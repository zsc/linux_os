<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬13ç« ï¼šå®‰å…¨å­ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Linux å†…æ ¸æºä»£ç æ·±åº¦è§£æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬1ç« ï¼šLinux å†…æ ¸æ¦‚è¿°ä¸å‘å±•å²</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬2ç« ï¼šè¿›ç¨‹ç®¡ç†ä¸ä»»åŠ¡è°ƒåº¦</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬3ç« ï¼šå†…å­˜ç®¡ç†æ¶æ„</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬4ç« ï¼šè¿›ç¨‹é—´é€šä¿¡æœºåˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬5ç« ï¼šè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬6ç« ï¼šå…·ä½“æ–‡ä»¶ç³»ç»Ÿå®ç°</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬7ç« ï¼šå—è®¾å¤‡å±‚ä¸I/Oè°ƒåº¦</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬8ç« ï¼šè®¾å¤‡é©±åŠ¨æ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬9ç« ï¼šç½‘ç»œåè®®æ ˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬10ç« ï¼šå†…æ ¸åŒæ­¥æœºåˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬11ç« ï¼šå¹¶å‘ç¼–ç¨‹æ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬12ç« ï¼šå®¹å™¨ä¸å‘½åç©ºé—´</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬13ç« ï¼šå®‰å…¨å­ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬14ç« ï¼šå®æ—¶Linux</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬15ç« ï¼šæ€§èƒ½åˆ†æä¸è°ƒè¯•</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬16ç« ï¼šå¼•å¯¼è¿‡ç¨‹ä¸åˆå§‹åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="13">ç¬¬13ç« ï¼šå®‰å…¨å­ç³»ç»Ÿ</h1>
<h2 id="_1">æœ¬ç« å¯¼è¯»</h2>
<p>Linuxå†…æ ¸å®‰å…¨å­ç³»ç»Ÿæ˜¯ä¿æŠ¤ç³»ç»Ÿå…å—æ¶æ„æ”»å‡»å’Œè¯¯ç”¨çš„å…³é”®é˜²çº¿ã€‚ä»æ—©æœŸç®€å•çš„Unixæƒé™æ¨¡å‹ï¼Œåˆ°ç°ä»£å¤æ‚çš„å¼ºåˆ¶è®¿é—®æ§åˆ¶ï¼ˆMACï¼‰å’Œç»†ç²’åº¦æƒèƒ½ç³»ç»Ÿï¼ŒLinuxå®‰å…¨æ¶æ„ç»å†äº†æ·±åˆ»çš„æ¼”å˜ã€‚æœ¬ç« å°†æ·±å…¥å‰–æLinuxå®‰å…¨æ¨¡å—ï¼ˆLSMï¼‰æ¡†æ¶çš„è®¾è®¡ä¸å®ç°ï¼Œæ¢è®¨ä¸»æµå®‰å…¨æ¨¡å—å¦‚SELinuxã€AppArmorçš„å·¥ä½œåŸç†ï¼Œåˆ†ææƒèƒ½ç³»ç»Ÿçš„ç»†ç²’åº¦æƒé™æ§åˆ¶æœºåˆ¶ï¼Œä»¥åŠeBPFåœ¨å®‰å…¨ç­–ç•¥å®æ–½ä¸­çš„é©å‘½æ€§åº”ç”¨ã€‚é€šè¿‡å­¦ä¹ æœ¬ç« ï¼Œè¯»è€…å°†æŒæ¡å†…æ ¸å®‰å…¨æœºåˆ¶çš„æ ¸å¿ƒåŸç†ï¼Œç†è§£ä¸åŒå®‰å…¨æ¨¡å‹çš„æƒè¡¡ï¼Œå¹¶èƒ½å¤Ÿè®¾è®¡å’Œå®ç°è‡ªå®šä¹‰çš„å®‰å…¨ç­–ç•¥ã€‚</p>
<h2 id="_2">å­¦ä¹ ç›®æ ‡</h2>
<p>å®Œæˆæœ¬ç« å­¦ä¹ åï¼Œæ‚¨å°†èƒ½å¤Ÿï¼š</p>
<ol>
<li><strong>ç†è§£LSMæ¡†æ¶æ¶æ„</strong>ï¼šæŒæ¡å®‰å…¨é’©å­çš„è®¾è®¡åŸç†å’Œå®ç°æœºåˆ¶</li>
<li><strong>åˆ†æä¸»æµå®‰å…¨æ¨¡å—</strong>ï¼šå¯¹æ¯”SELinuxã€AppArmorã€SMACKçš„è®¾è®¡å“²å­¦</li>
<li><strong>æŒæ¡æƒèƒ½ç³»ç»Ÿ</strong>ï¼šç†è§£ç»†ç²’åº¦æƒé™æ§åˆ¶å’Œæœ€å°æƒé™åŸåˆ™</li>
<li><strong>åº”ç”¨eBPFå®‰å…¨</strong>ï¼šä½¿ç”¨eBPFå®ç°åŠ¨æ€å®‰å…¨ç­–ç•¥</li>
<li><strong>è¯†åˆ«å¨èƒæ¨¡å‹</strong>ï¼šåˆ†æå†…æ ¸å®‰å…¨å¨èƒå’Œé˜²æŠ¤æœºåˆ¶</li>
<li><strong>å®è·µå®‰å…¨åŠ å›º</strong>ï¼šé…ç½®å’Œè°ƒè¯•å®‰å…¨æ¨¡å—ï¼Œå®ç°çºµæ·±é˜²å¾¡</li>
</ol>
<h2 id="131-linuxlsm">13.1 Linuxå®‰å…¨æ¨¡å—ï¼ˆLSMï¼‰æ¡†æ¶</h2>
<h3 id="1311-lsm">13.1.1 LSMçš„è¯ç”ŸèƒŒæ™¯</h3>
<p>Linuxå®‰å…¨æ¨¡å—æ¡†æ¶è¯ç”Ÿäº2001å¹´ï¼ŒæºäºLinuxå†…æ ¸å®‰å…¨å³°ä¼šçš„å…±è¯†ï¼šå†…æ ¸éœ€è¦æ”¯æŒå¤šç§å®‰å…¨æ¨¡å‹ï¼Œä½†ä¸åº”è¯¥å¼ºåˆ¶ä½¿ç”¨ä»»ä½•ç‰¹å®šçš„å®‰å…¨ç­–ç•¥ã€‚è¿™ä¸€è®¾è®¡ç†å¿µä½“ç°äº†Linuxçš„å¼€æ”¾æ€§å’Œçµæ´»æ€§ã€‚</p>
<div class="codehilite"><pre><span></span><code>ä¼ ç»ŸDACæ¨¡å‹çš„å±€é™æ€§ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     è‡ªä¸»è®¿é—®æ§åˆ¶ï¼ˆDACï¼‰             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ åŸºäºæ–‡ä»¶æ‰€æœ‰è€…å’Œæƒé™ä½           â”‚
â”‚  â€¢ ç”¨æˆ·å¯ä»¥ä¿®æ”¹è‡ªå·±æ–‡ä»¶çš„æƒé™       â”‚
â”‚  â€¢ rootç”¨æˆ·æ‹¥æœ‰æ— é™æƒé™             â”‚
â”‚  â€¢ æ— æ³•é˜²æ­¢ä¿¡æ¯æ³„éœ²å’Œææƒæ”»å‡»       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     å¼ºåˆ¶è®¿é—®æ§åˆ¶ï¼ˆMACï¼‰éœ€æ±‚         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ ç³»ç»Ÿå¼ºåˆ¶æ‰§è¡Œå®‰å…¨ç­–ç•¥             â”‚
â”‚  â€¢ ç”¨æˆ·æ— æ³•ä¿®æ”¹å®‰å…¨æ ‡ç­¾             â”‚
â”‚  â€¢ ç»†ç²’åº¦çš„è®¿é—®æ§åˆ¶                 â”‚
â”‚  â€¢ æœ€å°æƒé™åŸåˆ™                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="1312-lsm">13.1.2 LSMæ¡†æ¶æ¶æ„</h3>
<p>LSMæ¡†æ¶é€šè¿‡åœ¨å†…æ ¸å…³é”®æ“ä½œç‚¹æ’å…¥å®‰å…¨é’©å­ï¼ˆsecurity hooksï¼‰ï¼Œå…è®¸å®‰å…¨æ¨¡å—å®æ–½é¢å¤–çš„è®¿é—®æ§åˆ¶æ£€æŸ¥ï¼š</p>
<div class="codehilite"><pre><span></span><code>å†…æ ¸æ“ä½œæµç¨‹ä¸LSMé’©å­ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç³»ç»Ÿè°ƒç”¨    â”‚â”€â”€â”€â”€â–¶â”‚   DACæ£€æŸ¥    â”‚â”€â”€â”€â”€â–¶â”‚   LSMé’©å­    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚                      â”‚
                            â–¼                      â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚  æƒé™æ‹’ç»    â”‚     â”‚  å®‰å…¨æ¨¡å—    â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚    æ£€æŸ¥      â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                   â”‚
                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â–¼                 â–¼
                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                   â”‚   å…è®¸æ“ä½œ   â”‚ â”‚   æ‹’ç»æ“ä½œ   â”‚
                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="1313-lsm">13.1.3 LSMé’©å­å®ç°æœºåˆ¶</h3>
<p>LSMæ¡†æ¶åœ¨å†…æ ¸ä¸­å®šä¹‰äº†å¤§é‡çš„å®‰å…¨é’©å­ï¼Œè¦†ç›–æ–‡ä»¶ç³»ç»Ÿã€è¿›ç¨‹ç®¡ç†ã€ç½‘ç»œã€IPCç­‰æ‰€æœ‰å…³é”®å­ç³»ç»Ÿï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// include/linux/lsm_hooks.h ä¸­çš„é’©å­å®šä¹‰</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">security_hook_list</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_node</span><span class="w">       </span><span class="n">list</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_head</span><span class="w">       </span><span class="o">*</span><span class="n">head</span><span class="p">;</span>
<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="nc">security_list_options</span><span class="w"> </span><span class="n">hook</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w">              </span><span class="o">*</span><span class="n">lsm</span><span class="p">;</span><span class="w">  </span><span class="c1">// å®‰å…¨æ¨¡å—åç§°</span>
<span class="p">};</span>

<span class="c1">// æ–‡ä»¶æ“ä½œç›¸å…³çš„é’©å­ç¤ºä¾‹</span>
<span class="k">union</span><span class="w"> </span><span class="nc">security_list_options</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// æ–‡ä»¶æ‰“å¼€é’©å­</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">file_open</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// æ–‡ä»¶æƒé™æ£€æŸ¥é’©å­</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">file_permission</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mask</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// è¿›ç¨‹æ‰§è¡Œé’©å­</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">bprm_check_security</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">linux_binprm</span><span class="w"> </span><span class="o">*</span><span class="n">bprm</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ä»»åŠ¡åˆ›å»ºé’©å­</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">task_create</span><span class="p">)(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">clone_flags</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ç½‘ç»œå¥—æ¥å­—åˆ›å»ºé’©å­</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">socket_create</span><span class="p">)(</span><span class="kt">int</span><span class="w"> </span><span class="n">family</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">protocol</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">kern</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ... æ•°ç™¾ä¸ªé’©å­å‡½æ•°æŒ‡é’ˆ</span>
<span class="p">};</span>
</code></pre></div>

<p>é’©å­çš„è°ƒç”¨æµç¨‹é‡‡ç”¨é“¾å¼ç»“æ„ï¼Œå…è®¸å¤šä¸ªå®‰å…¨æ¨¡å—ä¸²è”ï¼ˆstackingï¼‰ï¼š</p>
<div class="codehilite"><pre><span></span><code>é’©å­è°ƒç”¨é“¾ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å†…æ ¸å‡½æ•°   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
security_file_open()
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  éå† security_hook_heads   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼                   â–¼         â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚SELinux â”‚        â”‚AppArmorâ”‚ â”‚ SMACK  â”‚ â”‚Capabilityâ”‚
â”‚ hook   â”‚        â”‚  hook  â”‚ â”‚  hook  â”‚ â”‚   hook   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                   â”‚         â”‚         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â–¼
        è¿”å›è®¿é—®å†³ç­–
</code></pre></div>

<h3 id="1314-lsm">13.1.4 LSMçš„å…³é”®æ•°æ®ç»“æ„</h3>
<p>æ¯ä¸ªå®‰å…¨æ¨¡å—éœ€è¦ç»´æŠ¤è‡ªå·±çš„å®‰å…¨ä¸Šä¸‹æ–‡ï¼ŒLSMæ¡†æ¶æä¾›äº†çµæ´»çš„å®‰å…¨blobæœºåˆ¶ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä»»åŠ¡å®‰å…¨ä¿¡æ¯</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">task_security_struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">osid</span><span class="p">;</span><span class="w">           </span><span class="c1">// å¯¹è±¡å®‰å…¨æ ‡è¯†ç¬¦</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">sid</span><span class="p">;</span><span class="w">            </span><span class="c1">// ä¸»ä½“å®‰å…¨æ ‡è¯†ç¬¦</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">exec_sid</span><span class="p">;</span><span class="w">       </span><span class="c1">// æ‰§è¡ŒåŸŸSID</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">create_sid</span><span class="p">;</span><span class="w">     </span><span class="c1">// åˆ›å»ºæ–‡ä»¶çš„SID</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">keycreate_sid</span><span class="p">;</span><span class="w">  </span><span class="c1">// åˆ›å»ºå¯†é’¥çš„SID</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">sockcreate_sid</span><span class="p">;</span><span class="w"> </span><span class="c1">// åˆ›å»ºå¥—æ¥å­—çš„SID</span>
<span class="p">};</span>

<span class="c1">// inodeå®‰å…¨ä¿¡æ¯</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">inode_security_struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">inode</span><span class="p">;</span><span class="w">    </span><span class="c1">// åå‘æŒ‡é’ˆ</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">list</span><span class="p">;</span><span class="w">  </span><span class="c1">// ç”¨äºå»¶è¿Ÿåˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">task_sid</span><span class="p">;</span><span class="w">          </span><span class="c1">// åˆ›å»ºä»»åŠ¡çš„SID</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">sid</span><span class="p">;</span><span class="w">               </span><span class="c1">// inodeçš„SID</span>
<span class="w">    </span><span class="n">u16</span><span class="w"> </span><span class="n">sclass</span><span class="p">;</span><span class="w">            </span><span class="c1">// å®‰å…¨ç±»åˆ«</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">initialized</span><span class="p">;</span><span class="w">  </span><span class="c1">// åˆå§‹åŒ–çŠ¶æ€</span>
<span class="w">    </span><span class="n">spinlock_t</span><span class="w"> </span><span class="n">lock</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>

<h2 id="132">13.2 ä¸»æµå®‰å…¨æ¨¡å—è¯¦è§£</h2>
<h3 id="1321-selinuxsecurity-enhanced-linux">13.2.1 SELinuxï¼ˆSecurity-Enhanced Linuxï¼‰</h3>
<p>SELinuxæ˜¯æœ€å¤æ‚ä¹Ÿæ˜¯æœ€å¼ºå¤§çš„Linuxå®‰å…¨æ¨¡å—ï¼Œç”±ç¾å›½å›½å®¶å®‰å…¨å±€ï¼ˆNSAï¼‰å¼€å‘ï¼Œå®ç°äº†ç±»å‹å¼ºåˆ¶ï¼ˆType Enforcementï¼‰å’Œå¤šçº§å®‰å…¨ï¼ˆMLSï¼‰æ¨¡å‹ã€‚</p>
<h4 id="te">ç±»å‹å¼ºåˆ¶ï¼ˆTEï¼‰æ¨¡å‹</h4>
<p>SELinuxçš„æ ¸å¿ƒæ˜¯åŸºäºç±»å‹çš„è®¿é—®æ§åˆ¶ï¼Œæ¯ä¸ªè¿›ç¨‹å’Œå¯¹è±¡éƒ½è¢«èµ‹äºˆä¸€ä¸ªå®‰å…¨ä¸Šä¸‹æ–‡ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="nx">SELinuxå®‰å…¨ä¸Šä¸‹æ–‡æ ¼å¼</span><span class="err">ï¼š</span>
<span class="nx">user</span><span class="p">:</span><span class="nx">role</span><span class="p">:</span><span class="k">type</span><span class="p">:</span><span class="nx">level</span>

<span class="nx">ç¤ºä¾‹</span><span class="err">ï¼š</span>
<span class="nx">system_u</span><span class="p">:</span><span class="nx">system_r</span><span class="p">:</span><span class="nx">httpd_t</span><span class="p">:</span><span class="nx">s0</span><span class="w">       </span><span class="err">#</span><span class="w"> </span><span class="nx">Apacheè¿›ç¨‹</span>
<span class="nx">unconfined_u</span><span class="p">:</span><span class="nx">object_r</span><span class="p">:</span><span class="nx">user_home_t</span><span class="p">:</span><span class="nx">s0</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="nx">ç”¨æˆ·ä¸»ç›®å½•æ–‡ä»¶</span>

<span class="nx">è®¿é—®æ§åˆ¶å†³ç­–</span><span class="err">ï¼š</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">        </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">   </span><span class="nx">ä¸»ä½“</span><span class="p">(</span><span class="nx">Subject</span><span class="p">)</span><span class="w"> </span><span class="err">â”‚</span><span class="w">        </span><span class="err">â”‚</span><span class="w">   </span><span class="nx">å®¢ä½“</span><span class="p">(</span><span class="nx">Object</span><span class="p">)</span><span class="w">  </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="nx">httpd_t</span><span class="w">      </span><span class="err">â”‚â”€â”€â”€â”€â”€â”€â”€â–¶â”‚</span><span class="w">   </span><span class="nx">httpd_config_t</span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">        </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">         </span><span class="err">â”‚</span><span class="w">                         </span><span class="err">â”‚</span>
<span class="w">         </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">                  </span><span class="err">â–¼</span>
<span class="w">          </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="w">          </span><span class="err">â”‚</span><span class="w">  </span><span class="nx">ç­–ç•¥è§„åˆ™</span><span class="w">    </span><span class="err">â”‚</span>
<span class="w">          </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">allow</span><span class="w"> </span><span class="nx">httpd_t</span><span class="err">â”‚</span>
<span class="w">          </span><span class="err">â”‚</span><span class="w"> </span><span class="nx">httpd_config_t</span><span class="err">â”‚</span>
<span class="w">          </span><span class="err">â”‚</span><span class="w"> </span><span class="p">:</span><span class="nx">file</span><span class="w"> </span><span class="nx">read</span><span class="p">;</span><span class="w">  </span><span class="err">â”‚</span>
<span class="w">          </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h4 id="_3">ç­–ç•¥è¯­è¨€ä¸ç¼–è¯‘</h4>
<p>SELinuxç­–ç•¥ä½¿ç”¨ç‰¹å®šçš„ç­–ç•¥è¯­è¨€ç¼–å†™ï¼Œç„¶åç¼–è¯‘æˆäºŒè¿›åˆ¶æ ¼å¼åŠ è½½åˆ°å†…æ ¸ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nx">ç±»å‹å£°æ˜</span>
<span class="k">type</span><span class="w"> </span><span class="nx">httpd_t</span><span class="p">;</span>
<span class="k">type</span><span class="w"> </span><span class="nx">httpd_exec_t</span><span class="p">;</span>
<span class="k">type</span><span class="w"> </span><span class="nx">httpd_config_t</span><span class="p">;</span>
<span class="k">type</span><span class="w"> </span><span class="nx">httpd_log_t</span><span class="p">;</span>

<span class="err">#</span><span class="w"> </span><span class="nx">åŸŸè½¬æ¢è§„åˆ™</span>
<span class="nx">type_transition</span><span class="w"> </span><span class="nx">init_t</span><span class="w"> </span><span class="nx">httpd_exec_t</span><span class="p">:</span><span class="nx">process</span><span class="w"> </span><span class="nx">httpd_t</span><span class="p">;</span>

<span class="err">#</span><span class="w"> </span><span class="nx">è®¿é—®å‘é‡è§„åˆ™</span>
<span class="nx">allow</span><span class="w"> </span><span class="nx">httpd_t</span><span class="w"> </span><span class="nx">httpd_config_t</span><span class="p">:</span><span class="nx">file</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">read</span><span class="w"> </span><span class="nx">getattr</span><span class="w"> </span><span class="p">};</span>
<span class="nx">allow</span><span class="w"> </span><span class="nx">httpd_t</span><span class="w"> </span><span class="nx">httpd_log_t</span><span class="p">:</span><span class="nx">file</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nx">write</span><span class="w"> </span><span class="nx">append</span><span class="w"> </span><span class="p">};</span>
<span class="nx">allow</span><span class="w"> </span><span class="nx">httpd_t</span><span class="w"> </span><span class="kp">self</span><span class="p">:</span><span class="nx">tcp_socket</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nx">bind</span><span class="w"> </span><span class="nx">listen</span><span class="w"> </span><span class="nx">accept</span><span class="w"> </span><span class="p">};</span>

<span class="err">#</span><span class="w"> </span><span class="nx">å®å®šä¹‰ç®€åŒ–ç­–ç•¥ç¼–å†™</span>
<span class="nx">define</span><span class="p">(</span><span class="err">`</span><span class="nx">apache_domain</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">`</span>
<span class="w">    </span><span class="k">type</span><span class="w"> </span><span class="err">$</span><span class="mi">1</span><span class="nx">_t</span><span class="p">;</span>
<span class="w">    </span><span class="k">type</span><span class="w"> </span><span class="err">$</span><span class="mi">1</span><span class="nx">_exec_t</span><span class="p">;</span>
<span class="w">    </span><span class="nx">domain_type</span><span class="p">(</span><span class="err">$</span><span class="mi">1</span><span class="nx">_t</span><span class="p">)</span>
<span class="w">    </span><span class="nx">domain_entry_file</span><span class="p">(</span><span class="err">$</span><span class="mi">1</span><span class="err">\</span><span class="nx">_t</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="mi">1</span><span class="nx">_exec_t</span><span class="p">)</span>
<span class="err">&#39;</span><span class="p">)</span>
</code></pre></div>

<h4 id="avcaccess-vector-cache">AVCï¼ˆAccess Vector Cacheï¼‰</h4>
<p>ä¸ºäº†æé«˜æ€§èƒ½ï¼ŒSELinuxå®ç°äº†è®¿é—®å‘é‡ç¼“å­˜ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">avc_node</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">avc_entry</span><span class="w">    </span><span class="n">ae</span><span class="p">;</span><span class="w">      </span><span class="c1">// è®¿é—®å‘é‡æ¡ç›®</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_node</span><span class="w">   </span><span class="n">list</span><span class="p">;</span><span class="w">    </span><span class="c1">// å“ˆå¸Œé“¾è¡¨</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rcu_head</span><span class="w">     </span><span class="n">rhead</span><span class="p">;</span><span class="w">   </span><span class="c1">// RCUå¤´</span>
<span class="p">};</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">avc_entry</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">u32</span><span class="w">         </span><span class="n">ssid</span><span class="p">;</span><span class="w">       </span><span class="c1">// æºå®‰å…¨æ ‡è¯†ç¬¦</span>
<span class="w">    </span><span class="n">u32</span><span class="w">         </span><span class="n">tsid</span><span class="p">;</span><span class="w">       </span><span class="c1">// ç›®æ ‡å®‰å…¨æ ‡è¯†ç¬¦</span>
<span class="w">    </span><span class="n">u16</span><span class="w">         </span><span class="n">tclass</span><span class="p">;</span><span class="w">     </span><span class="c1">// ç›®æ ‡ç±»åˆ«</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">av_decision</span><span class="w">  </span><span class="n">avd</span><span class="p">;</span><span class="w">  </span><span class="c1">// è®¿é—®å†³ç­–</span>
<span class="p">};</span>

<span class="c1">// AVCæŸ¥è¯¢æµç¨‹</span>
<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">avc_has_perm</span><span class="p">(</span><span class="n">u32</span><span class="w"> </span><span class="n">ssid</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">tsid</span><span class="p">,</span>
<span class="w">                               </span><span class="n">u16</span><span class="w"> </span><span class="n">tclass</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">requested</span><span class="p">,</span>
<span class="w">                               </span><span class="k">struct</span><span class="w"> </span><span class="nc">common_audit_data</span><span class="w"> </span><span class="o">*</span><span class="n">auditdata</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">av_decision</span><span class="w"> </span><span class="n">avd</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">rc</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// å¿«é€Ÿè·¯å¾„ï¼šæŸ¥è¯¢ç¼“å­˜</span>
<span class="w">    </span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">avc_has_perm_noaudit</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span><span class="w"> </span><span class="n">tsid</span><span class="p">,</span><span class="w"> </span><span class="n">tclass</span><span class="p">,</span><span class="w"> </span><span class="n">requested</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">avd</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// æ…¢é€Ÿè·¯å¾„ï¼šæŸ¥è¯¢ç­–ç•¥</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rc</span><span class="p">)</span>
<span class="w">        </span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">security_compute_av</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span><span class="w"> </span><span class="n">tsid</span><span class="p">,</span><span class="w"> </span><span class="n">tclass</span><span class="p">,</span><span class="w"> </span><span class="n">requested</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">avd</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// å®¡è®¡è®°å½•</span>
<span class="w">    </span><span class="n">avc_audit</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span><span class="w"> </span><span class="n">tsid</span><span class="p">,</span><span class="w"> </span><span class="n">tclass</span><span class="p">,</span><span class="w"> </span><span class="n">requested</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">avd</span><span class="p">,</span><span class="w"> </span><span class="n">rc</span><span class="p">,</span><span class="w"> </span><span class="n">auditdata</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1322-apparmor">13.2.2 AppArmor</h3>
<p>AppArmoré‡‡ç”¨åŸºäºè·¯å¾„çš„è®¿é—®æ§åˆ¶ï¼Œç›¸æ¯”SELinuxæ›´å®¹æ˜“ç†è§£å’Œé…ç½®ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">AppArmoré…ç½®æ–‡ä»¶ç¤ºä¾‹</span><span class="err">ï¼š</span>
<span class="c1">#include &lt;tunables/global&gt;</span>

<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nginx</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">#include &lt;abstractions/base&gt;</span>
<span class="w">    </span><span class="c1">#include &lt;abstractions/nameservice&gt;</span>

<span class="w">    </span><span class="n">capability</span><span class="w"> </span><span class="n">net_bind_service</span><span class="p">,</span>
<span class="w">    </span><span class="n">capability</span><span class="w"> </span><span class="n">setuid</span><span class="p">,</span>
<span class="w">    </span><span class="n">capability</span><span class="w"> </span><span class="n">setgid</span><span class="p">,</span>

<span class="w">    </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="w"> </span><span class="n">r</span><span class="p">,</span>
<span class="w">    </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/**</span><span class="w"> </span><span class="n">r</span><span class="p">,</span>
<span class="w">    </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">nginx</span><span class="o">/*.</span><span class="n">log</span><span class="w"> </span><span class="n">w</span><span class="p">,</span>
<span class="w">    </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="o">/**</span><span class="w"> </span><span class="n">r</span><span class="p">,</span>

<span class="w">    </span><span class="n">network</span><span class="w"> </span><span class="n">inet</span><span class="w"> </span><span class="n">stream</span><span class="p">,</span>
<span class="w">    </span><span class="n">network</span><span class="w"> </span><span class="n">inet6</span><span class="w"> </span><span class="n">stream</span><span class="p">,</span>

<span class="w">    </span><span class="c1"># å­é…ç½®æ–‡ä»¶</span>
<span class="w">    </span><span class="o">^/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">worker</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="o">/**</span><span class="w"> </span><span class="n">r</span><span class="p">,</span>
<span class="w">        </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="w"> </span><span class="n">r</span><span class="p">,</span>
<span class="w">        </span><span class="o">/</span><span class="n">tmp</span><span class="o">/**</span><span class="w"> </span><span class="n">rw</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>AppArmorçš„å®ç°ç›¸å¯¹ç®€å•ï¼Œä¸»è¦ä¾èµ–äºDFAï¼ˆç¡®å®šæœ‰é™è‡ªåŠ¨æœºï¼‰è¿›è¡Œè·¯å¾„åŒ¹é…ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">è·¯å¾„åŒ¹é…DFA</span><span class="err">ï¼š</span>
<span class="w">        </span><span class="o">/</span><span class="n">etc</span>
<span class="w">         </span><span class="err">â”‚</span>
<span class="w">    </span><span class="err">â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”</span>
<span class="w">    </span><span class="err">â”‚</span><span class="w">         </span><span class="err">â”‚</span>
<span class="w">  </span><span class="n">nginx</span><span class="o">/</span><span class="w">    </span><span class="n">passwd</span>
<span class="w">    </span><span class="err">â”‚</span><span class="w">         </span><span class="err">â”‚</span>
<span class="w">  </span><span class="o">*</span><span class="p">.</span><span class="n">conf</span><span class="w">    </span><span class="o">[</span><span class="n">accept</span><span class="o">]</span>
<span class="w">    </span><span class="err">â”‚</span>
<span class="w">  </span><span class="o">[</span><span class="n">accept</span><span class="o">]</span>
</code></pre></div>

<h3 id="1323-smacksimplified-mandatory-access-control-kernel">13.2.3 SMACKï¼ˆSimplified Mandatory Access Control Kernelï¼‰</h3>
<p>SMACKæä¾›äº†æ›´ç®€å•çš„æ ‡ç­¾å¼è®¿é—®æ§åˆ¶ï¼š</p>
<div class="codehilite"><pre><span></span><code>SMACKè§„åˆ™æ ¼å¼ï¼š
ä¸»ä½“æ ‡ç­¾  å®¢ä½“æ ‡ç­¾  è®¿é—®æƒé™

ç¤ºä¾‹ï¼š
WebServer Database  r     # WebServerå¯ä»¥è¯»Database
User      WebServer wx    # Userå¯ä»¥å†™å’Œæ‰§è¡ŒWebServer
System    _         rwxa  # Systemå¯¹æ‰€æœ‰å¯¹è±¡æœ‰å®Œå…¨æƒé™
</code></pre></div>

<h2 id="133-linuxcapabilities">13.3 Linuxæƒèƒ½ç³»ç»Ÿï¼ˆCapabilitiesï¼‰</h2>
<h3 id="1331">13.3.1 æƒèƒ½çš„è®¾è®¡ç†å¿µ</h3>
<p>Linuxæƒèƒ½ç³»ç»Ÿå°†ä¼ ç»Ÿçš„è¶…çº§ç”¨æˆ·æƒé™åˆ†è§£ä¸ºç»†ç²’åº¦çš„æƒèƒ½ï¼Œå®ç°æœ€å°æƒé™åŸåˆ™ï¼š</p>
<div class="codehilite"><pre><span></span><code>ä¼ ç»Ÿæ¨¡å‹ vs æƒèƒ½æ¨¡å‹ï¼š

ä¼ ç»Ÿæ¨¡å‹ï¼š                    æƒèƒ½æ¨¡å‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    root      â”‚           â”‚   CAP_NET_ADMIN  â”‚
â”‚  (æ‰€æœ‰æƒé™)   â”‚   â”€â”€â”€â–¶    â”‚   CAP_SYS_ADMIN  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚   CAP_DAC_OVERRIDEâ”‚
                           â”‚   CAP_SETUID      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚   ...            â”‚
â”‚  æ™®é€šç”¨æˆ·     â”‚           â”‚   (38ä¸ªæƒèƒ½)      â”‚
â”‚  (å—é™æƒé™)   â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="1332">13.3.2 æƒèƒ½çš„å®ç°æœºåˆ¶</h3>
<p>æ¯ä¸ªè¿›ç¨‹ç»´æŠ¤å¤šä¸ªæƒèƒ½é›†åˆï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// include/linux/cred.h</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">cred</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ... å…¶ä»–å­—æ®µ</span>
<span class="w">    </span><span class="n">kernel_cap_t</span><span class="w">    </span><span class="n">cap_inheritable</span><span class="p">;</span><span class="w">  </span><span class="c1">// å¯ç»§æ‰¿æƒèƒ½é›†</span>
<span class="w">    </span><span class="n">kernel_cap_t</span><span class="w">    </span><span class="n">cap_permitted</span><span class="p">;</span><span class="w">    </span><span class="c1">// å…è®¸æƒèƒ½é›†</span>
<span class="w">    </span><span class="n">kernel_cap_t</span><span class="w">    </span><span class="n">cap_effective</span><span class="p">;</span><span class="w">    </span><span class="c1">// æœ‰æ•ˆæƒèƒ½é›†</span>
<span class="w">    </span><span class="n">kernel_cap_t</span><span class="w">    </span><span class="n">cap_bset</span><span class="p">;</span><span class="w">        </span><span class="c1">// è¾¹ç•Œé›†</span>
<span class="w">    </span><span class="n">kernel_cap_t</span><span class="w">    </span><span class="n">cap_ambient</span><span class="p">;</span><span class="w">     </span><span class="c1">// ç¯å¢ƒæƒèƒ½é›†</span>
<span class="p">};</span>

<span class="c1">// æƒèƒ½æ£€æŸ¥å®</span>
<span class="cp">#define capable(cap) (capable_wrt_inode_uidgid(current_cred(), \</span>
<span class="cp">                     NULL, NULL, cap))</span>

<span class="c1">// æ–‡ä»¶æƒèƒ½å­˜å‚¨åœ¨æ‰©å±•å±æ€§ä¸­</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">vfs_cap_data</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__le32</span><span class="w"> </span><span class="n">magic_etc</span><span class="p">;</span><span class="w">            </span><span class="c1">// é­”æ•°å’Œæ ‡å¿—</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">__le32</span><span class="w"> </span><span class="n">permitted</span><span class="p">;</span><span class="w">        </span><span class="c1">// å…è®¸æƒèƒ½</span>
<span class="w">        </span><span class="n">__le32</span><span class="w"> </span><span class="n">inheritable</span><span class="p">;</span><span class="w">      </span><span class="c1">// å¯ç»§æ‰¿æƒèƒ½</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">VFS_CAP_U32</span><span class="p">];</span>
<span class="p">};</span>
</code></pre></div>

<p>æƒèƒ½çš„ä¼ é€’è§„åˆ™éµå¾ªå¤æ‚çš„å…¬å¼ï¼š</p>
<div class="codehilite"><pre><span></span><code>P&#39;(ambient)     = (file caps || P(ambient))
P&#39;(permitted)   = (P(inheritable) &amp; F(inheritable)) | 
                  (F(permitted) &amp; cap_bset) | P&#39;(ambient)
P&#39;(effective)   = F(effective) ? P&#39;(permitted) : P&#39;(ambient)
P&#39;(inheritable) = P(inheritable)
P&#39;(bset)        = P(bset)

å…¶ä¸­ï¼š
P  = çˆ¶è¿›ç¨‹æƒèƒ½
P&#39; = å­è¿›ç¨‹æƒèƒ½
F  = æ–‡ä»¶æƒèƒ½
</code></pre></div>

<h3 id="1333">13.3.3 å¸¸ç”¨æƒèƒ½è¯¦è§£</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// ç½‘ç»œç®¡ç†æƒèƒ½</span>
<span class="n">CAP_NET_ADMIN</span><span class="w">       </span><span class="c1">// é…ç½®ç½‘ç»œæ¥å£ã€è·¯ç”±è¡¨ã€é˜²ç«å¢™è§„åˆ™</span>
<span class="n">CAP_NET_BIND_SERVICE</span><span class="w"> </span><span class="c1">// ç»‘å®šç‰¹æƒç«¯å£ï¼ˆ&lt;1024ï¼‰</span>
<span class="n">CAP_NET_RAW</span><span class="w">         </span><span class="c1">// ä½¿ç”¨åŸå§‹å¥—æ¥å­—å’ŒåŒ…å¥—æ¥å­—</span>

<span class="c1">// ç³»ç»Ÿç®¡ç†æƒèƒ½</span>
<span class="n">CAP_SYS_ADMIN</span><span class="w">       </span><span class="c1">// æ‰§è¡Œç³»ç»Ÿç®¡ç†æ“ä½œï¼ˆæœ€å¼ºå¤§çš„æƒèƒ½ï¼‰</span>
<span class="n">CAP_SYS_MODULE</span><span class="w">      </span><span class="c1">// åŠ è½½å’Œå¸è½½å†…æ ¸æ¨¡å—</span>
<span class="n">CAP_SYS_PTRACE</span><span class="w">      </span><span class="c1">// è¿½è¸ªä»»æ„è¿›ç¨‹</span>
<span class="n">CAP_SYS_CHROOT</span><span class="w">      </span><span class="c1">// ä½¿ç”¨chroot()</span>

<span class="c1">// æ–‡ä»¶ç³»ç»Ÿæƒèƒ½</span>
<span class="n">CAP_DAC_OVERRIDE</span><span class="w">    </span><span class="c1">// ç»•è¿‡æ–‡ä»¶è¯»ã€å†™ã€æ‰§è¡Œæƒé™æ£€æŸ¥</span>
<span class="n">CAP_DAC_READ_SEARCH</span><span class="w"> </span><span class="c1">// ç»•è¿‡æ–‡ä»¶è¯»æƒé™å’Œç›®å½•æœç´¢æƒé™æ£€æŸ¥</span>
<span class="n">CAP_FOWNER</span><span class="w">          </span><span class="c1">// ç»•è¿‡æ–‡ä»¶æ‰€æœ‰è€…æ£€æŸ¥</span>
<span class="n">CAP_CHOWN</span><span class="w">           </span><span class="c1">// æ”¹å˜æ–‡ä»¶æ‰€æœ‰è€…</span>

<span class="c1">// è¿›ç¨‹ç®¡ç†æƒèƒ½</span>
<span class="n">CAP_SETUID</span><span class="w">          </span><span class="c1">// è®¾ç½®UID</span>
<span class="n">CAP_SETGID</span><span class="w">          </span><span class="c1">// è®¾ç½®GID</span>
<span class="n">CAP_KILL</span><span class="w">            </span><span class="c1">// å‘é€ä¿¡å·ç»™ä»»æ„è¿›ç¨‹</span>
<span class="n">CAP_SETPCAP</span><span class="w">         </span><span class="c1">// ä¿®æ”¹è¿›ç¨‹æƒèƒ½</span>
</code></pre></div>

<h2 id="134-ebpf">13.4 eBPFä¸å®‰å…¨ç­–ç•¥</h2>
<h3 id="1341-ebpf">13.4.1 eBPFåœ¨å®‰å…¨ä¸­çš„åº”ç”¨</h3>
<p>eBPFï¼ˆextended Berkeley Packet Filterï¼‰ä¸ºLinuxå®‰å…¨æä¾›äº†å¯ç¼–ç¨‹çš„ã€åŠ¨æ€çš„å®‰å…¨ç­–ç•¥å®æ–½æœºåˆ¶ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä½¿ç”¨eBPFå®ç°ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤</span>
<span class="n">SEC</span><span class="p">(</span><span class="s">&quot;lsm/file_open&quot;</span><span class="p">)</span>
<span class="kt">int</span><span class="w"> </span><span class="n">BPF_PROG</span><span class="p">(</span><span class="n">file_open_security</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">bpf_get_current_task</span><span class="p">();</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">comm</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="w">    </span><span class="n">bpf_get_current_comm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">comm</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// è·å–æ–‡ä»¶è·¯å¾„</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">path</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="n">dentry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="p">;</span>
<span class="w">    </span><span class="n">bpf_d_path</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">path</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// å®‰å…¨ç­–ç•¥ï¼šç¦æ­¢ç‰¹å®šè¿›ç¨‹è®¿é—®æ•æ„Ÿæ–‡ä»¶</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;suspicious&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/etc/shadow&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">bpf_printk</span><span class="p">(</span><span class="s">&quot;Blocked: %s accessing %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1342-bpf-lsm">13.4.2 BPF LSMæ¡†æ¶</h3>
<p>BPF LSMå…è®¸é€šè¿‡eBPFç¨‹åºå®ç°LSMé’©å­ï¼š</p>
<div class="codehilite"><pre><span></span><code>BPF LSMæ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ç”¨æˆ·ç©ºé—´BPFç¨‹åº          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ bpf()ç³»ç»Ÿè°ƒç”¨
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      BPFéªŒè¯å™¨               â”‚
â”‚  â€¢ ç±»å‹æ£€æŸ¥                  â”‚
â”‚  â€¢ è¾¹ç•Œæ£€æŸ¥                  â”‚
â”‚  â€¢ å¾ªç¯æ£€æµ‹                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      BPF JITç¼–è¯‘å™¨           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      LSMé’©å­ç‚¹               â”‚
â”‚  â€¢ file_open                 â”‚
â”‚  â€¢ task_alloc                â”‚
â”‚  â€¢ socket_connect            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="1343-ebpf">13.4.3 ä½¿ç”¨eBPFè¿›è¡Œè¿è¡Œæ—¶å®‰å…¨ç›‘æ§</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// ç›‘æ§è¿›ç¨‹åˆ›å»º</span>
<span class="n">SEC</span><span class="p">(</span><span class="s">&quot;tracepoint/sched/sched_process_fork&quot;</span><span class="p">)</span>
<span class="kt">int</span><span class="w"> </span><span class="n">trace_fork</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">trace_event_raw_sched_process_fork</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">parent_pid</span><span class="p">;</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">child_pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">child_pid</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// è®°å½•è¿›ç¨‹æ ‘</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">process_info</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">parent_pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">child_pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">child_pid</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_ktime_get_ns</span><span class="p">(),</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">bpf_map_update_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">process_tree</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">child_pid</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_ANY</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// æ£€æµ‹å¼‚å¸¸forkè¡Œä¸º</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="o">*</span><span class="n">fork_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fork_stats</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pid</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fork_count</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">*</span><span class="n">fork_count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">FORK_THRESHOLD</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// è§¦å‘å‘Šè­¦</span>
<span class="w">        </span><span class="n">bpf_send_signal</span><span class="p">(</span><span class="n">SIGKILL</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// ç›‘æ§ç½‘ç»œè¿æ¥</span>
<span class="n">SEC</span><span class="p">(</span><span class="s">&quot;lsm/socket_connect&quot;</span><span class="p">)</span>
<span class="kt">int</span><span class="w"> </span><span class="n">BPF_PROG</span><span class="p">(</span><span class="n">socket_connect_security</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">socket</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="p">,</span>
<span class="w">             </span><span class="k">struct</span><span class="w"> </span><span class="nc">sockaddr</span><span class="w"> </span><span class="o">*</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">addrlen</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="o">-&gt;</span><span class="n">sa_family</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">AF_INET</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sockaddr_in</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sockaddr_in</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">address</span><span class="p">;</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">dest_ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span>
<span class="w">    </span><span class="n">u16</span><span class="w"> </span><span class="n">dest_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ntohs</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// æ£€æŸ¥é»‘åå•</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">blacklist_ips</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dest_ip</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">bpf_printk</span><span class="p">(</span><span class="s">&quot;Blocked connection to %pI4:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dest_ip</span><span class="p">,</span><span class="w"> </span><span class="n">dest_port</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="135">13.5 å†…æ ¸å®‰å…¨å¨èƒæ¨¡å‹</h2>
<h3 id="1351">13.5.1 å¸¸è§æ”»å‡»å‘é‡</h3>
<p>Linuxå†…æ ¸é¢ä¸´å¤šç§å®‰å…¨å¨èƒï¼š</p>
<div class="codehilite"><pre><span></span><code>æ”»å‡»å‘é‡åˆ†ç±»ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            å†…æ ¸æ”»å‡»é¢                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. ç³»ç»Ÿè°ƒç”¨æ¥å£                        â”‚
â”‚     â€¢ è¾“å…¥éªŒè¯ä¸è¶³                      â”‚
â”‚     â€¢ ç«æ€æ¡ä»¶                          â”‚
â”‚     â€¢ æ•´æ•°æº¢å‡º                          â”‚
â”‚                                         â”‚
â”‚  2. è®¾å¤‡é©±åŠ¨                            â”‚
â”‚     â€¢ æœªåˆå§‹åŒ–å†…å­˜                      â”‚
â”‚     â€¢ ç¼“å†²åŒºæº¢å‡º                        â”‚
â”‚     â€¢ UAFï¼ˆUse-After-Freeï¼‰             â”‚
â”‚                                         â”‚
â”‚  3. ç½‘ç»œåè®®æ ˆ                          â”‚
â”‚     â€¢ åŒ…å¤„ç†æ¼æ´                        â”‚
â”‚     â€¢ åè®®çŠ¶æ€æœºé”™è¯¯                    â”‚
â”‚     â€¢ æ‹’ç»æœåŠ¡æ”»å‡»                      â”‚
â”‚                                         â”‚
â”‚  4. æ–‡ä»¶ç³»ç»Ÿ                            â”‚
â”‚     â€¢ å…ƒæ•°æ®æŸå                        â”‚
â”‚     â€¢ ç¬¦å·é“¾æ¥æ”»å‡»                      â”‚
â”‚     â€¢ æƒé™ç»•è¿‡                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="1352">13.5.2 æƒé™æå‡æ”»å‡»</h3>
<p>æƒé™æå‡æ˜¯æœ€ä¸¥é‡çš„å®‰å…¨å¨èƒä¹‹ä¸€ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// å…¸å‹çš„æƒé™æå‡æ¼æ´æ¨¡å¼</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">vulnerable_ioctl_data</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">user_ptr</span><span class="p">;</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// é”™è¯¯çš„æƒé™æ£€æŸ¥</span>
<span class="k">static</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">vulnerable_ioctl</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">cmd</span><span class="p">,</span>
<span class="w">                            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vulnerable_ioctl_data</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// ç¼ºå°‘æƒé™æ£€æŸ¥ï¼</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// å±é™©ï¼šç›´æ¥ä½¿ç”¨ç”¨æˆ·æä¾›çš„æŒ‡é’ˆ</span>
<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">user_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">kernel_secret</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">);</span><span class="w">  </span><span class="c1">// ä¿¡æ¯æ³„éœ²</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// æ­£ç¡®çš„å®ç°</span>
<span class="k">static</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">secure_ioctl</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">cmd</span><span class="p">,</span>
<span class="w">                         </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vulnerable_ioctl_data</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// æƒé™æ£€æŸ¥</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// è¾“å…¥éªŒè¯</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MAX_SIZE</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// ä½¿ç”¨å®‰å…¨çš„å†…æ ¸API</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">user_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">safe_data</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1353">13.5.3 ä¾§ä¿¡é“æ”»å‡»</h3>
<p>ç°ä»£CPUçš„ä¾§ä¿¡é“æ¼æ´å¯¹å†…æ ¸å®‰å…¨æ„æˆæ–°æŒ‘æˆ˜ï¼š</p>
<div class="codehilite"><pre><span></span><code>Spectre/Meltdownç¼“è§£æªæ–½ï¼š

1. é¡µè¡¨éš”ç¦»ï¼ˆPTIï¼‰ï¼š
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  ç”¨æˆ·é¡µè¡¨     â”‚    â”‚  å†…æ ¸é¡µè¡¨     â”‚
   â”‚              â”‚    â”‚              â”‚
   â”‚  ç”¨æˆ·ç©ºé—´æ˜ å°„ â”‚    â”‚  ç”¨æˆ·ç©ºé—´æ˜ å°„ â”‚
   â”‚              â”‚    â”‚  +           â”‚
   â”‚              â”‚    â”‚  å†…æ ¸ç©ºé—´æ˜ å°„ â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2. æ¨æµ‹æ‰§è¡Œå±éšœï¼š
   asm volatile(&quot;lfence&quot; ::: &quot;memory&quot;);  // Intel
   asm volatile(&quot;dsb sy&quot; ::: &quot;memory&quot;);  // ARM

3. é—´æ¥åˆ†æ”¯é¢„æµ‹å±éšœï¼ˆIBPBï¼‰ï¼š
   wrmsrl(MSR_IA32_PRED_CMD, PRED_CMD_IBPB);
</code></pre></div>

<h3 id="1354">13.5.4 å†…å­˜æŸåé˜²æŠ¤</h3>
<p>å†…æ ¸å®ç°äº†å¤šç§å†…å­˜æŸåé˜²æŠ¤æœºåˆ¶ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// KASLRï¼ˆå†…æ ¸åœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–ï¼‰</span>
<span class="c1">// arch/x86/boot/compressed/kaslr.c</span>
<span class="k">static</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">find_random_phys_addr</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">minimum</span><span class="p">,</span>
<span class="w">                                          </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">image_size</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">random_addr</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// è·å–éšæœºæ•°</span>
<span class="w">    </span><span class="n">random_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kaslr_get_random_long</span><span class="p">(</span><span class="s">&quot;Physical&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// å¯¹é½åˆ°å†…æ ¸å¯¹é½è¾¹ç•Œ</span>
<span class="w">    </span><span class="n">random_addr</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="n">CONFIG_PHYSICAL_ALIGN</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ç¡®ä¿åœ¨æœ‰æ•ˆèŒƒå›´å†…</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">random_addr</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">minimum</span><span class="p">)</span>
<span class="w">        </span><span class="n">random_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">minimum</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">random_addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// æ ˆæº¢å‡ºä¿æŠ¤ï¼ˆStack Canaryï¼‰</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">__stack_chk_fail</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;stack-protector: Kernel stack is corrupted in: %pS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="n">__builtin_return_address</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>

<span class="c1">// KFENCEï¼ˆå†…æ ¸ç”µæ …æ ï¼‰</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">kfence_guarded_alloc</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// åœ¨åˆ†é…åŒºåŸŸå‰åè®¾ç½®ä¿æŠ¤é¡µ</span>
<span class="w">    </span><span class="n">set_memory_valid</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">addr</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="w">    </span><span class="n">set_memory_valid</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">## 13.6 å†å²æ•…äº‹ï¼šLinuxå®‰å…¨çš„æ¼”è¿›ä¹‹è·¯</span>

<span class="cp">### 13.6.1 NSAè´¡çŒ®SELinuxçš„äº‰è®®</span>

<span class="mi">2000</span><span class="n">å¹´</span><span class="err">ï¼Œ</span><span class="n">ç¾å›½å›½å®¶å®‰å…¨å±€</span><span class="err">ï¼ˆ</span><span class="n">NSA</span><span class="err">ï¼‰</span><span class="n">å‘Linuxç¤¾åŒºè´¡çŒ®SELinuxä»£ç æ—¶å¼•å‘å·¨å¤§äº‰è®®</span><span class="err">ã€‚</span><span class="n">è®¸å¤šå¼€å‘è€…è´¨ç–‘</span><span class="err">ï¼š</span><span class="s">&quot;ä¸ºä»€ä¹ˆNSAè¦å¸®åŠ©åŠ å¼ºLinuxå®‰å…¨ï¼Ÿæ˜¯å¦æœ‰åé—¨ï¼Ÿ&quot;</span>

<span class="n">Linus</span><span class="w"> </span><span class="n">Torvaldsæœ€åˆçš„æ€åº¦æ˜¯è°¨æ…çš„</span><span class="err">ï¼š</span><span class="s">&quot;æˆ‘ä¸ä¼šæ¥å—ä»»ä½•æˆ‘ä¸ç†è§£çš„å®‰å…¨ä»£ç ã€‚&quot;</span><span class="n">ç»è¿‡é•¿è¾¾3å¹´çš„ä»£ç å®¡æŸ¥å’Œé‡æ„</span><span class="err">ï¼Œ</span><span class="n">SELinuxæœ€ç»ˆåœ¨2003å¹´è¿›å…¥2</span><span class="mf">.6</span><span class="n">å†…æ ¸</span><span class="err">ã€‚</span><span class="n">è¿™ä¸ªè¿‡ç¨‹ä¸­</span><span class="err">ï¼Œ</span><span class="n">LSMæ¡†æ¶åº”è¿è€Œç”Ÿ</span><span class="err">â€”â€”</span><span class="n">å®ƒå…è®¸SELinuxä½œä¸ºå¯é€‰æ¨¡å—å­˜åœ¨</span><span class="err">ï¼Œ</span><span class="n">è€Œä¸æ˜¯å¼ºåˆ¶æ‰€æœ‰äººä½¿ç”¨</span><span class="err">ã€‚</span>

<span class="n">æœ‰è¶£çš„æ˜¯</span><span class="err">ï¼Œ</span><span class="n">Edward</span><span class="w"> </span><span class="n">Snowdenåœ¨2013å¹´çš„çˆ†æ–™æ˜¾ç¤º</span><span class="err">ï¼Œ</span><span class="n">NSAç¡®å®æœ‰å„ç§ç›‘æ§é¡¹ç›®</span><span class="err">ï¼Œ</span><span class="n">ä½†æ²¡æœ‰è¯æ®è¡¨æ˜SELinuxå­˜åœ¨åé—¨</span><span class="err">ã€‚</span><span class="n">ç›¸å</span><span class="err">ï¼Œ</span><span class="n">SELinuxçš„å¼€æºç‰¹æ€§ä½¿å…¶æˆä¸ºæœ€é€æ˜</span><span class="err">ã€</span><span class="n">æœ€è¢«å®¡æŸ¥çš„å®‰å…¨ç³»ç»Ÿä¹‹ä¸€</span><span class="err">ã€‚</span>

<span class="cp">### 13.6.2 Linuså¯¹å®‰å…¨æ¡†æ¶çš„æ€åº¦è½¬å˜</span>

<span class="n">æ—©æœŸçš„Linuså¯¹å¤æ‚çš„å®‰å…¨æ¡†æ¶æŒæ€€ç–‘æ€åº¦</span><span class="err">ã€‚</span><span class="n">ä»–åœ¨2001å¹´çš„é‚®ä»¶ä¸­å†™é“</span><span class="err">ï¼š</span><span class="s">&quot;å®‰å…¨ä¸åº”è¯¥å¦¨ç¢æ­£å¸¸ä½¿ç”¨ã€‚å¦‚æœå®‰å…¨æªæ–½è®©ç³»ç»Ÿå˜å¾—éš¾ç”¨ï¼Œäººä»¬å°±ä¼šå…³é—­å®ƒã€‚&quot;</span>

<span class="n">è¿™ç§å®ç”¨ä¸»ä¹‰å“²å­¦æ·±åˆ»å½±å“äº†Linuxå®‰å…¨æ¶æ„çš„è®¾è®¡</span><span class="err">ï¼š</span>

<span class="o">-</span><span class="w"> </span><span class="n">å®‰å…¨åŠŸèƒ½å¿…é¡»æ˜¯å¯é€‰çš„</span>
<span class="o">-</span><span class="w"> </span><span class="n">é»˜è®¤é…ç½®ä¸èƒ½ç ´åç°æœ‰ç³»ç»Ÿ</span>
<span class="o">-</span><span class="w"> </span><span class="n">æ€§èƒ½å½±å“å¿…é¡»æœ€å°åŒ–</span>

<span class="n">éšç€äº‘è®¡ç®—å’Œå®¹å™¨æŠ€æœ¯çš„å…´èµ·</span><span class="err">ï¼Œ</span><span class="n">Linusçš„æ€åº¦æœ‰æ‰€è½¯åŒ–</span><span class="err">ã€‚</span><span class="mi">2018</span><span class="n">å¹´</span><span class="err">ï¼Œ</span><span class="n">ä»–åœ¨ä¸€æ¬¡é‡‡è®¿ä¸­æ‰¿è®¤</span><span class="err">ï¼š</span><span class="s">&quot;å®‰å…¨å·²ç»å˜å¾—å¦‚æ­¤é‡è¦ï¼Œæˆ‘ä»¬ä¸èƒ½å†æŠŠå®ƒå½“ä½œæ¬¡è¦åŠŸèƒ½ã€‚&quot;</span>

<span class="cp">### 13.6.3 æƒèƒ½ç³»ç»Ÿçš„æ¼«é•¿å¾ç¨‹</span>

<span class="n">Linuxæƒèƒ½ç³»ç»Ÿçš„å®ç°ç»å†äº†è¿‘20å¹´çš„æ¼”è¿›</span><span class="err">ï¼š</span>

<span class="o">-</span><span class="w"> </span><span class="o">**</span><span class="mi">1997</span><span class="n">å¹´</span><span class="o">**</span><span class="err">ï¼š</span><span class="n">é¦–æ¬¡å¼•å…¥æƒèƒ½æ¦‚å¿µ</span><span class="err">ï¼ˆ</span><span class="mf">2.1</span><span class="n">å†…æ ¸</span><span class="err">ï¼‰</span>
<span class="o">-</span><span class="w"> </span><span class="o">**</span><span class="mi">2008</span><span class="n">å¹´</span><span class="o">**</span><span class="err">ï¼š</span><span class="n">æ–‡ä»¶æƒèƒ½æ”¯æŒ</span><span class="err">ï¼ˆ</span><span class="mf">2.6.24</span><span class="err">ï¼‰</span>
<span class="o">-</span><span class="w"> </span><span class="o">**</span><span class="mi">2015</span><span class="n">å¹´</span><span class="o">**</span><span class="err">ï¼š</span><span class="n">ç¯å¢ƒæƒèƒ½</span><span class="err">ï¼ˆ</span><span class="n">Ambient</span><span class="w"> </span><span class="n">Capabilities</span><span class="err">ï¼‰</span><span class="n">å¼•å…¥</span><span class="err">ï¼ˆ</span><span class="mf">4.3</span><span class="n">å†…æ ¸</span><span class="err">ï¼‰</span>

<span class="n">Andy</span><span class="w"> </span><span class="n">Lutomirskiåœ¨å®ç°ç¯å¢ƒæƒèƒ½æ—¶è¯´</span><span class="err">ï¼š</span><span class="s">&quot;æƒèƒ½ç³»ç»Ÿçš„é—®é¢˜æ˜¯å®ƒå¤ªå¤æ‚äº†ã€‚æˆ‘ä»¬éœ€è¦è®©å®ƒå¯¹æ™®é€šå¼€å‘è€…æ›´å‹å¥½ã€‚&quot;</span><span class="n">è¿™ä¿ƒæˆäº†ç¯å¢ƒæƒèƒ½çš„è®¾è®¡</span><span class="err">ï¼Œ</span><span class="n">ä½¿å¾—érootè¿›ç¨‹ä¹Ÿèƒ½ä¿æŒæŸäº›æƒèƒ½</span><span class="err">ã€‚</span>

<span class="cp">## 13.7 é«˜çº§è¯é¢˜ï¼šç°ä»£å†…æ ¸å®‰å…¨æŠ€æœ¯</span>

<span class="cp">### 13.7.1 å†…æ ¸è‡ªä¿æŠ¤é¡¹ç›®ï¼ˆKSPPï¼‰</span>

<span class="n">Kernel</span><span class="w"> </span><span class="n">Self</span><span class="w"> </span><span class="n">Protection</span><span class="w"> </span><span class="n">Projectç”±Kees</span><span class="w"> </span><span class="n">Cooké¢†å¯¼</span><span class="err">ï¼Œ</span><span class="n">è‡´åŠ›äºå°†å„ç§å®‰å…¨åŠ å›ºæŠ€æœ¯æ•´åˆåˆ°ä¸»çº¿å†…æ ¸</span><span class="err">ï¼š</span>

<span class="err">```</span><span class="n">c</span>
<span class="c1">// æ§åˆ¶æµå®Œæ•´æ€§ï¼ˆCFIï¼‰</span>
<span class="c1">// ç¼–è¯‘å™¨åœ¨é—´æ¥è°ƒç”¨ç‚¹æ’å…¥ç±»å‹æ£€æŸ¥</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">cfi_check_fn</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)(</span><span class="kt">int</span><span class="p">),</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// ç¼–è¯‘å™¨ç”Ÿæˆçš„CFIæ£€æŸ¥</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">__cfi_check</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="w"> </span><span class="n">CFI_TYPE_FN</span><span class="p">))</span>
<span class="w">        </span><span class="n">__cfi_fail</span><span class="p">();</span>

<span class="w">    </span><span class="n">fn</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span><span class="w">  </span><span class="c1">// å®‰å…¨çš„é—´æ¥è°ƒç”¨</span>
<span class="p">}</span>

<span class="c1">// å†…æ ¸åœ°å€ç©ºé—´éš”ç¦»ï¼ˆKASIï¼‰</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">kasi_struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">isolated_mm</span><span class="p">;</span><span class="w">  </span><span class="c1">// éš”ç¦»çš„åœ°å€ç©ºé—´</span>
<span class="w">    </span><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="n">isolated_ptes</span><span class="p">;</span><span class="w">           </span><span class="c1">// ç‹¬ç«‹çš„é¡µè¡¨é¡¹</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">isolated_start</span><span class="p">;</span><span class="w">   </span><span class="c1">// éš”ç¦»åŒºåŸŸèµ·å§‹</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">isolated_size</span><span class="p">;</span><span class="w">    </span><span class="c1">// éš”ç¦»åŒºåŸŸå¤§å°</span>
<span class="p">};</span>

<span class="c1">// åˆå§‹åŒ–å®Œæ•´æ€§æµ‹é‡ï¼ˆIMAï¼‰</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">ima_calc_file_hash</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">ima_digest_data</span><span class="w"> </span><span class="o">*</span><span class="n">hash</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">loff_t</span><span class="w"> </span><span class="n">i_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i_size_read</span><span class="p">(</span><span class="n">file_inode</span><span class="p">(</span><span class="n">file</span><span class="p">));</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">crypto_shash</span><span class="w"> </span><span class="o">*</span><span class="n">tfm</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">shash_desc</span><span class="w"> </span><span class="o">*</span><span class="n">desc</span><span class="p">;</span>

<span class="w">    </span><span class="n">tfm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ima_alloc_tfm</span><span class="p">(</span><span class="n">hash</span><span class="o">-&gt;</span><span class="n">algo</span><span class="p">);</span>
<span class="w">    </span><span class="n">desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ima_alloc_desc</span><span class="p">(</span><span class="n">tfm</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// è®¡ç®—æ–‡ä»¶å“ˆå¸Œ</span>
<span class="w">    </span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">crypto_shash_init</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">offset</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">i_size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">rbuf_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">i_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">rbuf_size</span><span class="p">);</span>
<span class="w">        </span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">integrity_kernel_read</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">rbuf</span><span class="p">,</span><span class="w"> </span><span class="n">rbuf_len</span><span class="p">);</span>
<span class="w">        </span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">crypto_shash_update</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span><span class="w"> </span><span class="n">rbuf</span><span class="p">,</span><span class="w"> </span><span class="n">rbuf_len</span><span class="p">);</span>
<span class="w">        </span><span class="n">offset</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">rbuf_len</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">crypto_shash_final</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span><span class="w"> </span><span class="n">hash</span><span class="o">-&gt;</span><span class="n">digest</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1372">13.7.2 åŸºäºç¡¬ä»¶çš„å®‰å…¨ç‰¹æ€§</h3>
<p>ç°ä»£å¤„ç†å™¨æä¾›äº†è¶Šæ¥è¶Šå¤šçš„å®‰å…¨ç‰¹æ€§ï¼š</p>
<div class="codehilite"><pre><span></span><code>Intel CETï¼ˆæ§åˆ¶æµå¼ºåˆ¶æŠ€æœ¯ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Shadow Stack               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ ç¡¬ä»¶ç»´æŠ¤çš„è¿”å›åœ°å€æ ˆ         â”‚
â”‚  â€¢ é˜²æ­¢ROPæ”»å‡»                  â”‚
â”‚  â€¢ è‡ªåŠ¨éªŒè¯è¿”å›åœ°å€             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ARM Pointer Authenticationï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æŒ‡é’ˆè®¤è¯ç ï¼ˆPACï¼‰              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ åœ¨æŒ‡é’ˆé«˜ä½åµŒå…¥è®¤è¯ç          â”‚
â”‚  â€¢ ä½¿ç”¨å¯†é’¥ç”Ÿæˆå’ŒéªŒè¯           â”‚
â”‚  â€¢ é˜²æ­¢æŒ‡é’ˆç¯¡æ”¹                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="1373">13.7.3 å®¹å™¨å®‰å…¨ä¸æ²™ç®±æŠ€æœ¯</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// seccomp-bpfæ²™ç®±å®ç°</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">install_seccomp_filter</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sock_filter</span><span class="w"> </span><span class="n">filter</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// æ£€æŸ¥ç³»ç»Ÿè°ƒç”¨å·</span>
<span class="w">        </span><span class="n">BPF_STMT</span><span class="p">(</span><span class="n">BPF_LD</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">BPF_W</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">BPF_ABS</span><span class="p">,</span>
<span class="w">                </span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">seccomp_data</span><span class="p">,</span><span class="w"> </span><span class="n">nr</span><span class="p">)),</span>

<span class="w">        </span><span class="c1">// å…è®¸çš„ç³»ç»Ÿè°ƒç”¨ç™½åå•</span>
<span class="w">        </span><span class="n">BPF_JUMP</span><span class="p">(</span><span class="n">BPF_JMP</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">BPF_JEQ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">BPF_K</span><span class="p">,</span><span class="w"> </span><span class="n">__NR_read</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>
<span class="w">        </span><span class="n">BPF_STMT</span><span class="p">(</span><span class="n">BPF_RET</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">BPF_K</span><span class="p">,</span><span class="w"> </span><span class="n">SECCOMP_RET_ALLOW</span><span class="p">),</span>

<span class="w">        </span><span class="n">BPF_JUMP</span><span class="p">(</span><span class="n">BPF_JMP</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">BPF_JEQ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">BPF_K</span><span class="p">,</span><span class="w"> </span><span class="n">__NR_write</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>
<span class="w">        </span><span class="n">BPF_STMT</span><span class="p">(</span><span class="n">BPF_RET</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">BPF_K</span><span class="p">,</span><span class="w"> </span><span class="n">SECCOMP_RET_ALLOW</span><span class="p">),</span>

<span class="w">        </span><span class="n">BPF_JUMP</span><span class="p">(</span><span class="n">BPF_JMP</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">BPF_JEQ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">BPF_K</span><span class="p">,</span><span class="w"> </span><span class="n">__NR_exit</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>
<span class="w">        </span><span class="n">BPF_STMT</span><span class="p">(</span><span class="n">BPF_RET</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">BPF_K</span><span class="p">,</span><span class="w"> </span><span class="n">SECCOMP_RET_ALLOW</span><span class="p">),</span>

<span class="w">        </span><span class="c1">// é»˜è®¤æ‹’ç»</span>
<span class="w">        </span><span class="n">BPF_STMT</span><span class="p">(</span><span class="n">BPF_RET</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">BPF_K</span><span class="p">,</span><span class="w"> </span><span class="n">SECCOMP_RET_KILL</span><span class="p">),</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sock_fprog</span><span class="w"> </span><span class="n">prog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">filter</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">filter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filter</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// å®‰è£…è¿‡æ»¤å™¨</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prctl</span><span class="p">(</span><span class="n">PR_SET_NO_NEW_PRIVS</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prctl</span><span class="p">(</span><span class="n">PR_SET_SECCOMP</span><span class="p">,</span><span class="w"> </span><span class="n">SECCOMP_MODE_FILTER</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">prog</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Landlock LSM - ç”¨æˆ·ç©ºé—´æ²™ç®±</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">landlock_ruleset_attr</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__u64</span><span class="w"> </span><span class="n">handled_access_fs</span><span class="p">;</span><span class="w">  </span><span class="c1">// æ–‡ä»¶ç³»ç»Ÿè®¿é—®æƒé™</span>
<span class="w">    </span><span class="n">__u64</span><span class="w"> </span><span class="n">handled_access_net</span><span class="p">;</span><span class="w"> </span><span class="c1">// ç½‘ç»œè®¿é—®æƒé™</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">create_landlock_sandbox</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">landlock_ruleset_attr</span><span class="w"> </span><span class="n">attr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">handled_access_fs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LANDLOCK_ACCESS_FS_READ_FILE</span><span class="w"> </span><span class="o">|</span>
<span class="w">                            </span><span class="n">LANDLOCK_ACCESS_FS_READ_DIR</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ruleset_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">landlock_create_ruleset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// æ·»åŠ è§„åˆ™</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">landlock_path_beneath_attr</span><span class="w"> </span><span class="n">path_beneath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">allowed_access</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LANDLOCK_ACCESS_FS_READ_FILE</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">parent_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="s">&quot;/usr&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">O_PATH</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">O_CLOEXEC</span><span class="p">),</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">landlock_add_rule</span><span class="p">(</span><span class="n">ruleset_fd</span><span class="p">,</span><span class="w"> </span><span class="n">LANDLOCK_RULE_PATH_BENEATH</span><span class="p">,</span>
<span class="w">                      </span><span class="o">&amp;</span><span class="n">path_beneath</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// åº”ç”¨é™åˆ¶</span>
<span class="w">    </span><span class="n">landlock_restrict_self</span><span class="p">(</span><span class="n">ruleset_fd</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="138">13.8 æœ¬ç« å°ç»“</h2>
<p>Linuxå†…æ ¸å®‰å…¨å­ç³»ç»Ÿæ˜¯ä¸€ä¸ªå¤æ‚è€Œç²¾å¦™çš„ä½“ç³»ï¼Œä»LSMæ¡†æ¶çš„çµæ´»æ¶æ„ï¼Œåˆ°SELinuxçš„å¼ºåˆ¶è®¿é—®æ§åˆ¶ï¼Œä»ç»†ç²’åº¦çš„æƒèƒ½ç³»ç»Ÿï¼Œåˆ°å¯ç¼–ç¨‹çš„eBPFå®‰å…¨ç­–ç•¥ï¼Œæ¯ä¸€å±‚éƒ½ä½“ç°äº†æ·±æ€ç†Ÿè™‘çš„è®¾è®¡ã€‚</p>
<p><strong>æ ¸å¿ƒè¦ç‚¹å›é¡¾ï¼š</strong></p>
<ol>
<li><strong>LSMæ¡†æ¶</strong>æä¾›äº†ç»Ÿä¸€çš„å®‰å…¨é’©å­æœºåˆ¶ï¼Œæ”¯æŒå¤šç§å®‰å…¨æ¨¡å‹å…±å­˜</li>
<li><strong>SELinux</strong>å®ç°äº†æœ€ä¸¥æ ¼çš„å¼ºåˆ¶è®¿é—®æ§åˆ¶ï¼Œé€‚ç”¨äºé«˜å®‰å…¨éœ€æ±‚åœºæ™¯</li>
<li><strong>AppArmor</strong>é‡‡ç”¨åŸºäºè·¯å¾„çš„è®¿é—®æ§åˆ¶ï¼Œé…ç½®æ›´åŠ ç›´è§‚</li>
<li><strong>æƒèƒ½ç³»ç»Ÿ</strong>å°†rootæƒé™ç»†åˆ†ï¼Œå®ç°æœ€å°æƒé™åŸåˆ™</li>
<li><strong>eBPFå®‰å…¨</strong>æä¾›äº†åŠ¨æ€ã€å¯ç¼–ç¨‹çš„å®‰å…¨ç­–ç•¥å®æ–½</li>
<li><strong>å¨èƒæ¨¡å‹</strong>æ¶µç›–æƒé™æå‡ã€ä¾§ä¿¡é“ã€å†…å­˜æŸåç­‰å¤šç§æ”»å‡»å‘é‡</li>
</ol>
<p><strong>å…³é”®å…¬å¼ï¼š</strong></p>
<p>è®¿é—®æ§åˆ¶å†³ç­–ï¼š
$$\text{Decision} = \text{DAC}(S,O,P) \land \text{MAC}(S,O,P) \land \text{Capability}(S,P)$$
å…¶ä¸­ï¼š</p>
<ul>
<li>$S$ = ä¸»ä½“ï¼ˆSubjectï¼‰</li>
<li>$O$ = å®¢ä½“ï¼ˆObjectï¼‰  </li>
<li>$P$ = æƒé™ï¼ˆPermissionï¼‰</li>
</ul>
<p>æƒèƒ½ä¼ é€’å…¬å¼ï¼š
$$P'_{permitted} = (P_{inheritable} \cap F_{inheritable}) \cup (F_{permitted} \cap \text{cap_bset}) \cup P'_{ambient}$$
å®‰å…¨å¼ºåº¦è¯„ä¼°ï¼š
$$\text{Security_Strength} = \sum_{i=1}^{n} w_i \cdot \text{Control}_i$$</p>
<p>å…¶ä¸­$w_i$ä¸ºå„å®‰å…¨æ§åˆ¶çš„æƒé‡ã€‚</p>
<h2 id="139">13.9 ç»ƒä¹ é¢˜</h2>
<h3 id="_4">åŸºç¡€é¢˜</h3>
<p><strong>ç»ƒä¹ 13.1</strong>ï¼šè§£é‡ŠLSMæ¡†æ¶ä¸­security_hook_headsçš„ä½œç”¨ï¼Œä»¥åŠå®ƒå¦‚ä½•æ”¯æŒå¤šä¸ªå®‰å…¨æ¨¡å—çš„ä¸²è”ã€‚</p>
<details>
<summary>æç¤º</summary>
<p>è€ƒè™‘é’©å­é“¾è¡¨çš„éå†é¡ºåºå’Œè¿”å›å€¼å¤„ç†æœºåˆ¶ã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>security_hook_headsæ˜¯ä¸€ä¸ªåŒ…å«æ‰€æœ‰å®‰å…¨é’©å­é“¾è¡¨å¤´çš„ç»“æ„ã€‚æ¯ä¸ªé’©å­ä½ç½®å¯ä»¥æ³¨å†Œå¤šä¸ªå®‰å…¨æ¨¡å—çš„å¤„ç†å‡½æ•°ï¼Œå½¢æˆé“¾è¡¨ã€‚è°ƒç”¨æ—¶æŒ‰æ³¨å†Œé¡ºåºéå†ï¼Œä»»ä½•æ¨¡å—è¿”å›é”™è¯¯éƒ½ä¼šç»ˆæ­¢æ“ä½œã€‚è¿™ç§è®¾è®¡å…è®¸å¤šä¸ªå®‰å…¨æ¨¡å—ååŒå·¥ä½œï¼Œå®ç°çºµæ·±é˜²å¾¡ã€‚</p>
</details>
<p><strong>ç»ƒä¹ 13.2</strong>ï¼šç¼–å†™ä¸€ä¸ªç®€å•çš„AppArmoré…ç½®æ–‡ä»¶ï¼Œé™åˆ¶nginxåªèƒ½è®¿é—®/var/wwwç›®å½•å’Œç›‘å¬80ç«¯å£ã€‚</p>
<details>
<summary>æç¤º</summary>
<p>éœ€è¦è€ƒè™‘æ–‡ä»¶è®¿é—®æƒé™ã€ç½‘ç»œæƒé™å’Œå¿…è¦çš„ç³»ç»Ÿèµ„æºã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>é…ç½®åŒ…æ‹¬ï¼š/var/www/*<em> ræƒé™ç”¨äºè¯»å–ç½‘é¡µæ–‡ä»¶ï¼Œ/var/log/nginx/</em> wæƒé™ç”¨äºå†™æ—¥å¿—ï¼Œcapability net_bind_serviceç”¨äºç»‘å®š80ç«¯å£ï¼Œnetwork inet streamç”¨äºTCPè¿æ¥ã€‚è¿˜éœ€åŒ…å«åŸºç¡€æŠ½è±¡å¦‚abstractions/baseã€‚</p>
</details>
<p><strong>ç»ƒä¹ 13.3</strong>ï¼šè¯´æ˜ä¸ºä»€ä¹ˆCAP_SYS_ADMINè¢«ç§°ä¸º"æ–°çš„root"ï¼Œå¹¶ç»™å‡ºä¸‰ä¸ªåº”è¯¥é¿å…æˆäºˆæ­¤æƒèƒ½çš„åŸå› ã€‚</p>
<details>
<summary>æç¤º</summary>
<p>æŸ¥çœ‹CAP_SYS_ADMINå…è®¸çš„æ“ä½œåˆ—è¡¨ã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>CAP_SYS_ADMINå…è®¸æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿã€é…ç½®äº¤æ¢ç©ºé—´ã€æ‰§è¡Œå„ç§ç³»ç»Ÿç®¡ç†æ“ä½œï¼Œå‡ ä¹ç­‰åŒäºrootã€‚åº”é¿å…æˆäºˆå› ä¸ºï¼š1)è¿èƒŒæœ€å°æƒé™åŸåˆ™ï¼Œ2)å¯èƒ½é€šè¿‡æŒ‚è½½ç»•è¿‡å…¶ä»–å®‰å…¨é™åˆ¶ï¼Œ3)å¢å¤§æ”»å‡»é¢ã€‚åº”è¯¥ä½¿ç”¨æ›´å…·ä½“çš„æƒèƒ½å¦‚CAP_NET_ADMINæˆ–CAP_SYS_MODULEã€‚</p>
</details>
<h3 id="_5">æŒ‘æˆ˜é¢˜</h3>
<p><strong>ç»ƒä¹ 13.4</strong>ï¼šè®¾è®¡ä¸€ä¸ªåŸºäºeBPFçš„å®‰å…¨ç›‘æ§ç³»ç»Ÿï¼Œæ£€æµ‹å¹¶é˜»æ­¢è¿›ç¨‹çš„å¼‚å¸¸forkè¡Œä¸ºï¼ˆforkç‚¸å¼¹æ”»å‡»ï¼‰ã€‚</p>
<details>
<summary>æç¤º</summary>
<p>éœ€è¦è·Ÿè¸ªæ¯ä¸ªè¿›ç¨‹çš„forké¢‘ç‡ï¼Œè®¾ç½®é˜ˆå€¼ï¼Œä½¿ç”¨BPF mapå­˜å‚¨çŠ¶æ€ã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>æ–¹æ¡ˆåŒ…æ‹¬ï¼šä½¿ç”¨BPF_MAP_TYPE_HASHå­˜å‚¨æ¯ä¸ªPIDçš„forkè®¡æ•°å’Œæ—¶é—´æˆ³ï¼Œåœ¨sched_process_forkè·Ÿè¸ªç‚¹æ›´æ–°è®¡æ•°ï¼Œå®ç°æ»‘åŠ¨çª—å£ç®—æ³•è®¡ç®—forké€Ÿç‡ï¼Œè¶…è¿‡é˜ˆå€¼æ—¶é€šè¿‡bpf_send_signalå‘é€SIGKILLã€‚éœ€è¦è€ƒè™‘mapæ¸…ç†å’Œçˆ¶å­è¿›ç¨‹å…³ç³»ã€‚</p>
</details>
<p><strong>ç»ƒä¹ 13.5</strong>ï¼šåˆ†æDirty COWï¼ˆCVE-2016-5195ï¼‰æ¼æ´çš„åŸç†ï¼Œè§£é‡Šå®ƒå¦‚ä½•ç»•è¿‡Linuxçš„æƒé™ç³»ç»Ÿï¼Œä»¥åŠå†…æ ¸æ˜¯å¦‚ä½•ä¿®å¤çš„ã€‚</p>
<details>
<summary>æç¤º</summary>
<p>å…³æ³¨å†™æ—¶å¤åˆ¶ï¼ˆCOWï¼‰æœºåˆ¶å’Œç«æ€æ¡ä»¶ã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>Dirty COWåˆ©ç”¨äº†get_user_pages()å’ŒCOWæœºåˆ¶ä¹‹é—´çš„ç«æ€æ¡ä»¶ã€‚é€šè¿‡madvise(MADV_DONTNEED)å’Œå†™å…¥åªè¯»æ˜ å°„çš„ç«äº‰ï¼Œå¯ä»¥ç›´æ¥ä¿®æ”¹é¡µç¼“å­˜ä¸­çš„åŸå§‹é¡µé¢ã€‚ä¿®å¤æ–¹æ¡ˆæ˜¯åœ¨å¤„ç†COWæ—¶å¢åŠ é¢å¤–çš„æ ‡å¿—ä½FOLL_COWï¼Œç¡®ä¿å†™æ“ä½œæ€»æ˜¯è§¦å‘é¡µé¢å¤åˆ¶ï¼Œé¿å…ç›´æ¥ä¿®æ”¹å…±äº«é¡µé¢ã€‚</p>
</details>
<p><strong>ç»ƒä¹ 13.6</strong>ï¼šå®ç°ä¸€ä¸ªLSMæ¨¡å—ï¼Œé™åˆ¶ç‰¹å®šè¿›ç¨‹åªèƒ½åˆ›å»ºç‰¹å®šç±»å‹çš„æ–‡ä»¶ï¼ˆå¦‚åªèƒ½åˆ›å»º.logæ–‡ä»¶ï¼‰ã€‚</p>
<details>
<summary>æç¤º</summary>
<p>éœ€è¦hookæ–‡ä»¶åˆ›å»ºç›¸å…³çš„LSMé’©å­ï¼Œæ£€æŸ¥æ–‡ä»¶ååç¼€ã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>å®ç°éœ€è¦ï¼š1)æ³¨å†Œinode_createå’Œinode_mknodé’©å­ï¼Œ2)åœ¨é’©å­å‡½æ•°ä¸­è·å–å½“å‰è¿›ç¨‹åå’Œç›®æ ‡æ–‡ä»¶åï¼Œ3)ä½¿ç”¨é…ç½®çš„ç™½åå•æ£€æŸ¥æ–‡ä»¶æ‰©å±•åï¼Œ4)ç»´æŠ¤è¿›ç¨‹åˆ°å…è®¸æ‰©å±•åçš„æ˜ å°„è¡¨ï¼Œ5)å¤„ç†ç¬¦å·é“¾æ¥å’Œç¡¬é“¾æ¥çš„ç‰¹æ®Šæƒ…å†µã€‚</p>
</details>
<p><strong>ç»ƒä¹ 13.7</strong>ï¼šè®¾è®¡ä¸€ä¸ªåŸºäºSELinuxçš„å¤šç§Ÿæˆ·éš”ç¦»æ–¹æ¡ˆï¼Œç¡®ä¿ä¸åŒç§Ÿæˆ·çš„è¿›ç¨‹å’Œæ–‡ä»¶å®Œå…¨éš”ç¦»ã€‚</p>
<details>
<summary>æç¤º</summary>
<p>ä½¿ç”¨MCSï¼ˆMulti-Category Securityï¼‰æˆ–MLSï¼ˆMulti-Level Securityï¼‰ã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>æ–¹æ¡ˆè®¾è®¡ï¼šä¸ºæ¯ä¸ªç§Ÿæˆ·åˆ†é…å”¯ä¸€çš„ç±»åˆ«ï¼ˆå¦‚c0,c1,c2ï¼‰ï¼Œåˆ›å»ºç§Ÿæˆ·ä¸“ç”¨çš„ç±»å‹ï¼ˆtenant1_t, tenant2_tï¼‰ï¼Œä½¿ç”¨MCSçº¦æŸç¡®ä¿è¿›ç¨‹åªèƒ½è®¿é—®ç›¸åŒç±»åˆ«çš„èµ„æºã€‚ç­–ç•¥è§„åˆ™åŒ…æ‹¬ç±»å‹è½¬æ¢è§„åˆ™ã€æ–‡ä»¶ä¸Šä¸‹æ–‡è§„åˆ™å’Œç½‘ç»œæ ‡ç­¾è§„åˆ™ã€‚è¿˜éœ€è€ƒè™‘å…±äº«èµ„æºçš„å¤„ç†å’Œç®¡ç†åŸŸçš„è®¾ç½®ã€‚</p>
</details>
<p><strong>ç»ƒä¹ 13.8</strong>ï¼šåˆ†æå¹¶æ¯”è¾ƒKASLRã€KPTIã€CETä¸‰ç§å†…æ ¸ä¿æŠ¤æœºåˆ¶çš„æ€§èƒ½å¼€é”€å’Œå®‰å…¨æ•ˆç›Šã€‚</p>
<details>
<summary>æç¤º</summary>
<p>è€ƒè™‘å„æœºåˆ¶é˜²æŠ¤çš„æ”»å‡»ç±»å‹å’Œå®ç°ä»£ä»·ã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>KASLRéšæœºåŒ–å†…æ ¸åœ°å€ï¼Œå¼€é”€å°ï¼ˆ&lt;1%ï¼‰ï¼Œä½†å¯é€šè¿‡ä¾§ä¿¡é“æ³„éœ²ã€‚KPTIéš”ç¦»é¡µè¡¨é˜²Meltdownï¼Œå¼€é”€å¤§ï¼ˆ5-30%ï¼‰ï¼Œæ•ˆæœç¡®å®šã€‚CETé˜²æ§åˆ¶æµåŠ«æŒï¼Œéœ€ç¡¬ä»¶æ”¯æŒï¼Œå¼€é”€ä¸­ç­‰ï¼ˆ2-5%ï¼‰ï¼Œé˜²æŠ¤ROP/JOPæ”»å‡»æ•ˆæœå¥½ã€‚å®é™…éƒ¨ç½²éœ€æ ¹æ®å¨èƒæ¨¡å‹å’Œæ€§èƒ½è¦æ±‚æƒè¡¡ã€‚</p>
</details>
<h2 id="1310">13.10 å¸¸è§é™·é˜±ä¸é”™è¯¯</h2>
<h3 id="1dac">é™·é˜±1ï¼šè¿‡åº¦ä¾èµ–DACæƒé™æ£€æŸ¥</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯ï¼šåªæ£€æŸ¥DACæƒé™</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_DAC_OVERRIDE</span><span class="p">))</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="c1">// å±é™©ï¼ç»•è¿‡äº†æ‰€æœ‰LSMæ£€æŸ¥</span>

<span class="c1">// æ­£ç¡®ï¼šDACå’ŒLSMéƒ½è¦æ£€æŸ¥</span>
<span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generic_permission</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="n">mask</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="k">return</span><span class="w"> </span><span class="n">security_inode_permission</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="n">mask</span><span class="p">);</span>
</code></pre></div>

<h3 id="2">é™·é˜±2ï¼šå¿½è§†æƒèƒ½çš„ç»§æ‰¿è§„åˆ™</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># é”™è¯¯ï¼šæœŸæœ›å­è¿›ç¨‹ç»§æ‰¿çˆ¶è¿›ç¨‹çš„æ‰€æœ‰æƒèƒ½</span>
setcap<span class="w"> </span>cap_net_admin+ep<span class="w"> </span>/usr/bin/parent
<span class="c1"># å­è¿›ç¨‹ä¸ä¼šè‡ªåŠ¨è·å¾—cap_net_admin</span>

<span class="c1"># æ­£ç¡®ï¼šè®¾ç½®ç»§æ‰¿ä½</span>
setcap<span class="w"> </span>cap_net_admin+eip<span class="w"> </span>/usr/bin/parent
</code></pre></div>

<h3 id="3selinux">é™·é˜±3ï¼šSELinuxä¸Šä¸‹æ–‡è½¬æ¢é”™è¯¯</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯ï¼šå¿˜è®°è®¾ç½®æ‰§è¡Œä¸Šä¸‹æ–‡</span>
<span class="n">execve</span><span class="p">(</span><span class="s">&quot;/usr/bin/service&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="n">envp</span><span class="p">);</span>
<span class="c1">// è¿›ç¨‹ä»åœ¨åŸåŸŸä¸­è¿è¡Œ</span>

<span class="c1">// æ­£ç¡®ï¼šç¡®ä¿ç±»å‹è½¬æ¢è§„åˆ™å­˜åœ¨</span>
<span class="c1">// type_transition init_t service_exec_t:process service_t;</span>
</code></pre></div>

<h3 id="4ebpf">é™·é˜±4ï¼šeBPFéªŒè¯å™¨é™åˆ¶</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯ï¼šæ— ç•Œå¾ªç¯</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">user_provided_value</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// BPFéªŒè¯å™¨ä¼šæ‹’ç»</span>
<span class="p">}</span>

<span class="c1">// æ­£ç¡®ï¼šæœ‰ç•Œå¾ªç¯</span>
<span class="cp">#pragma unroll</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">user_value</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// éªŒè¯å™¨å¯ä»¥è¯æ˜å¾ªç¯æœ‰ç•Œ</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="5">é™·é˜±5ï¼šå®‰å…¨æ¨¡å—åŠ è½½é¡ºåº</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># é”™è¯¯ï¼šæœŸæœ›ååŠ è½½çš„æ¨¡å—ä¼˜å…ˆçº§æ›´é«˜</span>
insmod<span class="w"> </span>security_module1.ko
insmod<span class="w"> </span>security_module2.ko<span class="w">  </span><span class="c1"># ä¸ä¸€å®šä¼˜å…ˆ</span>

<span class="c1"># æ­£ç¡®ï¼šä½¿ç”¨security=å‚æ•°æŒ‡å®šä¸»æ¨¡å—</span>
<span class="c1"># åœ¨grubä¸­ï¼šsecurity=selinux</span>
</code></pre></div>

<h2 id="1311">13.11 æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•</h2>
<h3 id="_6">è®¾è®¡é˜¶æ®µ</h3>
<ul>
<li>[ ] æ˜ç¡®å®šä¹‰å®‰å…¨éœ€æ±‚å’Œå¨èƒæ¨¡å‹</li>
<li>[ ] é€‰æ‹©åˆé€‚çš„å®‰å…¨æ¨¡å‹ï¼ˆDAC/MAC/RBACï¼‰</li>
<li>[ ] è®¾è®¡æœ€å°æƒé™çš„æƒèƒ½é›†åˆ</li>
<li>[ ] è§„åˆ’å®‰å…¨æ¨¡å—çš„éƒ¨ç½²ç­–ç•¥</li>
<li>[ ] è€ƒè™‘æ€§èƒ½å½±å“å’Œå¯ç”¨æ€§å¹³è¡¡</li>
</ul>
<h3 id="_7">å®ç°é˜¶æ®µ</h3>
<ul>
<li>[ ] æ­£ç¡®å®ç°LSMé’©å­ï¼Œé¿å…TOCTOUé—®é¢˜</li>
<li>[ ] ä½¿ç”¨å†…æ ¸åŠ å›ºé€‰é¡¹ï¼ˆCONFIG_HARDENED_USERCOPYç­‰ï¼‰</li>
<li>[ ] å®æ–½è¾“å…¥éªŒè¯å’Œè¾¹ç•Œæ£€æŸ¥</li>
<li>[ ] é¿å…ä¿¡æ¯æ³„éœ²ï¼ˆæ¸…é›¶æ•æ„Ÿæ•°æ®ï¼‰</li>
<li>[ ] ä½¿ç”¨å®‰å…¨çš„å†…æ ¸APIï¼ˆå¦‚copy_from_userï¼‰</li>
</ul>
<h3 id="_8">é…ç½®é˜¶æ®µ</h3>
<ul>
<li>[ ] é…ç½®SELinux/AppArmorç­–ç•¥</li>
<li>[ ] è®¾ç½®é€‚å½“çš„æƒèƒ½è¾¹ç•Œé›†</li>
<li>[ ] å¯ç”¨å®¡è®¡æ—¥å¿—è®°å½•</li>
<li>[ ] é…ç½®seccompè¿‡æ»¤å™¨</li>
<li>[ ] å®æ–½ç½‘ç»œå®‰å…¨ç­–ç•¥</li>
</ul>
<h3 id="_9">è¿è¡Œé˜¶æ®µ</h3>
<ul>
<li>[ ] ç›‘æ§å®‰å…¨äº‹ä»¶å’Œå®¡è®¡æ—¥å¿—</li>
<li>[ ] å®šæœŸæ›´æ–°å®‰å…¨ç­–ç•¥</li>
<li>[ ] è¿›è¡Œå®‰å…¨æ¼æ´æ‰«æ</li>
<li>[ ] å®æ–½å…¥ä¾µæ£€æµ‹ç³»ç»Ÿ</li>
<li>[ ] åˆ¶å®šåº”æ€¥å“åº”è®¡åˆ’</li>
</ul>
<h3 id="_10">å®¡è®¡é˜¶æ®µ</h3>
<ul>
<li>[ ] å®¡æŸ¥æƒé™å’Œæƒèƒ½åˆ†é…</li>
<li>[ ] æ£€æŸ¥å®‰å…¨ç­–ç•¥çš„æœ‰æ•ˆæ€§</li>
<li>[ ] åˆ†ææ€§èƒ½å½±å“</li>
<li>[ ] è¯„ä¼°å®‰å…¨åˆè§„æ€§</li>
<li>[ ] æ›´æ–°å¨èƒæ¨¡å‹</li>
</ul>
<hr />
<p>é€šè¿‡æœ¬ç« çš„å­¦ä¹ ï¼Œæˆ‘ä»¬æ·±å…¥ç†è§£äº†Linuxå†…æ ¸çš„å®‰å…¨æ¶æ„ï¼Œä»çµæ´»çš„LSMæ¡†æ¶åˆ°å¼ºå¤§çš„SELinuxï¼Œä»ç»†ç²’åº¦çš„æƒèƒ½ç³»ç»Ÿåˆ°åŠ¨æ€çš„eBPFå®‰å…¨ã€‚å®‰å…¨æ˜¯ä¸€ä¸ªæŒç»­æ¼”è¿›çš„é¢†åŸŸï¼Œéœ€è¦åœ¨å¯ç”¨æ€§ã€æ€§èƒ½å’Œå®‰å…¨æ€§ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ã€‚ä¸‹ä¸€ç« ï¼Œæˆ‘ä»¬å°†æ¢è®¨å®æ—¶Linuxï¼Œäº†è§£å¦‚ä½•åœ¨ä¿è¯å®‰å…¨çš„åŒæ—¶æ»¡è¶³ä¸¥æ ¼çš„å®æ—¶æ€§è¦æ±‚ã€‚
```</p>
            </article>
            
            <nav class="page-nav"><a href="chapter12.html" class="nav-link prev">â† ç¬¬12ç« ï¼šå®¹å™¨ä¸å‘½åç©ºé—´</a><a href="chapter14.html" class="nav-link next">ç¬¬14ç« ï¼šå®æ—¶Linux â†’</a></nav>
        </main>
    </div>
</body>
</html>