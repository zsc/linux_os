<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬14ç« ï¼šå®æ—¶Linux</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Linux å†…æ ¸æºä»£ç æ·±åº¦è§£æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬1ç« ï¼šLinux å†…æ ¸æ¦‚è¿°ä¸å‘å±•å²</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬2ç« ï¼šè¿›ç¨‹ç®¡ç†ä¸ä»»åŠ¡è°ƒåº¦</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬3ç« ï¼šå†…å­˜ç®¡ç†æ¶æ„</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬4ç« ï¼šè¿›ç¨‹é—´é€šä¿¡æœºåˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬5ç« ï¼šè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬6ç« ï¼šå…·ä½“æ–‡ä»¶ç³»ç»Ÿå®ç°</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬7ç« ï¼šå—è®¾å¤‡å±‚ä¸I/Oè°ƒåº¦</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬8ç« ï¼šè®¾å¤‡é©±åŠ¨æ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬9ç« ï¼šç½‘ç»œåè®®æ ˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬10ç« ï¼šå†…æ ¸åŒæ­¥æœºåˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬11ç« ï¼šå¹¶å‘ç¼–ç¨‹æ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬12ç« ï¼šå®¹å™¨ä¸å‘½åç©ºé—´</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬13ç« ï¼šå®‰å…¨å­ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬14ç« ï¼šå®æ—¶Linux</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬15ç« ï¼šæ€§èƒ½åˆ†æä¸è°ƒè¯•</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬16ç« ï¼šå¼•å¯¼è¿‡ç¨‹ä¸åˆå§‹åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="14linux">ç¬¬14ç« ï¼šå®æ—¶Linux</h1>
<h2 id="_1">æœ¬ç« å­¦ä¹ ç›®æ ‡</h2>
<p>å®æ—¶ç³»ç»Ÿè¦æ±‚ä»»åŠ¡åœ¨ç¡®å®šçš„æ—¶é—´çº¦æŸå†…å®Œæˆï¼Œè¿™å¯¹ä¼ ç»Ÿ Linux å†…æ ¸æå‡ºäº†ä¸¥å³»æŒ‘æˆ˜ã€‚æœ¬ç« æ·±å…¥å‰–æ Linux å®æ—¶æ‰©å±•çš„æ ¸å¿ƒæŠ€æœ¯ï¼Œä» PREEMPT_RT è¡¥ä¸é›†åˆ° SCHED_DEADLINE è°ƒåº¦å™¨ï¼Œä»ä¼˜å…ˆçº§ç»§æ‰¿æœºåˆ¶åˆ°é«˜ç²¾åº¦å®šæ—¶å™¨ã€‚é€šè¿‡å­¦ä¹ æœ¬ç« ï¼Œæ‚¨å°†æŒæ¡å¦‚ä½•å°†é€šç”¨ Linux è½¬å˜ä¸ºæ»¡è¶³ä¸¥æ ¼æ—¶é—´çº¦æŸçš„å®æ—¶æ“ä½œç³»ç»Ÿï¼Œç†è§£å»¶è¿Ÿçš„æ¥æºä¸ä¼˜åŒ–æŠ€æœ¯ï¼Œå¹¶èƒ½å¤Ÿè®¾è®¡å’Œè°ƒè¯•å®æ—¶åº”ç”¨ã€‚</p>
<h2 id="141">14.1 å®æ—¶ç³»ç»ŸåŸºç¡€æ¦‚å¿µ</h2>
<h3 id="1411">14.1.1 å®æ—¶æ€§å®šä¹‰ä¸åˆ†ç±»</h3>
<p>å®æ—¶ç³»ç»Ÿçš„æ ¸å¿ƒæ˜¯<strong>å¯é¢„æµ‹æ€§</strong>è€Œéå•çº¯çš„å¿«é€Ÿå“åº”ã€‚ä¸€ä¸ªå®æ—¶ç³»ç»Ÿå¿…é¡»ä¿è¯ï¼š</p>
<p>$$\forall t_i \in T: t_{response} \leq t_{deadline}$$
å…¶ä¸­ $T$ æ˜¯ä»»åŠ¡é›†åˆï¼Œ$t_{response}$ æ˜¯å“åº”æ—¶é—´ï¼Œ$t_{deadline}$ æ˜¯æˆªæ­¢æ—¶é—´ã€‚</p>
<p>æ ¹æ®å¯¹æˆªæ­¢æ—¶é—´è¿åçš„å®¹å¿åº¦ï¼Œå®æ—¶ç³»ç»Ÿåˆ†ä¸ºï¼š</p>
<ol>
<li>
<p><strong>ç¡¬å®æ—¶ï¼ˆHard Real-timeï¼‰</strong>ï¼šé”™è¿‡æˆªæ­¢æ—¶é—´å°†å¯¼è‡´ç¾éš¾æ€§åæœ
   - ä¾‹ï¼šé£æœºæ§åˆ¶ç³»ç»Ÿã€å¿ƒè„èµ·æå™¨
   - è¦æ±‚ï¼šæœ€åæƒ…å†µæ‰§è¡Œæ—¶é—´ï¼ˆWCETï¼‰å¿…é¡»å¯è¯æ˜</p>
</li>
<li>
<p><strong>è½¯å®æ—¶ï¼ˆSoft Real-timeï¼‰</strong>ï¼šå¶å°”é”™è¿‡æˆªæ­¢æ—¶é—´å¯æ¥å—ä½†ä¼šé™ä½æœåŠ¡è´¨é‡
   - ä¾‹ï¼šè§†é¢‘æ’­æ”¾ã€VoIP é€šè¯
   - è¦æ±‚ï¼šç»Ÿè®¡æ„ä¹‰ä¸Šçš„å»¶è¿Ÿä¿è¯</p>
</li>
<li>
<p><strong>å›ºå®æ—¶ï¼ˆFirm Real-timeï¼‰</strong>ï¼šé”™è¿‡æˆªæ­¢æ—¶é—´çš„ç»“æœæ— ç”¨ä½†ä¸ç¾éš¾
   - ä¾‹ï¼šå·¥ä¸šæ§åˆ¶æ˜¾ç¤ºç³»ç»Ÿ
   - è¦æ±‚ï¼šåŠæ—¶æ€§ä¸èµ„æºåˆ©ç”¨ç‡å¹³è¡¡</p>
</li>
</ol>
<h3 id="1412-linux">14.1.2 Linux å†…æ ¸å»¶è¿Ÿæ¥æº</h3>
<p>æ ‡å‡† Linux å†…æ ¸çš„å»¶è¿Ÿä¸»è¦æ¥è‡ªï¼š</p>
<div class="codehilite"><pre><span></span><code>ä¸­æ–­å»¶è¿Ÿé“¾ï¼š
    ç¡¬ä»¶ä¸­æ–­ â†’ ä¸­æ–­å¤„ç†ç¨‹åº
         â†“
    è½¯ä¸­æ–­å¤„ç† â†’ ä»»åŠ¡è°ƒåº¦
         â†“
    ç”¨æˆ·è¿›ç¨‹æ‰§è¡Œ
</code></pre></div>

<p>å…·ä½“å»¶è¿Ÿç»„æˆï¼š</p>
<ol>
<li>
<p><strong>ä¸­æ–­å»¶è¿Ÿ</strong>ï¼ˆInterrupt Latencyï¼‰
   - ä¸­æ–­ç¦ç”¨æœŸé—´ï¼šä¸´ç•ŒåŒºä¿æŠ¤
   - ä¸­æ–­å¤„ç†æ—¶é—´ï¼šISR æ‰§è¡Œ
   - å…¬å¼ï¼š$L_{irq} = T_{disable} + T_{ISR}$</p>
</li>
<li>
<p><strong>è°ƒåº¦å»¶è¿Ÿ</strong>ï¼ˆScheduling Latencyï¼‰
   - å†…æ ¸ä¸å¯æŠ¢å åŒºï¼šè‡ªæ—‹é”æŒæœ‰æœŸ
   - è°ƒåº¦å™¨å¼€é”€ï¼šä»»åŠ¡é€‰æ‹©ç®—æ³•
   - å…¬å¼ï¼š$L_{sched} = T_{preempt_disable} + T_{scheduler}$</p>
</li>
<li>
<p><strong>åŒæ­¥å»¶è¿Ÿ</strong>ï¼ˆSynchronization Latencyï¼‰
   - ä¼˜å…ˆçº§åè½¬ï¼šä½ä¼˜å…ˆçº§ä»»åŠ¡æŒé”
   - é”ç«äº‰ï¼šç­‰å¾…èµ„æºé‡Šæ”¾</p>
</li>
</ol>
<h3 id="1413">14.1.3 å®æ—¶æ€§æ¼”è¿›å†ç¨‹</h3>
<p>Linux å®æ—¶æ€§æ”¹è¿›çš„é‡Œç¨‹ç¢‘ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="mi">1991</span><span class="o">:</span><span class="w"> </span><span class="n">Linux</span><span class="w"> </span><span class="mf">0.01</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="err">å®Œå…¨ä¸å¯æŠ¢å </span>
<span class="w">  </span><span class="o">|</span>
<span class="mi">2001</span><span class="o">:</span><span class="w"> </span><span class="mf">2.4</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="err">å¼•å…¥ä½å»¶è¿Ÿè¡¥ä¸</span>
<span class="w">  </span><span class="o">|</span>
<span class="mi">2003</span><span class="o">:</span><span class="w"> </span><span class="mf">2.6</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="err">å†…æ ¸å¯æŠ¢å ï¼ˆ</span><span class="n">CONFIG_PREEMPT</span><span class="err">ï¼‰</span>
<span class="w">  </span><span class="o">|</span>
<span class="mi">2004</span><span class="o">:</span><span class="w"> </span><span class="n">PREEMPT_RT</span><span class="w"> </span><span class="err">é¡¹ç›®å¯åŠ¨ï¼ˆ</span><span class="n">Ingo</span><span class="w"> </span><span class="n">Molnar</span><span class="err">ï¼‰</span>
<span class="w">  </span><span class="o">|</span>
<span class="mi">2005</span><span class="o">:</span><span class="w"> </span><span class="err">é«˜ç²¾åº¦å®šæ—¶å™¨ï¼ˆ</span><span class="n">hrtimer</span><span class="err">ï¼‰</span>
<span class="w">  </span><span class="o">|</span>
<span class="mi">2009</span><span class="o">:</span><span class="w"> </span><span class="n">SCHED_DEADLINE</span><span class="w"> </span><span class="err">è°ƒåº¦ç±»</span>
<span class="w">  </span><span class="o">|</span>
<span class="mi">2019</span><span class="o">:</span><span class="w"> </span><span class="mf">5.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">PREEMPT_RT</span><span class="w"> </span><span class="err">å¼€å§‹ä¸»çº¿åŒ–</span>
<span class="w">  </span><span class="o">|</span>
<span class="mi">2023</span><span class="o">:</span><span class="w"> </span><span class="mi">6</span><span class="o">.</span><span class="na">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="err">å¤§éƒ¨åˆ†</span><span class="w"> </span><span class="n">RT</span><span class="w"> </span><span class="err">ç‰¹æ€§å·²ä¸»çº¿</span>
</code></pre></div>

<h2 id="142-preempt_rt">14.2 PREEMPT_RT è¡¥ä¸é›†</h2>
<h3 id="1421">14.2.1 æ ¸å¿ƒè®¾è®¡ç†å¿µ</h3>
<p>PREEMPT_RT çš„ç›®æ ‡æ˜¯å°† Linux è½¬å˜ä¸ºå®Œå…¨å¯æŠ¢å çš„å†…æ ¸ï¼š</p>
<div class="codehilite"><pre><span></span><code>æ ‡å‡†å†…æ ¸æ‰§è¡Œæµï¼š
    ç”¨æˆ·ç©ºé—´ â†’ [å¯æŠ¢å ]
         â†“
    ç³»ç»Ÿè°ƒç”¨ â†’ [éƒ¨åˆ†å¯æŠ¢å ]
         â†“
    ä¸­æ–­å¤„ç† â†’ [ä¸å¯æŠ¢å ]

PREEMPT_RT æ‰§è¡Œæµï¼š
    ç”¨æˆ·ç©ºé—´ â†’ [å¯æŠ¢å ]
         â†“
    ç³»ç»Ÿè°ƒç”¨ â†’ [å®Œå…¨å¯æŠ¢å ]
         â†“
    çº¿ç¨‹åŒ–ä¸­æ–­ â†’ [å¯æŠ¢å ]
</code></pre></div>

<h3 id="1422">14.2.2 å…³é”®ç»„ä»¶æ”¹é€ </h3>
<h4 id="_2">è‡ªæ—‹é”è½¬æ¢ä¸ºå¯ç¡çœ é”</h4>
<p>æ ‡å‡†å†…æ ¸çš„ spinlock åœ¨ RT ä¸­å˜ä¸º rt_mutexï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* æ ‡å‡†å†…æ ¸ */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">spinlock</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">arch_spinlock_t</span><span class="w"> </span><span class="n">raw_lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* PREEMPT_RT */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">spinlock</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rt_mutex_base</span><span class="w"> </span><span class="n">lock</span><span class="p">;</span><span class="w">  </span><span class="cm">/* å¯ç¡çœ çš„äº’æ–¥é” */</span>
<span class="cp">#ifdef CONFIG_DEBUG_LOCK_ALLOC</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lockdep_map</span><span class="w"> </span><span class="n">dep_map</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">};</span>
</code></pre></div>

<p>è¿™ç§è½¬æ¢çš„å½±å“ï¼š</p>
<ul>
<li>ä¸´ç•ŒåŒºå˜ä¸ºå¯æŠ¢å </li>
<li>æŒé”æ—¶å¯ä»¥ç¡çœ </li>
<li>æ”¯æŒä¼˜å…ˆçº§ç»§æ‰¿</li>
</ul>
<h4 id="_3">ä¸­æ–­çº¿ç¨‹åŒ–</h4>
<p>å°†ä¸­æ–­å¤„ç†ç¨‹åºè½¬æ¢ä¸ºå†…æ ¸çº¿ç¨‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* ä¸­æ–­çº¿ç¨‹åŒ–ç»“æ„ */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">irq_desc</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">irqaction</span><span class="w"> </span><span class="o">*</span><span class="n">action</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="kr">thread</span><span class="p">;</span><span class="w">  </span><span class="cm">/* ä¸­æ–­çº¿ç¨‹ */</span>
<span class="w">    </span><span class="n">wait_queue_head_t</span><span class="w"> </span><span class="n">wait_for_threads</span><span class="p">;</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">threads_active</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* çº¿ç¨‹åŒ–ä¸­æ–­å¤„ç†æµç¨‹ */</span>
<span class="n">irqreturn_t</span><span class="w"> </span><span class="nf">handle_irq_event</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">irq_desc</span><span class="w"> </span><span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* å”¤é†’ä¸­æ–­çº¿ç¨‹ */</span>
<span class="w">        </span><span class="n">wake_up_process</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">IRQ_WAKE_THREAD</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="cm">/* ç›´æ¥å¤„ç† */</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">action</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span><span class="w"> </span><span class="n">action</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="_4">è½¯ä¸­æ–­çº¿ç¨‹åŒ–</h4>
<p>è½¯ä¸­æ–­ä¹Ÿè¢«è½¬æ¢ä¸º ksoftirqd çº¿ç¨‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* RT å†…æ ¸çš„è½¯ä¸­æ–­å¤„ç† */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run_ksoftirqd</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">tsk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__this_cpu_read</span><span class="p">(</span><span class="n">ksoftirqd</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tsk</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">tsk</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">TASK_RUNNING</span><span class="p">)</span>
<span class="w">        </span><span class="n">wake_up_process</span><span class="p">(</span><span class="n">tsk</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1423">14.2.3 æŠ¢å æ¨¡å‹å¯¹æ¯”</h3>
<p>Linux æä¾›å¤šç§æŠ¢å æ¨¡å‹ï¼š</p>
<p>| æ¨¡å‹ | CONFIGé€‰é¡¹ | ç‰¹ç‚¹ | å»¶è¿Ÿ | ååé‡ |</p>
<table>
<thead>
<tr>
<th>æ¨¡å‹</th>
<th>CONFIGé€‰é¡¹</th>
<th>ç‰¹ç‚¹</th>
<th>å»¶è¿Ÿ</th>
<th>ååé‡</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ— æŠ¢å </td>
<td>PREEMPT_NONE</td>
<td>ä»…è‡ªæ„¿è°ƒåº¦ç‚¹</td>
<td>é«˜(~100ms)</td>
<td>æœ€é«˜</td>
</tr>
<tr>
<td>è‡ªæ„¿æŠ¢å </td>
<td>PREEMPT_VOLUNTARY</td>
<td>å¢åŠ æŠ¢å ç‚¹</td>
<td>ä¸­(~10ms)</td>
<td>é«˜</td>
</tr>
<tr>
<td>æŠ¢å </td>
<td>PREEMPT</td>
<td>å†…æ ¸å¯æŠ¢å </td>
<td>ä½(~1ms)</td>
<td>ä¸­</td>
</tr>
<tr>
<td>RTæŠ¢å </td>
<td>PREEMPT_RT</td>
<td>å®Œå…¨å¯æŠ¢å </td>
<td>æä½(~50Î¼s)</td>
<td>è¾ƒä½</td>
</tr>
</tbody>
</table>
<h2 id="143">14.3 ä¼˜å…ˆçº§ç»§æ‰¿ä¸ä¼˜å…ˆçº§å¤©èŠ±æ¿</h2>
<h3 id="1431">14.3.1 ä¼˜å…ˆçº§åè½¬é—®é¢˜</h3>
<p>ä¼˜å…ˆçº§åè½¬å‘ç”Ÿåœ¨é«˜ä¼˜å…ˆçº§ä»»åŠ¡ç­‰å¾…ä½ä¼˜å…ˆçº§ä»»åŠ¡æŒæœ‰çš„èµ„æºæ—¶ï¼š</p>
<div class="codehilite"><pre><span></span><code>æ—¶é—´è½´å±•ç¤ºï¼š
T0: L(ä½ä¼˜å…ˆçº§)è·å–é” mutex_A
T1: H(é«˜ä¼˜å…ˆçº§)å°è¯•è·å– mutex_Aï¼Œé˜»å¡
T2: M(ä¸­ä¼˜å…ˆçº§)å°±ç»ªï¼ŒæŠ¢å  L
T3: M æ‰§è¡Œ...
T4: M å®Œæˆï¼ŒL ç»§ç»­
T5: L é‡Šæ”¾ mutex_A
T6: H è·å¾— mutex_A å¹¶æ‰§è¡Œ

é—®é¢˜ï¼šH è¢« M é—´æ¥é˜»å¡ï¼Œè¿åä¼˜å…ˆçº§è¯­ä¹‰
</code></pre></div>

<h3 id="1432-pi">14.3.2 ä¼˜å…ˆçº§ç»§æ‰¿åè®®ï¼ˆPIï¼‰</h3>
<p>PI åè®®é€šè¿‡ä¸´æ—¶æå‡æŒé”ä»»åŠ¡çš„ä¼˜å…ˆçº§è§£å†³åè½¬ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* rt_mutex ä¼˜å…ˆçº§ç»§æ‰¿å®ç° */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">rt_mutex_waiter</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rb_node</span><span class="w"> </span><span class="n">tree_node</span><span class="p">;</span><span class="w">     </span><span class="cm">/* çº¢é»‘æ ‘èŠ‚ç‚¹ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">task</span><span class="p">;</span><span class="w">     </span><span class="cm">/* ç­‰å¾…ä»»åŠ¡ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rt_mutex_base</span><span class="w"> </span><span class="o">*</span><span class="n">lock</span><span class="p">;</span><span class="w">   </span><span class="cm">/* ç­‰å¾…çš„é” */</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">prio</span><span class="p">;</span><span class="w">                      </span><span class="cm">/* ç­‰å¾…è€…ä¼˜å…ˆçº§ */</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">deadline</span><span class="p">;</span><span class="w">                  </span><span class="cm">/* æˆªæ­¢æ—¶é—´ */</span>
<span class="p">};</span>

<span class="cm">/* ä¼˜å…ˆçº§ç»§æ‰¿é“¾ */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">task_blocks_on_rt_mutex</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">rt_mutex_base</span><span class="w"> </span><span class="o">*</span><span class="n">lock</span><span class="p">,</span>
<span class="w">                                   </span><span class="k">struct</span><span class="w"> </span><span class="nc">rt_mutex_waiter</span><span class="w"> </span><span class="o">*</span><span class="n">waiter</span><span class="p">,</span>
<span class="w">                                   </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rt_mutex_owner</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* å°†ç­‰å¾…è€…åŠ å…¥ç­‰å¾…é˜Ÿåˆ— */</span>
<span class="w">    </span><span class="n">rt_mutex_enqueue</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span><span class="w"> </span><span class="n">waiter</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* ç»§æ‰¿ä¼˜å…ˆçº§ */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">prio</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">owner</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* æå‡æŒé”è€…ä¼˜å…ˆçº§ */</span>
<span class="w">        </span><span class="n">rt_mutex_adjust_prio_chain</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span><span class="w"> </span><span class="n">task</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>ä¼˜å…ˆçº§ç»§æ‰¿çš„ä¼ é€’æ€§ï¼š</p>
<div class="codehilite"><pre><span></span><code>PIé“¾ä¼ é€’ï¼š
T1(prio=10) â†’ blocks on L1 held by â†’
T2(prio=30) â†’ blocks on L2 held by â†’
T3(prio=50) â†’ ç»§æ‰¿ prio=10

ç»“æœï¼šT3 ä¸´æ—¶è¿è¡Œåœ¨ prio=10
</code></pre></div>

<h3 id="1433-pc">14.3.3 ä¼˜å…ˆçº§å¤©èŠ±æ¿åè®®ï¼ˆPCï¼‰</h3>
<p>PC åè®®é¢„å…ˆå°†é”çš„ä¼˜å…ˆçº§è®¾ä¸ºå¯èƒ½è®¿é—®å®ƒçš„æœ€é«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* ä¼˜å…ˆçº§å¤©èŠ±æ¿å®ç°ä¼ªä»£ç  */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">prio_ceiling_mutex</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rt_mutex</span><span class="w"> </span><span class="n">base</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ceiling_priority</span><span class="p">;</span><span class="w">  </span><span class="cm">/* å¤©èŠ±æ¿ä¼˜å…ˆçº§ */</span>
<span class="p">};</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">pc_mutex_lock</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">prio_ceiling_mutex</span><span class="w"> </span><span class="o">*</span><span class="n">pcm</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">old_prio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">task</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* ç«‹å³æå‡åˆ°å¤©èŠ±æ¿ä¼˜å…ˆçº§ */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">ceiling_priority</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">task</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">task</span><span class="o">-&gt;</span><span class="n">prio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">ceiling_priority</span><span class="p">;</span>
<span class="w">        </span><span class="cm">/* é‡æ–°å…¥é˜Ÿè°ƒåº¦å™¨ */</span>
<span class="w">        </span><span class="n">requeue_task_rt</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">rt_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">old_prio</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>PI vs PC å¯¹æ¯”ï¼š</p>
<p>| ç‰¹æ€§ | ä¼˜å…ˆçº§ç»§æ‰¿(PI) | ä¼˜å…ˆçº§å¤©èŠ±æ¿(PC) |</p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>ä¼˜å…ˆçº§ç»§æ‰¿(PI)</th>
<th>ä¼˜å…ˆçº§å¤©èŠ±æ¿(PC)</th>
</tr>
</thead>
<tbody>
<tr>
<td>ä¼˜å…ˆçº§è°ƒæ•´æ—¶æœº</td>
<td>å‘ç”Ÿé˜»å¡æ—¶</td>
<td>è·å–é”æ—¶</td>
</tr>
<tr>
<td>å¼€é”€</td>
<td>åŠ¨æ€ï¼Œé“¾å¼ä¼ é€’</td>
<td>é™æ€ï¼Œå›ºå®š</td>
</tr>
<tr>
<td>æ­»é”é¢„é˜²</td>
<td>ä¸èƒ½</td>
<td>å¯ä»¥</td>
</tr>
<tr>
<td>å®ç°å¤æ‚åº¦</td>
<td>é«˜</td>
<td>ä¸­</td>
</tr>
<tr>
<td>Linuxæ”¯æŒ</td>
<td>å®Œæ•´æ”¯æŒ</td>
<td>éƒ¨åˆ†æ”¯æŒ</td>
</tr>
</tbody>
</table>
<h2 id="144-hrtimer">14.4 é«˜ç²¾åº¦å®šæ—¶å™¨ï¼ˆhrtimerï¼‰</h2>
<h3 id="1441">14.4.1 ä¼ ç»Ÿå®šæ—¶å™¨çš„å±€é™</h3>
<p>Linux ä¼ ç»Ÿå®šæ—¶å™¨åŸºäº jiffiesï¼Œç²¾åº¦å— HZ é™åˆ¶ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* ä¼ ç»Ÿå®šæ—¶å™¨ç²¾åº¦ */</span>
<span class="n">HZ</span><span class="o">=</span><span class="mi">100</span><span class="o">:</span><span class="w">  </span><span class="n">ç²¾åº¦</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="n">ms</span>
<span class="n">HZ</span><span class="o">=</span><span class="mi">1000</span><span class="o">:</span><span class="w"> </span><span class="n">ç²¾åº¦</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="n">ms</span>

<span class="cm">/* jiffies å®šæ—¶å™¨é—®é¢˜ */</span>

<span class="mf">1.</span><span class="w"> </span><span class="n">ç²¾åº¦ä¸è¶³</span><span class="err">ï¼š</span><span class="n">æœ€å°ç²’åº¦å—</span><span class="w"> </span><span class="n">HZ</span><span class="w"> </span><span class="n">é™åˆ¶</span>
<span class="mf">2.</span><span class="w"> </span><span class="n">çº§è”å¼€é”€</span><span class="err">ï¼š</span><span class="n">æ—¶é—´è½®çº§è”æ“ä½œ</span>
<span class="mf">3.</span><span class="w"> </span><span class="n">åŒæ­¥é—®é¢˜</span><span class="err">ï¼š</span><span class="n">æ‰€æœ‰å®šæ—¶å™¨åœ¨</span><span class="w"> </span><span class="n">tick</span><span class="w"> </span><span class="n">è¾¹ç•Œè§¦å‘</span>
</code></pre></div>

<h3 id="1442-hrtimer">14.4.2 hrtimer æ¶æ„è®¾è®¡</h3>
<p>é«˜ç²¾åº¦å®šæ—¶å™¨ä½¿ç”¨çº¢é»‘æ ‘ç»„ç»‡ï¼Œæ”¯æŒçº³ç§’çº§ç²¾åº¦ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* hrtimer æ•°æ®ç»“æ„ */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">hrtimer</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">timerqueue_node</span><span class="w"> </span><span class="n">node</span><span class="p">;</span><span class="w">  </span><span class="cm">/* çº¢é»‘æ ‘èŠ‚ç‚¹ */</span>
<span class="w">    </span><span class="n">ktime_t</span><span class="w"> </span><span class="n">_softexpires</span><span class="p">;</span><span class="w">         </span><span class="cm">/* è½¯è¿‡æœŸæ—¶é—´ */</span>
<span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="n">hrtimer_restart</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">function</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">hrtimer</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hrtimer_clock_base</span><span class="w"> </span><span class="o">*</span><span class="n">base</span><span class="p">;</span>
<span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">state</span><span class="p">;</span>
<span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">is_rel</span><span class="p">;</span><span class="w">                    </span><span class="cm">/* ç›¸å¯¹/ç»å¯¹å®šæ—¶å™¨ */</span>
<span class="p">};</span>

<span class="cm">/* æ—¶é’ŸåŸºç¡€ */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">hrtimer_clock_base</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hrtimer_cpu_base</span><span class="w"> </span><span class="o">*</span><span class="n">cpu_base</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="p">;</span>
<span class="w">    </span><span class="kt">clockid_t</span><span class="w"> </span><span class="n">clockid</span><span class="p">;</span><span class="w">            </span><span class="cm">/* CLOCK_MONOTONIC/REALTIME */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">timerqueue_head</span><span class="w"> </span><span class="n">active</span><span class="p">;</span><span class="w"> </span><span class="cm">/* çº¢é»‘æ ‘æ ¹ */</span>
<span class="w">    </span><span class="n">ktime_t</span><span class="w"> </span><span class="n">resolution</span><span class="p">;</span><span class="w">           </span><span class="cm">/* æ—¶é’Ÿåˆ†è¾¨ç‡ */</span>
<span class="w">    </span><span class="n">ktime_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">get_time</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span><span class="w">    </span><span class="cm">/* è·å–å½“å‰æ—¶é—´ */</span>
<span class="w">    </span><span class="n">ktime_t</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span><span class="w">              </span><span class="cm">/* æ—¶é—´åç§» */</span>
<span class="p">};</span>

<span class="cp">### 14.4.3 æ—¶é’Ÿæºä¸æ—¶é’Ÿäº‹ä»¶è®¾å¤‡</span>

<span class="n">Linux</span><span class="w"> </span><span class="n">æ—¶é—´å­ç³»ç»Ÿåˆ†ç¦»äº†æ—¶é’Ÿæº</span><span class="err">ï¼ˆ</span><span class="n">clocksource</span><span class="err">ï¼‰</span><span class="n">å’Œæ—¶é’Ÿäº‹ä»¶è®¾å¤‡</span><span class="err">ï¼ˆ</span><span class="n">clock_event_device</span><span class="err">ï¼‰ï¼š</span>

<span class="err">```</span><span class="n">c</span>
<span class="cm">/* æ—¶é’Ÿæºï¼šæä¾›æ—¶é—´è¯»å– */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">clocksource</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">read</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">clocksource</span><span class="w"> </span><span class="o">*</span><span class="n">cs</span><span class="p">);</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">mask</span><span class="p">;</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">mult</span><span class="p">;</span><span class="w">                    </span><span class="cm">/* é¢‘ç‡è½¬æ¢ä¹˜æ•° */</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">shift</span><span class="p">;</span><span class="w">                   </span><span class="cm">/* é¢‘ç‡è½¬æ¢ç§»ä½ */</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">max_idle_ns</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span><span class="w">            </span><span class="cm">/* TSC, HPET, ACPI_PM */</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">rating</span><span class="p">;</span><span class="w">                  </span><span class="cm">/* ä¼˜å…ˆçº§è¯„åˆ† */</span>
<span class="p">};</span>

<span class="cm">/* æ—¶é’Ÿäº‹ä»¶è®¾å¤‡ï¼šäº§ç”Ÿå®šæ—¶ä¸­æ–­ */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">clock_event_device</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">event_handler</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">clock_event_device</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">set_next_event</span><span class="p">)(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">evt</span><span class="p">,</span>
<span class="w">                         </span><span class="k">struct</span><span class="w"> </span><span class="nc">clock_event_device</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">set_state_oneshot</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">clock_event_device</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">set_state_periodic</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">clock_event_device</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">features</span><span class="p">;</span><span class="w">       </span><span class="cm">/* ONESHOT, PERIODIC */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">max_delta_ns</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">min_delta_ns</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>

<p>æ—¶é’Ÿæºä¼˜å…ˆçº§ï¼ˆx86ï¼‰ï¼š</p>
<div class="codehilite"><pre><span></span><code>Rating  æ—¶é’Ÿæº         ç²¾åº¦        ç‰¹ç‚¹
400     TSC           ~1ns        CPUæ—¶é—´æˆ³è®¡æ•°å™¨
250     HPET          ~100ns      é«˜ç²¾åº¦äº‹ä»¶å®šæ—¶å™¨  
200     ACPI_PM       ~300ns      ACPIç”µæºç®¡ç†å®šæ—¶å™¨
100     PIT           ~1Î¼s        å¯ç¼–ç¨‹é—´éš”å®šæ—¶å™¨
</code></pre></div>

<h3 id="1444-hrtimer">14.4.4 hrtimer æ“ä½œå®ç°</h3>
<p>å®šæ—¶å™¨çš„å¯åŠ¨ä¸åˆ°æœŸå¤„ç†ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* å¯åŠ¨é«˜ç²¾åº¦å®šæ—¶å™¨ */</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">hrtimer_start</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">hrtimer</span><span class="w"> </span><span class="o">*</span><span class="n">timer</span><span class="p">,</span><span class="w"> </span><span class="n">ktime_t</span><span class="w"> </span><span class="n">tim</span><span class="p">,</span>
<span class="w">                  </span><span class="k">enum</span><span class="w"> </span><span class="n">hrtimer_mode</span><span class="w"> </span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hrtimer_clock_base</span><span class="w"> </span><span class="o">*</span><span class="n">base</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span>

<span class="w">    </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lock_hrtimer_base</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* è®¡ç®—ç»å¯¹è¿‡æœŸæ—¶é—´ */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mode</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">HRTIMER_MODE_REL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">tim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ktime_add_safe</span><span class="p">(</span><span class="n">tim</span><span class="p">,</span><span class="w"> </span><span class="n">base</span><span class="o">-&gt;</span><span class="n">get_time</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">_softexpires</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tim</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* æ’å…¥çº¢é»‘æ ‘ */</span>
<span class="w">    </span><span class="n">enqueue_hrtimer</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span><span class="w"> </span><span class="n">base</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* ç¼–ç¨‹ç¡¬ä»¶å®šæ—¶å™¨ */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">timer</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">base</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">.</span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">hrtimer_reprogram</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span><span class="w"> </span><span class="n">base</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">unlock_hrtimer_base</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* å®šæ—¶å™¨åˆ°æœŸå¤„ç† */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">hrtimer_interrupt</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">clock_event_device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hrtimer_cpu_base</span><span class="w"> </span><span class="o">*</span><span class="n">cpu_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this_cpu_ptr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hrtimer_bases</span><span class="p">);</span>
<span class="w">    </span><span class="n">ktime_t</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ktime_get</span><span class="p">();</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timerqueue_getnext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">container_of</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">hrtimer</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">_softexpires</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">now</span><span class="p">)</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="n">__remove_hrtimer</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span><span class="w"> </span><span class="n">base</span><span class="p">);</span>
<span class="w">        </span><span class="n">fn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">;</span>

<span class="w">        </span><span class="cm">/* æ‰§è¡Œå›è°ƒ */</span>
<span class="w">        </span><span class="n">restart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fn</span><span class="p">(</span><span class="n">timer</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">restart</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">HRTIMER_RESTART</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">hrtimer_start_expires</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span><span class="w"> </span><span class="n">HRTIMER_MODE_ABS</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1445-no_hz">14.4.5 åŠ¨æ€æ—¶é’Ÿï¼ˆNO_HZï¼‰</h3>
<p>NO_HZ æ¨¡å¼åœ¨ç³»ç»Ÿç©ºé—²æ—¶åœæ­¢å‘¨æœŸæ€§æ—¶é’Ÿä¸­æ–­ï¼š</p>
<div class="codehilite"><pre><span></span><code>ä¼ ç»Ÿ HZ æ¨¡å¼ï¼š
|tick|tick|tick|tick|tick|tick|  æ¯ 1/HZ ç§’ä¸­æ–­
     æµªè´¹åŠŸè€—

NO_HZ_IDLE æ¨¡å¼ï¼š
|tick|------idle------|tick|     ç©ºé—²æ—¶æ— ä¸­æ–­
          çœç”µ

NO_HZ_FULL æ¨¡å¼ï¼š
|tick|---userspace----|tick|     ç”¨æˆ·æ€è¿è¡Œæ—¶æ— ä¸­æ–­
       é™ä½å»¶è¿ŸæŠ–åŠ¨
</code></pre></div>

<h2 id="145">14.5 å®æ—¶è°ƒåº¦ç±»</h2>
<h3 id="1451-sched_fifo">14.5.1 SCHED_FIFOï¼šå…ˆè¿›å…ˆå‡ºè°ƒåº¦</h3>
<p>SCHED_FIFO æ˜¯æœ€ç®€å•çš„å®æ—¶è°ƒåº¦ç­–ç•¥ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* SCHED_FIFO è¿è¡Œé˜Ÿåˆ— */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">rt_prio_array</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">DECLARE_BITMAP</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span><span class="w"> </span><span class="n">MAX_RT_PRIO</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span><span class="w">  </span><span class="cm">/* ä¼˜å…ˆçº§ä½å›¾ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">queue</span><span class="p">[</span><span class="n">MAX_RT_PRIO</span><span class="p">];</span><span class="w">    </span><span class="cm">/* æ¯ä¸ªä¼˜å…ˆçº§çš„ä»»åŠ¡é˜Ÿåˆ— */</span>
<span class="p">};</span>

<span class="cm">/* é€‰æ‹©ä¸‹ä¸€ä¸ªä»»åŠ¡ - O(1) å¤æ‚åº¦ */</span>
<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">pick_next_rt_entity</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">rt_rq</span><span class="w"> </span><span class="o">*</span><span class="n">rt_rq</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rt_prio_array</span><span class="w"> </span><span class="o">*</span><span class="n">array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rt_rq</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* æ‰¾åˆ°æœ€é«˜ä¼˜å…ˆçº§ */</span>
<span class="w">    </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sched_find_first_bit</span><span class="p">(</span><span class="n">array</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">MAX_RT_PRIO</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* è¿”å›é˜Ÿé¦–ä»»åŠ¡ */</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">array</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
<span class="w">                           </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="p">,</span><span class="w"> </span><span class="n">rt_list_entry</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>SCHED_FIFO ç‰¹æ€§ï¼š</p>
<ul>
<li>æ— æ—¶é—´ç‰‡ï¼Œè¿è¡Œç›´åˆ°ä¸»åŠ¨è®©å‡º</li>
<li>åŒä¼˜å…ˆçº§ä»»åŠ¡ FIFO æ’é˜Ÿ</li>
<li>ä¼˜å…ˆçº§èŒƒå›´ï¼š1-99ï¼ˆ99æœ€é«˜ï¼‰</li>
</ul>
<h3 id="1452-sched_rr">14.5.2 SCHED_RRï¼šè½®è½¬è°ƒåº¦</h3>
<p>SCHED_RR åœ¨ FIFO åŸºç¡€ä¸Šå¢åŠ æ—¶é—´ç‰‡ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* RR æ—¶é—´ç‰‡ç®¡ç† */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">task_tick_rt</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">rq</span><span class="w"> </span><span class="o">*</span><span class="n">rq</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">queued</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_rt_entity</span><span class="w"> </span><span class="o">*</span><span class="n">rt_se</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rt</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policy</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">SCHED_RR</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">--</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rt</span><span class="p">.</span><span class="n">time_slice</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* æ—¶é—´ç‰‡ç”¨å®Œï¼Œé‡ç½®å¹¶é‡æ–°å…¥é˜Ÿ */</span>
<span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rt</span><span class="p">.</span><span class="n">time_slice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sched_rr_timeslice</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* ç§»åˆ°é˜Ÿå°¾ */</span>
<span class="w">    </span><span class="n">requeue_task_rt</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* è®¾ç½®é‡æ–°è°ƒåº¦æ ‡å¿— */</span>
<span class="w">    </span><span class="n">set_tsk_need_resched</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>é»˜è®¤ RR æ—¶é—´ç‰‡ï¼š100msï¼ˆå¯é€šè¿‡ /proc/sys/kernel/sched_rr_timeslice_ms è°ƒæ•´ï¼‰</p>
<h3 id="1453-sched_deadlineedf">14.5.3 SCHED_DEADLINEï¼šEDF è°ƒåº¦</h3>
<p>SCHED_DEADLINE å®ç°æœ€æ—©æˆªæ­¢æ—¶é—´ä¼˜å…ˆï¼ˆEDFï¼‰ç®—æ³•ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* DEADLINE ä»»åŠ¡å‚æ•° */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">sched_dl_entity</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rb_node</span><span class="w"> </span><span class="n">rb_node</span><span class="p">;</span><span class="w">      </span><span class="cm">/* çº¢é»‘æ ‘èŠ‚ç‚¹ */</span>

<span class="w">    </span><span class="cm">/* ä¸‰ä¸ªå…³é”®å‚æ•° */</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">dl_runtime</span><span class="p">;</span><span class="w">              </span><span class="cm">/* æœ€å¤§è¿è¡Œæ—¶é—´ */</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">dl_deadline</span><span class="p">;</span><span class="w">             </span><span class="cm">/* ç›¸å¯¹æˆªæ­¢æ—¶é—´ */</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">dl_period</span><span class="p">;</span><span class="w">               </span><span class="cm">/* å‘¨æœŸ */</span>

<span class="w">    </span><span class="cm">/* è¿è¡Œæ—¶çŠ¶æ€ */</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">deadline</span><span class="p">;</span><span class="w">                </span><span class="cm">/* ç»å¯¹æˆªæ­¢æ—¶é—´ */</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">runtime</span><span class="p">;</span><span class="w">                 </span><span class="cm">/* å‰©ä½™è¿è¡Œæ—¶é—´ */</span>

<span class="w">    </span><span class="cm">/* CBS (Constant Bandwidth Server) */</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">dl_bw</span><span class="p">;</span><span class="w">                   </span><span class="cm">/* å¸¦å®½ = runtime/period */</span>
<span class="p">};</span>
</code></pre></div>

<p>EDF è°ƒåº¦ç®—æ³•æ ¸å¿ƒï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* é€‰æ‹©æœ€æ—©æˆªæ­¢æ—¶é—´çš„ä»»åŠ¡ */</span>
<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_dl_entity</span><span class="w"> </span><span class="o">*</span><span class="n">pick_next_dl_entity</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dl_rq</span><span class="w"> </span><span class="o">*</span><span class="n">dl_rq</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rb_node</span><span class="w"> </span><span class="o">*</span><span class="n">left</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rb_first_cached</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dl_rq</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">rb_entry</span><span class="p">(</span><span class="n">left</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_dl_entity</span><span class="p">,</span><span class="w"> </span><span class="n">rb_node</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* å‡†å…¥æ§åˆ¶ - ä¿è¯å¯è°ƒåº¦æ€§ */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">dl_overflow</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">policy</span><span class="p">,</span>
<span class="w">                      </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_attr</span><span class="w"> </span><span class="o">*</span><span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">period</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">sched_period</span><span class="p">;</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">runtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">sched_runtime</span><span class="p">;</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">new_bw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">runtime</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">period</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* æ£€æŸ¥ CPU åˆ©ç”¨ç‡ä¸Šç•Œ */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dl_rq</span><span class="o">-&gt;</span><span class="n">total_bw</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">new_bw</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">dl_rq</span><span class="o">-&gt;</span><span class="n">max_bw</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span><span class="w">  </span><span class="cm">/* æ‹’ç»ä»»åŠ¡ */</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>å¯è°ƒåº¦æ€§åˆ†æï¼ˆå•å¤„ç†å™¨ï¼‰ï¼š
$$U = \sum_{i=1}^{n} \frac{C_i}{T_i} \leq 1$$</p>
<p>å…¶ä¸­ $C_i$ æ˜¯ä»»åŠ¡ $i$ çš„è®¡ç®—æ—¶é—´ï¼Œ$T_i$ æ˜¯å‘¨æœŸã€‚</p>
<h3 id="1454">14.5.4 è°ƒåº¦ç±»ä¼˜å…ˆçº§</h3>
<p>Linux è°ƒåº¦ç±»çš„ä¼˜å…ˆçº§é¡ºåºï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="err">è°ƒåº¦ç±»ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š</span>

<span class="mf">1.</span><span class="w"> </span><span class="n">SCHED_DEADLINE</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">EDFå®æ—¶è°ƒåº¦</span>
<span class="mf">2.</span><span class="w"> </span><span class="n">SCHED_FIFO</span><span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="err">å›ºå®šä¼˜å…ˆçº§å®æ—¶</span>
<span class="mf">3.</span><span class="w"> </span><span class="n">SCHED_RR</span><span class="w">        </span><span class="o">-</span><span class="w"> </span><span class="err">è½®è½¬å®æ—¶</span>
<span class="mf">4.</span><span class="w"> </span><span class="n">SCHED_NORMAL</span><span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">CFSå…¬å¹³è°ƒåº¦</span>
<span class="mf">5.</span><span class="w"> </span><span class="n">SCHED_BATCH</span><span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="err">æ‰¹å¤„ç†</span>
<span class="mf">6.</span><span class="w"> </span><span class="n">SCHED_IDLE</span><span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="err">ç©ºé—²</span>

<span class="err">é€‰æ‹©é€»è¾‘ï¼š</span>
<span class="n">for_each_class</span><span class="p">(</span><span class="n">class</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">pick_next_task</span><span class="p">(</span><span class="n">rq</span><span class="p">))</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="n">task</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="146">14.6 å»¶è¿Ÿåˆ†æä¸ä¼˜åŒ–</h2>
<h3 id="1461">14.6.1 å»¶è¿Ÿæµ‹é‡å·¥å…·</h3>
<p>Linux æä¾›å¤šç§å»¶è¿Ÿè¿½è¸ªæœºåˆ¶ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># cyclictest - RT å»¶è¿Ÿæµ‹è¯•æ ‡å‡†å·¥å…·</span>
cyclictest<span class="w"> </span>-p<span class="w"> </span><span class="m">99</span><span class="w"> </span>-m<span class="w"> </span>-n<span class="w"> </span>-l<span class="w"> </span><span class="m">100000</span><span class="w"> </span>-h<span class="w"> </span><span class="m">1000</span>

<span class="c1"># ftrace å»¶è¿Ÿè¿½è¸ªå™¨</span>
<span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;irqsoff&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/kernel/debug/tracing/current_tracer
<span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;preemptoff&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/kernel/debug/tracing/current_tracer
<span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;wakeup_rt&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/kernel/debug/tracing/current_tracer

<span class="c1"># hwlat_detector - ç¡¬ä»¶/å›ºä»¶å»¶è¿Ÿæ£€æµ‹</span>
<span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;hwlat&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/kernel/debug/tracing/current_tracer
</code></pre></div>

<h3 id="1462">14.6.2 ä¸­æ–­å»¶è¿Ÿä¼˜åŒ–</h3>
<p>å‡å°‘ä¸­æ–­å»¶è¿Ÿçš„æŠ€æœ¯ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* 1. ä¸­æ–­åˆå¹¶ï¼ˆNAPIï¼‰ */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">napi_poll</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">napi_struct</span><span class="w"> </span><span class="o">*</span><span class="n">napi</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">work_done</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* æ‰¹é‡å¤„ç†åŒ…ï¼Œå‡å°‘ä¸­æ–­é¢‘ç‡ */</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">work_done</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">budget</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">process_packet</span><span class="p">())</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="n">work_done</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">work_done</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">budget</span><span class="p">)</span>
<span class="w">        </span><span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">work_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* 2. ä¸­æ–­äº²å’Œæ€§è®¾ç½® */</span>
<span class="n">echo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">irq</span><span class="o">/</span><span class="mi">24</span><span class="o">/</span><span class="n">smp_affinity</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">ç»‘å®šåˆ°</span><span class="w"> </span><span class="n">CPU1</span>

<span class="cm">/* 3. ä¸­æ–­çº¿ç¨‹ä¼˜å…ˆçº§è°ƒæ•´ */</span>
<span class="n">chrt</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">99</span><span class="w"> </span><span class="n">$</span><span class="p">(</span><span class="n">pidof</span><span class="w"> </span><span class="n">irq</span><span class="o">/</span><span class="mi">24</span><span class="o">-</span><span class="n">eth0</span><span class="p">)</span>
</code></pre></div>

<h3 id="1463">14.6.3 è°ƒåº¦å»¶è¿Ÿä¼˜åŒ–</h3>
<p>é™ä½è°ƒåº¦å»¶è¿Ÿçš„æ–¹æ³•ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* 1. å‡å°‘æŠ¢å ç¦ç”¨åŒº */</span>
<span class="c1">// ä¸å¥½çš„åšæ³•</span>
<span class="n">preempt_disable</span><span class="p">();</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10000</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">do_something</span><span class="p">();</span>
<span class="p">}</span>
<span class="n">preempt_enable</span><span class="p">();</span>

<span class="c1">// æ”¹è¿›åšæ³•</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10000</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">preempt_disable</span><span class="p">();</span>
<span class="w">    </span><span class="n">do_something</span><span class="p">();</span>
<span class="w">    </span><span class="n">preempt_enable</span><span class="p">();</span>
<span class="w">    </span><span class="n">cond_resched</span><span class="p">();</span><span class="w">  </span><span class="cm">/* è‡ªæ„¿è°ƒåº¦ç‚¹ */</span>
<span class="p">}</span>

<span class="cm">/* 2. ä½¿ç”¨ local_lock æ›¿ä»£ preempt_disable */</span>
<span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">local_lock</span><span class="p">,</span><span class="w"> </span><span class="n">my_lock</span><span class="p">);</span>

<span class="n">local_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_lock</span><span class="p">);</span>
<span class="cm">/* ä¸´ç•ŒåŒº - RT å†…æ ¸ä¸­å¯æŠ¢å  */</span>
<span class="n">local_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_lock</span><span class="p">);</span>
</code></pre></div>

<h3 id="1464-wcet">14.6.4 æœ€åæƒ…å†µæ‰§è¡Œæ—¶é—´ï¼ˆWCETï¼‰</h3>
<p>WCET åˆ†æå¯¹ç¡¬å®æ—¶ç³»ç»Ÿè‡³å…³é‡è¦ï¼š</p>
<div class="codehilite"><pre><span></span><code>WCET ç»„æˆï¼š
â”œâ”€â”€ ä»»åŠ¡æ‰§è¡Œæ—¶é—´
â”‚   â”œâ”€â”€ åŸºæœ¬å—æ‰§è¡Œ
â”‚   â””â”€â”€ ç¼“å­˜æ•ˆåº”
â”œâ”€â”€ å†…æ ¸å¼€é”€
â”‚   â”œâ”€â”€ ç³»ç»Ÿè°ƒç”¨
â”‚   â””â”€â”€ ä¸Šä¸‹æ–‡åˆ‡æ¢
â””â”€â”€ å¹²æ‰°æ—¶é—´
    â”œâ”€â”€ ä¸­æ–­å¤„ç†
    â””â”€â”€ é«˜ä¼˜å…ˆçº§æŠ¢å 

æ€» WCET = max(æ‰§è¡Œè·¯å¾„) + max(å†…æ ¸å¼€é”€) + Î£(å¹²æ‰°)
</code></pre></div>

<h2 id="147">14.7 å®æ—¶ç³»ç»Ÿé›†æˆæŠ€æœ¯</h2>
<h3 id="1471-cpu-isolation">14.7.1 CPU éš”ç¦»ï¼ˆIsolationï¼‰</h3>
<p>å°† CPU ä¸“ç”¨äºå®æ—¶ä»»åŠ¡ï¼Œé¿å…å¹²æ‰°ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># å†…æ ¸å¯åŠ¨å‚æ•°</span>
<span class="nv">isolcpus</span><span class="o">=</span><span class="m">2</span>,3<span class="w"> </span><span class="nv">nohz_full</span><span class="o">=</span><span class="m">2</span>,3<span class="w"> </span><span class="nv">rcu_nocbs</span><span class="o">=</span><span class="m">2</span>,3

<span class="c1"># è¿è¡Œæ—¶ç»‘å®š</span>
taskset<span class="w"> </span>-c<span class="w"> </span><span class="m">2</span><span class="w"> </span>./realtime_app
</code></pre></div>

<p>CPU éš”ç¦»æ•ˆæœï¼š</p>
<ul>
<li>æ— è°ƒåº¦å™¨è´Ÿè½½å‡è¡¡</li>
<li>æ—  RCU å›è°ƒ</li>
<li>æ— å®šæ—¶å™¨ä¸­æ–­ï¼ˆNO_HZ_FULLï¼‰</li>
</ul>
<h3 id="1472">14.7.2 å†…å­˜é”å®š</h3>
<p>é˜²æ­¢é¡µé¢æ¢å‡ºå¯¼è‡´çš„ä¸ç¡®å®šå»¶è¿Ÿï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* é”å®šæ‰€æœ‰å†…å­˜é¡µ */</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mlockall</span><span class="p">(</span><span class="n">MCL_CURRENT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MCL_FUTURE</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;mlockall failed&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* é¢„åˆ†é…å †æ ˆ */</span>
<span class="kt">void</span><span class="w"> </span><span class="n">stack_prefault</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">dummy</span><span class="p">[</span><span class="n">MAX_STACK_SIZE</span><span class="p">];</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">dummy</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MAX_STACK_SIZE</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1473">14.7.3 å®æ—¶åº”ç”¨æ¨¡æ¿</h3>
<p>æ ‡å‡†å®æ—¶åº”ç”¨åˆå§‹åŒ–æµç¨‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">setup_realtime</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_param</span><span class="w"> </span><span class="n">param</span><span class="p">;</span>
<span class="w">    </span><span class="kt">cpu_set_t</span><span class="w"> </span><span class="n">cpuset</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* 1. è®¾ç½®å®æ—¶è°ƒåº¦ç­–ç•¥ */</span>
<span class="w">    </span><span class="n">param</span><span class="p">.</span><span class="n">sched_priority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sched_setscheduler</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">SCHED_FIFO</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">param</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;sched_setscheduler&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* 2. ç»‘å®š CPU */</span>
<span class="w">    </span><span class="n">CPU_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpuset</span><span class="p">);</span>
<span class="w">    </span><span class="n">CPU_SET</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cpuset</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sched_setaffinity</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">cpuset</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cpuset</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;sched_setaffinity&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* 3. é”å®šå†…å­˜ */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mlockall</span><span class="p">(</span><span class="n">MCL_CURRENT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MCL_FUTURE</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;mlockall&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* 4. é¢„çƒ­ç¼“å­˜ */</span>
<span class="w">    </span><span class="n">stack_prefault</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="_5">æœ¬ç« å°ç»“</h2>
<p>æœ¬ç« æ·±å…¥æ¢è®¨äº† Linux å®æ—¶æ‰©å±•çš„æ ¸å¿ƒæŠ€æœ¯ã€‚ä» PREEMPT_RT è¡¥ä¸é›†çš„å®Œå…¨å¯æŠ¢å å†…æ ¸è®¾è®¡ï¼Œåˆ°ä¼˜å…ˆçº§ç»§æ‰¿åè®®è§£å†³ä¼˜å…ˆçº§åè½¬é—®é¢˜ï¼Œå†åˆ°é«˜ç²¾åº¦å®šæ—¶å™¨å’Œ SCHED_DEADLINE è°ƒåº¦å™¨çš„å®ç°ï¼Œæˆ‘ä»¬ç³»ç»Ÿåœ°åˆ†æäº†å°†é€šç”¨ Linux è½¬å˜ä¸ºå®æ—¶æ“ä½œç³»ç»Ÿçš„å…³é”®æœºåˆ¶ã€‚</p>
<p><strong>æ ¸å¿ƒè¦ç‚¹å›é¡¾</strong>ï¼š</p>
<ol>
<li><strong>PREEMPT_RT ä¸‰å¤§æ”¹é€ </strong>ï¼šè‡ªæ—‹é”ç¡çœ åŒ–ã€ä¸­æ–­çº¿ç¨‹åŒ–ã€è½¯ä¸­æ–­çº¿ç¨‹åŒ–</li>
<li><strong>ä¼˜å…ˆçº§ç»§æ‰¿é“¾</strong>ï¼šåŠ¨æ€æå‡æŒé”ä»»åŠ¡ä¼˜å…ˆçº§ï¼Œé˜²æ­¢ä¼˜å…ˆçº§åè½¬</li>
<li><strong>é«˜ç²¾åº¦å®šæ—¶å™¨</strong>ï¼šçº³ç§’çº§ç²¾åº¦ï¼Œçº¢é»‘æ ‘ç»„ç»‡ï¼Œæ”¯æŒ NO_HZ æ¨¡å¼</li>
<li><strong>å®æ—¶è°ƒåº¦ç±»å±‚æ¬¡</strong>ï¼šDEADLINE &gt; FIFO &gt; RR &gt; NORMAL</li>
<li><strong>å»¶è¿Ÿä¼˜åŒ–æŠ€æœ¯</strong>ï¼šCPU éš”ç¦»ã€å†…å­˜é”å®šã€ä¸­æ–­äº²å’Œæ€§</li>
</ol>
<p><strong>å…³é”®å…¬å¼æ€»ç»“</strong>ï¼š</p>
<ul>
<li>EDF å¯è°ƒåº¦æ€§ï¼š$U = \sum \frac{C_i}{T_i} \leq 1$</li>
<li>å“åº”æ—¶é—´ï¼š$R_i = C_i + \sum_{j \in hp(i)} \lceil \frac{R_i}{T_j} \rceil C_j$</li>
<li>ä¼˜å…ˆçº§ç»§æ‰¿ï¼š$prio_{effective} = \min(prio_{nominal}, prio_{waiters})$</li>
</ul>
<h2 id="_6">ç»ƒä¹ é¢˜</h2>
<h3 id="_7">åŸºç¡€é¢˜</h3>
<ol>
<li><strong>PREEMPT_RT æœºåˆ¶ç†è§£</strong>
åˆ†æä»¥ä¸‹ä»£ç åœ¨æ ‡å‡†å†…æ ¸å’Œ RT å†…æ ¸ä¸­çš„è¡Œä¸ºå·®å¼‚ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span><span class="w">  </span><span class="cm">/* ç¡çœ  10ms */</span>
<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
</code></pre></div>

<details>
<summary>ç­”æ¡ˆ</summary>
<p>æ ‡å‡†å†…æ ¸ï¼šç¼–è¯‘é”™è¯¯æˆ–å†…æ ¸å´©æºƒã€‚spin_lock æŒæœ‰æ—¶ä¸èƒ½ç¡çœ ï¼Œå› ä¸ºä¼šå¯¼è‡´æ­»é”ã€‚</p>
<p>RT å†…æ ¸ï¼šæ­£å¸¸æ‰§è¡Œã€‚spin_lock åœ¨ RT ä¸­æ˜¯å¯ç¡çœ çš„ rt_mutexï¼Œå…è®¸æŒé”ç¡çœ å¹¶æ”¯æŒä¼˜å…ˆçº§ç»§æ‰¿ã€‚</p>
<p>å…³é”®å·®å¼‚ï¼šRT å†…æ ¸å°†è‡ªæ—‹é”è½¬æ¢ä¸ºäº’æ–¥é”ï¼Œå®ç°å®Œå…¨å¯æŠ¢å ã€‚</p>
</details>
<ol start="2">
<li><strong>ä¼˜å…ˆçº§åè½¬åœºæ™¯åˆ†æ</strong>
ä¸‰ä¸ªä»»åŠ¡ L(ä¼˜å…ˆçº§=10)ã€M(ä¼˜å…ˆçº§=50)ã€H(ä¼˜å…ˆçº§=90) å…±äº«äº’æ–¥é” mutex_Aã€‚å¦‚æœ L å…ˆè·å¾—é”ï¼Œç„¶å H è¯·æ±‚é”ï¼Œæœ€å M å°±ç»ªï¼Œæè¿°ä»»åŠ¡æ‰§è¡Œé¡ºåºã€‚</li>
</ol>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>æ— ä¼˜å…ˆçº§ç»§æ‰¿ï¼š</p>
<ol>
<li>L æŒé”è¿è¡Œ</li>
<li>H è¯·æ±‚é”ï¼Œé˜»å¡</li>
<li>M å°±ç»ªï¼ŒæŠ¢å  L</li>
<li>M æ‰§è¡Œå®Œæˆ</li>
<li>L ç»§ç»­ï¼Œé‡Šæ”¾é”</li>
<li>H è·å¾—é”æ‰§è¡Œ</li>
</ol>
<p>æœ‰ä¼˜å…ˆçº§ç»§æ‰¿ï¼š</p>
<ol>
<li>L æŒé”è¿è¡Œ</li>
<li>H è¯·æ±‚é”ï¼ŒL ç»§æ‰¿ä¼˜å…ˆçº§ 90</li>
<li>M å°±ç»ªä½†ä¼˜å…ˆçº§ä½äº L(90)</li>
<li>L ä»¥ä¼˜å…ˆçº§ 90 æ‰§è¡Œï¼Œé‡Šæ”¾é”</li>
<li>H è·å¾—é”æ‰§è¡Œ</li>
<li>M æœ€åæ‰§è¡Œ</li>
</ol>
<p>PI é¿å…äº†ä¸­ä¼˜å…ˆçº§ä»»åŠ¡å»¶è¿Ÿé«˜ä¼˜å…ˆçº§ä»»åŠ¡ã€‚</p>
</details>
<ol start="3">
<li><strong>hrtimer ç²¾åº¦è®¡ç®—</strong>
ç³»ç»Ÿä½¿ç”¨ TSC ä½œä¸ºæ—¶é’Ÿæºï¼ˆé¢‘ç‡ 2.4GHzï¼‰ï¼Œè®¡ç®—ç†è®ºæœ€é«˜å®šæ—¶ç²¾åº¦ã€‚</li>
</ol>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>TSC å‘¨æœŸ = 1 / 2.4GHz = 0.417ns</p>
<p>ç†è®ºç²¾åº¦ = TSC å‘¨æœŸ = 0.417ns</p>
<p>å®é™…ç²¾åº¦å—é™äºï¼š</p>
<ul>
<li>ä¸­æ–­å»¶è¿Ÿï¼ˆ~1Î¼sï¼‰</li>
<li>è°ƒåº¦å»¶è¿Ÿï¼ˆ~10Î¼sï¼‰</li>
<li>æ—¶é’Ÿäº‹ä»¶è®¾å¤‡ç¼–ç¨‹å¼€é”€ï¼ˆ~100nsï¼‰</li>
</ul>
<p>å…¸å‹å®é™…ç²¾åº¦ï¼š1-10Î¼s</p>
</details>
<ol start="4">
<li><strong>SCHED_DEADLINE å‡†å…¥æ§åˆ¶</strong>
ç³»ç»Ÿæœ‰ä¸¤ä¸ª DEADLINE ä»»åŠ¡ï¼š</li>
</ol>
<ul>
<li>T1: runtime=2ms, period=10ms</li>
<li>T2: runtime=3ms, period=15ms
é—®ï¼šèƒ½å¦å†åŠ å…¥ T3: runtime=4ms, period=20msï¼Ÿ</li>
</ul>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>è®¡ç®— CPU åˆ©ç”¨ç‡ï¼š</p>
<ul>
<li>U1 = 2/10 = 0.2</li>
<li>U2 = 3/15 = 0.2</li>
<li>U3 = 4/20 = 0.2</li>
</ul>
<p>æ€»åˆ©ç”¨ç‡ = 0.2 + 0.2 + 0.2 = 0.6 &lt; 1</p>
<p>ç­”ï¼šå¯ä»¥åŠ å…¥ T3ã€‚ç³»ç»Ÿæ€»åˆ©ç”¨ç‡ 60%ï¼Œæ»¡è¶³ EDF å¯è°ƒåº¦æ¡ä»¶ã€‚</p>
<p>æ³¨æ„ï¼šå¤šæ ¸ç³»ç»Ÿä¸­æ¯ä¸ª CPU ç‹¬ç«‹è®¡ç®—åˆ©ç”¨ç‡ã€‚</p>
</details>
<h3 id="_8">æŒ‘æˆ˜é¢˜</h3>
<ol start="5">
<li><strong>å®æ—¶è°ƒåº¦å™¨è®¾è®¡</strong>
è®¾è®¡ä¸€ä¸ªæ··åˆè°ƒåº¦å™¨ï¼ŒåŒæ—¶æ”¯æŒå‘¨æœŸä»»åŠ¡å’Œé›¶æ˜Ÿä»»åŠ¡ï¼Œè¦æ±‚ï¼š</li>
</ol>
<ul>
<li>å‘¨æœŸä»»åŠ¡ä½¿ç”¨ EDF</li>
<li>é›¶æ˜Ÿä»»åŠ¡ä½¿ç”¨å›ºå®šä¼˜å…ˆçº§</li>
<li>ä¿è¯ä¸¤ç±»ä»»åŠ¡çš„éš”ç¦»</li>
</ul>
<p><em>æç¤ºï¼šè€ƒè™‘ä½¿ç”¨æœåŠ¡å™¨ï¼ˆserverï¼‰æœºåˆ¶</em></p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>æ··åˆè°ƒåº¦å™¨æ¶æ„ï¼š</p>
<ol>
<li>
<p><strong>CBS (Constant Bandwidth Server) ç”¨äºé›¶æ˜Ÿä»»åŠ¡</strong>
   - ä¸ºé›¶æ˜Ÿä»»åŠ¡é¢„ç•™å¸¦å®½
   - è½¬æ¢ä¸ºå‘¨æœŸæ€§é¢„ç®—è¡¥å……</p>
</li>
<li>
<p><strong>å±‚æ¬¡åŒ–è°ƒåº¦</strong></p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code>æ ¹è°ƒåº¦å™¨ï¼ˆEDFï¼‰
â”œâ”€â”€ å‘¨æœŸä»»åŠ¡1
â”œâ”€â”€ å‘¨æœŸä»»åŠ¡2
â””â”€â”€ CBSæœåŠ¡å™¨
    â”œâ”€â”€ é›¶æ˜Ÿä»»åŠ¡1ï¼ˆä¼˜å…ˆçº§ï¼‰
    â””â”€â”€ é›¶æ˜Ÿä»»åŠ¡2ï¼ˆä¼˜å…ˆçº§ï¼‰
</code></pre></div>

<ol start="3">
<li>
<p><strong>å‡†å…¥æ§åˆ¶</strong>
   - å‘¨æœŸä»»åŠ¡ï¼šÎ£(Ci/Ti) â‰¤ Î±
   - CBSé¢„ç®—ï¼šQs/Ts â‰¤ 1-Î±
   - Î± æ˜¯å‘¨æœŸä»»åŠ¡é¢„ç•™æ¯”ä¾‹</p>
</li>
<li>
<p><strong>å®ç°è¦ç‚¹</strong>
   - CBS ä½œä¸º EDF ä»»åŠ¡å‚ä¸è°ƒåº¦
   - CBS å†…éƒ¨ä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—
   - é¢„ç®—è€—å°½æ—¶ CBS æš‚åœ</p>
</li>
</ol>
</details>
<ol start="6">
<li><strong>å»¶è¿ŸæŠ–åŠ¨åˆ†æ</strong>
å®æ—¶ä»»åŠ¡æ¯ 10ms æ‰§è¡Œä¸€æ¬¡ï¼Œæµ‹é‡åˆ°å»¶è¿Ÿåˆ†å¸ƒï¼š</li>
</ol>
<ul>
<li>99%: &lt; 50Î¼s</li>
<li>0.9%: 50-100Î¼s  </li>
<li>0.1%: &gt; 1ms</li>
</ul>
<p>åˆ†æå¯èƒ½çš„åŸå› å’Œä¼˜åŒ–æ–¹æ¡ˆã€‚</p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p><strong>å»¶è¿Ÿå°–å³°åŸå› åˆ†æ</strong>ï¼š</p>
<ol>
<li>
<p><strong>SMI (System Management Interrupt)</strong>
   - æ£€æµ‹ï¼šhwlat_detector
   - è§£å†³ï¼šBIOS è®¾ç½®ç¦ç”¨ SMI</p>
</li>
<li>
<p><strong>CPU é¢‘ç‡è°ƒèŠ‚</strong>
   - æ£€æµ‹ï¼š/sys/devices/system/cpu/cpu*/cpufreq/
   - è§£å†³ï¼šperformance governor</p>
</li>
<li>
<p><strong>å†…å­˜é¡µé”™è¯¯</strong>
   - æ£€æµ‹ï¼šç¼ºé¡µç»Ÿè®¡
   - è§£å†³ï¼šmlockall() + é¢„åˆ†é…</p>
</li>
<li>
<p><strong>ç¼“å­˜æœªå‘½ä¸­</strong>
   - æ£€æµ‹ï¼šperf stat -e cache-misses
   - è§£å†³ï¼šç¼“å­˜é¢„çƒ­ï¼ŒNUMA ç»‘å®š</p>
</li>
<li>
<p><strong>ä¸­æ–­é£æš´</strong>
   - æ£€æµ‹ï¼š/proc/interrupts
   - è§£å†³ï¼šä¸­æ–­åˆå¹¶ï¼ŒNAPI</p>
</li>
</ol>
<p><strong>ä¼˜åŒ–æ–¹æ¡ˆ</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># 1. CPU é…ç½®</span>
<span class="nb">echo</span><span class="w"> </span>performance<span class="w"> </span>&gt;<span class="w"> </span>/sys/devices/system/cpu/cpu2/cpufreq/scaling_governor
<span class="nb">echo</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/devices/system/cpu/cpu2/online<span class="w">  </span><span class="c1"># éš”ç¦» CPU</span>

<span class="c1"># 2. ä¸­æ–­ç»‘å®š</span>
<span class="nb">echo</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>&gt;<span class="w"> </span>/proc/irq/default_smp_affinity

<span class="c1"># 3. å†…æ ¸å‚æ•°</span>
<span class="nv">nohz_full</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">rcu_nocbs</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">isolcpus</span><span class="o">=</span><span class="m">2</span>

<span class="c1"># 4. åº”ç”¨ä¼˜åŒ–</span>

-<span class="w"> </span>å†…å­˜é¢„åˆ†é…
-<span class="w"> </span>ç¼“å­˜é¢„çƒ­å¾ªç¯
-<span class="w"> </span>é¿å…ç³»ç»Ÿè°ƒç”¨
</code></pre></div>

</details>
<ol start="7">
<li><strong>å®æ—¶è¡¥ä¸ç§»æ¤</strong>
å°† PREEMPT_RT è¡¥ä¸ç§»æ¤åˆ°åµŒå…¥å¼ ARM å¹³å°ï¼Œéœ€è¦è€ƒè™‘å“ªäº›æ¶æ„ç›¸å…³é—®é¢˜ï¼Ÿ</li>
</ol>
<details>
<summary>ç­”æ¡ˆ</summary>
<p><strong>ARM æ¶æ„ç‰¹æ®Šè€ƒè™‘</strong>ï¼š</p>
<ol>
<li>
<p><strong>ä¸­æ–­æ§åˆ¶å™¨å·®å¼‚</strong>
   - GIC vs NVIC
   - ä¸­æ–­ä¼˜å…ˆçº§ä½æ•°
   - FIQ vs IRQ å¤„ç†</p>
</li>
<li>
<p><strong>åŸå­æ“ä½œå®ç°</strong>
   - LDREX/STREX æŒ‡ä»¤
   - å†…å­˜å±éšœå·®å¼‚ï¼ˆDMB/DSB/ISBï¼‰
   - Thumb vs ARM æ¨¡å¼</p>
</li>
<li>
<p><strong>å®šæ—¶å™¨æ¶æ„</strong>
   - Generic Timer vs SysTick
   - æ—¶é’Ÿæºç²¾åº¦ï¼ˆ32.768kHz vs MHzï¼‰</p>
</li>
<li>
<p><strong>ç¼“å­˜æ¶æ„</strong>
   - ç¼“å­˜è¡Œå¤§å°ï¼ˆ32B vs 64Bï¼‰
   - ç¼“å­˜ä¸€è‡´æ€§åè®®</p>
</li>
<li>
<p><strong>ç§»æ¤æ­¥éª¤</strong></p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="mf">1.</span><span class="w"> </span><span class="n">æ¶æ„ç›¸å…³ä»£ç </span><span class="err">ï¼ˆ</span><span class="n">arch</span><span class="o">/</span><span class="n">arm</span><span class="o">/</span><span class="err">ï¼‰</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">ä¸Šä¸‹æ–‡åˆ‡æ¢</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">ä¸­æ–­å…¥å£</span><span class="o">/</span><span class="n">å‡ºå£</span>

<span class="mf">2.</span><span class="w"> </span><span class="n">å¹³å°é©±åŠ¨</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">å®šæ—¶å™¨é©±åŠ¨</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">ä¸­æ–­æ§åˆ¶å™¨</span>

<span class="mf">3.</span><span class="w"> </span><span class="n">é…ç½®é€‰é¡¹</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">Kconfig</span><span class="w"> </span><span class="n">ä¾èµ–</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">é»˜è®¤é…ç½®</span>

<span class="mf">4.</span><span class="w"> </span><span class="n">æµ‹è¯•éªŒè¯</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">cyclictest</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">stress</span><span class="o">-</span><span class="n">ng</span>
</code></pre></div>

<ol start="6">
<li><strong>å¸¸è§é—®é¢˜</strong>
   - FPU ä¸Šä¸‹æ–‡ä¿å­˜
   - Thumb-2 ä»£ç ä¼˜åŒ–
   - èƒ½è€—ç®¡ç†å†²çª</li>
</ol>
</details>
<ol start="8">
<li><strong>å½¢å¼åŒ–éªŒè¯</strong>
ä½¿ç”¨æ¨¡å‹æ£€æŸ¥å·¥å…·éªŒè¯ä¼˜å…ˆçº§ç»§æ‰¿åè®®çš„æ­£ç¡®æ€§ï¼Œå»ºç«‹ä»€ä¹ˆæ ·çš„æ¨¡å‹ï¼Ÿ</li>
</ol>
<details>
<summary>ç­”æ¡ˆ</summary>
<p><strong>UPPAAL æ—¶é—´è‡ªåŠ¨æœºæ¨¡å‹</strong>ï¼š</p>
<ol>
<li><strong>ä»»åŠ¡è‡ªåŠ¨æœº</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code>çŠ¶æ€ï¼šReady, Running, Blocked
æ—¶é’Ÿï¼šexec_time, deadline
è¿ç§»ï¼š

<span class="k">-</span> Ready â†’ Running [guard: highest_prio]
<span class="k">-</span> Running â†’ Blocked [sync: lock_request]
<span class="k">-</span> Blocked â†’ Ready [sync: lock_release]
</code></pre></div>

<ol start="2">
<li><strong>äº’æ–¥é”è‡ªåŠ¨æœº</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code>çŠ¶æ€ï¼šFree, Locked
å˜é‡ï¼šowner, wait_queue
è¿ç§»ï¼š

<span class="k">-</span> Free â†’ Locked [sync: lock_request]
<span class="k">-</span> Locked â†’ Free [sync: lock_release]
</code></pre></div>

<ol start="3">
<li><strong>éªŒè¯å±æ€§ï¼ˆCTLï¼‰</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// æ— æ­»é”</span>
<span class="nx">A</span><span class="p">[]</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="nx">deadlock</span>

<span class="c1">// ä¼˜å…ˆçº§åè½¬bounded</span>
<span class="nx">A</span><span class="p">[]</span><span class="w"> </span><span class="p">(</span><span class="nx">Task_H</span><span class="p">.</span><span class="nx">Blocked</span><span class="w"> </span><span class="nx">imply</span><span class="w"> </span>
<span class="w">     </span><span class="nx">Task_H</span><span class="p">.</span><span class="nx">wait_time</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">MAX_INVERSION</span><span class="p">)</span>

<span class="c1">// äº’æ–¥æ€§</span>
<span class="nx">A</span><span class="p">[]</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="p">(</span><span class="nx">Task1</span><span class="p">.</span><span class="nx">cs</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">Task2</span><span class="p">.</span><span class="nx">cs</span><span class="p">)</span>

<span class="c1">// å®æ—¶æ€§</span>
<span class="nx">A</span><span class="p">[]</span><span class="w"> </span><span class="p">(</span><span class="nx">Task</span><span class="p">.</span><span class="nx">exec_time</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">Task</span><span class="p">.</span><span class="nx">deadline</span><span class="p">)</span>
</code></pre></div>

<ol start="4">
<li><strong>æ¨¡å‹å‚æ•°</strong>
   - ä»»åŠ¡æ•°ï¼š3-5
   - ä¼˜å…ˆçº§ï¼šç¦»æ•£å€¼
   - æ‰§è¡Œæ—¶é—´ï¼šåŒºé—´
   - ä¸´ç•ŒåŒºï¼šéç¡®å®šé€‰æ‹©</li>
</ol>
<p>éªŒè¯å¯å‘ç°æ­»é”ã€æ— ç•Œä¼˜å…ˆçº§åè½¬ç­‰é—®é¢˜ã€‚</p>
</details>
<h2 id="_9">å¸¸è§é™·é˜±ä¸é”™è¯¯</h2>
<h3 id="1-rt">1. RT å†…æ ¸ä¸ç­‰äºç¡¬å®æ—¶</h3>
<p><strong>é™·é˜±</strong>ï¼šè®¤ä¸ºä½¿ç”¨ PREEMPT_RT å°±èƒ½ä¿è¯ç¡¬å®æ—¶</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># é”™è¯¯æƒ³æ³•ï¼šè£…äº† RT å†…æ ¸å°±æ˜¯ç¡¬å®æ—¶ç³»ç»Ÿ</span>
</code></pre></div>

<p><strong>æ­£è§£</strong>ï¼šRT å†…æ ¸åªæ˜¯é™ä½å»¶è¿Ÿï¼Œç¡¬å®æ—¶éœ€è¦ï¼š</p>
<ul>
<li>WCET åˆ†æ</li>
<li>èµ„æºé¢„ç•™</li>
<li>é”™è¯¯éš”ç¦»</li>
<li>è®¤è¯æ ‡å‡†ï¼ˆDO-178Cã€IEC 61508ï¼‰</li>
</ul>
<h3 id="2">2. ä¼˜å…ˆçº§è®¾ç½®é”™è¯¯</h3>
<p><strong>é™·é˜±</strong>ï¼šéšæ„è®¾ç½®å®æ—¶ä¼˜å…ˆçº§</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// å±é™©ï¼šæœ€é«˜ä¼˜å…ˆçº§å¯èƒ½é¥¿æ­»ç³»ç»Ÿä»»åŠ¡</span>
<span class="n">param</span><span class="p">.</span><span class="n">sched_priority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="p">;</span>
<span class="n">sched_setscheduler</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">SCHED_FIFO</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">param</span><span class="p">);</span>
</code></pre></div>

<p><strong>æ­£è§£</strong>ï¼šé¢„ç•™ä¼˜å…ˆçº§ç©ºé—´ï¼š</p>
<ul>
<li>99: ç´§æ€¥ä¸­æ–­çº¿ç¨‹</li>
<li>90-98: å…³é”®ç³»ç»ŸæœåŠ¡</li>
<li>50-89: å®æ—¶åº”ç”¨</li>
<li>1-49: è½¯å®æ—¶ä»»åŠ¡</li>
</ul>
<h3 id="3">3. å¿½è§†å†…å­˜å»¶è¿Ÿ</h3>
<p><strong>é™·é˜±</strong>ï¼šåªå…³æ³¨ CPU è°ƒåº¦</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// é¡µé”™è¯¯å¯¼è‡´æ¯«ç§’çº§å»¶è¿Ÿ</span>
<span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">LARGE_SIZE</span><span class="p">);</span>
<span class="n">memset</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">LARGE_SIZE</span><span class="p">);</span><span class="w">  </span><span class="c1">// è§¦å‘ç¼ºé¡µ</span>
</code></pre></div>

<p><strong>æ­£è§£</strong>ï¼šå®Œæ•´å†…å­˜ç®¡ç†ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">mlockall</span><span class="p">(</span><span class="n">MCL_CURRENT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MCL_FUTURE</span><span class="p">);</span>
<span class="c1">// é¢„åˆ†é…å¹¶é¢„è§¦ç¢°</span>
<span class="n">posix_memalign</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="n">memset</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
</code></pre></div>

<h3 id="4">4. ä¸­æ–­å¤„ç†ä¸å½“</h3>
<p><strong>é™·é˜±</strong>ï¼šå®æ—¶ä»»åŠ¡è¢«ä¸­æ–­é£æš´å½±å“</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># ç½‘å¡ä¸­æ–­å½±å“å®æ—¶æ€§</span>
cat<span class="w"> </span>/proc/interrupts<span class="w">  </span><span class="c1"># æ¯ç§’æ•°ä¸‡ä¸­æ–­</span>
</code></pre></div>

<p><strong>æ­£è§£</strong>ï¼šä¸­æ–­ç®¡ç†ç­–ç•¥ï¼š</p>
<ul>
<li>ä¸­æ–­äº²å’Œæ€§ç»‘å®š</li>
<li>NAPI è½®è¯¢æ¨¡å¼</li>
<li>ä¸­æ–­åˆå¹¶ï¼ˆethtool -Cï¼‰</li>
<li>ä¸­æ–­çº¿ç¨‹åŒ–ä¼˜å…ˆçº§è°ƒæ•´</li>
</ul>
<h3 id="5">5. è°ƒè¯•å·¥å…·ä½¿ç”¨ä¸å½“</h3>
<p><strong>é™·é˜±</strong>ï¼šä½¿ç”¨ printk è°ƒè¯•å®æ—¶ä»£ç </p>
<div class="codehilite"><pre><span></span><code><span class="c1">// printk å¯èƒ½å¯¼è‡´æ•°ç™¾å¾®ç§’å»¶è¿Ÿ</span>
<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Enter critical section</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</code></pre></div>

<p><strong>æ­£è§£</strong>ï¼šä½¿ç”¨æ— é”è¿½è¸ªï¼š</p>
<ul>
<li>ftrace äº‹ä»¶</li>
<li>å¾ªç¯ç¼“å†²åŒº</li>
<li>LTTng/SystemTap</li>
</ul>
<h2 id="_10">æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•</h2>
<h3 id="_11">ç³»ç»Ÿé…ç½®</h3>
<ul>
<li>[ ] å†…æ ¸ç¼–è¯‘é€‰é¡¹</li>
<li>CONFIG_PREEMPT_RT å¯ç”¨</li>
<li>CONFIG_DEBUG_PREEMPT è°ƒè¯•æœŸå¯ç”¨</li>
<li>CONFIG_NO_HZ_FULL é…ç½®</li>
<li>[ ] å¯åŠ¨å‚æ•°è®¾ç½®</li>
<li>isolcpus éš”ç¦» RT CPU</li>
<li>nohz_full ç¦ç”¨æ—¶é’Ÿä¸­æ–­</li>
<li>rcu_nocbs ç§»é™¤ RCU å›è°ƒ</li>
<li>[ ] BIOS/UEFI é…ç½®</li>
<li>ç¦ç”¨ SMI</li>
<li>ç¦ç”¨ CPU é¢‘ç‡è°ƒèŠ‚</li>
<li>ç¦ç”¨ C-states</li>
</ul>
<h3 id="_12">åº”ç”¨è®¾è®¡</h3>
<ul>
<li>[ ] å®æ—¶ä»»åŠ¡åˆå§‹åŒ–</li>
<li>è°ƒåº¦ç­–ç•¥è®¾ç½®ï¼ˆFIFO/RR/DEADLINEï¼‰</li>
<li>CPU äº²å’Œæ€§ç»‘å®š</li>
<li>å†…å­˜é”å®šï¼ˆmlockallï¼‰</li>
<li>æ ˆé¢„åˆ†é…</li>
<li>[ ] èµ„æºç®¡ç†</li>
<li>é¿å…åŠ¨æ€å†…å­˜åˆ†é…</li>
<li>ä½¿ç”¨å†…å­˜æ± </li>
<li>é¢„åˆ†é…æ‰€æœ‰èµ„æº</li>
<li>[ ] åŒæ­¥æœºåˆ¶</li>
<li>ä¼˜å…ˆä½¿ç”¨ rt_mutex</li>
<li>é¿å…ä¼˜å…ˆçº§åè½¬</li>
<li>æœ€å°åŒ–ä¸´ç•ŒåŒº</li>
</ul>
<h3 id="_13">æ€§èƒ½ç›‘æ§</h3>
<ul>
<li>[ ] å»¶è¿Ÿæµ‹é‡</li>
<li>cyclictest åŸºå‡†æµ‹è¯•</li>
<li>åº”ç”¨å†…å»¶è¿Ÿç»Ÿè®¡</li>
<li>æœ€åæƒ…å†µè®°å½•</li>
<li>[ ] ç³»ç»Ÿè¿½è¸ª</li>
<li>ftrace é…ç½®</li>
<li>perf äº‹ä»¶ç›‘æ§</li>
<li>eBPF æ¢é’ˆéƒ¨ç½²</li>
<li>[ ] èµ„æºç›‘æ§</li>
<li>CPU åˆ©ç”¨ç‡ &lt; 70%</li>
<li>å†…å­˜é”å®šé‡æ£€æŸ¥</li>
<li>ä¸­æ–­é¢‘ç‡ç›‘æ§</li>
</ul>
<h3 id="_14">æµ‹è¯•éªŒè¯</h3>
<ul>
<li>[ ] åŠŸèƒ½æµ‹è¯•</li>
<li>æ‰€æœ‰å®æ—¶çº¦æŸæ»¡è¶³</li>
<li>é™çº§æ¨¡å¼æ­£ç¡®</li>
<li>é”™è¯¯æ¢å¤æœºåˆ¶</li>
<li>[ ] å‹åŠ›æµ‹è¯•</li>
<li>CPU å‹åŠ›ï¼ˆstress-ngï¼‰</li>
<li>å†…å­˜å‹åŠ›</li>
<li>I/O å‹åŠ›</li>
<li>ç»„åˆå‹åŠ›åœºæ™¯</li>
<li>[ ] é•¿æœŸç¨³å®šæ€§</li>
<li>72 å°æ—¶è¿ç»­è¿è¡Œ</li>
<li>å†…å­˜æ³„æ¼æ£€æŸ¥</li>
<li>ä¼˜å…ˆçº§ç»§æ‰¿é“¾æ£€æŸ¥</li>
</ul>
<h3 id="_15">æ–‡æ¡£è§„èŒƒ</h3>
<ul>
<li>[ ] è®¾è®¡æ–‡æ¡£</li>
<li>ä»»åŠ¡æ¨¡å‹å®šä¹‰</li>
<li>æ—¶åºå›¾</li>
<li>WCET åˆ†æ</li>
<li>[ ] é…ç½®æ–‡æ¡£</li>
<li>å†…æ ¸é…ç½®</li>
<li>ç³»ç»Ÿè°ƒä¼˜å‚æ•°</li>
<li>åº”ç”¨é…ç½®</li>
<li>[ ] è¿ç»´æ‰‹å†Œ</li>
<li>ç›‘æ§æŒ‡æ ‡</li>
<li>æ•…éšœè¯Šæ–­æµç¨‹</li>
<li>æ€§èƒ½è°ƒä¼˜æŒ‡å—
```</li>
</ul>
            </article>
            
            <nav class="page-nav"><a href="chapter13.html" class="nav-link prev">â† ç¬¬13ç« ï¼šå®‰å…¨å­ç³»ç»Ÿ</a><a href="chapter15.html" class="nav-link next">ç¬¬15ç« ï¼šæ€§èƒ½åˆ†æä¸è°ƒè¯• â†’</a></nav>
        </main>
    </div>
</body>
</html>