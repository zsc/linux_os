<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬4ç« ï¼šè¿›ç¨‹é—´é€šä¿¡æœºåˆ¶</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Linux å†…æ ¸æºä»£ç æ·±åº¦è§£æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬1ç« ï¼šLinux å†…æ ¸æ¦‚è¿°ä¸å‘å±•å²</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬2ç« ï¼šè¿›ç¨‹ç®¡ç†ä¸ä»»åŠ¡è°ƒåº¦</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬3ç« ï¼šå†…å­˜ç®¡ç†æ¶æ„</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬4ç« ï¼šè¿›ç¨‹é—´é€šä¿¡æœºåˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬5ç« ï¼šè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬6ç« ï¼šå…·ä½“æ–‡ä»¶ç³»ç»Ÿå®ç°</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬7ç« ï¼šå—è®¾å¤‡å±‚ä¸I/Oè°ƒåº¦</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬8ç« ï¼šè®¾å¤‡é©±åŠ¨æ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬9ç« ï¼šç½‘ç»œåè®®æ ˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬10ç« ï¼šå†…æ ¸åŒæ­¥æœºåˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬11ç« ï¼šå¹¶å‘ç¼–ç¨‹æ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬12ç« ï¼šå®¹å™¨ä¸å‘½åç©ºé—´</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬13ç« ï¼šå®‰å…¨å­ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬14ç« ï¼šå®æ—¶Linux</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬15ç« ï¼šæ€§èƒ½åˆ†æä¸è°ƒè¯•</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬16ç« ï¼šå¼•å¯¼è¿‡ç¨‹ä¸åˆå§‹åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="4">ç¬¬4ç« ï¼šè¿›ç¨‹é—´é€šä¿¡æœºåˆ¶</h1>
<p>è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰æ˜¯æ“ä½œç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œå®ƒä½¿å¾—ç‹¬ç«‹çš„è¿›ç¨‹èƒ½å¤Ÿäº¤æ¢æ•°æ®ã€åŒæ­¥æ‰§è¡Œå’Œåè°ƒèµ„æºè®¿é—®ã€‚Linux å†…æ ¸æä¾›äº†ä¸°å¯Œçš„ IPC æœºåˆ¶ï¼Œä»ç»å…¸çš„ Unix ç®¡é“åˆ°ç°ä»£çš„ futex å’Œ io_uringï¼Œæ¯ç§æœºåˆ¶éƒ½æœ‰å…¶ç‹¬ç‰¹çš„è®¾è®¡å“²å­¦å’Œé€‚ç”¨åœºæ™¯ã€‚æœ¬ç« å°†æ·±å…¥å‰–æ Linux IPC æœºåˆ¶çš„å†…æ ¸å®ç°ï¼Œæ­ç¤ºå…¶èƒŒåçš„ç®—æ³•åŸç†ã€æ€§èƒ½ç‰¹å¾å’Œæ¼”è¿›å†ç¨‹ã€‚</p>
<h2 id="_1">å­¦ä¹ ç›®æ ‡</h2>
<p>å®Œæˆæœ¬ç« å­¦ä¹ åï¼Œæ‚¨å°†èƒ½å¤Ÿï¼š</p>
<ol>
<li><strong>ç†è§£ä¼ ç»Ÿ IPC æœºåˆ¶</strong>ï¼šæŒæ¡ç®¡é“ã€æ¶ˆæ¯é˜Ÿåˆ—ã€å…±äº«å†…å­˜çš„å†…æ ¸å®ç°å’Œæ•°æ®ç»“æ„</li>
<li><strong>åˆ†æä¿¡å·ç³»ç»Ÿæ¶æ„</strong>ï¼šç†è§£ä¿¡å·çš„äº§ç”Ÿã€æŠ•é€’ã€å¤„ç†å…¨æµç¨‹ï¼ŒåŒ…æ‹¬å®æ—¶ä¿¡å·æ‰©å±•</li>
<li><strong>æŒæ¡ futex åŸç†</strong>ï¼šæ·±å…¥ç†è§£ç”¨æˆ·æ€/å†…æ ¸æ€æ··åˆåŒæ­¥æœºåˆ¶ï¼ŒåŒ…æ‹¬ PI-futex å’Œ robust futex</li>
<li><strong>ä½¿ç”¨ç°ä»£ IPC æ¥å£</strong>ï¼šç†Ÿç»ƒè¿ç”¨ eventfdã€signalfdã€timerfd æ„å»ºé«˜æ•ˆäº‹ä»¶é©±åŠ¨ç¨‹åº</li>
<li><strong>ä¼˜åŒ– IPC æ€§èƒ½</strong>ï¼šæ ¹æ®åœºæ™¯é€‰æ‹©åˆé€‚çš„ IPC æœºåˆ¶ï¼Œå®ç°é›¶æ‹·è´å’Œ NUMA ä¼˜åŒ–</li>
<li><strong>ç†è§£å‰æ²¿æŠ€æœ¯</strong>ï¼šæŒæ¡ io_uringã€RDMA ç­‰æ–°ä¸€ä»£é«˜æ€§èƒ½é€šä¿¡æœºåˆ¶</li>
</ol>
<h2 id="41-ipc">4.1 ä¼ ç»Ÿ IPC æœºåˆ¶</h2>
<p>Linux å†…æ ¸ç»§æ‰¿å¹¶æ‰©å±•äº† Unix çš„ä¼ ç»Ÿ IPC æœºåˆ¶ã€‚è¿™äº›æœºåˆ¶è™½ç„¶å†å²æ‚ ä¹…ï¼Œä½†åœ¨ç°ä»£ç³»ç»Ÿä¸­ä»ç„¶æ‰®æ¼”ç€é‡è¦è§’è‰²ã€‚ç†è§£å®ƒä»¬çš„å®ç°åŸç†å¯¹äºç³»ç»Ÿç¼–ç¨‹å’Œæ€§èƒ½ä¼˜åŒ–è‡³å…³é‡è¦ã€‚</p>
<h3 id="411-pipe">4.1.1 ç®¡é“ï¼ˆPipeï¼‰æœºåˆ¶æ·±åº¦å‰–æ</h3>
<h4 id="_2">åŒ¿åç®¡é“å®ç°åŸç†</h4>
<p>ç®¡é“æ˜¯ Unix æœ€æ—©çš„ IPC æœºåˆ¶ä¹‹ä¸€ï¼Œå…¶ä¼˜é›…çš„è®¾è®¡ä½“ç°äº† "ä¸€åˆ‡çš†æ–‡ä»¶" çš„å“²å­¦ã€‚åœ¨ Linux å†…æ ¸ä¸­ï¼Œç®¡é“é€šè¿‡ç‰¹æ®Šçš„æ–‡ä»¶ç³»ç»Ÿ pipefs å®ç°ã€‚</p>
<p><strong>æ ¸å¿ƒæ•°æ®ç»“æ„</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// fs/pipe.c</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">pipe_inode_info</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mutex</span><span class="w"> </span><span class="n">mutex</span><span class="p">;</span><span class="w">           </span><span class="c1">// ä¿æŠ¤ç®¡é“çŠ¶æ€çš„äº’æ–¥é”</span>
<span class="w">    </span><span class="n">wait_queue_head_t</span><span class="w"> </span><span class="n">rd_wait</span><span class="p">;</span><span class="w">    </span><span class="c1">// è¯»è€…ç­‰å¾…é˜Ÿåˆ—</span>
<span class="w">    </span><span class="n">wait_queue_head_t</span><span class="w"> </span><span class="n">wr_wait</span><span class="p">;</span><span class="w">    </span><span class="c1">// å†™è€…ç­‰å¾…é˜Ÿåˆ—</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">head</span><span class="p">;</span><span class="w">            </span><span class="c1">// ç¯å½¢ç¼“å†²åŒºå¤´éƒ¨</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">tail</span><span class="p">;</span><span class="w">            </span><span class="c1">// ç¯å½¢ç¼“å†²åŒºå°¾éƒ¨</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">max_usage</span><span class="p">;</span><span class="w">       </span><span class="c1">// æœ€å¤§ç¼“å†²åŒºæ•°é‡</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ring_size</span><span class="p">;</span><span class="w">       </span><span class="c1">// ç¯å½¢ç¼“å†²åŒºå¤§å°ï¼ˆå¿…é¡»æ˜¯2çš„å¹‚ï¼‰</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">readers</span><span class="p">;</span><span class="w">         </span><span class="c1">// è¯»è€…è®¡æ•°</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">writers</span><span class="p">;</span><span class="w">         </span><span class="c1">// å†™è€…è®¡æ•°</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">files</span><span class="p">;</span><span class="w">           </span><span class="c1">// å¼•ç”¨è®¡æ•°</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">r_counter</span><span class="p">;</span><span class="w">       </span><span class="c1">// è¯»è®¡æ•°å™¨ï¼ˆç”¨äº pollï¼‰</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">w_counter</span><span class="p">;</span><span class="w">       </span><span class="c1">// å†™è®¡æ•°å™¨ï¼ˆç”¨äº pollï¼‰</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="o">*</span><span class="n">tmp_page</span><span class="p">;</span><span class="w">        </span><span class="c1">// ä¸´æ—¶é¡µé¢ï¼ˆä¼˜åŒ–å°æ•°æ®ä¼ è¾“ï¼‰</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">fasync_struct</span><span class="w"> </span><span class="o">*</span><span class="n">fasync_readers</span><span class="p">;</span><span class="w">  </span><span class="c1">// å¼‚æ­¥é€šçŸ¥è¯»è€…</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">fasync_struct</span><span class="w"> </span><span class="o">*</span><span class="n">fasync_writers</span><span class="p">;</span><span class="w">  </span><span class="c1">// å¼‚æ­¥é€šçŸ¥å†™è€…</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pipe_buffer</span><span class="w"> </span><span class="o">*</span><span class="n">bufs</span><span class="p">;</span><span class="w">     </span><span class="c1">// ç¯å½¢ç¼“å†²åŒºæ•°ç»„</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">user_struct</span><span class="w"> </span><span class="o">*</span><span class="n">user</span><span class="p">;</span><span class="w">     </span><span class="c1">// åˆ›å»ºè€…ç”¨æˆ·ç»“æ„</span>
<span class="p">};</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">pipe_buffer</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="o">*</span><span class="n">page</span><span class="p">;</span><span class="w">            </span><span class="c1">// æ•°æ®é¡µ</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span><span class="w">          </span><span class="c1">// é¡µå†…åç§»</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w">             </span><span class="c1">// æœ‰æ•ˆæ•°æ®é•¿åº¦</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">pipe_buf_operations</span><span class="w"> </span><span class="o">*</span><span class="n">ops</span><span class="p">;</span><span class="w">  </span><span class="c1">// ç¼“å†²åŒºæ“ä½œå‡½æ•°</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span><span class="w">           </span><span class="c1">// æ ‡å¿—ä½</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">private</span><span class="p">;</span><span class="w">        </span><span class="c1">// ç§æœ‰æ•°æ®</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>ç®¡é“åˆ›å»ºæµç¨‹</strong></p>
<p>å½“è¿›ç¨‹è°ƒç”¨ <code>pipe()</code> æˆ– <code>pipe2()</code> ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå†…æ ¸æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š</p>
<ol>
<li><strong>åˆ†é… pipe_inode_info ç»“æ„</strong>ï¼šåˆå§‹åŒ–ç®¡é“çš„å…ƒæ•°æ®</li>
<li><strong>åˆ›å»ºä¸¤ä¸ª file ç»“æ„</strong>ï¼šåˆ†åˆ«ç”¨äºè¯»ç«¯å’Œå†™ç«¯</li>
<li><strong>è®¾ç½®æ–‡ä»¶æ“ä½œå‡½æ•°</strong>ï¼šè¯»ç«¯ä½¿ç”¨ <code>read_pipe_fops</code>ï¼Œå†™ç«¯ä½¿ç”¨ <code>write_pipe_fops</code></li>
<li><strong>åˆ†é…æ–‡ä»¶æè¿°ç¬¦</strong>ï¼šå°†ä¸¤ä¸ª fd è¿”å›ç»™ç”¨æˆ·ç©ºé—´</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// fs/pipe.c ç®€åŒ–ç‰ˆ</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">do_pipe2</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">fildes</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">files</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>

<span class="w">    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__do_pipe_flags</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">files</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// å°†æ–‡ä»¶æè¿°ç¬¦å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">fildes</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">fd</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// é”™è¯¯å¤„ç†</span>
<span class="w">            </span><span class="n">fput</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">            </span><span class="n">fput</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">            </span><span class="n">put_unused_fd</span><span class="p">(</span><span class="n">fd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">            </span><span class="n">put_unused_fd</span><span class="p">(</span><span class="n">fd</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">            </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// å®‰è£…æ–‡ä»¶æè¿°ç¬¦</span>
<span class="w">            </span><span class="n">fd_install</span><span class="p">(</span><span class="n">fd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">            </span><span class="n">fd_install</span><span class="p">(</span><span class="n">fd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">files</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>ç¯å½¢ç¼“å†²åŒºç®¡ç†</strong></p>
<p>Linux ç®¡é“ä½¿ç”¨ç¯å½¢ç¼“å†²åŒºï¼ˆcircular bufferï¼‰ç®¡ç†æ•°æ®ï¼Œè¿™ç§è®¾è®¡æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š</p>
<ol>
<li><strong>ç©ºé—´æ•ˆç‡</strong>ï¼šé¿å…æ•°æ®ç§»åŠ¨ï¼Œé€šè¿‡è°ƒæ•´æŒ‡é’ˆå®ç°å¾ªç¯ä½¿ç”¨</li>
<li><strong>æ—¶é—´æ•ˆç‡</strong>ï¼šO(1) çš„å…¥é˜Ÿå’Œå‡ºé˜Ÿæ“ä½œ</li>
<li><strong>ç¼“å­˜å‹å¥½</strong>ï¼šè¿ç»­çš„å†…å­˜è®¿é—®æ¨¡å¼</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c">ç¯å½¢ç¼“å†²åŒºç¤ºæ„å›¾ï¼š</span>
<span class="c">        head</span>
<span class="c">          |</span>
<span class="c">          v</span>
<span class="c">    </span><span class="nb">+---+---+---+---+---+---+---+---+</span>
<span class="c">    | D | E |   |   |   | A | B | C |</span>
<span class="c">    </span><span class="nb">+---+---+---+---+---+---+---+---+</span>
<span class="c">              ^               ^</span>
<span class="c">              |               |</span>
<span class="c">           tail         wrapped data</span>
</code></pre></div>

<p><strong>è¯»å†™æ“ä½œå®ç°</strong></p>
<p>ç®¡é“çš„è¯»å†™æ“ä½œæ¶‰åŠå¤æ‚çš„åŒæ­¥æœºåˆ¶ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ç®€åŒ–çš„ç®¡é“å†™æ“ä½œ</span>
<span class="k">static</span><span class="w"> </span><span class="kt">ssize_t</span>
<span class="nf">pipe_write</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">kiocb</span><span class="w"> </span><span class="o">*</span><span class="n">iocb</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">iov_iter</span><span class="w"> </span><span class="o">*</span><span class="n">from</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">filp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iocb</span><span class="o">-&gt;</span><span class="n">ki_filp</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pipe_inode_info</span><span class="w"> </span><span class="o">*</span><span class="n">pipe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">head</span><span class="p">,</span><span class="w"> </span><span class="n">tail</span><span class="p">,</span><span class="w"> </span><span class="n">max_usage</span><span class="p">,</span><span class="w"> </span><span class="n">mask</span><span class="p">;</span>
<span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">total_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iov_iter_count</span><span class="p">(</span><span class="n">from</span><span class="p">);</span>
<span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">chars</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">was_empty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="w">    </span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// æ£€æŸ¥æ˜¯å¦æœ‰è¯»è€…</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">readers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">send_sig</span><span class="p">(</span><span class="n">SIGPIPE</span><span class="p">,</span><span class="w"> </span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
<span class="w">    </span><span class="n">tail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">;</span>
<span class="w">    </span><span class="n">max_usage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">max_usage</span><span class="p">;</span>
<span class="w">    </span><span class="n">mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">ring_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// è®¡ç®—å¯ç”¨ç©ºé—´</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pipe_full</span><span class="p">(</span><span class="n">head</span><span class="p">,</span><span class="w"> </span><span class="n">tail</span><span class="p">,</span><span class="w"> </span><span class="n">max_usage</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">head_buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">head</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">mask</span><span class="p">;</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">pipe_buffer</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">head_buf</span><span class="p">];</span>

<span class="w">        </span><span class="c1">// åˆ†é…é¡µé¢å¹¶å¤åˆ¶æ•°æ®</span>
<span class="w">        </span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_HIGHUSER</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">__GFP_ACCOUNT</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// ä»ç”¨æˆ·ç©ºé—´å¤åˆ¶æ•°æ®</span>
<span class="w">        </span><span class="n">chars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">copy_page_from_iter</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">from</span><span class="p">);</span>
<span class="w">        </span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chars</span><span class="p">;</span>

<span class="w">        </span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">head</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">chars</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// å”¤é†’ç­‰å¾…çš„è¯»è€…</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">was_empty</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">wake_up_interruptible_sync_poll</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">rd_wait</span><span class="p">,</span><span class="w"> </span><span class="n">EPOLLIN</span><span class="p">);</span>
<span class="w">            </span><span class="n">kill_fasync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">fasync_readers</span><span class="p">,</span><span class="w"> </span><span class="n">SIGIO</span><span class="p">,</span><span class="w"> </span><span class="n">POLL_IN</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="nl">out</span><span class="p">:</span>
<span class="w">    </span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="fifo">å‘½åç®¡é“ï¼ˆFIFOï¼‰</h4>
<p>å‘½åç®¡é“é€šè¿‡æ–‡ä»¶ç³»ç»Ÿæä¾›æŒä¹…åŒ–çš„ IPC é€šé“ï¼Œå…è®¸æ— äº²ç¼˜å…³ç³»çš„è¿›ç¨‹é€šä¿¡ã€‚</p>
<p><strong>FIFO åˆ›å»ºä¸æ‰“å¼€</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// fs/pipe.c</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">fifo_open</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pipe_inode_info</span><span class="w"> </span><span class="o">*</span><span class="n">pipe</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">is_pipe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_magic</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PIPEFS_MAGIC</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">    </span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_pipe</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pipe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_pipe</span><span class="p">;</span>
<span class="w">        </span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">files</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
<span class="w">        </span><span class="n">pipe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_pipe_info</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pipe</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="w">        </span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_pipe</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// å¦ä¸€ä¸ªè¿›ç¨‹å·²ç»åˆ›å»ºäº†ç®¡é“</span>
<span class="w">            </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_pipe</span><span class="o">-&gt;</span><span class="n">files</span><span class="o">++</span><span class="p">;</span>
<span class="w">            </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
<span class="w">            </span><span class="n">free_pipe_info</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
<span class="w">            </span><span class="n">pipe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_pipe</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_pipe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pipe</span><span class="p">;</span>
<span class="w">            </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_lock</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pipe</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// æ ¹æ®æ‰“å¼€æ¨¡å¼æ›´æ–°è¯»è€…/å†™è€…è®¡æ•°</span>
<span class="w">    </span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_mode</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FMODE_READ</span><span class="p">)</span>
<span class="w">        </span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">readers</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_mode</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FMODE_WRITE</span><span class="p">)</span>
<span class="w">        </span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">writers</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="splice-tee">splice å’Œ tee ç³»ç»Ÿè°ƒç”¨</h4>
<p>splice å’Œ tee æ˜¯ Linux 2.6.17 å¼•å…¥çš„é›¶æ‹·è´æ•°æ®ä¼ è¾“æœºåˆ¶ï¼Œå¤§å¹…æå‡äº†ç®¡é“çš„æ€§èƒ½ã€‚</p>
<p><strong>splice åŸç†</strong></p>
<p>splice é€šè¿‡åœ¨å†…æ ¸ç©ºé—´ç§»åŠ¨é¡µé¢å¼•ç”¨è€Œéå¤åˆ¶æ•°æ®ï¼Œå®ç°é«˜æ•ˆçš„æ•°æ®ä¼ è¾“ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// fs/splice.c æ ¸å¿ƒé€»è¾‘</span>
<span class="n">ASMLINKAGE</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">sys_splice</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd_in</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">off_in</span><span class="p">,</span>
<span class="w">                           </span><span class="kt">int</span><span class="w"> </span><span class="n">fd_out</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">off_out</span><span class="p">,</span>
<span class="w">                           </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">fd</span><span class="w"> </span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
<span class="w">    </span><span class="n">in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fdget</span><span class="p">(</span><span class="n">fd_in</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">in</span><span class="p">.</span><span class="n">file</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fdget</span><span class="p">(</span><span class="n">fd_out</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">file</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">do_splice</span><span class="p">(</span><span class="n">in</span><span class="p">.</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">off_in</span><span class="p">,</span><span class="w"> </span><span class="n">out</span><span class="p">.</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">off_out</span><span class="p">,</span>
<span class="w">                            </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="w">            </span><span class="n">fdput</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">fdput</span><span class="p">(</span><span class="n">in</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>é›¶æ‹·è´æ•°æ®æµ</strong></p>
<div class="codehilite"><pre><span></span><code>ä¼ ç»Ÿæ–¹å¼ï¼ˆ4æ¬¡æ‹·è´ï¼‰ï¼š
ç£ç›˜ â†’ å†…æ ¸ç¼“å†²åŒº â†’ ç”¨æˆ·ç¼“å†²åŒº â†’ å†…æ ¸ç¼“å†²åŒº â†’ ç½‘ç»œ

spliceæ–¹å¼ï¼ˆ2æ¬¡æ‹·è´ï¼‰ï¼š
ç£ç›˜ â†’ å†…æ ¸ç¼“å†²åŒº â†’ ç½‘ç»œ
         ^
         |
    ä»…ç§»åŠ¨é¡µé¢å¼•ç”¨
</code></pre></div>

<h3 id="412-system-v-ipc">4.1.2 System V IPC æœºåˆ¶è¯¦è§£</h3>
<p>System V IPC æ˜¯ AT&amp;T åœ¨ System V Release 3 ä¸­å¼•å…¥çš„ä¸‰ç§ IPC æœºåˆ¶çš„ç»Ÿç§°ï¼ŒåŒ…æ‹¬æ¶ˆæ¯é˜Ÿåˆ—ã€å…±äº«å†…å­˜å’Œä¿¡å·é‡ã€‚å°½ç®¡ POSIX è¯•å›¾æä¾›æ›´ç°ä»£çš„æ›¿ä»£æ–¹æ¡ˆï¼ŒSystem V IPC å› å…¶å¹¿æ³›çš„åº”ç”¨ä»ç„¶æ˜¯ Linux å†…æ ¸çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚</p>
<h4 id="_3">é€šç”¨æ¶æ„ä¸æ•°æ®ç»“æ„</h4>
<p>System V IPC çš„ä¸‰ç§æœºåˆ¶å…±äº«ç›¸ä¼¼çš„æ¶æ„è®¾è®¡ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// include/linux/ipc.h</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">kern_ipc_perm</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">spinlock_t</span><span class="w">      </span><span class="n">lock</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w">            </span><span class="n">deleted</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w">             </span><span class="n">id</span><span class="p">;</span><span class="w">             </span><span class="c1">// IPC æ ‡è¯†ç¬¦</span>
<span class="w">    </span><span class="kt">key_t</span><span class="w">           </span><span class="n">key</span><span class="p">;</span><span class="w">            </span><span class="c1">// IPC é”®å€¼</span>
<span class="w">    </span><span class="n">kuid_t</span><span class="w">          </span><span class="n">uid</span><span class="p">;</span><span class="w">            </span><span class="c1">// æ‰€æœ‰è€… UID</span>
<span class="w">    </span><span class="n">kgid_t</span><span class="w">          </span><span class="n">gid</span><span class="p">;</span><span class="w">            </span><span class="c1">// æ‰€æœ‰è€… GID</span>
<span class="w">    </span><span class="n">kuid_t</span><span class="w">          </span><span class="n">cuid</span><span class="p">;</span><span class="w">           </span><span class="c1">// åˆ›å»ºè€… UID</span>
<span class="w">    </span><span class="n">kgid_t</span><span class="w">          </span><span class="n">cgid</span><span class="p">;</span><span class="w">           </span><span class="c1">// åˆ›å»ºè€… GID</span>
<span class="w">    </span><span class="n">umode_t</span><span class="w">         </span><span class="n">mode</span><span class="p">;</span><span class="w">           </span><span class="c1">// è®¿é—®æƒé™</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">   </span><span class="n">seq</span><span class="p">;</span><span class="w">            </span><span class="c1">// åºåˆ—å·</span>
<span class="w">    </span><span class="kt">void</span><span class="w">            </span><span class="o">*</span><span class="n">security</span><span class="p">;</span><span class="w">      </span><span class="c1">// LSM å®‰å…¨æ ‡ç­¾</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rhash_head</span><span class="w"> </span><span class="n">khtnode</span><span class="p">;</span><span class="w">      </span><span class="c1">// å“ˆå¸Œè¡¨èŠ‚ç‚¹</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rcu_head</span><span class="w"> </span><span class="n">rcu</span><span class="p">;</span><span class="w">            </span><span class="c1">// RCU å¤´</span>
<span class="w">    </span><span class="n">refcount_t</span><span class="w">      </span><span class="n">refcount</span><span class="p">;</span><span class="w">       </span><span class="c1">// å¼•ç”¨è®¡æ•°</span>
<span class="p">}</span><span class="w"> </span><span class="n">____cacheline_aligned_in_smp</span><span class="p">;</span>

<span class="c1">// IPC å‘½åç©ºé—´ç»“æ„</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">ipc_namespace</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">refcount_t</span><span class="w">      </span><span class="n">count</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ipc_ids</span><span class="w">  </span><span class="n">ids</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span><span class="w">        </span><span class="c1">// ä¸‰ç§ IPC æœºåˆ¶çš„ ID è¡¨</span>

<span class="w">    </span><span class="kt">int</span><span class="w">             </span><span class="n">sem_ctls</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span><span class="w">    </span><span class="c1">// ä¿¡å·é‡é™åˆ¶å‚æ•°</span>
<span class="w">    </span><span class="kt">int</span><span class="w">             </span><span class="n">used_sems</span><span class="p">;</span><span class="w">      </span><span class="c1">// å·²ä½¿ç”¨çš„ä¿¡å·é‡æ•°</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">    </span><span class="n">msg_ctlmax</span><span class="p">;</span><span class="w">     </span><span class="c1">// æ¶ˆæ¯æœ€å¤§å­—èŠ‚æ•°</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">    </span><span class="n">msg_ctlmnb</span><span class="p">;</span><span class="w">     </span><span class="c1">// é˜Ÿåˆ—æœ€å¤§å­—èŠ‚æ•°</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">    </span><span class="n">msg_ctlmni</span><span class="p">;</span><span class="w">     </span><span class="c1">// æœ€å¤§é˜Ÿåˆ—æ•°</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w">        </span><span class="n">msg_bytes</span><span class="p">;</span><span class="w">      </span><span class="c1">// å½“å‰æ¶ˆæ¯å­—èŠ‚æ€»æ•°</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w">        </span><span class="n">msg_hdrs</span><span class="p">;</span><span class="w">       </span><span class="c1">// å½“å‰æ¶ˆæ¯å¤´æ€»æ•°</span>

<span class="w">    </span><span class="kt">size_t</span><span class="w">          </span><span class="n">shm_ctlmax</span><span class="p">;</span><span class="w">     </span><span class="c1">// å…±äº«å†…å­˜æ®µæœ€å¤§å¤§å°</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w">          </span><span class="n">shm_ctlall</span><span class="p">;</span><span class="w">     </span><span class="c1">// å…±äº«å†…å­˜æ€»å¤§å°é™åˆ¶</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">   </span><span class="n">shm_tot</span><span class="p">;</span><span class="w">        </span><span class="c1">// å½“å‰å…±äº«å†…å­˜é¡µæ•°</span>
<span class="w">    </span><span class="kt">int</span><span class="w">             </span><span class="n">shm_ctlmni</span><span class="p">;</span><span class="w">     </span><span class="c1">// æœ€å¤§å…±äº«å†…å­˜æ®µæ•°</span>
<span class="w">    </span><span class="kt">int</span><span class="w">             </span><span class="n">shm_rmid_forced</span><span class="p">;</span><span class="c1">// å¼ºåˆ¶åˆ é™¤æ ‡å¿—</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">notifier_block</span><span class="w"> </span><span class="n">ipcns_nb</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vfsmount</span><span class="w"> </span><span class="o">*</span><span class="n">mq_mnt</span><span class="p">;</span><span class="w">        </span><span class="c1">// POSIX æ¶ˆæ¯é˜Ÿåˆ—æŒ‚è½½ç‚¹</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">    </span><span class="n">mq_queues_count</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">    </span><span class="n">mq_queues_max</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">    </span><span class="n">mq_msg_max</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">    </span><span class="n">mq_msgsize_max</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">    </span><span class="n">mq_msg_default</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">    </span><span class="n">mq_msgsize_default</span><span class="p">;</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">user_namespace</span><span class="w"> </span><span class="o">*</span><span class="n">user_ns</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ucounts</span><span class="w">  </span><span class="o">*</span><span class="n">ucounts</span><span class="p">;</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">llist_node</span><span class="w"> </span><span class="n">async_free_work</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">work_struct</span><span class="w"> </span><span class="n">free_work</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">__randomize_layout</span><span class="p">;</span>
</code></pre></div>

<h4 id="message-queue">æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queueï¼‰</h4>
<p>æ¶ˆæ¯é˜Ÿåˆ—æä¾›äº†ä¸€ç§è¿›ç¨‹é—´ä¼ é€’æ ¼å¼åŒ–æ•°æ®çš„æœºåˆ¶ï¼Œæ¯ä¸ªæ¶ˆæ¯éƒ½æœ‰ç±»å‹æ ‡è¯†ï¼Œæ¥æ”¶è€…å¯ä»¥é€‰æ‹©æ€§åœ°æ¥æ”¶ç‰¹å®šç±»å‹çš„æ¶ˆæ¯ã€‚</p>
<p><strong>æ ¸å¿ƒæ•°æ®ç»“æ„</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ipc/msg.c</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">msg_queue</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kern_ipc_perm</span><span class="w"> </span><span class="n">q_perm</span><span class="p">;</span>
<span class="w">    </span><span class="n">time64_t</span><span class="w"> </span><span class="n">q_stime</span><span class="p">;</span><span class="w">           </span><span class="c1">// æœ€åå‘é€æ—¶é—´</span>
<span class="w">    </span><span class="n">time64_t</span><span class="w"> </span><span class="n">q_rtime</span><span class="p">;</span><span class="w">           </span><span class="c1">// æœ€åæ¥æ”¶æ—¶é—´</span>
<span class="w">    </span><span class="n">time64_t</span><span class="w"> </span><span class="n">q_ctime</span><span class="p">;</span><span class="w">           </span><span class="c1">// æœ€åä¿®æ”¹æ—¶é—´</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">q_cbytes</span><span class="p">;</span><span class="w">     </span><span class="c1">// é˜Ÿåˆ—ä¸­å½“å‰å­—èŠ‚æ•°</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">q_qnum</span><span class="p">;</span><span class="w">       </span><span class="c1">// é˜Ÿåˆ—ä¸­æ¶ˆæ¯æ•°</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">q_qbytes</span><span class="p">;</span><span class="w">     </span><span class="c1">// é˜Ÿåˆ—æœ€å¤§å­—èŠ‚æ•°</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pid</span><span class="w"> </span><span class="o">*</span><span class="n">q_lspid</span><span class="p">;</span><span class="w">        </span><span class="c1">// æœ€åå‘é€è€… PID</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pid</span><span class="w"> </span><span class="o">*</span><span class="n">q_lrpid</span><span class="p">;</span><span class="w">        </span><span class="c1">// æœ€åæ¥æ”¶è€… PID</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">q_messages</span><span class="p">;</span><span class="w">    </span><span class="c1">// æ¶ˆæ¯é“¾è¡¨</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">q_receivers</span><span class="p">;</span><span class="w">   </span><span class="c1">// æ¥æ”¶è€…ç­‰å¾…é˜Ÿåˆ—</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">q_senders</span><span class="p">;</span><span class="w">     </span><span class="c1">// å‘é€è€…ç­‰å¾…é˜Ÿåˆ—</span>
<span class="p">}</span><span class="w"> </span><span class="n">__randomize_layout</span><span class="p">;</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">msg_msg</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">m_list</span><span class="p">;</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">m_type</span><span class="p">;</span><span class="w">                </span><span class="c1">// æ¶ˆæ¯ç±»å‹</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">m_ts</span><span class="p">;</span><span class="w">                </span><span class="c1">// æ¶ˆæ¯å¤§å°</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">msg_msgseg</span><span class="w"> </span><span class="o">*</span><span class="n">next</span><span class="p">;</span><span class="w">    </span><span class="c1">// å¤§æ¶ˆæ¯çš„ä¸‹ä¸€æ®µ</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">security</span><span class="p">;</span><span class="w">             </span><span class="c1">// å®‰å…¨æ ‡ç­¾</span>
<span class="w">    </span><span class="c1">// æ¶ˆæ¯æ•°æ®ç´§éšå…¶å</span>
<span class="p">};</span>

<span class="c1">// å¤§æ¶ˆæ¯åˆ†æ®µç»“æ„</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">msg_msgseg</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">msg_msgseg</span><span class="w"> </span><span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// åˆ†æ®µæ•°æ®ç´§éšå…¶å</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>æ¶ˆæ¯å‘é€æµç¨‹</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ç®€åŒ–çš„ msgsnd å®ç°</span>
<span class="k">static</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">do_msgsnd</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">msqid</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">mtype</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">mtext</span><span class="p">,</span>
<span class="w">                     </span><span class="kt">size_t</span><span class="w"> </span><span class="n">msgsz</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">msgflg</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">msg_queue</span><span class="w"> </span><span class="o">*</span><span class="n">msq</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">msg_msg</span><span class="w"> </span><span class="o">*</span><span class="n">msg</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// åˆ†é…æ¶ˆæ¯ç»“æ„</span>
<span class="w">    </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load_msg</span><span class="p">(</span><span class="n">mtext</span><span class="p">,</span><span class="w"> </span><span class="n">msgsz</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>

<span class="w">    </span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">m_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mtype</span><span class="p">;</span>
<span class="w">    </span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">m_ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msgsz</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// æŸ¥æ‰¾æ¶ˆæ¯é˜Ÿåˆ—</span>
<span class="w">    </span><span class="n">msq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msq_obtain_object_check</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span><span class="w"> </span><span class="n">msqid</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">msq</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">msq</span><span class="p">);</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">out_free</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">ipc_lock_object</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// æ£€æŸ¥æƒé™</span>
<span class="w">    </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ipcperms</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">,</span><span class="w"> </span><span class="n">S_IWUGO</span><span class="p">))</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">out_unlock</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// æ£€æŸ¥é˜Ÿåˆ—ç©ºé—´</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">msgsz</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_cbytes</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_qbytes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">msgflg</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">IPC_NOWAIT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">out_unlock</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">// é˜»å¡ç­‰å¾…ç©ºé—´</span>
<span class="w">        </span><span class="c1">// ...</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// å°†æ¶ˆæ¯åŠ å…¥é˜Ÿåˆ—</span>
<span class="w">    </span><span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">m_list</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_messages</span><span class="p">);</span>
<span class="w">    </span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_cbytes</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">msgsz</span><span class="p">;</span>
<span class="w">    </span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_qnum</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="n">atomic_add</span><span class="p">(</span><span class="n">msgsz</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">msg_bytes</span><span class="p">);</span>
<span class="w">    </span><span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">msg_hdrs</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// å”¤é†’ç­‰å¾…çš„æ¥æ”¶è€…</span>
<span class="w">    </span><span class="n">ss_wakeup</span><span class="p">(</span><span class="n">msq</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">wake_q</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>

<span class="w">    </span><span class="n">ipc_unlock_object</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">);</span>
<span class="w">    </span><span class="n">wake_up_q</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wake_q</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>æ¶ˆæ¯é˜Ÿåˆ—çš„ $O(1)$ æŸ¥æ‰¾ä¼˜åŒ–</strong></p>
<p>Linux ä½¿ç”¨åŸºæ•°æ ‘ï¼ˆradix treeï¼‰å®ç° IPC ID åˆ°å¯¹è±¡çš„å¿«é€Ÿæ˜ å°„ï¼š</p>
<div class="codehilite"><pre><span></span><code>IPC ID ç»“æ„ï¼š
+--------+--------+--------+
| seq(16)| idx(15)| use(1) |
+--------+--------+--------+

åŸºæ•°æ ‘æŸ¥æ‰¾ï¼š
     root
    /    \
   /      \
node1    node2
  |        |
 obj1     obj2
</code></pre></div>

<h4 id="shared-memory">å…±äº«å†…å­˜ï¼ˆShared Memoryï¼‰</h4>
<p>å…±äº«å†…å­˜æ˜¯æœ€å¿«çš„ IPC æœºåˆ¶ï¼Œå› ä¸ºè¿›ç¨‹ç›´æ¥è®¿é—®åŒä¸€å—ç‰©ç†å†…å­˜ï¼Œé¿å…äº†æ•°æ®å¤åˆ¶ã€‚</p>
<p><strong>æ ¸å¿ƒå®ç°</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ipc/shm.c</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">shmid_kernel</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kern_ipc_perm</span><span class="w"> </span><span class="n">shm_perm</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">shm_file</span><span class="p">;</span><span class="w">      </span><span class="c1">// å…³è”çš„æ–‡ä»¶å¯¹è±¡</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">shm_nattch</span><span class="p">;</span><span class="w">    </span><span class="c1">// å½“å‰é™„åŠ æ•°</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">shm_segsz</span><span class="p">;</span><span class="w">     </span><span class="c1">// æ®µå¤§å°</span>
<span class="w">    </span><span class="n">time64_t</span><span class="w"> </span><span class="n">shm_atim</span><span class="p">;</span><span class="w">          </span><span class="c1">// æœ€åé™„åŠ æ—¶é—´</span>
<span class="w">    </span><span class="n">time64_t</span><span class="w"> </span><span class="n">shm_dtim</span><span class="p">;</span><span class="w">          </span><span class="c1">// æœ€ååˆ†ç¦»æ—¶é—´</span>
<span class="w">    </span><span class="n">time64_t</span><span class="w"> </span><span class="n">shm_ctim</span><span class="p">;</span><span class="w">          </span><span class="c1">// æœ€åä¿®æ”¹æ—¶é—´</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pid</span><span class="w"> </span><span class="o">*</span><span class="n">shm_cprid</span><span class="p">;</span><span class="w">       </span><span class="c1">// åˆ›å»ºè€… PID</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pid</span><span class="w"> </span><span class="o">*</span><span class="n">shm_lprid</span><span class="p">;</span><span class="w">       </span><span class="c1">// æœ€åæ“ä½œè€… PID</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ucounts</span><span class="w"> </span><span class="o">*</span><span class="n">mlock_ucounts</span><span class="p">;</span><span class="w">  </span><span class="c1">// mlock è®¡æ•°</span>

<span class="w">    </span><span class="c1">// ä»»åŠ¡åˆ—è¡¨ï¼Œç”¨äº task-&gt;sysvshm.shm_clist</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">shm_clist</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ipc_namespace</span><span class="w"> </span><span class="o">*</span><span class="n">ns</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">__randomize_layout</span><span class="p">;</span>
</code></pre></div>

<p><strong>å…±äº«å†…å­˜æ˜ å°„è¿‡ç¨‹</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// shmat ç³»ç»Ÿè°ƒç”¨çš„æ ¸å¿ƒé€»è¾‘</span>
<span class="kt">long</span><span class="w"> </span><span class="nf">do_shmat</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">shmid</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">shmaddr</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">shmflg</span><span class="p">,</span>
<span class="w">             </span><span class="n">ulong</span><span class="w"> </span><span class="o">*</span><span class="n">raddr</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">shmlba</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">shmid_kernel</span><span class="w"> </span><span class="o">*</span><span class="n">shp</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">shmaddr</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">base</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w">    </span><span class="n">err</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAP_SHARED</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">prot</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">acc_mode</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ipc_namespace</span><span class="w"> </span><span class="o">*</span><span class="n">ns</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">shm_file_data</span><span class="w"> </span><span class="o">*</span><span class="n">sfd</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">f_flags</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">populate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// è·å–å…±äº«å†…å­˜å¯¹è±¡</span>
<span class="w">    </span><span class="n">shp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shm_obtain_object_check</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span><span class="w"> </span><span class="n">shmid</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">shp</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">shp</span><span class="p">);</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// æƒé™æ£€æŸ¥</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ipcperms</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">shp</span><span class="o">-&gt;</span><span class="n">shm_perm</span><span class="p">,</span><span class="w"> </span><span class="n">acc_mode</span><span class="p">))</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">out_unlock</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// è·å–å…³è”çš„æ–‡ä»¶</span>
<span class="w">    </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_file</span><span class="p">(</span><span class="n">shp</span><span class="o">-&gt;</span><span class="n">shm_file</span><span class="p">);</span>
<span class="w">    </span><span class="n">shp</span><span class="o">-&gt;</span><span class="n">shm_nattch</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i_size_read</span><span class="p">(</span><span class="n">file_inode</span><span class="p">(</span><span class="n">base</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// åˆ›å»º shm_file_data ç»“æ„</span>
<span class="w">    </span><span class="n">sfd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sfd</span><span class="p">),</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">sfd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">out_put</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_file_clone</span><span class="p">(</span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">f_flags</span><span class="p">,</span>
<span class="w">                           </span><span class="n">is_file_hugepages</span><span class="p">(</span><span class="n">base</span><span class="p">)</span><span class="w"> </span><span class="o">?</span>
<span class="w">                           </span><span class="o">&amp;</span><span class="n">shm_file_operations_huge</span><span class="w"> </span><span class="o">:</span>
<span class="w">                           </span><span class="o">&amp;</span><span class="n">shm_file_operations</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ä½¿ç”¨ do_mmap æ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´</span>
<span class="w">    </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">do_mmap</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">prot</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                  </span><span class="o">&amp;</span><span class="n">populate</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="o">*</span><span class="n">raddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span>
<span class="w">    </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">populate</span><span class="p">)</span>
<span class="w">        </span><span class="n">mm_populate</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">populate</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="semaphore">ä¿¡å·é‡ï¼ˆSemaphoreï¼‰</h4>
<p>System V ä¿¡å·é‡æ”¯æŒä¿¡å·é‡é›†åˆå’ŒåŸå­æ“ä½œåºåˆ—ï¼Œæ¯” POSIX ä¿¡å·é‡åŠŸèƒ½æ›´å¼ºå¤§ä½†ä¹Ÿæ›´å¤æ‚ã€‚</p>
<p><strong>ä¿¡å·é‡æ•°æ®ç»“æ„</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ipc/sem.c</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">sem_array</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kern_ipc_perm</span><span class="w"> </span><span class="n">sem_perm</span><span class="p">;</span><span class="w">  </span><span class="c1">// IPC æƒé™</span>
<span class="w">    </span><span class="n">time64_t</span><span class="w">         </span><span class="n">sem_ctime</span><span class="p">;</span><span class="w">     </span><span class="c1">// æœ€åä¿®æ”¹æ—¶é—´</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">pending_alter</span><span class="p">;</span><span class="w">  </span><span class="c1">// å¾…å¤„ç†çš„ä¿®æ”¹æ“ä½œ</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">pending_const</span><span class="p">;</span><span class="w">  </span><span class="c1">// å¾…å¤„ç†çš„å¸¸é‡æ“ä½œ</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">list_id</span><span class="p">;</span><span class="w">       </span><span class="c1">// undo åˆ—è¡¨</span>
<span class="w">    </span><span class="kt">int</span><span class="w">              </span><span class="n">sem_nsems</span><span class="p">;</span><span class="w">     </span><span class="c1">// ä¿¡å·é‡æ•°é‡</span>
<span class="w">    </span><span class="kt">int</span><span class="w">              </span><span class="n">complex_count</span><span class="p">;</span><span class="w"> </span><span class="c1">// å¤æ‚æ“ä½œè®¡æ•°</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">     </span><span class="n">use_global_lock</span><span class="p">;</span><span class="c1">// å…¨å±€é”æ ‡å¿—</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sem</span><span class="w">       </span><span class="n">sems</span><span class="p">[];</span><span class="w">        </span><span class="c1">// ä¿¡å·é‡æ•°ç»„</span>
<span class="p">}</span><span class="w"> </span><span class="n">__randomize_layout</span><span class="p">;</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">sem</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">semval</span><span class="p">;</span><span class="w">                     </span><span class="c1">// å½“å‰å€¼</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pid</span><span class="w"> </span><span class="o">*</span><span class="n">sempid</span><span class="p">;</span><span class="w">             </span><span class="c1">// æœ€åæ“ä½œçš„ PID</span>
<span class="w">    </span><span class="n">spinlock_t</span><span class="w"> </span><span class="n">lock</span><span class="p">;</span><span class="w">                </span><span class="c1">// æ¯ä¸ªä¿¡å·é‡çš„é”</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">pending_alter</span><span class="p">;</span><span class="w"> </span><span class="c1">// ç­‰å¾…å€¼æ”¹å˜çš„æ“ä½œ</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">pending_const</span><span class="p">;</span><span class="w"> </span><span class="c1">// ç­‰å¾…å€¼ä¸å˜çš„æ“ä½œ</span>
<span class="w">    </span><span class="n">time64_t</span><span class="w"> </span><span class="n">sem_otime</span><span class="p">;</span><span class="w">             </span><span class="c1">// æœ€åæ“ä½œæ—¶é—´</span>
<span class="p">}</span><span class="w"> </span><span class="n">____cacheline_aligned_in_smp</span><span class="p">;</span>
</code></pre></div>

<p><strong>ä¿¡å·é‡æ“ä½œçš„åŸå­æ€§ä¿è¯</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// semop ç³»ç»Ÿè°ƒç”¨å¤„ç†å¤šä¸ªä¿¡å·é‡æ“ä½œ</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">perform_atomic_semop</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sem_array</span><span class="w"> </span><span class="o">*</span><span class="n">sma</span><span class="p">,</span>
<span class="w">                               </span><span class="k">struct</span><span class="w"> </span><span class="nc">sem_queue</span><span class="w"> </span><span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sembuf</span><span class="w"> </span><span class="o">*</span><span class="n">sop</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sem</span><span class="w"> </span><span class="o">*</span><span class="n">curr</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nsops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">q</span><span class="o">-&gt;</span><span class="n">nsops</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">semval</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// ç¬¬ä¸€éï¼šæ£€æŸ¥æ‰€æœ‰æ“ä½œæ˜¯å¦å¯ä»¥æ‰§è¡Œ</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nsops</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">sop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">sops</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">        </span><span class="n">curr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sma</span><span class="o">-&gt;</span><span class="n">sems</span><span class="p">[</span><span class="n">sop</span><span class="o">-&gt;</span><span class="n">sem_num</span><span class="p">];</span>
<span class="w">        </span><span class="n">semval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">semval</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sop</span><span class="o">-&gt;</span><span class="n">sem_op</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">semval</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// æ“ä½œä¼šå¯¼è‡´ä¿¡å·é‡å€¼ä¸ºè´Ÿï¼Œä¸èƒ½æ‰§è¡Œ</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">  </span><span class="c1">// éœ€è¦ç­‰å¾…</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// ç¬¬äºŒéï¼šæ‰§è¡Œæ‰€æœ‰æ“ä½œ</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nsops</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">sop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">sops</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">        </span><span class="n">curr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sma</span><span class="o">-&gt;</span><span class="n">sems</span><span class="p">[</span><span class="n">sop</span><span class="o">-&gt;</span><span class="n">sem_num</span><span class="p">];</span>

<span class="w">        </span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">semval</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">sop</span><span class="o">-&gt;</span><span class="n">sem_op</span><span class="p">;</span>
<span class="w">        </span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">sempid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">q</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="c1">// æˆåŠŸæ‰§è¡Œ</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="413-posix-ipc">4.1.3 POSIX IPC</h3>
<p>POSIX IPC æ˜¯ IEEE 1003.1b-1993 æ ‡å‡†å®šä¹‰çš„è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ï¼Œæ—¨åœ¨æä¾›æ¯” System V IPC æ›´æ¸…æ´ã€æ›´ä¸€è‡´çš„æ¥å£ã€‚POSIX IPC çš„è®¾è®¡å……åˆ†å¸å–äº† System V IPC çš„ç»éªŒæ•™è®­ï¼Œæä¾›äº†åŸºäºæ–‡ä»¶æè¿°ç¬¦çš„æ“ä½œæ¨¡å‹ï¼Œæ›´å¥½åœ°é›†æˆåˆ° Unix çš„ "ä¸€åˆ‡çš†æ–‡ä»¶" å“²å­¦ä¸­ã€‚</p>
<h4 id="posix">POSIX æ¶ˆæ¯é˜Ÿåˆ—</h4>
<p>POSIX æ¶ˆæ¯é˜Ÿåˆ—å…‹æœäº† System V æ¶ˆæ¯é˜Ÿåˆ—çš„è¯¸å¤šé™åˆ¶ï¼Œæä¾›äº†æ¶ˆæ¯ä¼˜å…ˆçº§ã€å¼‚æ­¥é€šçŸ¥ç­‰é«˜çº§ç‰¹æ€§ã€‚</p>
<p><strong>æ ¸å¿ƒæ•°æ®ç»“æ„</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ipc/mqueue.c</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">mqueue_inode_info</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">spinlock_t</span><span class="w"> </span><span class="n">lock</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="n">vfs_inode</span><span class="p">;</span><span class="w">     </span><span class="c1">// VFS inode</span>
<span class="w">    </span><span class="n">wait_queue_head_t</span><span class="w"> </span><span class="n">wait_q</span><span class="p">;</span><span class="w">   </span><span class="c1">// ç­‰å¾…é˜Ÿåˆ—</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rb_root</span><span class="w"> </span><span class="n">msg_tree</span><span class="p">;</span><span class="w">    </span><span class="c1">// æ¶ˆæ¯çº¢é»‘æ ‘ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rb_node</span><span class="w"> </span><span class="o">*</span><span class="n">msg_tree_rightmost</span><span class="p">;</span><span class="w">  </span><span class="c1">// æœ€å³èŠ‚ç‚¹ç¼“å­˜</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">posix_msg_tree_node</span><span class="w"> </span><span class="o">*</span><span class="n">node_cache</span><span class="p">;</span><span class="w">  </span><span class="c1">// èŠ‚ç‚¹ç¼“å­˜</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mq_attr</span><span class="w"> </span><span class="n">attr</span><span class="p">;</span><span class="w">        </span><span class="c1">// é˜Ÿåˆ—å±æ€§</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sigevent</span><span class="w"> </span><span class="n">notify</span><span class="p">;</span><span class="w">     </span><span class="c1">// å¼‚æ­¥é€šçŸ¥é…ç½®</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pid</span><span class="w"> </span><span class="o">*</span><span class="n">notify_owner</span><span class="p">;</span><span class="w">   </span><span class="c1">// é€šçŸ¥æ¥æ”¶è¿›ç¨‹</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">user_namespace</span><span class="w"> </span><span class="o">*</span><span class="n">notify_user_ns</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ucounts</span><span class="w"> </span><span class="o">*</span><span class="n">ucounts</span><span class="p">;</span><span class="w">    </span><span class="c1">// ç”¨æˆ·è®¡æ•°</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">qsize</span><span class="p">;</span><span class="w">        </span><span class="c1">// é˜Ÿåˆ—å½“å‰å¤§å°ï¼ˆå­—èŠ‚ï¼‰</span>
<span class="p">};</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">mq_attr</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">mq_flags</span><span class="p">;</span><span class="w">      </span><span class="c1">// é˜Ÿåˆ—æ ‡å¿—ï¼ˆO_NONBLOCKï¼‰</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">mq_maxmsg</span><span class="p">;</span><span class="w">     </span><span class="c1">// æœ€å¤§æ¶ˆæ¯æ•°</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">mq_msgsize</span><span class="p">;</span><span class="w">    </span><span class="c1">// æœ€å¤§æ¶ˆæ¯å¤§å°</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">mq_curmsgs</span><span class="p">;</span><span class="w">    </span><span class="c1">// å½“å‰æ¶ˆæ¯æ•°</span>
<span class="p">};</span>

<span class="c1">// æ¶ˆæ¯èŠ‚ç‚¹ç»“æ„</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">msg_msg</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rb_node</span><span class="w"> </span><span class="n">m_rb_node</span><span class="p">;</span><span class="w">   </span><span class="c1">// çº¢é»‘æ ‘èŠ‚ç‚¹</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">m_list</span><span class="p">;</span><span class="w">    </span><span class="c1">// åŒä¼˜å…ˆçº§æ¶ˆæ¯é“¾è¡¨</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">m_type</span><span class="p">;</span><span class="w">                </span><span class="c1">// æ¶ˆæ¯ä¼˜å…ˆçº§</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">m_ts</span><span class="p">;</span><span class="w">                </span><span class="c1">// æ¶ˆæ¯å¤§å°</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">msg_msgseg</span><span class="w"> </span><span class="o">*</span><span class="n">next</span><span class="p">;</span><span class="w">    </span><span class="c1">// å¤§æ¶ˆæ¯çš„ä¸‹ä¸€æ®µ</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">security</span><span class="p">;</span><span class="w">             </span><span class="c1">// å®‰å…¨æ ‡ç­¾</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>ä¼˜å…ˆçº§é˜Ÿåˆ—å®ç°</strong></p>
<p>POSIX æ¶ˆæ¯é˜Ÿåˆ—ä½¿ç”¨çº¢é»‘æ ‘å®ç° $O(\log n)$ çš„ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// æ¶ˆæ¯æ’å…¥ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">msg_insert</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">msg_msg</span><span class="w"> </span><span class="o">*</span><span class="n">msg</span><span class="p">,</span>
<span class="w">                     </span><span class="k">struct</span><span class="w"> </span><span class="nc">mqueue_inode_info</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rb_node</span><span class="w"> </span><span class="o">**</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">posix_msg_tree_node</span><span class="w"> </span><span class="o">*</span><span class="n">leaf</span><span class="p">;</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">m_type</span><span class="p">;</span><span class="w">  </span><span class="c1">// ä¼˜å…ˆçº§ä½œä¸ºé”®</span>

<span class="w">    </span><span class="c1">// æŸ¥æ‰¾æ’å…¥ä½ç½®</span>
<span class="w">    </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">msg_tree</span><span class="p">.</span><span class="n">rb_node</span><span class="p">;</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>
<span class="w">        </span><span class="n">leaf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rb_entry</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">posix_msg_tree_node</span><span class="p">,</span><span class="w"> </span><span class="n">rb_node</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">leaf</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">leaf</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// ç›¸åŒä¼˜å…ˆçº§ï¼ŒåŠ å…¥é“¾è¡¨å°¾éƒ¨ï¼ˆFIFOï¼‰</span>
<span class="w">            </span><span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">m_list</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">leaf</span><span class="o">-&gt;</span><span class="n">msg_list</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// åˆ›å»ºæ–°çš„ä¼˜å…ˆçº§èŠ‚ç‚¹</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">node_cache</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">leaf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">node_cache</span><span class="p">;</span>
<span class="w">        </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">node_cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">leaf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">leaf</span><span class="p">),</span><span class="w"> </span><span class="n">GFP_ATOMIC</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">leaf</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">leaf</span><span class="o">-&gt;</span><span class="n">msg_list</span><span class="p">);</span>
<span class="w">    </span><span class="n">leaf</span><span class="o">-&gt;</span><span class="n">priority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k</span><span class="p">;</span>
<span class="w">    </span><span class="n">rb_link_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">leaf</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">,</span><span class="w"> </span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">rb_insert_color</span><span class="p">(</span><span class="o">&amp;</span><span class="n">leaf</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">msg_tree</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// æ›´æ–°æœ€å³èŠ‚ç‚¹ç¼“å­˜ï¼ˆæœ€ä½ä¼˜å…ˆçº§ï¼‰</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">parent</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">msg_tree_rightmost</span><span class="p">)</span>
<span class="w">        </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">msg_tree_rightmost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">leaf</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">;</span>

<span class="w">    </span><span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">m_list</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">leaf</span><span class="o">-&gt;</span><span class="n">msg_list</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>å¼‚æ­¥é€šçŸ¥æœºåˆ¶</strong></p>
<p>POSIX æ¶ˆæ¯é˜Ÿåˆ—æ”¯æŒä¸‰ç§é€šçŸ¥æ–¹å¼ï¼š</p>
<ol>
<li><strong>ä¿¡å·é€šçŸ¥</strong>ï¼šå‘æŒ‡å®šè¿›ç¨‹å‘é€ä¿¡å·</li>
<li><strong>çº¿ç¨‹é€šçŸ¥</strong>ï¼šåˆ›å»ºæ–°çº¿ç¨‹æ‰§è¡Œé€šçŸ¥å‡½æ•°</li>
<li><strong>ä¿¡å·å€¼é€šçŸ¥</strong>ï¼šå‘é€å¸¦å€¼çš„å®æ—¶ä¿¡å·</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// mq_notify å®ç°</span>
<span class="n">SYSCALL_DEFINE2</span><span class="p">(</span><span class="n">mq_notify</span><span class="p">,</span><span class="w"> </span><span class="n">mqd_t</span><span class="p">,</span><span class="w"> </span><span class="n">mqdes</span><span class="p">,</span>
<span class="w">               </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sigevent</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">u_notification</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">fd</span><span class="w"> </span><span class="n">f</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mqueue_inode_info</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sigevent</span><span class="w"> </span><span class="n">notification</span><span class="p">;</span>

<span class="w">    </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fdget</span><span class="p">(</span><span class="n">mqdes</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">f</span><span class="p">.</span><span class="n">file</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>

<span class="w">    </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MQUEUE_I</span><span class="p">(</span><span class="n">file_inode</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">file</span><span class="p">));</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">u_notification</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">notification</span><span class="p">,</span><span class="w"> </span><span class="n">u_notification</span><span class="p">,</span>
<span class="w">                          </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sigevent</span><span class="p">)))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">notification</span><span class="p">.</span><span class="n">sigev_notify</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">SIGEV_NONE</span><span class="p">:</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">SIGEV_SIGNAL</span><span class="p">:</span>
<span class="w">            </span><span class="c1">// è®¾ç½®ä¿¡å·é€šçŸ¥</span>
<span class="w">            </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">notify</span><span class="p">.</span><span class="n">sigev_signo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">notification</span><span class="p">.</span><span class="n">sigev_signo</span><span class="p">;</span>
<span class="w">            </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">notify</span><span class="p">.</span><span class="n">sigev_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">notification</span><span class="p">.</span><span class="n">sigev_value</span><span class="p">;</span>
<span class="w">            </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">notify_owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_pid</span><span class="p">(</span><span class="n">task_pid</span><span class="p">(</span><span class="n">current</span><span class="p">));</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">SIGEV_THREAD</span><span class="p">:</span>
<span class="w">            </span><span class="c1">// çº¿ç¨‹é€šçŸ¥éœ€è¦ç”¨æˆ·ç©ºé—´åº“æ”¯æŒ</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// å–æ¶ˆé€šçŸ¥</span>
<span class="w">        </span><span class="n">put_pid</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">notify_owner</span><span class="p">);</span>
<span class="w">        </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">notify_owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">fdput</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="posix_1">POSIX å…±äº«å†…å­˜</h4>
<p>POSIX å…±äº«å†…å­˜é€šè¿‡ tmpfs æ–‡ä»¶ç³»ç»Ÿå®ç°ï¼Œæä¾›äº†æ›´çµæ´»çš„å†…å­˜æ˜ å°„æœºåˆ¶ã€‚</p>
<p><strong>å®ç°æ¶æ„</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// POSIX å…±äº«å†…å­˜åŸºäº tmpfs</span>
<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_system_type</span><span class="w"> </span><span class="n">shmem_fs_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">owner</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">name</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;tmpfs&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">init_fs_context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shmem_init_fs_context</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">kill_sb</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">kill_litter_super</span><span class="p">,</span>
<span class="p">};</span>

<span class="c1">// shm_open å®é™…ä¸Šæ˜¯åœ¨ /dev/shm ä¸‹åˆ›å»ºæ–‡ä»¶</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">shm_open</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">oflag</span><span class="p">,</span><span class="w"> </span><span class="kt">mode_t</span><span class="w"> </span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">pathname</span><span class="p">[</span><span class="n">PATH_MAX</span><span class="p">];</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// æ„é€ è·¯å¾„ /dev/shm/name</span>
<span class="w">    </span><span class="n">snprintf</span><span class="p">(</span><span class="n">pathname</span><span class="p">,</span><span class="w"> </span><span class="n">PATH_MAX</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/dev/shm/%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ä½¿ç”¨ open ç³»ç»Ÿè°ƒç”¨</span>
<span class="w">    </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="n">pathname</span><span class="p">,</span><span class="w"> </span><span class="n">oflag</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">fd</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>ä¸ System V å…±äº«å†…å­˜çš„å¯¹æ¯”</strong></p>
<p>| ç‰¹æ€§ | System V | POSIX |</p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>System V</th>
<th>POSIX</th>
</tr>
</thead>
<tbody>
<tr>
<td>å‘½åç©ºé—´</td>
<td>IPC é”®å€¼</td>
<td>æ–‡ä»¶ç³»ç»Ÿè·¯å¾„</td>
</tr>
<tr>
<td>æŒä¹…æ€§</td>
<td>ç›´åˆ°æ˜¾å¼åˆ é™¤</td>
<td>å¯é€‰æŒä¹…åŒ–</td>
</tr>
<tr>
<td>å¤§å°è°ƒæ•´</td>
<td>åˆ›å»ºæ—¶å›ºå®š</td>
<td>ftruncate åŠ¨æ€è°ƒæ•´</td>
</tr>
<tr>
<td>æƒé™ç®¡ç†</td>
<td>IPC æƒé™ä½</td>
<td>æ–‡ä»¶ç³»ç»Ÿæƒé™</td>
</tr>
<tr>
<td>åŒæ­¥æœºåˆ¶</td>
<td>éœ€è¦ä¿¡å·é‡</td>
<td>å¯ç”¨æ–‡ä»¶é”</td>
</tr>
</tbody>
</table>
<p><strong>å†…å­˜æ˜ å°„ä¼˜åŒ–</strong></p>
<p>POSIX å…±äº«å†…å­˜æ”¯æŒå¤§é¡µï¼ˆHuge Pagesï¼‰æ˜ å°„ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä½¿ç”¨å¤§é¡µçš„å…±äº«å†…å­˜</span>
<span class="kt">int</span><span class="w"> </span><span class="n">shm_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shm_open</span><span class="p">(</span><span class="s">&quot;/hugepage_shm&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">O_CREAT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">O_RDWR</span><span class="p">,</span><span class="w"> </span><span class="mo">0666</span><span class="p">);</span>

<span class="c1">// è®¾ç½®å¤§é¡µæ ‡å¿—</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">statfs</span><span class="w"> </span><span class="n">fs_stats</span><span class="p">;</span>
<span class="n">fstatfs</span><span class="p">(</span><span class="n">shm_fd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fs_stats</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fs_stats</span><span class="p">.</span><span class="n">f_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">HUGETLBFS_MAGIC</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// è‡ªåŠ¨ä½¿ç”¨å¤§é¡µ</span>
<span class="p">}</span>

<span class="c1">// æ˜ å°„æ—¶æŒ‡å®š MAP_HUGETLB</span>
<span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">PROT_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PROT_WRITE</span><span class="p">,</span>
<span class="w">                 </span><span class="n">MAP_SHARED</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MAP_HUGETLB</span><span class="p">,</span><span class="w"> </span><span class="n">shm_fd</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</code></pre></div>

<h4 id="posix_2">POSIX ä¿¡å·é‡</h4>
<p>POSIX ä¿¡å·é‡æä¾›äº†ä¸¤ç§ç±»å‹ï¼šå‘½åä¿¡å·é‡å’Œæœªå‘½åä¿¡å·é‡ï¼Œç›¸æ¯” System V ä¿¡å·é‡æ›´åŠ ç®€æ´ã€‚</p>
<p><strong>ä¿¡å·é‡å®ç°</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// kernel/locking/semaphore.c</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">semaphore</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">raw_spinlock_t</span><span class="w">      </span><span class="n">lock</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">        </span><span class="n">count</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w">    </span><span class="n">wait_list</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// POSIX ä¿¡å·é‡çš„ç”¨æˆ·ç©ºé—´è¡¨ç¤º</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">__size</span><span class="p">[</span><span class="n">__SIZEOF_SEM_T</span><span class="p">];</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__align</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">sem_t</span><span class="p">;</span>

<span class="c1">// å†…æ ¸ä¸­çš„ POSIX ä¿¡å·é‡æ“ä½œ</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">posix_sem_ops</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">wait</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">semaphore</span><span class="w"> </span><span class="o">*</span><span class="n">sem</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">timedwait</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">semaphore</span><span class="w"> </span><span class="o">*</span><span class="n">sem</span><span class="p">,</span><span class="w"> </span>
<span class="w">                    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w"> </span><span class="o">*</span><span class="n">abs_timeout</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">trywait</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">semaphore</span><span class="w"> </span><span class="o">*</span><span class="n">sem</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">post</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">semaphore</span><span class="w"> </span><span class="o">*</span><span class="n">sem</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">getvalue</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">semaphore</span><span class="w"> </span><span class="o">*</span><span class="n">sem</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">sval</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>æœªå‘½åä¿¡å·é‡çš„å…±äº«å†…å­˜å®ç°</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// è¿›ç¨‹é—´å…±äº«çš„æœªå‘½åä¿¡å·é‡</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">shared_sem</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">semaphore</span><span class="w"> </span><span class="n">sem</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pshared</span><span class="p">;</span><span class="w">            </span><span class="c1">// PTHREAD_PROCESS_SHARED</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">refcount</span><span class="p">;</span><span class="w">      </span><span class="c1">// å¼•ç”¨è®¡æ•°</span>
<span class="p">};</span>

<span class="c1">// sem_init å®ç°</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">sem_init</span><span class="p">(</span><span class="n">sem_t</span><span class="w"> </span><span class="o">*</span><span class="n">sem</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pshared</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">shared_sem</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pshared</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PTHREAD_PROCESS_SHARED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// åˆ†é…å…±äº«å†…å­˜æ®µ</span>
<span class="w">        </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">),</span><span class="w"> </span><span class="n">PROT_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PROT_WRITE</span><span class="p">,</span>
<span class="w">                </span><span class="n">MAP_SHARED</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MAP_ANONYMOUS</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MAP_FAILED</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// è¿›ç¨‹ç§æœ‰ä¿¡å·é‡</span>
<span class="w">        </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<span class="w">    </span><span class="n">s</span><span class="o">-&gt;</span><span class="n">pshared</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pshared</span><span class="p">;</span>
<span class="w">    </span><span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">    </span><span class="o">*</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">shared_sem</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="n">sem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>è‡ªé€‚åº”ç­‰å¾…ä¼˜åŒ–</strong></p>
<p>POSIX ä¿¡å·é‡å®ç°äº†è‡ªé€‚åº”ç­‰å¾…ç­–ç•¥ï¼Œåœ¨è½»åº¦ç«äº‰æ—¶è‡ªæ—‹ï¼Œé‡åº¦ç«äº‰æ—¶ç¡çœ ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// è‡ªé€‚åº”ç­‰å¾…å®ç°</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">adaptive_sem_wait</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">semaphore</span><span class="w"> </span><span class="o">*</span><span class="n">sem</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">spin_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">MAX_SPINS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// å¿«é€Ÿè·¯å¾„ï¼šå°è¯•è·å–</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">raw_spin_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sem</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sem</span><span class="o">-&gt;</span><span class="n">count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">sem</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>
<span class="w">            </span><span class="n">raw_spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sem</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">raw_spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sem</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// è‡ªé€‚åº”è‡ªæ—‹</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">spin_count</span><span class="o">++</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAX_SPINS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sem</span><span class="o">-&gt;</span><span class="n">count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">raw_spin_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sem</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sem</span><span class="o">-&gt;</span><span class="n">count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">sem</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>
<span class="w">                    </span><span class="n">raw_spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sem</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="n">raw_spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sem</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">cpu_relax</span><span class="p">();</span><span class="w">  </span><span class="c1">// å¤„ç†å™¨ç‰¹å®šçš„è‡ªæ—‹ç­‰å¾…</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// æ…¢é€Ÿè·¯å¾„ï¼šç¡çœ ç­‰å¾…</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">__sem_wait_slowpath</span><span class="p">(</span><span class="n">sem</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="system-v-ipc">ä¸ System V IPC å¯¹æ¯”</h4>
<p><strong>æ¶æ„å·®å¼‚</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nv">System</span><span class="w"> </span><span class="nv">V</span><span class="w"> </span><span class="nv">IPC</span><span class="w"> </span>æ¶æ„ï¼š
<span class="w">    </span>ç”¨æˆ·ç©ºé—´
<span class="w">        </span><span class="o">|</span>
<span class="w">    </span>ç³»ç»Ÿè°ƒç”¨æ¥å£<span class="w"> </span><span class="ss">(</span><span class="nv">msgget</span>,<span class="w"> </span><span class="nv">shmat</span>,<span class="w"> </span><span class="nv">semget</span><span class="ss">)</span>
<span class="w">        </span><span class="o">|</span>
<span class="w">    </span><span class="nv">IPC</span><span class="w"> </span>å‘½åç©ºé—´
<span class="w">        </span><span class="o">|</span>
<span class="w">    </span><span class="nv">IPC</span><span class="w"> </span>å¯¹è±¡ç®¡ç†å™¨
<span class="w">        </span><span class="o">|</span>
<span class="w">    </span>å†…æ ¸æ•°æ®ç»“æ„

<span class="nv">POSIX</span><span class="w"> </span><span class="nv">IPC</span><span class="w"> </span>æ¶æ„ï¼š
<span class="w">    </span>ç”¨æˆ·ç©ºé—´
<span class="w">        </span><span class="o">|</span>
<span class="w">    </span>æ–‡ä»¶ç³»ç»Ÿæ¥å£<span class="w"> </span><span class="ss">(</span><span class="nv">open</span>,<span class="w"> </span><span class="nv">mmap</span>,<span class="w"> </span><span class="k">unlink</span><span class="ss">)</span>
<span class="w">        </span><span class="o">|</span>
<span class="w">    </span><span class="nv">VFS</span><span class="w"> </span>å±‚
<span class="w">        </span><span class="o">|</span>
<span class="w">    </span>ç‰¹æ®Šæ–‡ä»¶ç³»ç»Ÿ<span class="w"> </span><span class="ss">(</span><span class="nv">mqueue</span>,<span class="w"> </span><span class="nv">tmpfs</span><span class="ss">)</span>
<span class="w">        </span><span class="o">|</span>
<span class="w">    </span>å†…æ ¸æ•°æ®ç»“æ„
</code></pre></div>

<p><strong>æ€§èƒ½å¯¹æ¯”</strong></p>
<p>| æ“ä½œ | System V | POSIX | æ€§èƒ½å·®å¼‚åŸå›  |</p>
<table>
<thead>
<tr>
<th>æ“ä½œ</th>
<th>System V</th>
<th>POSIX</th>
<th>æ€§èƒ½å·®å¼‚åŸå› </th>
</tr>
</thead>
<tbody>
<tr>
<td>åˆ›å»ºå¼€é”€</td>
<td>ä¸­ç­‰</td>
<td>è¾ƒä½</td>
<td>POSIX åˆ©ç”¨æ–‡ä»¶ç³»ç»Ÿç¼“å­˜</td>
</tr>
<tr>
<td>æŸ¥æ‰¾é€Ÿåº¦</td>
<td>O(1)</td>
<td>O(log n)</td>
<td>System V ä½¿ç”¨å“ˆå¸Œè¡¨</td>
</tr>
<tr>
<td>å†…å­˜å ç”¨</td>
<td>è¾ƒé«˜</td>
<td>è¾ƒä½</td>
<td>POSIX å…±äº« VFS ç»“æ„</td>
</tr>
<tr>
<td>å¹¶å‘æ€§èƒ½</td>
<td>ä¸€èˆ¬</td>
<td>è¾ƒå¥½</td>
<td>POSIX ç»†ç²’åº¦é”</td>
</tr>
<tr>
<td>æŒä¹…åŒ–</td>
<td>è‡ªåŠ¨</td>
<td>å¯é€‰</td>
<td>System V é»˜è®¤æŒä¹…</td>
</tr>
</tbody>
</table>
<p><strong>é€‰æ‹©å»ºè®®</strong></p>
<ol>
<li>
<p><strong>ä½¿ç”¨ POSIX IPC çš„åœºæ™¯</strong>ï¼š
   - æ–°å¼€å‘çš„åº”ç”¨ç¨‹åº
   - éœ€è¦ä¸æ–‡ä»¶ç³»ç»Ÿé›†æˆ
   - éœ€è¦ç²¾ç¡®çš„è¶…æ—¶æ§åˆ¶
   - è·¨å¹³å°å¯ç§»æ¤æ€§è¦æ±‚é«˜</p>
</li>
<li>
<p><strong>ä½¿ç”¨ System V IPC çš„åœºæ™¯</strong>ï¼š
   - ç»´æŠ¤é—ç•™ç³»ç»Ÿ
   - éœ€è¦ä¿¡å·é‡é›†åˆçš„åŸå­æ“ä½œ
   - éœ€è¦æ¶ˆæ¯ç±»å‹è¿‡æ»¤
   - å·²æœ‰å¤§é‡ System V IPC ä»£ç </p>
</li>
</ol>
<h2 id="43">4.3 ä¿¡å·æœºåˆ¶å®ç°</h2>
<p>ä¿¡å·æ˜¯ Unix ç³»ç»Ÿæœ€å¤è€çš„è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ä¹‹ä¸€ï¼Œä¹Ÿæ˜¯å¼‚æ­¥äº‹ä»¶é€šçŸ¥çš„æ ¸å¿ƒæœºåˆ¶ã€‚Linux å†…æ ¸ä¸ä»…å®Œæ•´å®ç°äº† POSIX.1 æ ‡å‡†ä¿¡å·ï¼Œè¿˜æ‰©å±•äº†å®æ—¶ä¿¡å·æ”¯æŒï¼Œæä¾›äº†æ›´ä¸°å¯Œçš„ä¿¡å·ä¿¡æ¯ä¼ é€’èƒ½åŠ›ã€‚ç†è§£ä¿¡å·æœºåˆ¶çš„å†…æ ¸å®ç°å¯¹äºç¼–å†™å¥å£®çš„ç³»ç»Ÿç¨‹åºè‡³å…³é‡è¦ã€‚</p>
<h3 id="431">4.3.1 ä¿¡å·åŸºç¡€æ¶æ„</h3>
<p>Linux ä¿¡å·æœºåˆ¶å»ºç«‹åœ¨ç²¾å·§çš„æ•°æ®ç»“æ„å’Œç®—æ³•ä¹‹ä¸Šï¼Œå®ç°äº†é«˜æ•ˆçš„ä¿¡å·äº§ç”Ÿã€æŠ•é€’å’Œå¤„ç†æµç¨‹ã€‚</p>
<h4 id="_4">ä¿¡å·çš„äº§ç”Ÿä¸æŠ•é€’</h4>
<p><strong>æ ¸å¿ƒæ•°æ®ç»“æ„</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// include/linux/sched/signal.h</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">signal_struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">refcount_t</span><span class="w">      </span><span class="n">sigcnt</span><span class="p">;</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w">        </span><span class="n">live</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w">             </span><span class="n">nr_threads</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">thread_head</span><span class="p">;</span>

<span class="w">    </span><span class="n">wait_queue_head_t</span><span class="w"> </span><span class="n">wait_chldexit</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// å½“å‰è¿›ç¨‹ç»„ä¿¡å·å¤„ç†å™¨</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">k_sigaction</span><span class="w"> </span><span class="n">action</span><span class="p">[</span><span class="n">_NSIG</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// å…±äº«çš„æŒ‚èµ·ä¿¡å·</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sigpending</span><span class="w"> </span><span class="n">shared_pending</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// POSIX å®šæ—¶å™¨åˆ—è¡¨</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">posix_timers</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// å®æ—¶å®šæ—¶å™¨</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hrtimer</span><span class="w"> </span><span class="n">real_timer</span><span class="p">;</span>
<span class="w">    </span><span class="n">ktime_t</span><span class="w"> </span><span class="n">real_timer_offset</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// CPU æ—¶é—´é™åˆ¶</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_cputime</span><span class="w"> </span><span class="n">cputime_expires</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">cpu_timers</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// è¿›ç¨‹ç»„ä¿¡æ¯</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pid</span><span class="w"> </span><span class="o">*</span><span class="n">pgrp</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pid</span><span class="w"> </span><span class="o">*</span><span class="n">tty_old_pgrp</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// ä¼šè¯é¢†å¯¼è€…</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">leader</span><span class="p">;</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">tty_struct</span><span class="w"> </span><span class="o">*</span><span class="n">tty</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// ç´¯ç§¯çš„èµ„æºä½¿ç”¨ç»Ÿè®¡</span>
<span class="w">    </span><span class="n">seqlock_t</span><span class="w"> </span><span class="n">stats_lock</span><span class="p">;</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">utime</span><span class="p">,</span><span class="w"> </span><span class="n">stime</span><span class="p">,</span><span class="w"> </span><span class="n">cutime</span><span class="p">,</span><span class="w"> </span><span class="n">cstime</span><span class="p">;</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">gtime</span><span class="p">,</span><span class="w"> </span><span class="n">cgtime</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">prev_cputime</span><span class="w"> </span><span class="n">prev_cputime</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">nvcsw</span><span class="p">,</span><span class="w"> </span><span class="n">nivcsw</span><span class="p">,</span><span class="w"> </span><span class="n">cnvcsw</span><span class="p">,</span><span class="w"> </span><span class="n">cnivcsw</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">min_flt</span><span class="p">,</span><span class="w"> </span><span class="n">maj_flt</span><span class="p">,</span><span class="w"> </span><span class="n">cmin_flt</span><span class="p">,</span><span class="w"> </span><span class="n">cmaj_flt</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">inblock</span><span class="p">,</span><span class="w"> </span><span class="n">oublock</span><span class="p">,</span><span class="w"> </span><span class="n">cinblock</span><span class="p">,</span><span class="w"> </span><span class="n">coublock</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">maxrss</span><span class="p">,</span><span class="w"> </span><span class="n">cmaxrss</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_io_accounting</span><span class="w"> </span><span class="n">ioac</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// å®¡è®¡ä¸Šä¸‹æ–‡</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">sum_sched_runtime</span><span class="p">;</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rlimit</span><span class="w"> </span><span class="n">rlim</span><span class="p">[</span><span class="n">RLIM_NLIMITS</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// è¿›ç¨‹ç»„æ˜¯å¦ä¸ºå­¤å„¿</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">is_child_subreaper</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">has_child_subreaper</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// æ¯ä¸ªçº¿ç¨‹çš„ä¿¡å·ä¿¡æ¯</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">sighand_struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">spinlock_t</span><span class="w">      </span><span class="n">siglock</span><span class="p">;</span>
<span class="w">    </span><span class="n">refcount_t</span><span class="w">      </span><span class="n">count</span><span class="p">;</span>
<span class="w">    </span><span class="n">wait_queue_head_t</span><span class="w"> </span><span class="n">signalfd_wqh</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">k_sigaction</span><span class="w"> </span><span class="n">action</span><span class="p">[</span><span class="n">_NSIG</span><span class="p">];</span><span class="w">  </span><span class="c1">// ä¿¡å·å¤„ç†å™¨æ•°ç»„</span>
<span class="p">};</span>

<span class="c1">// æŒ‚èµ·ä¿¡å·é˜Ÿåˆ—</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">sigpending</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">list</span><span class="p">;</span><span class="w">     </span><span class="c1">// ä¿¡å·é˜Ÿåˆ—é“¾è¡¨</span>
<span class="w">    </span><span class="kt">sigset_t</span><span class="w"> </span><span class="n">signal</span><span class="p">;</span><span class="w">           </span><span class="c1">// æŒ‚èµ·ä¿¡å·ä½å›¾</span>
<span class="p">};</span>

<span class="c1">// ä¿¡å·é˜Ÿåˆ—é¡¹</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">sigqueue</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">list</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span>
<span class="w">    </span><span class="n">kernel_siginfo_t</span><span class="w"> </span><span class="n">info</span><span class="p">;</span><span class="w">     </span><span class="c1">// ä¿¡å·ä¿¡æ¯</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ucounts</span><span class="w"> </span><span class="o">*</span><span class="n">ucounts</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>ä¿¡å·äº§ç”Ÿæµç¨‹</strong></p>
<p>ä¿¡å·å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼äº§ç”Ÿï¼š</p>
<ol>
<li><strong>ç¡¬ä»¶å¼‚å¸¸</strong>ï¼šå¦‚é™¤é›¶é”™è¯¯ã€æ®µé”™è¯¯</li>
<li><strong>è½¯ä»¶æ¡ä»¶</strong>ï¼šå¦‚ alarm å®šæ—¶å™¨åˆ°æœŸ</li>
<li><strong>ç»ˆç«¯è¾“å…¥</strong>ï¼šå¦‚ Ctrl+C äº§ç”Ÿ SIGINT</li>
<li><strong>ç³»ç»Ÿè°ƒç”¨</strong>ï¼šå¦‚ kill()ã€raise()</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// kernel/signal.c - kill ç³»ç»Ÿè°ƒç”¨å®ç°</span>
<span class="n">SYSCALL_DEFINE2</span><span class="p">(</span><span class="n">kill</span><span class="p">,</span><span class="w"> </span><span class="kt">pid_t</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">sig</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kernel_siginfo</span><span class="w"> </span><span class="n">info</span><span class="p">;</span>

<span class="w">    </span><span class="n">prepare_kill_siginfo</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">kill_something_info</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">kill_something_info</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">sig</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">kernel_siginfo</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="kt">pid_t</span><span class="w"> </span><span class="n">pid</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// å‘é€ç»™æŒ‡å®šè¿›ç¨‹</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kill_pid_info</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">find_vpid</span><span class="p">(</span><span class="n">pid</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// å‘é€ç»™è¿›ç¨‹ç»„</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kill_pgrp_info</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">task_pgrp</span><span class="p">(</span><span class="n">current</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// å‘é€ç»™æ‰€æœ‰è¿›ç¨‹ï¼ˆé™¤äº† initï¼‰</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kill_all_info</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// å‘é€ç»™æŒ‡å®šè¿›ç¨‹ç»„</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kill_pgrp_info</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">find_vpid</span><span class="p">(</span><span class="o">-</span><span class="n">pid</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>ä¿¡å·æŠ•é€’ç®—æ³•</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä¿¡å·æŠ•é€’çš„æ ¸å¿ƒå‡½æ•°</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">__send_signal</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">sig</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">kernel_siginfo</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="p">,</span>
<span class="w">                        </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">pid_type</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">force</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sigpending</span><span class="w"> </span><span class="o">*</span><span class="n">pending</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sigqueue</span><span class="w"> </span><span class="o">*</span><span class="n">q</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">override_rlimit</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// æ£€æŸ¥ä¿¡å·æ˜¯å¦è¢«å¿½ç•¥</span>
<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TRACE_SIGNAL_IGNORED</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">prepare_signal</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">force</span><span class="p">))</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// é€‰æ‹©æŒ‚èµ·ä¿¡å·é˜Ÿåˆ—ï¼ˆçº¿ç¨‹ç§æœ‰æˆ–è¿›ç¨‹å…±äº«ï¼‰</span>
<span class="w">    </span><span class="n">pending</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">PIDTYPE_PID</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">signal</span><span class="o">-&gt;</span><span class="n">shared_pending</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// æ£€æŸ¥æ˜¯å¦ä¸ºä¼ ç»Ÿä¿¡å·ä¸”å·²åœ¨é˜Ÿåˆ—ä¸­</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">legacy_queue</span><span class="p">(</span><span class="n">pending</span><span class="p">,</span><span class="w"> </span><span class="n">sig</span><span class="p">))</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// åˆ†é…ä¿¡å·é˜Ÿåˆ—é¡¹</span>
<span class="w">    </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__sigqueue_alloc</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_ATOMIC</span><span class="p">,</span><span class="w"> </span><span class="n">override_rlimit</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pending</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="n">info</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="no">unsigned</span><span class="w"> </span><span class="no">long</span><span class="p">)</span><span class="w"> </span><span class="no">SEND_SIG_NOINFO</span><span class="p">:</span>
<span class="w">            </span><span class="n">clear_siginfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">);</span>
<span class="w">            </span><span class="n">q</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">si_signo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sig</span><span class="p">;</span>
<span class="w">            </span><span class="n">q</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">si_errno</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="n">q</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">si_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SI_USER</span><span class="p">;</span>
<span class="w">            </span><span class="n">q</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">si_pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">task_tgid_nr_ns</span><span class="p">(</span><span class="n">current</span><span class="p">,</span>
<span class="w">                                            </span><span class="n">task_active_pid_ns</span><span class="p">(</span><span class="n">t</span><span class="p">));</span>
<span class="w">            </span><span class="n">q</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">si_uid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">from_kuid_munged</span><span class="p">(</span><span class="n">current_user_ns</span><span class="p">(),</span>
<span class="w">                                             </span><span class="n">current_uid</span><span class="p">());</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="no">unsigned</span><span class="w"> </span><span class="no">long</span><span class="p">)</span><span class="w"> </span><span class="no">SEND_SIG_PRIV</span><span class="p">:</span>
<span class="w">            </span><span class="n">clear_siginfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">);</span>
<span class="w">            </span><span class="n">q</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">si_signo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sig</span><span class="p">;</span>
<span class="w">            </span><span class="n">q</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">si_errno</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="n">q</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">si_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SI_KERNEL</span><span class="p">;</span>
<span class="w">            </span><span class="n">q</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">si_pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="n">q</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">si_uid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span>
<span class="w">            </span><span class="n">copy_siginfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">is_si_special</span><span class="p">(</span><span class="n">info</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">               </span><span class="n">sig</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">SIGRTMIN</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">info</span><span class="o">-&gt;</span><span class="n">si_code</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">SI_USER</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// å®æ—¶ä¿¡å·å¿…é¡»æ’é˜Ÿï¼Œå¦‚æœå†…å­˜ä¸è¶³åˆ™å¤±è´¥</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// è®¾ç½®ä¿¡å·ä½å›¾</span>
<span class="w">    </span><span class="n">sigaddset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pending</span><span class="o">-&gt;</span><span class="n">signal</span><span class="p">,</span><span class="w"> </span><span class="n">sig</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// å”¤é†’ç›®æ ‡è¿›ç¨‹</span>
<span class="w">    </span><span class="n">complete_signal</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">);</span>

<span class="nl">ret</span><span class="p">:</span>
<span class="w">    </span><span class="n">trace_signal_generate</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">PIDTYPE_PID</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="_5">ä¿¡å·å¤„ç†å™¨æ³¨å†Œ</h4>
<p><strong>sigaction ç³»ç»Ÿè°ƒç”¨</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// kernel/signal.c</span>
<span class="n">SYSCALL_DEFINE4</span><span class="p">(</span><span class="n">rt_sigaction</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">sig</span><span class="p">,</span>
<span class="w">               </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sigaction</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">act</span><span class="p">,</span>
<span class="w">               </span><span class="k">struct</span><span class="w"> </span><span class="nc">sigaction</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">oact</span><span class="p">,</span>
<span class="w">               </span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="n">sigsetsize</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">k_sigaction</span><span class="w"> </span><span class="n">new_sa</span><span class="p">,</span><span class="w"> </span><span class="n">old_sa</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// æ£€æŸ¥ä¿¡å·å·ç æœ‰æ•ˆæ€§</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">valid_signal</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">sig</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">act</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">sig_kernel_only</span><span class="p">(</span><span class="n">sig</span><span class="p">)))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">act</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_sa</span><span class="p">.</span><span class="n">sa</span><span class="p">,</span><span class="w"> </span><span class="n">act</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">new_sa</span><span class="p">.</span><span class="n">sa</span><span class="p">)))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">do_sigaction</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="w"> </span><span class="n">act</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="o">&amp;</span><span class="n">new_sa</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">oact</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="o">&amp;</span><span class="n">old_sa</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oact</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">oact</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">old_sa</span><span class="p">.</span><span class="n">sa</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">old_sa</span><span class="p">.</span><span class="n">sa</span><span class="p">)))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="n">do_sigaction</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">sig</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">k_sigaction</span><span class="w"> </span><span class="o">*</span><span class="n">act</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">k_sigaction</span><span class="w"> </span><span class="o">*</span><span class="n">oact</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">t</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">k_sigaction</span><span class="w"> </span><span class="o">*</span><span class="n">k</span><span class="p">;</span>
<span class="w">    </span><span class="kt">sigset_t</span><span class="w"> </span><span class="n">mask</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">valid_signal</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">sig</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">act</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">sig_kernel_only</span><span class="p">(</span><span class="n">sig</span><span class="p">)))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="w">    </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sighand</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">[</span><span class="n">sig</span><span class="mi">-1</span><span class="p">];</span>

<span class="w">    </span><span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sighand</span><span class="o">-&gt;</span><span class="n">siglock</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oact</span><span class="p">)</span>
<span class="w">        </span><span class="o">*</span><span class="n">oact</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">k</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">act</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">sigdelsetmask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">act</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_mask</span><span class="p">,</span>
<span class="w">                     </span><span class="n">sigmask</span><span class="p">(</span><span class="n">SIGKILL</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">sigmask</span><span class="p">(</span><span class="n">SIGSTOP</span><span class="p">));</span>
<span class="w">        </span><span class="o">*</span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">act</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// å¦‚æœè®¾ç½®ä¸º SIG_IGNï¼Œæ¸…é™¤æŒ‚èµ·çš„ä¿¡å·</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sig_handler</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">sig</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SIG_IGN</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">sigemptyset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mask</span><span class="p">);</span>
<span class="w">            </span><span class="n">sigaddset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">sig</span><span class="p">);</span>
<span class="w">            </span><span class="n">flush_sigqueue_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">signal</span><span class="o">-&gt;</span><span class="n">shared_pending</span><span class="p">);</span>
<span class="w">            </span><span class="n">for_each_thread</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">)</span>
<span class="w">                </span><span class="n">flush_sigqueue_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sighand</span><span class="o">-&gt;</span><span class="n">siglock</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="pending">ä¿¡å·æ©ç ä¸ Pending ä¿¡å·</h4>
<p><strong>ä¿¡å·æ©ç æ“ä½œ</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä¿¡å·æ©ç çš„åŸå­æ“ä½œ</span>
<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sigaddset</span><span class="p">(</span><span class="kt">sigset_t</span><span class="w"> </span><span class="o">*</span><span class="n">set</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">_sig</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">sig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_sig</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_NSIG_WORDS</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="n">set</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mi">1UL</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">sig</span><span class="p">;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">set</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="n">sig</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">_NSIG_BPW</span><span class="p">]</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mi">1UL</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">sig</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">_NSIG_BPW</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sigdelset</span><span class="p">(</span><span class="kt">sigset_t</span><span class="w"> </span><span class="o">*</span><span class="n">set</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">_sig</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">sig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_sig</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_NSIG_WORDS</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="n">set</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="mi">1UL</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">sig</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">set</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="n">sig</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">_NSIG_BPW</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="mi">1UL</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">sig</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">_NSIG_BPW</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">sigismember</span><span class="p">(</span><span class="kt">sigset_t</span><span class="w"> </span><span class="o">*</span><span class="n">set</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">_sig</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">sig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_sig</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_NSIG_WORDS</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">set</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="mi">1UL</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">sig</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">set</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="n">sig</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">_NSIG_BPW</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="mi">1UL</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">sig</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">_NSIG_BPW</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>ä¿¡å·çš„é˜»å¡ä¸è§£é™¤</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// sigprocmask ç³»ç»Ÿè°ƒç”¨</span>
<span class="n">SYSCALL_DEFINE4</span><span class="p">(</span><span class="n">rt_sigprocmask</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">how</span><span class="p">,</span><span class="w"> </span><span class="kt">sigset_t</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">nset</span><span class="p">,</span>
<span class="w">               </span><span class="kt">sigset_t</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">oset</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="n">sigsetsize</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">sigset_t</span><span class="w"> </span><span class="n">old_set</span><span class="p">,</span><span class="w"> </span><span class="n">new_set</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// ä¿å­˜æ—§çš„ä¿¡å·æ©ç </span>
<span class="w">    </span><span class="n">old_set</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">blocked</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nset</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_set</span><span class="p">,</span><span class="w"> </span><span class="n">nset</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">sigset_t</span><span class="p">)))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="w">        </span><span class="n">sigdelsetmask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_set</span><span class="p">,</span><span class="w"> </span><span class="n">sigmask</span><span class="p">(</span><span class="n">SIGKILL</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">sigmask</span><span class="p">(</span><span class="n">SIGSTOP</span><span class="p">));</span>

<span class="w">        </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sigprocmask</span><span class="p">(</span><span class="n">how</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">new_set</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oset</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">oset</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">old_set</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">sigset_t</span><span class="p">)))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// è®¾ç½®ä¿¡å·æ©ç </span>
<span class="kt">int</span><span class="w"> </span><span class="n">sigprocmask</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">how</span><span class="p">,</span><span class="w"> </span><span class="kt">sigset_t</span><span class="w"> </span><span class="o">*</span><span class="n">set</span><span class="p">,</span><span class="w"> </span><span class="kt">sigset_t</span><span class="w"> </span><span class="o">*</span><span class="n">oldset</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">tsk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="p">;</span>
<span class="w">    </span><span class="kt">sigset_t</span><span class="w"> </span><span class="n">newset</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// æ ¹æ®æ“ä½œç±»å‹è®¡ç®—æ–°æ©ç </span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">how</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">SIG_BLOCK</span><span class="p">:</span>
<span class="w">        </span><span class="n">sigorsets</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newset</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="n">blocked</span><span class="p">,</span><span class="w"> </span><span class="n">set</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">SIG_UNBLOCK</span><span class="p">:</span>
<span class="w">        </span><span class="n">sigandnsets</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newset</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="n">blocked</span><span class="p">,</span><span class="w"> </span><span class="n">set</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">SIG_SETMASK</span><span class="p">:</span>
<span class="w">        </span><span class="n">newset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">set</span><span class="p">;</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">__set_current_blocked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newset</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="432">4.3.2 å®æ—¶ä¿¡å·æ‰©å±•</h3>
<p>Linux æ”¯æŒ POSIX.1b å®æ—¶ä¿¡å·æ‰©å±•ï¼Œæä¾›äº†æ›´å¯é çš„ä¿¡å·æœºåˆ¶ã€‚</p>
<h4 id="vs">æ ‡å‡†ä¿¡å· vs å®æ—¶ä¿¡å·</h4>
<p><strong>ä¿¡å·åˆ†ç±»</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// include/uapi/asm-generic/signal.h</span>
<span class="cp">#define SIGHUP       1  </span><span class="c1">// ç»ˆç«¯æŒ‚èµ·</span>
<span class="cp">#define SIGINT       2  </span><span class="c1">// ç»ˆç«¯ä¸­æ–­ï¼ˆCtrl+Cï¼‰</span>
<span class="cp">#define SIGQUIT      3  </span><span class="c1">// ç»ˆç«¯é€€å‡ºï¼ˆCtrl+\ï¼‰</span>
<span class="cp">#define SIGILL       4  </span><span class="c1">// éæ³•æŒ‡ä»¤</span>
<span class="cp">#define SIGTRAP      5  </span><span class="c1">// è·Ÿè¸ª/æ–­ç‚¹é™·é˜±</span>
<span class="cp">#define SIGABRT      6  </span><span class="c1">// abort() è°ƒç”¨</span>
<span class="cp">#define SIGBUS       7  </span><span class="c1">// æ€»çº¿é”™è¯¯</span>
<span class="cp">#define SIGFPE       8  </span><span class="c1">// æµ®ç‚¹å¼‚å¸¸</span>
<span class="cp">#define SIGKILL      9  </span><span class="c1">// å¼ºåˆ¶ç»ˆæ­¢ï¼ˆä¸å¯æ•è·ï¼‰</span>
<span class="cp">#define SIGUSR1     10  </span><span class="c1">// ç”¨æˆ·å®šä¹‰ä¿¡å· 1</span>
<span class="cp">#define SIGSEGV     11  </span><span class="c1">// æ®µé”™è¯¯</span>
<span class="cp">#define SIGUSR2     12  </span><span class="c1">// ç”¨æˆ·å®šä¹‰ä¿¡å· 2</span>
<span class="cp">#define SIGPIPE     13  </span><span class="c1">// ç®¡é“ç ´è£‚</span>
<span class="cp">#define SIGALRM     14  </span><span class="c1">// alarm() å®šæ—¶å™¨</span>
<span class="cp">#define SIGTERM     15  </span><span class="c1">// ç»ˆæ­¢è¯·æ±‚</span>
<span class="cp">#define SIGSTKFLT   16  </span><span class="c1">// åå¤„ç†å™¨æ ˆé”™è¯¯</span>
<span class="cp">#define SIGCHLD     17  </span><span class="c1">// å­è¿›ç¨‹çŠ¶æ€æ”¹å˜</span>
<span class="cp">#define SIGCONT     18  </span><span class="c1">// ç»§ç»­æ‰§è¡Œ</span>
<span class="cp">#define SIGSTOP     19  </span><span class="c1">// åœæ­¢æ‰§è¡Œï¼ˆä¸å¯æ•è·ï¼‰</span>
<span class="cp">#define SIGTSTP     20  </span><span class="c1">// ç»ˆç«¯åœæ­¢ï¼ˆCtrl+Zï¼‰</span>
<span class="cp">#define SIGTTIN     21  </span><span class="c1">// åå°è¿›ç¨‹è¯»ç»ˆç«¯</span>
<span class="cp">#define SIGTTOU     22  </span><span class="c1">// åå°è¿›ç¨‹å†™ç»ˆç«¯</span>
<span class="cp">#define SIGURG      23  </span><span class="c1">// ç´§æ€¥æ•°æ®åˆ°è¾¾</span>
<span class="cp">#define SIGXCPU     24  </span><span class="c1">// CPU æ—¶é—´é™åˆ¶è¶…å‡º</span>
<span class="cp">#define SIGXFSZ     25  </span><span class="c1">// æ–‡ä»¶å¤§å°é™åˆ¶è¶…å‡º</span>
<span class="cp">#define SIGVTALRM   26  </span><span class="c1">// è™šæ‹Ÿå®šæ—¶å™¨</span>
<span class="cp">#define SIGPROF     27  </span><span class="c1">// æ€§èƒ½åˆ†æå®šæ—¶å™¨</span>
<span class="cp">#define SIGWINCH    28  </span><span class="c1">// ç»ˆç«¯çª—å£å¤§å°æ”¹å˜</span>
<span class="cp">#define SIGIO       29  </span><span class="c1">// I/O å°±ç»ª</span>
<span class="cp">#define SIGPWR      30  </span><span class="c1">// ç”µæºæ•…éšœ</span>
<span class="cp">#define SIGSYS      31  </span><span class="c1">// ç³»ç»Ÿè°ƒç”¨å‚æ•°é”™è¯¯</span>

<span class="c1">// å®æ—¶ä¿¡å·èŒƒå›´</span>
<span class="cp">#define SIGRTMIN    32</span>
<span class="cp">#define SIGRTMAX    64</span>
</code></pre></div>

<p><strong>å…³é”®å·®å¼‚</strong></p>
<p>| ç‰¹æ€§ | æ ‡å‡†ä¿¡å·ï¼ˆ1-31ï¼‰ | å®æ—¶ä¿¡å·ï¼ˆ32-64ï¼‰ |</p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>æ ‡å‡†ä¿¡å·ï¼ˆ1-31ï¼‰</th>
<th>å®æ—¶ä¿¡å·ï¼ˆ32-64ï¼‰</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ’é˜Ÿ</td>
<td>ä¸æ’é˜Ÿï¼Œå¤šä¸ªç›¸åŒä¿¡å·åˆå¹¶</td>
<td>å¯é æ’é˜Ÿï¼Œä¸ä¸¢å¤±</td>
</tr>
<tr>
<td>ä¼˜å…ˆçº§</td>
<td>ä¿¡å·ç¼–å·è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜</td>
<td>å¯è‡ªå®šä¹‰ä¼˜å…ˆçº§</td>
</tr>
<tr>
<td>ä¿¡æ¯ä¼ é€’</td>
<td>ä»…ä¿¡å·ç¼–å·</td>
<td>å¯æºå¸¦é¢å¤–æ•°æ®</td>
</tr>
<tr>
<td>é¡ºåºä¿è¯</td>
<td>æ— ä¿è¯</td>
<td>FIFO é¡ºåºä¿è¯</td>
</tr>
<tr>
<td>ç”¨é€”</td>
<td>ç³»ç»Ÿå®šä¹‰çš„ç‰¹å®šäº‹ä»¶</td>
<td>åº”ç”¨ç¨‹åºè‡ªå®šä¹‰</td>
</tr>
</tbody>
</table>
<h4 id="_6">ä¿¡å·é˜Ÿåˆ—æœºåˆ¶</h4>
<p><strong>å®æ—¶ä¿¡å·çš„å¯é æ’é˜Ÿ</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// å®æ—¶ä¿¡å·é˜Ÿåˆ—ç®¡ç†</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">sigqueue_cache</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sigqueue</span><span class="w"> </span><span class="o">*</span><span class="n">first</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sigqueue</span><span class="w"> </span><span class="o">*</span><span class="n">__sigqueue_alloc</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">sig</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">t</span><span class="p">,</span>
<span class="w">                                        </span><span class="n">gfp_t</span><span class="w"> </span><span class="n">gfp_flags</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">override_rlimit</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sigqueue</span><span class="w"> </span><span class="o">*</span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ucounts</span><span class="w"> </span><span class="o">*</span><span class="n">ucounts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">sigpending</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// å®æ—¶ä¿¡å·å¿…é¡»æ’é˜Ÿ</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">sig</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">SIGRTMIN</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>
<span class="w">        </span><span class="p">(</span><span class="n">sigpending</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inc_rlimit_ucounts</span><span class="p">(</span><span class="n">ucounts</span><span class="p">,</span><span class="w"> </span><span class="n">UCOUNT_RLIMIT_SIGPENDING</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">dec_rlimit_ucounts</span><span class="p">(</span><span class="n">ucounts</span><span class="p">,</span><span class="w"> </span><span class="n">UCOUNT_RLIMIT_SIGPENDING</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// ä»ç¼“å­˜æˆ– slab åˆ†é…</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">sigqueue_cache</span><span class="p">.</span><span class="n">count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">sigqueue_cache</span><span class="p">.</span><span class="n">first</span><span class="p">;</span>
<span class="w">        </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">sigqueue_cache</span><span class="p">.</span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">q</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<span class="w">        </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">sigqueue_cache</span><span class="p">.</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmem_cache_alloc</span><span class="p">(</span><span class="n">sigqueue_cachep</span><span class="p">,</span><span class="w"> </span><span class="n">gfp_flags</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">q</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ucounts</span><span class="p">)</span>
<span class="w">            </span><span class="n">dec_rlimit_ucounts</span><span class="p">(</span><span class="n">ucounts</span><span class="p">,</span><span class="w"> </span><span class="n">UCOUNT_RLIMIT_SIGPENDING</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
<span class="w">        </span><span class="n">q</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">q</span><span class="o">-&gt;</span><span class="n">ucounts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ucounts</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">q</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="siginfo_t">siginfo_t ç»“æ„è¯¦è§£</h4>
<p><strong>ä¿¡å·ä¿¡æ¯ç»“æ„</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// include/uapi/asm-generic/siginfo.h</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">kernel_siginfo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">si_signo</span><span class="p">;</span><span class="w">    </span><span class="c1">// ä¿¡å·ç¼–å·</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">si_errno</span><span class="p">;</span><span class="w">    </span><span class="c1">// errno å€¼</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">si_code</span><span class="p">;</span><span class="w">     </span><span class="c1">// ä¿¡å·æ¥æºä»£ç </span>

<span class="w">        </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">_pad</span><span class="p">[</span><span class="n">SI_PAD_SIZE</span><span class="p">];</span>

<span class="w">            </span><span class="c1">// SIGKILL</span>
<span class="w">            </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">__kernel_pid_t</span><span class="w"> </span><span class="n">_pid</span><span class="p">;</span><span class="w">    </span><span class="c1">// å‘é€è¿›ç¨‹ PID</span>
<span class="w">                </span><span class="n">__kernel_uid32_t</span><span class="w"> </span><span class="n">_uid</span><span class="p">;</span><span class="w">  </span><span class="c1">// å‘é€è¿›ç¨‹ UID</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="n">_kill</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// POSIX.1b å®šæ—¶å™¨</span>
<span class="w">            </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">__kernel_timer_t</span><span class="w"> </span><span class="n">_tid</span><span class="p">;</span><span class="w">  </span><span class="c1">// å®šæ—¶å™¨ ID</span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">_overrun</span><span class="p">;</span><span class="w">           </span><span class="c1">// æº¢å‡ºè®¡æ•°</span>
<span class="w">                </span><span class="kt">sigval_t</span><span class="w"> </span><span class="n">_sigval</span><span class="p">;</span><span class="w">       </span><span class="c1">// ä¿¡å·å€¼</span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">_sys_private</span><span class="p">;</span><span class="w">       </span><span class="c1">// ç³»ç»Ÿç§æœ‰æ•°æ®</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="n">_timer</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// POSIX.1b ä¿¡å·</span>
<span class="w">            </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">__kernel_pid_t</span><span class="w"> </span><span class="n">_pid</span><span class="p">;</span><span class="w">    </span><span class="c1">// å‘é€è¿›ç¨‹ PID</span>
<span class="w">                </span><span class="n">__kernel_uid32_t</span><span class="w"> </span><span class="n">_uid</span><span class="p">;</span><span class="w">  </span><span class="c1">// å‘é€è¿›ç¨‹ UID</span>
<span class="w">                </span><span class="kt">sigval_t</span><span class="w"> </span><span class="n">_sigval</span><span class="p">;</span><span class="w">       </span><span class="c1">// ä¿¡å·å€¼</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="n">_rt</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// SIGCHLD</span>
<span class="w">            </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">__kernel_pid_t</span><span class="w"> </span><span class="n">_pid</span><span class="p">;</span><span class="w">    </span><span class="c1">// å­è¿›ç¨‹ PID</span>
<span class="w">                </span><span class="n">__kernel_uid32_t</span><span class="w"> </span><span class="n">_uid</span><span class="p">;</span><span class="w">  </span><span class="c1">// å­è¿›ç¨‹ UID</span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">_status</span><span class="p">;</span><span class="w">            </span><span class="c1">// é€€å‡ºçŠ¶æ€</span>
<span class="w">                </span><span class="n">__kernel_clock_t</span><span class="w"> </span><span class="n">_utime</span><span class="p">;</span>
<span class="w">                </span><span class="n">__kernel_clock_t</span><span class="w"> </span><span class="n">_stime</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="n">_sigchld</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// SIGILL, SIGFPE, SIGSEGV, SIGBUS, SIGTRAP</span>
<span class="w">            </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kt">void</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">_addr</span><span class="p">;</span><span class="w">     </span><span class="c1">// æ•…éšœåœ°å€</span>

<span class="w">                </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// BUS_MCEERR_AR, BUS_MCEERR_AO</span>
<span class="w">                    </span><span class="kt">int</span><span class="w"> </span><span class="n">_trapno</span><span class="p">;</span><span class="w">        </span><span class="c1">// TRAP ç¼–å·</span>

<span class="w">                    </span><span class="c1">// BUS_MCEERR_AR, BUS_MCEERR_AO</span>
<span class="w">                    </span><span class="kt">short</span><span class="w"> </span><span class="n">_addr_lsb</span><span class="p">;</span><span class="w">    </span><span class="c1">// åœ°å€ LSB</span>

<span class="w">                    </span><span class="c1">// SEGV_BNDERR</span>
<span class="w">                    </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="kt">void</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">_lower</span><span class="p">;</span>
<span class="w">                        </span><span class="kt">void</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">_upper</span><span class="p">;</span>
<span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="n">_addr_bnd</span><span class="p">;</span>

<span class="w">                    </span><span class="c1">// SEGV_PKUERR</span>
<span class="w">                    </span><span class="n">__u32</span><span class="w"> </span><span class="n">_pkey</span><span class="p">;</span>
<span class="w">                </span><span class="p">};</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="n">_sigfault</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// SIGPOLL</span>
<span class="w">            </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kt">long</span><span class="w"> </span><span class="n">_band</span><span class="p">;</span><span class="w">     </span><span class="c1">// POLL_IN, POLL_OUT, POLL_MSG</span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">_fd</span><span class="p">;</span><span class="w">        </span><span class="c1">// æ–‡ä»¶æè¿°ç¬¦</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="n">_sigpoll</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// SIGSYS</span>
<span class="w">            </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kt">void</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">_call_addr</span><span class="p">;</span><span class="w">    </span><span class="c1">// è°ƒç”¨åœ°å€</span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">_syscall</span><span class="p">;</span><span class="w">                </span><span class="c1">// ç³»ç»Ÿè°ƒç”¨å·</span>
<span class="w">                </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">_arch</span><span class="p">;</span><span class="w">          </span><span class="c1">// æ¶æ„</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="n">_sigsys</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="n">_sifields</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>
<span class="p">}</span><span class="w"> </span><span class="n">kernel_siginfo_t</span><span class="p">;</span>
</code></pre></div>

<p><strong>ä¿¡å·ä»£ç å®šä¹‰</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä¿¡å·æ¥æºä»£ç ï¼ˆsi_codeï¼‰</span>
<span class="cp">#define SI_USER      0      </span><span class="c1">// kill(), raise()</span>
<span class="cp">#define SI_KERNEL    0x80   </span><span class="c1">// å†…æ ¸äº§ç”Ÿ</span>
<span class="cp">#define SI_QUEUE    -1      </span><span class="c1">// sigqueue()</span>
<span class="cp">#define SI_TIMER    -2      </span><span class="c1">// POSIX.1b å®šæ—¶å™¨</span>
<span class="cp">#define SI_MESGQ    -3      </span><span class="c1">// POSIX.1b æ¶ˆæ¯é˜Ÿåˆ—</span>
<span class="cp">#define SI_ASYNCIO  -4      </span><span class="c1">// AIO å®Œæˆ</span>
<span class="cp">#define SI_SIGIO    -5      </span><span class="c1">// SIGIO æ’é˜Ÿ</span>
<span class="cp">#define SI_TKILL    -6      </span><span class="c1">// tkill(), tgkill()</span>
<span class="cp">#define SI_DETHREAD -7      </span><span class="c1">// SIGCHLD from execve</span>

<span class="c1">// SIGILL çš„ si_code</span>
<span class="cp">#define ILL_ILLOPC  1       </span><span class="c1">// éæ³•æ“ä½œç </span>
<span class="cp">#define ILL_ILLOPN  2       </span><span class="c1">// éæ³•æ“ä½œæ•°</span>
<span class="cp">#define ILL_ILLADR  3       </span><span class="c1">// éæ³•å¯»å€æ¨¡å¼</span>
<span class="cp">#define ILL_ILLTRP  4       </span><span class="c1">// éæ³•é™·é˜±</span>
<span class="cp">#define ILL_PRVOPC  5       </span><span class="c1">// ç‰¹æƒæ“ä½œç </span>
<span class="cp">#define ILL_PRVREG  6       </span><span class="c1">// ç‰¹æƒå¯„å­˜å™¨</span>
<span class="cp">#define ILL_COPROC  7       </span><span class="c1">// åå¤„ç†å™¨é”™è¯¯</span>
<span class="cp">#define ILL_BADSTK  8       </span><span class="c1">// å†…éƒ¨æ ˆé”™è¯¯</span>

<span class="c1">// SIGSEGV çš„ si_code</span>
<span class="cp">#define SEGV_MAPERR 1       </span><span class="c1">// åœ°å€æœªæ˜ å°„</span>
<span class="cp">#define SEGV_ACCERR 2       </span><span class="c1">// æƒé™é”™è¯¯</span>
<span class="cp">#define SEGV_BNDERR 3       </span><span class="c1">// è¾¹ç•Œæ£€æŸ¥å¤±è´¥</span>
<span class="cp">#define SEGV_PKUERR 4       </span><span class="c1">// ä¿æŠ¤é”®é”™è¯¯</span>
</code></pre></div>

<h3 id="44-futex">4.4 futex ä¸ç”¨æˆ·æ€åŒæ­¥</h3>
<h4 id="441-futex">4.4.1 futex è®¾è®¡åŸç†</h4>
<ul>
<li>ç”¨æˆ·æ€å¿«é€Ÿè·¯å¾„</li>
<li>å†…æ ¸æ€æ…¢é€Ÿè·¯å¾„</li>
<li>futex å“ˆå¸Œè¡¨ç»„ç»‡</li>
</ul>
<h4 id="442-futex">4.4.2 futex æ“ä½œè¯¦è§£</h4>
<ul>
<li>FUTEX_WAIT ä¸ FUTEX_WAKE</li>
<li>Priority Inheritance (PI) futex</li>
<li>Robust futex æœºåˆ¶</li>
</ul>
<h3 id="45-ipc">4.5 ç°ä»£ IPC æœºåˆ¶</h3>
<h4 id="451-eventfd">4.5.1 eventfd</h4>
<ul>
<li>eventfd å®ç°åŸç†</li>
<li>ä¸ epoll é›†æˆ</li>
<li>eventfd åœ¨è™šæ‹ŸåŒ–ä¸­çš„åº”ç”¨</li>
</ul>
<h4 id="452-signalfd-timerfd">4.5.2 signalfd ä¸ timerfd</h4>
<ul>
<li>ä¿¡å·çš„æ–‡ä»¶æè¿°ç¬¦æŠ½è±¡</li>
<li>å®šæ—¶å™¨çš„æ–‡ä»¶æè¿°ç¬¦æŠ½è±¡</li>
<li>ç»Ÿä¸€çš„äº‹ä»¶å¤„ç†æ¨¡å‹</li>
</ul>
<h3 id="46">4.6 æ€§èƒ½åˆ†æä¸ä¼˜åŒ–</h3>
<ul>
<li>IPC æœºåˆ¶æ€§èƒ½å¯¹æ¯”</li>
<li>é›¶æ‹·è´ä¼˜åŒ–æŠ€æœ¯</li>
<li>NUMA æ¶æ„ä¸‹çš„ IPC ä¼˜åŒ–</li>
</ul>
<h3 id="47">4.7 å†å²æ•…äº‹</h3>
<ul>
<li>Ulrich Drepper ä¸ futex çš„è¯ç”Ÿ</li>
<li>System V IPC åˆ° POSIX IPC çš„æ ‡å‡†ä¹‹äº‰</li>
<li>Android Binder çš„è®¾è®¡å“²å­¦</li>
</ul>
<h3 id="48">4.8 é«˜çº§è¯é¢˜</h3>
<ul>
<li>io_uring çš„å¼‚æ­¥é€šä¿¡æ¨¡å‹</li>
<li>RDMA åœ¨å†…æ ¸ä¸­çš„æ”¯æŒ</li>
<li>ç”¨æˆ·æ€æ—è·¯æŠ€æœ¯ï¼ˆDPDKï¼‰</li>
</ul>
<h3 id="49">4.9 æœ¬ç« å°ç»“</h3>
<h3 id="410">4.10 ç»ƒä¹ é¢˜</h3>
<h3 id="411">4.11 å¸¸è§é™·é˜±ä¸é”™è¯¯</h3>
<h3 id="412">4.12 æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•</h3>
            </article>
            
            <nav class="page-nav"><a href="chapter3.html" class="nav-link prev">â† ç¬¬3ç« ï¼šå†…å­˜ç®¡ç†æ¶æ„</a><a href="chapter5.html" class="nav-link next">ç¬¬5ç« ï¼šè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰ â†’</a></nav>
        </main>
    </div>
</body>
</html>