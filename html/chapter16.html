<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬16ç« ï¼šå¼•å¯¼è¿‡ç¨‹ä¸åˆå§‹åŒ–</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Linux å†…æ ¸æºä»£ç æ·±åº¦è§£æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬1ç« ï¼šLinux å†…æ ¸æ¦‚è¿°ä¸å‘å±•å²</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬2ç« ï¼šè¿›ç¨‹ç®¡ç†ä¸ä»»åŠ¡è°ƒåº¦</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬3ç« ï¼šå†…å­˜ç®¡ç†æ¶æ„</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬4ç« ï¼šè¿›ç¨‹é—´é€šä¿¡æœºåˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬5ç« ï¼šè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬6ç« ï¼šå…·ä½“æ–‡ä»¶ç³»ç»Ÿå®ç°</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬7ç« ï¼šå—è®¾å¤‡å±‚ä¸I/Oè°ƒåº¦</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬8ç« ï¼šè®¾å¤‡é©±åŠ¨æ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬9ç« ï¼šç½‘ç»œåè®®æ ˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬10ç« ï¼šå†…æ ¸åŒæ­¥æœºåˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬11ç« ï¼šå¹¶å‘ç¼–ç¨‹æ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬12ç« ï¼šå®¹å™¨ä¸å‘½åç©ºé—´</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬13ç« ï¼šå®‰å…¨å­ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬14ç« ï¼šå®æ—¶Linux</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬15ç« ï¼šæ€§èƒ½åˆ†æä¸è°ƒè¯•</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬16ç« ï¼šå¼•å¯¼è¿‡ç¨‹ä¸åˆå§‹åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="16">ç¬¬16ç« ï¼šå¼•å¯¼è¿‡ç¨‹ä¸åˆå§‹åŒ–</h1>
<h2 id="_1">æœ¬ç« å¯¼è¯»</h2>
<p>ç³»ç»Ÿå¯åŠ¨æ˜¯ Linux å†…æ ¸æœ€ç¥ç§˜ä¹Ÿæœ€å…³é”®çš„é˜¶æ®µã€‚ä»æŒ‰ä¸‹ç”µæºæŒ‰é’®åˆ°ç”¨æˆ·ç™»å½•ç•Œé¢å‡ºç°ï¼ŒæœŸé—´ç»å†äº†å¤æ‚çš„ç¡¬ä»¶åˆå§‹åŒ–ã€å†…æ ¸åŠ è½½ã€å­ç³»ç»Ÿå¯åŠ¨ç­‰è¿‡ç¨‹ã€‚æœ¬ç« å°†æ·±å…¥å‰–æä» BIOS/UEFI å›ºä»¶åˆ° systemd ç”¨æˆ·ç©ºé—´çš„å®Œæ•´å¯åŠ¨é“¾è·¯ï¼Œé‡ç‚¹è§£æå†…æ ¸å¦‚ä½•ä»ä¸€ä¸ªå‹ç¼©çš„äºŒè¿›åˆ¶æ–‡ä»¶å˜æˆè¿è¡Œä¸­çš„æ“ä½œç³»ç»Ÿæ ¸å¿ƒã€‚é€šè¿‡å­¦ä¹ æœ¬ç« ï¼Œæ‚¨å°†æŒæ¡å†…æ ¸å¯åŠ¨çš„æ¯ä¸ªå…³é”®èŠ‚ç‚¹ã€ç†è§£ initcall æœºåˆ¶çš„è®¾è®¡å“²å­¦ï¼Œå¹¶èƒ½å¤Ÿä¼˜åŒ–ç³»ç»Ÿå¯åŠ¨æ€§èƒ½ã€‚</p>
<h2 id="161-biosuefi">16.1 BIOS/UEFI å¼•å¯¼é˜¶æ®µ</h2>
<h3 id="1611-bios">16.1.1 ä¼ ç»Ÿ BIOS å¼•å¯¼æµç¨‹</h3>
<p>å½“ x86 ç³»ç»Ÿä¸Šç”µæ—¶ï¼ŒCPU è¢«ç¡¬ä»¶å¼ºåˆ¶è®¾ç½®ä¸ºå®æ¨¡å¼ï¼Œå¹¶ä»ç‰©ç†åœ°å€ 0xFFFFFFF0ï¼ˆReset Vectorï¼‰å¼€å§‹æ‰§è¡Œã€‚è¿™ä¸ªåœ°å€æ˜ å°„åˆ° BIOS ROMï¼ŒåŒ…å«ä¸€æ¡è·³è½¬æŒ‡ä»¤ï¼Œè·³è½¬åˆ° BIOS åˆå§‹åŒ–ä»£ç ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="nx">å¯åŠ¨é¡ºåº</span><span class="err">ï¼š</span>

<span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="nx">Power</span><span class="w"> </span><span class="nx">On</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="nx">CPU</span><span class="w"> </span><span class="nx">Reset</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="nx">CS</span><span class="p">:</span><span class="nx">IP</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mh">0xF000</span><span class="p">:</span><span class="mh">0xFFF0</span>
<span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="nx">BIOS</span><span class="w"> </span><span class="nx">POST</span><span class="w"> </span><span class="p">(</span><span class="nx">Power</span><span class="o">-</span><span class="nx">On</span><span class="w"> </span><span class="k">Self</span><span class="o">-</span><span class="nx">Test</span><span class="p">)</span>
<span class="mi">3</span><span class="p">.</span><span class="w"> </span><span class="nx">å†…å­˜æ£€æµ‹ä¸åˆå§‹åŒ–</span>
<span class="mi">4</span><span class="p">.</span><span class="w"> </span><span class="nx">æœç´¢å¯åŠ¨è®¾å¤‡</span><span class="err">ï¼ˆ</span><span class="nx">æŒ‰</span><span class="w"> </span><span class="nx">Boot</span><span class="w"> </span><span class="nx">Order</span><span class="err">ï¼‰</span>
<span class="mi">5</span><span class="p">.</span><span class="w"> </span><span class="nx">åŠ è½½</span><span class="w"> </span><span class="nx">MBR</span><span class="w"> </span><span class="p">(</span><span class="nx">Master</span><span class="w"> </span><span class="nx">Boot</span><span class="w"> </span><span class="nx">Record</span><span class="p">)</span><span class="w"> </span><span class="nx">åˆ°</span><span class="w"> </span><span class="mh">0x7C00</span>
<span class="mi">6</span><span class="p">.</span><span class="w"> </span><span class="nx">è·³è½¬åˆ°</span><span class="w"> </span><span class="mh">0x7C00</span><span class="w"> </span><span class="nx">æ‰§è¡Œå¼•å¯¼ä»£ç </span>
</code></pre></div>

<p>MBR ç»“æ„ï¼ˆ512 å­—èŠ‚ï¼‰ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="err">åç§»</span><span class="w">    </span><span class="err">å¤§å°</span><span class="w">     </span><span class="err">æè¿°</span>
<span class="mh">0x000</span><span class="w">   </span><span class="mi">446</span><span class="n">B</span><span class="w">    </span><span class="err">å¼•å¯¼ä»£ç ï¼ˆ</span><span class="n">bootloader</span><span class="w"> </span><span class="n">stage</span><span class="w"> </span><span class="mi">1</span><span class="err">ï¼‰</span>
<span class="mh">0x1BE</span><span class="w">   </span><span class="mi">64</span><span class="n">B</span><span class="w">     </span><span class="err">åˆ†åŒºè¡¨ï¼ˆ</span><span class="mi">4</span><span class="err">ä¸ª</span><span class="mi">16</span><span class="err">å­—èŠ‚åˆ†åŒºé¡¹ï¼‰</span>
<span class="mh">0x1FE</span><span class="w">   </span><span class="mi">2</span><span class="n">B</span><span class="w">      </span><span class="err">é­”æ•°</span><span class="w"> </span><span class="mh">0xAA55</span><span class="err">ï¼ˆå°ç«¯åºï¼‰</span>
</code></pre></div>

<h3 id="1612-uefi">16.1.2 UEFI ç°ä»£å¼•å¯¼</h3>
<p>UEFIï¼ˆUnified Extensible Firmware Interfaceï¼‰æä¾›äº†æ›´å¼ºå¤§çš„å¼•å¯¼æœºåˆ¶ï¼š</p>
<div class="codehilite"><pre><span></span><code>UEFI å¯åŠ¨æµç¨‹ï¼š
SEC (Security) â†’ PEI (Pre-EFI) â†’ DXE (Driver Execution) â†’ BDS (Boot Device Select) â†’ OS Loader
     â†“              â†“               â†“                        â†“                      â†“
  éªŒè¯å›ºä»¶      åˆå§‹åŒ–å†…å­˜      åŠ è½½é©±åŠ¨å’Œåè®®           é€‰æ‹©å¯åŠ¨é¡¹            åŠ è½½å†…æ ¸
</code></pre></div>

<p>UEFI çš„å…³é”®ä¼˜åŠ¿ï¼š</p>
<ul>
<li><strong>GPT åˆ†åŒºæ”¯æŒ</strong>ï¼šçªç ´ MBR çš„ 2TB é™åˆ¶</li>
<li><strong>å®‰å…¨å¯åŠ¨</strong>ï¼šé€šè¿‡ç­¾åéªŒè¯é˜²æ­¢ rootkit</li>
<li><strong>ç½‘ç»œå¯åŠ¨</strong>ï¼šåŸç”Ÿæ”¯æŒ PXE å’Œ HTTP å¯åŠ¨</li>
<li><strong>è¿è¡Œæ—¶æœåŠ¡</strong>ï¼šä¸º OS æä¾›æŒç»­çš„å›ºä»¶æœåŠ¡</li>
</ul>
<p>ESPï¼ˆEFI System Partitionï¼‰æ–‡ä»¶å¸ƒå±€ï¼š</p>
<div class="codehilite"><pre><span></span><code>/EFI/
â”œâ”€â”€ BOOT/
â”‚   â””â”€â”€ BOOTX64.EFI    # é»˜è®¤å¼•å¯¼å™¨
â”œâ”€â”€ ubuntu/
â”‚   â”œâ”€â”€ grubx64.efi     # GRUB UEFI å¼•å¯¼å™¨
â”‚   â”œâ”€â”€ shimx64.efi     # Secure Boot shim
â”‚   â””â”€â”€ grub.cfg        # GRUB é…ç½®
â””â”€â”€ Microsoft/
    â””â”€â”€ Boot/           # Windows å¼•å¯¼å™¨
</code></pre></div>

<h3 id="1613-bootloader">16.1.3 Bootloader æ¶æ„</h3>
<p>ç°ä»£ Linux ç³»ç»Ÿä¸»è¦ä½¿ç”¨ GRUB2ï¼ˆGRand Unified Bootloaderï¼‰ï¼š</p>
<p>GRUB2 å¤šé˜¶æ®µåŠ è½½ï¼š</p>
<div class="codehilite"><pre><span></span><code>Stage 1 (boot.img):

  - å¤§å°ï¼š512 å­—èŠ‚ï¼ˆåˆšå¥½ä¸€ä¸ªæ‰‡åŒºï¼‰
  - ä½ç½®ï¼šMBR æˆ– GPT çš„ BIOS Boot Partition
  - åŠŸèƒ½ï¼šåŠ è½½ Stage 1.5

Stage 1.5 (core.img):

  - å¤§å°ï¼šçº¦ 32KB
  - ä½ç½®ï¼šMBR åçš„ç©ºé—²æ‰‡åŒºæˆ–ä¸“ç”¨åˆ†åŒº
  - åŠŸèƒ½ï¼šåŒ…å«æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨ï¼Œèƒ½å¤Ÿè¯»å– /boot

Stage 2 (grub modules):

  - ä½ç½®ï¼š/boot/grub/
  - åŠŸèƒ½ï¼šæä¾›å®Œæ•´çš„å¼•å¯¼ç¯å¢ƒ
</code></pre></div>

<p>GRUB2 ä¼ é€’ç»™å†…æ ¸çš„å…³é”®å‚æ•°ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">boot_params</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">screen_info</span><span class="w"> </span><span class="n">screen_info</span><span class="p">;</span><span class="w">    </span><span class="c1">// æ˜¾ç¤ºæ¨¡å¼ä¿¡æ¯</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">apm_bios_info</span><span class="w"> </span><span class="n">apm_bios_info</span><span class="p">;</span><span class="w"> </span><span class="c1">// APM BIOS ä¿¡æ¯</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">cmd_line_ptr</span><span class="p">;</span><span class="w">                </span><span class="c1">// å†…æ ¸å‘½ä»¤è¡ŒæŒ‡é’ˆ</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">initrd_addr_max</span><span class="p">;</span><span class="w">             </span><span class="c1">// initrd æœ€å¤§åœ°å€</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">kernel_alignment</span><span class="p">;</span><span class="w">            </span><span class="c1">// å†…æ ¸å¯¹é½è¦æ±‚</span>
<span class="w">    </span><span class="c1">// ... E820 å†…å­˜æ˜ å°„è¡¨</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">e820_entry</span><span class="w"> </span><span class="n">e820_table</span><span class="p">[</span><span class="n">E820_MAX_ENTRIES</span><span class="p">];</span>
<span class="p">};</span>
</code></pre></div>

<h2 id="162">16.2 å†…æ ¸åŠ è½½ä¸è§£å‹</h2>
<h3 id="1621-bzimage">16.2.1 bzImage æ ¼å¼è§£æ</h3>
<p>Linux å†…æ ¸ç¼–è¯‘åç”Ÿæˆçš„ bzImageï¼ˆbig zImageï¼‰æ˜¯ä¸€ä¸ªè‡ªè§£å‹çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼š</p>
<div class="codehilite"><pre><span></span><code>bzImage ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 0x0000
â”‚   Setup Header  â”‚ å®æ¨¡å¼è®¾ç½®ä»£ç ï¼ˆarch/x86/boot/header.Sï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ 0x1F1 (497)
â”‚   Boot Protocol â”‚ å¼•å¯¼åè®®ç‰ˆæœ¬å’Œæ ‡å¿—
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ 0x200 (512)
â”‚   Setup Code    â”‚ 16ä½/32ä½æ··åˆä»£ç 
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ setup_sects * 512
â”‚  Protected Mode â”‚ 32/64ä½å‹ç¼©å†…æ ¸
â”‚  Kernel (vmlinux.gz)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<p>å…³é”®çš„ setup_header å­—æ®µï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">setup_header</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__u8</span><span class="w">  </span><span class="n">setup_sects</span><span class="p">;</span><span class="w">      </span><span class="c1">// setup ä»£ç çš„æ‰‡åŒºæ•°</span>
<span class="w">    </span><span class="n">__u16</span><span class="w"> </span><span class="n">root_flags</span><span class="p">;</span><span class="w">       </span><span class="c1">// æ ¹æ–‡ä»¶ç³»ç»Ÿæ ‡å¿—</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">syssize</span><span class="p">;</span><span class="w">          </span><span class="c1">// å‹ç¼©å†…æ ¸å¤§å°ï¼ˆ16å­—èŠ‚ä¸ºå•ä½ï¼‰</span>
<span class="w">    </span><span class="n">__u16</span><span class="w"> </span><span class="n">ram_size</span><span class="p">;</span><span class="w">         </span><span class="c1">// åºŸå¼ƒ</span>
<span class="w">    </span><span class="n">__u16</span><span class="w"> </span><span class="n">vid_mode</span><span class="p">;</span><span class="w">         </span><span class="c1">// è§†é¢‘æ¨¡å¼</span>
<span class="w">    </span><span class="n">__u16</span><span class="w"> </span><span class="n">root_dev</span><span class="p">;</span><span class="w">         </span><span class="c1">// æ ¹è®¾å¤‡å·</span>
<span class="w">    </span><span class="n">__u16</span><span class="w"> </span><span class="n">boot_flag</span><span class="p">;</span><span class="w">        </span><span class="c1">// 0xAA55 é­”æ•°</span>
<span class="w">    </span><span class="n">__u16</span><span class="w"> </span><span class="n">jump</span><span class="p">;</span><span class="w">             </span><span class="c1">// è·³è½¬æŒ‡ä»¤</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">header</span><span class="p">;</span><span class="w">           </span><span class="c1">// &quot;HdrS&quot; é­”æ•°</span>
<span class="w">    </span><span class="n">__u16</span><span class="w"> </span><span class="n">version</span><span class="p">;</span><span class="w">          </span><span class="c1">// å¼•å¯¼åè®®ç‰ˆæœ¬</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">realmode_swtch</span><span class="p">;</span><span class="w">   </span><span class="c1">// åˆ‡æ¢åˆ°å®æ¨¡å¼çš„é’©å­</span>
<span class="w">    </span><span class="n">__u16</span><span class="w"> </span><span class="n">start_sys_seg</span><span class="p">;</span><span class="w">    </span><span class="c1">// åºŸå¼ƒ</span>
<span class="w">    </span><span class="n">__u16</span><span class="w"> </span><span class="n">kernel_version</span><span class="p">;</span><span class="w">   </span><span class="c1">// å†…æ ¸ç‰ˆæœ¬å­—ç¬¦ä¸²æŒ‡é’ˆ</span>
<span class="w">    </span><span class="n">__u8</span><span class="w">  </span><span class="n">type_of_loader</span><span class="p">;</span><span class="w">   </span><span class="c1">// å¼•å¯¼å™¨ç±»å‹</span>
<span class="w">    </span><span class="n">__u8</span><span class="w">  </span><span class="n">loadflags</span><span class="p">;</span><span class="w">        </span><span class="c1">// å¼•å¯¼æ ‡å¿—</span>
<span class="w">    </span><span class="n">__u16</span><span class="w"> </span><span class="n">setup_move_size</span><span class="p">;</span><span class="w">  </span><span class="c1">// ç§»åŠ¨åˆ° setup ä»£ç å¤§å°</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">code32_start</span><span class="p">;</span><span class="w">     </span><span class="c1">// 32ä½ä»£ç èµ·å§‹åœ°å€</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">ramdisk_image</span><span class="p">;</span><span class="w">    </span><span class="c1">// initrd åŠ è½½åœ°å€</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">ramdisk_size</span><span class="p">;</span><span class="w">     </span><span class="c1">// initrd å¤§å°</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">bootsect_kludge</span><span class="p">;</span><span class="w">  </span><span class="c1">// åºŸå¼ƒ</span>
<span class="w">    </span><span class="n">__u16</span><span class="w"> </span><span class="n">heap_end_ptr</span><span class="p">;</span><span class="w">     </span><span class="c1">// setup heap ç»“æŸä½ç½®</span>
<span class="w">    </span><span class="n">__u8</span><span class="w">  </span><span class="n">ext_loader_ver</span><span class="p">;</span><span class="w">   </span><span class="c1">// æ‰©å±•å¼•å¯¼å™¨ç‰ˆæœ¬</span>
<span class="w">    </span><span class="n">__u8</span><span class="w">  </span><span class="n">ext_loader_type</span><span class="p">;</span><span class="w">  </span><span class="c1">// æ‰©å±•å¼•å¯¼å™¨ç±»å‹</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">cmd_line_ptr</span><span class="p">;</span><span class="w">     </span><span class="c1">// å†…æ ¸å‘½ä»¤è¡Œåœ°å€</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">initrd_addr_max</span><span class="p">;</span><span class="w">  </span><span class="c1">// initrd æœ€é«˜åœ°å€</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">kernel_alignment</span><span class="p">;</span><span class="w"> </span><span class="c1">// å†…æ ¸å¯¹é½è¦æ±‚</span>
<span class="w">    </span><span class="n">__u8</span><span class="w">  </span><span class="n">relocatable_kernel</span><span class="p">;</span><span class="w"> </span><span class="c1">// å†…æ ¸æ˜¯å¦å¯é‡å®šä½</span>
<span class="w">    </span><span class="n">__u8</span><span class="w">  </span><span class="n">min_alignment</span><span class="p">;</span><span class="w">    </span><span class="c1">// æœ€å°å¯¹é½ï¼ˆ2^nï¼‰</span>
<span class="w">    </span><span class="n">__u16</span><span class="w"> </span><span class="n">xloadflags</span><span class="p">;</span><span class="w">       </span><span class="c1">// æ‰©å±•å¼•å¯¼æ ‡å¿—</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">cmdline_size</span><span class="p">;</span><span class="w">     </span><span class="c1">// å‘½ä»¤è¡Œæœ€å¤§é•¿åº¦</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">hardware_subarch</span><span class="p">;</span><span class="w"> </span><span class="c1">// ç¡¬ä»¶å­æ¶æ„</span>
<span class="w">    </span><span class="n">__u64</span><span class="w"> </span><span class="n">hardware_subarch_data</span><span class="p">;</span><span class="w"> </span><span class="c1">// å­æ¶æ„æ•°æ®æŒ‡é’ˆ</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">payload_offset</span><span class="p">;</span><span class="w">   </span><span class="c1">// å‹ç¼©è½½è·åç§»</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">payload_length</span><span class="p">;</span><span class="w">   </span><span class="c1">// å‹ç¼©è½½è·é•¿åº¦</span>
<span class="w">    </span><span class="n">__u64</span><span class="w"> </span><span class="n">setup_data</span><span class="p">;</span><span class="w">       </span><span class="c1">// setup_data é“¾è¡¨</span>
<span class="w">    </span><span class="n">__u64</span><span class="w"> </span><span class="n">pref_address</span><span class="p">;</span><span class="w">     </span><span class="c1">// é¦–é€‰åŠ è½½åœ°å€</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">init_size</span><span class="p">;</span><span class="w">        </span><span class="c1">// åˆå§‹åŒ–æ‰€éœ€å†…å­˜å¤§å°</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">handover_offset</span><span class="p">;</span><span class="w">  </span><span class="c1">// EFI handover åè®®å…¥å£</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="1622">16.2.2 è§£å‹è¿‡ç¨‹è¯¦è§£</h3>
<p>å†…æ ¸è§£å‹å‘ç”Ÿåœ¨ä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œä¸»è¦ä»£ç åœ¨ <code>arch/x86/boot/compressed/</code> ç›®å½•ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// arch/x86/boot/compressed/head_64.S</span>
<span class="nl">startup_64</span><span class="p">:</span>
<span class="w">    </span><span class="c1">// 1. æ¸…é™¤ BSS æ®µ</span>
<span class="w">    </span><span class="n">xorl</span><span class="w"> </span><span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">eax</span>
<span class="w">    </span><span class="n">leaq</span><span class="w"> </span><span class="n">_bss</span><span class="p">(</span><span class="o">%</span><span class="n">rip</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">rdi</span>
<span class="w">    </span><span class="n">leaq</span><span class="w"> </span><span class="n">_ebss</span><span class="p">(</span><span class="o">%</span><span class="n">rip</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">rcx</span>
<span class="w">    </span><span class="n">subq</span><span class="w"> </span><span class="o">%</span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rcx</span>
<span class="w">    </span><span class="n">shrq</span><span class="w"> </span><span class="n">$3</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rcx</span>
<span class="w">    </span><span class="n">rep</span><span class="w"> </span><span class="n">stosq</span>

<span class="w">    </span><span class="c1">// 2. å»ºç«‹èº«ä»½æ˜ å°„é¡µè¡¨</span>
<span class="w">    </span><span class="n">call</span><span class="w"> </span><span class="n">paging_prepare</span>

<span class="w">    </span><span class="c1">// 3. è°ƒç”¨ C è¯­è¨€è§£å‹å‡½æ•°</span>
<span class="w">    </span><span class="n">pushq</span><span class="w"> </span><span class="o">%</span><span class="n">rsi</span><span class="w">          </span><span class="c1">// boot_params æŒ‡é’ˆ</span>
<span class="w">    </span><span class="n">movq</span><span class="w"> </span><span class="o">%</span><span class="n">rsi</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rdi</span><span class="w">     </span><span class="c1">// ç¬¬ä¸€ä¸ªå‚æ•°</span>
<span class="w">    </span><span class="n">leaq</span><span class="w"> </span><span class="n">boot_heap</span><span class="p">(</span><span class="o">%</span><span class="n">rip</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">rsi</span><span class="w">  </span><span class="c1">// å †ç©ºé—´</span>
<span class="w">    </span><span class="n">call</span><span class="w"> </span><span class="n">extract_kernel</span>

<span class="w">    </span><span class="c1">// 4. è·³è½¬åˆ°è§£å‹åçš„å†…æ ¸</span>
<span class="w">    </span><span class="n">popq</span><span class="w"> </span><span class="o">%</span><span class="n">rsi</span>
<span class="w">    </span><span class="n">jmp</span><span class="w"> </span><span class="o">*%</span><span class="n">rax</span>
</code></pre></div>

<p>è§£å‹ç®—æ³•æ”¯æŒå¤šç§æ ¼å¼ï¼š</p>
<ul>
<li><strong>GZIP</strong>ï¼šé»˜è®¤é€‰æ‹©ï¼Œå‹ç¼©ç‡å’Œé€Ÿåº¦å¹³è¡¡</li>
<li><strong>BZIP2</strong>ï¼šæ›´å¥½çš„å‹ç¼©ç‡ï¼Œè§£å‹è¾ƒæ…¢</li>
<li><strong>LZMA/XZ</strong>ï¼šæœ€ä½³å‹ç¼©ç‡ï¼Œå†…å­˜éœ€æ±‚å¤§</li>
<li><strong>LZO/LZ4</strong>ï¼šå¿«é€Ÿè§£å‹ï¼Œé€‚åˆåµŒå…¥å¼ç³»ç»Ÿ</li>
</ul>
<h3 id="1623">16.2.3 æ—©æœŸå†…å­˜å¸ƒå±€</h3>
<p>è§£å‹åçš„å†…å­˜å¸ƒå±€ï¼ˆx86_64ï¼‰ï¼š</p>
<div class="codehilite"><pre><span></span><code>ç‰©ç†å†…å­˜å¸ƒå±€ï¼š
0x00000000 - 0x000FFFFF  å®æ¨¡å¼å†…å­˜ï¼ˆ1MBï¼‰
  0x00000000 - 0x000003FF  ä¸­æ–­å‘é‡è¡¨ï¼ˆIVTï¼‰
  0x00000400 - 0x000004FF  BIOS æ•°æ®åŒºï¼ˆBDAï¼‰
  0x00000500 - 0x00007BFF  å¯ç”¨å†…å­˜
  0x00007C00 - 0x00007DFF  MBR åŠ è½½åŒº
  0x00080000 - 0x0009FFFF  æ‰©å±• BIOS æ•°æ®åŒºï¼ˆEBDAï¼‰
  0x000A0000 - 0x000BFFFF  è§†é¢‘å†…å­˜
  0x000C0000 - 0x000FFFFF  BIOS ROM

0x00100000+              é«˜ç«¯å†…å­˜
  0x00100000              _textï¼ˆå†…æ ¸ä»£ç æ®µå¼€å§‹ï¼‰
  <span class="k">...</span>                     å†…æ ¸ä»£ç 
  _etext                  å†…æ ¸ä»£ç æ®µç»“æŸ
  <span class="k">...</span>                     å†…æ ¸æ•°æ®
  _edata                  åˆå§‹åŒ–æ•°æ®ç»“æŸ
  __bss_start             BSS æ®µå¼€å§‹
  _end                    å†…æ ¸é•œåƒç»“æŸ
</code></pre></div>

<h2 id="163">16.3 æ—©æœŸåˆå§‹åŒ–</h2>
<h3 id="1631-cpu">16.3.1 CPU æ¨¡å¼åˆ‡æ¢</h3>
<p>x86 å¤„ç†å™¨çš„æ¨¡å¼æ¼”è¿›è·¯å¾„ï¼š</p>
<div class="codehilite"><pre><span></span><code>å®æ¨¡å¼(16ä½) â†’ ä¿æŠ¤æ¨¡å¼(32ä½) â†’ é•¿æ¨¡å¼(64ä½)
    â†“              â†“                â†“
  20ä½åœ°å€      4GBåœ°å€ç©ºé—´      48ä½è™šæ‹Ÿåœ°å€
  1MBå†…å­˜       åˆ†æ®µ+åˆ†é¡µ        ä»…åˆ†é¡µ
  æ— ä¿æŠ¤        ç‰¹æƒçº§ä¿æŠ¤       NXä½æ”¯æŒ
</code></pre></div>

<p>å®æ¨¡å¼åˆ°ä¿æŠ¤æ¨¡å¼åˆ‡æ¢ï¼ˆarch/x86/boot/pm.cï¼‰ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// è®¾ç½® GDTï¼ˆå…¨å±€æè¿°ç¬¦è¡¨ï¼‰</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setup_gdt</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">boot_gdt</span><span class="p">[]</span><span class="w"> </span><span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="mi">16</span><span class="p">)))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">[</span><span class="n">GDT_ENTRY_BOOT_CS</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GDT_ENTRY</span><span class="p">(</span><span class="mh">0xc09b</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfffff</span><span class="p">),</span><span class="w">  </span><span class="c1">// ä»£ç æ®µ</span>
<span class="w">        </span><span class="p">[</span><span class="n">GDT_ENTRY_BOOT_DS</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GDT_ENTRY</span><span class="p">(</span><span class="mh">0xc093</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfffff</span><span class="p">),</span><span class="w">  </span><span class="c1">// æ•°æ®æ®µ</span>
<span class="w">        </span><span class="p">[</span><span class="n">GDT_ENTRY_BOOT_TSS</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GDT_ENTRY</span><span class="p">(</span><span class="mh">0x0089</span><span class="p">,</span><span class="w"> </span><span class="mi">4096</span><span class="p">,</span><span class="w"> </span><span class="mi">103</span><span class="p">),</span><span class="w">  </span><span class="c1">// TSS</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">gdt_ptr</span><span class="w"> </span><span class="n">gdt</span><span class="p">;</span>
<span class="w">    </span><span class="n">gdt</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">boot_gdt</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">gdt</span><span class="p">.</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">boot_gdt</span><span class="p">;</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;lgdtl %0&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;m&quot;</span><span class="w"> </span><span class="p">(</span><span class="n">gdt</span><span class="p">));</span>
<span class="p">}</span>

<span class="c1">// åˆ‡æ¢åˆ°ä¿æŠ¤æ¨¡å¼</span>
<span class="nl">protected_mode_jump</span><span class="p">:</span>
<span class="w">    </span><span class="n">movl</span><span class="w"> </span><span class="o">%</span><span class="n">cr0</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">eax</span>
<span class="w">    </span><span class="n">orb</span><span class="w"> </span><span class="n">$X86_CR0_PE</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">al</span><span class="w">    </span><span class="c1">// è®¾ç½® PE (Protection Enable) ä½</span>
<span class="w">    </span><span class="n">movl</span><span class="w"> </span><span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">cr0</span>
<span class="w">    </span><span class="n">ljmp</span><span class="w"> </span><span class="n">$</span><span class="err">\</span><span class="n">_</span><span class="err">\</span><span class="n">_BOOT</span><span class="err">\</span><span class="n">_CS</span><span class="p">,</span><span class="w"> </span><span class="n">$in_pm32</span><span class="w">  </span><span class="c1">// é•¿è·³è½¬åˆ·æ–° CS</span>
</code></pre></div>

<p>32ä½åˆ°64ä½é•¿æ¨¡å¼åˆ‡æ¢ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// arch/x86/boot/compressed/head_64.S</span>
<span class="nl">startup_32:</span>
<span class="w">    </span><span class="c1">// 1. æ£€æŸ¥ CPU æ˜¯å¦æ”¯æŒé•¿æ¨¡å¼</span>
<span class="w">    </span><span class="nf">movl</span><span class="w"> </span><span class="no">$0x80000001</span><span class="p">,</span><span class="w"> </span><span class="nv">%eax</span>
<span class="w">    </span><span class="nf">cpuid</span>
<span class="w">    </span><span class="nf">testl</span><span class="w"> </span><span class="no">$</span><span class="p">(</span><span class="mi">1</span><span class="err">&lt;&lt;</span><span class="mi">29</span><span class="p">),</span><span class="w"> </span><span class="nv">%edx</span><span class="w">    </span><span class="c1">// æ£€æŸ¥ LM (Long Mode) ä½</span>
<span class="w">    </span><span class="nf">jz</span><span class="w"> </span><span class="no">no_longmode</span>

<span class="w">    </span><span class="c1">// 2. è®¾ç½® PAEï¼ˆç‰©ç†åœ°å€æ‰©å±•ï¼‰</span>
<span class="w">    </span><span class="nf">movl</span><span class="w"> </span><span class="nv">%cr4</span><span class="p">,</span><span class="w"> </span><span class="nv">%eax</span>
<span class="w">    </span><span class="nf">orl</span><span class="w"> </span><span class="no">$X86_CR4_PAE</span><span class="p">,</span><span class="w"> </span><span class="nv">%eax</span>
<span class="w">    </span><span class="nf">movl</span><span class="w"> </span><span class="nv">%eax</span><span class="p">,</span><span class="w"> </span><span class="nv">%cr4</span>

<span class="w">    </span><span class="c1">// 3. åŠ è½½ PML4 é¡µè¡¨</span>
<span class="w">    </span><span class="nf">movl</span><span class="w"> </span><span class="no">$early_level4_pgt</span><span class="p">,</span><span class="w"> </span><span class="nv">%eax</span>
<span class="w">    </span><span class="nf">movl</span><span class="w"> </span><span class="nv">%eax</span><span class="p">,</span><span class="w"> </span><span class="nv">%cr3</span>

<span class="w">    </span><span class="c1">// 4. å¯ç”¨ EFER.LMEï¼ˆé•¿æ¨¡å¼ä½¿èƒ½ï¼‰</span>
<span class="w">    </span><span class="nf">movl</span><span class="w"> </span><span class="no">$MSR_EFER</span><span class="p">,</span><span class="w"> </span><span class="nv">%ecx</span>
<span class="w">    </span><span class="nf">rdmsr</span>
<span class="w">    </span><span class="nf">orl</span><span class="w"> </span><span class="no">$EFER_LME</span><span class="p">,</span><span class="w"> </span><span class="nv">%eax</span>
<span class="w">    </span><span class="nf">wrmsr</span>

<span class="w">    </span><span class="c1">// 5. å¯ç”¨åˆ†é¡µå’Œä¿æŠ¤æ¨¡å¼</span>
<span class="w">    </span><span class="nf">movl</span><span class="w"> </span><span class="nv">%cr0</span><span class="p">,</span><span class="w"> </span><span class="nv">%eax</span>
<span class="w">    </span><span class="nf">orl</span><span class="w"> </span><span class="no">$</span><span class="p">(</span><span class="no">X86_CR0_PG</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="no">X86_CR0_PE</span><span class="p">),</span><span class="w"> </span><span class="nv">%eax</span>
<span class="w">    </span><span class="nf">movl</span><span class="w"> </span><span class="nv">%eax</span><span class="p">,</span><span class="w"> </span><span class="nv">%cr0</span>

<span class="w">    </span><span class="c1">// 6. é•¿è·³è½¬è¿›å…¥64ä½æ¨¡å¼</span>
<span class="w">    </span><span class="nf">ljmp</span><span class="w"> </span><span class="no">$</span><span class="err">\</span><span class="no">_</span><span class="err">\</span><span class="no">_KERNEL</span><span class="err">\</span><span class="no">_CS</span><span class="p">,</span><span class="w"> </span><span class="no">$startup_64</span>
</code></pre></div>

<h3 id="1632">16.3.2 æ—©æœŸé¡µè¡¨å»ºç«‹</h3>
<p>Linux ä½¿ç”¨ 4 çº§é¡µè¡¨ï¼ˆx86_64ï¼‰ï¼š</p>
<div class="codehilite"><pre><span></span><code>è™šæ‹Ÿåœ°å€åˆ†è§£ï¼ˆ48ä½ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¦å·æ‰©å±•â”‚  PML4  â”‚  PDPT  â”‚   PD   â”‚   PT   â”‚  Offset  â”‚
â”‚ 16 bitsâ”‚ 9 bits â”‚ 9 bits â”‚ 9 bits â”‚ 9 bits â”‚ 12 bits  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“         â†“         â†“         â†“         â†“
        PML4E     PDPTE      PDE       PTE    ç‰©ç†é¡µå†…åç§»
</code></pre></div>

<p>æ—©æœŸé¡µè¡¨åˆå§‹åŒ–ï¼ˆarch/x86/kernel/head_64.Sï¼‰ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// æ—©æœŸé¡µè¡¨æ•°æ®ç»“æ„</span>
<span class="n">__INITDATA</span>
<span class="n">NEXT_PAGE</span><span class="p">(</span><span class="n">early_level4_pgt</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">quad</span><span class="w">   </span><span class="n">level3_ident_pgt</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">__START_KERNEL_map</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">_KERNPG_TABLE</span>
<span class="w">    </span><span class="p">.</span><span class="n">fill</span><span class="w">   </span><span class="mi">511</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">0</span>

<span class="n">NEXT_PAGE</span><span class="p">(</span><span class="n">level3_ident_pgt</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">quad</span><span class="w">   </span><span class="n">level2_ident_pgt</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">__START_KERNEL_map</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">_KERNPG_TABLE</span>
<span class="w">    </span><span class="p">.</span><span class="n">fill</span><span class="w">   </span><span class="mi">511</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">0</span>

<span class="n">NEXT_PAGE</span><span class="p">(</span><span class="n">level2_ident_pgt</span><span class="p">)</span>
<span class="w">    </span><span class="c1">// æ˜ å°„å‰ 1GB ç‰©ç†å†…å­˜ï¼ˆ2MB å¤§é¡µï¼‰</span>
<span class="w">    </span><span class="n">PMDS</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">__PAGE_KERNEL_IDENT_LARGE_EXEC</span><span class="p">,</span><span class="w"> </span><span class="n">PTRS_PER_PMD</span><span class="p">)</span>
</code></pre></div>

<p>åŠ¨æ€é¡µè¡¨å»ºç«‹æµç¨‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">early_alloc_pgt_buf</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">tables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">INIT_PGT_BUF_SIZE</span><span class="p">;</span>
<span class="w">    </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">base</span><span class="p">;</span>

<span class="w">    </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memblock_find_in_range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1ULL</span><span class="o">&lt;&lt;</span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="n">tables</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">base</span><span class="p">)</span>
<span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;Cannot find space for the kernel page tables&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="n">memblock_reserve</span><span class="p">(</span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">tables</span><span class="p">);</span>
<span class="w">    </span><span class="n">pgt_buf_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base</span><span class="p">;</span>
<span class="w">    </span><span class="n">pgt_buf_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tables</span><span class="p">;</span>
<span class="w">    </span><span class="n">pgt_buf_top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1633">16.3.3 ä¸­æ–­å’Œå¼‚å¸¸åˆå§‹åŒ–</h3>
<p>IDTï¼ˆä¸­æ–­æè¿°ç¬¦è¡¨ï¼‰è®¾ç½®ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// arch/x86/kernel/idt.c</span>
<span class="n">gate_desc</span><span class="w"> </span><span class="n">idt_table</span><span class="p">[</span><span class="n">IDT_ENTRIES</span><span class="p">]</span><span class="w"> </span><span class="n">__page_aligned_bss</span><span class="p">;</span>

<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">__initconst</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">idt_data</span><span class="w"> </span><span class="n">def_idts</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">INTG</span><span class="p">(</span><span class="n">X86_TRAP_DE</span><span class="p">,</span><span class="w">       </span><span class="n">divide_error</span><span class="p">),</span><span class="w">        </span><span class="c1">// é™¤é›¶å¼‚å¸¸</span>
<span class="w">    </span><span class="n">INTG</span><span class="p">(</span><span class="n">X86_TRAP_DB</span><span class="p">,</span><span class="w">       </span><span class="n">debug</span><span class="p">),</span><span class="w">               </span><span class="c1">// è°ƒè¯•å¼‚å¸¸</span>
<span class="w">    </span><span class="n">INTG</span><span class="p">(</span><span class="n">X86_TRAP_NMI</span><span class="p">,</span><span class="w">      </span><span class="n">nmi</span><span class="p">),</span><span class="w">                 </span><span class="c1">// ä¸å¯å±è”½ä¸­æ–­</span>
<span class="w">    </span><span class="n">INTG</span><span class="p">(</span><span class="n">X86_TRAP_BP</span><span class="p">,</span><span class="w">       </span><span class="n">int3</span><span class="p">),</span><span class="w">                </span><span class="c1">// æ–­ç‚¹</span>
<span class="w">    </span><span class="n">INTG</span><span class="p">(</span><span class="n">X86_TRAP_OF</span><span class="p">,</span><span class="w">       </span><span class="n">overflow</span><span class="p">),</span><span class="w">            </span><span class="c1">// æº¢å‡º</span>
<span class="w">    </span><span class="n">INTG</span><span class="p">(</span><span class="n">X86_TRAP_BR</span><span class="p">,</span><span class="w">       </span><span class="n">bounds</span><span class="p">),</span><span class="w">              </span><span class="c1">// è¾¹ç•Œæ£€æŸ¥</span>
<span class="w">    </span><span class="n">INTG</span><span class="p">(</span><span class="n">X86_TRAP_UD</span><span class="p">,</span><span class="w">       </span><span class="n">invalid_op</span><span class="p">),</span><span class="w">          </span><span class="c1">// æ— æ•ˆæ“ä½œç </span>
<span class="w">    </span><span class="n">INTG</span><span class="p">(</span><span class="n">X86_TRAP_NM</span><span class="p">,</span><span class="w">       </span><span class="n">device_not_available</span><span class="p">),</span><span class="w"> </span><span class="c1">// è®¾å¤‡ä¸å¯ç”¨</span>
<span class="w">    </span><span class="n">INTG</span><span class="p">(</span><span class="n">X86_TRAP_DF</span><span class="p">,</span><span class="w">       </span><span class="n">double_fault</span><span class="p">),</span><span class="w">        </span><span class="c1">// åŒé‡æ•…éšœ</span>
<span class="w">    </span><span class="n">INTG</span><span class="p">(</span><span class="n">X86_TRAP_OLD_MF</span><span class="p">,</span><span class="w">   </span><span class="n">coprocessor_segment_overrun</span><span class="p">),</span>
<span class="w">    </span><span class="n">INTG</span><span class="p">(</span><span class="n">X86_TRAP_TS</span><span class="p">,</span><span class="w">       </span><span class="n">invalid_TSS</span><span class="p">),</span><span class="w">         </span><span class="c1">// æ— æ•ˆ TSS</span>
<span class="w">    </span><span class="n">INTG</span><span class="p">(</span><span class="n">X86_TRAP_NP</span><span class="p">,</span><span class="w">       </span><span class="n">segment_not_present</span><span class="p">),</span><span class="w"> </span><span class="c1">// æ®µä¸å­˜åœ¨</span>
<span class="w">    </span><span class="n">INTG</span><span class="p">(</span><span class="n">X86_TRAP_SS</span><span class="p">,</span><span class="w">       </span><span class="n">stack_segment</span><span class="p">),</span><span class="w">       </span><span class="c1">// æ ˆæ®µé”™è¯¯</span>
<span class="w">    </span><span class="n">INTG</span><span class="p">(</span><span class="n">X86_TRAP_GP</span><span class="p">,</span><span class="w">       </span><span class="n">general_protection</span><span class="p">),</span><span class="w">  </span><span class="c1">// é€šç”¨ä¿æŠ¤</span>
<span class="w">    </span><span class="n">INTG</span><span class="p">(</span><span class="n">X86_TRAP_PF</span><span class="p">,</span><span class="w">       </span><span class="n">page_fault</span><span class="p">),</span><span class="w">          </span><span class="c1">// é¡µé¢é”™è¯¯</span>
<span class="w">    </span><span class="n">INTG</span><span class="p">(</span><span class="n">X86_TRAP_MF</span><span class="p">,</span><span class="w">       </span><span class="n">coprocessor_error</span><span class="p">),</span><span class="w">   </span><span class="c1">// åå¤„ç†å™¨é”™è¯¯</span>
<span class="w">    </span><span class="n">INTG</span><span class="p">(</span><span class="n">X86_TRAP_AC</span><span class="p">,</span><span class="w">       </span><span class="n">alignment_check</span><span class="p">),</span><span class="w">     </span><span class="c1">// å¯¹é½æ£€æŸ¥</span>
<span class="w">    </span><span class="n">INTG</span><span class="p">(</span><span class="n">X86_TRAP_MC</span><span class="p">,</span><span class="w">       </span><span class="n">machine_check</span><span class="p">),</span><span class="w">       </span><span class="c1">// æœºå™¨æ£€æŸ¥</span>
<span class="w">    </span><span class="n">INTG</span><span class="p">(</span><span class="n">X86_TRAP_XF</span><span class="p">,</span><span class="w">       </span><span class="n">simd_coprocessor_error</span><span class="p">),</span><span class="w"> </span><span class="c1">// SIMD å¼‚å¸¸</span>
<span class="p">};</span>

<span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">idt_setup_early_traps</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">idt_setup_from_table</span><span class="p">(</span><span class="n">idt_table</span><span class="p">,</span><span class="w"> </span><span class="n">early_idts</span><span class="p">,</span><span class="w"> </span>
<span class="w">                        </span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">early_idts</span><span class="p">),</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">    </span><span class="n">load_idt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idt_descr</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="164-start_kernel">16.4 start_kernel æµç¨‹åˆ†æ</h2>
<h3 id="1641-start_kernel">16.4.1 start_kernel æ€»ä½“æ¶æ„</h3>
<p><code>start_kernel()</code> æ˜¯å†…æ ¸ C ä»£ç çš„å…¥å£ç‚¹ï¼Œè´Ÿè´£åˆå§‹åŒ–æ‰€æœ‰æ ¸å¿ƒå­ç³»ç»Ÿï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// init/main.c</span>
<span class="n">asmlinkage</span><span class="w"> </span><span class="n">__visible</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="n">start_kernel</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">command_line</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">after_dashes</span><span class="p">;</span>

<span class="w">    </span><span class="n">set_task_stack_end_magic</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_task</span><span class="p">);</span><span class="w">  </span><span class="c1">// è®¾ç½®æ ˆé­”æ•°</span>
<span class="w">    </span><span class="n">smp_setup_processor_id</span><span class="p">();</span><span class="w">               </span><span class="c1">// è®¾ç½® CPU ID</span>
<span class="w">    </span><span class="n">debug_objects_early_init</span><span class="p">();</span><span class="w">             </span><span class="c1">// è°ƒè¯•å¯¹è±¡åˆå§‹åŒ–</span>

<span class="w">    </span><span class="n">cgroup_init_early</span><span class="p">();</span><span class="w">                    </span><span class="c1">// cgroup æ—©æœŸåˆå§‹åŒ–</span>

<span class="w">    </span><span class="n">local_irq_disable</span><span class="p">();</span><span class="w">                    </span><span class="c1">// ç¦ç”¨æœ¬åœ°ä¸­æ–­</span>
<span class="w">    </span><span class="n">early_boot_irqs_disabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// æ¶æ„ç›¸å…³çš„æ—©æœŸåˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">boot_cpu_init</span><span class="p">();</span>
<span class="w">    </span><span class="n">page_address_init</span><span class="p">();</span>
<span class="w">    </span><span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">linux_banner</span><span class="p">);</span><span class="w">          </span><span class="c1">// æ‰“å°å†…æ ¸ç‰ˆæœ¬</span>

<span class="w">    </span><span class="n">setup_arch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">command_line</span><span class="p">);</span><span class="w">              </span><span class="c1">// æ¶æ„ç›¸å…³è®¾ç½®</span>
<span class="w">    </span><span class="n">setup_command_line</span><span class="p">(</span><span class="n">command_line</span><span class="p">);</span><span class="w">       </span><span class="c1">// å¤„ç†å‘½ä»¤è¡Œå‚æ•°</span>
<span class="w">    </span><span class="n">setup_nr_cpu_ids</span><span class="p">();</span><span class="w">                     </span><span class="c1">// è®¾ç½® CPU æ•°é‡</span>
<span class="w">    </span><span class="n">setup_per_cpu_areas</span><span class="p">();</span><span class="w">                  </span><span class="c1">// è®¾ç½® per-CPU åŒºåŸŸ</span>

<span class="w">    </span><span class="n">smp_prepare_boot_cpu</span><span class="p">();</span><span class="w">                 </span><span class="c1">// å‡†å¤‡å¯åŠ¨ CPU</span>
<span class="w">    </span><span class="n">boot_cpu_hotplug_init</span><span class="p">();</span>

<span class="w">    </span><span class="n">build_all_zonelists</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span><span class="w">              </span><span class="c1">// æ„å»ºå†…å­˜åŒºåŸŸé“¾è¡¨</span>
<span class="w">    </span><span class="n">page_alloc_init</span><span class="p">();</span><span class="w">                      </span><span class="c1">// é¡µåˆ†é…å™¨åˆå§‹åŒ–</span>

<span class="w">    </span><span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;Kernel command line: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">saved_command_line</span><span class="p">);</span>

<span class="w">    </span><span class="n">parse_early_param</span><span class="p">();</span><span class="w">                    </span><span class="c1">// è§£ææ—©æœŸå‚æ•°</span>
<span class="w">    </span><span class="n">after_dashes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse_args</span><span class="p">(</span><span class="s">&quot;Booting kernel&quot;</span><span class="p">,</span>
<span class="w">                             </span><span class="n">static_command_line</span><span class="p">,</span><span class="w"> </span><span class="n">__start___param</span><span class="p">,</span>
<span class="w">                             </span><span class="n">__stop___param</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">__start___param</span><span class="p">,</span>
<span class="w">                             </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">unknown_bootoption</span><span class="p">);</span>

<span class="w">    </span><span class="n">jump_label_init</span><span class="p">();</span><span class="w">                      </span><span class="c1">// é™æ€é”®åˆå§‹åŒ–</span>

<span class="w">    </span><span class="n">setup_log_buf</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w">                       </span><span class="c1">// è®¾ç½®æ—¥å¿—ç¼“å†²åŒº</span>
<span class="w">    </span><span class="n">vfs_caches_init_early</span><span class="p">();</span><span class="w">                </span><span class="c1">// VFS ç¼“å­˜æ—©æœŸåˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">sort_main_extable</span><span class="p">();</span><span class="w">                    </span><span class="c1">// æ’åºå¼‚å¸¸è¡¨</span>
<span class="w">    </span><span class="n">trap_init</span><span class="p">();</span><span class="w">                            </span><span class="c1">// é™·é˜±é—¨åˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">mm_init</span><span class="p">();</span><span class="w">                              </span><span class="c1">// å†…å­˜ç®¡ç†åˆå§‹åŒ–</span>

<span class="w">    </span><span class="n">ftrace_init</span><span class="p">();</span><span class="w">                          </span><span class="c1">// å‡½æ•°è·Ÿè¸ªåˆå§‹åŒ–</span>

<span class="w">    </span><span class="n">sched_init</span><span class="p">();</span><span class="w">                           </span><span class="c1">// è°ƒåº¦å™¨åˆå§‹åŒ–</span>

<span class="w">    </span><span class="n">preempt_disable</span><span class="p">();</span><span class="w">                      </span><span class="c1">// ç¦ç”¨æŠ¢å </span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">WARN</span><span class="p">(</span><span class="o">!</span><span class="n">irqs_disabled</span><span class="p">(),</span>
<span class="w">         </span><span class="s">&quot;Interrupts were enabled early</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">))</span>
<span class="w">        </span><span class="n">local_irq_disable</span><span class="p">();</span>
<span class="w">    </span><span class="n">early_boot_irqs_disabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="n">local_irq_enable</span><span class="p">();</span><span class="w">                     </span><span class="c1">// å¯ç”¨ä¸­æ–­</span>

<span class="w">    </span><span class="n">kmem_cache_init_late</span><span class="p">();</span><span class="w">                 </span><span class="c1">// slab åæœŸåˆå§‹åŒ–</span>

<span class="w">    </span><span class="n">console_init</span><span class="p">();</span><span class="w">                         </span><span class="c1">// æ§åˆ¶å°åˆå§‹åŒ–</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">panic_later</span><span class="p">)</span>
<span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;Too many boot %s vars at `%s&#39;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">panic_later</span><span class="p">,</span>
<span class="w">              </span><span class="n">panic_param</span><span class="p">);</span>

<span class="w">    </span><span class="n">lockdep_init</span><span class="p">();</span><span class="w">                         </span><span class="c1">// é”ä¾èµ–åˆå§‹åŒ–</span>

<span class="w">    </span><span class="n">locking_selftest</span><span class="p">();</span><span class="w">                     </span><span class="c1">// é”è‡ªæµ‹</span>

<span class="w">    </span><span class="n">mem_encrypt_init</span><span class="p">();</span><span class="w">                     </span><span class="c1">// å†…å­˜åŠ å¯†åˆå§‹åŒ–</span>

<span class="w">    </span><span class="cp">#ifdef CONFIG_BLK_DEV_INITRD</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">initrd_start</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">initrd_below_start_ok</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="n">page_to_pfn</span><span class="p">(</span><span class="n">virt_to_page</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">initrd_start</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">min_low_pfn</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pr_crit</span><span class="p">(</span><span class="s">&quot;initrd overwritten (0x%08lx &lt; 0x%08lx) - disabling it.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">page_to_pfn</span><span class="p">(</span><span class="n">virt_to_page</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">initrd_start</span><span class="p">)),</span>
<span class="w">            </span><span class="n">min_low_pfn</span><span class="p">);</span>
<span class="w">        </span><span class="n">initrd_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="cp">#endif</span>

<span class="w">    </span><span class="n">setup_per_cpu_pageset</span><span class="p">();</span><span class="w">                </span><span class="c1">// è®¾ç½® per-CPU é¡µé›†</span>
<span class="w">    </span><span class="n">numa_policy_init</span><span class="p">();</span><span class="w">                     </span><span class="c1">// NUMA ç­–ç•¥åˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">acpi_early_init</span><span class="p">();</span><span class="w">                      </span><span class="c1">// ACPI æ—©æœŸåˆå§‹åŒ–</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">late_time_init</span><span class="p">)</span>
<span class="w">        </span><span class="n">late_time_init</span><span class="p">();</span>
<span class="w">    </span><span class="n">sched_clock_init</span><span class="p">();</span><span class="w">                     </span><span class="c1">// è°ƒåº¦æ—¶é’Ÿåˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">calibrate_delay</span><span class="p">();</span><span class="w">                      </span><span class="c1">// æ ¡å‡†å»¶è¿Ÿå¾ªç¯</span>
<span class="w">    </span><span class="n">pid_idr_init</span><span class="p">();</span><span class="w">                         </span><span class="c1">// PID IDR åˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">anon_vma_init</span><span class="p">();</span><span class="w">                        </span><span class="c1">// åŒ¿å VMA åˆå§‹åŒ–</span>
<span class="w">    </span><span class="cp">#ifdef CONFIG_X86</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">efi_enabled</span><span class="p">(</span><span class="n">EFI_RUNTIME_SERVICES</span><span class="p">))</span>
<span class="w">        </span><span class="n">efi_enter_virtual_mode</span><span class="p">();</span><span class="w">           </span><span class="c1">// EFI è™šæ‹Ÿæ¨¡å¼</span>
<span class="w">    </span><span class="cp">#endif</span>
<span class="w">    </span><span class="n">thread_stack_cache_init</span><span class="p">();</span><span class="w">              </span><span class="c1">// çº¿ç¨‹æ ˆç¼“å­˜åˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">cred_init</span><span class="p">();</span><span class="w">                            </span><span class="c1">// å‡­è¯åˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">fork_init</span><span class="p">();</span><span class="w">                            </span><span class="c1">// fork åˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">proc_caches_init</span><span class="p">();</span><span class="w">                     </span><span class="c1">// è¿›ç¨‹ç¼“å­˜åˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">uts_ns_init</span><span class="p">();</span><span class="w">                          </span><span class="c1">// UTS å‘½åç©ºé—´åˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">buffer_init</span><span class="p">();</span><span class="w">                          </span><span class="c1">// ç¼“å†²åŒºåˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">key_init</span><span class="p">();</span><span class="w">                             </span><span class="c1">// å¯†é’¥ç®¡ç†åˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">security_init</span><span class="p">();</span><span class="w">                        </span><span class="c1">// å®‰å…¨æ¨¡å—åˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">dbg_late_init</span><span class="p">();</span><span class="w">                        </span><span class="c1">// è°ƒè¯•åæœŸåˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">vfs_caches_init</span><span class="p">();</span><span class="w">                      </span><span class="c1">// VFS ç¼“å­˜åˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">pagecache_init</span><span class="p">();</span><span class="w">                       </span><span class="c1">// é¡µç¼“å­˜åˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">signals_init</span><span class="p">();</span><span class="w">                         </span><span class="c1">// ä¿¡å·åˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">seq_file_init</span><span class="p">();</span><span class="w">                        </span><span class="c1">// seq_file åˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">proc_root_init</span><span class="p">();</span><span class="w">                       </span><span class="c1">// proc æ ¹ç›®å½•åˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">nsfs_init</span><span class="p">();</span><span class="w">                            </span><span class="c1">// å‘½åç©ºé—´æ–‡ä»¶ç³»ç»Ÿåˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">cpuset_init</span><span class="p">();</span><span class="w">                          </span><span class="c1">// cpuset åˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">cgroup_init</span><span class="p">();</span><span class="w">                          </span><span class="c1">// cgroup åˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">taskstats_init_early</span><span class="p">();</span><span class="w">                 </span><span class="c1">// ä»»åŠ¡ç»Ÿè®¡åˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">delayacct_init</span><span class="p">();</span><span class="w">                       </span><span class="c1">// å»¶è¿Ÿç»Ÿè®¡åˆå§‹åŒ–</span>

<span class="w">    </span><span class="n">poking_init</span><span class="p">();</span><span class="w">                          </span><span class="c1">// ä»£ç ä¿®æ”¹åˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">check_bugs</span><span class="p">();</span><span class="w">                           </span><span class="c1">// æ£€æŸ¥ CPU ç¼ºé™·</span>

<span class="w">    </span><span class="n">acpi_subsystem_init</span><span class="p">();</span><span class="w">                  </span><span class="c1">// ACPI å­ç³»ç»Ÿåˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">arch_post_acpi_subsys_init</span><span class="p">();</span><span class="w">           </span><span class="c1">// æ¶æ„ ACPI ååˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">sfi_init_late</span><span class="p">();</span><span class="w">                        </span><span class="c1">// SFI åæœŸåˆå§‹åŒ–</span>

<span class="w">    </span><span class="cm">/* å®Œæˆè°ƒåº¦å™¨åˆå§‹åŒ– */</span>
<span class="w">    </span><span class="n">scheduler_enable</span><span class="p">();</span>

<span class="w">    </span><span class="cm">/* æ‰§è¡Œæ‰€æœ‰ initcall */</span>
<span class="w">    </span><span class="n">rest_init</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1642">16.4.2 å…³é”®å­ç³»ç»Ÿåˆå§‹åŒ–é¡ºåº</h3>
<p>åˆå§‹åŒ–é¡ºåºçš„ä¾èµ–å…³ç³»ï¼š</p>
<div class="codehilite"><pre><span></span><code>å†…å­˜ç®¡ç†åŸºç¡€è®¾æ–½
    â†“
ä¸­æ–­å’Œå¼‚å¸¸å¤„ç†
    â†“
è°ƒåº¦å™¨æ ¸å¿ƒ
    â†“
æ—¶é’Ÿå’Œå®šæ—¶å™¨
    â†“
è¿›ç¨‹ç®¡ç†
    â†“
æ–‡ä»¶ç³»ç»Ÿ
    â†“
è®¾å¤‡é©±åŠ¨
</code></pre></div>

<p>å…³é”®åˆå§‹åŒ–å‡½æ•°è¯¦è§£ï¼š</p>
<ol>
<li><strong>mm_init() - å†…å­˜ç®¡ç†åˆå§‹åŒ–</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">mm_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">page_ext_init_flatmem</span><span class="p">();</span><span class="w">    </span><span class="c1">// é¡µæ‰©å±•åˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">mem_init</span><span class="p">();</span><span class="w">                  </span><span class="c1">// æ¶æ„ç›¸å…³å†…å­˜åˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">kmem_cache_init</span><span class="p">();</span><span class="w">          </span><span class="c1">// slab åˆ†é…å™¨åˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">pgtable_init</span><span class="p">();</span><span class="w">             </span><span class="c1">// é¡µè¡¨ç¼“å­˜åˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">vmalloc_init</span><span class="p">();</span><span class="w">             </span><span class="c1">// vmalloc åŒºåŸŸåˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">ioremap_huge_init</span><span class="p">();</span><span class="w">        </span><span class="c1">// å¤§é¡µ ioremap åˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">kaslr_late_init</span><span class="p">();</span><span class="w">          </span><span class="c1">// KASLR åæœŸåˆå§‹åŒ–</span>
<span class="p">}</span>
</code></pre></div>

<ol start="2">
<li><strong>sched_init() - è°ƒåº¦å™¨åˆå§‹åŒ–</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">sched_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">alloc_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ptr</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// åˆå§‹åŒ–ç­‰å¾…é˜Ÿåˆ—</span>
<span class="w">    </span><span class="n">wait_bit_init</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// åˆ†é…è°ƒåº¦åŸŸæ‹“æ‰‘</span>
<span class="w">    </span><span class="n">alloc_size</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">nr_cpu_ids</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// åˆ†é…æ ¹åŸŸ</span>
<span class="w">    </span><span class="n">alloc_size</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">nr_cpu_ids</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">alloc_size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">kzalloc</span><span class="p">(</span><span class="n">alloc_size</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_NOWAIT</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// è®¾ç½®å„ç§æŒ‡é’ˆ...</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">init_rt_bandwidth</span><span class="p">(</span><span class="o">&amp;</span><span class="n">def_rt_bandwidth</span><span class="p">,</span><span class="w"> </span><span class="n">global_rt_period</span><span class="p">(),</span><span class="w"> </span><span class="n">global_rt_runtime</span><span class="p">());</span>

<span class="w">    </span><span class="c1">// åˆå§‹åŒ–æ¯ä¸ª CPU çš„è¿è¡Œé˜Ÿåˆ—</span>
<span class="w">    </span><span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">rq</span><span class="w"> </span><span class="o">*</span><span class="n">rq</span><span class="p">;</span>

<span class="w">        </span><span class="n">rq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpu_rq</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="w">        </span><span class="n">raw_spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="w">        </span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">nr_running</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">calc_load_active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">calc_load_update</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jiffies</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">LOAD_FREQ</span><span class="p">;</span>
<span class="w">        </span><span class="n">init_cfs_rq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cfs</span><span class="p">);</span><span class="w">          </span><span class="c1">// CFS è¿è¡Œé˜Ÿåˆ—</span>
<span class="w">        </span><span class="n">init_rt_rq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">rt</span><span class="p">);</span><span class="w">            </span><span class="c1">// RT è¿è¡Œé˜Ÿåˆ—</span>
<span class="w">        </span><span class="n">init_dl_rq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">dl</span><span class="p">);</span><span class="w">            </span><span class="c1">// Deadline è¿è¡Œé˜Ÿåˆ—</span>

<span class="w">        </span><span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">leaf_cfs_rq_list</span><span class="p">);</span>
<span class="w">        </span><span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">leaf_rt_rq_list</span><span class="p">);</span>

<span class="w">        </span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">        </span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">online</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">idle_stamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">avg_idle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">sysctl_sched_migration_cost</span><span class="p">;</span>
<span class="w">        </span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">max_idle_balance_cost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sysctl_sched_migration_cost</span><span class="p">;</span>

<span class="w">        </span><span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cfs_tasks</span><span class="p">);</span>

<span class="w">        </span><span class="n">rq_attach_root</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">def_root_domain</span><span class="p">);</span>

<span class="w">        </span><span class="cp">#ifdef CONFIG_NO_HZ_COMMON</span>
<span class="w">        </span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">nohz_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="cp">#endif</span>

<span class="w">        </span><span class="cp">#ifdef CONFIG_NO_HZ_FULL</span>
<span class="w">        </span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">last_sched_tick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="cp">#endif</span>

<span class="w">        </span><span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">nr_iowait</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">set_load_weight</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_task</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span><span class="w">    </span><span class="c1">// è®¾ç½® init ä»»åŠ¡æƒé‡</span>

<span class="w">    </span><span class="c1">// åˆå§‹åŒ– CPU ä¼˜å…ˆçº§æ˜ å°„</span>
<span class="w">    </span><span class="n">init_cpu_present</span><span class="p">(</span><span class="n">cpu_possible_mask</span><span class="p">);</span>
<span class="w">    </span><span class="n">init_cpu_online</span><span class="p">(</span><span class="n">cpu_possible_mask</span><span class="p">);</span>

<span class="w">    </span><span class="n">scheduler_running</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">                  </span><span class="c1">// æ ‡è®°è°ƒåº¦å™¨è¿è¡Œ</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1643-rest_init">16.4.3 rest_init ä¸å†…æ ¸çº¿ç¨‹åˆ›å»º</h3>
<p><code>rest_init()</code> åˆ›å»ºç¬¬ä¸€æ‰¹å†…æ ¸çº¿ç¨‹å¹¶åˆ‡æ¢åˆ°ç”¨æˆ·ç©ºé—´ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">noinline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__ref</span><span class="w"> </span><span class="n">rest_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">tsk</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">;</span>

<span class="w">    </span><span class="n">rcu_scheduler_starting</span><span class="p">();</span><span class="w">       </span><span class="c1">// RCU è°ƒåº¦å™¨å¯åŠ¨</span>

<span class="w">    </span><span class="cm">/*</span>

<span class="cm">     * åˆ›å»º kernel_init çº¿ç¨‹ï¼ˆPID 1ï¼‰</span>
<span class="cm">     * è¿™å°†æˆä¸ºæ‰€æœ‰ç”¨æˆ·è¿›ç¨‹çš„ç¥–å…ˆ</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernel_thread</span><span class="p">(</span><span class="n">kernel_init</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">CLONE_FS</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;Failed to create kernel_init thread&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/*</span>

<span class="cm">     * åˆ›å»º kthreadd çº¿ç¨‹ï¼ˆPID 2ï¼‰</span>
<span class="cm">     * è´Ÿè´£åˆ›å»ºå…¶ä»–å†…æ ¸çº¿ç¨‹</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernel_thread</span><span class="p">(</span><span class="n">kthreadd</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">CLONE_FS</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">CLONE_FILES</span><span class="p">);</span>
<span class="w">    </span><span class="n">kthreadd_task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">find_task_by_pid_ns</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">init_pid_ns</span><span class="p">);</span>

<span class="w">    </span><span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kthreadd_done</span><span class="p">);</span><span class="w">       </span><span class="c1">// é€šçŸ¥ kthreadd åˆ›å»ºå®Œæˆ</span>

<span class="w">    </span><span class="cm">/*</span>

<span class="cm">     * å½“å‰ä»»åŠ¡ï¼ˆPID 0ï¼‰å°†æˆä¸º idle è¿›ç¨‹</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">init_idle_bootup_task</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
<span class="w">    </span><span class="n">schedule_preempt_disabled</span><span class="p">();</span><span class="w">    </span><span class="c1">// å¼€å§‹è°ƒåº¦</span>

<span class="w">    </span><span class="cm">/* è°ƒç”¨ cpu_idle å¾ªç¯ */</span>
<span class="w">    </span><span class="n">cpu_startup_entry</span><span class="p">(</span><span class="n">CPUHP_ONLINE</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="165-initcall">16.5 initcall æœºåˆ¶</h2>
<h3 id="1651-initcall">16.5.1 initcall çº§åˆ«ä½“ç³»</h3>
<p>Linux ä½¿ç”¨ initcall æœºåˆ¶æ¥ç®¡ç†é©±åŠ¨å’Œæ¨¡å—çš„åˆå§‹åŒ–é¡ºåºã€‚initcall åˆ†ä¸ºå¤šä¸ªçº§åˆ«ï¼Œç¡®ä¿ä¾èµ–å…³ç³»æ­£ç¡®ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// include/linux/init.h</span>
<span class="k">typedef</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">initcall_t</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/* initcall çº§åˆ«å®šä¹‰ */</span>
<span class="cp">#define pure_initcall(fn)       __define_initcall(fn, 0)  </span><span class="c1">// çº¯åˆå§‹åŒ–</span>
<span class="cp">#define core_initcall(fn)       __define_initcall(fn, 1)  </span><span class="c1">// æ ¸å¿ƒåˆå§‹åŒ–</span>
<span class="cp">#define core_initcall_sync(fn)  __define_initcall(fn, 1s) </span><span class="c1">// æ ¸å¿ƒåŒæ­¥</span>
<span class="cp">#define postcore_initcall(fn)   __define_initcall(fn, 2)  </span><span class="c1">// æ ¸å¿ƒå</span>
<span class="cp">#define postcore_initcall_sync(fn) __define_initcall(fn, 2s)</span>
<span class="cp">#define arch_initcall(fn)       __define_initcall(fn, 3)  </span><span class="c1">// æ¶æ„ç›¸å…³</span>
<span class="cp">#define arch_initcall_sync(fn)  __define_initcall(fn, 3s)</span>
<span class="cp">#define subsys_initcall(fn)     __define_initcall(fn, 4)  </span><span class="c1">// å­ç³»ç»Ÿ</span>
<span class="cp">#define subsys_initcall_sync(fn) __define_initcall(fn, 4s)</span>
<span class="cp">#define fs_initcall(fn)         __define_initcall(fn, 5)  </span><span class="c1">// æ–‡ä»¶ç³»ç»Ÿ</span>
<span class="cp">#define fs_initcall_sync(fn)    __define_initcall(fn, 5s)</span>
<span class="cp">#define device_initcall(fn)     __define_initcall(fn, 6)  </span><span class="c1">// è®¾å¤‡é©±åŠ¨</span>
<span class="cp">#define device_initcall_sync(fn) __define_initcall(fn, 6s)</span>
<span class="cp">#define late_initcall(fn)       __define_initcall(fn, 7)  </span><span class="c1">// åæœŸåˆå§‹åŒ–</span>
<span class="cp">#define late_initcall_sync(fn)  __define_initcall(fn, 7s)</span>

<span class="cm">/* module_init å®é™…ä¸Šæ˜¯ device_initcall */</span>
<span class="cp">#define module_init(x)  __initcall(x);</span>
</code></pre></div>

<p>initcall æ‰§è¡Œé¡ºåºï¼š</p>
<div class="codehilite"><pre><span></span><code>    0. pure_initcall        æœ€æ—©æ‰§è¡Œï¼ŒåŸºç¡€è®¾æ–½
    1. core_initcall        æ ¸å¿ƒç»„ä»¶
    2. postcore_initcall    æ ¸å¿ƒç»„ä»¶ä¹‹å
    3. arch_initcall        æ¶æ„ç‰¹å®šä»£ç 
    4. subsys_initcall      å­ç³»ç»Ÿï¼ˆæ€»çº¿ã€ç”µæºç®¡ç†ç­‰ï¼‰
    5. fs_initcall          æ–‡ä»¶ç³»ç»Ÿ
    6. device_initcall      è®¾å¤‡é©±åŠ¨ï¼ˆmodule_initï¼‰
    7. late_initcall        æœ€åçš„åˆå§‹åŒ–
</code></pre></div>

<h3 id="1652-initcall">16.5.2 initcall å®ç°æœºåˆ¶</h3>
<p>initcall é€šè¿‡ç‰¹æ®Šçš„é“¾æ¥å™¨è„šæœ¬æ®µå®ç°ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// include/asm-generic/vmlinux.lds.h</span>
<span class="cp">#define INIT_CALLS_LEVEL(level)                     \</span>
<span class="cp">    __initcall##level##_start = .;                  \</span>
<span class="cp">    KEEP(*(.initcall##level##.init))               \</span>
<span class="cp">    KEEP(*(.initcall##level##s.init))              \</span>

<span class="cp">#define INIT_CALLS                                   \</span>
<span class="cp">    __initcall_start = .;                          \</span>
<span class="cp">    KEEP(*(.initcallearly.init))                   \</span>
<span class="cp">    INIT_CALLS_LEVEL(0)                            \</span>
<span class="cp">    INIT_CALLS_LEVEL(1)                            \</span>
<span class="cp">    INIT_CALLS_LEVEL(2)                            \</span>
<span class="cp">    INIT_CALLS_LEVEL(3)                            \</span>
<span class="cp">    INIT_CALLS_LEVEL(4)                            \</span>
<span class="cp">    INIT_CALLS_LEVEL(5)                            \</span>
<span class="cp">    INIT_CALLS_LEVEL(rootfs)                       \</span>
<span class="cp">    INIT_CALLS_LEVEL(6)                            \</span>
<span class="cp">    INIT_CALLS_LEVEL(7)                            \</span>
<span class="cp">    __initcall_end = .;</span>
</code></pre></div>

<p>å®å±•å¼€ç¤ºä¾‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// é©±åŠ¨ä»£ç </span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">my_driver_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">my_driver_init</span><span class="p">);</span>

<span class="c1">// å±•å¼€å</span>
<span class="k">static</span><span class="w"> </span><span class="n">initcall_t</span><span class="w"> </span><span class="n">__initcall_my_driver_init6</span><span class="w"> </span>
<span class="w">    </span><span class="n">__used</span><span class="w"> </span><span class="n">__attribute__</span><span class="p">((</span><span class="n">__section__</span><span class="p">(</span><span class="s">&quot;.initcall6.init&quot;</span><span class="p">)))</span><span class="w"> </span>
<span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">my_driver_init</span><span class="p">;</span>
</code></pre></div>

<h3 id="1653-do_initcalls">16.5.3 do_initcalls æ‰§è¡Œæµç¨‹</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// init/main.c</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">do_initcalls</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">level</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">initcall_levels</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">level</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="n">do_initcall_level</span><span class="p">(</span><span class="n">level</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">do_initcall_level</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">initcall_entry_t</span><span class="w"> </span><span class="o">*</span><span class="n">fn</span><span class="p">;</span>

<span class="w">    </span><span class="n">strcpy</span><span class="p">(</span><span class="n">initcall_command_line</span><span class="p">,</span><span class="w"> </span><span class="n">saved_command_line</span><span class="p">);</span>
<span class="w">    </span><span class="n">parse_args</span><span class="p">(</span><span class="n">initcall_level_names</span><span class="p">[</span><span class="n">level</span><span class="p">],</span>
<span class="w">               </span><span class="n">initcall_command_line</span><span class="p">,</span><span class="w"> </span><span class="n">__start___param</span><span class="p">,</span>
<span class="w">               </span><span class="n">__stop___param</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">__start___param</span><span class="p">,</span>
<span class="w">               </span><span class="n">level</span><span class="p">,</span><span class="w"> </span><span class="n">level</span><span class="p">,</span>
<span class="w">               </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">ignore_unknown_bootoption</span><span class="p">);</span>

<span class="w">    </span><span class="n">trace_initcall_level</span><span class="p">(</span><span class="n">initcall_level_names</span><span class="p">[</span><span class="n">level</span><span class="p">]);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">fn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">initcall_levels</span><span class="p">[</span><span class="n">level</span><span class="p">];</span><span class="w"> </span><span class="n">fn</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">initcall_levels</span><span class="p">[</span><span class="n">level</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span><span class="w"> </span><span class="n">fn</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="n">do_one_initcall</span><span class="p">(</span><span class="n">initcall_from_entry</span><span class="p">(</span><span class="n">fn</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="n">__init_or_module</span><span class="w"> </span><span class="nf">do_one_initcall</span><span class="p">(</span><span class="n">initcall_t</span><span class="w"> </span><span class="n">fn</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">preempt_count</span><span class="p">();</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">msgbuf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">initcall_blacklisted</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

<span class="w">    </span><span class="n">trace_initcall_start</span><span class="p">(</span><span class="n">fn</span><span class="p">);</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fn</span><span class="p">();</span>
<span class="w">    </span><span class="n">trace_initcall_finish</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span>

<span class="w">    </span><span class="n">msgbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">preempt_count</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">count</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">sprintf</span><span class="p">(</span><span class="n">msgbuf</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;preemption imbalance &quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">preempt_count_set</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">irqs_disabled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">strlcat</span><span class="p">(</span><span class="n">msgbuf</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;disabled interrupts &quot;</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">msgbuf</span><span class="p">));</span>
<span class="w">        </span><span class="n">local_irq_enable</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">WARN</span><span class="p">(</span><span class="n">msgbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;initcall %pS returned with %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fn</span><span class="p">,</span><span class="w"> </span><span class="n">msgbuf</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1654">16.5.4 ä¾èµ–ç®¡ç†ä¸è°ƒè¯•</h3>
<p>initcall è°ƒè¯•å‚æ•°ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># å†…æ ¸å‘½ä»¤è¡Œå‚æ•°</span>
<span class="nv">initcall_debug</span><span class="o">=</span><span class="m">1</span><span class="w">        </span><span class="c1"># æ‰“å°æ¯ä¸ª initcall çš„æ‰§è¡Œæ—¶é—´</span>
<span class="nv">initcall_blacklist</span><span class="o">=</span>foo_init,bar_init<span class="w">  </span><span class="c1"># é»‘åå•ç‰¹å®š initcall</span>
</code></pre></div>

<p>ä¾èµ–å£°æ˜ç¤ºä¾‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä½¿ç”¨ module_param å£°æ˜ä¾èµ–</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">depends_on_foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">depends_on_foo</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">my_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">depends_on_foo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Waiting for foo module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EPROBE_DEFER</span><span class="p">;</span><span class="w">  </span><span class="c1">// å»¶è¿Ÿæ¢æµ‹</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// æ­£å¸¸åˆå§‹åŒ–</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="166-systemd">16.6 systemd ä¸ç”¨æˆ·ç©ºé—´å¯åŠ¨</h2>
<h3 id="1661-kernel_init">16.6.1 kernel_init è¿›ç¨‹</h3>
<p>kernel_init (PID 1) æ˜¯æ‰€æœ‰ç”¨æˆ·ç©ºé—´è¿›ç¨‹çš„ç¥–å…ˆï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__ref</span><span class="w"> </span><span class="nf">kernel_init</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">    </span><span class="n">kernel_init_freeable</span><span class="p">();</span><span class="w">  </span><span class="c1">// æ‰§è¡Œå¯é‡Šæ”¾çš„åˆå§‹åŒ–</span>

<span class="w">    </span><span class="cm">/* éœ€è¦åœ¨é‡Šæ”¾å†…å­˜å‰å®Œæˆæ‰€æœ‰å¼‚æ­¥è°ƒç”¨ */</span>
<span class="w">    </span><span class="n">async_synchronize_full</span><span class="p">();</span>

<span class="w">    </span><span class="n">kprobe_free_init_mem</span><span class="p">();</span>
<span class="w">    </span><span class="n">ftrace_free_init_mem</span><span class="p">();</span>
<span class="w">    </span><span class="n">free_initmem</span><span class="p">();</span><span class="w">          </span><span class="c1">// é‡Šæ”¾ __init æ®µå†…å­˜</span>

<span class="w">    </span><span class="n">mark_readonly</span><span class="p">();</span>

<span class="w">    </span><span class="cm">/*</span>

<span class="cm">     * Kernel mappings are now finalized - update the userspace</span>
<span class="cm">     * page-table to finalize PTI.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">pti_finalize</span><span class="p">();</span>

<span class="w">    </span><span class="n">system_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SYSTEM_RUNNING</span><span class="p">;</span>
<span class="w">    </span><span class="n">numa_default_policy</span><span class="p">();</span>

<span class="w">    </span><span class="n">rcu_end_inkernel_boot</span><span class="p">();</span>

<span class="w">    </span><span class="n">do_sysctl_args</span><span class="p">();</span><span class="w">        </span><span class="c1">// å¤„ç† sysctl å‚æ•°</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ramdisk_execute_command</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">run_init_process</span><span class="p">(</span><span class="n">ramdisk_execute_command</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to execute %s (error %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">               </span><span class="n">ramdisk_execute_command</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/*</span>

<span class="cm">     * å°è¯•è¿è¡Œ init è¿›ç¨‹</span>
<span class="cm">     * æŒ‰é¡ºåºå°è¯•ä¸åŒçš„è·¯å¾„</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">execute_command</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">run_init_process</span><span class="p">(</span><span class="n">execute_command</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;Requested init %s failed (error %d).&quot;</span><span class="p">,</span>
<span class="w">              </span><span class="n">execute_command</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">try_to_run_init_process</span><span class="p">(</span><span class="s">&quot;/sbin/init&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="o">!</span><span class="n">try_to_run_init_process</span><span class="p">(</span><span class="s">&quot;/etc/init&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="o">!</span><span class="n">try_to_run_init_process</span><span class="p">(</span><span class="s">&quot;/bin/init&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="o">!</span><span class="n">try_to_run_init_process</span><span class="p">(</span><span class="s">&quot;/bin/sh&quot;</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;No working init found. Try passing init= option to kernel.&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1662-systemd">16.6.2 systemd æ¶æ„</h3>
<p>systemd ä½œä¸ºç°ä»£ Linux çš„ init ç³»ç»Ÿï¼Œé‡‡ç”¨å¹¶è¡ŒåŒ–å¯åŠ¨ï¼š</p>
<div class="codehilite"><pre><span></span><code>systemd æ ¸å¿ƒæ¦‚å¿µï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Unit      â”‚  åŸºæœ¬ç®¡ç†å•å…ƒ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Service    â”‚  å®ˆæŠ¤è¿›ç¨‹
â”‚   Socket     â”‚  å¥—æ¥å­—æ¿€æ´»
â”‚   Target     â”‚  åŒæ­¥ç‚¹
â”‚   Mount      â”‚  æŒ‚è½½ç‚¹
â”‚   Timer      â”‚  å®šæ—¶å™¨
â”‚   Path       â”‚  è·¯å¾„ç›‘æ§
â”‚   Slice      â”‚  èµ„æºæ§åˆ¶ç»„
â”‚   Scope      â”‚  å¤–éƒ¨è¿›ç¨‹ç»„
â”‚   Device     â”‚  è®¾å¤‡å•å…ƒ
â”‚   Swap       â”‚  äº¤æ¢åˆ†åŒº
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<p>systemd å¯åŠ¨é¡ºåºï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="mf">1.</span><span class="w"> </span><span class="kd">def</span><span class="n">ault</span><span class="mf">.</span><span class="n">target</span><span class="w"> </span><span class="p">(</span><span class="n">é€šå¸¸é“¾æ¥åˆ°</span><span class="w"> </span><span class="n">multi</span><span class="o">-</span><span class="n">user</span><span class="mf">.</span><span class="n">target</span><span class="w"> </span><span class="n">æˆ–</span><span class="w"> </span><span class="n">graphical</span><span class="mf">.</span><span class="n">target</span><span class="p">)</span>
<span class="w">   </span><span class="err">â†“</span>

<span class="mf">2.</span><span class="w"> </span><span class="n">basic</span><span class="mf">.</span><span class="n">target</span><span class="w"> </span><span class="p">(</span><span class="n">åŸºç¡€ç³»ç»Ÿ</span><span class="p">)</span>
<span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="kr">sys</span><span class="n">init</span><span class="mf">.</span><span class="n">target</span><span class="w"> </span><span class="p">(</span><span class="n">ç³»ç»Ÿåˆå§‹åŒ–</span><span class="p">)</span>
<span class="w">   </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">local</span><span class="o">-</span><span class="n">fs</span><span class="mf">.</span><span class="n">target</span><span class="w"> </span><span class="p">(</span><span class="n">æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ</span><span class="p">)</span>
<span class="w">   </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">swap</span><span class="mf">.</span><span class="n">target</span><span class="w"> </span><span class="p">(</span><span class="n">äº¤æ¢åˆ†åŒº</span><span class="p">)</span>
<span class="w">   </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">cryptsetup</span><span class="mf">.</span><span class="n">target</span><span class="w"> </span><span class="p">(</span><span class="n">åŠ å¯†å·</span><span class="p">)</span>
<span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">sockets</span><span class="mf">.</span><span class="n">target</span><span class="w"> </span><span class="p">(</span><span class="n">å¥—æ¥å­—</span><span class="p">)</span>
<span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">timers</span><span class="mf">.</span><span class="n">target</span><span class="w"> </span><span class="p">(</span><span class="n">å®šæ—¶å™¨</span><span class="p">)</span>
<span class="w">   </span><span class="err">â†“</span>

<span class="mf">3.</span><span class="w"> </span><span class="n">multi</span><span class="o">-</span><span class="n">user</span><span class="mf">.</span><span class="n">target</span><span class="w"> </span><span class="p">(</span><span class="n">å¤šç”¨æˆ·æ¨¡å¼</span><span class="p">)</span>
<span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">network</span><span class="mf">.</span><span class="n">target</span><span class="w"> </span><span class="p">(</span><span class="n">ç½‘ç»œæœåŠ¡</span><span class="p">)</span>
<span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="c1">remote-fs.target (è¿œç¨‹æ–‡ä»¶ç³»ç»Ÿ)</span>
<span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="err">[</span><span class="n">å„ç§æœåŠ¡</span><span class="mf">...</span><span class="err">]</span>
<span class="w">   </span><span class="err">â†“</span>

<span class="mf">4.</span><span class="w"> </span><span class="n">graphical</span><span class="mf">.</span><span class="n">target</span><span class="w"> </span><span class="p">(</span><span class="n">å›¾å½¢ç•Œé¢</span><span class="err">ï¼Œ</span><span class="n">å¯é€‰</span><span class="p">)</span>
</code></pre></div>

<h3 id="1663">16.6.3 å¯åŠ¨ä¼˜åŒ–æŠ€æœ¯</h3>
<ol>
<li><strong>å¹¶è¡ŒåŒ–å¯åŠ¨</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># systemd service æ–‡ä»¶</span>
<span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">My Service</span>
<span class="na">After</span><span class="o">=</span><span class="s">network.target</span><span class="w">       </span><span class="c1"># ä¾èµ–å£°æ˜</span>
<span class="na">Wants</span><span class="o">=</span><span class="s">other.service</span><span class="w">        </span><span class="c1"># å¼±ä¾èµ–</span>

<span class="k">[Service]</span>
<span class="na">Type</span><span class="o">=</span><span class="s">notify</span><span class="w">                </span><span class="c1"># æ”¯æŒ sd_notify</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/bin/myservice</span>
<span class="na">Restart</span><span class="o">=</span><span class="s">on-failure</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</code></pre></div>

<ol start="2">
<li><strong>å¥—æ¥å­—æ¿€æ´»</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä½¿ç”¨ systemd å¥—æ¥å­—æ¿€æ´»</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">sd_listen_fds</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">unset_environment</span><span class="p">);</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sd_listen_fds</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ä½¿ç”¨ systemd ä¼ é€’çš„æ–‡ä»¶æè¿°ç¬¦</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SD_LISTEN_FDS_START</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="c1">// ...</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<ol start="3">
<li><strong>å¯åŠ¨æ—¶é—´åˆ†æ</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># systemd å¯åŠ¨åˆ†æå·¥å…·</span>
systemd-analyze<span class="w">                 </span><span class="c1"># æ€»ä½“å¯åŠ¨æ—¶é—´</span>
systemd-analyze<span class="w"> </span>blame<span class="w">           </span><span class="c1"># æ¯ä¸ªæœåŠ¡çš„å¯åŠ¨æ—¶é—´</span>
systemd-analyze<span class="w"> </span>critical-chain<span class="w">  </span><span class="c1"># å…³é”®è·¯å¾„åˆ†æ</span>
systemd-analyze<span class="w"> </span>plot<span class="w"> </span>&gt;<span class="w"> </span>boot.svg<span class="w"> </span><span class="c1"># ç”Ÿæˆå¯åŠ¨æ—¶åºå›¾</span>
</code></pre></div>

<h3 id="1664-initramfs">16.6.4 initramfs ä¸æ—©æœŸç”¨æˆ·ç©ºé—´</h3>
<p>initramfsï¼ˆinitial RAM filesystemï¼‰æä¾›æ—©æœŸç”¨æˆ·ç©ºé—´ç¯å¢ƒï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// init/initramfs.c</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">populate_rootfs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">err</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* å¦‚æœæ²¡æœ‰ initramfsï¼Œç›´æ¥è¿”å› */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">initrd_start</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* æ£€æŸ¥æ˜¯å¦æ˜¯ cpio æ ¼å¼ */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">initrd_start</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_INITRAMFS_FORCE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unpack_to_rootfs</span><span class="p">((</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">initrd_start</span><span class="p">,</span>
<span class="w">                              </span><span class="n">initrd_size</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">free_initrd_mem</span><span class="p">(</span><span class="n">initrd_start</span><span class="p">,</span><span class="w"> </span><span class="n">initrd_end</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* è§£å‹ initramfs */</span>
<span class="w">    </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unpack_to_rootfs</span><span class="p">(</span><span class="n">__initramfs_start</span><span class="p">,</span>
<span class="w">                          </span><span class="n">__initramfs_size</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
<span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">rootfs_initcall</span><span class="p">(</span><span class="n">populate_rootfs</span><span class="p">);</span>
</code></pre></div>

<p>initramfs ç”Ÿæˆè„šæœ¬ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1"># åˆ›å»º initramfs</span>

<span class="c1"># åˆ›å»ºåŸºæœ¬ç›®å½•ç»“æ„</span>
mkdir<span class="w"> </span>-p<span class="w"> </span>initramfs/<span class="o">{</span>bin,sbin,etc,proc,sys,dev,lib,lib64<span class="o">}</span>

<span class="c1"># å¤åˆ¶å¿…è¦çš„äºŒè¿›åˆ¶æ–‡ä»¶</span>
cp<span class="w"> </span>/bin/busybox<span class="w"> </span>initramfs/bin/
<span class="k">for</span><span class="w"> </span>cmd<span class="w"> </span><span class="k">in</span><span class="w"> </span>sh<span class="w"> </span>ls<span class="w"> </span>mount<span class="w"> </span>umount<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>ln<span class="w"> </span>-s<span class="w"> </span>busybox<span class="w"> </span>initramfs/bin/<span class="nv">$cmd</span>
<span class="k">done</span>

<span class="c1"># åˆ›å»º init è„šæœ¬</span>
cat<span class="w"> </span>&gt;<span class="w"> </span>initramfs/init<span class="w"> </span><span class="s">&lt;&lt; &#39;EOF&#39;</span>
<span class="s">#!/bin/sh</span>
<span class="s">/bin/mount -t proc none /proc</span>
<span class="s">/bin/mount -t sysfs none /sys</span>
<span class="s">/bin/mount -t devtmpfs none /dev</span>

<span class="s"># æŒ‚è½½çœŸå®æ ¹æ–‡ä»¶ç³»ç»Ÿ</span>
<span class="s">/bin/mount -t ext4 /dev/sda1 /newroot</span>

<span class="s"># åˆ‡æ¢æ ¹æ–‡ä»¶ç³»ç»Ÿ</span>
<span class="s">exec switch_root /newroot /sbin/init</span>
<span class="s">EOF</span>
chmod<span class="w"> </span>+x<span class="w"> </span>initramfs/init

<span class="c1"># æ‰“åŒ…æˆ cpio å½’æ¡£</span>
<span class="nb">cd</span><span class="w"> </span>initramfs
find<span class="w"> </span>.<span class="w"> </span><span class="p">|</span><span class="w"> </span>cpio<span class="w"> </span>-o<span class="w"> </span>-H<span class="w"> </span>newc<span class="w"> </span><span class="p">|</span><span class="w"> </span>gzip<span class="w"> </span>&gt;<span class="w"> </span>../initramfs.cpio.gz
</code></pre></div>

<h2 id="_2">æœ¬ç« å°ç»“</h2>
<p>æœ¬ç« æ·±å…¥æ¢è®¨äº† Linux å†…æ ¸ä»ä¸Šç”µåˆ°ç”¨æˆ·ç©ºé—´å¯åŠ¨çš„å®Œæ•´è¿‡ç¨‹ã€‚æˆ‘ä»¬äº†è§£äº†ï¼š</p>
<ol>
<li><strong>å›ºä»¶å¼•å¯¼é˜¶æ®µ</strong>ï¼šBIOS/UEFI çš„å·¥ä½œåŸç†ï¼Œbootloader çš„å¤šé˜¶æ®µåŠ è½½æœºåˆ¶ï¼Œä»¥åŠå¼•å¯¼åè®®çš„è®¾è®¡</li>
<li><strong>å†…æ ¸è§£å‹å’Œæ—©æœŸåˆå§‹åŒ–</strong>ï¼šbzImage æ ¼å¼ã€è§£å‹ç®—æ³•é€‰æ‹©ã€CPU æ¨¡å¼åˆ‡æ¢ï¼ˆå®æ¨¡å¼â†’ä¿æŠ¤æ¨¡å¼â†’é•¿æ¨¡å¼ï¼‰</li>
<li><strong>start_kernel æ‰§è¡Œæµç¨‹</strong>ï¼šå„ä¸ªå­ç³»ç»Ÿçš„åˆå§‹åŒ–é¡ºåºå’Œä¾èµ–å…³ç³»ï¼Œä»å†…å­˜ç®¡ç†åˆ°è°ƒåº¦å™¨çš„å»ºç«‹</li>
<li><strong>initcall æœºåˆ¶</strong>ï¼šé©±åŠ¨å’Œæ¨¡å—çš„åˆ†çº§åˆå§‹åŒ–ç³»ç»Ÿï¼Œé€šè¿‡é“¾æ¥å™¨è„šæœ¬å®ç°çš„ä¼˜é›…è®¾è®¡</li>
<li><strong>ç”¨æˆ·ç©ºé—´å¯åŠ¨</strong>ï¼škernel_init è¿›ç¨‹çš„åˆ›å»ºï¼Œsystemd çš„å¹¶è¡ŒåŒ–å¯åŠ¨æ¶æ„ï¼Œinitramfs çš„ä½œç”¨</li>
</ol>
<p>å…³é”®æŠ€æœ¯è¦ç‚¹ï¼š</p>
<ul>
<li>é¡µè¡¨çš„å»ºç«‹è¿‡ç¨‹ï¼šä»æ—©æœŸæ’ç­‰æ˜ å°„åˆ°å®Œæ•´çš„è™šæ‹Ÿå†…å­˜ç³»ç»Ÿ</li>
<li>ä¸­æ–­ç³»ç»Ÿçš„åˆå§‹åŒ–ï¼šIDT è¡¨çš„è®¾ç½®å’Œå¼‚å¸¸å¤„ç†æœºåˆ¶</li>
<li>è¿›ç¨‹ 0ã€1ã€2 çš„ç‰¹æ®Šè§’è‰²ï¼šidleã€init å’Œ kthreadd</li>
<li>systemd çš„ target ä¾èµ–å›¾å’Œå¥—æ¥å­—æ¿€æ´»æœºåˆ¶</li>
</ul>
<p>å¯åŠ¨ä¼˜åŒ–çš„æ ¸å¿ƒæ€æƒ³ï¼š</p>
<ul>
<li>å¹¶è¡ŒåŒ–ï¼šåˆ©ç”¨å¤šæ ¸ CPU å¹¶è¡Œæ‰§è¡Œåˆå§‹åŒ–ä»»åŠ¡</li>
<li>å»¶è¿ŸåŠ è½½ï¼šå°†éå…³é”®ç»„ä»¶æ¨è¿Ÿåˆ°éœ€è¦æ—¶æ‰åˆå§‹åŒ–</li>
<li>ç¼“å­˜ä¼˜åŒ–ï¼šåˆç†å®‰æ’ä»£ç å’Œæ•°æ®å¸ƒå±€ï¼Œå‡å°‘ç¼“å­˜å¤±æ•ˆ</li>
</ul>
<h2 id="_3">ç»ƒä¹ é¢˜</h2>
<h3 id="_4">åŸºç¡€é¢˜</h3>
<p><strong>ç»ƒä¹  16.1</strong>ï¼šè§£é‡Š BIOS å’Œ UEFI å¯åŠ¨çš„ä¸»è¦åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆç°ä»£ç³»ç»Ÿå€¾å‘äºä½¿ç”¨ UEFIï¼Ÿ</p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ä¸»è¦åŒºåˆ«ï¼š</p>
<ol>
<li><strong>å¯åŠ¨æ¨¡å¼</strong>ï¼šBIOS ä½¿ç”¨ 16 ä½å®æ¨¡å¼å¯åŠ¨ï¼ŒUEFI å¯ä»¥ç›´æ¥åœ¨ 32/64 ä½æ¨¡å¼ä¸‹è¿è¡Œ</li>
<li><strong>åˆ†åŒºæ”¯æŒ</strong>ï¼šBIOS ä½¿ç”¨ MBRï¼ˆæœ€å¤§ 2TBï¼‰ï¼ŒUEFI ä½¿ç”¨ GPTï¼ˆæ”¯æŒè¶…å¤§ç¡¬ç›˜ï¼‰</li>
<li><strong>å¼•å¯¼è¿‡ç¨‹</strong>ï¼šBIOS éœ€è¦å¤šé˜¶æ®µå¼•å¯¼ï¼ˆMBRâ†’æ´»åŠ¨åˆ†åŒºï¼‰ï¼ŒUEFI å¯ä»¥ç›´æ¥ä» ESP åˆ†åŒºåŠ è½½å¼•å¯¼å™¨</li>
<li><strong>å®‰å…¨æ€§</strong>ï¼šUEFI æ”¯æŒå®‰å…¨å¯åŠ¨ï¼ˆSecure Bootï¼‰ï¼Œå¯ä»¥éªŒè¯å¼•å¯¼å™¨ç­¾å</li>
<li><strong>ç•Œé¢</strong>ï¼šUEFI æä¾›å›¾å½¢åŒ–è®¾ç½®ç•Œé¢ï¼Œæ”¯æŒé¼ æ ‡æ“ä½œ</li>
<li><strong>é©±åŠ¨</strong>ï¼šUEFI æœ‰æ ‡å‡†çš„é©±åŠ¨æ¨¡å‹ï¼ŒBIOS éœ€è¦ INT 13h ç­‰ä¸­æ–­è°ƒç”¨</li>
</ol>
<p>é€‰æ‹© UEFI çš„åŸå› ï¼šæ”¯æŒå¤§å®¹é‡ç¡¬ç›˜ã€æ›´å¿«çš„å¯åŠ¨é€Ÿåº¦ã€æ›´å¥½çš„å®‰å…¨æ€§ã€ç½‘ç»œå¯åŠ¨æ”¯æŒ</p>
</details>
<p><strong>ç»ƒä¹  16.2</strong>ï¼šåœ¨ x86_64 æ¶æ„ä¸‹ï¼Œå†…æ ¸ä»å®æ¨¡å¼åˆ‡æ¢åˆ°é•¿æ¨¡å¼éœ€è¦ç»è¿‡å“ªäº›æ­¥éª¤ï¼Ÿæ¯ä¸ªæ­¥éª¤çš„å…³é”®æ“ä½œæ˜¯ä»€ä¹ˆï¼Ÿ</p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>åˆ‡æ¢æ­¥éª¤ï¼š</p>
<ol>
<li>
<p><strong>å®æ¨¡å¼â†’ä¿æŠ¤æ¨¡å¼</strong>ï¼š
   - è®¾ç½® GDTï¼ˆå…¨å±€æè¿°ç¬¦è¡¨ï¼‰
   - è®¾ç½® CR0.PE ä½ï¼ˆä¿æŠ¤æ¨¡å¼ä½¿èƒ½ï¼‰
   - æ‰§è¡Œé•¿è·³è½¬åˆ·æ–° CS æ®µé€‰æ‹©å™¨</p>
</li>
<li>
<p><strong>ä¿æŠ¤æ¨¡å¼â†’é•¿æ¨¡å¼å…¼å®¹</strong>ï¼š
   - æ£€æŸ¥ CPUID ç¡®è®¤ CPU æ”¯æŒé•¿æ¨¡å¼
   - è®¾ç½® CR4.PAE ä½ï¼ˆç‰©ç†åœ°å€æ‰©å±•ï¼‰
   - å»ºç«‹ 4 çº§é¡µè¡¨ï¼ˆPML4ï¼‰
   - è®¾ç½® CR3 æŒ‡å‘é¡µè¡¨åŸºå€</p>
</li>
<li>
<p><strong>å¯ç”¨é•¿æ¨¡å¼</strong>ï¼š
   - è®¾ç½® EFER.LME ä½ï¼ˆé•¿æ¨¡å¼ä½¿èƒ½ï¼‰
   - è®¾ç½® CR0.PG ä½ï¼ˆå¯ç”¨åˆ†é¡µï¼‰
   - æ‰§è¡Œé•¿è·³è½¬è¿›å…¥ 64 ä½ä»£ç æ®µ</p>
</li>
</ol>
<p>å…³é”®ç‚¹ï¼šå¿…é¡»å…ˆå¯ç”¨ PAEï¼Œç„¶åè®¾ç½® LMEï¼Œæœ€åå¯ç”¨åˆ†é¡µ</p>
</details>
<p><strong>ç»ƒä¹  16.3</strong>ï¼šè§£é‡Š initcall çš„ä¸ƒä¸ªçº§åˆ«åŠå…¶ç”¨é€”ï¼Œä¸ºä»€ä¹ˆéœ€è¦è¿™ç§åˆ†çº§æœºåˆ¶ï¼Ÿ</p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>initcall çº§åˆ«ï¼š</p>
<ol>
<li><strong>pure_initcall (0)</strong>ï¼šæœ€åŸºç¡€çš„åˆå§‹åŒ–ï¼Œå¦‚è°ƒè¯•è®¾æ–½</li>
<li><strong>core_initcall (1)</strong>ï¼šæ ¸å¿ƒç»„ä»¶ï¼Œå¦‚ CPUã€å†…å­˜æ£€æµ‹</li>
<li><strong>postcore_initcall (2)</strong>ï¼šæ ¸å¿ƒååˆå§‹åŒ–ï¼Œå¦‚ IRQ å­ç³»ç»Ÿ</li>
<li><strong>arch_initcall (3)</strong>ï¼šæ¶æ„ç‰¹å®šåˆå§‹åŒ–ï¼Œå¦‚å¹³å°è®¾å¤‡</li>
<li><strong>subsys_initcall (4)</strong>ï¼šå­ç³»ç»Ÿåˆå§‹åŒ–ï¼Œå¦‚æ€»çº¿ã€ç”µæºç®¡ç†</li>
<li><strong>fs_initcall (5)</strong>ï¼šæ–‡ä»¶ç³»ç»Ÿåˆå§‹åŒ–</li>
<li><strong>device_initcall (6)</strong>ï¼šè®¾å¤‡é©±åŠ¨ï¼ˆmodule_initï¼‰</li>
<li><strong>late_initcall (7)</strong>ï¼šæœ€åçš„æ¸…ç†å’Œä¼˜åŒ–</li>
</ol>
<p>éœ€è¦åˆ†çº§çš„åŸå› ï¼š</p>
<ul>
<li>ç¡®ä¿ä¾èµ–å…³ç³»æ­£ç¡®ï¼ˆå¦‚æ€»çº¿å¿…é¡»åœ¨è®¾å¤‡ä¹‹å‰åˆå§‹åŒ–ï¼‰</li>
<li>é¿å…åˆå§‹åŒ–é¡ºåºé”™è¯¯å¯¼è‡´çš„å´©æºƒ</li>
<li>æä¾›ç¡®å®šæ€§çš„åˆå§‹åŒ–é¡ºåº</li>
<li>ä¾¿äºè°ƒè¯•å’Œé—®é¢˜å®šä½</li>
</ul>
</details>
<h3 id="_5">è¿›é˜¶é¢˜</h3>
<p><strong>ç»ƒä¹  16.4</strong>ï¼šåˆ†æ start_kernel ä¸­ä¸ºä»€ä¹ˆè¦å…ˆç¦ç”¨ä¸­æ–­ï¼Œç„¶ååœ¨ sched_init ä¹‹åæ‰å¯ç”¨ï¼Ÿè¿™ä¸ªé¡ºåºå¦‚æœæ”¹å˜ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ</p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ç¦ç”¨ä¸­æ–­çš„åŸå› ï¼š</p>
<ol>
<li><strong>æ•°æ®ç»“æ„æœªå°±ç»ª</strong>ï¼šæ—©æœŸåˆå§‹åŒ–æ—¶ï¼Œä¸­æ–­å¤„ç†æ‰€éœ€çš„æ•°æ®ç»“æ„ï¼ˆå¦‚ IDTã€per-CPU å˜é‡ï¼‰è¿˜æœªå»ºç«‹</li>
<li><strong>è°ƒåº¦å™¨æœªè¿è¡Œ</strong>ï¼šä¸­æ–­å¤„ç†å¯èƒ½éœ€è¦è°ƒåº¦ï¼Œä½†è°ƒåº¦å™¨è¿˜æœªåˆå§‹åŒ–</li>
<li><strong>é¿å…ç«æ€æ¡ä»¶</strong>ï¼šåˆå§‹åŒ–è¿‡ç¨‹ä¸­çš„å…¨å±€æ•°æ®ç»“æ„ä¿®æ”¹éœ€è¦åŸå­æ€§</li>
</ol>
<p>å¿…é¡»åœ¨ sched_init åå¯ç”¨çš„åŸå› ï¼š</p>
<ul>
<li>ä¸­æ–­å¤„ç†å¯èƒ½å”¤é†’è¿›ç¨‹ï¼Œéœ€è¦è°ƒåº¦å™¨æ”¯æŒ</li>
<li>æ—¶é’Ÿä¸­æ–­éœ€è¦æ›´æ–°è°ƒåº¦å™¨çš„æ—¶é—´ç‰‡</li>
<li>è½¯ä¸­æ–­å¤„ç†éœ€è¦ ksoftirqd çº¿ç¨‹</li>
</ul>
<p>å¦‚æœè¿‡æ—©å¯ç”¨ä¸­æ–­ï¼š</p>
<ul>
<li>å¯èƒ½è§¦å‘ç©ºæŒ‡é’ˆè§£å¼•ç”¨ï¼ˆå¤„ç†å‡½æ•°æœªæ³¨å†Œï¼‰</li>
<li>å¯¼è‡´æ­»é”ï¼ˆé”æœºåˆ¶æœªåˆå§‹åŒ–ï¼‰</li>
<li>ç³»ç»Ÿå´©æºƒï¼ˆå¿…è¦çš„æ•°æ®ç»“æ„æœªå»ºç«‹ï¼‰</li>
</ul>
<p>å¦‚æœè¿‡æ™šå¯ç”¨ä¸­æ–­ï¼š</p>
<ul>
<li>æŸäº›ä¾èµ–ä¸­æ–­çš„åˆå§‹åŒ–ä¼šå¤±è´¥</li>
<li>å®šæ—¶å™¨ç›¸å…³åŠŸèƒ½æ— æ³•å·¥ä½œ</li>
<li>è®¾å¤‡æ£€æµ‹å¯èƒ½è¶…æ—¶</li>
</ul>
</details>
<p><strong>ç»ƒä¹  16.5</strong>ï¼šè®¾è®¡ä¸€ä¸ªæœ€å°çš„ initramfsï¼Œè¦æ±‚èƒ½å¤Ÿï¼šæŒ‚è½½çœŸå®æ ¹æ–‡ä»¶ç³»ç»Ÿã€å»ºç«‹åŸºæœ¬çš„ /dev è®¾å¤‡èŠ‚ç‚¹ã€å¤„ç†å¯åŠ¨å¤±è´¥çš„åº”æ€¥ shellã€‚ç»™å‡ºå…·ä½“å®ç°ã€‚</p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>æœ€å° initramfs å®ç°ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1"># åˆ›å»ºç›®å½•ç»“æ„</span>
mkdir<span class="w"> </span>-p<span class="w"> </span>minimal_initramfs/<span class="o">{</span>bin,dev,etc,lib,lib64,mnt,proc,sys,root,tmp<span class="o">}</span>

<span class="c1"># å®‰è£… busyboxï¼ˆé™æ€é“¾æ¥ç‰ˆæœ¬ï¼‰</span>
cp<span class="w"> </span>/bin/busybox<span class="w"> </span>minimal_initramfs/bin/
<span class="nb">cd</span><span class="w"> </span>minimal_initramfs/bin
<span class="k">for</span><span class="w"> </span>cmd<span class="w"> </span><span class="k">in</span><span class="w"> </span>sh<span class="w"> </span>mount<span class="w"> </span>umount<span class="w"> </span>switch_root<span class="w"> </span>mknod<span class="w"> </span>ls<span class="w"> </span>cat<span class="w"> </span>echo<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>ln<span class="w"> </span>-s<span class="w"> </span>busybox<span class="w"> </span><span class="nv">$cmd</span>
<span class="k">done</span>
<span class="nb">cd</span><span class="w"> </span>../..

<span class="c1"># åˆ›å»º init è„šæœ¬</span>
cat<span class="w"> </span>&gt;<span class="w"> </span>minimal_initramfs/init<span class="w"> </span><span class="s">&lt;&lt; &#39;INIT_SCRIPT&#39;</span>
<span class="s">#!/bin/sh</span>

<span class="s"># åº”æ€¥ shell å‡½æ•°</span>
<span class="s">rescue_shell() {</span>
<span class="s">    echo &quot;å¯åŠ¨å¤±è´¥ï¼Œè¿›å…¥åº”æ€¥ shell&quot;</span>
<span class="s">    echo &quot;é—®é¢˜ï¼š$1&quot;</span>
<span class="s">    exec sh</span>
<span class="s">}</span>

<span class="s"># æŒ‚è½½å¿…è¦çš„æ–‡ä»¶ç³»ç»Ÿ</span>
<span class="s">mount -t proc none /proc || rescue_shell &quot;æ— æ³•æŒ‚è½½ /proc&quot;</span>
<span class="s">mount -t sysfs none /sys || rescue_shell &quot;æ— æ³•æŒ‚è½½ /sys&quot;</span>
<span class="s">mount -t devtmpfs none /dev || {</span>
<span class="s">    # å¦‚æœ devtmpfs ä¸å¯ç”¨ï¼Œæ‰‹åŠ¨åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹</span>
<span class="s">    mknod /dev/null c 1 3</span>
<span class="s">    mknod /dev/zero c 1 5</span>
<span class="s">    mknod /dev/random c 1 8</span>
<span class="s">    mknod /dev/urandom c 1 9</span>
<span class="s">    mknod /dev/tty c 5 0</span>
<span class="s">    mknod /dev/console c 5 1</span>
<span class="s">    mknod /dev/sda b 8 0</span>
<span class="s">    mknod /dev/sda1 b 8 1</span>
<span class="s">}</span>

<span class="s"># è§£æå†…æ ¸å‘½ä»¤è¡Œè·å–æ ¹è®¾å¤‡</span>
<span class="s">ROOT_DEV=&quot;&quot;</span>
<span class="s">for param in $(cat /proc/cmdline); do</span>
<span class="s">    case $param in</span>
<span class="s">        root=*)</span>
<span class="s">            ROOT_DEV=&quot;${param#root=}&quot;</span>
<span class="s">            ;;</span>
<span class="s">    esac</span>
<span class="s">done</span>

<span class="s">[ -z &quot;$ROOT_DEV&quot; ] &amp;&amp; rescue_shell &quot;æœªæŒ‡å®š root å‚æ•°&quot;</span>

<span class="s"># ç­‰å¾…æ ¹è®¾å¤‡å‡ºç°ï¼ˆæœ€å¤š 10 ç§’ï¼‰</span>
<span class="s">COUNTER=0</span>
<span class="s">while [ ! -b &quot;$ROOT_DEV&quot; ]; do</span>
<span class="s">    sleep 1</span>
<span class="s">    COUNTER=$((COUNTER + 1))</span>
<span class="s">    [ $COUNTER -ge 10 ] &amp;&amp; rescue\_shell &quot;æ ¹è®¾å¤‡ $ROOT_DEV ä¸å­˜åœ¨&quot;</span>
<span class="s">done</span>

<span class="s"># æŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿ</span>
<span class="s">mount -o ro &quot;$ROOT_DEV&quot; /mnt || rescue_shell &quot;æ— æ³•æŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿ&quot;</span>

<span class="s"># æ£€æŸ¥ init æ˜¯å¦å­˜åœ¨</span>
<span class="s">[ -x /mnt/sbin/init ] || rescue_shell &quot;/sbin/init ä¸å­˜åœ¨&quot;</span>

<span class="s"># æ¸…ç†å¹¶åˆ‡æ¢æ ¹</span>
<span class="s">umount /proc</span>
<span class="s">umount /sys</span>
<span class="s">umount /dev</span>

<span class="s"># åˆ‡æ¢åˆ°çœŸå®æ ¹æ–‡ä»¶ç³»ç»Ÿ</span>
<span class="s">exec switch_root /mnt /sbin/init || rescue_shell &quot;switch_root å¤±è´¥&quot;</span>
<span class="s">INIT_SCRIPT</span>

chmod<span class="w"> </span>+x<span class="w"> </span>minimal_initramfs/init

<span class="c1"># æ‰“åŒ…</span>
<span class="nb">cd</span><span class="w"> </span>minimal_initramfs
find<span class="w"> </span>.<span class="w"> </span><span class="p">|</span><span class="w"> </span>cpio<span class="w"> </span>-o<span class="w"> </span>-H<span class="w"> </span>newc<span class="w"> </span><span class="p">|</span><span class="w"> </span>gzip<span class="w"> </span>&gt;<span class="w"> </span>../minimal_initramfs.cpio.gz
<span class="nb">cd</span><span class="w"> </span>..

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;initramfs åˆ›å»ºå®Œæˆï¼šminimal_initramfs.cpio.gz&quot;</span>
</code></pre></div>

<p>å…³é”®è®¾è®¡ç‚¹ï¼š</p>
<ol>
<li>ä½¿ç”¨é™æ€é“¾æ¥çš„ busybox å‡å°‘ä¾èµ–</li>
<li>å®ç° rescue_shell æä¾›è°ƒè¯•èƒ½åŠ›</li>
<li>æ”¯æŒ devtmpfs å’Œæ‰‹åŠ¨åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹ä¸¤ç§æ–¹å¼</li>
<li>è§£æå†…æ ¸å‘½ä»¤è¡Œè·å–å¯åŠ¨å‚æ•°</li>
<li>å®ç°è®¾å¤‡ç­‰å¾…æœºåˆ¶é¿å…ç«æ€æ¡ä»¶</li>
</ol>
</details>
<p><strong>ç»ƒä¹  16.6</strong>ï¼šsystemd çš„ socket activation æœºåˆ¶æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿè®¾è®¡ä¸€ä¸ªæ”¯æŒ socket activation çš„ç®€å•æœåŠ¡ã€‚</p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>Socket Activation å·¥ä½œåŸç†ï¼š</p>
<ol>
<li>systemd é¢„å…ˆåˆ›å»ºå¹¶ç›‘å¬å¥—æ¥å­—</li>
<li>å½“æœ‰è¿æ¥åˆ°è¾¾æ—¶ï¼Œsystemd å¯åŠ¨å¯¹åº”çš„æœåŠ¡</li>
<li>systemd é€šè¿‡ç¯å¢ƒå˜é‡ä¼ é€’å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦</li>
<li>æœåŠ¡ç›´æ¥ä½¿ç”¨è¿™äº›æ–‡ä»¶æè¿°ç¬¦ï¼Œæ— éœ€è‡ªå·±åˆ›å»ºå¥—æ¥å­—</li>
</ol>
<p>å®ç°ç¤ºä¾‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// echo_server.c - æ”¯æŒ socket activation çš„å›æ˜¾æœåŠ¡å™¨</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;systemd/sd-daemon.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/socket.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;netinet/in.h&gt;</span>

<span class="cp">#define BUFFER_SIZE 1024</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">listen_fd</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">n_fds</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// æ£€æŸ¥æ˜¯å¦ç”± systemd å¯åŠ¨</span>
<span class="w">    </span><span class="n">n_fds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sd_listen_fds</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n_fds</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ä½¿ç”¨ systemd ä¼ é€’çš„å¥—æ¥å­—</span>
<span class="w">        </span><span class="n">listen_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SD_LISTEN_FDS_START</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">sd_notify</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;READY=1</span><span class="se">\n</span><span class="s">STATUS=Using systemd socket&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// å›é€€ï¼šè‡ªå·±åˆ›å»ºå¥—æ¥å­—</span>
<span class="w">        </span><span class="n">listen_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span><span class="w"> </span><span class="n">SOCK_STREAM</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">sockaddr_in</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="p">.</span><span class="n">sin_family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AF_INET</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">sin_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">htons</span><span class="p">(</span><span class="mi">8080</span><span class="p">),</span>
<span class="w">            </span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">INADDR_ANY</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">listen_fd</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span>
<span class="w">            </span><span class="n">listen</span><span class="p">(</span><span class="n">listen_fd</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;Failed to create socket&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// ä¸»å¾ªç¯</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">client_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accept</span><span class="p">(</span><span class="n">listen_fd</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">client_fd</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>

<span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="n">BUFFER_SIZE</span><span class="p">];</span>
<span class="w">        </span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read</span><span class="p">(</span><span class="n">client_fd</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">BUFFER_SIZE</span><span class="mi">-1</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">buffer</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="w">            </span><span class="n">write</span><span class="p">(</span><span class="n">client_fd</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span><span class="w">  </span><span class="c1">// å›æ˜¾</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">close</span><span class="p">(</span><span class="n">client_fd</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// é€šçŸ¥ systemd å¤„ç†äº†ä¸€ä¸ªè¿æ¥</span>
<span class="w">        </span><span class="n">sd_notify</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;STATUS=Processed a connection&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>systemd é…ç½®æ–‡ä»¶ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># echo.socket</span>
<span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">Echo Server Socket</span>

<span class="k">[Socket]</span>
<span class="na">ListenStream</span><span class="o">=</span><span class="s">8080</span>
<span class="na">Accept</span><span class="o">=</span><span class="s">no</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">sockets.target</span>

<span class="c1"># echo.service</span>
<span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">Echo Server</span>
<span class="na">Requires</span><span class="o">=</span><span class="s">echo.socket</span>

<span class="k">[Service]</span>
<span class="na">Type</span><span class="o">=</span><span class="s">notify</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/local/bin/echo_server</span>
<span class="na">StandardOutput</span><span class="o">=</span><span class="s">journal</span>
<span class="na">Restart</span><span class="o">=</span><span class="s">on-failure</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</code></pre></div>

<p>ä¼˜åŠ¿ï¼š</p>
<ul>
<li>é›¶åœæœºæ—¶é—´é‡å¯ï¼ˆå¥—æ¥å­—ä¿æŒç›‘å¬ï¼‰</li>
<li>æŒ‰éœ€å¯åŠ¨æœåŠ¡ï¼ˆèŠ‚çœèµ„æºï¼‰</li>
<li>å¹¶è¡ŒåŒ–å¯åŠ¨ï¼ˆæœåŠ¡å¯ä»¥å»¶è¿Ÿåˆ°çœŸæ­£éœ€è¦æ—¶ï¼‰</li>
</ul>
</details>
<h3 id="_6">æŒ‘æˆ˜é¢˜</h3>
<p><strong>ç»ƒä¹  16.7</strong>ï¼šåˆ†æ Linux å†…æ ¸å¯åŠ¨è¿‡ç¨‹ä¸­çš„å†…å­˜å¸ƒå±€å˜åŒ–ï¼Œä»å®æ¨¡å¼çš„ 1MB é™åˆ¶åˆ°æœ€ç»ˆçš„è™šæ‹Ÿå†…å­˜ç³»ç»Ÿã€‚ç”»å‡ºå„ä¸ªé˜¶æ®µçš„å†…å­˜æ˜ å°„å›¾ã€‚</p>
<details>
<summary>æç¤º</summary>
<p>éœ€è¦è€ƒè™‘çš„é˜¶æ®µï¼š</p>
<ol>
<li>å®æ¨¡å¼ï¼šæ®µ:åç§»å¯»å€ï¼Œ20 ä½åœ°å€æ€»çº¿</li>
<li>ä¿æŠ¤æ¨¡å¼æ—©æœŸï¼šæ’ç­‰æ˜ å°„ï¼ŒGDT æ®µæè¿°ç¬¦</li>
<li>å¯ç”¨åˆ†é¡µåï¼šä¸´æ—¶é¡µè¡¨ï¼Œå†…æ ¸ç©ºé—´æ˜ å°„</li>
<li>æœ€ç»ˆçŠ¶æ€ï¼šå®Œæ•´çš„è™šæ‹Ÿå†…å­˜å¸ƒå±€</li>
</ol>
<p>å…³é”®è½¬æ¢ç‚¹ï¼š</p>
<ul>
<li>setup_idtï¼šå»ºç«‹ä¸­æ–­æè¿°ç¬¦è¡¨</li>
<li>init_mem_mappingï¼šå»ºç«‹å†…æ ¸ç›´æ¥æ˜ å°„</li>
<li>setup_per_cpu_areasï¼šå»ºç«‹ per-CPU åŒºåŸŸ</li>
<li>vmalloc_initï¼šåˆå§‹åŒ– vmalloc åŒºåŸŸ</li>
</ul>
<p>éœ€è¦å…³æ³¨çš„åœ°å€èŒƒå›´ï¼š</p>
<ul>
<li>0-1MBï¼šå®æ¨¡å¼å¯è®¿é—®åŒºåŸŸ</li>
<li>1MB-16MBï¼šISA DMA åŒºåŸŸ</li>
<li>å†…æ ¸ä»£ç æ®µï¼š_text åˆ° _etext</li>
<li>å†…æ ¸ç›´æ¥æ˜ å°„ï¼šPAGE_OFFSET å¼€å§‹</li>
<li>vmalloc åŒºåŸŸï¼šVMALLOC_START åˆ° VMALLOC_END</li>
</ul>
</details>
<p><strong>ç»ƒä¹  16.8</strong>ï¼šè®¾è®¡å¹¶å®ç°ä¸€ä¸ªå¯åŠ¨æ—¶é—´åˆ†æå·¥å…·ï¼Œèƒ½å¤Ÿç²¾ç¡®æµ‹é‡å†…æ ¸å„ä¸ªåˆå§‹åŒ–é˜¶æ®µçš„è€—æ—¶ï¼Œå¹¶ç”Ÿæˆç«ç„°å›¾ã€‚è€ƒè™‘å¦‚ä½•å¤„ç†æ—©æœŸå¯åŠ¨ï¼ˆæ—¶é’Ÿæœªåˆå§‹åŒ–ï¼‰çš„è®¡æ—¶é—®é¢˜ã€‚</p>
<details>
<summary>æç¤º</summary>
<p>å®ç°æ€è·¯ï¼š</p>
<ol>
<li><strong>æ—©æœŸè®¡æ—¶</strong>ï¼šä½¿ç”¨ TSCï¼ˆTime Stamp Counterï¼‰æˆ– HPET</li>
<li><strong>æ•°æ®æ”¶é›†</strong>ï¼šåœ¨æ¯ä¸ª initcall å‰åè®°å½•æ—¶é—´æˆ³</li>
<li><strong>å­˜å‚¨æœºåˆ¶</strong>ï¼šä½¿ç”¨é™æ€æ•°ç»„æˆ– early_memremap</li>
<li><strong>æ•°æ®å¯¼å‡º</strong>ï¼šé€šè¿‡ /proc æˆ– debugfs æ¥å£</li>
<li><strong>å¯è§†åŒ–</strong>ï¼šè½¬æ¢ä¸º FlameGraph æ ¼å¼</li>
</ol>
<p>å…³é”®æŠ€æœ¯ç‚¹ï¼š</p>
<ul>
<li>rdtsc æŒ‡ä»¤è¯»å– CPU æ—¶é—´æˆ³</li>
<li>__init æ®µçš„å†…å­˜ä¼šè¢«é‡Šæ”¾ï¼Œéœ€è¦æŒä¹…åŒ–å­˜å‚¨</li>
<li>è€ƒè™‘å¤š CPU çš„æ—¶é—´åŒæ­¥é—®é¢˜</li>
<li>å¤„ç†æ—¶é’Ÿé¢‘ç‡å˜åŒ–ï¼ˆCPU åŠ¨æ€è°ƒé¢‘ï¼‰</li>
</ul>
<p>è¾“å‡ºæ ¼å¼è®¾è®¡ï¼š</p>
<div class="codehilite"><pre><span></span><code>initcall_name;parent_function;duration_us
</code></pre></div>

<p>å·¥å…·é›†æˆï¼š</p>
<ul>
<li>ä¸ ftrace é›†æˆè·å–æ›´è¯¦ç»†çš„è°ƒç”¨æ ˆ</li>
<li>æ”¯æŒ bootchart æ ¼å¼è¾“å‡º</li>
<li>ç”Ÿæˆ systemd-analyze å…¼å®¹çš„æ•°æ®</li>
</ul>
</details>
<h2 id="gotchas">å¸¸è§é™·é˜±ä¸é”™è¯¯ (Gotchas)</h2>
<h3 id="1">1. å¯åŠ¨å‚æ•°é”™è¯¯</h3>
<p><strong>é—®é¢˜</strong>ï¼šå†…æ ¸å‘½ä»¤è¡Œå‚æ•°æ‹¼å†™é”™è¯¯æˆ–æ ¼å¼ä¸æ­£ç¡®å¯¼è‡´å¯åŠ¨å¤±è´¥</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># é”™è¯¯ï¼šå‚æ•°ä¹‹é—´éœ€è¦ç©ºæ ¼</span>
<span class="nv">root</span><span class="o">=</span>/dev/sda1init<span class="o">=</span>/sbin/init<span class="w">  </span>

<span class="c1"># æ­£ç¡®ï¼š</span>
<span class="nv">root</span><span class="o">=</span>/dev/sda1<span class="w"> </span><span class="nv">init</span><span class="o">=</span>/sbin/init
</code></pre></div>

<p><strong>è§£å†³</strong>ï¼šä½¿ç”¨ <code>early_param</code> å’Œ <code>__setup</code> æ­£ç¡®æ³¨å†Œå‚æ•°å¤„ç†å‡½æ•°</p>
<h3 id="2-initcall">2. initcall é¡ºåºä¾èµ–</h3>
<p><strong>é—®é¢˜</strong>ï¼šé©±åŠ¨åˆå§‹åŒ–é¡ºåºé”™è¯¯å¯¼è‡´ä¾èµ–æœªæ»¡è¶³</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯ï¼šç½‘å¡é©±åŠ¨å¯èƒ½åœ¨ç½‘ç»œå­ç³»ç»Ÿä¹‹å‰åˆå§‹åŒ–</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">network_driver_init</span><span class="p">);</span><span class="w">  </span><span class="c1">// device_initcall çº§åˆ«</span>

<span class="c1">// æ­£ç¡®ï¼šä½¿ç”¨æ›´æ™šçš„åˆå§‹åŒ–çº§åˆ«</span>
<span class="n">late_initcall</span><span class="p">(</span><span class="n">network_driver_init</span><span class="p">);</span>
</code></pre></div>

<h3 id="3">3. æ—©æœŸå†…å­˜è®¿é—®</h3>
<p><strong>é—®é¢˜</strong>ï¼šåœ¨ MMU å¯ç”¨å‰è®¿é—®è™šæ‹Ÿåœ°å€</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯ï¼šæ—©æœŸä»£ç ä¸èƒ½ä½¿ç”¨ kmalloc</span>
<span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">early_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">);</span><span class="w">  </span><span class="c1">// å´©æºƒï¼</span>
<span class="p">}</span>

<span class="c1">// æ­£ç¡®ï¼šä½¿ç”¨ alloc_bootmem æˆ–é™æ€åˆ†é…</span>
<span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">early_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span><span class="w">  </span><span class="c1">// æˆ– alloc_bootmem(256)</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="4-init">4. init æ®µå†…å­˜é‡Šæ”¾</h3>
<p><strong>é—®é¢˜</strong>ï¼š__init å‡½æ•°çš„æŒ‡é’ˆåœ¨ init æ®µé‡Šæ”¾åä½¿ç”¨</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯ï¼šä¿å­˜ __init å‡½æ•°æŒ‡é’ˆ</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">saved_func</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">int</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">saved_func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">some_init_function</span><span class="p">;</span><span class="w">  </span><span class="c1">// å±é™©ï¼</span>
<span class="p">}</span>

<span class="c1">// æ­£ç¡®ï¼šä¸ä¿å­˜ __init å‡½æ•°æŒ‡é’ˆï¼Œæˆ–ç§»é™¤ __init</span>
</code></pre></div>

<h3 id="5">5. è®¾å¤‡æ¢æµ‹ç«æ€</h3>
<p><strong>é—®é¢˜</strong>ï¼šæ ¹è®¾å¤‡è¿˜æœªå‡ºç°å°±å°è¯•æŒ‚è½½</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># å†…æ ¸ panic: VFS: Unable to mount root fs</span>
</code></pre></div>

<p><strong>è§£å†³</strong>ï¼šä½¿ç”¨ rootwait å‚æ•°æˆ–åœ¨ initramfs ä¸­å®ç°ç­‰å¾…é€»è¾‘</p>
<h3 id="6-uefi">6. UEFI å®‰å…¨å¯åŠ¨</h3>
<p><strong>é—®é¢˜</strong>ï¼šæœªç­¾åçš„å†…æ ¸æˆ–æ¨¡å—åœ¨ Secure Boot ç¯å¢ƒä¸‹æ— æ³•åŠ è½½
<strong>è§£å†³</strong>ï¼š</p>
<ul>
<li>ä½¿ç”¨ MOK (Machine Owner Key) ç­¾åå†…æ ¸æ¨¡å—</li>
<li>æˆ–åœ¨ BIOS ä¸­ç¦ç”¨ Secure Boot</li>
<li>ä½¿ç”¨ shim åŠ è½½å™¨é“¾</li>
</ul>
<h2 id="_7">æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•</h2>
<h3 id="_8">å¯åŠ¨æ€§èƒ½ä¼˜åŒ–</h3>
<ul>
<li>[ ] é€‰æ‹©åˆé€‚çš„å†…æ ¸å‹ç¼©ç®—æ³•ï¼ˆLZ4 ç”¨äºå¿«é€Ÿè§£å‹ï¼‰</li>
<li>[ ] ç²¾ç®€å†…æ ¸é…ç½®ï¼Œç§»é™¤ä¸éœ€è¦çš„é©±åŠ¨</li>
<li>[ ] ä½¿ç”¨ initcall_blacklist ç¦ç”¨ä¸å¿…è¦çš„åˆå§‹åŒ–</li>
<li>[ ] å¯ç”¨å¹¶è¡ŒåŒ–é€‰é¡¹ï¼ˆå¦‚ PARALLEL_BOOTï¼‰</li>
<li>[ ] ä¼˜åŒ– initramfs å¤§å°ï¼ŒåªåŒ…å«å¿…è¦ç»„ä»¶</li>
</ul>
<h3 id="initcall">initcall è®¾è®¡</h3>
<ul>
<li>[ ] é€‰æ‹©æ­£ç¡®çš„ initcall çº§åˆ«</li>
<li>[ ] å®ç° -EPROBE_DEFER æ”¯æŒå»¶è¿Ÿæ¢æµ‹</li>
<li>[ ] é¿å…åœ¨ initcall ä¸­è¿›è¡Œé•¿æ—¶é—´é˜»å¡æ“ä½œ</li>
<li>[ ] ä½¿ç”¨ async_schedule è¿›è¡Œå¼‚æ­¥åˆå§‹åŒ–</li>
<li>[ ] æ·»åŠ é€‚å½“çš„é”™è¯¯å¤„ç†å’Œå›æ»šæœºåˆ¶</li>
</ul>
<h3 id="_9">è°ƒè¯•å’Œè¯Šæ–­</h3>
<ul>
<li>[ ] å¯ç”¨ initcall_debug è·Ÿè¸ªå¯åŠ¨è¿‡ç¨‹</li>
<li>[ ] ä½¿ç”¨ ftrace çš„ function_graph è·Ÿè¸ªå™¨</li>
<li>[ ] é…ç½® early_printk ç”¨äºæ—©æœŸè°ƒè¯•</li>
<li>[ ] ä¿å­˜å¯åŠ¨æ—¥å¿—ç”¨äºåç»­åˆ†æ</li>
<li>[ ] ä½¿ç”¨ systemd-analyze åˆ†æç”¨æˆ·ç©ºé—´å¯åŠ¨</li>
</ul>
<h3 id="_10">å®‰å…¨è€ƒè™‘</h3>
<ul>
<li>[ ] éªŒè¯å¼•å¯¼å™¨å’Œå†…æ ¸ç­¾åï¼ˆSecure Bootï¼‰</li>
<li>[ ] ä¿æŠ¤å†…æ ¸å‘½ä»¤è¡Œå‚æ•°ï¼ˆé¿å…æ³¨å…¥ï¼‰</li>
<li>[ ] é™åˆ¶ initramfs çš„æƒé™å’Œå†…å®¹</li>
<li>[ ] å¯ç”¨ KASLRï¼ˆå†…æ ¸åœ°å€ç©ºé—´éšæœºåŒ–ï¼‰</li>
<li>[ ] å®¡è®¡ init è„šæœ¬é¿å…å®‰å…¨æ¼æ´</li>
</ul>
<h3 id="_11">å¯é æ€§ä¿è¯</h3>
<ul>
<li>[ ] å®ç° watchdog ç›‘æ§å¯åŠ¨è¿‡ç¨‹</li>
<li>[ ] æä¾›å¤±è´¥åçš„æ¢å¤æœºåˆ¶ï¼ˆrescue shellï¼‰</li>
<li>[ ] è®°å½•å…³é”®å¯åŠ¨é˜¶æ®µçš„æ£€æŸ¥ç‚¹</li>
<li>[ ] å®ç°å¯åŠ¨å¤±è´¥çš„è‡ªåŠ¨å›æ»š</li>
<li>[ ] æµ‹è¯•å„ç§å¯åŠ¨å¤±è´¥åœºæ™¯</li>
</ul>
<h3 id="_12">æ–‡æ¡£å’Œç»´æŠ¤</h3>
<ul>
<li>[ ] è®°å½•è‡ªå®šä¹‰çš„å†…æ ¸å‚æ•°</li>
<li>[ ] ç»´æŠ¤ initcall ä¾èµ–å…³ç³»æ–‡æ¡£</li>
<li>[ ] è®°å½•å¯åŠ¨æ—¶é—´åŸºå‡†å’Œä¼˜åŒ–å†å²</li>
<li>[ ] æä¾›å¯åŠ¨é—®é¢˜çš„æ•…éšœæ’é™¤æŒ‡å—</li>
<li>[ ] å®šæœŸæ›´æ–°å’Œæµ‹è¯•æ¢å¤æµç¨‹</li>
</ul>
            </article>
            
            <nav class="page-nav"><a href="chapter15.html" class="nav-link prev">â† ç¬¬15ç« ï¼šæ€§èƒ½åˆ†æä¸è°ƒè¯•</a><a href="CLAUDE.html" class="nav-link next">Untitled â†’</a></nav>
        </main>
    </div>
</body>
</html>