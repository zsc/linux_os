<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬7ç« ï¼šå—è®¾å¤‡å±‚ä¸I/Oè°ƒåº¦</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Linux å†…æ ¸æºä»£ç æ·±åº¦è§£æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬1ç« ï¼šLinux å†…æ ¸æ¦‚è¿°ä¸å‘å±•å²</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬2ç« ï¼šè¿›ç¨‹ç®¡ç†ä¸ä»»åŠ¡è°ƒåº¦</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬3ç« ï¼šå†…å­˜ç®¡ç†æ¶æ„</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬4ç« ï¼šè¿›ç¨‹é—´é€šä¿¡æœºåˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬5ç« ï¼šè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬6ç« ï¼šå…·ä½“æ–‡ä»¶ç³»ç»Ÿå®ç°</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬7ç« ï¼šå—è®¾å¤‡å±‚ä¸I/Oè°ƒåº¦</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬8ç« ï¼šè®¾å¤‡é©±åŠ¨æ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬9ç« ï¼šç½‘ç»œåè®®æ ˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬10ç« ï¼šå†…æ ¸åŒæ­¥æœºåˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬11ç« ï¼šå¹¶å‘ç¼–ç¨‹æ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬12ç« ï¼šå®¹å™¨ä¸å‘½åç©ºé—´</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬13ç« ï¼šå®‰å…¨å­ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬14ç« ï¼šå®æ—¶Linux</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬15ç« ï¼šæ€§èƒ½åˆ†æä¸è°ƒè¯•</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬16ç« ï¼šå¼•å¯¼è¿‡ç¨‹ä¸åˆå§‹åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="7io">ç¬¬7ç« ï¼šå—è®¾å¤‡å±‚ä¸I/Oè°ƒåº¦</h1>
<h2 id="_1">ç« èŠ‚å¤§çº²</h2>
<h3 id="71">7.1 å—è®¾å¤‡æ¶æ„</h3>
<ul>
<li>7.1.1 å—è®¾å¤‡å±‚åœ¨å†…æ ¸ä¸­çš„ä½ç½®</li>
<li>7.1.2 æ ¸å¿ƒæ•°æ®ç»“æ„ï¼šbioã€requestã€gendisk</li>
<li>7.1.3 å—è®¾å¤‡é©±åŠ¨æ¥å£</li>
<li>7.1.4 è¯·æ±‚å¤„ç†æµç¨‹</li>
</ul>
<h3 id="72-io">7.2 I/Oè°ƒåº¦å™¨æ¼”è¿›</h3>
<ul>
<li>7.2.1 ä¼ ç»Ÿè°ƒåº¦å™¨ï¼šCFQã€deadlineã€noop</li>
<li>7.2.2 å¤šé˜Ÿåˆ—è°ƒåº¦å™¨ï¼šmq-deadlineã€bfqã€kyber</li>
<li>7.2.3 è°ƒåº¦å™¨é€‰æ‹©ç­–ç•¥</li>
<li>7.2.4 æ€§èƒ½å¯¹æ¯”ä¸åœºæ™¯é€‚ç”¨</li>
</ul>
<h3 id="73-blk-mq">7.3 å¤šé˜Ÿåˆ—å—å±‚ï¼ˆblk-mqï¼‰</h3>
<ul>
<li>7.3.1 ä»å•é˜Ÿåˆ—åˆ°å¤šé˜Ÿåˆ—çš„æ¶æ„å˜é©</li>
<li>7.3.2 è½¯ä»¶é˜Ÿåˆ—ä¸ç¡¬ä»¶é˜Ÿåˆ—æ˜ å°„</li>
<li>7.3.3 è¯·æ±‚åˆ†å‘ä¸å®Œæˆæœºåˆ¶</li>
<li>7.3.4 æ ‡ç­¾ç®¡ç†ä¸å¹¶å‘æ§åˆ¶</li>
</ul>
<h3 id="74-device-mapper">7.4 è®¾å¤‡æ˜ å°„å™¨ï¼ˆdevice-mapperï¼‰</h3>
<ul>
<li>7.4.1 DMæ¶æ„ä¸ç›®æ ‡é©±åŠ¨</li>
<li>7.4.2 çº¿æ€§æ˜ å°„ä¸æ¡å¸¦åŒ–</li>
<li>7.4.3 å¿«ç…§ä¸ç²¾ç®€é…ç½®</li>
<li>7.4.4 åŠ å¯†ä¸å®Œæ•´æ€§ä¿æŠ¤</li>
</ul>
<h3 id="75">7.5 æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯</h3>
<ul>
<li>7.5.1 I/Oåˆå¹¶ä¸è¯·æ±‚é‡æ’</li>
<li>7.5.2 é¢„è¯»ç­–ç•¥ä¸ç¼“å­˜ç®¡ç†</li>
<li>7.5.3 å†™å›æœºåˆ¶ä¸è„é¡µæ§åˆ¶</li>
<li>7.5.4 I/Oç»Ÿè®¡ä¸æ€§èƒ½ç›‘æ§</li>
</ul>
<h3 id="76">7.6 æœ¬ç« å°ç»“</h3>
<h3 id="77">7.7 ç»ƒä¹ é¢˜</h3>
<h3 id="78">7.8 å¸¸è§é™·é˜±ä¸é”™è¯¯</h3>
<h3 id="79">7.9 æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•</h3>
<hr />
<h2 id="_2">å¼€ç¯‡å¯¼è¯»</h2>
<p>å—è®¾å¤‡å±‚æ˜¯Linuxå†…æ ¸ä¸­è¿æ¥æ–‡ä»¶ç³»ç»Ÿä¸ç‰©ç†å­˜å‚¨è®¾å¤‡çš„å…³é”®æ¡¥æ¢ã€‚ä»æ—©æœŸçš„ç®€å•è¯·æ±‚é˜Ÿåˆ—åˆ°ç°ä»£çš„å¤šé˜Ÿåˆ—æ¶æ„ï¼Œå—è®¾å¤‡å±‚ç»å†äº†å¤šæ¬¡é‡å¤§å˜é©ï¼Œæ¯ä¸€æ¬¡éƒ½æ˜¯ä¸ºäº†é€‚åº”å­˜å‚¨æŠ€æœ¯çš„å‘å±•â€”â€”ä»æœºæ¢°ç¡¬ç›˜åˆ°SSDï¼Œå†åˆ°NVMeè®¾å¤‡ã€‚æœ¬ç« å°†æ·±å…¥å‰–æå—è®¾å¤‡å±‚çš„æ¶æ„è®¾è®¡ã€I/Oè°ƒåº¦ç®—æ³•ã€ä»¥åŠå¦‚ä½•é’ˆå¯¹ä¸åŒå­˜å‚¨ä»‹è´¨è¿›è¡Œæ€§èƒ½ä¼˜åŒ–ã€‚</p>
<h2 id="_3">å­¦ä¹ ç›®æ ‡</h2>
<p>å®Œæˆæœ¬ç« å­¦ä¹ åï¼Œæ‚¨å°†èƒ½å¤Ÿï¼š</p>
<ol>
<li><strong>ç†è§£å—è®¾å¤‡å±‚æ¶æ„</strong>ï¼šæŒæ¡bioã€requestã€gendiskç­‰æ ¸å¿ƒæ•°æ®ç»“æ„åŠå…¶ç›¸äº’å…³ç³»</li>
<li><strong>åˆ†æI/Oè°ƒåº¦ç®—æ³•</strong>ï¼šå¯¹æ¯”ä¸åŒè°ƒåº¦å™¨çš„è®¾è®¡ç†å¿µå’Œé€‚ç”¨åœºæ™¯</li>
<li><strong>æŒæ¡blk-mqæœºåˆ¶</strong>ï¼šç†è§£å¤šé˜Ÿåˆ—æ¶æ„å¦‚ä½•å……åˆ†å‘æŒ¥ç°ä»£å­˜å‚¨è®¾å¤‡æ€§èƒ½</li>
<li><strong>è¿ç”¨device-mapper</strong>ï¼šå®ç°é€»è¾‘å·ç®¡ç†ã€å¿«ç…§ã€åŠ å¯†ç­‰é«˜çº§å­˜å‚¨åŠŸèƒ½</li>
<li><strong>ä¼˜åŒ–å­˜å‚¨æ€§èƒ½</strong>ï¼šé€šè¿‡I/Oåˆå¹¶ã€é¢„è¯»ã€å†™å›ç­‰æŠ€æœ¯æå‡ç³»ç»Ÿååé‡</li>
</ol>
<hr />
<h2 id="71_1">7.1 å—è®¾å¤‡æ¶æ„</h2>
<h3 id="711">7.1.1 å—è®¾å¤‡å±‚åœ¨å†…æ ¸ä¸­çš„ä½ç½®</h3>
<p>å—è®¾å¤‡å±‚ä½äºVFSå’Œå®é™…å—è®¾å¤‡é©±åŠ¨ä¹‹é—´ï¼Œæä¾›äº†ç»Ÿä¸€çš„å—I/Oå¤„ç†æ¡†æ¶ï¼š</p>
<div class="codehilite"><pre><span></span><code>    ç”¨æˆ·ç©ºé—´
        |
    ç³»ç»Ÿè°ƒç”¨ (read/write/mmap)
        |
    â”Œâ”€â”€â”€â”€â”€â”
    â”‚ VFS â”‚ (è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ)
    â””â”€â”€â”¬â”€â”€â”˜
       â”‚
    â”Œâ”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Page Cacheâ”‚ (é¡µç¼“å­˜)
    â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
    â”Œâ”€â”€â”´â”€â”€â”€â”€â”€â”€â”
    â”‚ æ–‡ä»¶ç³»ç»Ÿ â”‚ (ext4/xfs/btrfs...)
    â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ submit_bio()
    â”Œâ”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  å—è®¾å¤‡å±‚(Block Layer)  â”‚
    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚ â”‚ bio å±‚   â”‚ â”‚ (å—I/Oå±‚)
    â”‚ â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚    â”‚make_request
    â”‚ â”Œâ”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚ â”‚ è¯·æ±‚é˜Ÿåˆ—  â”‚ â”‚ (request queue)
    â”‚ â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚    â”‚         â”‚
    â”‚ â”Œâ”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚ â”‚I/Oè°ƒåº¦å™¨ â”‚ â”‚ (elevator)
    â”‚ â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
    â”‚ å—è®¾å¤‡é©±åŠ¨ â”‚ (scsi/nvme/virtio-blk...)
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
    â”‚ ç¡¬ä»¶è®¾å¤‡  â”‚ (HDD/SSD/NVMe...)
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="712">7.1.2 æ ¸å¿ƒæ•°æ®ç»“æ„</h3>
<h4 id="bioblock-io">bioï¼ˆBlock I/Oï¼‰</h4>
<p>bioæ˜¯å—I/Oæ“ä½œçš„åŸºæœ¬å•ä½ï¼Œæè¿°äº†ä¸€æ¬¡I/Oæ“ä½œçš„æ‰€æœ‰ä¿¡æ¯ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">bio</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bio</span><span class="w">        </span><span class="o">*</span><span class="n">bi_next</span><span class="p">;</span><span class="w">      </span><span class="cm">/* è¯·æ±‚é“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªbio */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">gendisk</span><span class="w">    </span><span class="o">*</span><span class="n">bi_disk</span><span class="p">;</span><span class="w">      </span><span class="cm">/* ç›®æ ‡ç£ç›˜ */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">      </span><span class="n">bi_opf</span><span class="p">;</span><span class="w">        </span><span class="cm">/* æ“ä½œæ ‡å¿—(REQ_OP_*) */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">short</span><span class="w">    </span><span class="n">bi_flags</span><span class="p">;</span><span class="w">      </span><span class="cm">/* bioæ ‡å¿— */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">short</span><span class="w">    </span><span class="n">bi_ioprio</span><span class="p">;</span><span class="w">     </span><span class="cm">/* I/Oä¼˜å…ˆçº§ */</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bvec_iter</span><span class="w">  </span><span class="n">bi_iter</span><span class="p">;</span><span class="w">       </span><span class="cm">/* å½“å‰è¿­ä»£å™¨ä½ç½® */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">      </span><span class="n">bi_size</span><span class="p">;</span><span class="w">       </span><span class="cm">/* å‰©ä½™I/Oå­—èŠ‚æ•° */</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">short</span><span class="w">    </span><span class="n">bi_vcnt</span><span class="p">;</span><span class="w">       </span><span class="cm">/* bio_vecæ•°é‡ */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">short</span><span class="w">    </span><span class="n">bi_max_vecs</span><span class="p">;</span><span class="w">   </span><span class="cm">/* æœ€å¤§bio_vecæ•°é‡ */</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w">          </span><span class="n">bi_cnt</span><span class="p">;</span><span class="w">        </span><span class="cm">/* å¼•ç”¨è®¡æ•° */</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bio_vec</span><span class="w">    </span><span class="o">*</span><span class="n">bi_io_vec</span><span class="p">;</span><span class="w">    </span><span class="cm">/* å®é™…çš„vecåˆ—è¡¨ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bio_set</span><span class="w">    </span><span class="o">*</span><span class="n">bi_pool</span><span class="p">;</span><span class="w">      </span><span class="cm">/* bioå†…å­˜æ±  */</span>

<span class="w">    </span><span class="cm">/* å›è°ƒå’Œç§æœ‰æ•°æ® */</span>
<span class="w">    </span><span class="n">bio_end_io_t</span><span class="w">      </span><span class="o">*</span><span class="n">bi_end_io</span><span class="p">;</span><span class="w">    </span><span class="cm">/* I/Oå®Œæˆå›è°ƒ */</span>
<span class="w">    </span><span class="kt">void</span><span class="w">              </span><span class="o">*</span><span class="n">bi_private</span><span class="p">;</span><span class="w">   </span><span class="cm">/* ç§æœ‰æ•°æ® */</span>
<span class="p">};</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">bio_vec</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w">     </span><span class="o">*</span><span class="n">bv_page</span><span class="p">;</span><span class="w">     </span><span class="cm">/* ç‰©ç†é¡µ */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">    </span><span class="n">bv_len</span><span class="p">;</span><span class="w">       </span><span class="cm">/* æ•°æ®é•¿åº¦ */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">    </span><span class="n">bv_offset</span><span class="p">;</span><span class="w">    </span><span class="cm">/* é¡µå†…åç§» */</span>
<span class="p">};</span>
</code></pre></div>

<p>bioçš„å…³é”®ç‰¹æ€§ï¼š</p>
<ul>
<li><strong>æ•£åˆ—èšé›†æ”¯æŒ</strong>ï¼šé€šè¿‡bio_vecæ•°ç»„æ”¯æŒéè¿ç»­å†…å­˜</li>
<li><strong>é“¾å¼ç»“æ„</strong>ï¼šå¤šä¸ªbioå¯ä»¥é“¾æ¥æè¿°å¤§å—I/O</li>
<li><strong>é›¶æ‹·è´</strong>ï¼šç›´æ¥å¼•ç”¨ç”¨æˆ·ç©ºé—´é¡µé¢ï¼Œé¿å…æ•°æ®å¤åˆ¶</li>
</ul>
<h4 id="requestio">requestï¼ˆI/Oè¯·æ±‚ï¼‰</h4>
<p>requestæ˜¯ç»è¿‡åˆå¹¶ä¼˜åŒ–åçš„I/Oè¯·æ±‚å•ä½ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">request</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">request_queue</span><span class="w"> </span><span class="o">*</span><span class="n">q</span><span class="p">;</span><span class="w">         </span><span class="cm">/* æ‰€å±è¯·æ±‚é˜Ÿåˆ— */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">blk_mq_ctx</span><span class="w">    </span><span class="o">*</span><span class="n">mq_ctx</span><span class="p">;</span><span class="w">    </span><span class="cm">/* blk-mqä¸Šä¸‹æ–‡ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">blk_mq_hw_ctx</span><span class="w"> </span><span class="o">*</span><span class="n">mq_hctx</span><span class="p">;</span><span class="w">   </span><span class="cm">/* ç¡¬ä»¶é˜Ÿåˆ—ä¸Šä¸‹æ–‡ */</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">cmd_flags</span><span class="p">;</span><span class="w">          </span><span class="cm">/* å‘½ä»¤æ ‡å¿— */</span>
<span class="w">    </span><span class="n">req_flags_t</span><span class="w">  </span><span class="n">rq_flags</span><span class="p">;</span><span class="w">           </span><span class="cm">/* è¯·æ±‚æ ‡å¿— */</span>

<span class="w">    </span><span class="n">sector_t</span><span class="w">     </span><span class="n">__sector</span><span class="p">;</span><span class="w">           </span><span class="cm">/* èµ·å§‹æ‰‡åŒº */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__data_len</span><span class="p">;</span><span class="w">         </span><span class="cm">/* æ•°æ®é•¿åº¦ */</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bio</span><span class="w">   </span><span class="o">*</span><span class="n">bio</span><span class="p">;</span><span class="w">               </span><span class="cm">/* bioé“¾è¡¨å¤´ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bio</span><span class="w">   </span><span class="o">*</span><span class="n">biotail</span><span class="p">;</span><span class="w">           </span><span class="cm">/* bioé“¾è¡¨å°¾ */</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">queuelist</span><span class="p">;</span><span class="w">      </span><span class="cm">/* é˜Ÿåˆ—é“¾è¡¨ */</span>

<span class="w">    </span><span class="cm">/* ç”¨äºI/Oç»Ÿè®¡ */</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">start_time_ns</span><span class="p">;</span><span class="w">              </span><span class="cm">/* å¼€å§‹æ—¶é—´ */</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">io_start_time_ns</span><span class="p">;</span><span class="w">           </span><span class="cm">/* I/Oå¼€å§‹æ—¶é—´ */</span>

<span class="w">    </span><span class="cm">/* ç”¨äºè¶…æ—¶å¤„ç† */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">timeout</span><span class="p">;</span><span class="w">            </span><span class="cm">/* è¶…æ—¶æ—¶é—´ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">timer_list</span><span class="w"> </span><span class="n">timeout_timer</span><span class="p">;</span><span class="w"> </span><span class="cm">/* è¶…æ—¶å®šæ—¶å™¨ */</span>
<span class="p">};</span>
</code></pre></div>

<h4 id="gendisk">gendiskï¼ˆé€šç”¨ç£ç›˜ï¼‰</h4>
<p>gendiskä»£è¡¨ä¸€ä¸ªå—è®¾å¤‡ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">gendisk</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">major</span><span class="p">;</span><span class="w">                      </span><span class="cm">/* ä¸»è®¾å¤‡å· */</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">first_minor</span><span class="p">;</span><span class="w">                </span><span class="cm">/* èµ·å§‹æ¬¡è®¾å¤‡å· */</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">minors</span><span class="p">;</span><span class="w">                     </span><span class="cm">/* æ¬¡è®¾å¤‡å·æ•°é‡ */</span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">disk_name</span><span class="p">[</span><span class="n">DISK_NAME_LEN</span><span class="p">];</span><span class="w"> </span><span class="cm">/* ç£ç›˜åç§°(å¦‚sda) */</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">request_queue</span><span class="w"> </span><span class="o">*</span><span class="n">queue</span><span class="p">;</span><span class="w">    </span><span class="cm">/* è¯·æ±‚é˜Ÿåˆ— */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">block_device</span><span class="w"> </span><span class="o">*</span><span class="n">part0</span><span class="p">;</span><span class="w">     </span><span class="cm">/* æ•´ä¸ªç£ç›˜çš„å—è®¾å¤‡ */</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">block_device_operations</span><span class="w"> </span><span class="o">*</span><span class="n">fops</span><span class="p">;</span><span class="w"> </span><span class="cm">/* å—è®¾å¤‡æ“ä½œ */</span>

<span class="w">    </span><span class="cm">/* åˆ†åŒºä¿¡æ¯ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">disk_part_tbl</span><span class="w"> </span><span class="n">__rcu</span><span class="w"> </span><span class="o">*</span><span class="n">part_tbl</span><span class="p">;</span><span class="w">  </span><span class="cm">/* åˆ†åŒºè¡¨ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hd_struct</span><span class="w"> </span><span class="n">part0</span><span class="p">;</span><span class="w">                </span><span class="cm">/* æ•´ç›˜åˆ†åŒº */</span>

<span class="w">    </span><span class="cm">/* å®¹é‡ä¿¡æ¯ */</span>
<span class="w">    </span><span class="n">sector_t</span><span class="w"> </span><span class="n">capacity</span><span class="p">;</span><span class="w">              </span><span class="cm">/* ç£ç›˜å®¹é‡(æ‰‡åŒº) */</span>

<span class="w">    </span><span class="cm">/* ç»Ÿè®¡ä¿¡æ¯ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">disk_stats</span><span class="w"> </span><span class="n">__percpu</span><span class="w"> </span><span class="o">*</span><span class="n">dkstats</span><span class="p">;</span><span class="w">   </span><span class="cm">/* ç£ç›˜ç»Ÿè®¡ */</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="713">7.1.3 å—è®¾å¤‡é©±åŠ¨æ¥å£</h3>
<p>å—è®¾å¤‡é©±åŠ¨éœ€è¦å®ç°block_device_operationsæ¥å£ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">block_device_operations</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">open</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">block_device</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">fmode_t</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">release</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">gendisk</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">fmode_t</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">ioctl</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">block_device</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">fmode_t</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">compat_ioctl</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">block_device</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">fmode_t</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">direct_access</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">block_device</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">sector_t</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">media_changed</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">gendisk</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">revalidate_disk</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">gendisk</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">getgeo</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">block_device</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">hd_geometry</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">swap_slot_free_notify</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">block_device</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">module</span><span class="w"> </span><span class="o">*</span><span class="n">owner</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="714">7.1.4 è¯·æ±‚å¤„ç†æµç¨‹</h3>
<p>å®Œæ•´çš„I/Oè¯·æ±‚å¤„ç†æµç¨‹ï¼š</p>
<ol>
<li><strong>bioæäº¤é˜¶æ®µ</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="n">æ–‡ä»¶ç³»ç»Ÿ</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">submit_bio</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">generic_make_request</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">è¯·æ±‚é˜Ÿåˆ—</span>
</code></pre></div>

<ol start="2">
<li><strong>è¯·æ±‚åˆå¹¶é˜¶æ®µ</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="n">bio</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">ç”µæ¢¯ç®—æ³•åˆå¹¶</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">æ’å…¥è°ƒåº¦é˜Ÿåˆ—</span>
</code></pre></div>

<ol start="3">
<li><strong>è¯·æ±‚æ´¾å‘é˜¶æ®µ</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="n">è°ƒåº¦å™¨</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">blk_mq_dispatch_rq_list</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">é©±åŠ¨ç¨‹åº</span>
</code></pre></div>

<ol start="4">
<li><strong>å®Œæˆå¤„ç†é˜¶æ®µ</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="n">ä¸­æ–­å¤„ç†</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">blk_mq_complete_request</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">bio_endio</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">å”¤é†’ç­‰å¾…è¿›ç¨‹</span>
</code></pre></div>

<hr />
<h2 id="72-io_1">7.2 I/Oè°ƒåº¦å™¨æ¼”è¿›</h2>
<p>I/Oè°ƒåº¦å™¨è´Ÿè´£å¯¹å—è®¾å¤‡è¯·æ±‚è¿›è¡Œé‡æ’åºå’Œåˆå¹¶ï¼Œä»¥æé«˜ç£ç›˜è®¿é—®æ•ˆç‡ã€‚Linuxå†…æ ¸æä¾›äº†å¤šç§è°ƒåº¦ç®—æ³•ï¼Œé€‚åº”ä¸åŒçš„å­˜å‚¨è®¾å¤‡å’Œå·¥ä½œè´Ÿè½½ã€‚</p>
<h3 id="721">7.2.1 ä¼ ç»Ÿè°ƒåº¦å™¨</h3>
<h4 id="cfqcompletely-fair-queuing">CFQï¼ˆCompletely Fair Queuingï¼‰</h4>
<p>CFQæ˜¯Linuxé•¿æœŸçš„é»˜è®¤è°ƒåº¦å™¨ï¼Œä¸ºæ¯ä¸ªè¿›ç¨‹ç»´æŠ¤ç‹¬ç«‹çš„I/Oé˜Ÿåˆ—ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">cfq_data</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">request_queue</span><span class="w"> </span><span class="o">*</span><span class="n">queue</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* æœåŠ¡æ ‘(çº¢é»‘æ ‘)æŒ‰ä¼˜å…ˆçº§ç»„ç»‡ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">cfq_rb_root</span><span class="w"> </span><span class="n">service_trees</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">];</span><span class="w">  </span><span class="cm">/* sync/async, 3ä¸ªä¼˜å…ˆçº§ */</span>

<span class="w">    </span><span class="cm">/* ç©ºé—²å’Œå¿™ç¢Œé˜Ÿåˆ— */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">idle_list</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">busy_list</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* æ—¶é—´ç‰‡å’Œé…é¢ */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">cfq_quantum</span><span class="p">;</span><span class="w">        </span><span class="cm">/* é˜Ÿåˆ—æ—¶é—´ç‰‡ */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">cfq_slice</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w">       </span><span class="cm">/* sync/asyncæ—¶é—´ç‰‡ */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">cfq_slice_idle</span><span class="p">;</span><span class="w">     </span><span class="cm">/* ç©ºé—²ç­‰å¾…æ—¶é—´ */</span>

<span class="w">    </span><span class="cm">/* ç»Ÿè®¡ä¿¡æ¯ */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">busy_queues</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">cfq_io_context</span><span class="w"> </span><span class="o">*</span><span class="n">active_cic</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>

<p>CFQçš„æ ¸å¿ƒç®—æ³•ï¼š</p>
<ul>
<li><strong>è¿›ç¨‹å…¬å¹³æ€§</strong>ï¼šæ¯ä¸ªè¿›ç¨‹è·å¾—å…¬å¹³çš„I/Oå¸¦å®½ä»½é¢</li>
<li><strong>åŒæ­¥ä¼˜å…ˆ</strong>ï¼šåŒæ­¥I/Oä¼˜å…ˆäºå¼‚æ­¥I/O</li>
<li><strong>æ—¶é—´ç‰‡è½®è½¬</strong>ï¼šç±»ä¼¼CPUè°ƒåº¦çš„æ—¶é—´ç‰‡æœºåˆ¶</li>
<li><strong>é¢„æœŸæ€è€ƒæ—¶é—´</strong>ï¼šä¸ºé¡ºåºè¯»é¢„ç•™ç­‰å¾…æ—¶é—´</li>
</ul>
<h4 id="deadline">Deadlineè°ƒåº¦å™¨</h4>
<p>Deadlineè°ƒåº¦å™¨é€šè¿‡æˆªæ­¢æ—¶é—´ä¿è¯I/Oå»¶è¿Ÿä¸Šç•Œï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">deadline_data</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* è¯·æ±‚é˜Ÿåˆ—ï¼šè¯»å†™åˆ†ç¦»ï¼ŒæŒ‰æ‰‡åŒºæ’åº */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rb_root</span><span class="w"> </span><span class="n">sort_list</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w">     </span><span class="cm">/* è¯»/å†™çº¢é»‘æ ‘ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">fifo_list</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w">   </span><span class="cm">/* FIFOé˜Ÿåˆ— */</span>

<span class="w">    </span><span class="cm">/* å½“å‰æ‰¹å¤„ç† */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">request</span><span class="w"> </span><span class="o">*</span><span class="n">next_rq</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w">      </span><span class="cm">/* ä¸‹ä¸€ä¸ªè¯·æ±‚ */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">batching</span><span class="p">;</span><span class="w">            </span><span class="cm">/* æ‰¹å¤„ç†è®¡æ•° */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">starved</span><span class="p">;</span><span class="w">             </span><span class="cm">/* é¥¥é¥¿è®¡æ•° */</span>

<span class="w">    </span><span class="cm">/* è°ƒåº¦å‚æ•° */</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fifo_expire</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w">              </span><span class="cm">/* è¯»500ms,å†™5000ms */</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fifo_batch</span><span class="p">;</span><span class="w">                  </span><span class="cm">/* æ‰¹å¤§å°16 */</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">writes_starved</span><span class="p">;</span><span class="w">              </span><span class="cm">/* å†™é¥¥é¥¿é˜ˆå€¼2 */</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">front_merges</span><span class="p">;</span><span class="w">                </span><span class="cm">/* å‰å‘åˆå¹¶å¼€å…³ */</span>
<span class="p">};</span>
</code></pre></div>

<p>Deadlineç‰¹ç‚¹ï¼š</p>
<ul>
<li><strong>åŒé˜Ÿåˆ—æœºåˆ¶</strong>ï¼šæ’åºé˜Ÿåˆ—(çº¢é»‘æ ‘) + FIFOé˜Ÿåˆ—</li>
<li><strong>æˆªæ­¢æ—¶é—´ä¿è¯</strong>ï¼šè¯»è¯·æ±‚500msï¼Œå†™è¯·æ±‚5s</li>
<li><strong>é˜²æ­¢é¥¥é¥¿</strong>ï¼šé€šè¿‡starvedè®¡æ•°é˜²æ­¢å†™è¯·æ±‚é¥¥é¥¿</li>
<li><strong>æ‰¹å¤„ç†ä¼˜åŒ–</strong>ï¼šè¿ç»­å¤„ç†å¤šä¸ªç›¸é‚»è¯·æ±‚</li>
</ul>
<h4 id="noop">NOOPè°ƒåº¦å™¨</h4>
<p>æœ€ç®€å•çš„è°ƒåº¦å™¨ï¼Œä»…åšåŸºæœ¬çš„è¯·æ±‚åˆå¹¶ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">noop_data</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">queue</span><span class="p">;</span><span class="w">  </span><span class="cm">/* ç®€å•FIFOé˜Ÿåˆ— */</span>
<span class="p">};</span>
</code></pre></div>

<p>é€‚ç”¨åœºæ™¯ï¼š</p>
<ul>
<li>SSDç­‰éšæœºè®¿é—®æ€§èƒ½å¥½çš„è®¾å¤‡</li>
<li>è™šæ‹Ÿæœºä¸­çš„è™šæ‹Ÿç£ç›˜</li>
<li>éœ€è¦ä¸Šå±‚è‡ªè¡Œæ§åˆ¶I/Oé¡ºåºçš„åœºæ™¯</li>
</ul>
<h3 id="722">7.2.2 å¤šé˜Ÿåˆ—è°ƒåº¦å™¨</h3>
<p>éšç€NVMeç­‰é«˜æ€§èƒ½å­˜å‚¨è®¾å¤‡çš„æ™®åŠï¼Œä¼ ç»Ÿå•é˜Ÿåˆ—è°ƒåº¦å™¨æˆä¸ºç“¶é¢ˆã€‚Linuxå¼•å…¥äº†åŸºäºblk-mqçš„æ–°ä¸€ä»£è°ƒåº¦å™¨ã€‚</p>
<h4 id="mq-deadline">mq-deadline</h4>
<p>å¤šé˜Ÿåˆ—ç‰ˆæœ¬çš„deadlineè°ƒåº¦å™¨ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">mq_deadline_data</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* per-hardware queue */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">deadline_data</span><span class="w"> </span><span class="o">**</span><span class="n">hq_data</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* å…¨å±€ç»Ÿè®¡ */</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">dispatched</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="w">    </span><span class="cm">/* æ¯CPUç»Ÿè®¡é¿å…ç¼“å­˜è¡Œç«äº‰ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mq_deadline_cpu_stats</span><span class="w"> </span><span class="n">__percpu</span><span class="w"> </span><span class="o">*</span><span class="n">stats</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>

<h4 id="bfqbudget-fair-queueing">BFQï¼ˆBudget Fair Queueingï¼‰</h4>
<p>BFQæ˜¯ä¸“ä¸ºäº¤äº’å¼å’Œè½¯å®æ—¶åº”ç”¨ä¼˜åŒ–çš„è°ƒåº¦å™¨ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">bfq_data</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* æœåŠ¡æ ‘ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bfq_group</span><span class="w"> </span><span class="o">*</span><span class="n">root_group</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* æƒé‡æ ‘ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rb_root</span><span class="w"> </span><span class="n">queue_weights_tree</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rb_root</span><span class="w"> </span><span class="n">group_weights_tree</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* é¢„ç®—å’Œæ—¶é—´ç‰‡ */</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">bfq_max_budget</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">bfq_timeout</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* äº¤äº’æ€§æ£€æµ‹ */</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">strict_guarantees</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">low_latency</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>

<p>BFQç‰¹æ€§ï¼š</p>
<ul>
<li><strong>é¢„ç®—å…¬å¹³</strong>ï¼šåŸºäºé¢„ç®—è€Œéæ—¶é—´çš„å…¬å¹³æ€§</li>
<li><strong>ä½å»¶è¿Ÿä¿è¯</strong>ï¼šä¸ºäº¤äº’å¼åº”ç”¨æä¾›å“åº”æ€§ä¿è¯</li>
<li><strong>cgroupæ”¯æŒ</strong>ï¼šä¸cgroup v2æ·±åº¦é›†æˆ</li>
</ul>
<h4 id="kyber">Kyber</h4>
<p>Kyberæ˜¯ä¸ºå¿«é€ŸNVMeè®¾å¤‡è®¾è®¡çš„è½»é‡çº§è°ƒåº¦å™¨ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">kyber_data</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* ä»¤ç‰Œæ¡¶ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kyber_token_bucket</span><span class="w"> </span><span class="n">tb</span><span class="p">[</span><span class="n">KYBER_NUM_DOMAINS</span><span class="p">];</span>

<span class="w">    </span><span class="cm">/* å»¶è¿Ÿç›®æ ‡ */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">read_lat_nsec</span><span class="p">;</span><span class="w">   </span><span class="cm">/* 2ms */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">write_lat_nsec</span><span class="p">;</span><span class="w">  </span><span class="cm">/* 10ms */</span>

<span class="w">    </span><span class="cm">/* è‡ªé€‚åº”è°ƒæ•´ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">timer_list</span><span class="w"> </span><span class="n">timer</span><span class="p">;</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">samples</span><span class="p">[</span><span class="n">KYBER_NUM_DOMAINS</span><span class="p">];</span>
<span class="p">};</span>
</code></pre></div>

<p>Kyberä½¿ç”¨ä»¤ç‰Œæ¡¶ç®—æ³•æ§åˆ¶I/Oå»¶è¿Ÿï¼š</p>
<ul>
<li><strong>å»¶è¿Ÿç›®æ ‡</strong>ï¼šè¯»2msï¼Œå†™10ms</li>
<li><strong>åŠ¨æ€è°ƒæ•´</strong>ï¼šæ ¹æ®å®é™…å»¶è¿Ÿè°ƒæ•´ä»¤ç‰Œå‘æ”¾é€Ÿç‡</li>
<li><strong>æç®€è®¾è®¡</strong>ï¼šé€‚åˆé«˜é€Ÿè®¾å¤‡çš„ä½å¼€é”€è°ƒåº¦</li>
</ul>
<h3 id="723">7.2.3 è°ƒåº¦å™¨é€‰æ‹©ç­–ç•¥</h3>
<p>ä¸åŒå­˜å‚¨è®¾å¤‡å’Œå·¥ä½œè´Ÿè½½çš„æœ€ä½³è°ƒåº¦å™¨é€‰æ‹©ï¼š</p>
<p>| å­˜å‚¨ç±»å‹ | å·¥ä½œè´Ÿè½½ | æ¨èè°ƒåº¦å™¨ | ç†ç”± |</p>
<table>
<thead>
<tr>
<th>å­˜å‚¨ç±»å‹</th>
<th>å·¥ä½œè´Ÿè½½</th>
<th>æ¨èè°ƒåº¦å™¨</th>
<th>ç†ç”±</th>
</tr>
</thead>
<tbody>
<tr>
<td>HDD</td>
<td>æœåŠ¡å™¨æ··åˆè´Ÿè½½</td>
<td>mq-deadline</td>
<td>å¹³è¡¡ååé‡å’Œå»¶è¿Ÿ</td>
</tr>
<tr>
<td>HDD</td>
<td>æ¡Œé¢åº”ç”¨</td>
<td>bfq</td>
<td>ä¼˜ç§€çš„äº¤äº’æ€§</td>
</tr>
<tr>
<td>SATA SSD</td>
<td>é€šç”¨è´Ÿè½½</td>
<td>mq-deadline</td>
<td>ç¨³å®šå¯é </td>
</tr>
<tr>
<td>NVMe SSD</td>
<td>é«˜æ€§èƒ½æœåŠ¡å™¨</td>
<td>none/kyber</td>
<td>æœ€å°å¼€é”€</td>
</tr>
<tr>
<td>è™šæ‹Ÿç£ç›˜</td>
<td>è™šæ‹Ÿæœº</td>
<td>none</td>
<td>é¿å…é‡å¤è°ƒåº¦</td>
</tr>
</tbody>
</table>
<p>è¿è¡Œæ—¶åˆ‡æ¢è°ƒåº¦å™¨ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># æŸ¥çœ‹å½“å‰è°ƒåº¦å™¨</span>
cat<span class="w"> </span>/sys/block/sda/queue/scheduler

<span class="c1"># åˆ‡æ¢è°ƒåº¦å™¨</span>
<span class="nb">echo</span><span class="w"> </span>mq-deadline<span class="w"> </span>&gt;<span class="w"> </span>/sys/block/sda/queue/scheduler
</code></pre></div>

<h3 id="724">7.2.4 æ€§èƒ½å¯¹æ¯”ä¸åœºæ™¯é€‚ç”¨</h3>
<p>å…³é”®æ€§èƒ½æŒ‡æ ‡å¯¹æ¯”ï¼ˆç›¸å¯¹å€¼ï¼‰ï¼š</p>
<p>| è°ƒåº¦å™¨ | é¡ºåºååé‡ | éšæœºIOPS | å¹³å‡å»¶è¿Ÿ | CPUå¼€é”€ | å…¬å¹³æ€§ |</p>
<table>
<thead>
<tr>
<th>è°ƒåº¦å™¨</th>
<th>é¡ºåºååé‡</th>
<th>éšæœºIOPS</th>
<th>å¹³å‡å»¶è¿Ÿ</th>
<th>CPUå¼€é”€</th>
<th>å…¬å¹³æ€§</th>
</tr>
</thead>
<tbody>
<tr>
<td>noop</td>
<td>ä¸­</td>
<td>é«˜</td>
<td>ä½</td>
<td>æä½</td>
<td>å·®</td>
</tr>
<tr>
<td>deadline</td>
<td>é«˜</td>
<td>ä¸­</td>
<td>å¯æ§</td>
<td>ä½</td>
<td>ä¸­</td>
</tr>
<tr>
<td>cfq</td>
<td>ä¸­</td>
<td>ä½</td>
<td>ä¸­</td>
<td>é«˜</td>
<td>ä¼˜ç§€</td>
</tr>
<tr>
<td>mq-deadline</td>
<td>é«˜</td>
<td>é«˜</td>
<td>å¯æ§</td>
<td>ä½</td>
<td>ä¸­</td>
</tr>
<tr>
<td>bfq</td>
<td>ä¸­</td>
<td>ä¸­</td>
<td>æä½</td>
<td>è¾ƒé«˜</td>
<td>ä¼˜ç§€</td>
</tr>
<tr>
<td>kyber</td>
<td>é«˜</td>
<td>æé«˜</td>
<td>å¯æ§</td>
<td>æä½</td>
<td>ä¸­</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="73-blk-mq_1">7.3 å¤šé˜Ÿåˆ—å—å±‚ï¼ˆblk-mqï¼‰</h2>
<h3 id="731">7.3.1 ä»å•é˜Ÿåˆ—åˆ°å¤šé˜Ÿåˆ—çš„æ¶æ„å˜é©</h3>
<p>ä¼ ç»Ÿå•é˜Ÿåˆ—æ¶æ„çš„ç“¶é¢ˆï¼š</p>
<div class="codehilite"><pre><span></span><code>    æ‰€æœ‰CPU
        â†“
    [å…¨å±€é”]
        â†“
   å•ä¸€è¯·æ±‚é˜Ÿåˆ—
        â†“
    I/Oè°ƒåº¦å™¨
        â†“
     è®¾å¤‡é©±åŠ¨
</code></pre></div>

<p>å¤šé˜Ÿåˆ—æ¶æ„çš„é©æ–°ï¼š</p>
<div class="codehilite"><pre><span></span><code>  CPU0    CPU1    CPU2    CPU3
    â†“       â†“       â†“       â†“
  SWQ0    SWQ1    SWQ2    SWQ3  (è½¯ä»¶é˜Ÿåˆ—)
    â†“       â†“       â†“       â†“
    â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
         [æ˜ å°„ç®—æ³•]
              â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  HWQ0    HWQ1       â”‚     (ç¡¬ä»¶é˜Ÿåˆ—)
    â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“        â†“
    [æ ‡ç­¾0]  [æ ‡ç­¾1]            (æ ‡ç­¾ç®¡ç†)
       â†“        â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   NVMeè®¾å¤‡   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="732">7.3.2 è½¯ä»¶é˜Ÿåˆ—ä¸ç¡¬ä»¶é˜Ÿåˆ—æ˜ å°„</h3>
<p>blk-mqçš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">blk_mq_hw_ctx</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">spinlock_t</span><span class="w">      </span><span class="n">lock</span><span class="p">;</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">dispatch</span><span class="p">;</span><span class="w">     </span><span class="cm">/* æ´¾å‘é˜Ÿåˆ— */</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">    </span><span class="n">state</span><span class="p">;</span><span class="w">         </span><span class="cm">/* é˜Ÿåˆ—çŠ¶æ€ */</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">____cacheline_aligned_in_smp</span><span class="p">;</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">delayed_work</span><span class="w"> </span><span class="n">run_work</span><span class="p">;</span><span class="w">      </span><span class="cm">/* å¼‚æ­¥è¿è¡Œ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">delayed_work</span><span class="w"> </span><span class="n">delay_work</span><span class="p">;</span><span class="w">    </span><span class="cm">/* å»¶è¿Ÿå¤„ç† */</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">       </span><span class="n">flags</span><span class="p">;</span><span class="w">         </span><span class="cm">/* BLK_MQ_F_* */</span>

<span class="w">    </span><span class="kt">void</span><span class="w">               </span><span class="o">*</span><span class="n">driver_data</span><span class="p">;</span><span class="w">   </span><span class="cm">/* é©±åŠ¨ç§æœ‰æ•°æ® */</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sbitmap</span><span class="w">      </span><span class="n">ctx_map</span><span class="p">;</span><span class="w">       </span><span class="cm">/* è½¯ä»¶é˜Ÿåˆ—ä½å›¾ */</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">blk_mq_ctx</span><span class="w">  </span><span class="o">**</span><span class="n">ctxs</span><span class="p">;</span><span class="w">        </span><span class="cm">/* è½¯ä»¶é˜Ÿåˆ—æ•°ç»„ */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">        </span><span class="n">nr_ctx</span><span class="p">;</span><span class="w">        </span><span class="cm">/* è½¯ä»¶é˜Ÿåˆ—æ•°é‡ */</span>

<span class="w">    </span><span class="n">atomic_t</span><span class="w">            </span><span class="n">wait_index</span><span class="p">;</span><span class="w">    </span><span class="cm">/* ç­‰å¾…ç´¢å¼• */</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">blk_mq_tags</span><span class="w"> </span><span class="o">*</span><span class="n">tags</span><span class="p">;</span><span class="w">          </span><span class="cm">/* æ ‡ç­¾é›† */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">blk_mq_tags</span><span class="w"> </span><span class="o">*</span><span class="n">sched_tags</span><span class="p">;</span><span class="w">   </span><span class="cm">/* è°ƒåº¦å™¨æ ‡ç­¾ */</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">       </span><span class="n">queued</span><span class="p">;</span><span class="w">        </span><span class="cm">/* æ’é˜Ÿè¯·æ±‚æ•° */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">       </span><span class="n">run</span><span class="p">;</span><span class="w">           </span><span class="cm">/* è¿è¡Œæ¬¡æ•° */</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">        </span><span class="n">numa_node</span><span class="p">;</span><span class="w">     </span><span class="cm">/* NUMAèŠ‚ç‚¹ */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">        </span><span class="n">queue_num</span><span class="p">;</span><span class="w">     </span><span class="cm">/* é˜Ÿåˆ—ç¼–å· */</span>
<span class="p">};</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">blk_mq_ctx</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">spinlock_t</span><span class="w">      </span><span class="n">lock</span><span class="p">;</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">rq_list</span><span class="p">;</span><span class="w">      </span><span class="cm">/* è¯·æ±‚åˆ—è¡¨ */</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">____cacheline_aligned_in_smp</span><span class="p">;</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">        </span><span class="n">cpu</span><span class="p">;</span><span class="w">           </span><span class="cm">/* æ‰€å±CPU */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">        </span><span class="n">index_hw</span><span class="p">;</span><span class="w">      </span><span class="cm">/* ç¡¬ä»¶é˜Ÿåˆ—ç´¢å¼• */</span>

<span class="w">    </span><span class="cm">/* ç»Ÿè®¡ä¿¡æ¯ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">blk_mq_ctxs</span><span class="w">  </span><span class="o">*</span><span class="n">ctxs</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kobject</span><span class="w">      </span><span class="n">kobj</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">____cacheline_aligned_in_smp</span><span class="p">;</span>
</code></pre></div>

<p>CPUåˆ°ç¡¬ä»¶é˜Ÿåˆ—çš„æ˜ å°„ç®—æ³•ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* é»˜è®¤æ˜ å°„ï¼šè½®è¯¢åˆ†é… */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">blk_mq_map_queues</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">blk_mq_tag_set</span><span class="w"> </span><span class="o">*</span><span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">set</span><span class="o">-&gt;</span><span class="n">mq_map</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nr_queues</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">set</span><span class="o">-&gt;</span><span class="n">nr_hw_queues</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">cpu</span><span class="p">,</span><span class="w"> </span><span class="n">queue</span><span class="p">;</span>

<span class="w">    </span><span class="n">queue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">map</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queue</span><span class="p">;</span>
<span class="w">        </span><span class="n">queue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">queue</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">nr_queues</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* NUMAæ„ŸçŸ¥æ˜ å°„ */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">blk_mq_map_queues_numa</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">blk_mq_tag_set</span><span class="w"> </span><span class="o">*</span><span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">cpumask</span><span class="w"> </span><span class="o">*</span><span class="n">mask</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">queue</span><span class="p">,</span><span class="w"> </span><span class="n">cpu</span><span class="p">;</span>

<span class="w">    </span><span class="n">queue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">for_each_node_mask</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">node_possible_map</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpumask_of_node</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
<span class="w">        </span><span class="n">for_each_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span><span class="w"> </span><span class="n">mask</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">set</span><span class="o">-&gt;</span><span class="n">mq_map</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queue</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">set</span><span class="o">-&gt;</span><span class="n">nr_hw_queues</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">queue</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="733">7.3.3 è¯·æ±‚åˆ†å‘ä¸å®Œæˆæœºåˆ¶</h3>
<p>è¯·æ±‚åˆ†å‘æµç¨‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* 1. bioæäº¤åˆ°è½¯ä»¶é˜Ÿåˆ— */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">blk_mq_make_request</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">request_queue</span><span class="w"> </span><span class="o">*</span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bio</span><span class="w"> </span><span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">blk_mq_ctx</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blk_mq_get_ctx</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">request</span><span class="w"> </span><span class="o">*</span><span class="n">rq</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* åˆ†é…è¯·æ±‚ */</span>
<span class="w">    </span><span class="n">rq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blk_mq_get_request</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="n">bio</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* åˆå§‹åŒ–è¯·æ±‚ */</span>
<span class="w">    </span><span class="n">blk_mq_bio_to_request</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span><span class="w"> </span><span class="n">bio</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* æ’å…¥è½¯ä»¶é˜Ÿåˆ— */</span>
<span class="w">    </span><span class="n">blk_mq_insert_request</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* è§¦å‘è¿è¡Œ */</span>
<span class="w">    </span><span class="n">blk_mq_run_hw_queue</span><span class="p">(</span><span class="n">hctx</span><span class="p">,</span><span class="w"> </span><span class="n">async</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* 2. ä»è½¯ä»¶é˜Ÿåˆ—æ´¾å‘åˆ°ç¡¬ä»¶é˜Ÿåˆ— */</span>
<span class="kt">bool</span><span class="w"> </span><span class="nf">blk_mq_dispatch_rq_list</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">blk_mq_hw_ctx</span><span class="w"> </span><span class="o">*</span><span class="n">hctx</span><span class="p">,</span>
<span class="w">                             </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">request</span><span class="w"> </span><span class="o">*</span><span class="n">rq</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">errors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">list</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">rq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">list_first_entry</span><span class="p">(</span><span class="n">list</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">request</span><span class="p">,</span><span class="w"> </span><span class="n">queuelist</span><span class="p">);</span>
<span class="w">        </span><span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">queuelist</span><span class="p">);</span>

<span class="w">        </span><span class="cm">/* è°ƒç”¨é©±åŠ¨çš„queue_rq */</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">q</span><span class="o">-&gt;</span><span class="n">mq_ops</span><span class="o">-&gt;</span><span class="n">queue_rq</span><span class="p">(</span><span class="n">hctx</span><span class="p">,</span><span class="w"> </span><span class="n">rq</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BLK_STS_OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">queued</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BLK_STS_RESOURCE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="cm">/* èµ„æºä¸è¶³ï¼Œé‡æ–°å…¥é˜Ÿ */</span>
<span class="w">            </span><span class="n">blk_mq_requeue_request</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">queued</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>è¯·æ±‚å®Œæˆå¤„ç†ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* ä¸­æ–­ä¸Šä¸‹æ–‡çš„å®Œæˆå¤„ç† */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">blk_mq_complete_request</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">request</span><span class="w"> </span><span class="o">*</span><span class="n">rq</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">blk_mq_ctx</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">mq_ctx</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* æ ‡è®°å®Œæˆ */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">blk_mark_rq_complete</span><span class="p">(</span><span class="n">rq</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* æœ¬åœ°CPUå¤„ç† */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">smp_processor_id</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">__blk_mq_complete_request</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* IPIåˆ°ç›®æ ‡CPU */</span>
<span class="w">        </span><span class="n">blk_mq_trigger_softirq</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* è½¯ä¸­æ–­ä¸­çš„å¤„ç† */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">__blk_mq_complete_request</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">request</span><span class="w"> </span><span class="o">*</span><span class="n">rq</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">request_queue</span><span class="w"> </span><span class="o">*</span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* æ›´æ–°ç»Ÿè®¡ */</span>
<span class="w">    </span><span class="n">blk_account_io_completion</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* è°ƒç”¨å®Œæˆå›è°ƒ */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">end_io</span><span class="p">)</span>
<span class="w">        </span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">end_io</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">blk_mq_free_request</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="734">7.3.4 æ ‡ç­¾ç®¡ç†ä¸å¹¶å‘æ§åˆ¶</h3>
<p>æ ‡ç­¾ç®¡ç†ç¡®ä¿è¯·æ±‚æ•°é‡å—æ§ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">blk_mq_tags</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nr_tags</span><span class="p">;</span><span class="w">       </span><span class="cm">/* æ ‡ç­¾æ€»æ•° */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nr_reserved</span><span class="p">;</span><span class="w">   </span><span class="cm">/* ä¿ç•™æ ‡ç­¾æ•° */</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sbitmap_queue</span><span class="w"> </span><span class="n">bitmap_tags</span><span class="p">;</span><span class="w">    </span><span class="cm">/* æ™®é€šæ ‡ç­¾ä½å›¾ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sbitmap_queue</span><span class="w"> </span><span class="n">breserved_tags</span><span class="p">;</span><span class="w"> </span><span class="cm">/* ä¿ç•™æ ‡ç­¾ä½å›¾ */</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">request</span><span class="w"> </span><span class="o">**</span><span class="n">rqs</span><span class="p">;</span><span class="w">       </span><span class="cm">/* è¯·æ±‚æ•°ç»„ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">page_list</span><span class="p">;</span><span class="w"> </span><span class="cm">/* å†…å­˜é¡µåˆ—è¡¨ */</span>
<span class="p">};</span>

<span class="cm">/* æ ‡ç­¾åˆ†é… */</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">blk_mq_get_tag</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">blk_mq_alloc_data</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">blk_mq_tags</span><span class="w"> </span><span class="o">*</span><span class="n">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">tags</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sbitmap_queue</span><span class="w"> </span><span class="o">*</span><span class="n">bt</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">tag</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* é€‰æ‹©ä½å›¾ï¼šæ™®é€šæˆ–ä¿ç•™ */</span>
<span class="w">    </span><span class="n">bt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tags</span><span class="o">-&gt;</span><span class="n">bitmap_tags</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">BLK_MQ_REQ_RESERVED</span><span class="p">)</span>
<span class="w">        </span><span class="n">bt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tags</span><span class="o">-&gt;</span><span class="n">breserved_tags</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* ä»ä½å›¾åˆ†é… */</span>
<span class="w">    </span><span class="n">tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__sbitmap_queue_get</span><span class="p">(</span><span class="n">bt</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tag</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">BLK_MQ_REQ_NOWAIT</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* ç­‰å¾…æ ‡ç­¾é‡Šæ”¾ */</span>
<span class="w">        </span><span class="n">blk_mq_wait_for_tag</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="w">        </span><span class="n">tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__sbitmap_queue_get</span><span class="p">(</span><span class="n">bt</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">tag</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>æ ‡ç­¾ç­‰å¾…å’Œå”¤é†’æœºåˆ¶ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* ç­‰å¾…æ ‡ç­¾ */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">blk_mq_wait_for_tag</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">blk_mq_alloc_data</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sbq_wait_state</span><span class="w"> </span><span class="o">*</span><span class="n">ws</span><span class="p">;</span>
<span class="w">    </span><span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>

<span class="w">    </span><span class="n">ws</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bt_wait_ptr</span><span class="p">(</span><span class="n">bt</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hctx</span><span class="p">);</span>

<span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ws</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span><span class="w"> </span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>

<span class="w">        </span><span class="n">tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__sbitmap_queue_get</span><span class="p">(</span><span class="n">bt</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tag</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="n">io_schedule</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="w">    </span><span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ws</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">tag</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* é‡Šæ”¾æ ‡ç­¾å¹¶å”¤é†’ç­‰å¾…è€… */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">blk_mq_put_tag</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">blk_mq_hw_ctx</span><span class="w"> </span><span class="o">*</span><span class="n">hctx</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">blk_mq_tags</span><span class="w"> </span><span class="o">*</span><span class="n">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hctx</span><span class="o">-&gt;</span><span class="n">tags</span><span class="p">;</span>

<span class="w">    </span><span class="n">sbitmap_queue_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tags</span><span class="o">-&gt;</span><span class="n">bitmap_tags</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* å”¤é†’ç­‰å¾…è€… */</span>
<span class="w">    </span><span class="n">sbitmap_queue_wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tags</span><span class="o">-&gt;</span><span class="n">bitmap_tags</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="74-device-mapper_1">7.4 è®¾å¤‡æ˜ å°„å™¨ï¼ˆDevice Mapperï¼‰</h2>
<p>Device Mapperæ˜¯Linuxå†…æ ¸ä¸­çš„ä¸€ä¸ªé€šç”¨æ¡†æ¶ï¼Œç”¨äºåˆ›å»ºè™šæ‹Ÿå—è®¾å¤‡ã€‚å®ƒä¸ºLVM2ã€è½¯ä»¶RAIDã€åŠ å¯†ç­‰æä¾›åº•å±‚æ”¯æŒã€‚</p>
<h3 id="741-dm">7.4.1 DMæ¶æ„ä¸ç›®æ ‡é©±åŠ¨</h3>
<p>DMçš„ä¸‰å±‚æ¶æ„ï¼š</p>
<div class="codehilite"><pre><span></span><code>    ç”¨æˆ·ç©ºé—´å·¥å…· (lvm2, cryptsetup, dmsetup)
            â†“ ioctl
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    Device Mapper Core    â”‚
    â”‚  (æ˜ å°„è¡¨ç®¡ç†ï¼ŒI/Oè·¯ç”±)    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚       Target Drivers          â”‚
    â”‚  (linear, striped, mirror,    â”‚
    â”‚   snapshot, crypt, thin...)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚     Underlying Devices        â”‚
    â”‚   (ç‰©ç†ç£ç›˜ã€åˆ†åŒºã€å…¶ä»–DMè®¾å¤‡)  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<p>æ ¸å¿ƒæ•°æ®ç»“æ„ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* æ˜ å°„è®¾å¤‡ */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">mapped_device</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rw_semaphore</span><span class="w"> </span><span class="n">io_lock</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mutex</span><span class="w"> </span><span class="n">suspend_lock</span><span class="p">;</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">request_queue</span><span class="w"> </span><span class="o">*</span><span class="n">queue</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">gendisk</span><span class="w"> </span><span class="o">*</span><span class="n">disk</span><span class="p">;</span>

<span class="w">    </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">holders</span><span class="p">;</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">open_count</span><span class="p">;</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dm_table</span><span class="w"> </span><span class="o">*</span><span class="n">map</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* I/Oç»Ÿè®¡ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dm_stats</span><span class="w"> </span><span class="n">stats</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* äº‹ä»¶å¤„ç† */</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">event_nr</span><span class="p">;</span>
<span class="w">    </span><span class="n">wait_queue_head_t</span><span class="w"> </span><span class="n">eventq</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* å·¥ä½œé˜Ÿåˆ— */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">workqueue_struct</span><span class="w"> </span><span class="o">*</span><span class="n">wq</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* æ˜ å°„è¡¨ */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">dm_table</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mapped_device</span><span class="w"> </span><span class="o">*</span><span class="n">md</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* ç›®æ ‡è®¾å¤‡æ•°ç»„ */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">num_targets</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dm_target</span><span class="w"> </span><span class="o">*</span><span class="n">targets</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* è®¾å¤‡é™åˆ¶ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">queue_limits</span><span class="w"> </span><span class="n">limits</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* åº•å±‚è®¾å¤‡åˆ—è¡¨ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">devices</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* ç›®æ ‡é©±åŠ¨ */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">target_type</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">module</span><span class="w"> </span><span class="o">*</span><span class="n">module</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">version</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

<span class="w">    </span><span class="cm">/* æ„é€ å’Œææ„ */</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">ctr</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dm_target</span><span class="w"> </span><span class="o">*</span><span class="n">ti</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">dtr</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dm_target</span><span class="w"> </span><span class="o">*</span><span class="n">ti</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* I/Oå¤„ç† */</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">map</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dm_target</span><span class="w"> </span><span class="o">*</span><span class="n">ti</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bio</span><span class="w"> </span><span class="o">*</span><span class="n">bio</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">end_io</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dm_target</span><span class="w"> </span><span class="o">*</span><span class="n">ti</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bio</span><span class="w"> </span><span class="o">*</span><span class="n">bio</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">error</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* ç®¡ç†æ“ä½œ */</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">preresume</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dm_target</span><span class="w"> </span><span class="o">*</span><span class="n">ti</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">resume</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dm_target</span><span class="w"> </span><span class="o">*</span><span class="n">ti</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">presuspend</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dm_target</span><span class="w"> </span><span class="o">*</span><span class="n">ti</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">postsuspend</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dm_target</span><span class="w"> </span><span class="o">*</span><span class="n">ti</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* çŠ¶æ€æŸ¥è¯¢ */</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">status</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dm_target</span><span class="w"> </span><span class="o">*</span><span class="n">ti</span><span class="p">,</span><span class="w"> </span><span class="n">status_type_t</span><span class="w"> </span><span class="n">type</span><span class="p">,</span>
<span class="w">                   </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">maxlen</span><span class="p">);</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">list</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="742">7.4.2 çº¿æ€§æ˜ å°„ä¸æ¡å¸¦åŒ–</h3>
<h4 id="dm-linear">çº¿æ€§æ˜ å°„ï¼ˆdm-linearï¼‰</h4>
<p>æœ€ç®€å•çš„ç›®æ ‡ç±»å‹ï¼Œå°†è™šæ‹Ÿè®¾å¤‡çš„è¿ç»­åŒºåŸŸæ˜ å°„åˆ°ç‰©ç†è®¾å¤‡ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">linear_c</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dm_dev</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">;</span>
<span class="w">    </span><span class="n">sector_t</span><span class="w"> </span><span class="n">start</span><span class="p">;</span><span class="w">  </span><span class="cm">/* ç‰©ç†è®¾å¤‡èµ·å§‹æ‰‡åŒº */</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">linear_map</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dm_target</span><span class="w"> </span><span class="o">*</span><span class="n">ti</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bio</span><span class="w"> </span><span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">linear_c</span><span class="w"> </span><span class="o">*</span><span class="n">lc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* é‡å®šå‘åˆ°åº•å±‚è®¾å¤‡ */</span>
<span class="w">    </span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
<span class="w">    </span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_iter</span><span class="p">.</span><span class="n">bi_sector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lc</span><span class="o">-&gt;</span><span class="n">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dm_target_offset</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span><span class="w"> </span><span class="n">bio</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">DM_MAPIO_REMAPPED</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>ä½¿ç”¨ç¤ºä¾‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># åˆ›å»ºçº¿æ€§æ˜ å°„ï¼šå°†/dev/sdb1å’Œ/dev/sdc1è¿æ¥</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;0 1000000 linear /dev/sdb1 0&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>dmsetup<span class="w"> </span>create<span class="w"> </span>linear1
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;1000000 1000000 linear /dev/sdc1 0&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>dmsetup<span class="w"> </span>create<span class="w"> </span>linear2
</code></pre></div>

<h4 id="dm-stripe">æ¡å¸¦åŒ–ï¼ˆdm-stripeï¼‰</h4>
<p>å°†I/Oåˆ†æ•£åˆ°å¤šä¸ªè®¾å¤‡ä»¥æé«˜å¹¶è¡Œæ€§ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">stripe_c</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">stripes</span><span class="p">;</span><span class="w">        </span><span class="cm">/* æ¡å¸¦æ•°é‡ */</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">stripe_width</span><span class="p">;</span><span class="w">   </span><span class="cm">/* æ¡å¸¦å®½åº¦(æ‰‡åŒº) */</span>

<span class="w">    </span><span class="cm">/* æ¡å¸¦æ•°ç»„ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">stripe</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">dm_dev</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">;</span>
<span class="w">        </span><span class="n">sector_t</span><span class="w"> </span><span class="n">physical_start</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">stripe</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">stripe_map</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dm_target</span><span class="w"> </span><span class="o">*</span><span class="n">ti</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bio</span><span class="w"> </span><span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">stripe_c</span><span class="w"> </span><span class="o">*</span><span class="n">sc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
<span class="w">    </span><span class="n">sector_t</span><span class="w"> </span><span class="n">sector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_iter</span><span class="p">.</span><span class="n">bi_sector</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">stripe</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* è®¡ç®—æ¡å¸¦ç´¢å¼• */</span>
<span class="w">    </span><span class="n">stripe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sector_div</span><span class="p">(</span><span class="n">sector</span><span class="p">,</span><span class="w"> </span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stripe_width</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stripes</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* é‡å®šå‘åˆ°å¯¹åº”æ¡å¸¦ */</span>
<span class="w">    </span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stripe</span><span class="p">[</span><span class="n">stripe</span><span class="p">].</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
<span class="w">    </span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_iter</span><span class="p">.</span><span class="n">bi_sector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stripe</span><span class="p">[</span><span class="n">stripe</span><span class="p">].</span><span class="n">physical_start</span><span class="w"> </span><span class="o">+</span>
<span class="w">                             </span><span class="p">(</span><span class="n">sector</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stripe_width</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">                             </span><span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_iter</span><span class="p">.</span><span class="n">bi_sector</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stripe_width</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">DM_MAPIO_REMAPPED</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="743">7.4.3 å¿«ç…§ä¸ç²¾ç®€é…ç½®</h3>
<h4 id="dm-snapshot">å¿«ç…§ï¼ˆdm-snapshotï¼‰</h4>
<p>å®ç°æ—¶é—´ç‚¹å¿«ç…§åŠŸèƒ½ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">dm_snapshot</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rw_semaphore</span><span class="w"> </span><span class="n">lock</span><span class="p">;</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dm_dev</span><span class="w"> </span><span class="o">*</span><span class="n">origin</span><span class="p">;</span><span class="w">    </span><span class="cm">/* åŸå§‹è®¾å¤‡ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dm_dev</span><span class="w"> </span><span class="o">*</span><span class="n">cow</span><span class="p">;</span><span class="w">       </span><span class="cm">/* COWè®¾å¤‡ */</span>

<span class="w">    </span><span class="cm">/* å¼‚å¸¸å­˜å‚¨ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dm_exception_store</span><span class="w"> </span><span class="o">*</span><span class="n">store</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* å¼‚å¸¸å“ˆå¸Œè¡¨ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">exception_table</span><span class="w"> </span><span class="n">complete</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">exception_table</span><span class="w"> </span><span class="n">pending</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* å—å¤§å° */</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">chunk_size</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">chunk_shift</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* ä½å›¾è·Ÿè¸ª */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">tracked_chunk_bitset</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* COWå¤„ç† */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">snapshot_map</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dm_target</span><span class="w"> </span><span class="o">*</span><span class="n">ti</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bio</span><span class="w"> </span><span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dm_snapshot</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
<span class="w">    </span><span class="n">chunk_t</span><span class="w"> </span><span class="n">chunk</span><span class="p">;</span>

<span class="w">    </span><span class="n">chunk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_iter</span><span class="p">.</span><span class="n">bi_sector</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">s</span><span class="o">-&gt;</span><span class="n">chunk_shift</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* æŸ¥æ‰¾å¼‚å¸¸æ˜ å°„ */</span>
<span class="w">    </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dm_lookup_exception</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">,</span><span class="w"> </span><span class="n">chunk</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* å·²å¤åˆ¶ï¼Œé‡å®šå‘åˆ°COWè®¾å¤‡ */</span>
<span class="w">        </span><span class="n">remap_exception</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">bio</span><span class="p">,</span><span class="w"> </span><span class="n">chunk</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">DM_MAPIO_REMAPPED</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* é¦–æ¬¡å†™å…¥ï¼Œè§¦å‘COW */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bio_data_dir</span><span class="p">(</span><span class="n">bio</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">WRITE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__lookup_pending_exception</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">chunk</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pe</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="cm">/* åˆ›å»ºæŒ‚èµ·å¼‚å¸¸ */</span>
<span class="w">            </span><span class="n">pe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_pending_exception</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="w">            </span><span class="n">start_copy</span><span class="p">(</span><span class="n">pe</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">bio_list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pe</span><span class="o">-&gt;</span><span class="n">origin_bios</span><span class="p">,</span><span class="w"> </span><span class="n">bio</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">DM_MAPIO_SUBMITTED</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* è¯»æ“ä½œï¼Œç›´æ¥è®¿é—®åŸå§‹è®¾å¤‡ */</span>
<span class="w">    </span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="o">-&gt;</span><span class="n">origin</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">DM_MAPIO_REMAPPED</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="dm-thin">ç²¾ç®€é…ç½®ï¼ˆdm-thinï¼‰</h4>
<p>å®ç°å­˜å‚¨è¿‡åº¦åˆ†é…å’Œé«˜æ•ˆå¿«ç…§ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">thin_c</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dm_pool_metadata</span><span class="w"> </span><span class="o">*</span><span class="n">pmd</span><span class="p">;</span><span class="w">    </span><span class="cm">/* å…ƒæ•°æ® */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dm_bio_prison</span><span class="w"> </span><span class="o">*</span><span class="n">prison</span><span class="p">;</span><span class="w">    </span><span class="cm">/* bioç›‘ç‹± */</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pool</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">bio_list</span><span class="w"> </span><span class="n">deferred_bios</span><span class="p">;</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">workqueue_struct</span><span class="w"> </span><span class="o">*</span><span class="n">wq</span><span class="p">;</span>

<span class="w">        </span><span class="cm">/* æ•°æ®å—åˆ†é… */</span>
<span class="w">        </span><span class="n">dm_block_t</span><span class="w"> </span><span class="n">offset_mask</span><span class="p">;</span>
<span class="w">        </span><span class="n">dm_block_t</span><span class="w"> </span><span class="n">low_water_blocks</span><span class="p">;</span>

<span class="w">        </span><span class="cm">/* ç²¾ç®€è®¾å¤‡åˆ—è¡¨ */</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">active_thins</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="o">*</span><span class="n">pool</span><span class="p">;</span>

<span class="w">    </span><span class="n">dm_thin_id</span><span class="w"> </span><span class="n">dev_id</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dm_thin_device</span><span class="w"> </span><span class="o">*</span><span class="n">td</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* ç²¾ç®€æ˜ å°„ */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">thin_map</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dm_target</span><span class="w"> </span><span class="o">*</span><span class="n">ti</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bio</span><span class="w"> </span><span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">thin_c</span><span class="w"> </span><span class="o">*</span><span class="n">tc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
<span class="w">    </span><span class="n">dm_block_t</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_iter</span><span class="p">.</span><span class="n">bi_sector</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">block_shift</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dm_thin_lookup_result</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* æŸ¥æ‰¾æ˜ å°„ */</span>
<span class="w">    </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dm_thin_find_block</span><span class="p">(</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">td</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* å—å·²åˆ†é… */</span>
<span class="w">        </span><span class="n">remap_to_pool</span><span class="p">(</span><span class="n">tc</span><span class="p">,</span><span class="w"> </span><span class="n">bio</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">block</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">DM_MAPIO_REMAPPED</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="n">ENODATA</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* å—æœªåˆ†é… */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bio_data_dir</span><span class="p">(</span><span class="n">bio</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">READ</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="cm">/* è¯»é›¶ */</span>
<span class="w">            </span><span class="n">zero_fill_bio</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
<span class="w">            </span><span class="n">bio_endio</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">DM_MAPIO_SUBMITTED</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="cm">/* å†™æ—¶åˆ†é… */</span>
<span class="w">        </span><span class="n">schedule_zero_fill_copy</span><span class="p">(</span><span class="n">tc</span><span class="p">,</span><span class="w"> </span><span class="n">bio</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">DM_MAPIO_SUBMITTED</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">DM_MAPIO_KILL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="744">7.4.4 åŠ å¯†ä¸å®Œæ•´æ€§ä¿æŠ¤</h3>
<h4 id="dm-crypt">dm-crypt</h4>
<p>æä¾›é€æ˜çš„å—è®¾å¤‡åŠ å¯†ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">crypt_config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dm_dev</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">;</span>
<span class="w">    </span><span class="n">sector_t</span><span class="w"> </span><span class="n">start</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* åŠ å¯†å‚æ•° */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">crypto_skcipher</span><span class="w"> </span><span class="o">*</span><span class="n">tfm</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">cipher_string</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">key_size</span><span class="p">;</span>
<span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="n">key</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* IVç”Ÿæˆ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">iv_operations</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">ctr</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">crypt_config</span><span class="w"> </span><span class="o">*</span><span class="n">cc</span><span class="p">);</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">dtr</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">crypt_config</span><span class="w"> </span><span class="o">*</span><span class="n">cc</span><span class="p">);</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">generator</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">crypt_config</span><span class="w"> </span><span class="o">*</span><span class="n">cc</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="n">iv</span><span class="p">,</span>
<span class="w">                        </span><span class="k">struct</span><span class="w"> </span><span class="nc">dm_crypt_request</span><span class="w"> </span><span class="o">*</span><span class="n">dmreq</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="o">*</span><span class="n">iv_gen_ops</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* å·¥ä½œé˜Ÿåˆ— */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">workqueue_struct</span><span class="w"> </span><span class="o">*</span><span class="n">queue</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">workqueue_struct</span><span class="w"> </span><span class="o">*</span><span class="n">crypt_queue</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* å†…å­˜æ±  */</span>
<span class="w">    </span><span class="n">mempool_t</span><span class="w"> </span><span class="o">*</span><span class="n">req_pool</span><span class="p">;</span>
<span class="w">    </span><span class="n">mempool_t</span><span class="w"> </span><span class="o">*</span><span class="n">page_pool</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* åŠ å¯†I/Oå¤„ç† */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">crypt_map</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dm_target</span><span class="w"> </span><span class="o">*</span><span class="n">ti</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bio</span><span class="w"> </span><span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">crypt_config</span><span class="w"> </span><span class="o">*</span><span class="n">cc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dm_crypt_io</span><span class="w"> </span><span class="o">*</span><span class="n">io</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* åˆ†é…åŠ å¯†I/Oä¸Šä¸‹æ–‡ */</span>
<span class="w">    </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mempool_alloc</span><span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">io_pool</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_NOIO</span><span class="p">);</span>
<span class="w">    </span><span class="n">io</span><span class="o">-&gt;</span><span class="n">cc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cc</span><span class="p">;</span>
<span class="w">    </span><span class="n">io</span><span class="o">-&gt;</span><span class="n">base_bio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bio</span><span class="p">;</span>
<span class="w">    </span><span class="n">io</span><span class="o">-&gt;</span><span class="n">sector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_iter</span><span class="p">.</span><span class="n">bi_sector</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bio_data_dir</span><span class="p">(</span><span class="n">bio</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">READ</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* è¯»ï¼šå…ˆè¯»å–åŠ å¯†æ•°æ®ï¼Œåè§£å¯† */</span>
<span class="w">        </span><span class="n">kcryptd_queue_read</span><span class="p">(</span><span class="n">io</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* å†™ï¼šå…ˆåŠ å¯†ï¼Œåå†™å…¥ */</span>
<span class="w">        </span><span class="n">kcryptd_queue_crypt</span><span class="p">(</span><span class="n">io</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">DM_MAPIO_SUBMITTED</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>ä½¿ç”¨ç¤ºä¾‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># åˆ›å»ºåŠ å¯†è®¾å¤‡</span>
cryptsetup<span class="w"> </span>luksFormat<span class="w"> </span>/dev/sdb1
cryptsetup<span class="w"> </span>open<span class="w"> </span>/dev/sdb1<span class="w"> </span>encrypted
mkfs.ext4<span class="w"> </span>/dev/mapper/encrypted
</code></pre></div>

<hr />
<h2 id="75_1">7.5 æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯</h2>
<h3 id="751-io">7.5.1 I/Oåˆå¹¶ä¸è¯·æ±‚é‡æ’</h3>
<p>è¯·æ±‚åˆå¹¶å‡å°‘è®¾å¤‡è®¿é—®æ¬¡æ•°ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* å‰å‘åˆå¹¶ï¼šæ–°bioåˆå¹¶åˆ°å·²æœ‰requestå‰é¢ */</span>
<span class="kt">bool</span><span class="w"> </span><span class="nf">blk_attempt_front_merge</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">request_queue</span><span class="w"> </span><span class="o">*</span><span class="n">q</span><span class="p">,</span>
<span class="w">                             </span><span class="k">struct</span><span class="w"> </span><span class="nc">request</span><span class="w"> </span><span class="o">*</span><span class="n">rq</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bio</span><span class="w"> </span><span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">blk_rq_merge_ok</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span><span class="w"> </span><span class="n">bio</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ll_front_merge_fn</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="n">rq</span><span class="p">,</span><span class="w"> </span><span class="n">bio</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* æ›´æ–°request */</span>
<span class="w">    </span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">__sector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_iter</span><span class="p">.</span><span class="n">bi_sector</span><span class="p">;</span>
<span class="w">    </span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">__data_len</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_iter</span><span class="p">.</span><span class="n">bi_size</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* é“¾æ¥bio */</span>
<span class="w">    </span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">;</span>
<span class="w">    </span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">bio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bio</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* åå‘åˆå¹¶ï¼šæ–°bioåˆå¹¶åˆ°å·²æœ‰requeståé¢ */</span>
<span class="kt">bool</span><span class="w"> </span><span class="nf">blk_attempt_back_merge</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">request_queue</span><span class="w"> </span><span class="o">*</span><span class="n">q</span><span class="p">,</span>
<span class="w">                            </span><span class="k">struct</span><span class="w"> </span><span class="nc">request</span><span class="w"> </span><span class="o">*</span><span class="n">rq</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bio</span><span class="w"> </span><span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">blk_rq_merge_ok</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span><span class="w"> </span><span class="n">bio</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ll_back_merge_fn</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="n">rq</span><span class="p">,</span><span class="w"> </span><span class="n">bio</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* æ›´æ–°request */</span>
<span class="w">    </span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">__data_len</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_iter</span><span class="p">.</span><span class="n">bi_size</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* é“¾æ¥bio */</span>
<span class="w">    </span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">biotail</span><span class="o">-&gt;</span><span class="n">bi_next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bio</span><span class="p">;</span>
<span class="w">    </span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">biotail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bio</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="752">7.5.2 é¢„è¯»ç­–ç•¥ä¸ç¼“å­˜ç®¡ç†</h3>
<p>é¢„è¯»æœºåˆ¶æé«˜é¡ºåºè¯»æ€§èƒ½ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">file_ra_state</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">pgoff_t</span><span class="w"> </span><span class="n">start</span><span class="p">;</span><span class="w">          </span><span class="cm">/* é¢„è¯»çª—å£èµ·å§‹ */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w">      </span><span class="cm">/* å½“å‰çª—å£å¤§å° */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">async_size</span><span class="p">;</span><span class="cm">/* å¼‚æ­¥é¢„è¯»å¤§å° */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ra_pages</span><span class="p">;</span><span class="w">  </span><span class="cm">/* æœ€å¤§é¢„è¯»é¡µæ•° */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mmap_miss</span><span class="p">;</span><span class="w"> </span><span class="cm">/* mmapç¼“å­˜æœªå‘½ä¸­è®¡æ•° */</span>
<span class="w">    </span><span class="n">loff_t</span><span class="w"> </span><span class="n">prev_pos</span><span class="p">;</span><span class="w">       </span><span class="cm">/* ä¸Šæ¬¡è¯»å–ä½ç½® */</span>
<span class="p">};</span>

<span class="cm">/* é¢„è¯»ç®—æ³• */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">get_next_ra_size</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file_ra_state</span><span class="w"> </span><span class="o">*</span><span class="n">ra</span><span class="p">,</span>
<span class="w">                                      </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">cur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ra</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">newsize</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">max</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span>
<span class="w">        </span><span class="n">newsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cur</span><span class="p">;</span><span class="w">    </span><span class="cm">/* å¿«é€Ÿå¢é•¿ */</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">newsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cur</span><span class="p">;</span><span class="w">    </span><span class="cm">/* çº¿æ€§å¢é•¿ */</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">newsize</span><span class="p">,</span><span class="w"> </span><span class="n">max</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="753">7.5.3 å†™å›æœºåˆ¶ä¸è„é¡µæ§åˆ¶</h3>
<p>è„é¡µå†™å›çš„è§¦å‘æ¡ä»¶ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">bdi_writeback</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">backing_dev_info</span><span class="w"> </span><span class="o">*</span><span class="n">bdi</span><span class="p">;</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">state</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">last_old_flush</span><span class="p">;</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">b_dirty</span><span class="p">;</span><span class="w">      </span><span class="cm">/* è„inodeåˆ—è¡¨ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">b_io</span><span class="p">;</span><span class="w">         </span><span class="cm">/* æ­£åœ¨å†™å›åˆ—è¡¨ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">b_more_io</span><span class="p">;</span><span class="w">    </span><span class="cm">/* éœ€è¦æ›´å¤šI/Oåˆ—è¡¨ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">b_dirty_time</span><span class="p">;</span><span class="w"> </span><span class="cm">/* åªæœ‰æ—¶é—´æˆ³å˜åŒ– */</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">percpu_counter</span><span class="w"> </span><span class="n">stat</span><span class="p">[</span><span class="n">NR_WB_STAT_ITEMS</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* å†™å›æ§åˆ¶å‚æ•° */</span>
<span class="kt">int</span><span class="w"> </span><span class="n">dirty_background_ratio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w">  </span><span class="cm">/* åå°å†™å›é˜ˆå€¼10% */</span>
<span class="kt">int</span><span class="w"> </span><span class="n">dirty_ratio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span><span class="w">             </span><span class="cm">/* å‰å°å†™å›é˜ˆå€¼20% */</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">dirty_expire_interval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">HZ</span><span class="p">;</span><span class="w"> </span><span class="cm">/* 30ç§’è¿‡æœŸ */</span>
</code></pre></div>

<h3 id="754-io">7.5.4 I/Oç»Ÿè®¡ä¸æ€§èƒ½ç›‘æ§</h3>
<p>å—è®¾å¤‡ç»Ÿè®¡ä¿¡æ¯ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">disk_stats</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">sectors</span><span class="p">[</span><span class="n">NR_STAT_GROUPS</span><span class="p">];</span><span class="w">  </span><span class="cm">/* è¯»å†™æ‰‡åŒºæ•° */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ios</span><span class="p">[</span><span class="n">NR_STAT_GROUPS</span><span class="p">];</span><span class="w">      </span><span class="cm">/* I/Oæ¬¡æ•° */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">merges</span><span class="p">[</span><span class="n">NR_STAT_GROUPS</span><span class="p">];</span><span class="w">   </span><span class="cm">/* åˆå¹¶æ¬¡æ•° */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ticks</span><span class="p">[</span><span class="n">NR_STAT_GROUPS</span><span class="p">];</span><span class="w">    </span><span class="cm">/* I/Oæ—¶é—´ */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">io_ticks</span><span class="p">;</span><span class="w">                 </span><span class="cm">/* æ€»I/Oæ—¶é—´ */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">time_in_queue</span><span class="p">;</span><span class="w">            </span><span class="cm">/* é˜Ÿåˆ—æ—¶é—´ */</span>
<span class="p">};</span>
</code></pre></div>

<p>é€šè¿‡/proc/diskstatsç›‘æ§ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># å­—æ®µè¯´æ˜ï¼š</span>
<span class="c1"># 1-3: ä¸»æ¬¡è®¾å¤‡å·å’Œè®¾å¤‡å</span>
<span class="c1"># 4: è¯»å®Œæˆæ¬¡æ•°</span>
<span class="c1"># 5: åˆå¹¶è¯»æ¬¡æ•°</span>
<span class="c1"># 6: è¯»æ‰‡åŒºæ•°</span>
<span class="c1"># 7: è¯»è€—æ—¶(ms)</span>
<span class="c1"># 8-11: å†™ç›¸å…³ç»Ÿè®¡</span>
<span class="c1"># 12: æ­£åœ¨è¿›è¡Œçš„I/O</span>
<span class="c1"># 13: I/Oè€—æ—¶</span>
<span class="c1"># 14: åŠ æƒI/Oè€—æ—¶</span>

cat<span class="w"> </span>/proc/diskstats
</code></pre></div>

<hr />
<h2 id="76_1">7.6 æœ¬ç« å°ç»“</h2>
<p>æœ¬ç« æ·±å…¥æ¢è®¨äº†Linuxå—è®¾å¤‡å±‚çš„è®¾è®¡ä¸å®ç°ï¼Œä¸»è¦å†…å®¹åŒ…æ‹¬ï¼š</p>
<h3 id="_4">æ ¸å¿ƒæ¦‚å¿µå›é¡¾</h3>
<ol>
<li>
<p><strong>å—è®¾å¤‡æ¶æ„</strong>ï¼š
   - bioä½œä¸ºåŸºæœ¬I/Oå•ä½ï¼Œæ”¯æŒæ•£åˆ—èšé›†
   - requestç»è¿‡åˆå¹¶ä¼˜åŒ–ï¼Œå‡å°‘è®¾å¤‡è®¿é—®
   - gendiskæŠ½è±¡ç‰©ç†è®¾å¤‡ï¼Œæä¾›ç»Ÿä¸€æ¥å£</p>
</li>
<li>
<p><strong>I/Oè°ƒåº¦æ¼”è¿›</strong>ï¼š
   - ä¼ ç»Ÿè°ƒåº¦å™¨(CFQ/Deadline)é€‚åˆæœºæ¢°ç¡¬ç›˜
   - å¤šé˜Ÿåˆ—è°ƒåº¦å™¨(mq-deadline/bfq/kyber)ä¸ºSSDä¼˜åŒ–
   - ä¸åŒå·¥ä½œè´Ÿè½½éœ€è¦é€‰æ‹©åˆé€‚çš„è°ƒåº¦ç­–ç•¥</p>
</li>
<li>
<p><strong>blk-mqé©æ–°</strong>ï¼š
   - è½¯ä»¶é˜Ÿåˆ—ä¸ç¡¬ä»¶é˜Ÿåˆ—åˆ†ç¦»ï¼Œå‡å°‘é”ç«äº‰
   - æ ‡ç­¾ç®¡ç†æ§åˆ¶å¹¶å‘åº¦
   - NUMAæ„ŸçŸ¥çš„é˜Ÿåˆ—æ˜ å°„æå‡æ€§èƒ½</p>
</li>
<li>
<p><strong>Device Mapperçµæ´»æ€§</strong>ï¼š
   - ç›®æ ‡é©±åŠ¨æ¶æ„æ”¯æŒå¤šç§è™šæ‹Ÿè®¾å¤‡
   - å¿«ç…§å’Œç²¾ç®€é…ç½®å®ç°é«˜çº§å­˜å‚¨åŠŸèƒ½
   - é€æ˜åŠ å¯†ä¿æŠ¤æ•°æ®å®‰å…¨</p>
</li>
</ol>
<h3 id="_5">å…³é”®æ€§èƒ½ä¼˜åŒ–</h3>
<ul>
<li><strong>I/Oåˆå¹¶</strong>ï¼š$åˆå¹¶ç‡ = \frac{åˆå¹¶è¯·æ±‚æ•°}{æ€»è¯·æ±‚æ•°} \times 100\%$</li>
<li><strong>é¢„è¯»æ•ˆç‡</strong>ï¼š$å‘½ä¸­ç‡ = \frac{é¢„è¯»å‘½ä¸­é¡µæ•°}{æ€»é¢„è¯»é¡µæ•°} \times 100\%$</li>
<li><strong>é˜Ÿåˆ—æ·±åº¦</strong>ï¼š$å¹³å‡é˜Ÿåˆ—æ·±åº¦ = \frac{\sum é˜Ÿåˆ—é•¿åº¦ \times æ—¶é—´}{æ€»æ—¶é—´}$</li>
<li><strong>å»¶è¿Ÿåˆ†æ</strong>ï¼š$æ€»å»¶è¿Ÿ = é˜Ÿåˆ—å»¶è¿Ÿ + æœåŠ¡å»¶è¿Ÿ$</li>
</ul>
<h3 id="_6">å‘å±•è¶‹åŠ¿</h3>
<ol>
<li><strong>æ–°ç¡¬ä»¶æ”¯æŒ</strong>ï¼šZNS SSDã€æŒä¹…å†…å­˜ã€CXLå­˜å‚¨</li>
<li><strong>æ™ºèƒ½è°ƒåº¦</strong>ï¼šæœºå™¨å­¦ä¹ é©±åŠ¨çš„I/Oé¢„æµ‹</li>
<li><strong>å®¹å™¨ä¼˜åŒ–</strong>ï¼šcgroup v2çš„I/Oéš”ç¦»å¢å¼º</li>
<li><strong>å¯ç¼–ç¨‹å­˜å‚¨</strong>ï¼šeBPFåœ¨å—å±‚çš„åº”ç”¨</li>
</ol>
<hr />
<h2 id="77_1">7.7 ç»ƒä¹ é¢˜</h2>
<h3 id="_7">åŸºç¡€é¢˜</h3>
<ol>
<li><strong>bioä¸requestçš„å…³ç³»</strong>
åˆ†æä»¥ä¸‹ä»£ç ç‰‡æ®µï¼Œè§£é‡Šbioå¦‚ä½•è½¬æ¢ä¸ºrequestï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">blk_mq_bio_to_request</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">request</span><span class="w"> </span><span class="o">*</span><span class="n">rq</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bio</span><span class="w"> </span><span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">__sector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_iter</span><span class="p">.</span><span class="n">bi_sector</span><span class="p">;</span>
<span class="w">    </span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">__data_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_iter</span><span class="p">.</span><span class="n">bi_size</span><span class="p">;</span>
<span class="w">    </span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">bio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">biotail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bio</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<details>
<summary>æç¤º</summary>
<p>è€ƒè™‘bioé“¾è¡¨ç»“æ„å’Œrequestçš„èšåˆç‰¹æ€§</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>bioæ˜¯åŸºæœ¬I/Oå•ä½ï¼Œrequestæ˜¯ä¼˜åŒ–åçš„è¯·æ±‚å•ä½ã€‚è½¬æ¢è¿‡ç¨‹ï¼š</p>
<ol>
<li>å•ä¸ªæˆ–å¤šä¸ªbioå¯ä»¥ç»„æˆä¸€ä¸ªrequest</li>
<li>requestè®°å½•èµ·å§‹æ‰‡åŒºå’Œæ€»æ•°æ®é•¿åº¦</li>
<li>bioé€šè¿‡é“¾è¡¨è¿æ¥ï¼ŒbiotailæŒ‡å‘æœ€åä¸€ä¸ªbio</li>
<li>ç›¸é‚»çš„bioå¯ä»¥åˆå¹¶åˆ°åŒä¸€ä¸ªrequestä¸­</li>
</ol>
</details>
<ol start="2">
<li><strong>I/Oè°ƒåº¦å™¨é€‰æ‹©</strong>
æŸæœåŠ¡å™¨è¿è¡ŒPostgreSQLæ•°æ®åº“ï¼Œå­˜å‚¨è®¾å¤‡æ˜¯SATA SSDï¼Œåº”è¯¥é€‰æ‹©å“ªç§I/Oè°ƒåº¦å™¨ï¼Ÿè¯´æ˜ç†ç”±ã€‚</li>
</ol>
<details>
<summary>æç¤º</summary>
<p>è€ƒè™‘æ•°æ®åº“çš„I/Oç‰¹å¾ï¼šéšæœºè¯»å†™å¤šã€å»¶è¿Ÿæ•æ„Ÿ</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>æ¨èä½¿ç”¨mq-deadlineè°ƒåº¦å™¨ï¼š</p>
<ol>
<li>æ•°æ®åº“ä»¥éšæœºI/Oä¸ºä¸»ï¼ŒCFQçš„é¡ºåºä¼˜åŒ–æ•ˆæœæœ‰é™</li>
<li>mq-deadlineä¿è¯å»¶è¿Ÿä¸Šç•Œï¼Œé€‚åˆäº‹åŠ¡å¤„ç†</li>
<li>æ¯”noneè°ƒåº¦å™¨æä¾›æ›´å¥½çš„å…¬å¹³æ€§</li>
<li>ç›¸æ¯”bfqå¼€é”€æ›´å°ï¼Œé€‚åˆæœåŠ¡å™¨ç¯å¢ƒ</li>
</ol>
</details>
<ol start="3">
<li><strong>blk-mqé˜Ÿåˆ—æ˜ å°„</strong>
ç³»ç»Ÿæœ‰8ä¸ªCPUï¼ŒNVMeè®¾å¤‡æ”¯æŒ4ä¸ªç¡¬ä»¶é˜Ÿåˆ—ï¼Œæè¿°é»˜è®¤çš„CPUåˆ°ç¡¬ä»¶é˜Ÿåˆ—æ˜ å°„ã€‚</li>
</ol>
<details>
<summary>æç¤º</summary>
<p>è½®è¯¢åˆ†é…ç®—æ³•ï¼šCPU % ç¡¬ä»¶é˜Ÿåˆ—æ•°</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>é»˜è®¤è½®è¯¢æ˜ å°„ï¼š</p>
<ul>
<li>CPU 0, 4 â†’ HWQ 0</li>
<li>CPU 1, 5 â†’ HWQ 1  </li>
<li>CPU 2, 6 â†’ HWQ 2</li>
<li>CPU 3, 7 â†’ HWQ 3</li>
</ul>
<p>æ¯ä¸ªç¡¬ä»¶é˜Ÿåˆ—æœåŠ¡2ä¸ªCPUï¼Œä¿è¯è´Ÿè½½å‡è¡¡ã€‚</p>
</details>
<h3 id="_8">æŒ‘æˆ˜é¢˜</h3>
<ol start="4">
<li><strong>è®¾è®¡I/Oåˆå¹¶ç®—æ³•</strong>
è®¾è®¡ä¸€ä¸ªæ”¹è¿›çš„I/Oåˆå¹¶ç®—æ³•ï¼ŒåŒæ—¶è€ƒè™‘ï¼š</li>
</ol>
<ul>
<li>ç©ºé—´å±€éƒ¨æ€§ï¼ˆç›¸é‚»æ‰‡åŒºï¼‰</li>
<li>æ—¶é—´å±€éƒ¨æ€§ï¼ˆè¯·æ±‚æ—¶é—´æ¥è¿‘ï¼‰</li>
<li>å…¬å¹³æ€§ï¼ˆé˜²æ­¢æŸäº›è¿›ç¨‹é¥¥é¥¿ï¼‰</li>
</ul>
<details>
<summary>æç¤º</summary>
<p>å¯ä»¥ä½¿ç”¨æ—¶é—´çª—å£å’Œè·ç¦»é˜ˆå€¼çš„ç»„åˆç­–ç•¥</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>æ”¹è¿›çš„åˆå¹¶ç®—æ³•è®¾è®¡ï¼š</p>
<ol>
<li>
<p><strong>åŒé‡é˜ˆå€¼ç­–ç•¥</strong>ï¼š
   - è·ç¦»é˜ˆå€¼ï¼šæ‰‡åŒºè·ç¦» &lt; 128KBå¯åˆå¹¶
   - æ—¶é—´é˜ˆå€¼ï¼š100mså†…çš„è¯·æ±‚å¯åˆå¹¶</p>
</li>
<li>
<p><strong>å…¬å¹³æ€§ä¿è¯</strong>ï¼š
   - æ¯ä¸ªè¿›ç¨‹ç»´æŠ¤ç‹¬ç«‹çš„åˆå¹¶çª—å£
   - è®¾ç½®æœ€å¤§åˆå¹¶æ¬¡æ•°é™åˆ¶(å¦‚16æ¬¡)
   - è¶…æ—¶è‡ªåŠ¨æ´¾å‘é˜²æ­¢æ— é™ç­‰å¾…</p>
</li>
<li>
<p><strong>è‡ªé€‚åº”è°ƒæ•´</strong>ï¼š
   - ç›‘æµ‹å‘½ä¸­ç‡åŠ¨æ€è°ƒæ•´é˜ˆå€¼
   - é¡ºåºI/Oå¢å¤§çª—å£ï¼ŒéšæœºI/Oå‡å°çª—å£</p>
</li>
<li>
<p><strong>ä¼˜å…ˆçº§è€ƒè™‘</strong>ï¼š
   - é«˜ä¼˜å…ˆçº§I/Oé™ä½åˆå¹¶ç­‰å¾…æ—¶é—´
   - å®æ—¶ä»»åŠ¡ç›´æ¥æ´¾å‘ä¸ç­‰å¾…åˆå¹¶</p>
</li>
</ol>
</details>
<ol start="5">
<li><strong>å®ç°ç®€å•çš„è®¾å¤‡æ˜ å°„ç›®æ ‡</strong>
è®¾è®¡ä¸€ä¸ªmirrorï¼ˆé•œåƒï¼‰ç›®æ ‡é©±åŠ¨çš„æ ¸å¿ƒé€»è¾‘ï¼Œè¦æ±‚ï¼š</li>
</ol>
<ul>
<li>è¯»æ“ä½œè´Ÿè½½å‡è¡¡</li>
<li>å†™æ“ä½œåŒæ­¥å¤åˆ¶</li>
<li>å¤„ç†è®¾å¤‡æ•…éšœ</li>
</ul>
<details>
<summary>æç¤º</summary>
<p>éœ€è¦è€ƒè™‘è¯»å†™åˆ†ç¦»ã€æ•…éšœæ£€æµ‹å’Œé™çº§æ¨¡å¼</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>Mirrorç›®æ ‡é©±åŠ¨è®¾è®¡ï¼š</p>
<ol>
<li>
<p><strong>æ•°æ®ç»“æ„</strong>ï¼š
   - é•œåƒè®¾å¤‡æ•°ç»„
   - è®¾å¤‡çŠ¶æ€æ ‡å¿—(æ­£å¸¸/æ•…éšœ)
   - è½®è¯¢ç´¢å¼•ç”¨äºè´Ÿè½½å‡è¡¡</p>
</li>
<li>
<p><strong>è¯»æ“ä½œå¤„ç†</strong>ï¼š
   - è½®è¯¢é€‰æ‹©å¥åº·è®¾å¤‡
   - å¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ä»½
   - è®°å½•è¯»é”™è¯¯ç”¨äºæ•…éšœæ£€æµ‹</p>
</li>
<li>
<p><strong>å†™æ“ä½œå¤„ç†</strong>ï¼š
   - å…‹éš†bioåˆ°æ‰€æœ‰å¥åº·è®¾å¤‡
   - ç­‰å¾…æ‰€æœ‰å†™å®Œæˆ
   - ä»»ä¸€å¤±è´¥åˆ™æ ‡è®°è®¾å¤‡æ•…éšœ</p>
</li>
<li>
<p><strong>æ•…éšœæ¢å¤</strong>ï¼š
   - å®šæœŸå°è¯•æ¢å¤æ•…éšœè®¾å¤‡
   - æ”¯æŒåœ¨çº¿é‡åŒæ­¥
   - ç»´æŠ¤è„å—ä½å›¾åŠ é€Ÿæ¢å¤</p>
</li>
<li>
<p><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼š
   - å¼‚æ­¥å†™å…¥æé«˜ååé‡
   - è¯»è¯·æ±‚NUMAäº²å’Œæ€§
   - å†™åˆå¹¶å‡å°‘å¼€é”€</p>
</li>
</ol>
</details>
<ol start="6">
<li><strong>åˆ†æblk-mqæ€§èƒ½ç“¶é¢ˆ</strong>
æŸNVMeè®¾å¤‡åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹æ€§èƒ½ä¸åŠé¢„æœŸï¼Œå¦‚ä½•åˆ†æå’Œä¼˜åŒ–ï¼Ÿ</li>
</ol>
<details>
<summary>æç¤º</summary>
<p>ä»è½¯ç¡¬ä»¶é˜Ÿåˆ—æ˜ å°„ã€æ ‡ç­¾åˆ†é…ã€ä¸­æ–­äº²å’Œæ€§ç­‰æ–¹é¢åˆ†æ</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>æ€§èƒ½åˆ†æå’Œä¼˜åŒ–æ–¹æ¡ˆï¼š</p>
<ol>
<li>
<p><strong>è¯Šæ–­æ­¥éª¤</strong>ï¼š
   - æ£€æŸ¥é˜Ÿåˆ—æ·±åº¦æ˜¯å¦å……åˆ†åˆ©ç”¨
   - åˆ†æè½¯ä¸­æ–­åˆ†å¸ƒæ˜¯å¦å‡è¡¡
   - ç›‘æµ‹æ ‡ç­¾åˆ†é…ç­‰å¾…æ—¶é—´
   - è¯„ä¼°NUMAèŠ‚ç‚¹è®¿é—®æ¨¡å¼</p>
</li>
<li>
<p><strong>å¯èƒ½çš„ç“¶é¢ˆ</strong>ï¼š
   - é˜Ÿåˆ—æ˜ å°„ä¸å½“å¯¼è‡´çƒ­ç‚¹
   - æ ‡ç­¾æ•°é‡ä¸è¶³é™åˆ¶å¹¶å‘
   - ä¸­æ–­å¤„ç†é›†ä¸­åœ¨å°‘æ•°CPU
   - è·¨NUMAè®¿é—®å¢åŠ å»¶è¿Ÿ</p>
</li>
<li>
<p><strong>ä¼˜åŒ–æªæ–½</strong>ï¼š
   - è°ƒæ•´nr_hw_queuesåŒ¹é…CPUæ•°
   - å¢åŠ queue_depthæé«˜å¹¶å‘åº¦
   - è®¾ç½®ä¸­æ–­äº²å’Œæ€§åˆ†æ•£è´Ÿè½½
   - ä½¿ç”¨NUMAæ„ŸçŸ¥çš„é˜Ÿåˆ—æ˜ å°„</p>
</li>
<li>
<p><strong>å‚æ•°è°ƒä¼˜</strong>ï¼š</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="nb">echo</span><span class="w"> </span><span class="m">256</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/block/nvme0n1/queue/nr_requests
<span class="nb">echo</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/block/nvme0n1/queue/rq_affinity
<span class="nb">echo</span><span class="w"> </span><span class="m">2</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/block/nvme0n1/queue/nomerges
</code></pre></div>

<ol start="5">
<li><strong>æ€§èƒ½éªŒè¯</strong>ï¼š
   - ä½¿ç”¨fioæµ‹è¯•ä¸åŒé˜Ÿåˆ—æ·±åº¦
   - ç›‘æ§iostatæŸ¥çœ‹åˆ©ç”¨ç‡
   - åˆ†æblktraceè¿½è¸ªI/Oè·¯å¾„</li>
</ol>
</details>
<ol start="7">
<li><strong>è®¾è®¡æ™ºèƒ½I/Oè°ƒåº¦å™¨</strong>
åŸºäºæœºå™¨å­¦ä¹ è®¾è®¡ä¸€ä¸ªè‡ªé€‚åº”I/Oè°ƒåº¦å™¨ï¼Œæè¿°ï¼š</li>
</ol>
<ul>
<li>ç‰¹å¾æå–æ–¹æ¡ˆ</li>
<li>æ¨¡å‹é€‰æ‹©ç†ç”±</li>
<li>åœ¨çº¿å­¦ä¹ æœºåˆ¶</li>
</ul>
<details>
<summary>æç¤º</summary>
<p>è€ƒè™‘I/Oæ¨¡å¼è¯†åˆ«ã€å·¥ä½œè´Ÿè½½åˆ†ç±»ã€å‚æ•°è‡ªåŠ¨è°ƒä¼˜</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>æ™ºèƒ½I/Oè°ƒåº¦å™¨è®¾è®¡ï¼š</p>
<ol>
<li>
<p><strong>ç‰¹å¾å·¥ç¨‹</strong>ï¼š
   - I/Oå¤§å°åˆ†å¸ƒ(4K/64K/1Mæ¯”ä¾‹)
   - é¡ºåº/éšæœºæ¯”ä¾‹
   - è¯»å†™æ¯”ä¾‹
   - è¿›ç¨‹é—´I/Oç›¸å…³æ€§
   - æ—¶é—´æ¨¡å¼(å‘¨æœŸæ€§/çªå‘æ€§)</p>
</li>
<li>
<p><strong>æ¨¡å‹æ¶æ„</strong>ï¼š
   - ä½¿ç”¨å†³ç­–æ ‘è¿›è¡Œå·¥ä½œè´Ÿè½½åˆ†ç±»
   - LSTMé¢„æµ‹æœªæ¥I/Oæ¨¡å¼
   - å¼ºåŒ–å­¦ä¹ ä¼˜åŒ–è°ƒåº¦å‚æ•°</p>
</li>
<li>
<p><strong>åœ¨çº¿å­¦ä¹ </strong>ï¼š
   - æ»‘åŠ¨çª—å£æ”¶é›†æœ€è¿‘Nç§’ç»Ÿè®¡
   - å¢é‡æ›´æ–°æ¨¡å‹å‚æ•°
   - A/Bæµ‹è¯•éªŒè¯æ”¹è¿›æ•ˆæœ</p>
</li>
<li>
<p><strong>è°ƒåº¦ç­–ç•¥</strong>ï¼š
   - æ•°æ®åº“è´Ÿè½½â†’ä¼˜åŒ–å»¶è¿Ÿ
   - æ‰¹å¤„ç†â†’æœ€å¤§åŒ–ååé‡
   - æ··åˆè´Ÿè½½â†’åŠ¨æ€æƒè¡¡</p>
</li>
<li>
<p><strong>å®ç°è€ƒè™‘</strong>ï¼š
   - eBPFæ”¶é›†ç‰¹å¾é¿å…å¼€é”€
   - æ¨¡å‹æ¨ç†ä½¿ç”¨æŸ¥æ‰¾è¡¨åŠ é€Ÿ
   - é™çº§æœºåˆ¶åº”å¯¹å¼‚å¸¸æƒ…å†µ</p>
</li>
</ol>
</details>
<ol start="8">
<li><strong>ä¼˜åŒ–Device Mapperæ€§èƒ½</strong>
åˆ†ædm-cryptçš„æ€§èƒ½å¼€é”€ï¼Œæå‡ºä¼˜åŒ–æ–¹æ¡ˆã€‚</li>
</ol>
<details>
<summary>æç¤º</summary>
<p>è€ƒè™‘åŠ å¯†ç®—æ³•ã€å¹¶è¡Œå¤„ç†ã€ç¡¬ä»¶åŠ é€Ÿç­‰å› ç´ </p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>dm-cryptæ€§èƒ½ä¼˜åŒ–ï¼š</p>
<ol>
<li>
<p><strong>æ€§èƒ½ç“¶é¢ˆåˆ†æ</strong>ï¼š
   - CPUå¯†é›†çš„åŠ å¯†è¿ç®—
   - å†…å­˜æ‹·è´å¼€é”€
   - å•çº¿ç¨‹å¤„ç†é™åˆ¶
   - IVç”Ÿæˆè®¡ç®—</p>
</li>
<li>
<p><strong>ç®—æ³•ä¼˜åŒ–</strong>ï¼š
   - ä½¿ç”¨AES-NIç¡¬ä»¶åŠ é€Ÿ
   - é€‰æ‹©XTSæ¨¡å¼æé«˜å¹¶è¡Œåº¦
   - ä¼˜åŒ–IVç”Ÿæˆç®—æ³•</p>
</li>
<li>
<p><strong>å¹¶è¡ŒåŒ–æ”¹è¿›</strong>ï¼š
   - å¤šCPUå¹¶è¡ŒåŠ å¯†
   - å¼‚æ­¥åŠ å¯†é˜Ÿåˆ—
   - per-CPUå·¥ä½œé˜Ÿåˆ—</p>
</li>
<li>
<p><strong>å†…å­˜ä¼˜åŒ–</strong>ï¼š
   - ä½¿ç”¨å†…å­˜æ± å‡å°‘åˆ†é…
   - é›¶æ‹·è´æŠ€æœ¯
   - å¯¹é½ä¼˜åŒ–cacheæ€§èƒ½</p>
</li>
<li>
<p><strong>é…ç½®å»ºè®®</strong>ï¼š</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># ä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿ</span>
cryptsetup<span class="w"> </span>--cipher<span class="w"> </span>aes-xts-plain64<span class="w"> </span><span class="se">\</span>
<span class="w">          </span>--key-size<span class="w"> </span><span class="m">512</span><span class="w"> </span><span class="se">\</span>
<span class="w">          </span>--use-random

<span class="c1"># è°ƒæ•´å·¥ä½œé˜Ÿåˆ—</span>
<span class="nb">echo</span><span class="w"> </span><span class="m">4</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/module/dm_crypt/parameters/num_threads

<span class="c1"># è®¾ç½®æ›´å¤§çš„å—å¤§å°</span>
cryptsetup<span class="w"> </span>--perf-no_read_workqueue<span class="w"> </span><span class="se">\</span>
<span class="w">          </span>--perf-no_write_workqueue
</code></pre></div>

<ol start="6">
<li><strong>æ€§èƒ½ç›‘æ§</strong>ï¼š
   - æµ‹é‡åŠ å¯†ååé‡
   - åˆ†æCPUåˆ©ç”¨ç‡åˆ†å¸ƒ
   - è¿½è¸ªI/Oå»¶è¿Ÿå¢åŠ </li>
</ol>
</details>
<hr />
<h2 id="78-gotchas">7.8 å¸¸è§é™·é˜±ä¸é”™è¯¯ï¼ˆGotchasï¼‰</h2>
<h3 id="_9">è°ƒè¯•æŠ€å·§</h3>
<ol>
<li><strong>I/OæŒ‚èµ·è¯Šæ–­</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># æ£€æŸ¥æŒ‚èµ·çš„I/O</span>
cat<span class="w"> </span>/proc/&lt;pid&gt;/stack
cat<span class="w"> </span>/sys/kernel/debug/block/&lt;dev&gt;/hctx*/busy

<span class="c1"># ä½¿ç”¨blktraceè¿½è¸ª</span>
blktrace<span class="w"> </span>-d<span class="w"> </span>/dev/sda<span class="w"> </span>-o<span class="w"> </span>trace
blkparse<span class="w"> </span>-i<span class="w"> </span>trace
</code></pre></div>

<ol start="2">
<li><strong>æ€§èƒ½é—®é¢˜å®šä½</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># ç›‘æ§é˜Ÿåˆ—æ·±åº¦</span>
iostat<span class="w"> </span>-x<span class="w"> </span><span class="m">1</span>

<span class="c1"># æŸ¥çœ‹è°ƒåº¦å™¨ç»Ÿè®¡</span>
cat<span class="w"> </span>/sys/block/sda/queue/scheduler
grep<span class="w"> </span>.<span class="w"> </span>/sys/block/sda/queue/iosched/*
</code></pre></div>

<h3 id="_10">å¸¸è§é”™è¯¯</h3>
<ol>
<li>
<p><strong>bioä½¿ç”¨é”™è¯¯</strong>
   - âŒ ä¿®æ”¹å·²æäº¤çš„bio
   - âŒ å¿˜è®°è°ƒç”¨bio_puté‡Šæ”¾å¼•ç”¨
   - âœ… å…‹éš†bioè¿›è¡Œä¿®æ”¹</p>
</li>
<li>
<p><strong>è¯·æ±‚é˜Ÿåˆ—é…ç½®</strong>
   - âŒ è¶…è¿‡è®¾å¤‡èƒ½åŠ›çš„é˜Ÿåˆ—æ·±åº¦
   - âŒ ä¸åŒ¹é…çš„æ‰‡åŒºå¤§å°
   - âœ… æ ¹æ®è®¾å¤‡ç‰¹æ€§è®¾ç½®é™åˆ¶</p>
</li>
<li>
<p><strong>DMç›®æ ‡å®ç°</strong>
   - âŒ åŒæ­¥I/Oé˜»å¡æ˜ å°„å‡½æ•°
   - âŒ ä¸å¤„ç†è®¾å¤‡çƒ­æ’æ‹”
   - âœ… å¼‚æ­¥å¤„ç†å’Œé”™è¯¯æ¢å¤</p>
</li>
<li>
<p><strong>æ€§èƒ½è°ƒä¼˜è¯¯åŒº</strong>
   - âŒ ç›²ç›®å¢åŠ é¢„è¯»å¤§å°
   - âŒ æ‰€æœ‰è®¾å¤‡ç”¨åŒä¸€è°ƒåº¦å™¨
   - âœ… åŸºäºæµ‹è¯•æ•°æ®è°ƒä¼˜</p>
</li>
</ol>
<hr />
<h2 id="79_1">7.9 æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•</h2>
<h3 id="_11">è®¾è®¡å®¡æŸ¥è¦ç‚¹</h3>
<h4 id="_12">å—è®¾å¤‡é©±åŠ¨</h4>
<ul>
<li>[ ] æ­£ç¡®è®¾ç½®é˜Ÿåˆ—é™åˆ¶ï¼ˆmax_sectorsã€max_segmentsï¼‰</li>
<li>[ ] å®ç°è¶…æ—¶å¤„ç†æœºåˆ¶</li>
<li>[ ] æ”¯æŒblk-mqå¤šé˜Ÿåˆ—æ¨¡å¼</li>
<li>[ ] å¤„ç†ç”µæºç®¡ç†äº‹ä»¶</li>
<li>[ ] æä¾›åˆç†çš„é»˜è®¤é˜Ÿåˆ—æ·±åº¦</li>
</ul>
<h4 id="io">I/Oè·¯å¾„ä¼˜åŒ–</h4>
<ul>
<li>[ ] æœ€å°åŒ–å†…å­˜åˆ†é…</li>
<li>[ ] é¿å…ä¸å¿…è¦çš„å†…å­˜æ‹·è´</li>
<li>[ ] ä½¿ç”¨per-CPUæ•°æ®å‡å°‘ç«äº‰</li>
<li>[ ] æ‰¹é‡å¤„ç†æé«˜æ•ˆç‡</li>
<li>[ ] æ­£ç¡®è®¾ç½®å†…å­˜å±éšœ</li>
</ul>
<h4 id="device-mapper">Device Mapperç›®æ ‡</h4>
<ul>
<li>[ ] æ”¯æŒåœ¨çº¿æ‰©å®¹</li>
<li>[ ] å¤„ç†åº•å±‚è®¾å¤‡é”™è¯¯</li>
<li>[ ] å®ç°çŠ¶æ€æŒä¹…åŒ–</li>
<li>[ ] æä¾›æœ‰æ„ä¹‰çš„çŠ¶æ€ä¿¡æ¯</li>
<li>[ ] æ”¯æŒéé˜»å¡I/Oè·¯å¾„</li>
</ul>
<h4 id="_13">æ€§èƒ½ç›‘æ§</h4>
<ul>
<li>[ ] å¯¼å‡ºå…³é”®æ€§èƒ½æŒ‡æ ‡</li>
<li>[ ] æ”¯æŒtracepointè°ƒè¯•</li>
<li>[ ] æä¾›sysfsè°ƒä¼˜æ¥å£</li>
<li>[ ] å®ç°I/Oç»Ÿè®¡æ”¶é›†</li>
<li>[ ] é›†æˆåˆ°æ ‡å‡†ç›‘æ§å·¥å…·</li>
</ul>
<h4 id="_14">å¯é æ€§ä¿è¯</h4>
<ul>
<li>[ ] å¤„ç†è®¾å¤‡ç§»é™¤åœºæ™¯</li>
<li>[ ] å®ç°I/Oé”™è¯¯é‡è¯•</li>
<li>[ ] æ”¯æŒI/Oè¶…æ—¶å–æ¶ˆ</li>
<li>[ ] ä¿è¯æ•°æ®ä¸€è‡´æ€§</li>
<li>[ ] ä¼˜é›…å¤„ç†èµ„æºè€—å°½</li>
</ul>
<h3 id="_15">éƒ¨ç½²å»ºè®®</h3>
<ol>
<li><strong>ç”Ÿäº§ç¯å¢ƒé…ç½®</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># è®¾ç½®åˆç†çš„è„é¡µæ¯”ä¾‹</span>
<span class="nb">echo</span><span class="w"> </span><span class="m">5</span><span class="w"> </span>&gt;<span class="w"> </span>/proc/sys/vm/dirty_background_ratio
<span class="nb">echo</span><span class="w"> </span><span class="m">10</span><span class="w"> </span>&gt;<span class="w"> </span>/proc/sys/vm/dirty_ratio

<span class="c1"># è°ƒæ•´é¢„è¯»å¤§å°</span>
blockdev<span class="w"> </span>--setra<span class="w"> </span><span class="m">256</span><span class="w"> </span>/dev/sda

<span class="c1"># è®¾ç½®I/Oè°ƒåº¦å™¨</span>
<span class="nb">echo</span><span class="w"> </span>mq-deadline<span class="w"> </span>&gt;<span class="w"> </span>/sys/block/sda/queue/scheduler

<span class="c1"># å¯ç”¨å¤šé˜Ÿåˆ—</span>
<span class="nb">echo</span><span class="w"> </span><span class="m">8</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/block/sda/queue/nr_requests
</code></pre></div>

<ol start="2">
<li><strong>æ€§èƒ½åŸºå‡†æµ‹è¯•</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># é¡ºåºè¯»å†™</span>
fio<span class="w"> </span>--name<span class="o">=</span>seq<span class="w"> </span>--rw<span class="o">=</span>write<span class="w"> </span>--bs<span class="o">=</span>1M<span class="w"> </span>--size<span class="o">=</span>10G

<span class="c1"># éšæœºIOPS</span>
fio<span class="w"> </span>--name<span class="o">=</span>rand<span class="w"> </span>--rw<span class="o">=</span>randread<span class="w"> </span>--bs<span class="o">=</span>4K<span class="w"> </span>--iodepth<span class="o">=</span><span class="m">32</span>

<span class="c1"># æ··åˆè´Ÿè½½</span>
fio<span class="w"> </span>--name<span class="o">=</span>mixed<span class="w"> </span>--rw<span class="o">=</span>randrw<span class="w"> </span>--rwmixread<span class="o">=</span><span class="m">70</span><span class="w"> </span>--bs<span class="o">=</span>4K
</code></pre></div>

<ol start="3">
<li><strong>æ•…éšœæ³¨å…¥æµ‹è¯•</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># æ¨¡æ‹ŸI/Oé”™è¯¯</span>
<span class="nb">echo</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/block/sda/make-it-fail

<span class="c1"># æ¨¡æ‹ŸI/Oå»¶è¿Ÿ</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;100&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/kernel/debug/fail_io_timeout/probability
</code></pre></div>

<hr />
<p><em>ç¬¬7ç« å®Œæˆã€‚æœ¬ç« è¯¦ç»†å‰–æäº†Linuxå—è®¾å¤‡å±‚çš„æ¶æ„æ¼”è¿›ï¼Œä»ä¼ ç»Ÿçš„å•é˜Ÿåˆ—åˆ°ç°ä»£çš„blk-mqï¼Œä»ç®€å•çš„è°ƒåº¦ç®—æ³•åˆ°æ™ºèƒ½åŒ–çš„I/Oä¼˜åŒ–ã€‚é€šè¿‡å­¦ä¹ æœ¬ç« ï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿç†è§£å­˜å‚¨æ ˆçš„å…³é”®ç»„ä»¶ï¼Œåˆ†æI/Oæ€§èƒ½é—®é¢˜ï¼Œå¹¶é’ˆå¯¹ä¸åŒåœºæ™¯é€‰æ‹©åˆé€‚çš„é…ç½®ç­–ç•¥ã€‚</em></p>
            </article>
            
            <nav class="page-nav"><a href="chapter6.html" class="nav-link prev">â† ç¬¬6ç« ï¼šå…·ä½“æ–‡ä»¶ç³»ç»Ÿå®ç°</a><a href="chapter8.html" class="nav-link next">ç¬¬8ç« ï¼šè®¾å¤‡é©±åŠ¨æ¨¡å‹ â†’</a></nav>
        </main>
    </div>
</body>
</html>