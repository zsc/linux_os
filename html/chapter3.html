<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬3ç« ï¼šå†…å­˜ç®¡ç†æ¶æ„</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Linux å†…æ ¸æºä»£ç æ·±åº¦è§£æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬1ç« ï¼šLinux å†…æ ¸æ¦‚è¿°ä¸å‘å±•å²</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬2ç« ï¼šè¿›ç¨‹ç®¡ç†ä¸ä»»åŠ¡è°ƒåº¦</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬3ç« ï¼šå†…å­˜ç®¡ç†æ¶æ„</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬4ç« ï¼šè¿›ç¨‹é—´é€šä¿¡æœºåˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬5ç« ï¼šè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬6ç« ï¼šå…·ä½“æ–‡ä»¶ç³»ç»Ÿå®ç°</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬7ç« ï¼šå—è®¾å¤‡å±‚ä¸I/Oè°ƒåº¦</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬8ç« ï¼šè®¾å¤‡é©±åŠ¨æ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬9ç« ï¼šç½‘ç»œåè®®æ ˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬10ç« ï¼šå†…æ ¸åŒæ­¥æœºåˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬11ç« ï¼šå¹¶å‘ç¼–ç¨‹æ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬12ç« ï¼šå®¹å™¨ä¸å‘½åç©ºé—´</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬13ç« ï¼šå®‰å…¨å­ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬14ç« ï¼šå®æ—¶Linux</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬15ç« ï¼šæ€§èƒ½åˆ†æä¸è°ƒè¯•</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬16ç« ï¼šå¼•å¯¼è¿‡ç¨‹ä¸åˆå§‹åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="3">ç¬¬3ç« ï¼šå†…å­˜ç®¡ç†æ¶æ„</h1>
<h2 id="_1">æœ¬ç« å¯¼è¯»</h2>
<p>Linux å†…æ ¸çš„å†…å­˜ç®¡ç†æ˜¯æ“ä½œç³»ç»Ÿæœ€å¤æ‚ä¹Ÿæœ€å…³é”®çš„å­ç³»ç»Ÿä¹‹ä¸€ã€‚ä»ç‰©ç†é¡µæ¡†çš„åˆ†é…åˆ°è™šæ‹Ÿåœ°å€ç©ºé—´çš„æ˜ å°„ï¼Œä»é«˜æ•ˆçš„å†…å­˜åˆ†é…å™¨åˆ°æ™ºèƒ½çš„é¡µé¢å›æ”¶æœºåˆ¶ï¼Œå†…å­˜ç®¡ç†ç›´æ¥å½±å“ç€ç³»ç»Ÿçš„æ€§èƒ½ã€ç¨³å®šæ€§å’Œå¯æ‰©å±•æ€§ã€‚æœ¬ç« å°†æ·±å…¥å‰–æ Linux å†…å­˜ç®¡ç†çš„æ ¸å¿ƒæœºåˆ¶ï¼Œç†è§£å…¶å¦‚ä½•åœ¨æœ‰é™çš„ç‰©ç†å†…å­˜ä¸Šæ”¯æ’‘èµ·ç°ä»£è®¡ç®—çš„æ— é™å¯èƒ½ã€‚</p>
<p>å­¦ä¹ ç›®æ ‡ï¼š</p>
<ul>
<li>æŒæ¡ç‰©ç†å†…å­˜ç®¡ç†çš„å±‚æ¬¡ç»“æ„ï¼šèŠ‚ç‚¹(node)ã€åŒºåŸŸ(zone)ã€é¡µæ¡†(page frame)</li>
<li>ç†è§£è™šæ‹Ÿå†…å­˜çš„å®ç°æœºåˆ¶ï¼šé¡µè¡¨ç»“æ„ã€åœ°å€è½¬æ¢ã€TLB ç®¡ç†</li>
<li>æ·±å…¥åˆ†æå†…å­˜åˆ†é…å™¨çš„è®¾è®¡ï¼šä¼™ä¼´ç³»ç»Ÿã€slab/slub/slob åˆ†é…å™¨</li>
<li>æŒæ¡å†…å­˜å›æ”¶ç­–ç•¥ï¼šLRU ç®—æ³•ã€é¡µé¢å›æ”¶ã€OOM killer æœºåˆ¶</li>
<li>ç†è§£ç°ä»£å†…å­˜ç®¡ç†ç‰¹æ€§ï¼šå¤§é¡µæ”¯æŒã€NUMA ä¼˜åŒ–ã€å†…å­˜å‹ç¼©</li>
</ul>
<h2 id="31">3.1 ç‰©ç†å†…å­˜ç®¡ç†æ¶æ„</h2>
<h3 id="311">3.1.1 å†…å­˜å¸ƒå±€ä¸åˆå§‹åŒ–</h3>
<p>Linux å¯åŠ¨æ—¶ï¼Œå†…æ ¸é¦–å…ˆéœ€è¦å»ºç«‹å¯¹ç‰©ç†å†…å­˜çš„è®¤çŸ¥ã€‚åœ¨ x86_64 æ¶æ„ä¸Šï¼Œè¿™ä¸ªè¿‡ç¨‹æ¶‰åŠå¤šä¸ªé˜¶æ®µï¼š</p>
<div class="codehilite"><pre><span></span><code>ç‰©ç†å†…å­˜å¸ƒå±€<span class="w"> </span><span class="p">(</span>å…¸å‹<span class="w"> </span><span class="n">x86_64</span><span class="w"> </span>ç³»ç»Ÿ<span class="p">)</span>ï¼š

<span class="mh">0x0000000000000000</span><span class="w"> </span><span class="o">+------------------+</span>
<span class="w">                   </span><span class="o">|</span><span class="w"> </span>å®æ¨¡å¼ä¸­æ–­å‘é‡è¡¨<span class="w">  </span><span class="o">|</span>
<span class="mh">0x0000000000001000</span><span class="w"> </span><span class="o">+------------------+</span>
<span class="w">                   </span><span class="o">|</span><span class="w"> </span><span class="n">BIOS</span><span class="w"> </span>æ•°æ®åŒº<span class="w">      </span><span class="o">|</span>
<span class="mh">0x00000000000A0000</span><span class="w"> </span><span class="o">+------------------+</span>
<span class="w">                   </span><span class="o">|</span><span class="w"> </span><span class="n">VGA</span><span class="w"> </span>æ˜¾å­˜<span class="w">         </span><span class="o">|</span>
<span class="mh">0x0000000000100000</span><span class="w"> </span><span class="o">+------------------+</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="n">MB</span>
<span class="w">                   </span><span class="o">|</span><span class="w"> </span>å†…æ ¸ä»£ç æ®µ<span class="w">       </span><span class="o">|</span>
<span class="w">                   </span><span class="o">|</span><span class="w"> </span>å†…æ ¸æ•°æ®æ®µ<span class="w">       </span><span class="o">|</span>
<span class="w">                   </span><span class="o">|</span><span class="w"> </span>å†…æ ¸<span class="w"> </span><span class="n">BSS</span><span class="w"> </span>æ®µ<span class="w">      </span><span class="o">|</span>
<span class="mh">0x0000000001000000</span><span class="w"> </span><span class="o">+------------------+</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">16</span><span class="n">MB</span>
<span class="w">                   </span><span class="o">|</span><span class="w"> </span>å¯ç”¨ç‰©ç†å†…å­˜<span class="w">     </span><span class="o">|</span>

<span class="w">                   </span><span class="o">|</span><span class="w"> </span>å¯ç”¨ç‰©ç†å†…å­˜<span class="w">     </span><span class="o">|</span>
<span class="w">                   </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span>
<span class="w">                   </span><span class="o">|</span><span class="w"> </span><span class="p">(</span>ä¸»è¦å†…å­˜åŒºåŸŸ<span class="p">)</span><span class="w">   </span><span class="o">|</span>
<span class="w">                   </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span>

<span class="mh">0x00000000</span><span class="n">XXXX0000</span><span class="w"> </span><span class="o">+------------------+</span>
<span class="w">                   </span><span class="o">|</span><span class="w"> </span><span class="n">ACPI</span><span class="w"> </span>è¡¨<span class="w">          </span><span class="o">|</span>
<span class="w">                   </span><span class="o">|</span><span class="w"> </span>è®¾å¤‡ä¿ç•™å†…å­˜<span class="w">     </span><span class="o">|</span>
<span class="mh">0x00000000FFFF0000</span><span class="w"> </span><span class="o">+------------------+</span>
</code></pre></div>

<p>å†…æ ¸é€šè¿‡ E820 å†…å­˜æ˜ å°„ï¼ˆæˆ– UEFI çš„å†…å­˜æè¿°ç¬¦ï¼‰è·å–å¯ç”¨å†…å­˜ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯å­˜å‚¨åœ¨ <code>struct e820_table</code> ä¸­ï¼ŒåŒ…å«æ¯ä¸ªå†…å­˜åŒºåŸŸçš„èµ·å§‹åœ°å€ã€å¤§å°å’Œç±»å‹ï¼ˆå¯ç”¨ã€ä¿ç•™ã€ACPI ç­‰ï¼‰ã€‚</p>
<h3 id="312-numa">3.1.2 NUMA æ¶æ„ä¸å†…å­˜èŠ‚ç‚¹</h3>
<p>ç°ä»£æœåŠ¡å™¨æ™®éé‡‡ç”¨ NUMAï¼ˆNon-Uniform Memory Accessï¼‰æ¶æ„ï¼Œå†…å­˜è®¿é—®å»¶è¿Ÿå–å†³äº CPU ä¸å†…å­˜çš„ç‰©ç†è·ç¦»ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c">NUMA æ‹“æ‰‘ç¤ºä¾‹ï¼ˆåŒè·¯æœåŠ¡å™¨ï¼‰ï¼š</span>

<span class="c">    Node 0                          Node 1</span>
<span class="nb">+-------------+</span><span class="c">                 </span><span class="nb">+-------------+</span>
<span class="c">|   CPU 0</span><span class="nb">-</span><span class="c">7   |</span><span class="nv">&lt;</span><span class="nb">---</span><span class="c">QPI/UPI</span><span class="nb">----</span><span class="nv">&gt;</span><span class="c">|  CPU 8</span><span class="nb">-</span><span class="c">15   |</span>
<span class="nb">+-------------+</span><span class="c">                 </span><span class="nb">+-------------+</span>
<span class="c">      |                               |</span>
<span class="nb">+-------------+</span><span class="c">                 </span><span class="nb">+-------------+</span>
<span class="c">| Local Memory|                 | Local Memory|</span>
<span class="c">|   (64GB)    |                 |   (64GB)    |</span>
<span class="nb">+-------------+</span><span class="c">                 </span><span class="nb">+-------------+</span>

<span class="c">è®¿é—®å»¶è¿Ÿï¼š</span>

<span class="nb">-</span><span class="c"> æœ¬åœ°å†…å­˜è®¿é—®ï¼š~60ns</span>
<span class="nb">-</span><span class="c"> è¿œç¨‹å†…å­˜è®¿é—®ï¼š~100</span><span class="nb">-</span><span class="c">120ns</span>
</code></pre></div>

<p>å†…æ ¸ä½¿ç”¨ <code>struct pglist_data</code>ï¼ˆé€šå¸¸ç§°ä¸º <code>pg_data_t</code>ï¼‰è¡¨ç¤ºä¸€ä¸ª NUMA èŠ‚ç‚¹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">pglist_data</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">zone</span><span class="w"> </span><span class="n">node_zones</span><span class="p">[</span><span class="n">MAX_NR_ZONES</span><span class="p">];</span><span class="w">  </span><span class="c1">// è¯¥èŠ‚ç‚¹çš„å†…å­˜åŒºåŸŸ</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">zonelist</span><span class="w"> </span><span class="n">node_zonelists</span><span class="p">[</span><span class="n">MAX_ZONELISTS</span><span class="p">];</span><span class="w"> </span><span class="c1">// å†…å­˜åˆ†é…å¤‡é€‰åˆ—è¡¨</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nr_zones</span><span class="p">;</span><span class="w">                          </span><span class="c1">// åŒºåŸŸæ•°é‡</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">node_start_pfn</span><span class="p">;</span><span class="w">          </span><span class="c1">// èµ·å§‹é¡µæ¡†å·</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">node_present_pages</span><span class="p">;</span><span class="w">      </span><span class="c1">// ç‰©ç†é¡µé¢æ€»æ•°</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">node_spanned_pages</span><span class="p">;</span><span class="w">      </span><span class="c1">// è·¨åº¦é¡µé¢æ•°ï¼ˆåŒ…å«ç©ºæ´ï¼‰</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">node_id</span><span class="p">;</span><span class="w">                           </span><span class="c1">// èŠ‚ç‚¹ ID</span>
<span class="w">    </span><span class="n">wait_queue_head_t</span><span class="w"> </span><span class="n">kswapd_wait</span><span class="p">;</span><span class="w">         </span><span class="c1">// kswapd ç­‰å¾…é˜Ÿåˆ—</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">kswapd</span><span class="p">;</span><span class="w">            </span><span class="c1">// é¡µé¢å›æ”¶çº¿ç¨‹</span>
<span class="w">    </span><span class="c1">// ... æ›´å¤šå­—æ®µ</span>
<span class="p">}</span><span class="w"> </span><span class="n">pg_data_t</span><span class="p">;</span>
</code></pre></div>

<h3 id="313-zone">3.1.3 å†…å­˜åŒºåŸŸï¼ˆZoneï¼‰ç®¡ç†</h3>
<p>æ¯ä¸ª NUMA èŠ‚ç‚¹çš„å†…å­˜è¢«åˆ’åˆ†ä¸ºå¤šä¸ªåŒºåŸŸï¼ˆzoneï¼‰ï¼Œåæ˜ ä¸åŒçš„ç¡¬ä»¶é™åˆ¶ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">enum</span><span class="w"> </span><span class="n">zone_type</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ZONE_DMA</span><span class="p">,</span><span class="w">      </span><span class="c1">// 0-16MBï¼ŒISA è®¾å¤‡ DMA</span>
<span class="w">    </span><span class="n">ZONE_DMA32</span><span class="p">,</span><span class="w">    </span><span class="c1">// 0-4GBï¼Œ32ä½è®¾å¤‡ DMA</span>
<span class="w">    </span><span class="n">ZONE_NORMAL</span><span class="p">,</span><span class="w">   </span><span class="c1">// å¸¸è§„å†…å­˜ï¼Œç›´æ¥æ˜ å°„</span>
<span class="w">    </span><span class="n">ZONE_HIGHMEM</span><span class="p">,</span><span class="w">  </span><span class="c1">// é«˜ç«¯å†…å­˜ï¼ˆä»…32ä½ç³»ç»Ÿï¼‰</span>
<span class="w">    </span><span class="n">ZONE_MOVABLE</span><span class="p">,</span><span class="w">  </span><span class="c1">// å¯è¿ç§»é¡µé¢ï¼Œæ”¯æŒå†…å­˜çƒ­æ’æ‹”</span>
<span class="w">    </span><span class="n">ZONE_DEVICE</span><span class="p">,</span><span class="w">   </span><span class="c1">// è®¾å¤‡å†…å­˜ï¼ˆå¦‚ GPUã€æŒä¹…å†…å­˜ï¼‰</span>
<span class="w">    </span><span class="n">__MAX_NR_ZONES</span>
<span class="p">};</span>
</code></pre></div>

<p>æ¯ä¸ªåŒºåŸŸç”± <code>struct zone</code> ç»“æ„ç®¡ç†ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">zone</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">_watermark</span><span class="p">[</span><span class="n">NR_WMARK</span><span class="p">];</span><span class="w">    </span><span class="c1">// æ°´ä½çº¿ï¼šminã€lowã€high</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">watermark_boost</span><span class="p">;</span><span class="w">          </span><span class="c1">// åŠ¨æ€æ°´ä½æå‡</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">lowmem_reserve</span><span class="p">[</span><span class="n">MAX_NR_ZONES</span><span class="p">];</span><span class="w">     </span><span class="c1">// ä¸ºé«˜ä¼˜å…ˆçº§é¢„ç•™</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pglist_data</span><span class="w"> </span><span class="o">*</span><span class="n">zone_pgdat</span><span class="p">;</span><span class="w">        </span><span class="c1">// æ‰€å±èŠ‚ç‚¹</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">per_cpu_pages</span><span class="w"> </span><span class="n">__percpu</span><span class="w"> </span><span class="o">*</span><span class="n">per_cpu_pageset</span><span class="p">;</span><span class="w"> </span><span class="c1">// Per-CPU é¡µé¢ç¼“å­˜</span>

<span class="w">    </span><span class="c1">// ç©ºé—²é¡µé¢ç®¡ç†ï¼ˆä¼™ä¼´ç³»ç»Ÿï¼‰</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">free_area</span><span class="w"> </span><span class="n">free_area</span><span class="p">[</span><span class="n">MAX_ORDER</span><span class="p">];</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">managed_pages</span><span class="p">;</span><span class="w">           </span><span class="c1">// è¢«ä¼™ä¼´ç³»ç»Ÿç®¡ç†çš„é¡µé¢</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">spanned_pages</span><span class="p">;</span><span class="w">           </span><span class="c1">// æ€»è·¨åº¦</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">present_pages</span><span class="p">;</span><span class="w">           </span><span class="c1">// å®é™…å­˜åœ¨çš„é¡µé¢</span>

<span class="w">    </span><span class="c1">// å†…å­˜å‹ç¼©</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">compact_cached_free_pfn</span><span class="p">;</span><span class="w"> </span><span class="c1">// å‹ç¼©æ‰«æä½ç½®</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">compact_init_free_pfn</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// LRU é“¾è¡¨ï¼ˆé¡µé¢å›æ”¶ï¼‰</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lruvec</span><span class="w"> </span><span class="n">lruvec</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">pages_scanned</span><span class="p">;</span><span class="w">           </span><span class="c1">// å·²æ‰«æé¡µé¢æ•°</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span><span class="w">                   </span><span class="c1">// åŒºåŸŸçŠ¶æ€æ ‡å¿—</span>

<span class="w">    </span><span class="c1">// ç»Ÿè®¡ä¿¡æ¯</span>
<span class="w">    </span><span class="n">atomic_long_t</span><span class="w"> </span><span class="n">vm_stat</span><span class="p">[</span><span class="n">NR_VM_ZONE_STAT_ITEMS</span><span class="p">];</span>
<span class="w">    </span><span class="n">atomic_long_t</span><span class="w"> </span><span class="n">vm_numa_stat</span><span class="p">[</span><span class="n">NR_VM_NUMA_STAT_ITEMS</span><span class="p">];</span>
<span class="p">}</span><span class="w"> </span><span class="n">____cacheline_internodealigned_in_smp</span><span class="p">;</span>
</code></pre></div>

<h3 id="314-page-frame-struct-page">3.1.4 é¡µæ¡†ï¼ˆPage Frameï¼‰ä¸ struct page</h3>
<p>ç‰©ç†å†…å­˜ä»¥é¡µæ¡†ï¼ˆé€šå¸¸ 4KBï¼‰ä¸ºå•ä½ç®¡ç†ã€‚æ¯ä¸ªé¡µæ¡†å¯¹åº”ä¸€ä¸ª <code>struct page</code> ç»“æ„ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span><span class="w">    </span><span class="c1">// é¡µé¢çŠ¶æ€æ ‡å¿—ï¼ˆPG_locked, PG_dirty, PG_lru ç­‰ï¼‰</span>

<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// å¤šç§ç”¨é€”çš„è”åˆä½“ï¼ŒèŠ‚çœå†…å­˜</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w">    </span><span class="c1">// é¡µé¢ç¼“å­˜å’ŒåŒ¿åé¡µé¢</span>
<span class="w">            </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">lru</span><span class="p">;</span><span class="w">       </span><span class="c1">// LRU é“¾è¡¨</span>
<span class="w">            </span><span class="k">struct</span><span class="w"> </span><span class="nc">address_space</span><span class="w"> </span><span class="o">*</span><span class="n">mapping</span><span class="p">;</span><span class="w"> </span><span class="c1">// æ‰€å±åœ°å€ç©ºé—´</span>
<span class="w">            </span><span class="n">pgoff_t</span><span class="w"> </span><span class="n">index</span><span class="p">;</span><span class="w">              </span><span class="c1">// åœ¨æ˜ å°„ä¸­çš„åç§»</span>
<span class="w">            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">private</span><span class="p">;</span><span class="w">      </span><span class="c1">// æ–‡ä»¶ç³»ç»Ÿç§æœ‰æ•°æ®</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w">    </span><span class="c1">// slab åˆ†é…å™¨</span>
<span class="w">            </span><span class="k">struct</span><span class="w"> </span><span class="nc">kmem_cache</span><span class="w"> </span><span class="o">*</span><span class="n">slab_cache</span><span class="p">;</span>
<span class="w">            </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">freelist</span><span class="p">;</span><span class="w">             </span><span class="c1">// ç©ºé—²å¯¹è±¡é“¾è¡¨</span>
<span class="w">            </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">s_mem</span><span class="p">;</span><span class="w">                </span><span class="c1">// slab é¦–ä¸ªå¯¹è±¡</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w">    </span><span class="c1">// å¤åˆé¡µï¼ˆå¤§é¡µï¼‰</span>
<span class="w">            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">compound_head</span><span class="p">;</span>
<span class="w">            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">compound_dtor</span><span class="p">;</span>
<span class="w">            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">compound_order</span><span class="p">;</span>
<span class="w">            </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">compound_mapcount</span><span class="p">;</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">_mapcount</span><span class="p">;</span><span class="w">     </span><span class="c1">// é¡µè¡¨æ˜ å°„è®¡æ•°</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">page_type</span><span class="p">;</span><span class="w"> </span><span class="c1">// é¡µé¢ç±»å‹ï¼ˆå¦‚ buddyã€slabï¼‰</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">_refcount</span><span class="p">;</span><span class="w">         </span><span class="c1">// å¼•ç”¨è®¡æ•°</span>

<span class="cp">#ifdef CONFIG_MEMCG</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mem_cgroup</span><span class="w"> </span><span class="o">*</span><span class="n">mem_cgroup</span><span class="p">;</span><span class="w"> </span><span class="c1">// å†…å­˜æ§åˆ¶ç»„</span>
<span class="cp">#endif</span>
<span class="p">};</span>
</code></pre></div>

<p>å…³é”®æ¦‚å¿µï¼š</p>
<ul>
<li><strong>é¡µé¢æ ‡å¿—ï¼ˆflagsï¼‰</strong>ï¼šè®°å½•é¡µé¢çŠ¶æ€ï¼Œå¦‚è„é¡µã€é”å®šã€æ­£åœ¨å›æ”¶ç­‰</li>
<li><strong>å¼•ç”¨è®¡æ•°ï¼ˆ_refcountï¼‰</strong>ï¼šè¿½è¸ªé¡µé¢ä½¿ç”¨è€…æ•°é‡</li>
<li><strong>æ˜ å°„è®¡æ•°ï¼ˆ_mapcountï¼‰</strong>ï¼šè®°å½•é¡µé¢è¢«å¤šå°‘ä¸ªé¡µè¡¨æ˜ å°„</li>
<li><strong>LRU é“¾è¡¨</strong>ï¼šç”¨äºé¡µé¢å›æ”¶ç®—æ³•</li>
</ul>
<h3 id="315-buddy-system">3.1.5 ä¼™ä¼´ç³»ç»Ÿï¼ˆBuddy Systemï¼‰</h3>
<p>ä¼™ä¼´ç³»ç»Ÿæ˜¯ Linux ç‰©ç†å†…å­˜åˆ†é…çš„æ ¸å¿ƒç®—æ³•ï¼Œé€šè¿‡å°†å†…å­˜å—ç»„ç»‡æˆ 2^n é¡µé¢çš„å—æ¥å‡å°‘å¤–éƒ¨ç¢ç‰‡ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="err">ä¼™ä¼´ç³»ç»ŸåŸç†ï¼š</span>

<span class="n">Order</span><span class="w"> </span><span class="mi">0</span><span class="o">:</span><span class="w">  </span><span class="err">â–¡</span><span class="w"> </span><span class="err">â–¡</span><span class="w"> </span><span class="err">â–¡</span><span class="w"> </span><span class="err">â–¡</span><span class="w"> </span><span class="err">â–¡</span><span class="w"> </span><span class="err">â–¡</span><span class="w"> </span><span class="err">â–¡</span><span class="w"> </span><span class="err">â–¡</span><span class="w">  </span><span class="p">(</span><span class="err">å•é¡µï¼Œ</span><span class="mi">4</span><span class="n">KB</span><span class="p">)</span>
<span class="n">Order</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="w">  </span><span class="err">â–¡â–¡</span><span class="w"> </span><span class="err">â–¡â–¡</span><span class="w"> </span><span class="err">â–¡â–¡</span><span class="w"> </span><span class="err">â–¡â–¡</span><span class="w">      </span><span class="p">(</span><span class="mi">2</span><span class="err">é¡µï¼Œ</span><span class="mi">8</span><span class="n">KB</span><span class="p">)</span>
<span class="n">Order</span><span class="w"> </span><span class="mi">2</span><span class="o">:</span><span class="w">  </span><span class="err">â–¡â–¡â–¡â–¡</span><span class="w"> </span><span class="err">â–¡â–¡â–¡â–¡</span><span class="w">        </span><span class="p">(</span><span class="mi">4</span><span class="err">é¡µï¼Œ</span><span class="mi">16</span><span class="n">KB</span><span class="p">)</span>
<span class="n">Order</span><span class="w"> </span><span class="mi">3</span><span class="o">:</span><span class="w">  </span><span class="err">â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡</span><span class="w">          </span><span class="p">(</span><span class="mi">8</span><span class="err">é¡µï¼Œ</span><span class="mi">32</span><span class="n">KB</span><span class="p">)</span>
<span class="p">...</span>
<span class="n">Order</span><span class="w"> </span><span class="mi">10</span><span class="o">:</span><span class="w"> </span><span class="err">â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡</span><span class="p">...</span><span class="w">       </span><span class="p">(</span><span class="mi">1024</span><span class="err">é¡µï¼Œ</span><span class="mi">4</span><span class="n">MB</span><span class="p">)</span>

<span class="err">åˆ†é…è¿‡ç¨‹ï¼ˆç”³è¯·</span><span class="w"> </span><span class="mi">8</span><span class="n">KB</span><span class="err">ï¼‰ï¼š</span>

<span class="mf">1.</span><span class="w"> </span><span class="err">æ£€æŸ¥</span><span class="w"> </span><span class="n">Order</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="err">æ˜¯å¦æœ‰ç©ºé—²å—</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="err">æ— </span>
<span class="mf">2.</span><span class="w"> </span><span class="err">æ£€æŸ¥</span><span class="w"> </span><span class="n">Order</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="err">æ˜¯å¦æœ‰ç©ºé—²å—</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="err">æœ‰</span>
<span class="mf">3.</span><span class="w"> </span><span class="err">åˆ†è£‚</span><span class="w"> </span><span class="n">Order</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="err">å—ï¼š</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="err">å–ä¸€åŠï¼ˆ</span><span class="mi">8</span><span class="n">KB</span><span class="err">ï¼‰æ»¡è¶³è¯·æ±‚</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="err">å¦ä¸€åŠæ”¾å…¥</span><span class="w"> </span><span class="n">Order</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="err">ç©ºé—²é“¾è¡¨</span>
</code></pre></div>

<p>ä¼™ä¼´ç³»ç»Ÿçš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">free_area</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">free_list</span><span class="p">[</span><span class="n">MIGRATE_TYPES</span><span class="p">];</span><span class="w"> </span><span class="c1">// æŒ‰è¿ç§»ç±»å‹åˆ†ç±»çš„ç©ºé—²é“¾è¡¨</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">nr_free</span><span class="p">;</span><span class="w">                     </span><span class="c1">// ç©ºé—²å—æ•°é‡</span>
<span class="p">};</span>

<span class="c1">// é¡µé¢è¿ç§»ç±»å‹ï¼ˆå‡å°‘ç¢ç‰‡åŒ–ï¼‰</span>
<span class="k">enum</span><span class="w"> </span><span class="n">migratetype</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">MIGRATE_UNMOVABLE</span><span class="p">,</span><span class="w">     </span><span class="c1">// ä¸å¯è¿ç§»ï¼ˆå†…æ ¸æ•°æ®ç»“æ„ï¼‰</span>
<span class="w">    </span><span class="n">MIGRATE_MOVABLE</span><span class="p">,</span><span class="w">       </span><span class="c1">// å¯è¿ç§»ï¼ˆç”¨æˆ·é¡µé¢ï¼‰</span>
<span class="w">    </span><span class="n">MIGRATE_RECLAIMABLE</span><span class="p">,</span><span class="w">   </span><span class="c1">// å¯å›æ”¶ï¼ˆæ–‡ä»¶ç¼“å­˜ï¼‰</span>
<span class="w">    </span><span class="n">MIGRATE_PCPTYPES</span><span class="p">,</span><span class="w">      </span><span class="c1">// Per-CPU é¡µé¢ç±»å‹æ•°</span>
<span class="w">    </span><span class="n">MIGRATE_HIGHATOMIC</span><span class="p">,</span><span class="w">    </span><span class="c1">// é«˜ä¼˜å…ˆçº§åŸå­åˆ†é…</span>
<span class="w">    </span><span class="n">MIGRATE_CMA</span><span class="p">,</span><span class="w">           </span><span class="c1">// è¿ç»­å†…å­˜åˆ†é…å™¨</span>
<span class="w">    </span><span class="n">MIGRATE_ISOLATE</span><span class="p">,</span><span class="w">       </span><span class="c1">// éš”ç¦»é¡µé¢ï¼ˆå†…å­˜çƒ­æ’æ‹”ï¼‰</span>
<span class="w">    </span><span class="n">MIGRATE_TYPES</span>
<span class="p">};</span>
</code></pre></div>

<p>åˆ†é…å‡½æ•°è°ƒç”¨é“¾ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">alloc_pages</span><span class="p">()</span>
<span class="w">  </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">alloc_pages_current</span><span class="p">()</span><span class="w">  </span><span class="c1">// NUMA ç­–ç•¥</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">__alloc_pages_nodemask</span><span class="p">()</span><span class="w">  </span><span class="c1">// æ ¸å¿ƒåˆ†é…å‡½æ•°</span>
<span class="w">      </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">get_page_from_freelist</span><span class="p">()</span><span class="w">  </span><span class="c1">// å¿«é€Ÿè·¯å¾„</span>
<span class="w">        </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">rmqueue</span><span class="p">()</span><span class="w">  </span><span class="c1">// ä»ä¼™ä¼´ç³»ç»Ÿå–é¡µ</span>
<span class="w">          </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">__rmqueue</span><span class="p">()</span><span class="w">  </span><span class="c1">// å®é™…åˆ†é…</span>
<span class="w">      </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">__alloc_pages_slowpath</span><span class="p">()</span><span class="w">  </span><span class="c1">// æ…¢é€Ÿè·¯å¾„ï¼ˆå†…å­˜ç´§å¼ ï¼‰</span>
<span class="w">        </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">__alloc_pages_direct_reclaim</span><span class="p">()</span><span class="w">  </span><span class="c1">// ç›´æ¥å›æ”¶</span>
<span class="w">        </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">__alloc_pages_direct_compact</span><span class="p">()</span><span class="w">  </span><span class="c1">// å†…å­˜å‹ç¼©</span>
<span class="w">        </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">oom_kill_process</span><span class="p">()</span><span class="w">  </span><span class="c1">// OOM killer</span>
</code></pre></div>

<h2 id="32">3.2 è™šæ‹Ÿå†…å­˜æœºåˆ¶</h2>
<h3 id="321">3.2.1 è™šæ‹Ÿåœ°å€ç©ºé—´å¸ƒå±€</h3>
<p>Linux ä¸ºæ¯ä¸ªè¿›ç¨‹æä¾›ç‹¬ç«‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚åœ¨ x86_64 æ¶æ„ä¸Šï¼Œè™½ç„¶ç¡¬ä»¶æ”¯æŒ 48 ä½è™šæ‹Ÿåœ°å€ï¼ˆ256TBï¼‰ï¼Œä½†å†…æ ¸é‡‡ç”¨äº†åˆ†å‰²å¼å¸ƒå±€ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">x86_64</span><span class="w"> </span>è™šæ‹Ÿåœ°å€ç©ºé—´å¸ƒå±€ï¼ˆ<span class="m">5</span>çº§é¡µè¡¨ï¼Œ<span class="m">57</span>ä½åœ°å€ï¼‰ï¼š

<span class="mh">0x0000000000000000</span><span class="w"> </span><span class="o">+------------------+</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span>ç”¨æˆ·ç©ºé—´å¼€å§‹
<span class="w">                   </span><span class="o">|</span><span class="w"> </span>ç¨‹åºä»£ç æ®µ<span class="p">(</span><span class="n">.text</span><span class="p">)</span><span class="w"> </span><span class="o">|</span>
<span class="w">                   </span><span class="o">|</span><span class="w"> </span>ç¨‹åºæ•°æ®æ®µ<span class="p">(</span><span class="n">.data</span><span class="p">)</span><span class="w"> </span><span class="o">|</span>
<span class="w">                   </span><span class="o">|</span><span class="w"> </span><span class="n">BSS</span><span class="w"> </span>æ®µ<span class="p">(</span><span class="n">.bss</span><span class="p">)</span><span class="w">      </span><span class="o">|</span>
<span class="w">                   </span><span class="o">|</span><span class="w"> </span>å †ï¼ˆå‘ä¸Šå¢é•¿ï¼‰â†“<span class="w">    </span><span class="o">|</span>

<span class="w">                   </span><span class="o">|</span><span class="w"> </span>å †ï¼ˆå‘ä¸Šå¢é•¿ï¼‰â†“<span class="w">    </span><span class="o">|</span>
<span class="w">                   </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span>
<span class="w">                   </span><span class="o">|</span><span class="w"> </span>â†“<span class="w"> </span><span class="n">MMAP</span><span class="w"> </span>åŒºåŸŸ<span class="w"> </span>â†“<span class="w">     </span><span class="o">|</span>
<span class="w">                   </span><span class="o">|</span><span class="w">                   </span><span class="o">|</span>
<span class="w">                   </span><span class="o">|</span><span class="w"> </span>â†‘<span class="w"> </span>æ ˆï¼ˆå‘ä¸‹å¢é•¿ï¼‰<span class="w">   </span><span class="o">|</span>

<span class="mh">0x00007FFFFFFFFFFF</span><span class="w"> </span><span class="o">+------------------+</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span>ç”¨æˆ·ç©ºé—´ç»“æŸ<span class="w"> </span><span class="p">(</span><span class="m">128</span><span class="n">TB</span><span class="p">)</span>
<span class="w">                   </span><span class="o">|</span><span class="w"> </span>ä¸å¯è®¿é—®åŒºåŸŸ<span class="w">       </span><span class="o">|</span>
<span class="mh">0xFFFF800000000000</span><span class="w"> </span><span class="o">+------------------+</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span>å†…æ ¸ç©ºé—´å¼€å§‹
<span class="w">                   </span><span class="o">|</span><span class="w"> </span><span class="n">vmalloc</span><span class="w"> </span>åŒºåŸŸ<span class="w">      </span><span class="o">|</span>
<span class="w">                   </span><span class="o">|</span><span class="w"> </span>æŒä¹…æ˜ å°„åŒº<span class="w">         </span><span class="o">|</span>
<span class="w">                   </span><span class="o">|</span><span class="w"> </span>å›ºå®šæ˜ å°„åŒº<span class="w">         </span><span class="o">|</span>
<span class="w">                   </span><span class="o">|</span><span class="w"> </span>æ¨¡å—åŒºåŸŸ<span class="w">          </span><span class="o">|</span>
<span class="mh">0xFFFF888000000000</span><span class="w"> </span><span class="o">+------------------+</span>
<span class="w">                   </span><span class="o">|</span><span class="w"> </span>ç›´æ¥æ˜ å°„åŒº<span class="w">        </span><span class="o">|</span>
<span class="w">                   </span><span class="o">|</span><span class="w"> </span><span class="p">(</span>æ‰€æœ‰ç‰©ç†å†…å­˜<span class="p">)</span><span class="w">     </span><span class="o">|</span>
<span class="mh">0xFFFFFFFFFFFFFFFF</span><span class="w"> </span><span class="o">+------------------+</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span>å†…æ ¸ç©ºé—´ç»“æŸ
</code></pre></div>

<p>ç”¨æˆ·è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ç”± <code>struct mm_struct</code> ç®¡ç†ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_area_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mmap</span><span class="p">;</span><span class="w">       </span><span class="c1">// VMA é“¾è¡¨</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rb_root</span><span class="w"> </span><span class="n">mm_rb</span><span class="p">;</span><span class="w">               </span><span class="c1">// VMA çº¢é»‘æ ‘ï¼ˆå¿«é€ŸæŸ¥æ‰¾ï¼‰</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">mmap_base</span><span class="p">;</span><span class="w">            </span><span class="c1">// mmap åŒºåŸŸåŸºåœ°å€</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">task_size</span><span class="p">;</span><span class="w">            </span><span class="c1">// ç”¨æˆ·ç©ºé—´å¤§å°</span>

<span class="w">    </span><span class="n">pgd_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgd</span><span class="p">;</span><span class="w">                         </span><span class="c1">// é¡µå…¨å±€ç›®å½•</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">mm_users</span><span class="p">;</span><span class="w">                  </span><span class="c1">// ç”¨æˆ·è®¡æ•°ï¼ˆçº¿ç¨‹æ•°ï¼‰</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">mm_count</span><span class="p">;</span><span class="w">                  </span><span class="c1">// å¼•ç”¨è®¡æ•°</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">total_vm</span><span class="p">;</span><span class="w">             </span><span class="c1">// æ€»è™šæ‹Ÿå†…å­˜é¡µæ•°</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">locked_vm</span><span class="p">;</span><span class="w">            </span><span class="c1">// é”å®šé¡µæ•°</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">pinned_vm</span><span class="p">;</span><span class="w">            </span><span class="c1">// å›ºå®šé¡µæ•°</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">data_vm</span><span class="p">;</span><span class="w">              </span><span class="c1">// æ•°æ®æ®µé¡µæ•°</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">exec_vm</span><span class="p">;</span><span class="w">              </span><span class="c1">// å¯æ‰§è¡Œé¡µæ•°</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">stack_vm</span><span class="p">;</span><span class="w">             </span><span class="c1">// æ ˆé¡µæ•°</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">start_code</span><span class="p">,</span><span class="w"> </span><span class="n">end_code</span><span class="p">;</span><span class="w">     </span><span class="c1">// ä»£ç æ®µèŒƒå›´</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">start_data</span><span class="p">,</span><span class="w"> </span><span class="n">end_data</span><span class="p">;</span><span class="w">     </span><span class="c1">// æ•°æ®æ®µèŒƒå›´</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">start_brk</span><span class="p">,</span><span class="w"> </span><span class="n">brk</span><span class="p">;</span><span class="w">           </span><span class="c1">// å †èŒƒå›´</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">start_stack</span><span class="p">;</span><span class="w">              </span><span class="c1">// æ ˆèµ·å§‹åœ°å€</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">arg_start</span><span class="p">,</span><span class="w"> </span><span class="n">arg_end</span><span class="p">;</span><span class="w">       </span><span class="c1">// å‚æ•°èŒƒå›´</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">env_start</span><span class="p">,</span><span class="w"> </span><span class="n">env_end</span><span class="p">;</span><span class="w">       </span><span class="c1">// ç¯å¢ƒå˜é‡èŒƒå›´</span>

<span class="w">    </span><span class="n">spinlock_t</span><span class="w"> </span><span class="n">page_table_lock</span><span class="p">;</span><span class="w">        </span><span class="c1">// é¡µè¡¨é”</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rw_semaphore</span><span class="w"> </span><span class="n">mmap_sem</span><span class="p">;</span><span class="w">       </span><span class="c1">// mmap ä¿¡å·é‡</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">mmlist</span><span class="p">;</span><span class="w">            </span><span class="c1">// æ‰€æœ‰ mm_struct é“¾è¡¨</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">hiwater_rss</span><span class="p">;</span><span class="w">          </span><span class="c1">// RSS é«˜æ°´ä½</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">hiwater_vm</span><span class="p">;</span><span class="w">           </span><span class="c1">// è™šæ‹Ÿå†…å­˜é«˜æ°´ä½</span>

<span class="w">    </span><span class="c1">// æ›´å¤šå­—æ®µ...</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="322-vma">3.2.2 è™šæ‹Ÿå†…å­˜åŒºåŸŸï¼ˆVMAï¼‰</h3>
<p>è™šæ‹Ÿåœ°å€ç©ºé—´è¢«åˆ’åˆ†ä¸ºå¤šä¸ªè™šæ‹Ÿå†…å­˜åŒºåŸŸï¼ˆVMAï¼‰ï¼Œæ¯ä¸ª VMA ä»£è¡¨ä¸€æ®µè¿ç»­çš„è™šæ‹Ÿåœ°å€èŒƒå›´ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">vm_area_struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">vm_start</span><span class="p">;</span><span class="w">             </span><span class="c1">// VMA èµ·å§‹åœ°å€</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">vm_end</span><span class="p">;</span><span class="w">               </span><span class="c1">// VMA ç»“æŸåœ°å€</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_area_struct</span><span class="w"> </span><span class="o">*</span><span class="n">vm_next</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">vm_prev</span><span class="p">;</span><span class="w">  </span><span class="c1">// é“¾è¡¨æŒ‡é’ˆ</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rb_node</span><span class="w"> </span><span class="n">vm_rb</span><span class="p">;</span><span class="w">               </span><span class="c1">// çº¢é»‘æ ‘èŠ‚ç‚¹</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">vm_mm</span><span class="p">;</span><span class="w">            </span><span class="c1">// æ‰€å±çš„ mm_struct</span>
<span class="w">    </span><span class="n">pgprot_t</span><span class="w"> </span><span class="n">vm_page_prot</span><span class="p">;</span><span class="w">              </span><span class="c1">// é¡µé¢ä¿æŠ¤æ ‡å¿—</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">vm_flags</span><span class="p">;</span><span class="w">             </span><span class="c1">// VMA æ ‡å¿—</span>

<span class="w">    </span><span class="c1">// å…±äº«æ˜ å°„</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">rb_node</span><span class="w"> </span><span class="n">rb</span><span class="p">;</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">rb_subtree_last</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">shared</span><span class="p">;</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">anon_vma_chain</span><span class="p">;</span><span class="w">    </span><span class="c1">// åŒ¿å VMA é“¾</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">anon_vma</span><span class="w"> </span><span class="o">*</span><span class="n">anon_vma</span><span class="p">;</span><span class="w">          </span><span class="c1">// åå‘æ˜ å°„</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_operations_struct</span><span class="w"> </span><span class="o">*</span><span class="n">vm_ops</span><span class="p">;</span><span class="w">  </span><span class="c1">// VMA æ“ä½œ</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">vm_pgoff</span><span class="p">;</span><span class="w">             </span><span class="c1">// æ–‡ä»¶åç§»ï¼ˆé¡µå•ä½ï¼‰</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">vm_file</span><span class="p">;</span><span class="w">               </span><span class="c1">// æ˜ å°„çš„æ–‡ä»¶</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">vm_private_data</span><span class="p">;</span><span class="w">              </span><span class="c1">// ç§æœ‰æ•°æ®</span>

<span class="w">    </span><span class="c1">// NUMA ç­–ç•¥</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mempolicy</span><span class="w"> </span><span class="o">*</span><span class="n">vm_policy</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_userfaultfd_ctx</span><span class="w"> </span><span class="n">vm_userfaultfd_ctx</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// VMA æ ‡å¿—</span>
<span class="cp">#define VM_READ     0x00000001  </span><span class="c1">// å¯è¯»</span>
<span class="cp">#define VM_WRITE    0x00000002  </span><span class="c1">// å¯å†™</span>
<span class="cp">#define VM_EXEC     0x00000004  </span><span class="c1">// å¯æ‰§è¡Œ</span>
<span class="cp">#define VM_SHARED   0x00000008  </span><span class="c1">// å…±äº«æ˜ å°„</span>
<span class="cp">#define VM_MAYREAD  0x00000010  </span><span class="c1">// å¯èƒ½å¯è¯»</span>
<span class="cp">#define VM_MAYWRITE 0x00000020  </span><span class="c1">// å¯èƒ½å¯å†™</span>
<span class="cp">#define VM_MAYEXEC  0x00000040  </span><span class="c1">// å¯èƒ½å¯æ‰§è¡Œ</span>
<span class="cp">#define VM_GROWSDOWN 0x00000100 </span><span class="c1">// å‘ä¸‹å¢é•¿ï¼ˆæ ˆï¼‰</span>
<span class="cp">#define VM_LOCKED   0x00002000  </span><span class="c1">// é¡µé¢é”å®šåœ¨å†…å­˜</span>
<span class="cp">#define VM_HUGETLB  0x00400000  </span><span class="c1">// å¤§é¡µæ˜ å°„</span>
</code></pre></div>

<h3 id="323">3.2.3 å¤šçº§é¡µè¡¨æœºåˆ¶</h3>
<p>x86_64 ä½¿ç”¨ 4 çº§æˆ– 5 çº§é¡µè¡¨å®ç°è™šæ‹Ÿåˆ°ç‰©ç†åœ°å€è½¬æ¢ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="mi">4</span><span class="n">çº§é¡µè¡¨åœ°å€è½¬æ¢</span><span class="err">ï¼ˆ</span><span class="mi">48</span><span class="n">ä½è™šæ‹Ÿåœ°å€</span><span class="err">ï¼‰ï¼š</span>

<span class="n">è™šæ‹Ÿåœ°å€</span><span class="err">ï¼š</span>
<span class="o">+--------+--------+--------+--------+--------+------------+</span>
<span class="o">|</span><span class="w"> </span><span class="nf">Sign</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">PGD</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">PUD</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">PMD</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">PTE</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Offset</span><span class="w">     </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="n">Extend</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">Index</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="k">Index</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="k">Index</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="k">Index</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="mi">12</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w">  </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">4</span><span class="n">KB</span><span class="w"> </span><span class="n">page</span><span class="w">   </span><span class="o">|</span>
<span class="o">+--------+--------+--------+--------+--------+------------+</span>

<span class="n">è½¬æ¢è¿‡ç¨‹</span><span class="err">ï¼š</span>
<span class="n">CR3</span><span class="w"> </span><span class="n">å¯„å­˜å™¨</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">PGD</span><span class="w"> </span><span class="n">åŸºåœ°å€</span>
<span class="w">    </span><span class="o">|</span>
<span class="w">    </span><span class="n">v</span>
<span class="n">PGD</span><span class="o">[</span><span class="n">pgd_index</span><span class="o">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">PUD</span><span class="w"> </span><span class="n">åŸºåœ°å€</span>
<span class="w">    </span><span class="o">|</span>
<span class="w">    </span><span class="n">v</span>
<span class="n">PUD</span><span class="o">[</span><span class="n">pud_index</span><span class="o">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">PMD</span><span class="w"> </span><span class="n">åŸºåœ°å€</span>
<span class="w">    </span><span class="o">|</span>
<span class="w">    </span><span class="n">v</span>
<span class="n">PMD</span><span class="o">[</span><span class="n">pmd_index</span><span class="o">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">PT</span><span class="w"> </span><span class="n">åŸºåœ°å€</span>
<span class="w">    </span><span class="o">|</span>
<span class="w">    </span><span class="n">v</span>
<span class="n">PTE</span><span class="o">[</span><span class="n">pte_index</span><span class="o">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">ç‰©ç†é¡µæ¡†</span>
<span class="w">    </span><span class="o">|</span>
<span class="w">    </span><span class="n">v</span>
<span class="n">ç‰©ç†åœ°å€</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">é¡µæ¡†åœ°å€</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset</span>
</code></pre></div>

<p>é¡µè¡¨é¡¹æ ¼å¼ï¼ˆx86_64 PTEï¼‰ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="mf">63</span><span class="w">                                                             </span><span class="mf">0</span>
<span class="o">+---+---+---+-----+---+---+---+---+---+---+---+---+-----------+</span>
<span class="err">|</span><span class="n">NX</span><span class="w"> </span><span class="err">|</span><span class="w">   </span><span class="err">|</span><span class="w"> </span><span class="n">Reserved</span><span class="w"> </span><span class="err">|</span><span class="w">   </span><span class="n">Physical</span><span class="w"> </span><span class="n">Page</span><span class="w"> </span><span class="n">Frame</span><span class="w"> </span><span class="n">Number</span><span class="w">   </span><span class="err">|</span><span class="w"> </span><span class="n">Flags</span><span class="w">    </span><span class="err">|</span>
<span class="o">+---+---+---+-----+---+---+---+---+---+---+---+---+-----------+</span>
<span class="w">  </span><span class="err">|</span><span class="w">                                                      </span><span class="err">|</span>
<span class="w">  </span><span class="err">|</span><span class="w">                                                      </span><span class="o">+-&gt;</span><span class="w"> </span><span class="n">P</span><span class="p">(</span><span class="n">resent</span><span class="p">)</span>
<span class="w">  </span><span class="err">|</span><span class="w">                                                      </span><span class="o">+-&gt;</span><span class="w"> </span><span class="n">R</span><span class="o">/</span><span class="n">W</span>
<span class="w">  </span><span class="err">|</span><span class="w">                                                      </span><span class="o">+-&gt;</span><span class="w"> </span><span class="n">U</span><span class="o">/</span><span class="n">S</span>
<span class="w">  </span><span class="err">|</span><span class="w">                                                      </span><span class="o">+-&gt;</span><span class="w"> </span><span class="n">PWT</span>
<span class="w">  </span><span class="err">|</span><span class="w">                                                      </span><span class="o">+-&gt;</span><span class="w"> </span><span class="n">PCD</span>
<span class="w">  </span><span class="err">|</span><span class="w">                                                      </span><span class="o">+-&gt;</span><span class="w"> </span><span class="n">A</span><span class="p">(</span><span class="n">ccessed</span><span class="p">)</span>
<span class="w">  </span><span class="err">|</span><span class="w">                                                      </span><span class="o">+-&gt;</span><span class="w"> </span><span class="n">D</span><span class="p">(</span><span class="n">irty</span><span class="p">)</span>
<span class="w">  </span><span class="err">|</span><span class="w">                                                      </span><span class="o">+-&gt;</span><span class="w"> </span><span class="n">PAT</span>
<span class="w">  </span><span class="err">|</span><span class="w">                                                      </span><span class="o">+-&gt;</span><span class="w"> </span><span class="n">G</span><span class="p">(</span><span class="n">lobal</span><span class="p">)</span>
<span class="w">  </span><span class="o">+-&gt;</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="n">eXecute</span>
</code></pre></div>

<p>å†…æ ¸é¡µè¡¨æ“ä½œå®ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// é¡µè¡¨çº§åˆ«å®šä¹‰</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">pgd</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">pgd_t</span><span class="p">;</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">pud</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">pud_t</span><span class="p">;</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">pmd</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">pmd_t</span><span class="p">;</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">pte</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">pte_t</span><span class="p">;</span>

<span class="c1">// åœ°å€è½¬æ¢è¾…åŠ©å‡½æ•°</span>
<span class="cp">#define pgd_index(addr) (((addr) &gt;&gt; PGDIR_SHIFT) &amp; (PTRS_PER_PGD - 1))</span>
<span class="cp">#define pud_index(addr) (((addr) &gt;&gt; PUD_SHIFT) &amp; (PTRS_PER_PUD - 1))</span>
<span class="cp">#define pmd_index(addr) (((addr) &gt;&gt; PMD_SHIFT) &amp; (PTRS_PER_PMD - 1))</span>
<span class="cp">#define pte_index(addr) (((addr) &gt;&gt; PAGE_SHIFT) &amp; (PTRS_PER_PTE - 1))</span>

<span class="c1">// é¡µè¡¨éå†</span>
<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="n">pud_t</span><span class="w"> </span><span class="o">*</span><span class="nf">pud_offset</span><span class="p">(</span><span class="n">pgd_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgd</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">address</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">pud_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">pgd_page_vaddr</span><span class="p">(</span><span class="o">*</span><span class="n">pgd</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pud_index</span><span class="p">(</span><span class="n">address</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="n">pmd_t</span><span class="w"> </span><span class="o">*</span><span class="nf">pmd_offset</span><span class="p">(</span><span class="n">pud_t</span><span class="w"> </span><span class="o">*</span><span class="n">pud</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">address</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">pmd_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">pud_page_vaddr</span><span class="p">(</span><span class="o">*</span><span class="n">pud</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pmd_index</span><span class="p">(</span><span class="n">address</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="nf">pte_offset_kernel</span><span class="p">(</span><span class="n">pmd_t</span><span class="w"> </span><span class="o">*</span><span class="n">pmd</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">address</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">pmd_page_vaddr</span><span class="p">(</span><span class="o">*</span><span class="n">pmd</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pte_index</span><span class="p">(</span><span class="n">address</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="324-tlb">3.2.4 TLB ç®¡ç†</h3>
<p>TLBï¼ˆTranslation Lookaside Bufferï¼‰ç¼“å­˜è™šæ‹Ÿåˆ°ç‰©ç†åœ°å€çš„æ˜ å°„ï¼Œé¿å…æ¯æ¬¡è®¿é—®å†…å­˜éƒ½è¦éå†é¡µè¡¨ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c">TLB ç»“æ„ç¤ºä¾‹ï¼š</span>

<span class="nb">+----------+----------+--------+-------+-------+</span>
<span class="c">| Valid    | ASID/PCID| VPN    | PFN   | Flags |</span>
<span class="nb">+----------+----------+--------+-------+-------+</span>
<span class="c">| 1        | 0x123    | 0x7fff | 0x5432| RWX   |</span>
<span class="c">| 1        | 0x123    | 0x8000 | 0x6789| R</span><span class="nb">-</span><span class="c">X   |</span>
<span class="c">| 0        | </span><span class="nb">-</span><span class="c">        | </span><span class="nb">-</span><span class="c">      | </span><span class="nb">-</span><span class="c">     | </span><span class="nb">-</span><span class="c">     |</span>
<span class="nb">+----------+----------+--------+-------+-------+</span>

<span class="c">TLB å‘½ä¸­ç‡å¯¹æ€§èƒ½çš„å½±å“ï¼š</span>

<span class="nb">-</span><span class="c"> TLB å‘½ä¸­ï¼š~1 CPU å‘¨æœŸ</span>
<span class="nb">-</span><span class="c"> TLB æœªå‘½ä¸­ï¼š~100</span><span class="nb">-</span><span class="c">200 CPU å‘¨æœŸï¼ˆ4çº§é¡µè¡¨éå†ï¼‰</span>
</code></pre></div>

<p>Linux TLB åˆ·æ–°ç­–ç•¥ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// TLB åˆ·æ–°æ¥å£</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">flush_tlb_all</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span><span class="w">                    </span><span class="c1">// åˆ·æ–°æ‰€æœ‰ TLB é¡¹</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">flush_tlb_mm</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">);</span><span class="w">     </span><span class="c1">// åˆ·æ–°ç‰¹å®šè¿›ç¨‹çš„ TLB</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">flush_tlb_page</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_area_struct</span><span class="w"> </span><span class="o">*</span><span class="n">vma</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">flush_tlb_range</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_area_struct</span><span class="w"> </span><span class="o">*</span><span class="n">vma</span><span class="p">,</span><span class="w"> </span>
<span class="w">                     </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">end</span><span class="p">);</span>

<span class="c1">// æ‡’æƒ° TLB æ¨¡å¼ï¼ˆå†…æ ¸çº¿ç¨‹ä¼˜åŒ–ï¼‰</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="n">init_mm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">mm_rb</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">RB_ROOT</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">pgd</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">swapper_pg_dir</span><span class="p">,</span><span class="w">  </span><span class="c1">// å†…æ ¸é¡µè¡¨</span>
<span class="w">    </span><span class="p">.</span><span class="n">mm_users</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">ATOMIC_INIT</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">mm_count</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">ATOMIC_INIT</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">mmap_sem</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">__RWSEM_INITIALIZER</span><span class="p">(</span><span class="n">init_mm</span><span class="p">.</span><span class="n">mmap_sem</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">page_table_lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__SPIN_LOCK_UNLOCKED</span><span class="p">(</span><span class="n">init_mm</span><span class="p">.</span><span class="n">page_table_lock</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">mmlist</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">LIST_HEAD_INIT</span><span class="p">(</span><span class="n">init_mm</span><span class="p">.</span><span class="n">mmlist</span><span class="p">),</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="325">3.2.5 ç¼ºé¡µå¼‚å¸¸å¤„ç†</h3>
<p>å½“è®¿é—®çš„è™šæ‹Ÿåœ°å€æ²¡æœ‰å¯¹åº”çš„ç‰©ç†é¡µé¢æ—¶ï¼ŒCPU è§¦å‘ç¼ºé¡µå¼‚å¸¸ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// x86_64 ç¼ºé¡µå¼‚å¸¸å¤„ç†å…¥å£</span>
<span class="n">dotraplinkage</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">do_page_fault</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">pt_regs</span><span class="w"> </span><span class="o">*</span><span class="n">regs</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">error_code</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_cr2</span><span class="p">();</span><span class="w">  </span><span class="c1">// è·å–å¼•èµ·å¼‚å¸¸çš„åœ°å€</span>

<span class="w">    </span><span class="c1">// é”™è¯¯ç è§£æ</span>
<span class="w">    </span><span class="c1">// bit 0: 0=é¡µä¸å­˜åœ¨, 1=ä¿æŠ¤è¿ä¾‹</span>
<span class="w">    </span><span class="c1">// bit 1: 0=è¯»è®¿é—®, 1=å†™è®¿é—®</span>
<span class="w">    </span><span class="c1">// bit 2: 0=å†…æ ¸æ¨¡å¼, 1=ç”¨æˆ·æ¨¡å¼</span>
<span class="w">    </span><span class="c1">// bit 3: 1=ä½¿ç”¨ä¿ç•™ä½</span>
<span class="w">    </span><span class="c1">// bit 4: 1=æŒ‡ä»¤è·å–</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">kmmio_fault</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="p">)))</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">fault_in_kernel_space</span><span class="p">(</span><span class="n">address</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// å†…æ ¸ç©ºé—´ç¼ºé¡µ</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vmalloc_fault</span><span class="p">(</span><span class="n">address</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// ç”¨æˆ·ç©ºé—´ç¼ºé¡µ</span>
<span class="w">    </span><span class="n">__do_page_fault</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span><span class="w"> </span><span class="n">error_code</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// ç¼ºé¡µå¤„ç†æ ¸å¿ƒé€»è¾‘</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">handle_mm_fault</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_area_struct</span><span class="w"> </span><span class="o">*</span><span class="n">vma</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">address</span><span class="p">,</span>
<span class="w">                          </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">is_vm_hugetlb_page</span><span class="p">(</span><span class="n">vma</span><span class="p">)))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">hugetlb_fault</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_mm</span><span class="p">,</span><span class="w"> </span><span class="n">vma</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>

<span class="w">    </span><span class="n">pgd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pgd_offset</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="p">);</span>
<span class="w">    </span><span class="n">pud</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pud_alloc</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">pgd</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="p">);</span>
<span class="w">    </span><span class="n">pmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pmd_alloc</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">pud</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">handle_pte_fault</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">vma</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">pte</span><span class="p">,</span><span class="w"> </span><span class="n">pmd</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>ç¼ºé¡µå¼‚å¸¸ç±»å‹ï¼š</p>
<ol>
<li><strong>æ¬¡è¦ç¼ºé¡µï¼ˆMinor Faultï¼‰</strong>ï¼šé¡µé¢åœ¨å†…å­˜ä¸­ä½†æœªæ˜ å°„</li>
<li><strong>ä¸»è¦ç¼ºé¡µï¼ˆMajor Faultï¼‰</strong>ï¼šéœ€è¦ä»ç£ç›˜è¯»å–</li>
<li><strong>å†™æ—¶å¤åˆ¶ï¼ˆCOWï¼‰</strong>ï¼šå†™å…¥å…±äº«é¡µé¢æ—¶å¤åˆ¶</li>
<li><strong>éœ€æ±‚åˆ†é¡µï¼ˆDemand Pagingï¼‰</strong>ï¼šé¦–æ¬¡è®¿é—®æ—¶åˆ†é…</li>
</ol>
<h2 id="33">3.3 å†…å­˜åˆ†é…å™¨</h2>
<h3 id="331-slab">3.3.1 Slab åˆ†é…å™¨æ¶æ„</h3>
<p>Slab åˆ†é…å™¨æ˜¯å»ºç«‹åœ¨ä¼™ä¼´ç³»ç»Ÿä¹‹ä¸Šçš„é«˜æ•ˆå°å¯¹è±¡åˆ†é…å™¨ï¼Œè§£å†³äº†å†…éƒ¨ç¢ç‰‡é—®é¢˜ï¼š</p>
<div class="codehilite"><pre><span></span><code>Slab åˆ†é…å™¨å±‚æ¬¡ç»“æ„ï¼š

    kmem_cache (ç¼“å­˜æè¿°ç¬¦)
         |
    +----|----+----+

    +----|----+----+
    |    |    |    |

  slab slab slab slab  (æ¯ä¸ª slab åŒ…å«å¤šä¸ªå¯¹è±¡)
    |
  +---+---+---+---+
  |obj|obj|obj|obj|  (ç›¸åŒå¤§å°çš„å¯¹è±¡)
  +---+---+---+---+

ç‰¹ç‚¹ï¼š

<span class="k">-</span> å¯¹è±¡é‡ç”¨ï¼šé¿å…é¢‘ç¹åˆå§‹åŒ–/é”€æ¯
<span class="k">-</span> CPU ç¼“å­˜å‹å¥½ï¼šçƒ­å¯¹è±¡ä¿æŒåœ¨ç¼“å­˜ä¸­
<span class="k">-</span> å‡å°‘ç¢ç‰‡ï¼šç›¸åŒå¤§å°å¯¹è±¡èšé›†
<span class="k">-</span> ç€è‰²ä¼˜åŒ–ï¼šé¿å…ç¼“å­˜è¡Œå†²çª
</code></pre></div>

<p>æ ¸å¿ƒæ•°æ®ç»“æ„ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">kmem_cache</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kmem_cache_cpu</span><span class="w"> </span><span class="n">__percpu</span><span class="w"> </span><span class="o">*</span><span class="n">cpu_slab</span><span class="p">;</span><span class="w">  </span><span class="c1">// Per-CPU ç¼“å­˜</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span><span class="w">                       </span><span class="c1">// ç¼“å­˜æ ‡å¿—</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">min_partial</span><span class="p">;</span><span class="w">                  </span><span class="c1">// æœ€å°éƒ¨åˆ†ç©ºé—² slab æ•°</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w">                         </span><span class="c1">// å¯¹è±¡å¤§å°</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">object_size</span><span class="p">;</span><span class="w">                  </span><span class="c1">// ç”¨æˆ·è¯·æ±‚çš„å¤§å°</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span><span class="w">                       </span><span class="c1">// ç©ºé—²æŒ‡é’ˆåç§»</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kmem_cache_order_objects</span><span class="w"> </span><span class="n">oo</span><span class="p">;</span><span class="w">        </span><span class="c1">// slab å¤§å°å’Œå¯¹è±¡æ•°</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kmem_cache_order_objects</span><span class="w"> </span><span class="n">max</span><span class="p">;</span><span class="w">       </span><span class="c1">// æœ€å¤§ slab é…ç½®</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kmem_cache_order_objects</span><span class="w"> </span><span class="n">min</span><span class="p">;</span><span class="w">       </span><span class="c1">// æœ€å° slab é…ç½®</span>

<span class="w">    </span><span class="n">gfp_t</span><span class="w"> </span><span class="n">allocflags</span><span class="p">;</span><span class="w">                          </span><span class="c1">// åˆ†é…æ ‡å¿—</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">refcount</span><span class="p">;</span><span class="w">                              </span><span class="c1">// å¼•ç”¨è®¡æ•°</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">ctor</span><span class="p">)(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">);</span><span class="w">                      </span><span class="c1">// æ„é€ å‡½æ•°</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span><span class="w">                          </span><span class="c1">// ç¼“å­˜åç§°</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">list</span><span class="p">;</span><span class="w">                     </span><span class="c1">// å…¨å±€ç¼“å­˜é“¾è¡¨</span>

<span class="w">    </span><span class="c1">// SLUB ç‰¹æœ‰å­—æ®µ</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kmem_cache_node</span><span class="w"> </span><span class="o">*</span><span class="n">node</span><span class="p">[</span><span class="n">MAX_NUMNODES</span><span class="p">];</span><span class="w"> </span><span class="c1">// èŠ‚ç‚¹æ•°æ®</span>

<span class="cp">#ifdef CONFIG_SLAB_FREELIST_HARDENED</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">random</span><span class="p">;</span><span class="w">                      </span><span class="c1">// éšæœºåŒ–ç§å­ï¼ˆå®‰å…¨ï¼‰</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="c1">// Per-CPU slab ç¼“å­˜</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">kmem_cache_cpu</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="n">freelist</span><span class="p">;</span><span class="w">        </span><span class="c1">// æœ¬åœ°ç©ºé—²å¯¹è±¡é“¾è¡¨</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">tid</span><span class="p">;</span><span class="w">      </span><span class="c1">// äº‹åŠ¡ IDï¼ˆæ— é”æ“ä½œï¼‰</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="o">*</span><span class="n">page</span><span class="p">;</span><span class="w">      </span><span class="c1">// å½“å‰ slab é¡µ</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="o">*</span><span class="n">partial</span><span class="p">;</span><span class="w">   </span><span class="c1">// éƒ¨åˆ†ç©ºé—² slab é“¾è¡¨</span>
<span class="cp">#ifdef CONFIG_SLUB_STATS</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">stat</span><span class="p">[</span><span class="n">NR_SLUB_STAT_ITEMS</span><span class="p">];</span><span class="w">  </span><span class="c1">// ç»Ÿè®¡ä¿¡æ¯</span>
<span class="cp">#endif</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="332-slub">3.3.2 SLUB åˆ†é…å™¨ä¼˜åŒ–</h3>
<p>SLUB æ˜¯ Slab çš„ç®€åŒ–ç‰ˆæœ¬ï¼Œæˆä¸ºç°ä»£ Linux çš„é»˜è®¤åˆ†é…å™¨ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// SLUB åˆ†é…å¿«é€Ÿè·¯å¾„ï¼ˆæ— é”ï¼‰</span>
<span class="k">static</span><span class="w"> </span><span class="n">__always_inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">slab_alloc_node</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">kmem_cache</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">,</span>
<span class="w">        </span><span class="n">gfp_t</span><span class="w"> </span><span class="n">gfpflags</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">object</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kmem_cache_cpu</span><span class="w"> </span><span class="o">*</span><span class="n">c</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="o">*</span><span class="n">page</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">tid</span><span class="p">;</span>

<span class="nl">redo</span><span class="p">:</span>
<span class="w">    </span><span class="c1">// ç¦ç”¨æŠ¢å ï¼Œè·å– Per-CPU æ•°æ®</span>
<span class="w">    </span><span class="n">preempt_disable</span><span class="p">();</span>
<span class="w">    </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this_cpu_ptr</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">cpu_slab</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// äº‹åŠ¡å¼€å§‹</span>
<span class="w">    </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">READ_ONCE</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
<span class="w">    </span><span class="n">barrier</span><span class="p">();</span>

<span class="w">    </span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="o">-&gt;</span><span class="n">freelist</span><span class="p">;</span>
<span class="w">    </span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">object</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">node_match</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// æ…¢é€Ÿè·¯å¾„ï¼šéœ€è¦æ–°çš„ slab</span>
<span class="w">        </span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__slab_alloc</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">gfpflags</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// å¿«é€Ÿè·¯å¾„ï¼šä» freelist å–å¯¹è±¡</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">next_object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_freepointer</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">object</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// æ— é”æ›´æ–°ï¼ˆä½¿ç”¨ cmpxchgï¼‰</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">this_cpu_cmpxchg_double</span><span class="p">(</span>
<span class="w">                </span><span class="n">s</span><span class="o">-&gt;</span><span class="n">cpu_slab</span><span class="o">-&gt;</span><span class="n">freelist</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="o">-&gt;</span><span class="n">cpu_slab</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span>
<span class="w">                </span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="n">tid</span><span class="p">,</span>
<span class="w">                </span><span class="n">next_object</span><span class="p">,</span><span class="w"> </span><span class="n">next_tid</span><span class="p">(</span><span class="n">tid</span><span class="p">))))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">redo</span><span class="p">;</span><span class="w">  </span><span class="c1">// CAS å¤±è´¥ï¼Œé‡è¯•</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">stat</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">ALLOC_FASTPATH</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">preempt_enable</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">object</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>SLUB ä¸ SLAB çš„å¯¹æ¯”ï¼š</p>
<p>| ç‰¹æ€§ | SLAB | SLUB | SLOB |</p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>SLAB</th>
<th>SLUB</th>
<th>SLOB</th>
</tr>
</thead>
<tbody>
<tr>
<td>å¤æ‚åº¦</td>
<td>é«˜</td>
<td>ä¸­</td>
<td>ä½</td>
</tr>
<tr>
<td>å†…å­˜å¼€é”€</td>
<td>è¾ƒå¤§</td>
<td>ä¸­ç­‰</td>
<td>æœ€å°</td>
</tr>
<tr>
<td>Per-CPU ç¼“å­˜</td>
<td>å¤æ‚</td>
<td>ç®€å•</td>
<td>æ— </td>
</tr>
<tr>
<td>è°ƒè¯•æ”¯æŒ</td>
<td>æœ‰é™</td>
<td>ä¸°å¯Œ</td>
<td>åŸºæœ¬</td>
</tr>
<tr>
<td>é€‚ç”¨åœºæ™¯</td>
<td>å¤§å‹ç³»ç»Ÿ</td>
<td>é€šç”¨</td>
<td>åµŒå…¥å¼</td>
</tr>
<tr>
<td>ç¢ç‰‡æ§åˆ¶</td>
<td>æœ€å¥½</td>
<td>å¥½</td>
<td>ä¸€èˆ¬</td>
</tr>
</tbody>
</table>
<h3 id="333-kmalloc">3.3.3 kmalloc å’Œé€šç”¨ç¼“å­˜</h3>
<p>kmalloc æ˜¯å†…æ ¸æœ€å¸¸ç”¨çš„å†…å­˜åˆ†é…æ¥å£ï¼ŒåŸºäºé¢„å®šä¹‰çš„é€šç”¨ç¼“å­˜ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// é€šç”¨ç¼“å­˜å¤§å°ï¼ˆ2^n å­—èŠ‚ï¼‰</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">kmem_cache</span><span class="w"> </span><span class="o">*</span><span class="n">kmalloc_caches</span><span class="p">[</span><span class="n">KMALLOC_SHIFT_HIGH</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>

<span class="c1">// kmalloc å®ç°</span>
<span class="k">static</span><span class="w"> </span><span class="n">__always_inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">kmalloc</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">gfp_t</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__builtin_constant_p</span><span class="p">(</span><span class="n">size</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ç¼–è¯‘æ—¶å¸¸é‡å¤§å°ï¼Œä¼˜åŒ–è·¯å¾„</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">KMALLOC_MAX_CACHE_SIZE</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">kmalloc_large</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>

<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc_index</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">kmem_cache_alloc_trace</span><span class="p">(</span><span class="n">kmalloc_caches</span><span class="p">[</span><span class="n">index</span><span class="p">],</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">__kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// å¤§å°åˆ°ç´¢å¼•çš„æ˜ å°„</span>
<span class="k">static</span><span class="w"> </span><span class="n">__always_inline</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">kmalloc_index</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w">       </span><span class="c1">// kmalloc-8</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w">      </span><span class="c1">// kmalloc-16</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w">      </span><span class="c1">// kmalloc-32</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">64</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span><span class="w">      </span><span class="c1">// kmalloc-64</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">128</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span><span class="w">     </span><span class="c1">// kmalloc-128</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w">     </span><span class="c1">// kmalloc-256</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">512</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">9</span><span class="p">;</span><span class="w">     </span><span class="c1">// kmalloc-512</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1024</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w">   </span><span class="c1">// kmalloc-1024</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">2048</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">11</span><span class="p">;</span><span class="w">   </span><span class="c1">// kmalloc-2048</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">4096</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span><span class="w">   </span><span class="c1">// kmalloc-4096</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">8192</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">13</span><span class="p">;</span><span class="w">   </span><span class="c1">// kmalloc-8192</span>
<span class="w">    </span><span class="c1">// ... æ›´å¤§çš„å°ºå¯¸</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="334-vmalloc">3.3.4 vmalloc è™šæ‹Ÿè¿ç»­åˆ†é…</h3>
<p>vmalloc åˆ†é…è™šæ‹Ÿåœ°å€è¿ç»­ä½†ç‰©ç†ä¸è¿ç»­çš„å†…å­˜ï¼Œé€‚åˆå¤§å—åˆ†é…ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">vmalloc</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">__vmalloc_node</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_KERNEL</span><span class="p">,</span>
<span class="w">                         </span><span class="n">NUMA_NO_NODE</span><span class="p">,</span><span class="w"> </span><span class="n">__builtin_return_address</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">__vmalloc_area_node</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">area</span><span class="p">,</span><span class="w"> </span><span class="n">gfp_t</span><span class="w"> </span><span class="n">gfp_mask</span><span class="p">,</span>
<span class="w">                                 </span><span class="n">pgprot_t</span><span class="w"> </span><span class="n">prot</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_vm_area_size</span><span class="p">(</span><span class="n">area</span><span class="p">);</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nr_pages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">PAGE_SHIFT</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="o">**</span><span class="n">pages</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// åˆ†é…é¡µé¢æŒ‡é’ˆæ•°ç»„</span>
<span class="w">    </span><span class="n">pages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kvmalloc_array</span><span class="p">(</span><span class="n">nr_pages</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// åˆ†é…ç‰©ç†é¡µé¢</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nr_pages</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_page</span><span class="p">(</span><span class="n">gfp_mask</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">__GFP_HIGHMEM</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// å»ºç«‹é¡µè¡¨æ˜ å°„</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">map_vm_area</span><span class="p">(</span><span class="n">area</span><span class="p">,</span><span class="w"> </span><span class="n">prot</span><span class="p">,</span><span class="w"> </span><span class="n">pages</span><span class="p">))</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">area</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>vmalloc vs kmallocï¼š</p>
<div class="codehilite"><pre><span></span><code>kmalloc:

- ç‰©ç†è¿ç»­
- ç›´æ¥æ˜ å°„åŒº
- å¿«é€Ÿï¼ˆæ— éœ€ä¿®æ”¹é¡µè¡¨ï¼‰
- é€‚åˆå°åˆ†é…ï¼ˆ&lt;128KBï¼‰
- DMA å‹å¥½

vmalloc:

- ä»…è™šæ‹Ÿè¿ç»­
- vmalloc åŒºåŸŸ
- è¾ƒæ…¢ï¼ˆéœ€è¦ä¿®æ”¹é¡µè¡¨ï¼‰
- é€‚åˆå¤§åˆ†é…
- å¯èƒ½è·¨ NUMA èŠ‚ç‚¹
</code></pre></div>

<h3 id="335-per-cpu">3.3.5 Per-CPU å†…å­˜åˆ†é…</h3>
<p>Per-CPU å˜é‡é¿å…ç¼“å­˜ç«äº‰ï¼Œæé«˜å¤šæ ¸æ€§èƒ½ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// é™æ€ Per-CPU å˜é‡</span>
<span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">my_counter</span><span class="p">);</span>

<span class="c1">// åŠ¨æ€ Per-CPU åˆ†é…</span>
<span class="kt">void</span><span class="w"> </span><span class="n">__percpu</span><span class="w"> </span><span class="o">*</span><span class="nf">__alloc_percpu</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">align</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">pcpu_alloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">align</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Per-CPU å†…å­˜å¸ƒå±€</span>
<span class="cm">/*</span>

<span class="cm"> * CPU0: [---- unit 0 ----]</span>
<span class="cm"> * CPU1: [---- unit 1 ----]</span>
<span class="cm"> * CPU2: [---- unit 2 ----]</span>
<span class="cm"> * CPU3: [---- unit 3 ----]</span>
<span class="cm"> * </span>
<span class="cm"> * æ¯ä¸ª unit åŒ…å«ç›¸åŒçš„å˜é‡å‰¯æœ¬</span>
<span class="cm"> */</span>

<span class="c1">// è®¿é—® Per-CPU å˜é‡</span>
<span class="kt">int</span><span class="w"> </span><span class="n">cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_cpu</span><span class="p">();</span><span class="w">  </span><span class="c1">// ç¦ç”¨æŠ¢å </span>
<span class="n">per_cpu</span><span class="p">(</span><span class="n">my_counter</span><span class="p">,</span><span class="w"> </span><span class="n">cpu</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
<span class="n">put_cpu</span><span class="p">();</span><span class="w">  </span><span class="c1">// æ¢å¤æŠ¢å </span>

<span class="c1">// æˆ–ä½¿ç”¨ä¾¿æ·å®</span>
<span class="n">this_cpu_inc</span><span class="p">(</span><span class="n">my_counter</span><span class="p">);</span><span class="w">  </span><span class="c1">// åŸå­æ“ä½œï¼Œæ— éœ€ç¦ç”¨æŠ¢å </span>
</code></pre></div>

<h2 id="34">3.4 å†…å­˜å›æ”¶æœºåˆ¶</h2>
<h3 id="341-lru">3.4.1 LRU ç®—æ³•å®ç°</h3>
<p>Linux ä½¿ç”¨è¿‘ä¼¼ LRUï¼ˆLeast Recently Usedï¼‰ç®—æ³•ç®¡ç†é¡µé¢å›æ”¶ï¼š</p>
<div class="codehilite"><pre><span></span><code>LRU é“¾è¡¨ç»„ç»‡ï¼š

         æ´»è·ƒé“¾è¡¨                    éæ´»è·ƒé“¾è¡¨
    (Active LRU Lists)          (Inactive LRU Lists)

    +-------------+              +-------------+
    | Active Anon |              |Inactive Anon|
    | (åŒ¿åé¡µé¢)   |              | (åŒ¿åé¡µé¢)   |
    +-------------+              +-------------+
         |                            |
    é¢‘ç¹è®¿é—®çš„                    è¾ƒå°‘è®¿é—®çš„
    è¿›ç¨‹å†…å­˜é¡µ                    è¿›ç¨‹å†…å­˜é¡µ

    +-------------+              +-------------+
    | Active File |              |Inactive File|
    | (æ–‡ä»¶é¡µé¢)   |              | (æ–‡ä»¶é¡µé¢)   |
    +-------------+              +-------------+
         |                            |
    çƒ­ç‚¹æ–‡ä»¶ç¼“å­˜                  å†·æ–‡ä»¶ç¼“å­˜
</code></pre></div>

<p>LRU é“¾è¡¨ç®¡ç†ç»“æ„ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">lruvec</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">lists</span><span class="p">[</span><span class="n">NR_LRU_LISTS</span><span class="p">];</span><span class="w">  </span><span class="c1">// LRU é“¾è¡¨æ•°ç»„</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">zone_reclaim_stat</span><span class="w"> </span><span class="n">reclaim_stat</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// LRU é“¾è¡¨ç±»å‹</span>
<span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="n">lru_list</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">LRU_INACTIVE_ANON</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LRU_BASE</span><span class="p">,</span><span class="w">      </span><span class="c1">// éæ´»è·ƒåŒ¿åé¡µ</span>
<span class="w">        </span><span class="n">LRU_ACTIVE_ANON</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LRU_BASE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">LRU_ACTIVE</span><span class="p">,</span><span class="w">    </span><span class="c1">// æ´»è·ƒåŒ¿åé¡µ</span>
<span class="w">        </span><span class="n">LRU_INACTIVE_FILE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LRU_BASE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">LRU_FILE</span><span class="p">,</span><span class="w">    </span><span class="c1">// éæ´»è·ƒæ–‡ä»¶é¡µ</span>
<span class="w">        </span><span class="n">LRU_ACTIVE_FILE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LRU_BASE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">LRU_FILE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">LRU_ACTIVE</span><span class="p">,</span><span class="w">  </span><span class="c1">// æ´»è·ƒæ–‡ä»¶é¡µ</span>
<span class="w">        </span><span class="n">LRU_UNEVICTABLE</span><span class="p">,</span><span class="w">                    </span><span class="c1">// ä¸å¯å›æ”¶é¡µ</span>
<span class="w">        </span><span class="n">NR_LRU_LISTS</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">atomic_long_t</span><span class="w"> </span><span class="n">nr_zone_inactive_anon</span><span class="p">;</span>
<span class="w">    </span><span class="n">atomic_long_t</span><span class="w"> </span><span class="n">nr_zone_active_anon</span><span class="p">;</span>
<span class="w">    </span><span class="n">atomic_long_t</span><span class="w"> </span><span class="n">nr_zone_inactive_file</span><span class="p">;</span>
<span class="w">    </span><span class="n">atomic_long_t</span><span class="w"> </span><span class="n">nr_zone_active_file</span><span class="p">;</span>
<span class="w">    </span><span class="n">atomic_long_t</span><span class="w"> </span><span class="n">nr_zone_unevictable</span><span class="p">;</span>

<span class="w">    </span><span class="n">spinlock_t</span><span class="w"> </span><span class="n">lru_lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// é¡µé¢åœ¨ LRU é“¾è¡¨é—´çš„ç§»åŠ¨</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">activate_page</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="o">*</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">PageLRU</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">PageActive</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">PageUnevictable</span><span class="p">(</span><span class="n">page</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">lruvec</span><span class="w"> </span><span class="o">*</span><span class="n">lruvec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mem_cgroup_page_lruvec</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

<span class="w">        </span><span class="n">del_page_from_lru_list</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="n">lruvec</span><span class="p">,</span><span class="w"> </span><span class="n">page_lru</span><span class="p">(</span><span class="n">page</span><span class="p">));</span>
<span class="w">        </span><span class="n">SetPageActive</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
<span class="w">        </span><span class="n">add_page_to_lru_list</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="n">lruvec</span><span class="p">,</span><span class="w"> </span><span class="n">page_lru</span><span class="p">(</span><span class="n">page</span><span class="p">));</span>

<span class="w">        </span><span class="n">__count_vm_event</span><span class="p">(</span><span class="n">PGACTIVATE</span><span class="p">);</span>
<span class="w">        </span><span class="n">update_page_reclaim_stat</span><span class="p">(</span><span class="n">lruvec</span><span class="p">,</span><span class="w"> </span><span class="n">page</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="342">3.4.2 é¡µé¢å›æ”¶æµç¨‹</h3>
<p>å†…å­˜å‹åŠ›è§¦å‘é¡µé¢å›æ”¶ï¼Œkswapd å®ˆæŠ¤è¿›ç¨‹è´Ÿè´£åå°å›æ”¶ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// kswapd ä¸»å¾ªç¯</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">kswapd</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">pg_data_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">pg_data_t</span><span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">tsk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="p">;</span>

<span class="w">    </span><span class="n">set_freezable</span><span class="p">();</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// ç­‰å¾…å†…å­˜å‹åŠ›äº‹ä»¶</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">try_to_freeze</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kthread_should_stop</span><span class="p">())</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// æ£€æŸ¥æ°´ä½çº¿</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prepare_kswapd_sleep</span><span class="p">(</span><span class="n">pgdat</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p">,</span><span class="w"> </span><span class="n">classzone_idx</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// ç¡çœ ç­‰å¾…å”¤é†’</span>
<span class="w">            </span><span class="n">schedule</span><span class="p">();</span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// æ‰§è¡Œé¡µé¢å›æ”¶</span>
<span class="w">        </span><span class="n">balance_pgdat</span><span class="p">(</span><span class="n">pgdat</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p">,</span><span class="w"> </span><span class="n">classzone_idx</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// é¡µé¢å›æ”¶æ ¸å¿ƒå‡½æ•°</span>
<span class="k">static</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">shrink_node</span><span class="p">(</span><span class="n">pg_data_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdat</span><span class="p">,</span>
<span class="w">                                 </span><span class="k">struct</span><span class="w"> </span><span class="nc">scan_control</span><span class="w"> </span><span class="o">*</span><span class="n">sc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lruvec</span><span class="w"> </span><span class="o">*</span><span class="n">lruvec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node_lruvec</span><span class="p">(</span><span class="n">pgdat</span><span class="p">);</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">nr_reclaimed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// æ‰«ææ§åˆ¶å‚æ•°</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">scan_control</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">nr_to_reclaim</span><span class="p">;</span><span class="w">   </span><span class="c1">// ç›®æ ‡å›æ”¶é¡µæ•°</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">nr_scanned</span><span class="p">;</span><span class="w">      </span><span class="c1">// å·²æ‰«æé¡µæ•°</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">priority</span><span class="p">;</span><span class="w">         </span><span class="c1">// æ‰«æä¼˜å…ˆçº§ï¼ˆ0-12ï¼‰</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">may_writepage</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span><span class="w">  </span><span class="c1">// æ˜¯å¦å¯å†™å›è„é¡µ</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">may_unmap</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span><span class="w">      </span><span class="c1">// æ˜¯å¦å¯è§£é™¤æ˜ å°„</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">may_swap</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span><span class="w">       </span><span class="c1">// æ˜¯å¦å¯æ¢å‡º</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">hibernation_mode</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// 1. å›æ”¶æ–‡ä»¶é¡µç¼“å­˜</span>
<span class="w">    </span><span class="n">nr_reclaimed</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">shrink_list</span><span class="p">(</span><span class="n">LRU_INACTIVE_FILE</span><span class="p">,</span><span class="w"> </span><span class="n">nr_to_scan</span><span class="p">,</span>
<span class="w">                                </span><span class="n">lruvec</span><span class="p">,</span><span class="w"> </span><span class="n">sc</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 2. å›æ”¶åŒ¿åé¡µï¼ˆéœ€è¦ swapï¼‰</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">may_swap</span><span class="p">)</span>
<span class="w">        </span><span class="n">nr_reclaimed</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">shrink_list</span><span class="p">(</span><span class="n">LRU_INACTIVE_ANON</span><span class="p">,</span><span class="w"> </span><span class="n">nr_to_scan</span><span class="p">,</span>
<span class="w">                                   </span><span class="n">lruvec</span><span class="p">,</span><span class="w"> </span><span class="n">sc</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 3. å›æ”¶ slab ç¼“å­˜</span>
<span class="w">    </span><span class="n">nr_reclaimed</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">shrink_slab</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">gfp_mask</span><span class="p">,</span><span class="w"> </span><span class="n">pgdat</span><span class="o">-&gt;</span><span class="n">node_id</span><span class="p">,</span>
<span class="w">                               </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">nr_reclaimed</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>æ°´ä½çº¿æœºåˆ¶ï¼š</p>
<div class="codehilite"><pre><span></span><code>å†…å­˜æ°´ä½çº¿ï¼ˆWatermarksï¼‰ï¼š

é¡µé¢æ•° ^
      |
      |............... high (å¼€å§‹åå°å›æ”¶)
      |
      |............... low  (å”¤é†’ kswapd)
      |
      |............... min  (ç›´æ¥å›æ”¶ï¼Œå¯èƒ½ OOM)
      |___________________________
                                æ—¶é—´ -&gt;

è®¡ç®—å…¬å¼ï¼š
min = (å†…å­˜å¤§å° * æ¯”ä¾‹) / 10000
low = min + (min / 4)
high = min + (min / 2)
</code></pre></div>

<h3 id="343">3.4.3 ç›´æ¥å›æ”¶ä¸å›å†™</h3>
<p>å½“å†…å­˜åˆ†é…å¤±è´¥æ—¶ï¼Œè¿›ç¨‹ç›´æ¥å‚ä¸é¡µé¢å›æ”¶ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ç›´æ¥å›æ”¶è·¯å¾„</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">__perform_reclaim</span><span class="p">(</span><span class="n">gfp_t</span><span class="w"> </span><span class="n">gfp_mask</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">order</span><span class="p">,</span>
<span class="w">                            </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">alloc_context</span><span class="w"> </span><span class="o">*</span><span class="n">ac</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">reclaim_state</span><span class="w"> </span><span class="n">reclaim_state</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">progress</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">noreclaim_flag</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// é¿å…é€’å½’å›æ”¶</span>
<span class="w">    </span><span class="n">noreclaim_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memalloc_noreclaim_save</span><span class="p">();</span>
<span class="w">    </span><span class="n">reclaim_state</span><span class="p">.</span><span class="n">reclaimed_slab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">reclaim_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">reclaim_state</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// æ‰§è¡Œç›´æ¥å›æ”¶</span>
<span class="w">    </span><span class="n">progress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">try_to_free_pages</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">zonelist</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p">,</span><span class="w"> </span><span class="n">gfp_mask</span><span class="p">,</span>
<span class="w">                                 </span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">nodemask</span><span class="p">);</span>

<span class="w">    </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">reclaim_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="n">memalloc_noreclaim_restore</span><span class="p">(</span><span class="n">noreclaim_flag</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">progress</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// é¡µé¢å›å†™æœºåˆ¶</span>
<span class="k">static</span><span class="w"> </span><span class="n">pageout_t</span><span class="w"> </span><span class="nf">pageout</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="o">*</span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">address_space</span><span class="w"> </span><span class="o">*</span><span class="n">mapping</span><span class="p">,</span>
<span class="w">                         </span><span class="k">struct</span><span class="w"> </span><span class="nc">scan_control</span><span class="w"> </span><span class="o">*</span><span class="n">sc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// æ£€æŸ¥é¡µé¢æ˜¯å¦è„</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">PageDirty</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">PAGE_CLEAN</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// æ£€æŸ¥æ˜¯å¦å…è®¸å†™å›</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">may_writepage</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">PAGE_KEEP</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// æ­£åœ¨å›å†™ä¸­</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">PageWriteback</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">PAGE_KEEP</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// è§¦å‘å¼‚æ­¥å›å†™</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">a_ops</span><span class="o">-&gt;</span><span class="n">writepage</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">PAGE_ACTIVATE</span><span class="p">;</span>

<span class="w">    </span><span class="n">SetPageReclaim</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">a_ops</span><span class="o">-&gt;</span><span class="n">writepage</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">wbc</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="344-oom-killer">3.4.4 OOM Killer æœºåˆ¶</h3>
<p>å½“å†…å­˜å›æ”¶æ— æ³•æ»¡è¶³åˆ†é…éœ€æ±‚æ—¶ï¼ŒOOM Killer é€‰æ‹©è¿›ç¨‹ç»ˆæ­¢ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// OOM è¯„åˆ†ç®—æ³•</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">oom_badness</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="w"> </span>
<span class="w">                         </span><span class="k">struct</span><span class="w"> </span><span class="nc">mem_cgroup</span><span class="w"> </span><span class="o">*</span><span class="n">memcg</span><span class="p">,</span>
<span class="w">                         </span><span class="k">const</span><span class="w"> </span><span class="n">nodemask_t</span><span class="w"> </span><span class="o">*</span><span class="n">nodemask</span><span class="p">,</span>
<span class="w">                         </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">totalpages</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">points</span><span class="p">;</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">adj</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// è·å–è¿›ç¨‹å†…å­˜ä½¿ç”¨é‡</span>
<span class="w">    </span><span class="n">points</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_mm_rss</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">get_mm_counter</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">MM_SWAPENTS</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">            </span><span class="n">mm_pgtables_bytes</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">PAGE_SIZE</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// è€ƒè™‘ oom_score_adj è°ƒæ•´å€¼</span>
<span class="w">    </span><span class="n">adj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">signal</span><span class="o">-&gt;</span><span class="n">oom_score_adj</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">adj</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OOM_SCORE_ADJ_MIN</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// -1000 è¡¨ç¤ºæ°¸ä¸æ€æ­»</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// è®¡ç®—æœ€ç»ˆåˆ†æ•°ï¼ˆ0-1000ï¼‰</span>
<span class="w">    </span><span class="n">adj</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">totalpages</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span>
<span class="w">    </span><span class="n">points</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">adj</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// ç‰¹æ®Šè¿›ç¨‹ä¿æŠ¤</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">has_capability_noaudit</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
<span class="w">        </span><span class="n">points</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="p">(</span><span class="n">points</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w">  </span><span class="c1">// root è¿›ç¨‹é™ä½ 3%</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">points</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">points</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// OOM Killer é€‰æ‹©å—å®³è€…</span>
<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">select_bad_process</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">oom_control</span><span class="w"> </span><span class="o">*</span><span class="n">oc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">chosen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">chosen_points</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="n">for_each_process</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">points</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// è·³è¿‡ä¸å¯æ€æ­»çš„è¿›ç¨‹</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oom_unkillable_task</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">oc</span><span class="o">-&gt;</span><span class="n">nodemask</span><span class="p">))</span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// è®¡ç®— badness åˆ†æ•°</span>
<span class="w">        </span><span class="n">points</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oom_badness</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">oc</span><span class="o">-&gt;</span><span class="n">nodemask</span><span class="p">,</span><span class="w"> </span><span class="n">oc</span><span class="o">-&gt;</span><span class="n">totalpages</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">points</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">points</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">chosen_points</span><span class="p">)</span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span>

<span class="w">        </span><span class="n">chosen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
<span class="w">        </span><span class="n">chosen_points</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">points</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">chosen</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// æ‰§è¡Œ OOM Kill</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">oom_kill_process</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">oom_control</span><span class="w"> </span><span class="o">*</span><span class="n">oc</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">victim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oc</span><span class="o">-&gt;</span><span class="n">chosen</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// æ‰“å° OOM ä¿¡æ¯</span>
<span class="w">    </span><span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Kill process %d (%s) score %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">           </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">task_pid_nr</span><span class="p">(</span><span class="n">victim</span><span class="p">),</span><span class="w"> </span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span>
<span class="w">           </span><span class="n">oom_badness</span><span class="p">(</span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">oc</span><span class="o">-&gt;</span><span class="n">nodemask</span><span class="p">,</span><span class="w"> </span><span class="n">oc</span><span class="o">-&gt;</span><span class="n">totalpages</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// å‘é€ SIGKILL</span>
<span class="w">    </span><span class="n">do_send_sig_info</span><span class="p">(</span><span class="n">SIGKILL</span><span class="p">,</span><span class="w"> </span><span class="n">SEND_SIG_PRIV</span><span class="p">,</span><span class="w"> </span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">PIDTYPE_PID</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// æ ‡è®°ä¸º OOM å—å®³è€…</span>
<span class="w">    </span><span class="n">mark_oom_victim</span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// å°è¯•å›æ”¶å†…å­˜</span>
<span class="w">    </span><span class="n">try_oom_reaper</span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="345">3.4.5 å†…å­˜å‹ç¼©ä¸å»ç¢ç‰‡åŒ–</h3>
<p>å†…å­˜å‹ç¼©é€šè¿‡ç§»åŠ¨é¡µé¢æ¥åˆ›å»ºè¿ç»­ç©ºé—²å†…å­˜ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// å†…å­˜å‹ç¼©ç®—æ³•</span>
<span class="k">static</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">compact_zone</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">zone</span><span class="w"> </span><span class="o">*</span><span class="n">zone</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                  </span><span class="k">struct</span><span class="w"> </span><span class="nc">compact_control</span><span class="w"> </span><span class="o">*</span><span class="n">cc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">migrate_pfn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">migrate_pfn</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">free_pfn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">free_pfn</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// æ‰«æå¯ç§»åŠ¨é¡µé¢ï¼ˆä»ä½åœ°å€å‘é«˜åœ°å€ï¼‰</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">migrate_pfn</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">free_pfn</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// éš”ç¦»å¯ç§»åŠ¨é¡µé¢</span>
<span class="w">        </span><span class="n">nr_isolated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isolate_migratepages</span><span class="p">(</span><span class="n">zone</span><span class="p">,</span><span class="w"> </span><span class="n">cc</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">nr_isolated</span><span class="p">)</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// è¿ç§»é¡µé¢åˆ°ç©ºé—²ä½ç½®</span>
<span class="w">        </span><span class="n">migrate_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">migratepages</span><span class="p">,</span><span class="w"> </span><span class="n">compaction_alloc</span><span class="p">,</span>
<span class="w">                     </span><span class="n">compaction_free</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">cc</span><span class="p">,</span>
<span class="w">                     </span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="n">MR_COMPACTION</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">COMPACT_COMPLETE</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// é¡µé¢è¿ç§»ç±»å‹ç®¡ç†</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">set_pageblock_migratetype</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="o">*</span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">migratetype</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">page_group_by_mobility_disabled</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">                </span><span class="n">migratetype</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MIGRATE_PCPTYPES</span><span class="p">))</span>
<span class="w">        </span><span class="n">migratetype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MIGRATE_UNMOVABLE</span><span class="p">;</span>

<span class="w">    </span><span class="n">set_pageblock_flags_group</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">migratetype</span><span class="p">,</span>
<span class="w">                             </span><span class="n">PB_migrate</span><span class="p">,</span><span class="w"> </span><span class="n">PB_migrate_end</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="35">3.5 æœ¬ç« å°ç»“</h2>
<p>Linux å†…å­˜ç®¡ç†æ˜¯ä¸€ä¸ªå¤æ‚è€Œç²¾å¦™çš„ç³»ç»Ÿï¼Œé€šè¿‡å¤šå±‚æ¬¡çš„æŠ½è±¡å’Œä¼˜åŒ–å®ç°äº†é«˜æ•ˆçš„å†…å­˜åˆ©ç”¨ï¼š</p>
<h3 id="_2">æ ¸å¿ƒæ¦‚å¿µå›é¡¾</h3>
<ol>
<li>
<p><strong>ç‰©ç†å†…å­˜ç®¡ç†å±‚æ¬¡</strong>ï¼š
   - NUMA èŠ‚ç‚¹ â†’ å†…å­˜åŒºåŸŸï¼ˆZoneï¼‰â†’ é¡µæ¡†ï¼ˆPageï¼‰
   - ä¼™ä¼´ç³»ç»Ÿè§£å†³å¤–éƒ¨ç¢ç‰‡ï¼Œæ”¯æŒå¤§å—è¿ç»­åˆ†é…
   - struct page æ˜¯ç‰©ç†é¡µé¢ç®¡ç†çš„æ ¸å¿ƒæ•°æ®ç»“æ„</p>
</li>
<li>
<p><strong>è™šæ‹Ÿå†…å­˜æœºåˆ¶</strong>ï¼š
   - å¤šçº§é¡µè¡¨å®ç°è™šæ‹Ÿåˆ°ç‰©ç†åœ°å€æ˜ å°„
   - VMA ç®¡ç†è¿›ç¨‹åœ°å€ç©ºé—´çš„ä¸åŒåŒºåŸŸ
   - TLB ç¼“å­˜åŠ é€Ÿåœ°å€è½¬æ¢
   - ç¼ºé¡µå¼‚å¸¸å®ç°æŒ‰éœ€åˆ†é…</p>
</li>
<li>
<p><strong>å†…å­˜åˆ†é…å™¨</strong>ï¼š
   - Slab/SLUBï¼šé«˜æ•ˆçš„å°å¯¹è±¡åˆ†é…ï¼Œå‡å°‘å†…éƒ¨ç¢ç‰‡
   - kmallocï¼šé€šç”¨å†…æ ¸å†…å­˜åˆ†é…æ¥å£
   - vmallocï¼šè™šæ‹Ÿè¿ç»­çš„å¤§å—å†…å­˜åˆ†é…
   - Per-CPU åˆ†é…ï¼šé¿å…ç¼“å­˜ç«äº‰</p>
</li>
<li>
<p><strong>å†…å­˜å›æ”¶æœºåˆ¶</strong>ï¼š
   - LRU ç®—æ³•ç®¡ç†é¡µé¢è€åŒ–
   - kswapd åå°å›æ”¶ä¸ç›´æ¥å›æ”¶
   - OOM Killer ä½œä¸ºæœ€åæ‰‹æ®µ
   - å†…å­˜å‹ç¼©åˆ›å»ºè¿ç»­ç©ºé—²ç©ºé—´</p>
</li>
</ol>
<h3 id="_3">å…³é”®å…¬å¼</h3>
<ol>
<li>
<p><strong>é¡µè¡¨ç´¢å¼•è®¡ç®—</strong>ï¼š
   $$\text{PGD_index} = \frac{\text{VA} \gg 39}{512} \bmod 512$$
   $$\text{ç‰©ç†åœ°å€} = \text{PFN} \times 4096 + \text{offset}$$</p>
</li>
<li>
<p><strong>ä¼™ä¼´ç³»ç»Ÿå—å¤§å°</strong>ï¼š
$$\text{å—å¤§å°} = 2^{\text{order}} \times \text{PAGE_SIZE}$$</p>
</li>
<li>
<p><strong>OOM è¯„åˆ†</strong>ï¼š
$$\text{score} = \frac{\text{RSS} + \text{Swap}}{\text{Total}} \times 1000 + \text{oom_score_adj}$$</p>
</li>
<li>
<p><strong>æ°´ä½çº¿è®¡ç®—</strong>ï¼š
$$\text{min} = \frac{\text{zone_pages} \times \text{min_free_kbytes}}{10000}$$
   $$\text{low} = \text{min} \times 1.25, \quad \text{high} = \text{min} \times 1.5$$</p>
</li>
</ol>
<h2 id="36">3.6 ç»ƒä¹ é¢˜</h2>
<h3 id="_4">åŸºç¡€ç†è§£é¢˜</h3>
<p><strong>é¢˜ç›® 1</strong>ï¼šè§£é‡Šä¸ºä»€ä¹ˆ Linux ä½¿ç”¨å¤šçº§é¡µè¡¨è€Œä¸æ˜¯å•çº§é¡µè¡¨ï¼Ÿè®¡ç®— 48 ä½è™šæ‹Ÿåœ°å€ç©ºé—´ä½¿ç”¨å•çº§é¡µè¡¨éœ€è¦å¤šå°‘å†…å­˜ã€‚</p>
<details>
<summary>æç¤ºï¼šè€ƒè™‘é¡µè¡¨é¡¹å¤§å°å’Œè™šæ‹Ÿåœ°å€ç©ºé—´å¤§å°</summary>
<p>è®¡ç®—å•çº§é¡µè¡¨çš„å†…å­˜éœ€æ±‚ï¼Œå¹¶ä¸å¤šçº§é¡µè¡¨çš„æŒ‰éœ€åˆ†é…ç‰¹æ€§å¯¹æ¯”ã€‚</p>
</details>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p>å•çº§é¡µè¡¨éœ€è¦ä¸ºæ•´ä¸ªè™šæ‹Ÿåœ°å€ç©ºé—´é¢„åˆ†é…é¡µè¡¨é¡¹ï¼š</p>
<ul>
<li>48ä½åœ°å€ç©ºé—´ = 2^48 å­—èŠ‚ = 256TB</li>
<li>4KBé¡µé¢ = 2^12 å­—èŠ‚</li>
<li>éœ€è¦é¡µè¡¨é¡¹æ•° = 2^48 / 2^12 = 2^36 ä¸ª</li>
<li>æ¯ä¸ªPTE 8å­—èŠ‚ï¼Œæ€»éœ€æ±‚ = 2^36 Ã— 8 = 512GB</li>
</ul>
<p>å¤šçº§é¡µè¡¨ä¼˜åŠ¿ï¼š</p>
<ol>
<li>æŒ‰éœ€åˆ†é…ï¼šåªä¸ºå®é™…ä½¿ç”¨çš„è™šæ‹Ÿåœ°å€åˆ›å»ºé¡µè¡¨</li>
<li>ç¨€ç–åœ°å€ç©ºé—´é«˜æ•ˆï¼šå¤§éƒ¨åˆ†è¿›ç¨‹åªä½¿ç”¨å¾ˆå°éƒ¨åˆ†åœ°å€ç©ºé—´</li>
<li>å…±äº«é¡µè¡¨ï¼šå†…æ ¸é¡µè¡¨å¯åœ¨è¿›ç¨‹é—´å…±äº«</li>
<li>ç¼“å­˜å‹å¥½ï¼šæ´»è·ƒé¡µè¡¨é¡¹é›†ä¸­ï¼Œæé«˜TLBå‘½ä¸­ç‡</li>
</ol>
</details>
<p><strong>é¢˜ç›® 2</strong>ï¼šä¼™ä¼´ç³»ç»Ÿä¸­ï¼Œå¦‚æœè¯·æ±‚åˆ†é… 5 ä¸ªé¡µé¢ï¼Œç³»ç»Ÿä¼šå¦‚ä½•å¤„ç†ï¼Ÿè¯´æ˜åˆ†é…è¿‡ç¨‹å’Œå†…éƒ¨ç¢ç‰‡ã€‚</p>
<details>
<summary>æç¤ºï¼šä¼™ä¼´ç³»ç»Ÿåªèƒ½åˆ†é… 2^n å¤§å°çš„å—</summary>
<p>è€ƒè™‘å‘ä¸Šå–æ•´åˆ°æœ€è¿‘çš„ 2 çš„å¹‚æ¬¡ï¼Œä»¥åŠäº§ç”Ÿçš„å†…éƒ¨ç¢ç‰‡ã€‚</p>
</details>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p>åˆ†é…è¿‡ç¨‹ï¼š</p>
<ol>
<li>5é¡µé¢å‘ä¸Šå–æ•´åˆ° 2^3 = 8 é¡µé¢</li>
<li>æŸ¥æ‰¾ order=3 çš„ç©ºé—²å—</li>
<li>å¦‚æœæ²¡æœ‰ï¼Œå‘æ›´é«˜ order è¯·æ±‚å¹¶åˆ†è£‚</li>
<li>è¿”å› 8 é¡µé¢çš„å—ç»™è¯·æ±‚è€…</li>
</ol>
<p>å†…éƒ¨ç¢ç‰‡ï¼š</p>
<ul>
<li>è¯·æ±‚ï¼š5 Ã— 4KB = 20KB</li>
<li>å®é™…åˆ†é…ï¼š8 Ã— 4KB = 32KB</li>
<li>å†…éƒ¨ç¢ç‰‡ï¼š12KB (37.5%)</li>
<li>è¿™æ˜¯ä¼™ä¼´ç³»ç»Ÿç®€å•é«˜æ•ˆçš„ä»£ä»·</li>
</ul>
</details>
<h3 id="_5">ä»£ç åˆ†æé¢˜</h3>
<p><strong>é¢˜ç›® 3</strong>ï¼šåˆ†æä»¥ä¸‹ä»£ç ç‰‡æ®µï¼Œè§£é‡Šå®ƒåœ¨å†…å­˜ç®¡ç†ä¸­çš„ä½œç”¨ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="o">*</span><span class="n">alloc_pages</span><span class="p">(</span><span class="n">gfp_t</span><span class="w"> </span><span class="n">gfp_mask</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">order</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">alloc_pages_current</span><span class="p">(</span><span class="n">gfp_mask</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define alloc_page(gfp_mask) alloc_pages(gfp_mask, 0)</span>
<span class="cp">#define __get_free_page(gfp_mask) \</span>
<span class="cp">    __get_free_pages((gfp_mask), 0)</span>
</code></pre></div>

<details>
<summary>æç¤ºï¼šæ³¨æ„ order å‚æ•°å’Œå®å®šä¹‰çš„ä½œç”¨</summary>
<p>è¿™äº›æ˜¯é¡µé¢åˆ†é…çš„ä¸åŒæ¥å£ï¼Œæä¾›ä¸åŒçº§åˆ«çš„æŠ½è±¡ã€‚</p>
</details>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p>ä»£ç ä½œç”¨ï¼š</p>
<ol>
<li><code>alloc_pages()</code>: æ ¸å¿ƒé¡µé¢åˆ†é…å‡½æ•°ï¼Œåˆ†é… 2^order ä¸ªè¿ç»­é¡µé¢</li>
<li><code>alloc_page()</code>: åˆ†é…å•ä¸ªé¡µé¢çš„ä¾¿æ·å®ï¼ˆorder=0ï¼‰</li>
<li><code>__get_free_page()</code>: åˆ†é…å•é¡µå¹¶è¿”å›è™šæ‹Ÿåœ°å€è€Œé struct page</li>
</ol>
<p>è®¾è®¡ç†å¿µï¼š</p>
<ul>
<li>æä¾›å¤šå±‚æ¬¡ API æ»¡è¶³ä¸åŒéœ€æ±‚</li>
<li>alloc_pages è¿”å› struct page*ï¼Œé€‚åˆéœ€è¦é¡µé¢å…ƒæ•°æ®çš„åœºæ™¯</li>
<li>__get_free_page è¿”å›åœ°å€ï¼Œé€‚åˆç›´æ¥ä½¿ç”¨å†…å­˜çš„åœºæ™¯</li>
<li>å®å®šä¹‰é¿å…å‡½æ•°è°ƒç”¨å¼€é”€</li>
</ul>
</details>
<p><strong>é¢˜ç›® 4</strong>ï¼šä»¥ä¸‹ SLUB å¿«é€Ÿè·¯å¾„ä»£ç ä½¿ç”¨äº†ä»€ä¹ˆä¼˜åŒ–æŠ€æœ¯ï¼Ÿä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ</p>
<div class="codehilite"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">this_cpu_cmpxchg_double</span><span class="p">(</span>
<span class="w">        </span><span class="n">s</span><span class="o">-&gt;</span><span class="n">cpu_slab</span><span class="o">-&gt;</span><span class="n">freelist</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="o">-&gt;</span><span class="n">cpu_slab</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span>
<span class="w">        </span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="n">tid</span><span class="p">,</span>
<span class="w">        </span><span class="n">next_object</span><span class="p">,</span><span class="w"> </span><span class="n">next_tid</span><span class="p">(</span><span class="n">tid</span><span class="p">))))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">redo</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<details>
<summary>æç¤ºï¼šæ³¨æ„ cmpxchg å’Œ Per-CPU å˜é‡çš„ä½¿ç”¨</summary>
<p>è¿™æ˜¯æ— é”ç¼–ç¨‹æŠ€æœ¯ï¼Œä½¿ç”¨ CAS æ“ä½œå®ç°åŸå­æ›´æ–°ã€‚</p>
</details>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p>ä¼˜åŒ–æŠ€æœ¯ï¼š</p>
<ol>
<li><strong>æ— é”ç®—æ³•</strong>ï¼šä½¿ç”¨ CASï¼ˆCompare-And-Swapï¼‰é¿å…é”å¼€é”€</li>
<li><strong>Per-CPU ç¼“å­˜</strong>ï¼šæ¯ä¸ª CPU ç‹¬ç«‹çš„ freelistï¼Œé¿å…ç¼“å­˜ç«äº‰</li>
<li><strong>äº‹åŠ¡ ID (tid)</strong>ï¼šæ£€æµ‹å¹¶å‘ä¿®æ”¹ï¼Œç¡®ä¿ä¸€è‡´æ€§</li>
<li><strong>åŒå­— CAS</strong>ï¼šåŸå­æ›´æ–° freelist å’Œ tid</li>
</ol>
<p>è®¾è®¡åŸå› ï¼š</p>
<ul>
<li>å†…å­˜åˆ†é…æ˜¯é«˜é¢‘æ“ä½œï¼Œé”ä¼šæˆä¸ºç“¶é¢ˆ</li>
<li>Per-CPU è®¾è®¡åˆ©ç”¨äº† CPU ç¼“å­˜å±€éƒ¨æ€§</li>
<li>å¤±è´¥é‡è¯•æ¯”ç­‰å¾…é”æ›´é«˜æ•ˆï¼ˆä¹è§‚å¹¶å‘ï¼‰</li>
<li>é€‚åˆåˆ†é…é¢‘ç¹ä½†ç«äº‰è¾ƒå°‘çš„åœºæ™¯</li>
</ul>
</details>
<h3 id="_6">è®¾è®¡å®ç°é¢˜</h3>
<p><strong>é¢˜ç›® 5</strong>ï¼šè®¾è®¡ä¸€ä¸ªç®€åŒ–çš„ Slab åˆ†é…å™¨ï¼Œæ”¯æŒå›ºå®šå¤§å°å¯¹è±¡çš„åˆ†é…å’Œé‡Šæ”¾ã€‚è¦æ±‚ï¼š</p>
<ul>
<li>æ”¯æŒå¯¹è±¡ç¼“å­˜å’Œé‡ç”¨</li>
<li>å®ç°ç®€å•çš„ Per-CPU ç¼“å­˜</li>
<li>è€ƒè™‘å†…å­˜å¯¹é½</li>
</ul>
<details>
<summary>æç¤ºï¼šä½¿ç”¨é“¾è¡¨ç®¡ç†ç©ºé—²å¯¹è±¡ï¼Œè€ƒè™‘æ‰¹é‡åˆ†é…ä¼˜åŒ–</summary>
<p>å…³é”®æ˜¯ç»´æŠ¤ç©ºé—²å¯¹è±¡é“¾è¡¨å’Œ Per-CPU ç¼“å­˜çš„åŒæ­¥ã€‚</p>
</details>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p>è®¾è®¡è¦ç‚¹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">simple_slab</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">freelist</span><span class="p">;</span><span class="w">          </span><span class="c1">// ç©ºé—²å¯¹è±¡é“¾è¡¨</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w">       </span><span class="c1">// å¯¹è±¡å¤§å°</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">align</span><span class="p">;</span><span class="w">      </span><span class="c1">// å¯¹é½è¦æ±‚</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="o">*</span><span class="n">pages</span><span class="p">;</span><span class="w">      </span><span class="c1">// slab é¡µé¢</span>

<span class="w">    </span><span class="c1">// Per-CPU ç¼“å­˜</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">list</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">__percpu</span><span class="w"> </span><span class="o">*</span><span class="n">cpu_cache</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// åˆ†é…é€»è¾‘ï¼š</span>

<span class="mf">1.</span><span class="w"> </span><span class="n">æ£€æŸ¥</span><span class="w"> </span><span class="n">Per</span><span class="o">-</span><span class="n">CPU</span><span class="w"> </span><span class="n">ç¼“å­˜</span>
<span class="mf">2.</span><span class="w"> </span><span class="n">å¦‚æœä¸ºç©º</span><span class="err">ï¼Œ</span><span class="n">ä»å…¨å±€</span><span class="w"> </span><span class="n">freelist</span><span class="w"> </span><span class="n">æ‰¹é‡è·å–</span>
<span class="mf">3.</span><span class="w"> </span><span class="n">å¦‚æœå…¨å±€ä¸ºç©º</span><span class="err">ï¼Œ</span><span class="n">åˆ†é…æ–°</span><span class="w"> </span><span class="n">slab</span>
<span class="mf">4.</span><span class="w"> </span><span class="n">è¿”å›å¯¹è±¡ç»™è°ƒç”¨è€…</span>

<span class="c1">// é‡Šæ”¾é€»è¾‘ï¼š</span>

<span class="mf">1.</span><span class="w"> </span><span class="n">æ”¾å…¥</span><span class="w"> </span><span class="n">Per</span><span class="o">-</span><span class="n">CPU</span><span class="w"> </span><span class="n">ç¼“å­˜</span>
<span class="mf">2.</span><span class="w"> </span><span class="n">å¦‚æœç¼“å­˜æ»¡</span><span class="err">ï¼Œ</span><span class="n">æ‰¹é‡è¿”å›ç»™å…¨å±€</span><span class="w"> </span><span class="n">freelist</span>
<span class="mf">3.</span><span class="w"> </span><span class="n">è€ƒè™‘</span><span class="w"> </span><span class="n">slab</span><span class="w"> </span><span class="n">åˆå¹¶å’Œå†…å­˜å›æ”¶</span>

<span class="c1">// å…³é”®ä¼˜åŒ–ï¼š</span>

<span class="o">-</span><span class="w"> </span><span class="n">æ‰¹é‡ä¼ è¾“å‡å°‘é”ç«äº‰</span>
<span class="o">-</span><span class="w"> </span><span class="n">å¯¹è±¡æ„é€ å‡½æ•°é¿å…é‡å¤åˆå§‹åŒ–</span>
<span class="o">-</span><span class="w"> </span><span class="n">LIFO</span><span class="w"> </span><span class="n">é¡ºåºæé«˜ç¼“å­˜çƒ­åº¦</span>
</code></pre></div>

</details>
<p><strong>é¢˜ç›® 6</strong>ï¼šå®ç°ä¸€ä¸ªç®€å•çš„ LRU é¡µé¢ç½®æ¢ç®—æ³•ï¼ŒåŒ…æ‹¬é¡µé¢è€åŒ–å’Œå›æ”¶é€‰æ‹©ã€‚</p>
<details>
<summary>æç¤ºï¼šä½¿ç”¨åŒå‘é“¾è¡¨ç»´æŠ¤ LRU é¡ºåºï¼Œè€ƒè™‘æ´»è·ƒ/éæ´»è·ƒåˆ—è¡¨</summary>
<p>é‡ç‚¹æ˜¯é¡µé¢åœ¨åˆ—è¡¨é—´çš„ç§»åŠ¨ç­–ç•¥å’Œå›æ”¶victimçš„é€‰æ‹©ã€‚</p>
</details>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p>å®ç°æ¡†æ¶ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">lru_list</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">active</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">inactive</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">nr_active</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">nr_inactive</span><span class="p">;</span>
<span class="w">    </span><span class="n">spinlock_t</span><span class="w"> </span><span class="n">lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// é¡µé¢è®¿é—®æ—¶ï¼š</span>

<span class="mf">1.</span><span class="w"> </span><span class="n">å¦‚æœåœ¨</span><span class="w"> </span><span class="n">inactive</span><span class="w"> </span><span class="n">åˆ—è¡¨</span><span class="err">ï¼Œ</span><span class="n">ç§»åˆ°</span><span class="w"> </span><span class="n">active</span>
<span class="mf">2.</span><span class="w"> </span><span class="n">å¦‚æœåœ¨</span><span class="w"> </span><span class="n">active</span><span class="w"> </span><span class="n">åˆ—è¡¨</span><span class="err">ï¼Œ</span><span class="n">ç§»åˆ°åˆ—è¡¨å¤´éƒ¨</span>
<span class="mf">3.</span><span class="w"> </span><span class="n">ç»´æŠ¤</span><span class="w"> </span><span class="n">active</span><span class="o">:</span><span class="n">inactive</span><span class="w"> </span><span class="n">æ¯”ä¾‹</span><span class="err">ï¼ˆ</span><span class="n">å¦‚</span><span class="w"> </span><span class="mi">2</span><span class="o">:</span><span class="mi">1</span><span class="err">ï¼‰</span>

<span class="c1">// é¡µé¢è€åŒ–ï¼š</span>

<span class="mf">1.</span><span class="w"> </span><span class="n">å®šæœŸæ‰«æ</span><span class="w"> </span><span class="n">active</span><span class="w"> </span><span class="n">åˆ—è¡¨å°¾éƒ¨</span>
<span class="mf">2.</span><span class="w"> </span><span class="n">æ£€æŸ¥é¡µé¢è®¿é—®ä½</span><span class="err">ï¼ˆ</span><span class="n">PTE</span><span class="w"> </span><span class="n">çš„</span><span class="w"> </span><span class="n">Accessed</span><span class="w"> </span><span class="n">ä½</span><span class="err">ï¼‰</span>
<span class="mf">3.</span><span class="w"> </span><span class="n">æœªè®¿é—®çš„é¡µé¢é™çº§åˆ°</span><span class="w"> </span><span class="n">inactive</span>

<span class="c1">// å›æ”¶é€‰æ‹©ï¼š</span>

<span class="mf">1.</span><span class="w"> </span><span class="n">ä¼˜å…ˆä»</span><span class="w"> </span><span class="n">inactive</span><span class="w"> </span><span class="n">åˆ—è¡¨å°¾éƒ¨é€‰æ‹©</span>
<span class="mf">2.</span><span class="w"> </span><span class="n">è·³è¿‡è„é¡µ</span><span class="err">ï¼ˆ</span><span class="n">éœ€è¦å†™å›</span><span class="err">ï¼‰</span>
<span class="mf">3.</span><span class="w"> </span><span class="n">è·³è¿‡æ­£åœ¨ä½¿ç”¨çš„é¡µé¢</span>
<span class="mf">4.</span><span class="w"> </span><span class="n">æ‰¹é‡å›æ”¶æé«˜æ•ˆç‡</span>

<span class="c1">// ä¼˜åŒ–è€ƒè™‘ï¼š</span>

<span class="o">-</span><span class="w"> </span><span class="n">ä½¿ç”¨æ—¶é’Ÿç®—æ³•è¿‘ä¼¼</span><span class="w"> </span><span class="n">LRU</span>
<span class="o">-</span><span class="w"> </span><span class="n">åˆ†ç¦»æ–‡ä»¶é¡µå’ŒåŒ¿åé¡µ</span>
<span class="o">-</span><span class="w"> </span><span class="n">Per</span><span class="o">-</span><span class="n">zone</span><span class="w"> </span><span class="n">LRU</span><span class="w"> </span><span class="n">å‡å°‘é”ç«äº‰</span>
</code></pre></div>

</details>
<h3 id="_7">å¼€æ”¾æ€è€ƒé¢˜</h3>
<p><strong>é¢˜ç›® 7</strong>ï¼šç°ä»£ NVMe SSD çš„æ™®åŠå¦‚ä½•å½±å“ Linux å†…å­˜ç®¡ç†è®¾è®¡ï¼Ÿè¯·è®¨è®ºè‡³å°‘ä¸‰ä¸ªæ–¹é¢çš„å½±å“ã€‚</p>
<details>
<summary>æç¤ºï¼šè€ƒè™‘å»¶è¿Ÿã€å¸¦å®½ã€å¯¿å‘½ç­‰ç‰¹æ€§</summary>
<p>NVMe çš„ä½å»¶è¿Ÿæ”¹å˜äº†å†…å­˜ä¸å­˜å‚¨çš„ä¼ ç»Ÿè¾¹ç•Œã€‚</p>
</details>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p>å½±å“åˆ†æï¼š</p>
<ol>
<li>
<p><strong>äº¤æ¢ç­–ç•¥ä¼˜åŒ–</strong>ï¼š
   - NVMe å»¶è¿Ÿæ¥è¿‘ DRAMï¼ˆå¾®ç§’çº§ï¼‰
   - å¯ä»¥æ›´ç§¯æåœ°ä½¿ç”¨ swap
   - zswap/zram å‹ç¼©äº¤æ¢æ›´æœ‰ä»·å€¼
   - è€ƒè™‘åˆ†å±‚å†…å­˜ï¼ˆå†…å­˜+NVMe+HDDï¼‰</p>
</li>
<li>
<p><strong>é¡µé¢å›æ”¶ç®—æ³•</strong>ï¼š
   - ä¸»è¦/æ¬¡è¦ç¼ºé¡µçš„ä»£ä»·å·®è·ç¼©å°
   - å¯ä»¥å®¹å¿æ›´é«˜çš„ç¼ºé¡µç‡
   - é¢„è¯»ç®—æ³•éœ€è¦é‡æ–°è°ƒæ•´
   - è€ƒè™‘ SSD å¯¿å‘½çš„å†™å…¥å‡è¡¡</p>
</li>
<li>
<p><strong>æŒä¹…å†…å­˜æ”¯æŒ</strong>ï¼š
   - DAXï¼ˆç›´æ¥è®¿é—®ï¼‰ç»•è¿‡é¡µç¼“å­˜
   - PMEM ä½œä¸ºå†…å­˜æˆ–å­˜å‚¨çš„åŒé‡è§’è‰²
   - æ–°çš„ç¼–ç¨‹æ¨¡å‹ï¼ˆå¦‚ Intel Optaneï¼‰
   - å´©æºƒä¸€è‡´æ€§çš„æ–°æŒ‘æˆ˜</p>
</li>
<li>
<p><strong>I/O è·¯å¾„ä¼˜åŒ–</strong>ï¼š
   - å‡å°‘å†…æ ¸æ€/ç”¨æˆ·æ€åˆ‡æ¢ï¼ˆio_uringï¼‰
   - å·¨é¡µæ”¯æŒå‡å°‘ TLB å‹åŠ›
   - NUMA æ„ŸçŸ¥çš„è®¾å¤‡åˆ†é…</p>
</li>
</ol>
</details>
<p><strong>é¢˜ç›® 8</strong>ï¼šè®¾è®¡ä¸€ä¸ªæ”¯æŒå†…å­˜ QoSï¼ˆQuality of Serviceï¼‰çš„å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œç¡®ä¿å…³é”®åº”ç”¨çš„å†…å­˜ä¿éšœã€‚</p>
<details>
<summary>æç¤ºï¼šè€ƒè™‘å†…å­˜é¢„ç•™ã€ä¼˜å…ˆçº§å’Œéš”ç¦»æœºåˆ¶</summary>
<p>å‚è€ƒ cgroups çš„å†…å­˜æ§åˆ¶å™¨è®¾è®¡ã€‚</p>
</details>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p>QoS æœºåˆ¶è®¾è®¡ï¼š</p>
<ol>
<li>
<p><strong>å†…å­˜é¢„ç•™æœºåˆ¶</strong>ï¼š
   - æœ€å°ä¿éšœï¼ˆmemory.minï¼‰ï¼šä¿æŠ¤é˜ˆå€¼
   - è½¯é™åˆ¶ï¼ˆmemory.lowï¼‰ï¼šå°½åŠ›ä¿æŠ¤
   - ç¡¬é™åˆ¶ï¼ˆmemory.maxï¼‰ï¼šç»å¯¹ä¸Šé™
   - åˆ†å±‚ç»§æ‰¿ï¼šçˆ¶å­ cgroup çº¦æŸ</p>
</li>
<li>
<p><strong>ä¼˜å…ˆçº§è°ƒåº¦</strong>ï¼š
   - å†…å­˜åˆ†é…ä¼˜å…ˆçº§é˜Ÿåˆ—
   - é«˜ä¼˜å…ˆçº§å¯æŠ¢å ä½ä¼˜å…ˆçº§å†…å­˜
   - OOM æ—¶æŒ‰ä¼˜å…ˆçº§é€‰æ‹©å—å®³è€…
   - å›æ”¶å‹åŠ›æŒ‰ä¼˜å…ˆçº§åˆ†é…</p>
</li>
<li>
<p><strong>æ€§èƒ½éš”ç¦»</strong>ï¼š
   - Per-cgroup LRU é“¾è¡¨
   - ç‹¬ç«‹çš„å›æ”¶æ‰«ææ§åˆ¶
   - CPU å’Œå†…å­˜å¸¦å®½è”åˆæ§åˆ¶
   - NUMA èŠ‚ç‚¹ç»‘å®š</p>
</li>
<li>
<p><strong>ç›‘æ§åé¦ˆ</strong>ï¼š
   - å®æ—¶å†…å­˜å‹åŠ›æŒ‡æ ‡
   - åˆ†é…å»¶è¿Ÿç»Ÿè®¡
   - ç¼ºé¡µç‡ç›‘æ§
   - è‡ªé€‚åº”è°ƒæ•´ç­–ç•¥</p>
</li>
</ol>
<p>å®ç°è€ƒè™‘ï¼š</p>
<ul>
<li>é¿å…ä¼˜å…ˆçº§åè½¬</li>
<li>é˜²æ­¢é¥¿æ­»ä½ä¼˜å…ˆçº§</li>
<li>å¼€é”€ä¸ç²¾åº¦æƒè¡¡</li>
<li>ä¸è°ƒåº¦å™¨é›†æˆ</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="o">&lt;/</span><span class="nt">details</span><span class="o">&gt;</span>

<span class="err">##</span><span class="w"> </span><span class="nt">3</span><span class="p">.</span><span class="nc">7</span><span class="w"> </span><span class="nt">å¸¸è§é™·é˜±ä¸é”™è¯¯</span>

<span class="err">###</span><span class="w"> </span><span class="nt">å†…å­˜æ³„æ¼æ¨¡å¼</span>

<span class="nt">1</span><span class="o">.</span><span class="w"> </span><span class="o">**</span><span class="nt">å¿˜è®°é‡Šæ”¾å†…å­˜</span><span class="o">**</span><span class="err">ï¼š</span>
<span class="err">```</span><span class="nt">c</span>
<span class="o">//</span><span class="w"> </span><span class="nt">é”™è¯¯</span><span class="err">ï¼š</span><span class="nt">å¿˜è®°</span><span class="w"> </span><span class="nt">kfree</span>
<span class="nt">void</span><span class="w"> </span><span class="o">*</span><span class="nt">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">kmalloc</span><span class="o">(</span><span class="nt">size</span><span class="o">,</span><span class="w"> </span><span class="nt">GFP_KERNEL</span><span class="o">);</span>
<span class="nt">if</span><span class="w"> </span><span class="o">(!</span><span class="nt">buf</span><span class="o">)</span>
<span class="w">    </span><span class="nt">return</span><span class="w"> </span><span class="nt">-ENOMEM</span><span class="o">;</span>
<span class="o">//</span><span class="w"> </span><span class="o">...</span><span class="w"> </span><span class="nt">ä½¿ç”¨</span><span class="w"> </span><span class="nt">buf</span>
<span class="nt">return</span><span class="w"> </span><span class="nt">0</span><span class="o">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="nt">æ³„æ¼</span><span class="err">ï¼</span>

<span class="o">//</span><span class="w"> </span><span class="nt">æ­£ç¡®</span><span class="err">ï¼š</span><span class="nt">ä½¿ç”¨</span><span class="w"> </span><span class="nt">goto</span><span class="w"> </span><span class="nt">æ¸…ç†</span>
<span class="nt">void</span><span class="w"> </span><span class="o">*</span><span class="nt">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">kmalloc</span><span class="o">(</span><span class="nt">size</span><span class="o">,</span><span class="w"> </span><span class="nt">GFP_KERNEL</span><span class="o">);</span>
<span class="nt">if</span><span class="w"> </span><span class="o">(!</span><span class="nt">buf</span><span class="o">)</span>
<span class="w">    </span><span class="nt">return</span><span class="w"> </span><span class="nt">-ENOMEM</span><span class="o">;</span>
<span class="o">//</span><span class="w"> </span><span class="o">...</span><span class="w"> </span><span class="nt">ä½¿ç”¨</span><span class="w"> </span><span class="nt">buf</span>
<span class="nt">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">do_something</span><span class="o">();</span>
<span class="nt">if</span><span class="w"> </span><span class="o">(</span><span class="nt">ret</span><span class="o">)</span>
<span class="w">    </span><span class="nt">goto</span><span class="w"> </span><span class="nt">out_free</span><span class="o">;</span>
<span class="o">//</span><span class="w"> </span><span class="o">...</span>
<span class="nt">out_free</span><span class="o">:</span>
<span class="w">    </span><span class="nt">kfree</span><span class="o">(</span><span class="nt">buf</span><span class="o">);</span>
<span class="w">    </span><span class="nt">return</span><span class="w"> </span><span class="nt">ret</span><span class="o">;</span>
</code></pre></div>

<ol start="2">
<li><strong>é‡å¤é‡Šæ”¾</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯ï¼šdouble free</span>
<span class="n">kfree</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
<span class="c1">// ... å…¶ä»–ä»£ç </span>
<span class="n">kfree</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span><span class="w">  </span><span class="c1">// å´©æºƒï¼</span>

<span class="c1">// æ­£ç¡®ï¼šé‡Šæ”¾åç½®ç©º</span>
<span class="n">kfree</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
<span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</code></pre></div>

<ol start="3">
<li><strong>é‡Šæ”¾æ ˆå†…å­˜</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯ï¼šé‡Šæ”¾æ ˆå˜é‡</span>
<span class="kt">char</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span><span class="w">  </span><span class="c1">// å´©æºƒï¼</span>

<span class="c1">// æ­£ç¡®ï¼šåªé‡Šæ”¾åŠ¨æ€åˆ†é…çš„å†…å­˜</span>
<span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</code></pre></div>

<h3 id="_8">åˆ†é…æ ‡å¿—è¯¯ç”¨</h3>
<ol>
<li><strong>åŸå­ä¸Šä¸‹æ–‡ä½¿ç”¨ GFP_KERNEL</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯ï¼šä¸­æ–­å¤„ç†ä¸­ç¡çœ </span>
<span class="n">irqreturn_t</span><span class="w"> </span><span class="nf">my_isr</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">irq</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">);</span><span class="w">  </span><span class="c1">// å¯èƒ½ç¡çœ ï¼</span>
<span class="p">}</span>

<span class="c1">// æ­£ç¡®ï¼šä½¿ç”¨ GFP_ATOMIC</span>
<span class="n">irqreturn_t</span><span class="w"> </span><span class="nf">my_isr</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">irq</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_ATOMIC</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<ol start="2">
<li><strong>å†…å­˜å›æ”¶æ­»é”</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯ï¼šæ–‡ä»¶ç³»ç»Ÿå›æ”¶è·¯å¾„å†æ¬¡åˆ†é…</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">writepage</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="o">*</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">);</span><span class="w">  </span><span class="c1">// å¯èƒ½æ­»é”ï¼</span>
<span class="p">}</span>

<span class="c1">// æ­£ç¡®ï¼šä½¿ç”¨ GFP_NOFS</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">writepage</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="o">*</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_NOFS</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="_9">å¹¶å‘è®¿é—®é”™è¯¯</h3>
<ol>
<li><strong>æ— ä¿æŠ¤çš„é¡µè¡¨æ“ä½œ</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯ï¼šæ— é”è®¿é—®é¡µè¡¨</span>
<span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="n">pte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pte_offset_map</span><span class="p">(</span><span class="n">pmd</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">);</span>
<span class="o">*</span><span class="n">pte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_pte</span><span class="p">;</span><span class="w">  </span><span class="c1">// ç«æ€æ¡ä»¶ï¼</span>

<span class="c1">// æ­£ç¡®ï¼šæŒæœ‰é¡µè¡¨é”</span>
<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">page_table_lock</span><span class="p">);</span>
<span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="n">pte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pte_offset_map</span><span class="p">(</span><span class="n">pmd</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">);</span>
<span class="o">*</span><span class="n">pte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_pte</span><span class="p">;</span>
<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">page_table_lock</span><span class="p">);</span>
</code></pre></div>

<ol start="2">
<li><strong>Per-CPU å˜é‡è¯¯ç”¨</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯ï¼šæœªç¦ç”¨æŠ¢å </span>
<span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">my_counter</span><span class="p">,</span><span class="w"> </span><span class="n">smp_processor_id</span><span class="p">());</span>
<span class="p">(</span><span class="o">*</span><span class="n">counter</span><span class="p">)</span><span class="o">++</span><span class="p">;</span><span class="w">  </span><span class="c1">// å¯èƒ½è¢«æŠ¢å åˆ°å…¶ä»– CPUï¼</span>

<span class="c1">// æ­£ç¡®ï¼šç¦ç”¨æŠ¢å </span>
<span class="n">preempt_disable</span><span class="p">();</span>
<span class="n">this_cpu_inc</span><span class="p">(</span><span class="n">my_counter</span><span class="p">);</span>
<span class="n">preempt_enable</span><span class="p">();</span>
</code></pre></div>

<h2 id="38">3.8 æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•</h2>
<h3 id="_10">å†…å­˜åˆ†é…å†³ç­–æ ‘</h3>
<ul>
<li>[ ] <strong>ç¡®å®šåˆ†é…å¤§å°</strong></li>
<li>å°äº PAGE_SIZE â†’ kmalloc</li>
<li>å¤§äº 128KB â†’ vmalloc</li>
<li>éœ€è¦ç‰©ç†è¿ç»­ â†’ alloc_pages</li>
<li>
<p>ç‰¹å®šå¯¹è±¡ç±»å‹ â†’ kmem_cache_alloc</p>
</li>
<li>
<p>[ ] <strong>é€‰æ‹©æ­£ç¡®çš„ GFP æ ‡å¿—</strong></p>
</li>
<li>è¿›ç¨‹ä¸Šä¸‹æ–‡ â†’ GFP_KERNEL</li>
<li>åŸå­ä¸Šä¸‹æ–‡ â†’ GFP_ATOMIC</li>
<li>æ–‡ä»¶ç³»ç»Ÿ â†’ GFP_NOFS</li>
<li>ä¸è§¦å‘ I/O â†’ GFP_NOIO</li>
<li>
<p>ç”¨æˆ·ç©ºé—´ â†’ GFP_USER</p>
</li>
<li>
<p>[ ] <strong>è€ƒè™‘ NUMA ç‰¹æ€§</strong></p>
</li>
<li>ä½¿ç”¨æœ¬åœ°èŠ‚ç‚¹åˆ†é…</li>
<li>è®¾ç½®åˆé€‚çš„ NUMA ç­–ç•¥</li>
<li>
<p>ç›‘æ§è·¨èŠ‚ç‚¹è®¿é—®</p>
</li>
<li>
<p>[ ] <strong>å®ç°é”™è¯¯å¤„ç†</strong></p>
</li>
<li>æ£€æŸ¥åˆ†é…å¤±è´¥</li>
<li>æä¾›é™çº§æ–¹æ¡ˆ</li>
<li>æ­£ç¡®çš„æ¸…ç†è·¯å¾„</li>
</ul>
<h3 id="_11">æ€§èƒ½ä¼˜åŒ–è¦ç‚¹</h3>
<ul>
<li>[ ] <strong>å‡å°‘åˆ†é…é¢‘ç‡</strong></li>
<li>å¯¹è±¡æ± å’Œç¼“å­˜</li>
<li>æ‰¹é‡åˆ†é…</li>
<li>
<p>é¢„åˆ†é…ç­–ç•¥</p>
</li>
<li>
<p>[ ] <strong>ä¼˜åŒ–ç¼“å­˜ä½¿ç”¨</strong></p>
</li>
<li>æ•°æ®ç»“æ„å¯¹é½</li>
<li>é¿å…ä¼ªå…±äº«</li>
<li>
<p>Per-CPU å˜é‡</p>
</li>
<li>
<p>[ ] <strong>æ§åˆ¶å†…å­˜ç¢ç‰‡</strong></p>
</li>
<li>ä½¿ç”¨åˆé€‚çš„åˆ†é…å™¨</li>
<li>å®šæœŸå†…å­˜å‹ç¼©</li>
<li>
<p>ç›‘æ§ç¢ç‰‡æŒ‡æ ‡</p>
</li>
<li>
<p>[ ] <strong>å†…å­˜å›æ”¶ä¼˜åŒ–</strong></p>
</li>
<li>åˆç†è®¾ç½®æ°´ä½çº¿</li>
<li>ä¼˜åŒ– swappiness</li>
<li>ä½¿ç”¨ madvise æç¤º</li>
</ul>
<h3 id="_12">è°ƒè¯•ä¸ç›‘æ§</h3>
<ul>
<li>[ ] <strong>ä½¿ç”¨è°ƒè¯•å·¥å…·</strong></li>
<li>KASANï¼ˆåœ°å€æ¶ˆæ¯’ï¼‰</li>
<li>kmemleakï¼ˆæ³„æ¼æ£€æµ‹ï¼‰</li>
<li>slub_debugï¼ˆåˆ†é…å™¨è°ƒè¯•ï¼‰</li>
<li>
<p>ftraceï¼ˆè·Ÿè¸ªåˆ†é…ï¼‰</p>
</li>
<li>
<p>[ ] <strong>ç›‘æ§å…³é”®æŒ‡æ ‡</strong></p>
</li>
<li>/proc/meminfo</li>
<li>/proc/buddyinfo</li>
<li>/proc/slabinfo</li>
<li>
<p>/proc/pagetypeinfo</p>
</li>
<li>
<p>[ ] <strong>æ€§èƒ½åˆ†æ</strong></p>
</li>
<li>perf å†…å­˜äº‹ä»¶</li>
<li>ç¼ºé¡µç‡ç»Ÿè®¡</li>
<li>å†…å­˜å¸¦å®½ä½¿ç”¨</li>
<li>NUMA å¹³è¡¡çŠ¶æ€</li>
</ul>
</details>
            </article>
            
            <nav class="page-nav"><a href="chapter2.html" class="nav-link prev">â† ç¬¬2ç« ï¼šè¿›ç¨‹ç®¡ç†ä¸ä»»åŠ¡è°ƒåº¦</a><a href="chapter4.html" class="nav-link next">ç¬¬4ç« ï¼šè¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ â†’</a></nav>
        </main>
    </div>
</body>
</html>