<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬9ç« ï¼šç½‘ç»œåè®®æ ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Linux å†…æ ¸æºä»£ç æ·±åº¦è§£æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬1ç« ï¼šLinux å†…æ ¸æ¦‚è¿°ä¸å‘å±•å²</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬2ç« ï¼šè¿›ç¨‹ç®¡ç†ä¸ä»»åŠ¡è°ƒåº¦</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬3ç« ï¼šå†…å­˜ç®¡ç†æ¶æ„</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬4ç« ï¼šè¿›ç¨‹é—´é€šä¿¡æœºåˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬5ç« ï¼šè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬6ç« ï¼šå…·ä½“æ–‡ä»¶ç³»ç»Ÿå®ç°</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬7ç« ï¼šå—è®¾å¤‡å±‚ä¸I/Oè°ƒåº¦</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬8ç« ï¼šè®¾å¤‡é©±åŠ¨æ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬9ç« ï¼šç½‘ç»œåè®®æ ˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬10ç« ï¼šå†…æ ¸åŒæ­¥æœºåˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬11ç« ï¼šå¹¶å‘ç¼–ç¨‹æ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬12ç« ï¼šå®¹å™¨ä¸å‘½åç©ºé—´</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬13ç« ï¼šå®‰å…¨å­ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬14ç« ï¼šå®æ—¶Linux</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬15ç« ï¼šæ€§èƒ½åˆ†æä¸è°ƒè¯•</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬16ç« ï¼šå¼•å¯¼è¿‡ç¨‹ä¸åˆå§‹åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="9">ç¬¬9ç« ï¼šç½‘ç»œåè®®æ ˆ</h1>
<h2 id="_1">ç« èŠ‚å¤§çº²</h2>
<h3 id="91">9.1 å¼•è¨€</h3>
<ul>
<li>Linux ç½‘ç»œæ ˆæ¶æ„æ¦‚è¿°</li>
<li>ä»ç½‘å¡åˆ°åº”ç”¨ç¨‹åºçš„æ•°æ®æµ</li>
<li>å†…æ ¸ç½‘ç»œå­ç³»ç»Ÿçš„æ¼”è¿›</li>
</ul>
<h3 id="92-sk_buff">9.2 sk_buff ä¸ç½‘ç»œæ•°æ®æµ</h3>
<ul>
<li>9.2.1 sk_buff ç»“æ„ä½“è¯¦è§£</li>
<li>9.2.2 sk_buff çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†</li>
<li>9.2.3 æ•°æ®åŒ…åœ¨å„å±‚çš„å¤„ç†æµç¨‹</li>
<li>9.2.4 é›¶æ‹·è´ä¸ scatter-gather I/O</li>
</ul>
<h3 id="93-tcpip">9.3 TCP/IP åè®®æ ˆå®ç°</h3>
<ul>
<li>9.3.1 ç½‘ç»œå±‚ï¼šIP åè®®å¤„ç†</li>
<li>9.3.2 ä¼ è¾“å±‚ï¼šTCP çŠ¶æ€æœºä¸æ‹¥å¡æ§åˆ¶</li>
<li>9.3.3 å¥—æ¥å­—å±‚ï¼šsocket API å®ç°</li>
<li>9.3.4 è¿æ¥ç®¡ç†ä¸ TIME_WAIT ä¼˜åŒ–</li>
</ul>
<h3 id="94-netfilter-iptables">9.4 Netfilter æ¡†æ¶ä¸ iptables</h3>
<ul>
<li>9.4.1 Netfilter é’©å­æœºåˆ¶</li>
<li>9.4.2 è¿æ¥è·Ÿè¸ªï¼ˆconntrackï¼‰</li>
<li>9.4.3 NAT å®ç°åŸç†</li>
<li>9.4.4 iptables è§„åˆ™åŒ¹é…å¼•æ“</li>
</ul>
<h3 id="95">9.5 é«˜æ€§èƒ½ç½‘ç»œæŠ€æœ¯</h3>
<ul>
<li>9.5.1 NAPIï¼šä¸­æ–­ç¼“è§£æœºåˆ¶</li>
<li>9.5.2 XDPï¼šå†…æ ¸å¿«é€Ÿæ•°æ®è·¯å¾„</li>
<li>9.5.3 io_uring ç½‘ç»œç¼–ç¨‹</li>
<li>9.5.4 eBPF ç½‘ç»œåº”ç”¨</li>
</ul>
<h3 id="96">9.6 æœ¬ç« å°ç»“</h3>
<h3 id="97">9.7 ç»ƒä¹ é¢˜</h3>
<h3 id="98">9.8 å¸¸è§é™·é˜±ä¸é”™è¯¯</h3>
<h3 id="99">9.9 æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•</h3>
<hr />
<h2 id="91_1">9.1 å¼•è¨€</h2>
<p>Linux ç½‘ç»œåè®®æ ˆæ˜¯å†…æ ¸ä¸­æœ€å¤æ‚ã€æœ€ç²¾å¦™çš„å­ç³»ç»Ÿä¹‹ä¸€ã€‚ä»æ—©æœŸçš„ç®€å• TCP/IP å®ç°ï¼Œåˆ°ä»Šå¤©æ”¯æŒæ¯ç§’å¤„ç†åƒä¸‡çº§æ•°æ®åŒ…çš„é«˜æ€§èƒ½æ¶æ„ï¼ŒLinux ç½‘ç»œæ ˆç»å†äº†ç¿»å¤©è¦†åœ°çš„å˜åŒ–ã€‚æœ¬ç« å°†æ·±å…¥å‰–æç½‘ç»œæ ˆçš„æ ¸å¿ƒæ•°æ®ç»“æ„ã€å…³é”®ç®—æ³•å’Œæ€§èƒ½ä¼˜åŒ–æŠ€æœ¯ï¼Œå¸®åŠ©è¯»è€…ç†è§£ä»ç½‘å¡ç¡¬ä»¶ä¸­æ–­åˆ°åº”ç”¨ç¨‹åº socket è°ƒç”¨çš„å®Œæ•´æ•°æ®æµã€‚</p>
<h3 id="_2">å­¦ä¹ ç›®æ ‡</h3>
<p>å®Œæˆæœ¬ç« å­¦ä¹ åï¼Œæ‚¨å°†èƒ½å¤Ÿï¼š</p>
<ol>
<li><strong>ç†è§£ sk_buff æ ¸å¿ƒæ•°æ®ç»“æ„</strong>ï¼šæŒæ¡ç½‘ç»œæ•°æ®åŒ…åœ¨å†…æ ¸ä¸­çš„è¡¨ç¤ºå’Œç®¡ç†æ–¹å¼</li>
<li><strong>åˆ†æ TCP/IP åè®®æ ˆå®ç°</strong>ï¼šæ·±å…¥ç†è§£å„å±‚åè®®çš„å¤„ç†æµç¨‹å’ŒçŠ¶æ€æœºåˆ¶</li>
<li><strong>æŒæ¡ Netfilter æ¡†æ¶</strong>ï¼šç†è§£é˜²ç«å¢™è§„åˆ™åŒ¹é…ã€NAT è½¬æ¢å’Œè¿æ¥è·Ÿè¸ªåŸç†</li>
<li><strong>åº”ç”¨é«˜æ€§èƒ½ç½‘ç»œæŠ€æœ¯</strong>ï¼šä½¿ç”¨ NAPIã€XDPã€eBPF ç­‰æŠ€æœ¯ä¼˜åŒ–ç½‘ç»œæ€§èƒ½</li>
<li><strong>è¯Šæ–­ç½‘ç»œæ€§èƒ½é—®é¢˜</strong>ï¼šå®šä½å’Œè§£å†³å¸¸è§çš„ç½‘ç»œç“¶é¢ˆå’Œå»¶è¿Ÿé—®é¢˜</li>
</ol>
<h3 id="_3">æ¶æ„æ¦‚è§ˆ</h3>
<p>Linux ç½‘ç»œæ ˆé‡‡ç”¨åˆ†å±‚æ¶æ„ï¼Œæ¯å±‚éƒ½æœ‰æ˜ç¡®çš„èŒè´£ï¼š</p>
<div class="codehilite"><pre><span></span><code>åº”ç”¨å±‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚     ç”¨æˆ·ç©ºé—´åº”ç”¨ç¨‹åºï¼ˆsocket APIï¼‰      â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†‘â†“
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ç³»ç»Ÿè°ƒç”¨ç•Œé¢ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                           â†‘â†“
å¥—æ¥å­—å±‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚    BSD Socket å±‚ï¼ˆstruct socketï¼‰     â”‚
          â”‚         åè®®æ— å…³çš„æ¥å£æŠ½è±¡             â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†‘â†“
ä¼ è¾“å±‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚    TCP / UDP / SCTP / DCCP          â”‚
          â”‚    æ‹¥å¡æ§åˆ¶ã€æµé‡æ§åˆ¶ã€å¯é ä¼ è¾“         â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†‘â†“
ç½‘ç»œå±‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚         IPv4 / IPv6 / ICMP           â”‚
          â”‚      è·¯ç”±é€‰æ‹©ã€åˆ†ç‰‡é‡ç»„ã€è½¬å‘           â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†‘â†“
Netfilter â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   é˜²ç«å¢™é’©å­ã€NATã€è¿æ¥è·Ÿè¸ª            â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†‘â†“
é“¾è·¯å±‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚    ARP / Neighbor Discovery          â”‚
          â”‚      ç½‘ç»œè®¾å¤‡æŠ½è±¡ï¼ˆnet_deviceï¼‰        â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†‘â†“
é©±åŠ¨å±‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚      ç½‘å¡é©±åŠ¨ï¼ˆe1000ã€ixgbeç­‰ï¼‰       â”‚
          â”‚         DMAã€ä¸­æ–­å¤„ç†ã€é˜Ÿåˆ—ç®¡ç†        â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="_4">å…³é”®åˆ›æ–°</h3>
<p>Linux ç½‘ç»œæ ˆçš„å‡ ä¸ªé‡è¦åˆ›æ–°ç‚¹ï¼š</p>
<ol>
<li><strong>sk_buff è®¾è®¡</strong>ï¼šé«˜æ•ˆçš„é›¶æ‹·è´æ•°æ®ç»“æ„ï¼Œæ”¯æŒæ•°æ®åŒ…åœ¨å„å±‚é—´ä¼ é€’è€Œæ— éœ€å¤åˆ¶</li>
<li><strong>NAPI æœºåˆ¶</strong>ï¼šè‡ªé€‚åº”çš„ä¸­æ–­ç¼“è§£æŠ€æœ¯ï¼Œåœ¨é«˜è´Ÿè½½æ—¶åˆ‡æ¢åˆ°è½®è¯¢æ¨¡å¼</li>
<li><strong>RCU åœ¨ç½‘ç»œæ ˆçš„åº”ç”¨</strong>ï¼šæ— é”çš„è·¯ç”±è¡¨å’Œè¿æ¥è¡¨æŸ¥æ‰¾</li>
<li><strong>XDP æ¡†æ¶</strong>ï¼šåœ¨é©±åŠ¨å±‚æä¾›å¯ç¼–ç¨‹çš„å¿«é€Ÿæ•°æ®è·¯å¾„</li>
<li><strong>eBPF ç½‘ç»œç¨‹åº</strong>ï¼šå®‰å…¨çš„å†…æ ¸æ€å¯ç¼–ç¨‹ç½‘ç»œå¤„ç†</li>
</ol>
<h3 id="_5">æ€§èƒ½æ¼”è¿›</h3>
<p>ç½‘ç»œæ ˆæ€§èƒ½çš„å‡ ä¸ªé‡Œç¨‹ç¢‘ï¼š</p>
<ul>
<li><strong>2.4 å†…æ ¸æ—¶ä»£</strong>ï¼šåŸºæœ¬çš„ TCP/IP å®ç°ï¼Œå•æ ¸æ€§èƒ½çº¦ 100Mbps</li>
<li><strong>2.6 å†…æ ¸å¼•å…¥ NAPI</strong>ï¼šä¸­æ–­ç¼“è§£æŠ€æœ¯ï¼Œåƒå…†ç½‘å¡æˆä¸ºå¯èƒ½</li>
<li><strong>3.x å†…æ ¸å¤šé˜Ÿåˆ—æ”¯æŒ</strong>ï¼šåˆ©ç”¨å¤šæ ¸å¹¶è¡Œå¤„ç†ï¼Œè¾¾åˆ° 10Gbps</li>
<li><strong>4.x å†…æ ¸ XDP å‡ºç°</strong>ï¼šå†…æ ¸æ—è·¯æŠ€æœ¯ï¼Œå•æ ¸ 14Mpps</li>
<li><strong>5.x å†…æ ¸ io_uring</strong>ï¼šå¼‚æ­¥ I/O é©å‘½ï¼Œæ¥è¿‘ç¡¬ä»¶æé™æ€§èƒ½</li>
</ul>
<h2 id="93-tcpip_1">9.3 TCP/IP åè®®æ ˆå®ç°</h2>
<p>Linux çš„ TCP/IP åè®®æ ˆæ˜¯ä¸€ä¸ªå®Œæ•´çš„ã€ç¬¦åˆæ ‡å‡†çš„å®ç°ï¼Œæ”¯æŒ IPv4ã€IPv6ã€TCPã€UDP ä»¥åŠä¼—å¤šæ‰©å±•åè®®ã€‚æœ¬èŠ‚æ·±å…¥åˆ†æåè®®æ ˆçš„æ ¸å¿ƒå®ç°ï¼ŒåŒ…æ‹¬ç½‘ç»œå±‚çš„è·¯ç”±æœºåˆ¶ã€ä¼ è¾“å±‚çš„çŠ¶æ€æœºç®¡ç†ã€å¥—æ¥å­—å±‚çš„ API å®ç°ï¼Œä»¥åŠè¿æ¥ç®¡ç†çš„ä¼˜åŒ–ç­–ç•¥ã€‚</p>
<h3 id="931-ip">9.3.1 ç½‘ç»œå±‚ï¼šIP åè®®å¤„ç†</h3>
<h4 id="ip">IP åè®®æ¶æ„</h4>
<p>Linux çš„ IP å±‚è´Ÿè´£æ•°æ®åŒ…çš„è·¯ç”±ã€è½¬å‘ã€åˆ†ç‰‡å’Œé‡ç»„ã€‚å…¶æ ¸å¿ƒæ•°æ®ç»“æ„å’Œå¤„ç†æµç¨‹ç»è¿‡ç²¾å¿ƒè®¾è®¡ï¼Œæ”¯æŒé«˜æ•ˆçš„æŸ¥æ‰¾å’Œè½¬å‘ï¼š</p>
<div class="codehilite"><pre><span></span><code>æ¥æ”¶å¤„ç†æµç¨‹ï¼š
netif_receive_skb() â†’ ip_rcv() â†’ ip_rcv_finish() â†’ ip_local_deliver() / ip_forward()
                                        â†“
                                  è·¯ç”±æŸ¥æ‰¾ï¼ˆFIBï¼‰
                                        â†“
                            æœ¬åœ°æ¥æ”¶ / è½¬å‘ / ä¸¢å¼ƒ

å‘é€å¤„ç†æµç¨‹ï¼š
ip_queue_xmit() â†’ ip_output() â†’ ip_finish_output() â†’ ip_finish_output2()
        â†“              â†“                â†“                    â†“
    è·¯ç”±æŸ¥æ‰¾      Netfilteré’©å­     åˆ†ç‰‡å¤„ç†            é‚»å±…å­ç³»ç»Ÿ
</code></pre></div>

<h4 id="_6">è·¯ç”±å­ç³»ç»Ÿ</h4>
<p>Linux ä½¿ç”¨ FIBï¼ˆForwarding Information Baseï¼‰å’Œè·¯ç”±ç¼“å­˜å®ç°é«˜æ•ˆçš„è·¯ç”±æŸ¥æ‰¾ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* è·¯ç”±è¡¨é¡¹ */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">fib_info</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_node</span><span class="w">    </span><span class="n">fib_hash</span><span class="p">;</span><span class="w">      </span><span class="cm">/* å“ˆå¸Œé“¾è¡¨ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w">     </span><span class="n">fib_lhash</span><span class="p">;</span><span class="w">     </span><span class="cm">/* é“¾è¡¨å¤´ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">net</span><span class="w">          </span><span class="o">*</span><span class="n">fib_net</span><span class="p">;</span><span class="w">       </span><span class="cm">/* ç½‘ç»œå‘½åç©ºé—´ */</span>
<span class="w">    </span><span class="kt">int</span><span class="w">                  </span><span class="n">fib_treeref</span><span class="p">;</span><span class="w">   </span><span class="cm">/* å¼•ç”¨è®¡æ•° */</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w">             </span><span class="n">fib_clntref</span><span class="p">;</span><span class="w">   </span><span class="cm">/* å®¢æˆ·ç«¯å¼•ç”¨ */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">         </span><span class="n">fib_flags</span><span class="p">;</span><span class="w">     </span><span class="cm">/* æ ‡å¿—ä½ */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w">        </span><span class="n">fib_dead</span><span class="p">;</span><span class="w">      </span><span class="cm">/* åˆ é™¤æ ‡è®° */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w">        </span><span class="n">fib_protocol</span><span class="p">;</span><span class="w">  </span><span class="cm">/* è·¯ç”±åè®® */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w">        </span><span class="n">fib_scope</span><span class="p">;</span><span class="w">     </span><span class="cm">/* è·¯ç”±èŒƒå›´ */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w">        </span><span class="n">fib_type</span><span class="p">;</span><span class="w">      </span><span class="cm">/* è·¯ç”±ç±»å‹ */</span>
<span class="w">    </span><span class="n">__be32</span><span class="w">               </span><span class="n">fib_prefsrc</span><span class="p">;</span><span class="w">   </span><span class="cm">/* é¦–é€‰æºåœ°å€ */</span>
<span class="w">    </span><span class="n">u32</span><span class="w">                  </span><span class="n">fib_priority</span><span class="p">;</span><span class="w">  </span><span class="cm">/* è·¯ç”±ä¼˜å…ˆçº§ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dst_metrics</span><span class="w">  </span><span class="o">*</span><span class="n">fib_metrics</span><span class="p">;</span><span class="w">   </span><span class="cm">/* è·¯ç”±åº¦é‡ */</span>
<span class="w">    </span><span class="kt">int</span><span class="w">                  </span><span class="n">fib_nhs</span><span class="p">;</span><span class="w">       </span><span class="cm">/* ä¸‹ä¸€è·³æ•°é‡ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">fib_nh</span><span class="w">        </span><span class="n">fib_nh</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w">     </span><span class="cm">/* ä¸‹ä¸€è·³æ•°ç»„ */</span>
<span class="p">};</span>

<span class="cm">/* è·¯ç”±æŸ¥æ‰¾æ ¸å¿ƒå‡½æ•° */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">ip_route_input_slow</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sk_buff</span><span class="w"> </span><span class="o">*</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="n">__be32</span><span class="w"> </span><span class="n">daddr</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                </span><span class="n">__be32</span><span class="w"> </span><span class="n">saddr</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">tos</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">net_device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">fib_result</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">flowi4</span><span class="w"> </span><span class="n">fl4</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* æ„é€ æŸ¥æ‰¾é”® */</span>
<span class="w">    </span><span class="n">fl4</span><span class="p">.</span><span class="n">daddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">daddr</span><span class="p">;</span>
<span class="w">    </span><span class="n">fl4</span><span class="p">.</span><span class="n">saddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">saddr</span><span class="p">;</span>
<span class="w">    </span><span class="n">fl4</span><span class="p">.</span><span class="n">flowi4_tos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tos</span><span class="p">;</span>
<span class="w">    </span><span class="n">fl4</span><span class="p">.</span><span class="n">flowi4_scope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RT_SCOPE_UNIVERSE</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* FIB æŸ¥æ‰¾ */</span>
<span class="w">    </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fib_lookup</span><span class="p">(</span><span class="n">net</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fl4</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* åˆ›å»ºè·¯ç”±ç¼“å­˜é¡¹ */</span>
<span class="w">    </span><span class="n">rth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rt_dst_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ip_local_deliver</span><span class="p">;</span>
<span class="w">    </span><span class="n">rth</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">.</span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ip_output</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="_7">è·¯ç”±ç¼“å­˜ä¼˜åŒ–</h4>
<p>Linux ä½¿ç”¨å¤šçº§ç¼“å­˜åŠ é€Ÿè·¯ç”±æŸ¥æ‰¾ï¼š</p>
<ol>
<li><strong>DST ç¼“å­˜</strong>ï¼šæ¯ä¸ª sk_buff æºå¸¦ dst_entry æŒ‡é’ˆ</li>
<li><strong>FIB Trie</strong>ï¼šåŸºäº LC-Trie çš„è·¯ç”±è¡¨æŸ¥æ‰¾ï¼ŒO(W) å¤æ‚åº¦</li>
<li><strong>è·¯ç”±å¼‚å¸¸ç¼“å­˜</strong>ï¼šå¤„ç† PMTUã€é‡å®šå‘ç­‰å¼‚å¸¸</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="cm">/* LC-Trie èŠ‚ç‚¹ */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">tnode</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">key_vector</span><span class="w"> </span><span class="n">kv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="w">    </span><span class="cm">/* LC-Trie ä½¿ç”¨è·¯å¾„å‹ç¼©å’Œçº§åˆ«å‹ç¼©ä¼˜åŒ– */</span>
<span class="p">};</span>

<span class="cm">/* æŸ¥æ‰¾ç®—æ³• */</span>
<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">key_vector</span><span class="w"> </span><span class="o">*</span><span class="n">fib_find_node</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">trie</span><span class="w"> </span><span class="o">*</span><span class="n">t</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                         </span><span class="k">struct</span><span class="w"> </span><span class="nc">key_vector</span><span class="w"> </span><span class="o">**</span><span class="n">tp</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">key_vector</span><span class="w"> </span><span class="o">*</span><span class="n">pn</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="o">-&gt;</span><span class="n">kv</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">index</span><span class="p">;</span>

<span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="w">        </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_index</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">pn</span><span class="p">);</span>
<span class="w">        </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_child_rcu</span><span class="p">(</span><span class="n">pn</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">)</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="cm">/* è·¯å¾„å‹ç¼©ï¼šè·³è¿‡åªæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹çš„å†…éƒ¨èŠ‚ç‚¹ */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_TNODE</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">bits</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">KEYLENGTH</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tkey_sub_equals</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="o">-&gt;</span><span class="n">bits</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">))</span>
<span class="w">                </span><span class="k">continue</span><span class="p">;</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">IS_TNODE</span><span class="p">(</span><span class="n">n</span><span class="p">));</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="ip_1">IP åˆ†ç‰‡ä¸é‡ç»„</h4>
<p>å½“æ•°æ®åŒ…å¤§å°è¶…è¿‡ MTU æ—¶ï¼ŒIP å±‚è´Ÿè´£åˆ†ç‰‡å’Œé‡ç»„ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* IP åˆ†ç‰‡ */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">ip_fragment</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">net</span><span class="w"> </span><span class="o">*</span><span class="n">net</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sock</span><span class="w"> </span><span class="o">*</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span>
<span class="w">                       </span><span class="k">struct</span><span class="w"> </span><span class="nc">sk_buff</span><span class="w"> </span><span class="o">*</span><span class="n">skb</span><span class="p">,</span>
<span class="w">                       </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mtu</span><span class="p">,</span>
<span class="w">                       </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">output</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">net</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sock</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                     </span><span class="k">struct</span><span class="w"> </span><span class="nc">sk_buff</span><span class="w"> </span><span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">iphdr</span><span class="w"> </span><span class="o">*</span><span class="n">iph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">hlen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ll_rs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LL_RESERVED_SPACE</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mtu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dst_mtu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* è®¡ç®—æ¯ä¸ªåˆ†ç‰‡çš„å¤§å° */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">frag_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mtu</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">hlen</span><span class="p">;</span>
<span class="w">    </span><span class="n">frag_size</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="mi">7</span><span class="p">;</span><span class="w">  </span><span class="cm">/* 8 å­—èŠ‚å¯¹é½ */</span>

<span class="w">    </span><span class="cm">/* åˆ›å»ºåˆ†ç‰‡ */</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">sk_buff</span><span class="w"> </span><span class="o">*</span><span class="n">skb2</span><span class="p">;</span>

<span class="w">        </span><span class="cm">/* åˆ†é…æ–°çš„ sk_buff */</span>
<span class="w">        </span><span class="n">skb2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_skb</span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">hlen</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ll_rs</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_ATOMIC</span><span class="p">);</span>

<span class="w">        </span><span class="cm">/* å¤åˆ¶ IP å¤´éƒ¨ */</span>
<span class="w">        </span><span class="n">ip_copy_metadata</span><span class="p">(</span><span class="n">skb2</span><span class="p">,</span><span class="w"> </span><span class="n">skb</span><span class="p">);</span>

<span class="w">        </span><span class="cm">/* è®¾ç½®åˆ†ç‰‡æ ‡å¿—å’Œåç§» */</span>
<span class="w">        </span><span class="n">iph2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb2</span><span class="p">);</span>
<span class="w">        </span><span class="n">iph2</span><span class="o">-&gt;</span><span class="n">frag_off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">htons</span><span class="p">((</span><span class="n">offset</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">3</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="n">iph2</span><span class="o">-&gt;</span><span class="n">frag_off</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">htons</span><span class="p">(</span><span class="n">IP_MF</span><span class="p">);</span>

<span class="w">        </span><span class="cm">/* å‘é€åˆ†ç‰‡ */</span>
<span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">output</span><span class="p">(</span><span class="n">net</span><span class="p">,</span><span class="w"> </span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="n">skb2</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* IP é‡ç»„ */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">ipq</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inet_frag_queue</span><span class="w"> </span><span class="n">q</span><span class="p">;</span>
<span class="w">    </span><span class="n">u8</span><span class="w">         </span><span class="n">ecn</span><span class="p">;</span><span class="w">        </span><span class="cm">/* ECN æ ‡è®° */</span>
<span class="w">    </span><span class="n">u16</span><span class="w">        </span><span class="n">max_df_size</span><span class="p">;</span><span class="w"> </span><span class="cm">/* æœ€å¤§ä¸åˆ†ç‰‡å¤§å° */</span>
<span class="w">    </span><span class="kt">int</span><span class="w">        </span><span class="n">iif</span><span class="p">;</span><span class="w">        </span><span class="cm">/* è¾“å…¥æ¥å£ */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">rid</span><span class="p">;</span><span class="w">      </span><span class="cm">/* è·¯ç”± ID */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inet_peer</span><span class="w"> </span><span class="o">*</span><span class="n">peer</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">ip_frag_reasm</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ipq</span><span class="w"> </span><span class="o">*</span><span class="n">qp</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sk_buff</span><span class="w"> </span><span class="o">*</span><span class="n">skb</span><span class="p">,</span>
<span class="w">                         </span><span class="k">struct</span><span class="w"> </span><span class="nc">sk_buff</span><span class="w"> </span><span class="o">*</span><span class="n">prev_tail</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">net_device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">net</span><span class="w"> </span><span class="o">*</span><span class="n">net</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">fqdir</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">iphdr</span><span class="w"> </span><span class="o">*</span><span class="n">iph</span><span class="p">;</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">reasm_data</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* æ£€æŸ¥æ‰€æœ‰åˆ†ç‰‡æ˜¯å¦åˆ°é½ */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">INET_FRAG_COMPLETE</span><span class="p">))</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">out_fail</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* é‡ç»„åˆ†ç‰‡ */</span>
<span class="w">    </span><span class="n">reasm_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inet_frag_reasm_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="n">prev_tail</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* åˆå¹¶æ‰€æœ‰åˆ†ç‰‡ */</span>
<span class="w">    </span><span class="n">inet_frag_reasm_finish</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="n">reasm_data</span><span class="p">,</span>
<span class="w">                           </span><span class="n">ip_frag_ecn_table</span><span class="p">[</span><span class="n">qp</span><span class="o">-&gt;</span><span class="n">ecn</span><span class="p">]);</span>

<span class="w">    </span><span class="cm">/* æ›´æ–° IP å¤´éƒ¨ */</span>
<span class="w">    </span><span class="n">iph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="w">    </span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">tot_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">htons</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
<span class="w">    </span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">frag_off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="932-tcp">9.3.2 ä¼ è¾“å±‚ï¼šTCP çŠ¶æ€æœºä¸æ‹¥å¡æ§åˆ¶</h3>
<h4 id="tcp">TCP è¿æ¥ç®¡ç†</h4>
<p>TCP ä½¿ç”¨æœ‰é™çŠ¶æ€æœºç®¡ç†è¿æ¥ç”Ÿå‘½å‘¨æœŸï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* TCP çŠ¶æ€æšä¸¾ */</span>
<span class="k">enum</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">TCP_ESTABLISHED</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="n">TCP_SYN_SENT</span><span class="p">,</span>
<span class="w">    </span><span class="n">TCP_SYN_RECV</span><span class="p">,</span>
<span class="w">    </span><span class="n">TCP_FIN_WAIT1</span><span class="p">,</span>
<span class="w">    </span><span class="n">TCP_FIN_WAIT2</span><span class="p">,</span>
<span class="w">    </span><span class="n">TCP_TIME_WAIT</span><span class="p">,</span>
<span class="w">    </span><span class="n">TCP_CLOSE</span><span class="p">,</span>
<span class="w">    </span><span class="n">TCP_CLOSE_WAIT</span><span class="p">,</span>
<span class="w">    </span><span class="n">TCP_LAST_ACK</span><span class="p">,</span>
<span class="w">    </span><span class="n">TCP_LISTEN</span><span class="p">,</span>
<span class="w">    </span><span class="n">TCP_CLOSING</span><span class="p">,</span>
<span class="w">    </span><span class="n">TCP_NEW_SYN_RECV</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* TCP æ§åˆ¶å— */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">tcp_sock</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inet_connection_sock</span><span class="w"> </span><span class="n">inet_conn</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* åºåˆ—å·ç®¡ç† */</span>
<span class="w">    </span><span class="n">u32</span><span class="w">    </span><span class="n">rcv_nxt</span><span class="p">;</span><span class="w">      </span><span class="cm">/* æœŸæœ›æ¥æ”¶çš„ä¸‹ä¸€ä¸ªåºåˆ—å· */</span>
<span class="w">    </span><span class="n">u32</span><span class="w">    </span><span class="n">snd_nxt</span><span class="p">;</span><span class="w">      </span><span class="cm">/* ä¸‹ä¸€ä¸ªè¦å‘é€çš„åºåˆ—å· */</span>
<span class="w">    </span><span class="n">u32</span><span class="w">    </span><span class="n">snd_una</span><span class="p">;</span><span class="w">      </span><span class="cm">/* æœ€æ—©æœªç¡®è®¤çš„åºåˆ—å· */</span>
<span class="w">    </span><span class="n">u32</span><span class="w">    </span><span class="n">snd_wnd</span><span class="p">;</span><span class="w">      </span><span class="cm">/* å‘é€çª—å£å¤§å° */</span>
<span class="w">    </span><span class="n">u32</span><span class="w">    </span><span class="n">rcv_wnd</span><span class="p">;</span><span class="w">      </span><span class="cm">/* æ¥æ”¶çª—å£å¤§å° */</span>

<span class="w">    </span><span class="cm">/* æ‹¥å¡æ§åˆ¶ */</span>
<span class="w">    </span><span class="n">u32</span><span class="w">    </span><span class="n">snd_cwnd</span><span class="p">;</span><span class="w">     </span><span class="cm">/* æ‹¥å¡çª—å£ */</span>
<span class="w">    </span><span class="n">u32</span><span class="w">    </span><span class="n">snd_ssthresh</span><span class="p">;</span><span class="w"> </span><span class="cm">/* æ…¢å¯åŠ¨é˜ˆå€¼ */</span>
<span class="w">    </span><span class="n">u32</span><span class="w">    </span><span class="n">prior_cwnd</span><span class="p">;</span><span class="w">   </span><span class="cm">/* ä¹‹å‰çš„æ‹¥å¡çª—å£ */</span>

<span class="w">    </span><span class="cm">/* RTT ä¼°ç®— */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">minmax</span><span class="w"> </span><span class="n">rtt_min</span><span class="p">;</span><span class="w">  </span><span class="cm">/* æœ€å° RTT */</span>
<span class="w">    </span><span class="n">u32</span><span class="w">    </span><span class="n">srtt_us</span><span class="p">;</span><span class="w">      </span><span class="cm">/* å¹³æ»‘ RTT (å¾®ç§’) */</span>
<span class="w">    </span><span class="n">u32</span><span class="w">    </span><span class="n">mdev_us</span><span class="p">;</span><span class="w">      </span><span class="cm">/* RTT å¹³å‡åå·® */</span>
<span class="w">    </span><span class="n">u32</span><span class="w">    </span><span class="n">rttvar_us</span><span class="p">;</span><span class="w">    </span><span class="cm">/* RTT æ–¹å·® */</span>
<span class="w">    </span><span class="n">u32</span><span class="w">    </span><span class="n">rto</span><span class="p">;</span><span class="w">          </span><span class="cm">/* é‡ä¼ è¶…æ—¶ */</span>

<span class="w">    </span><span class="cm">/* æ‹¥å¡æ§åˆ¶ç®—æ³• */</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">tcp_congestion_ops</span><span class="w"> </span><span class="o">*</span><span class="n">icsk_ca_ops</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* é‡ä¼ é˜Ÿåˆ— */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sk_buff_head</span><span class="w"> </span><span class="n">out_of_order_queue</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">tcp_sack_block</span><span class="w"> </span><span class="n">selective_acks</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

<span class="w">    </span><span class="cm">/* æ—¶é—´æˆ³ */</span>
<span class="w">    </span><span class="n">u32</span><span class="w">    </span><span class="n">tsoffset</span><span class="p">;</span><span class="w">     </span><span class="cm">/* æ—¶é—´æˆ³åç§» */</span>
<span class="w">    </span><span class="n">u32</span><span class="w">    </span><span class="n">ts_recent</span><span class="p">;</span><span class="w">    </span><span class="cm">/* æœ€è¿‘æ¥æ”¶çš„æ—¶é—´æˆ³ */</span>
<span class="w">    </span><span class="n">u32</span><span class="w">    </span><span class="n">ts_recent_stamp</span><span class="p">;</span><span class="w"> </span><span class="cm">/* ts_recent çš„æ—¶é—´ */</span>
<span class="p">};</span>
</code></pre></div>

<h4 id="_8">ä¸‰æ¬¡æ¡æ‰‹å®ç°</h4>
<p>TCP ä¸‰æ¬¡æ¡æ‰‹çš„å†…æ ¸å®ç°æ¶‰åŠ SYN cookieã€Fast Open ç­‰ä¼˜åŒ–ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* æœåŠ¡å™¨ç«¯ï¼šå¤„ç† SYN */</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">tcp_v4_conn_request</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sock</span><span class="w"> </span><span class="o">*</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sk_buff</span><span class="w"> </span><span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">tcp_options_received</span><span class="w"> </span><span class="n">tmp_opt</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">tcp_sock</span><span class="w"> </span><span class="o">*</span><span class="n">tp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">request_sock</span><span class="w"> </span><span class="o">*</span><span class="n">req</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* SYN flood é˜²æŠ¤ï¼šSYN cookie */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sk_acceptq_is_full</span><span class="p">(</span><span class="n">sk</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">want_cookie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcp_syn_flood_action</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;TCP&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">want_cookie</span><span class="p">)</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">drop</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* åˆ†é…è¯·æ±‚å¥—æ¥å­— */</span>
<span class="w">    </span><span class="n">req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inet_reqsk_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_request_sock_ops</span><span class="p">,</span><span class="w"> </span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="o">!</span><span class="n">want_cookie</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* è§£æ TCP é€‰é¡¹ */</span>
<span class="w">    </span><span class="n">tcp_parse_options</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tmp_opt</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* åˆå§‹åŒ–åºåˆ—å· */</span>
<span class="w">    </span><span class="n">tcp_openreq_init</span><span class="p">(</span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tmp_opt</span><span class="p">,</span><span class="w"> </span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="n">sk</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* ç”Ÿæˆ SYN cookieï¼ˆå¦‚æœéœ€è¦ï¼‰ */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">want_cookie</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">isn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cookie_init_sequence</span><span class="p">(</span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">mss</span><span class="p">);</span>
<span class="w">        </span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cookie_ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp_opt</span><span class="p">.</span><span class="n">tstamp_ok</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* æ­£å¸¸çš„ ISN ç”Ÿæˆ */</span>
<span class="w">        </span><span class="n">isn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcp_v4_init_seq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* å‘é€ SYN+ACK */</span>
<span class="w">    </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcp_v4_send_synack</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="n">dst</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fl4</span><span class="p">,</span><span class="w"> </span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">skb</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* åŠ å…¥åŠè¿æ¥é˜Ÿåˆ— */</span>
<span class="w">    </span><span class="n">inet_csk_reqsk_queue_hash_add</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">TCP_TIMEOUT_INIT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* å®¢æˆ·ç«¯ï¼šå‘é€ SYN */</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">tcp_connect</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sock</span><span class="w"> </span><span class="o">*</span><span class="n">sk</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">tcp_sock</span><span class="w"> </span><span class="o">*</span><span class="n">tp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sk_buff</span><span class="w"> </span><span class="o">*</span><span class="n">buff</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* åˆ†é… SYN åŒ… */</span>
<span class="w">    </span><span class="n">buff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sk_stream_alloc_skb</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_allocation</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* åˆå§‹åŒ– TCP å¤´éƒ¨ */</span>
<span class="w">    </span><span class="n">tcp_init_nondata_skb</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span><span class="w"> </span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">write_seq</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">TCPHDR_SYN</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* TCP Fast Open */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fastopen</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">tcp_fastopen_init_key_once</span><span class="p">();</span>
<span class="w">        </span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fastopen_req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fastopen_req</span><span class="p">),</span><span class="w"> </span>
<span class="w">                                    </span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_allocation</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* è®¾ç½®åˆå§‹æ‹¥å¡çª—å£ */</span>
<span class="w">    </span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">snd_cwnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TCP_INIT_CWND</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* å¯åŠ¨é‡ä¼ å®šæ—¶å™¨ */</span>
<span class="w">    </span><span class="n">inet_csk_reset_xmit_timer</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="n">ICSK_TIME_RETRANS</span><span class="p">,</span>
<span class="w">                              </span><span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">icsk_rto</span><span class="p">,</span><span class="w"> </span><span class="n">TCP_RTO_MAX</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* å‘é€ SYN */</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">tcp_transmit_skb</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="n">buff</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_allocation</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="_9">æ‹¥å¡æ§åˆ¶ç®—æ³•</h4>
<p>Linux æ”¯æŒå¯æ’æ‹”çš„æ‹¥å¡æ§åˆ¶ç®—æ³•ï¼Œé»˜è®¤ä½¿ç”¨ CUBICï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* æ‹¥å¡æ§åˆ¶æ“ä½œæ¥å£ */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">tcp_congestion_ops</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w">    </span><span class="n">list</span><span class="p">;</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">key</span><span class="p">;</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* å¿…éœ€çš„å›è°ƒå‡½æ•° */</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">init</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sock</span><span class="w"> </span><span class="o">*</span><span class="n">sk</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">release</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sock</span><span class="w"> </span><span class="o">*</span><span class="n">sk</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* æ‹¥å¡çª—å£è°ƒæ•´ */</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">ssthresh</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sock</span><span class="w"> </span><span class="o">*</span><span class="n">sk</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">cong_avoid</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sock</span><span class="w"> </span><span class="o">*</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">ack</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">acked</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* çŠ¶æ€å˜åŒ– */</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">set_state</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sock</span><span class="w"> </span><span class="o">*</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">new_state</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">cwnd_event</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sock</span><span class="w"> </span><span class="o">*</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">tcp_ca_event</span><span class="w"> </span><span class="n">ev</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* ä¸¢åŒ…å¤„ç† */</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">in_ack_event</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sock</span><span class="w"> </span><span class="o">*</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">undo_cwnd</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sock</span><span class="w"> </span><span class="o">*</span><span class="n">sk</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">pkts_acked</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sock</span><span class="w"> </span><span class="o">*</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">ack_sample</span><span class="w"> </span><span class="o">*</span><span class="n">sample</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* BBR ä½¿ç”¨çš„å›è°ƒ */</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">min_tso_segs</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sock</span><span class="w"> </span><span class="o">*</span><span class="n">sk</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">cong_control</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sock</span><span class="w"> </span><span class="o">*</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">rate_sample</span><span class="w"> </span><span class="o">*</span><span class="n">rs</span><span class="p">);</span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="n">TCP_CA_NAME_MAX</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* CUBIC ç®—æ³•æ ¸å¿ƒ */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">bictcp_cong_avoid</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sock</span><span class="w"> </span><span class="o">*</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">ack</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">acked</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">tcp_sock</span><span class="w"> </span><span class="o">*</span><span class="n">tp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bictcp</span><span class="w"> </span><span class="o">*</span><span class="n">ca</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inet_csk_ca</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">tcp_is_cwnd_limited</span><span class="p">(</span><span class="n">sk</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tcp_in_slow_start</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* æ…¢å¯åŠ¨ï¼šæŒ‡æ•°å¢é•¿ */</span>
<span class="w">        </span><span class="n">acked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcp_slow_start</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span><span class="w"> </span><span class="n">acked</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">acked</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* æ‹¥å¡é¿å…ï¼šCUBIC å‡½æ•° */</span>
<span class="w">    </span><span class="n">bictcp_update</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span><span class="w"> </span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">snd_cwnd</span><span class="p">,</span><span class="w"> </span><span class="n">acked</span><span class="p">);</span>
<span class="w">    </span><span class="n">tcp_cong_avoid_ai</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span><span class="w"> </span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="p">,</span><span class="w"> </span><span class="n">acked</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* CUBIC æ›´æ–°å‡½æ•° */</span>
<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">bictcp_update</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bictcp</span><span class="w"> </span><span class="o">*</span><span class="n">ca</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">cwnd</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">acked</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="n">bic_target</span><span class="p">,</span><span class="w"> </span><span class="n">max_cnt</span><span class="p">;</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">offs</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>

<span class="w">    </span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">ack_cnt</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">acked</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">last_cwnd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">cwnd</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="p">(</span><span class="n">s32</span><span class="p">)(</span><span class="n">tcp_jiffies32</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">last_time</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">HZ</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* CUBIC å‡½æ•°ï¼šW(t) = C * (t - K)^3 + Wmax */</span>
<span class="w">    </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">s32</span><span class="p">)(</span><span class="n">tcp_jiffies32</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">epoch_start</span><span class="p">);</span>
<span class="w">    </span><span class="n">t</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">delay_min</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* è®¡ç®— K = cubic_root(Wmax * beta / C) */</span>
<span class="w">    </span><span class="n">K</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">K</span><span class="p">;</span>

<span class="w">    </span><span class="n">offs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">ack_cnt</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">delta</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">K</span><span class="p">)</span>
<span class="w">        </span><span class="n">bic_target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">origin_point</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">delta</span><span class="p">;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">bic_target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">origin_point</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">delta</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* æ›´æ–°æ‹¥å¡çª—å£ */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bic_target</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">cwnd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cwnd</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">bic_target</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cwnd</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cwnd</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="_10">å¿«é€Ÿé‡ä¼ ä¸æ¢å¤</h4>
<p>TCP ä½¿ç”¨ SACKï¼ˆSelective Acknowledgmentï¼‰å®ç°é«˜æ•ˆçš„ä¸¢åŒ…æ¢å¤ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* å¿«é€Ÿé‡ä¼ åˆ¤å®š */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">tcp_time_to_recover</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sock</span><span class="w"> </span><span class="o">*</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">tcp_sock</span><span class="w"> </span><span class="o">*</span><span class="n">tp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* æ¡ä»¶1ï¼šæ”¶åˆ°3ä¸ªé‡å¤ ACK */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fackets_out</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">reordering</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* æ¡ä»¶2ï¼šSACK æ£€æµ‹åˆ°ä¸¢åŒ… */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tcp_is_sack</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lost_out</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* æ¡ä»¶3ï¼šFACK æ£€æµ‹ */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tcp_is_fack</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fackets_out</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">reordering</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* è¿›å…¥å¿«é€Ÿæ¢å¤ */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">tcp_enter_recovery</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sock</span><span class="w"> </span><span class="o">*</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">ece_ack</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">tcp_sock</span><span class="w"> </span><span class="o">*</span><span class="n">tp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mib_idx</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* ä¿å­˜å½“å‰çŠ¶æ€ */</span>
<span class="w">    </span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">prior_ssthresh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">tcp_init_undo</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* è°ƒæ•´æ‹¥å¡çª—å£ */</span>
<span class="w">    </span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">snd_ssthresh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcp_current_ssthresh</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="w">    </span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">snd_cwnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">snd_ssthresh</span><span class="p">;</span>
<span class="w">    </span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">snd_cwnd_cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">prior_cwnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">snd_cwnd</span><span class="p">;</span>
<span class="w">    </span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">prr_delivered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">prr_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* è®¾ç½®æ¢å¤ç‚¹ */</span>
<span class="w">    </span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">recovery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">snd_nxt</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* è¿›å…¥æ¢å¤çŠ¶æ€ */</span>
<span class="w">    </span><span class="n">tcp_set_ca_state</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="n">TCP_CA_Recovery</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="933-socket-api">9.3.3 å¥—æ¥å­—å±‚ï¼šsocket API å®ç°</h3>
<h4 id="socket">socket ç»“æ„ä½“ç³»</h4>
<p>Linux å¥—æ¥å­—å±‚æä¾›ç»Ÿä¸€çš„ç¼–ç¨‹æ¥å£ï¼Œå±è”½åº•å±‚åè®®å·®å¼‚ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* é€šç”¨å¥—æ¥å­—ç»“æ„ */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">socket</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">socket_state</span><span class="w">        </span><span class="n">state</span><span class="p">;</span><span class="w">      </span><span class="cm">/* å¥—æ¥å­—çŠ¶æ€ */</span>
<span class="w">    </span><span class="kt">short</span><span class="w">               </span><span class="n">type</span><span class="p">;</span><span class="w">       </span><span class="cm">/* SOCK_STREAM, SOCK_DGRAM ç­‰ */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">       </span><span class="n">flags</span><span class="p">;</span><span class="w">      </span><span class="cm">/* å¥—æ¥å­—æ ‡å¿— */</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w">        </span><span class="o">*</span><span class="n">file</span><span class="p">;</span><span class="w">       </span><span class="cm">/* å…³è”çš„æ–‡ä»¶å¯¹è±¡ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sock</span><span class="w">        </span><span class="o">*</span><span class="n">sk</span><span class="p">;</span><span class="w">         </span><span class="cm">/* ç½‘ç»œå±‚å¥—æ¥å­— */</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">proto_ops</span><span class="w"> </span><span class="o">*</span><span class="n">ops</span><span class="p">;</span><span class="w">    </span><span class="cm">/* åè®®æ“ä½œå‡½æ•°è¡¨ */</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">socket_wq</span><span class="w">    </span><span class="n">wq</span><span class="p">;</span><span class="w">         </span><span class="cm">/* ç­‰å¾…é˜Ÿåˆ— */</span>
<span class="p">};</span>

<span class="cm">/* ç½‘ç»œå±‚å¥—æ¥å­— */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">sock</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sock_common</span><span class="w">  </span><span class="n">__sk_common</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* æ¥æ”¶é˜Ÿåˆ— */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sk_buff_head</span><span class="w"> </span><span class="n">sk_receive_queue</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sk_buff_head</span><span class="w"> </span><span class="n">sk_write_queue</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* å†…å­˜ç®¡ç† */</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w">            </span><span class="n">sk_rmem_alloc</span><span class="p">;</span><span class="w">  </span><span class="cm">/* æ¥æ”¶ç¼“å†²åŒºå¤§å° */</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w">            </span><span class="n">sk_wmem_alloc</span><span class="p">;</span><span class="w">  </span><span class="cm">/* å‘é€ç¼“å†²åŒºå¤§å° */</span>
<span class="w">    </span><span class="kt">int</span><span class="w">                 </span><span class="n">sk_sndbuf</span><span class="p">;</span><span class="w">      </span><span class="cm">/* å‘é€ç¼“å†²åŒºé™åˆ¶ */</span>
<span class="w">    </span><span class="kt">int</span><span class="w">                 </span><span class="n">sk_rcvbuf</span><span class="p">;</span><span class="w">      </span><span class="cm">/* æ¥æ”¶ç¼“å†²åŒºé™åˆ¶ */</span>

<span class="w">    </span><span class="cm">/* å›è°ƒå‡½æ•° */</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">sk_state_change</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sock</span><span class="w"> </span><span class="o">*</span><span class="n">sk</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">sk_data_ready</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sock</span><span class="w"> </span><span class="o">*</span><span class="n">sk</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">sk_write_space</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sock</span><span class="w"> </span><span class="o">*</span><span class="n">sk</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">sk_error_report</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sock</span><span class="w"> </span><span class="o">*</span><span class="n">sk</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* åè®®ç›¸å…³ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">proto</span><span class="w">       </span><span class="o">*</span><span class="n">sk_prot</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">proto_ops</span><span class="w"> </span><span class="o">*</span><span class="n">sk_prot_creator</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* åè®®æ“ä½œå‡½æ•°è¡¨ */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">proto_ops</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">bind</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">socket</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sockaddr</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">connect</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">socket</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sockaddr</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">accept</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">socket</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">socket</span><span class="w"> </span><span class="o">*</span><span class="n">newsock</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">listen</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">socket</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">sendmsg</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">socket</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">msghdr</span><span class="w"> </span><span class="o">*</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">recvmsg</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">socket</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">msghdr</span><span class="w"> </span><span class="o">*</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="cm">/* ... */</span>
<span class="p">};</span>
</code></pre></div>

<h4 id="_11">ç³»ç»Ÿè°ƒç”¨å®ç°</h4>
<p>å¥—æ¥å­—ç³»ç»Ÿè°ƒç”¨çš„å†…æ ¸å®ç°ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* socket() ç³»ç»Ÿè°ƒç”¨ */</span>
<span class="n">SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">family</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">protocol</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">socket</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">retval</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* åˆ›å»ºå¥—æ¥å­— */</span>
<span class="w">    </span><span class="n">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sock_create</span><span class="p">(</span><span class="n">family</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">protocol</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sock</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">retval</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">retval</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* åˆ†é…æ–‡ä»¶æè¿°ç¬¦ */</span>
<span class="w">    </span><span class="n">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sock_map_fd</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">O_CLOEXEC</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">O_NONBLOCK</span><span class="p">));</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">retval</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">out_release</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* bind() å®ç° */</span>
<span class="n">SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">bind</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sockaddr</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">umyaddr</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">addrlen</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">socket</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sockaddr_storage</span><span class="w"> </span><span class="n">address</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* è·å–å¥—æ¥å­— */</span>
<span class="w">    </span><span class="n">sock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sockfd_lookup_light</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">err</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fput_needed</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">sock</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* å¤åˆ¶åœ°å€ */</span>
<span class="w">    </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">move_addr_to_kernel</span><span class="p">(</span><span class="n">umyaddr</span><span class="p">,</span><span class="w"> </span><span class="n">addrlen</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">address</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">bind</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sockaddr</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">addrlen</span><span class="p">);</span>

<span class="w">    </span><span class="n">fput_light</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">fput_needed</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* send() æ•°æ®å‘é€è·¯å¾„ */</span>
<span class="n">SYSCALL_DEFINE6</span><span class="p">(</span><span class="n">sendto</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">buff</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">,</span>
<span class="w">                </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sockaddr</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span>
<span class="w">                </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">addr_len</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">socket</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">msghdr</span><span class="w"> </span><span class="n">msg</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">iovec</span><span class="w"> </span><span class="n">iov</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* æ„é€ æ¶ˆæ¯ç»“æ„ */</span>
<span class="w">    </span><span class="n">iov</span><span class="p">.</span><span class="n">iov_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buff</span><span class="p">;</span>
<span class="w">    </span><span class="n">iov</span><span class="p">.</span><span class="n">iov_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<span class="w">    </span><span class="n">msg</span><span class="p">.</span><span class="n">msg_iov</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">iov</span><span class="p">;</span>
<span class="w">    </span><span class="n">msg</span><span class="p">.</span><span class="n">msg_iovlen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">msg</span><span class="p">.</span><span class="n">msg_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* è®¾ç½®ç›®æ ‡åœ°å€ */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">move_addr_to_kernel</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">addr_len</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">address</span><span class="p">);</span>
<span class="w">        </span><span class="n">msg</span><span class="p">.</span><span class="n">msg_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sockaddr</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">address</span><span class="p">;</span>
<span class="w">        </span><span class="n">msg</span><span class="p">.</span><span class="n">msg_namelen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addr_len</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* è°ƒç”¨åè®®å±‚å‘é€ */</span>
<span class="w">    </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">sendmsg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="io">å¼‚æ­¥ I/O æ”¯æŒ</h4>
<p>Linux 5.1 å¼•å…¥çš„ io_uring ä¸ºç½‘ç»œç¼–ç¨‹å¸¦æ¥é©å‘½æ€§æ”¹è¿›ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* io_uring ç½‘ç»œæ“ä½œ */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">io_send</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">io_kiocb</span><span class="w"> </span><span class="o">*</span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">issue_flags</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">io_sr_msg</span><span class="w"> </span><span class="o">*</span><span class="n">sr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">sr_msg</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">socket</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">msghdr</span><span class="w"> </span><span class="n">msg</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">    </span><span class="n">sock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sock_from_file</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">sock</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOTSOCK</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* æ„é€ æ¶ˆæ¯ */</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io_setup_async_msg</span><span class="p">(</span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="n">issue_flags</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* éé˜»å¡å‘é€ */</span>
<span class="w">    </span><span class="n">msg</span><span class="p">.</span><span class="n">msg_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">msg_flags</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MSG_NOSIGNAL</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">issue_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">IO_URING_F_NONBLOCK</span><span class="p">)</span>
<span class="w">        </span><span class="n">msg</span><span class="p">.</span><span class="n">msg_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">MSG_DONTWAIT</span><span class="p">;</span>

<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sock_sendmsg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* å¤„ç† EAGAIN */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="n">EAGAIN</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">issue_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">IO_URING_F_NONBLOCK</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* å®Œæˆè¯·æ±‚ */</span>
<span class="w">    </span><span class="n">io_req_complete</span><span class="p">(</span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="934-time_wait">9.3.4 è¿æ¥ç®¡ç†ä¸ TIME_WAIT ä¼˜åŒ–</h3>
<h4 id="time_wait">TIME_WAIT çŠ¶æ€ç®¡ç†</h4>
<p>TIME_WAIT çŠ¶æ€ç¡®ä¿å»¶è¿Ÿæ•°æ®åŒ…ä¸ä¼šå¹²æ‰°æ–°è¿æ¥ï¼Œä½†å¤§é‡ TIME_WAIT ä¼šæ¶ˆè€—èµ„æºï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* TIME_WAIT å¥—æ¥å­—ç»“æ„ï¼ˆç²¾ç®€ç‰ˆï¼‰ */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">inet_timewait_sock</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sock_common</span><span class="w">  </span><span class="n">__tw_common</span><span class="p">;</span>

<span class="w">    </span><span class="kt">int</span><span class="w">                 </span><span class="n">tw_timeout</span><span class="p">;</span><span class="w">     </span><span class="cm">/* TIME_WAIT è¶…æ—¶æ—¶é—´ */</span>
<span class="w">    </span><span class="k">volatile</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">tw_substate</span><span class="p">;</span><span class="w"> </span><span class="cm">/* å­çŠ¶æ€ */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w">       </span><span class="n">tw_rcv_wscale</span><span class="p">;</span><span class="w">  </span><span class="cm">/* æ¥æ”¶çª—å£ç¼©æ”¾ */</span>

<span class="w">    </span><span class="cm">/* è¿™äº›å­—æ®µä» struct tcp_sock å¤åˆ¶ */</span>
<span class="w">    </span><span class="n">__be16</span><span class="w">              </span><span class="n">tw_sport</span><span class="p">;</span><span class="w">       </span><span class="cm">/* æºç«¯å£ */</span>
<span class="w">    </span><span class="n">__be16</span><span class="w">              </span><span class="n">tw_dport</span><span class="p">;</span><span class="w">       </span><span class="cm">/* ç›®çš„ç«¯å£ */</span>
<span class="w">    </span><span class="n">__u32</span><span class="w">               </span><span class="n">tw_rcv_nxt</span><span class="p">;</span><span class="w">     </span><span class="cm">/* æœŸæœ›æ¥æ”¶åºåˆ—å· */</span>
<span class="w">    </span><span class="n">__u32</span><span class="w">               </span><span class="n">tw_snd_nxt</span><span class="p">;</span><span class="w">     </span><span class="cm">/* ä¸‹ä¸€ä¸ªå‘é€åºåˆ—å· */</span>
<span class="w">    </span><span class="n">__u32</span><span class="w">               </span><span class="n">tw_rcv_wnd</span><span class="p">;</span><span class="w">     </span><span class="cm">/* æ¥æ”¶çª—å£ */</span>
<span class="w">    </span><span class="n">__u32</span><span class="w">               </span><span class="n">tw_ts_recent</span><span class="p">;</span><span class="w">   </span><span class="cm">/* æ—¶é—´æˆ³ */</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">timer_list</span><span class="w">   </span><span class="n">tw_timer</span><span class="p">;</span><span class="w">       </span><span class="cm">/* TIME_WAIT å®šæ—¶å™¨ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inet_bind_bucket</span><span class="w"> </span><span class="o">*</span><span class="n">tw_tb</span><span class="p">;</span><span class="w">     </span><span class="cm">/* ç»‘å®šå“ˆå¸Œæ¡¶ */</span>
<span class="p">};</span>

<span class="cm">/* è¿›å…¥ TIME_WAIT çŠ¶æ€ */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">tcp_time_wait</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sock</span><span class="w"> </span><span class="o">*</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">timeo</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inet_timewait_sock</span><span class="w"> </span><span class="o">*</span><span class="n">tw</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">tcp_sock</span><span class="w"> </span><span class="o">*</span><span class="n">tp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* åˆ†é… timewait å¥—æ¥å­— */</span>
<span class="w">    </span><span class="n">tw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inet_twsk_alloc</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tw</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* å¤åˆ¶å¿…è¦å­—æ®µ */</span>
<span class="w">        </span><span class="n">tw</span><span class="o">-&gt;</span><span class="n">tw_rcv_wscale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_opt</span><span class="p">.</span><span class="n">rcv_wscale</span><span class="p">;</span>
<span class="w">        </span><span class="n">tw</span><span class="o">-&gt;</span><span class="n">tw_rcv_nxt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span><span class="p">;</span>
<span class="w">        </span><span class="n">tw</span><span class="o">-&gt;</span><span class="n">tw_snd_nxt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">snd_nxt</span><span class="p">;</span>
<span class="w">        </span><span class="n">tw</span><span class="o">-&gt;</span><span class="n">tw_rcv_wnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcp_receive_window</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="w">        </span><span class="n">tw</span><span class="o">-&gt;</span><span class="n">tw_ts_recent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_opt</span><span class="p">.</span><span class="n">ts_recent</span><span class="p">;</span>
<span class="w">        </span><span class="n">tw</span><span class="o">-&gt;</span><span class="n">tw_ts_recent_stamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_opt</span><span class="p">.</span><span class="n">ts_recent_stamp</span><span class="p">;</span>

<span class="w">        </span><span class="cm">/* è®¾ç½® TIME_WAIT å®šæ—¶å™¨ */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">timeo</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="n">timeo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TCP_TIMEWAIT_LEN</span><span class="p">;</span><span class="w">  </span><span class="cm">/* é»˜è®¤ 60 ç§’ */</span>

<span class="w">        </span><span class="n">inet_twsk_schedule</span><span class="p">(</span><span class="n">tw</span><span class="p">,</span><span class="w"> </span><span class="n">timeo</span><span class="p">);</span>

<span class="w">        </span><span class="cm">/* å°†åŸå§‹å¥—æ¥å­—è½¬æ¢ä¸º timewait */</span>
<span class="w">        </span><span class="n">inet_twsk_hashdance</span><span class="p">(</span><span class="n">tw</span><span class="p">,</span><span class="w"> </span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tcp_hashinfo</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* é”€æ¯åŸå§‹å¥—æ¥å­— */</span>
<span class="w">    </span><span class="n">tcp_done</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="time_wait_1">TIME_WAIT ä¼˜åŒ–ç­–ç•¥</h4>
<p>Linux æä¾›å¤šç§æœºåˆ¶ä¼˜åŒ– TIME_WAITï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* 1. TIME_WAIT é‡ç”¨ï¼ˆtw_reuseï¼‰ */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">tcp_tw_reuse_check</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">inet_timewait_sock</span><span class="w"> </span><span class="o">*</span><span class="n">tw</span><span class="p">,</span>
<span class="w">                               </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">tcp_options_received</span><span class="w"> </span><span class="o">*</span><span class="n">rx_opt</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="cm">/* æ£€æŸ¥æ—¶é—´æˆ³ï¼Œç¡®ä¿ä¸ä¼šæ¥æ”¶æ—§æ•°æ®åŒ… */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rx_opt</span><span class="o">-&gt;</span><span class="n">ts_recent</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="n">get_seconds</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tw</span><span class="o">-&gt;</span><span class="n">tw_ts_recent_stamp</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* 2. TIME_WAIT å›æ”¶ï¼ˆtw_recycleï¼‰- å·²åºŸå¼ƒ */</span>
<span class="cm">/* ç”±äº NAT ç¯å¢ƒé—®é¢˜ï¼Œ4.12 å†…æ ¸å·²ç§»é™¤ */</span>

<span class="cm">/* 3. TIME_WAIT æš—æ€ï¼ˆtw_killï¼‰ */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">inet_twsk_kill</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inet_timewait_sock</span><span class="w"> </span><span class="o">*</span><span class="n">tw</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inet_hashinfo</span><span class="w"> </span><span class="o">*</span><span class="n">hashinfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tw</span><span class="o">-&gt;</span><span class="n">tw_dr</span><span class="o">-&gt;</span><span class="n">hashinfo</span><span class="p">;</span>
<span class="w">    </span><span class="n">spinlock_t</span><span class="w"> </span><span class="o">*</span><span class="n">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inet_ehash_lockp</span><span class="p">(</span><span class="n">hashinfo</span><span class="p">,</span><span class="w"> </span><span class="n">tw</span><span class="o">-&gt;</span><span class="n">tw_hash</span><span class="p">);</span>

<span class="w">    </span><span class="n">spin_lock</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hlist_nulls_unhashed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tw</span><span class="o">-&gt;</span><span class="n">tw_node</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">spin_unlock</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* ä»å“ˆå¸Œè¡¨ç§»é™¤ */</span>
<span class="w">    </span><span class="n">hlist_nulls_del_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tw</span><span class="o">-&gt;</span><span class="n">tw_node</span><span class="p">);</span>
<span class="w">    </span><span class="n">sk_nulls_node_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tw</span><span class="o">-&gt;</span><span class="n">tw_node</span><span class="p">);</span>
<span class="w">    </span><span class="n">spin_unlock</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* é‡Šæ”¾ç«¯å£ */</span>
<span class="w">    </span><span class="n">inet_twsk_bind_unhash</span><span class="p">(</span><span class="n">tw</span><span class="p">,</span><span class="w"> </span><span class="n">hashinfo</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* é‡Šæ”¾å†…å­˜ */</span>
<span class="w">    </span><span class="n">inet_twsk_put</span><span class="p">(</span><span class="n">tw</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* 4. SO_LINGER é€‰é¡¹ */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">linger</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">l_onoff</span><span class="p">;</span><span class="w">    </span><span class="cm">/* 0 = off, é0 = on */</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">l_linger</span><span class="p">;</span><span class="w">   </span><span class="cm">/* å»¶è¿Ÿæ—¶é—´ï¼ˆç§’ï¼‰ */</span>
<span class="p">};</span>

<span class="cm">/* è®¾ç½® SO_LINGER è·³è¿‡ TIME_WAIT */</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_linger</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_lingertime</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* l_onoff = 1, l_linger = 0: ç«‹å³å…³é—­ï¼Œå‘é€ RST */</span>
<span class="w">    </span><span class="n">tcp_send_active_reset</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="n">gfp_any</span><span class="p">());</span>
<span class="w">    </span><span class="n">tcp_done</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* æ­£å¸¸å…³é—­æµç¨‹ */</span>
<span class="w">    </span><span class="n">tcp_close_state</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="_12">è¿æ¥è¡¨ç®¡ç†</h4>
<p>Linux ä½¿ç”¨å“ˆå¸Œè¡¨ç®¡ç†å¤§é‡å¹¶å‘è¿æ¥ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* TCP è¿æ¥å“ˆå¸Œè¡¨ */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">inet_hashinfo</span><span class="w"> </span><span class="n">tcp_hashinfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">ehash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w">          </span><span class="cm">/* established å“ˆå¸Œè¡¨ */</span>
<span class="w">    </span><span class="p">.</span><span class="n">ehash_locks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w">    </span><span class="cm">/* å“ˆå¸Œé”æ•°ç»„ */</span>
<span class="w">    </span><span class="p">.</span><span class="n">ehash_mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">        </span><span class="cm">/* å“ˆå¸Œæ©ç  */</span>
<span class="w">    </span><span class="p">.</span><span class="n">ehash_locks_mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>

<span class="w">    </span><span class="p">.</span><span class="n">bhash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w">          </span><span class="cm">/* bind å“ˆå¸Œè¡¨ */</span>
<span class="w">    </span><span class="p">.</span><span class="n">bhash_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>

<span class="w">    </span><span class="p">.</span><span class="n">lhash2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w">         </span><span class="cm">/* listen å“ˆå¸Œè¡¨ */</span>
<span class="w">    </span><span class="p">.</span><span class="n">lhash2_mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* è¿æ¥æŸ¥æ‰¾ */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">sock</span><span class="w"> </span><span class="o">*</span><span class="n">__inet_lookup_established</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">net</span><span class="w"> </span><span class="o">*</span><span class="n">net</span><span class="p">,</span>
<span class="w">                                        </span><span class="k">struct</span><span class="w"> </span><span class="nc">inet_hashinfo</span><span class="w"> </span><span class="o">*</span><span class="n">hashinfo</span><span class="p">,</span>
<span class="w">                                        </span><span class="k">const</span><span class="w"> </span><span class="n">__be32</span><span class="w"> </span><span class="n">saddr</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">__be16</span><span class="w"> </span><span class="n">sport</span><span class="p">,</span>
<span class="w">                                        </span><span class="k">const</span><span class="w"> </span><span class="n">__be32</span><span class="w"> </span><span class="n">daddr</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">u16</span><span class="w"> </span><span class="n">hnum</span><span class="p">,</span>
<span class="w">                                        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">dif</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">INET_ADDR_COOKIE</span><span class="p">(</span><span class="n">acookie</span><span class="p">,</span><span class="w"> </span><span class="n">saddr</span><span class="p">,</span><span class="w"> </span><span class="n">daddr</span><span class="p">);</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">__portpair</span><span class="w"> </span><span class="n">ports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">INET_COMBINED_PORTS</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span><span class="w"> </span><span class="n">hnum</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sock</span><span class="w"> </span><span class="o">*</span><span class="n">sk</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_nulls_node</span><span class="w"> </span><span class="o">*</span><span class="n">node</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* è®¡ç®—å“ˆå¸Œå€¼ */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inet_ehashfn</span><span class="p">(</span><span class="n">net</span><span class="p">,</span><span class="w"> </span><span class="n">daddr</span><span class="p">,</span><span class="w"> </span><span class="n">hnum</span><span class="p">,</span><span class="w"> </span><span class="n">saddr</span><span class="p">,</span><span class="w"> </span><span class="n">sport</span><span class="p">);</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">slot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">hashinfo</span><span class="o">-&gt;</span><span class="n">ehash_mask</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inet_ehash_bucket</span><span class="w"> </span><span class="o">*</span><span class="n">head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">hashinfo</span><span class="o">-&gt;</span><span class="n">ehash</span><span class="p">[</span><span class="n">slot</span><span class="p">];</span>

<span class="w">    </span><span class="cm">/* RCU è¯»é”ä¿æŠ¤ */</span>
<span class="w">    </span><span class="n">rcu_read_lock</span><span class="p">();</span>
<span class="nl">begin</span><span class="p">:</span>
<span class="w">    </span><span class="n">sk_nulls_for_each_rcu</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_hash</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">hash</span><span class="p">)</span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span>

<span class="w">        </span><span class="cm">/* å¿«é€Ÿè·¯å¾„ï¼šcookie åŒ¹é… */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">INET_MATCH</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="n">net</span><span class="p">,</span><span class="w"> </span><span class="n">acookie</span><span class="p">,</span><span class="w"> </span><span class="n">saddr</span><span class="p">,</span><span class="w"> </span><span class="n">daddr</span><span class="p">,</span><span class="w"> </span>
<span class="w">                              </span><span class="n">ports</span><span class="p">,</span><span class="w"> </span><span class="n">dif</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">refcount_inc_not_zero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_refcnt</span><span class="p">)))</span>
<span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>

<span class="w">            </span><span class="cm">/* å†æ¬¡æ£€æŸ¥ï¼ˆé˜²æ­¢å¹¶å‘åˆ é™¤ï¼‰ */</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">INET_MATCH</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="n">net</span><span class="p">,</span><span class="w"> </span><span class="n">acookie</span><span class="p">,</span><span class="w"> </span><span class="n">saddr</span><span class="p">,</span><span class="w"> </span><span class="n">daddr</span><span class="p">,</span>
<span class="w">                                     </span><span class="n">ports</span><span class="p">,</span><span class="w"> </span><span class="n">dif</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">sock_gen_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
<span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">begin</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">found</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* æ£€æŸ¥æ˜¯å¦éœ€è¦é‡è¯•ï¼ˆNULLS ä¿æŠ¤ï¼‰ */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">get_nulls_value</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">slot</span><span class="p">)</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">begin</span><span class="p">;</span>

<span class="nl">out</span><span class="p">:</span>
<span class="w">    </span><span class="n">sk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="nl">found</span><span class="p">:</span>
<span class="w">    </span><span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">sk</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="_13">ç«¯å£ç®¡ç†ä¸å¤ç”¨</h4>
<p>Linux æ”¯æŒ SO_REUSEADDR å’Œ SO_REUSEPORT å®ç°ç«¯å£å¤ç”¨ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* SO_REUSEPORT å®ç°è´Ÿè½½å‡è¡¡ */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">sock</span><span class="w"> </span><span class="o">*</span><span class="n">inet_lookup_listener</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">net</span><span class="w"> </span><span class="o">*</span><span class="n">net</span><span class="p">,</span>
<span class="w">                                   </span><span class="k">struct</span><span class="w"> </span><span class="nc">inet_hashinfo</span><span class="w"> </span><span class="o">*</span><span class="n">hashinfo</span><span class="p">,</span>
<span class="w">                                   </span><span class="k">struct</span><span class="w"> </span><span class="nc">sk_buff</span><span class="w"> </span><span class="o">*</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">doff</span><span class="p">,</span>
<span class="w">                                   </span><span class="k">const</span><span class="w"> </span><span class="n">__be32</span><span class="w"> </span><span class="n">saddr</span><span class="p">,</span><span class="w"> </span><span class="n">__be16</span><span class="w"> </span><span class="n">sport</span><span class="p">,</span>
<span class="w">                                   </span><span class="k">const</span><span class="w"> </span><span class="n">__be32</span><span class="w"> </span><span class="n">daddr</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">short</span><span class="w"> </span><span class="n">hnum</span><span class="p">,</span>
<span class="w">                                   </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">dif</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">sdif</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sock</span><span class="w"> </span><span class="o">*</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inet_listen_hashbucket</span><span class="w"> </span><span class="o">*</span><span class="n">ilb</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inet_lhashfn</span><span class="p">(</span><span class="n">net</span><span class="p">,</span><span class="w"> </span><span class="n">hnum</span><span class="p">);</span>

<span class="w">    </span><span class="n">ilb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">hashinfo</span><span class="o">-&gt;</span><span class="n">listening_hash</span><span class="p">[</span><span class="n">hash</span><span class="p">];</span>

<span class="w">    </span><span class="cm">/* æŸ¥æ‰¾ç›‘å¬å¥—æ¥å­— */</span>
<span class="w">    </span><span class="n">sk_for_each_rcu</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ilb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compute_score</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="n">net</span><span class="p">,</span><span class="w"> </span><span class="n">hnum</span><span class="p">,</span><span class="w"> </span><span class="n">daddr</span><span class="p">,</span><span class="w"> </span><span class="n">dif</span><span class="p">,</span><span class="w"> </span><span class="n">sdif</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">score</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">hiscore</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">hiscore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">score</span><span class="p">;</span>
<span class="w">            </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sk</span><span class="p">;</span>

<span class="w">            </span><span class="cm">/* SO_REUSEPORT è´Ÿè½½å‡è¡¡ */</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_reuseport</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">phash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inet_ehashfn</span><span class="p">(</span><span class="n">net</span><span class="p">,</span><span class="w"> </span><span class="n">daddr</span><span class="p">,</span><span class="w"> </span><span class="n">hnum</span><span class="p">,</span><span class="w"> </span><span class="n">saddr</span><span class="p">,</span><span class="w"> </span><span class="n">sport</span><span class="p">);</span>

<span class="w">                </span><span class="cm">/* ä½¿ç”¨åŒ…å“ˆå¸Œé€‰æ‹©å¥—æ¥å­— */</span>
<span class="w">                </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reuseport_select_sock</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="n">phash</span><span class="p">,</span><span class="w"> </span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="n">doff</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* REUSEPORT ç»„ç®¡ç† */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">sock_reuseport</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rcu_head</span><span class="w">     </span><span class="n">rcu</span><span class="p">;</span>

<span class="w">    </span><span class="n">u16</span><span class="w">                 </span><span class="n">max_socks</span><span class="p">;</span><span class="w">      </span><span class="cm">/* æ•°ç»„å¤§å° */</span>
<span class="w">    </span><span class="n">u16</span><span class="w">                 </span><span class="n">num_socks</span><span class="p">;</span><span class="w">      </span><span class="cm">/* å½“å‰å¥—æ¥å­—æ•° */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">        </span><span class="n">synq_overflow_ts</span><span class="p">;</span><span class="w"> </span><span class="cm">/* SYN é˜Ÿåˆ—æº¢å‡ºæ—¶é—´æˆ³ */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">        </span><span class="n">reuseport_id</span><span class="p">;</span><span class="w">   </span><span class="cm">/* ID */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">        </span><span class="n">bind_inany</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span><span class="w">   </span><span class="cm">/* ç»‘å®šä»»æ„åœ°å€ */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">        </span><span class="n">has_conns</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span><span class="w">    </span><span class="cm">/* æœ‰å·²å»ºç«‹è¿æ¥ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_prog</span><span class="w"> </span><span class="n">__rcu</span><span class="w"> </span><span class="o">*</span><span class="n">prog</span><span class="p">;</span><span class="w">        </span><span class="cm">/* eBPF ç¨‹åº */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sock</span><span class="w">        </span><span class="o">*</span><span class="n">socks</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w">       </span><span class="cm">/* å¥—æ¥å­—æ•°ç»„ */</span>
<span class="p">};</span>
</code></pre></div>

<hr />
<h2 id="92-sk_buff_1">9.2 sk_buff ä¸ç½‘ç»œæ•°æ®æµ</h2>
<p>sk_buffï¼ˆsocket bufferï¼‰æ˜¯ Linux ç½‘ç»œæ ˆçš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œæ¯ä¸ªç½‘ç»œæ•°æ®åŒ…åœ¨å†…æ ¸ä¸­éƒ½ç”±ä¸€ä¸ª sk_buff ç»“æ„è¡¨ç¤ºã€‚è¿™ä¸ªç²¾å¿ƒè®¾è®¡çš„æ•°æ®ç»“æ„æ”¯æŒé«˜æ•ˆçš„é›¶æ‹·è´æ“ä½œã€åè®®å¤´éƒ¨çš„åŠ¨æ€æ·»åŠ åˆ é™¤ï¼Œä»¥åŠæ•°æ®åŒ…çš„åˆ†ç‰‡ä¸é‡ç»„ã€‚</p>
<h3 id="921-sk_buff">9.2.1 sk_buff ç»“æ„ä½“è¯¦è§£</h3>
<p>sk_buff ç»“æ„ä½“åŒ…å«äº†æ•°æ®åŒ…çš„æ‰€æœ‰å…ƒä¿¡æ¯å’ŒæŒ‡å‘å®é™…æ•°æ®çš„æŒ‡é’ˆï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">sk_buff</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* é“¾è¡¨ç®¡ç† */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sk_buff</span><span class="w">    </span><span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sk_buff</span><span class="w">    </span><span class="o">*</span><span class="n">prev</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* æ—¶é—´æˆ³ */</span>
<span class="w">    </span><span class="n">ktime_t</span><span class="w">           </span><span class="n">tstamp</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* å…³è”çš„ç½‘ç»œè®¾å¤‡ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">net_device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* å…³è”çš„ socket */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sock</span><span class="w">       </span><span class="o">*</span><span class="n">sk</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* æ•°æ®æŒ‡é’ˆ </span>

<span class="cm">     * head: ç¼“å†²åŒºèµ·å§‹åœ°å€</span>
<span class="cm">     * data: æœ‰æ•ˆæ•°æ®èµ·å§‹åœ°å€  </span>
<span class="cm">     * tail: æœ‰æ•ˆæ•°æ®ç»“æŸåœ°å€</span>
<span class="cm">     * end:  ç¼“å†²åŒºç»“æŸåœ°å€</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w">     </span><span class="o">*</span><span class="n">head</span><span class="p">,</span>
<span class="w">                      </span><span class="o">*</span><span class="n">data</span><span class="p">,</span>
<span class="w">                      </span><span class="o">*</span><span class="n">tail</span><span class="p">,</span>
<span class="w">                      </span><span class="o">*</span><span class="n">end</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* ä¼ è¾“å±‚å¤´éƒ¨æŒ‡é’ˆ */</span>
<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">tcphdr</span><span class="w">  </span><span class="o">*</span><span class="n">th</span><span class="p">;</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">udphdr</span><span class="w">  </span><span class="o">*</span><span class="n">uh</span><span class="p">;</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">icmphdr</span><span class="w"> </span><span class="o">*</span><span class="n">icmph</span><span class="p">;</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w">  </span><span class="o">*</span><span class="n">raw</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">h</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* ç½‘ç»œå±‚å¤´éƒ¨æŒ‡é’ˆ */</span>
<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">iphdr</span><span class="w">   </span><span class="o">*</span><span class="n">iph</span><span class="p">;</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">ipv6hdr</span><span class="w"> </span><span class="o">*</span><span class="n">ipv6h</span><span class="p">;</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">arphdr</span><span class="w">  </span><span class="o">*</span><span class="n">arph</span><span class="p">;</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w">  </span><span class="o">*</span><span class="n">raw</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">nh</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* é“¾è·¯å±‚å¤´éƒ¨æŒ‡é’ˆ */</span>
<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">ethhdr</span><span class="w">  </span><span class="o">*</span><span class="n">ethernet</span><span class="p">;</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w">  </span><span class="o">*</span><span class="n">raw</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">mac</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* è·¯ç”±ä¿¡æ¯ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dst_entry</span><span class="w"> </span><span class="o">*</span><span class="n">dst</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* æ§åˆ¶ä¿¡æ¯ */</span>
<span class="w">    </span><span class="n">__u32</span><span class="w">             </span><span class="n">priority</span><span class="p">;</span>
<span class="w">    </span><span class="n">__u16</span><span class="w">             </span><span class="n">protocol</span><span class="p">;</span>
<span class="w">    </span><span class="n">__u8</span><span class="w">              </span><span class="n">pkt_type</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* å¼•ç”¨è®¡æ•° */</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w">          </span><span class="n">users</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* åˆ†ç‰‡ä¿¡æ¯ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">skb_shared_info</span><span class="w"> </span><span class="o">*</span><span class="n">shinfo</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="_14">å…³é”®æŒ‡é’ˆå…³ç³»</h3>
<p>sk_buff ä¸­æœ€é‡è¦çš„æ˜¯å››ä¸ªæ•°æ®æŒ‡é’ˆçš„å…³ç³»ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="w">        </span><span class="n">head</span><span class="w">                </span><span class="kt">data</span><span class="w">               </span><span class="n">tail</span><span class="w">                </span><span class="kd">end</span>
<span class="w">         </span><span class="err">â†“</span><span class="w">                   </span><span class="err">â†“</span><span class="w">                   </span><span class="err">â†“</span><span class="w">                   </span><span class="err">â†“</span>
<span class="w">    </span><span class="err">â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”</span>
<span class="w">    </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span><span class="w">   </span><span class="n">headroom</span><span class="w">    </span><span class="err">â”‚</span><span class="w">    </span><span class="n">packet</span><span class="w"> </span><span class="kt">data</span><span class="w">    </span><span class="err">â”‚</span><span class="w">    </span><span class="n">tailroom</span><span class="w">     </span><span class="err">â”‚</span><span class="w">    </span><span class="err">â”‚</span>
<span class="w">    </span><span class="err">â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜</span>
<span class="w">         </span><span class="err">â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w"> </span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’</span>
<span class="w">         </span><span class="err">â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w"> </span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’</span>
<span class="w">         </span><span class="err">â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><span class="w"> </span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="w"> </span><span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’</span>
</code></pre></div>

<p>è¿™ç§è®¾è®¡å…è®¸åœ¨æ•°æ®åŒ…å‰åé«˜æ•ˆåœ°æ·»åŠ æˆ–åˆ é™¤åè®®å¤´éƒ¨ï¼š</p>
<ul>
<li><strong>skb_push()</strong>ï¼šåœ¨æ•°æ®å‰æ·»åŠ å¤´éƒ¨ï¼ˆdata æŒ‡é’ˆå‰ç§»ï¼‰</li>
<li><strong>skb_pull()</strong>ï¼šç§»é™¤æ•°æ®å‰çš„å¤´éƒ¨ï¼ˆdata æŒ‡é’ˆåç§»ï¼‰</li>
<li><strong>skb_put()</strong>ï¼šåœ¨æ•°æ®åæ·»åŠ å†…å®¹ï¼ˆtail æŒ‡é’ˆåç§»ï¼‰</li>
<li><strong>skb_trim()</strong>ï¼šæˆªæ–­æ•°æ®æœ«å°¾ï¼ˆtail æŒ‡é’ˆå‰ç§»ï¼‰</li>
</ul>
<h3 id="922-sk_buff">9.2.2 sk_buff çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†</h3>
<h4 id="_15">åˆ†é…ä¸åˆå§‹åŒ–</h4>
<p>ç½‘ç»œæ•°æ®åŒ…çš„ sk_buff é€šå¸¸åœ¨ä»¥ä¸‹åœºæ™¯åˆ†é…ï¼š</p>
<ol>
<li><strong>æ¥æ”¶è·¯å¾„</strong>ï¼šç½‘å¡é©±åŠ¨åœ¨ DMA ç¼“å†²åŒºå‡†å¤‡æ—¶é¢„åˆ†é…</li>
<li><strong>å‘é€è·¯å¾„</strong>ï¼šåº”ç”¨ç¨‹åºå‘é€æ•°æ®æ—¶åŠ¨æ€åˆ†é…</li>
<li><strong>è½¬å‘è·¯å¾„</strong>ï¼šå¯èƒ½å¤ç”¨åŸ sk_buff æˆ–å…‹éš†</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="cm">/* åˆ†é… sk_buff */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">sk_buff</span><span class="w"> </span><span class="o">*</span><span class="n">skb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_skb</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_ATOMIC</span><span class="p">);</span>

<span class="cm">/* ä¸ºç½‘ç»œè®¾å¤‡åˆ†é…ï¼ˆåŒ…å« NET_SKB_PAD å¯¹é½ï¼‰ */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">sk_buff</span><span class="w"> </span><span class="o">*</span><span class="n">skb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>

<span class="cm">/* åˆ†é…å¹¶é¢„ç•™å¤´éƒ¨ç©ºé—´ */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">sk_buff</span><span class="w"> </span><span class="o">*</span><span class="n">skb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_skb</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">headroom</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="n">headroom</span><span class="p">);</span>
</code></pre></div>

<h4 id="_16">å¼•ç”¨è®¡æ•°ç®¡ç†</h4>
<p>sk_buff ä½¿ç”¨å¼•ç”¨è®¡æ•°ç®¡ç†ç”Ÿå‘½å‘¨æœŸï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* å¢åŠ å¼•ç”¨ */</span>
<span class="n">skb_get</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span><span class="w">  </span><span class="c1">// atomic_inc(&amp;skb-&gt;users)</span>

<span class="cm">/* å‡å°‘å¼•ç”¨ï¼Œåˆ° 0 æ—¶é‡Šæ”¾ */</span>
<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span><span class="w">  </span><span class="c1">// é”™è¯¯è·¯å¾„é‡Šæ”¾</span>
<span class="n">consume_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span><span class="w"> </span><span class="c1">// æ­£å¸¸è·¯å¾„é‡Šæ”¾</span>
</code></pre></div>

<h4 id="_17">å…‹éš†ä¸å¤åˆ¶</h4>
<p>ä¸ºäº†é¿å…æ•°æ®å¤åˆ¶ï¼Œsk_buff æ”¯æŒé«˜æ•ˆçš„å…‹éš†ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* å…‹éš†ï¼šå…±äº«æ•°æ®ï¼Œå¤åˆ¶å…ƒæ•°æ® */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">sk_buff</span><span class="w"> </span><span class="o">*</span><span class="n">clone</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">skb_clone</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_ATOMIC</span><span class="p">);</span>

<span class="cm">/* å®Œæ•´å¤åˆ¶ï¼šæ•°æ®å’Œå…ƒæ•°æ®éƒ½å¤åˆ¶ */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">sk_buff</span><span class="w"> </span><span class="o">*</span><span class="n">copy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">skb_copy</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_ATOMIC</span><span class="p">);</span>

<span class="cm">/* COW å¤åˆ¶ï¼šå¿…è¦æ—¶æ‰å¤åˆ¶æ•°æ® */</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">skb_shared</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
<span class="w">    </span><span class="n">skb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">skb_unshare</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_ATOMIC</span><span class="p">);</span>
</code></pre></div>

<h3 id="923">9.2.3 æ•°æ®åŒ…åœ¨å„å±‚çš„å¤„ç†æµç¨‹</h3>
<h4 id="bottom-up">æ¥æ”¶è·¯å¾„ï¼ˆBottom-upï¼‰</h4>
<div class="codehilite"><pre><span></span><code><span class="nx">ç½‘å¡</span><span class="w"> </span><span class="nx">DMA</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="nx">é©±åŠ¨</span><span class="w"> </span><span class="nx">RX</span><span class="w"> </span><span class="nx">ä¸­æ–­</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="nx">NAPI</span><span class="w"> </span><span class="nx">poll</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="nx">netif_receive_skb</span>
<span class="w">    </span><span class="err">â†“</span>
<span class="nx">é“¾è·¯å±‚å¤„ç†</span><span class="err">ï¼ˆ</span><span class="nx">eth_type_trans</span><span class="err">ï¼‰</span>
<span class="w">    </span><span class="err">â†“</span>
<span class="nx">ç½‘ç»œå±‚å¤„ç†</span><span class="err">ï¼ˆ</span><span class="nx">ip_rcv</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">ipv6_rcv</span><span class="err">ï¼‰</span>
<span class="w">    </span><span class="err">â†“</span>
<span class="nx">Netfilter</span><span class="w"> </span><span class="nx">PREROUTING</span><span class="w"> </span><span class="nx">é’©å­</span>
<span class="w">    </span><span class="err">â†“</span>
<span class="nx">è·¯ç”±å†³ç­–</span><span class="err">ï¼ˆ</span><span class="nx">æœ¬åœ°</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">è½¬å‘</span><span class="err">ï¼‰</span>
<span class="w">    </span><span class="err">â†“</span>
<span class="nx">æœ¬åœ°</span><span class="err">ï¼š</span><span class="nx">ä¼ è¾“å±‚å¤„ç†</span><span class="err">ï¼ˆ</span><span class="nx">tcp_v4_rcv</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">udp_rcv</span><span class="err">ï¼‰</span>
<span class="w">    </span><span class="err">â†“</span>
<span class="nx">å¥—æ¥å­—é˜Ÿåˆ—</span><span class="err">ï¼ˆ</span><span class="nx">sk</span><span class="o">-&gt;</span><span class="nx">sk_receive_queue</span><span class="err">ï¼‰</span>
<span class="w">    </span><span class="err">â†“</span>
<span class="nx">åº”ç”¨ç¨‹åº</span><span class="w"> </span><span class="nx">recv</span><span class="p">()</span>
</code></pre></div>

<p>æ¯å±‚å¤„ç†çš„å…¸å‹æ“ä½œï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* é“¾è·¯å±‚ï¼šè§£æä»¥å¤ªç½‘å¤´éƒ¨ */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">eth_type_trans</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sk_buff</span><span class="w"> </span><span class="o">*</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">net_device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ethhdr</span><span class="w"> </span><span class="o">*</span><span class="n">eth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eth_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="w">    </span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eth</span><span class="o">-&gt;</span><span class="n">h_proto</span><span class="p">;</span>
<span class="w">    </span><span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="n">ETH_HLEN</span><span class="p">);</span><span class="w">  </span><span class="c1">// ç§»é™¤ä»¥å¤ªç½‘å¤´éƒ¨</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ç½‘ç»œå±‚ï¼šIP å¤´éƒ¨æ ¡éªŒ */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">ip_rcv</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sk_buff</span><span class="w"> </span><span class="o">*</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">net_device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span>
<span class="w">                  </span><span class="k">struct</span><span class="w"> </span><span class="nc">packet_type</span><span class="w"> </span><span class="o">*</span><span class="n">pt</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">net_device</span><span class="w"> </span><span class="o">*</span><span class="n">orig_dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">iphdr</span><span class="w"> </span><span class="o">*</span><span class="n">iph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* æ ¡éªŒ IP å¤´éƒ¨ */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">version</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">drop</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pskb_may_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">drop</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* æ›´æ–° skb æŒ‡é’ˆ */</span>
<span class="w">    </span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">transport_header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">network_header</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">NF_HOOK</span><span class="p">(</span><span class="n">NFPROTO_IPV4</span><span class="p">,</span><span class="w"> </span><span class="n">NF_INET_PRE_ROUTING</span><span class="p">,</span><span class="w"> </span>
<span class="w">                   </span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">ip_rcv_finish</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="top-down">å‘é€è·¯å¾„ï¼ˆTop-downï¼‰</h4>
<div class="codehilite"><pre><span></span><code>åº”ç”¨ç¨‹åº send() â†’ socket å±‚
    â†“
ä¼ è¾“å±‚æ„é€ ï¼ˆtcp_transmit_skbï¼‰
    â†“
ç½‘ç»œå±‚å¤„ç†ï¼ˆip_outputï¼‰
    â†“
Netfilter POSTROUTING é’©å­
    â†“
é‚»å±…å­ç³»ç»Ÿï¼ˆARP è§£æï¼‰
    â†“
è®¾å¤‡é˜Ÿåˆ—ï¼ˆdev_queue_xmitï¼‰
    â†“
æµé‡æ§åˆ¶ï¼ˆqdiscï¼‰
    â†“
é©±åŠ¨ TX â†’ DMA â†’ ç½‘å¡å‘é€
</code></pre></div>

<h3 id="924-scatter-gather-io">9.2.4 é›¶æ‹·è´ä¸ scatter-gather I/O</h3>
<h4 id="io_1">åˆ†æ•£èšé›† I/O</h4>
<p>sk_buff æ”¯æŒå°†æ•°æ®åˆ†æ•£åœ¨å¤šä¸ªå†…å­˜é¡µä¸­ï¼Œé¿å…å¤§å—è¿ç»­å†…å­˜åˆ†é…ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">skb_shared_info</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">short</span><span class="w">  </span><span class="n">nr_frags</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">skb_frag_struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="o">*</span><span class="n">page</span><span class="p">;</span>
<span class="w">        </span><span class="n">__u32</span><span class="w">       </span><span class="n">page_offset</span><span class="p">;</span>
<span class="w">        </span><span class="n">__u32</span><span class="w">       </span><span class="n">size</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">frags</span><span class="p">[</span><span class="n">MAX_SKB_FRAGS</span><span class="p">];</span>
<span class="p">};</span>
</code></pre></div>

<p>è¿™ç§è®¾è®¡æ”¯æŒï¼š</p>
<ul>
<li><strong>é›¶æ‹·è´å‘é€</strong>ï¼šç›´æ¥æ˜ å°„ç”¨æˆ·ç©ºé—´é¡µé¢</li>
<li><strong>TSO/GSO</strong>ï¼šç¡¬ä»¶åˆ†æ®µå¸è½½</li>
<li><strong>GRO</strong>ï¼šæ¥æ”¶ç«¯æ•°æ®åŒ…èšåˆ</li>
</ul>
<h4 id="page-flipping">é¡µé¢ç¿»è½¬ï¼ˆPage Flippingï¼‰</h4>
<p>é«˜æ€§èƒ½ç½‘å¡é©±åŠ¨ä½¿ç”¨é¡µé¢ç¿»è½¬æŠ€æœ¯é¿å…æ•°æ®å¤åˆ¶ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* æ¥æ”¶æ—¶ç›´æ¥å°† DMA é¡µé¢èµ‹ç»™ sk_buff */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">rx_page_flip</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sk_buff</span><span class="w"> </span><span class="o">*</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">skb_fill_page_desc</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<span class="w">    </span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<span class="w">    </span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="msg_zerocopy">MSG_ZEROCOPY å‘é€</h4>
<p>Linux 4.14 å¼•å…¥çš„ MSG_ZEROCOPY å…è®¸åº”ç”¨ç¨‹åºé›¶æ‹·è´å‘é€ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* ç”¨æˆ·ç©ºé—´ */</span>
<span class="n">send</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">MSG_ZEROCOPY</span><span class="p">);</span>

<span class="cm">/* å†…æ ¸ç©ºé—´ï¼šç›´æ¥å¼•ç”¨ç”¨æˆ·é¡µé¢ */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">tcp_zerocopy_send</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sock</span><span class="w"> </span><span class="o">*</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">msghdr</span><span class="w"> </span><span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sk_buff</span><span class="w"> </span><span class="o">*</span><span class="n">skb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcp_write_queue_tail</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* å°†ç”¨æˆ·é¡µé¢æ·»åŠ åˆ° skb frags */</span>
<span class="w">    </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">skb_zerocopy_add_frags_iter</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_iter</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                       </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">uarg</span><span class="p">,</span><span class="w"> </span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_allocation</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* è®¾ç½®å›è°ƒé€šçŸ¥ */</span>
<span class="w">    </span><span class="n">skb_zcopy_set</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="n">uarg</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="_18">å†…å­˜ç®¡ç†ä¼˜åŒ–</h3>
<h4 id="skb">skb ç¼“å­˜æ± </h4>
<p>ä¸ºäº†å‡å°‘åˆ†é…å¼€é”€ï¼Œå†…æ ¸ç»´æŠ¤äº† per-CPU çš„ sk_buff ç¼“å­˜ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">netdev_alloc_cache</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">page_frag</span><span class="w">    </span><span class="n">frag</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">        </span><span class="n">pagecnt_bias</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">netdev_alloc_cache</span><span class="p">,</span><span class="w"> </span><span class="n">netdev_alloc_cache</span><span class="p">);</span>
</code></pre></div>

<h4 id="_19">å†…å­˜é¢„åˆ†é…ç­–ç•¥</h4>
<p>ç½‘å¡é©±åŠ¨é€šå¸¸é¢„åˆ†é…æ¥æ”¶ç¼“å†²åŒºï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* Intel ixgbe é©±åŠ¨çš„æ¥æ”¶ç¼“å†²åŒºç®¡ç† */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">ixgbe_alloc_rx_buffers</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">ixgbe_ring</span><span class="w"> </span><span class="o">*</span><span class="n">rx_ring</span><span class="p">,</span><span class="w"> </span><span class="n">u16</span><span class="w"> </span><span class="n">cleaned</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="nc">ixgbe_adv_rx_desc</span><span class="w"> </span><span class="o">*</span><span class="n">rx_desc</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ixgbe_rx_buffer</span><span class="w"> </span><span class="o">*</span><span class="n">bi</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* æ‰¹é‡åˆ†é…ï¼Œå‡å°‘å†…å­˜åˆ†é…å¼€é”€ */</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">cleaned</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">bi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_buffer_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">        </span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">skb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">netdev_alloc_skb_ip_align</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
<span class="w">                                             </span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_buf_len</span><span class="p">);</span>

<span class="w">        </span><span class="cm">/* è®¾ç½® DMA æ˜ å°„ */</span>
<span class="w">        </span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">dma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dma_map_single</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
<span class="w">                                  </span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_buf_len</span><span class="p">,</span><span class="w"> </span><span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
            </article>
            
            <nav class="page-nav"><a href="chapter8.html" class="nav-link prev">â† ç¬¬8ç« ï¼šè®¾å¤‡é©±åŠ¨æ¨¡å‹</a><a href="chapter10.html" class="nav-link next">ç¬¬10ç« ï¼šå†…æ ¸åŒæ­¥æœºåˆ¶ â†’</a></nav>
        </main>
    </div>
</body>
</html>