<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬8ç« ï¼šè®¾å¤‡é©±åŠ¨æ¨¡å‹</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Linux å†…æ ¸æºä»£ç æ·±åº¦è§£æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬1ç« ï¼šLinux å†…æ ¸æ¦‚è¿°ä¸å‘å±•å²</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬2ç« ï¼šè¿›ç¨‹ç®¡ç†ä¸ä»»åŠ¡è°ƒåº¦</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬3ç« ï¼šå†…å­˜ç®¡ç†æ¶æ„</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬4ç« ï¼šè¿›ç¨‹é—´é€šä¿¡æœºåˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬5ç« ï¼šè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬6ç« ï¼šå…·ä½“æ–‡ä»¶ç³»ç»Ÿå®ç°</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬7ç« ï¼šå—è®¾å¤‡å±‚ä¸I/Oè°ƒåº¦</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬8ç« ï¼šè®¾å¤‡é©±åŠ¨æ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬9ç« ï¼šç½‘ç»œåè®®æ ˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬10ç« ï¼šå†…æ ¸åŒæ­¥æœºåˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬11ç« ï¼šå¹¶å‘ç¼–ç¨‹æ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬12ç« ï¼šå®¹å™¨ä¸å‘½åç©ºé—´</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬13ç« ï¼šå®‰å…¨å­ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬14ç« ï¼šå®æ—¶Linux</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬15ç« ï¼šæ€§èƒ½åˆ†æä¸è°ƒè¯•</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬16ç« ï¼šå¼•å¯¼è¿‡ç¨‹ä¸åˆå§‹åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="8">ç¬¬8ç« ï¼šè®¾å¤‡é©±åŠ¨æ¨¡å‹</h1>
<h2 id="_1">æœ¬ç« å†…å®¹æè¦</h2>
<p>Linux è®¾å¤‡é©±åŠ¨æ¨¡å‹æ˜¯å†…æ ¸ä¸­æœ€å¤æ‚ä½†ä¹Ÿæœ€ä¼˜é›…çš„å­ç³»ç»Ÿä¹‹ä¸€ã€‚ä»æ—©æœŸç®€å•çš„å­—ç¬¦è®¾å¤‡å’Œå—è®¾å¤‡æŠ½è±¡ï¼Œæ¼”åŒ–åˆ°ä»Šå¤©ç»Ÿä¸€çš„è®¾å¤‡æ¨¡å‹ï¼Œè¿™ä¸€è·¯å¾„åæ˜ äº† Linux å†…æ ¸å¯¹ç¡¬ä»¶å¤šæ ·æ€§å’Œçƒ­æ’æ‹”éœ€æ±‚çš„ä¸æ–­é€‚åº”ã€‚æœ¬ç« æ·±å…¥å‰–æè®¾å¤‡é©±åŠ¨æ¨¡å‹çš„æ ¸å¿ƒæœºåˆ¶ï¼Œä» kobject/kset çš„å¯¹è±¡å±‚æ¬¡ï¼Œåˆ°æ€»çº¿-è®¾å¤‡-é©±åŠ¨çš„ä¸‰è§’å…³ç³»ï¼Œå†åˆ°ä¸­æ–­å¤„ç†çš„ç²¾å¦™è®¾è®¡ã€‚é€šè¿‡å­¦ä¹ æœ¬ç« ï¼Œè¯»è€…å°†æŒæ¡å¦‚ä½•ç¼–å†™é«˜æ•ˆã€å¯é çš„è®¾å¤‡é©±åŠ¨ï¼Œç†è§£å†…æ ¸å¦‚ä½•ç®¡ç†æˆåƒä¸Šä¸‡çš„ç¡¬ä»¶è®¾å¤‡ï¼Œä»¥åŠç°ä»£ Linux å¦‚ä½•å®ç°è®¾å¤‡çš„è‡ªåŠ¨å‘ç°å’Œé…ç½®ã€‚</p>
<h2 id="81">8.1 è®¾å¤‡æ¨¡å‹åŸºç¡€æ¶æ„</h2>
<h3 id="811-kobject">8.1.1 kobjectï¼šå†…æ ¸å¯¹è±¡çš„åŸºçŸ³</h3>
<p>Linux 2.6 å¼•å…¥çš„ kobjectï¼ˆkernel objectï¼‰æ˜¯æ•´ä¸ªè®¾å¤‡æ¨¡å‹çš„åŸºç¡€ã€‚æ¯ä¸ª kobject ä»£è¡¨å†…æ ¸ä¸­çš„ä¸€ä¸ªå¯¹è±¡ï¼Œé€šè¿‡å¼•ç”¨è®¡æ•°ç®¡ç†ç”Ÿå‘½å‘¨æœŸï¼Œé€šè¿‡ sysfs å‘ç”¨æˆ·ç©ºé—´å¯¼å‡ºä¿¡æ¯ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">kobject</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w">              </span><span class="o">*</span><span class="n">name</span><span class="p">;</span><span class="w">          </span><span class="c1">// å¯¹è±¡åç§°</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w">        </span><span class="n">entry</span><span class="p">;</span><span class="w">          </span><span class="c1">// é“¾å…¥ kset çš„é“¾è¡¨èŠ‚ç‚¹</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kobject</span><span class="w">          </span><span class="o">*</span><span class="n">parent</span><span class="p">;</span><span class="w">        </span><span class="c1">// çˆ¶å¯¹è±¡æŒ‡é’ˆ</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kset</span><span class="w">             </span><span class="o">*</span><span class="n">kset</span><span class="p">;</span><span class="w">          </span><span class="c1">// æ‰€å±çš„ kset</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kobj_type</span><span class="w">        </span><span class="o">*</span><span class="n">ktype</span><span class="p">;</span><span class="w">         </span><span class="c1">// å¯¹è±¡ç±»å‹å’Œæ“ä½œ</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kernfs_node</span><span class="w">      </span><span class="o">*</span><span class="n">sd</span><span class="p">;</span><span class="w">            </span><span class="c1">// sysfs ç›®å½•é¡¹</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kref</span><span class="w">             </span><span class="n">kref</span><span class="p">;</span><span class="w">           </span><span class="c1">// å¼•ç”¨è®¡æ•°</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">state_initialized</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span><span class="w">       </span><span class="c1">// åˆå§‹åŒ–æ ‡å¿—</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">state_in_sysfs</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span><span class="w">         </span><span class="c1">// åœ¨ sysfs ä¸­çš„æ ‡å¿—</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">state_add_uevent_sent</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span><span class="w">  </span><span class="c1">// uevent å‘é€æ ‡å¿—</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">state_remove_uevent_sent</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">uevent_suppress</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span><span class="w">        </span><span class="c1">// æŠ‘åˆ¶ uevent</span>
<span class="p">};</span>
</code></pre></div>

<p>kobject çš„å…³é”®ç‰¹æ€§ï¼š</p>
<ol>
<li><strong>å¼•ç”¨è®¡æ•°ç®¡ç†</strong>ï¼šé€šè¿‡ kref å®ç°è‡ªåŠ¨å†…å­˜ç®¡ç†</li>
<li><strong>å±‚æ¬¡ç»“æ„</strong>ï¼šé€šè¿‡ parent æŒ‡é’ˆå½¢æˆæ ‘å½¢ç»“æ„</li>
<li><strong>sysfs è¡¨ç¤º</strong>ï¼šæ¯ä¸ª kobject å¯¹åº” /sys ä¸‹çš„ä¸€ä¸ªç›®å½•</li>
<li><strong>äº‹ä»¶é€šçŸ¥</strong>ï¼šé€šè¿‡ uevent æœºåˆ¶é€šçŸ¥ç”¨æˆ·ç©ºé—´</li>
</ol>
<h3 id="812-kset">8.1.2 ksetï¼šå¯¹è±¡çš„é›†åˆ</h3>
<p>kset æ˜¯ kobject çš„é›†åˆï¼Œæä¾›äº†å¯¹åŒç±»å¯¹è±¡çš„ç»Ÿä¸€ç®¡ç†ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">kset</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">list</span><span class="p">;</span><span class="w">           </span><span class="c1">// kobject é“¾è¡¨å¤´</span>
<span class="w">    </span><span class="n">spinlock_t</span><span class="w"> </span><span class="n">list_lock</span><span class="p">;</span><span class="w">           </span><span class="c1">// ä¿æŠ¤é“¾è¡¨çš„è‡ªæ—‹é”</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kobject</span><span class="w"> </span><span class="n">kobj</span><span class="p">;</span><span class="w">            </span><span class="c1">// å†…åµŒçš„ kobject</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">kset_uevent_ops</span><span class="w"> </span><span class="o">*</span><span class="n">uevent_ops</span><span class="p">;</span><span class="w">  </span><span class="c1">// uevent æ“ä½œé›†</span>
<span class="p">};</span>
</code></pre></div>

<p>kset çš„ä¸»è¦åŠŸèƒ½ï¼š</p>
<ul>
<li>å°†ç›¸å…³çš„ kobject ç»„ç»‡åœ¨ä¸€èµ·</li>
<li>æä¾›çƒ­æ’æ‹”äº‹ä»¶çš„è¿‡æ»¤å’Œç¯å¢ƒå˜é‡è®¾ç½®</li>
<li>åœ¨ sysfs ä¸­è¡¨ç°ä¸ºåŒ…å«å¤šä¸ªå­ç›®å½•çš„ç›®å½•</li>
</ul>
<h3 id="813-ktype">8.1.3 ktypeï¼šå¯¹è±¡ç±»å‹å’Œæ“ä½œ</h3>
<p>ktype å®šä¹‰äº† kobject çš„ç±»å‹ç‰¹å®šæ“ä½œï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">kobj_type</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">release</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">kobject</span><span class="w"> </span><span class="o">*</span><span class="n">kobj</span><span class="p">);</span><span class="w">     </span><span class="c1">// é‡Šæ”¾å‡½æ•°</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sysfs_ops</span><span class="w"> </span><span class="o">*</span><span class="n">sysfs_ops</span><span class="p">;</span><span class="w">        </span><span class="c1">// sysfs æ“ä½œ</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">attribute</span><span class="w"> </span><span class="o">**</span><span class="n">default_attrs</span><span class="p">;</span><span class="w">          </span><span class="c1">// é»˜è®¤å±æ€§</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">attribute_group</span><span class="w"> </span><span class="o">**</span><span class="n">default_groups</span><span class="p">;</span><span class="w">  </span><span class="c1">// é»˜è®¤å±æ€§ç»„</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">kobj_ns_type_operations</span><span class="w"> </span><span class="o">*</span><span class="n">child_ns_type</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">namespace</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">kobject</span><span class="w"> </span><span class="o">*</span><span class="n">kobj</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">get_ownership</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">kobject</span><span class="w"> </span><span class="o">*</span><span class="n">kobj</span><span class="p">,</span><span class="w"> </span><span class="n">kuid_t</span><span class="w"> </span><span class="o">*</span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="n">kgid_t</span><span class="w"> </span><span class="o">*</span><span class="n">gid</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>

<h2 id="82">8.2 æ€»çº¿ã€è®¾å¤‡ã€é©±åŠ¨æ¨¡å‹</h2>
<h3 id="821-bus">8.2.1 æ€»çº¿ï¼ˆBusï¼‰æŠ½è±¡</h3>
<p>æ€»çº¿æ˜¯è¿æ¥è®¾å¤‡å’Œé©±åŠ¨çš„æ¡¥æ¢ï¼ŒLinux å°†ç‰©ç†æ€»çº¿ï¼ˆå¦‚ PCIã€USBï¼‰å’Œè™šæ‹Ÿæ€»çº¿ï¼ˆå¦‚ platformï¼‰éƒ½æŠ½è±¡ä¸º bus_typeï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">bus_type</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span><span class="w">                      </span><span class="c1">// æ€»çº¿åç§°</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">dev_name</span><span class="p">;</span><span class="w">                  </span><span class="c1">// è®¾å¤‡åç§°å‰ç¼€</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev_root</span><span class="p">;</span><span class="w">               </span><span class="c1">// æ ¹è®¾å¤‡</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">attribute_group</span><span class="w"> </span><span class="o">**</span><span class="n">bus_groups</span><span class="p">;</span><span class="w">     </span><span class="c1">// æ€»çº¿å±æ€§ç»„</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">attribute_group</span><span class="w"> </span><span class="o">**</span><span class="n">dev_groups</span><span class="p">;</span><span class="w">     </span><span class="c1">// è®¾å¤‡å±æ€§ç»„</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">attribute_group</span><span class="w"> </span><span class="o">**</span><span class="n">drv_groups</span><span class="p">;</span><span class="w">     </span><span class="c1">// é©±åŠ¨å±æ€§ç»„</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">match</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device_driver</span><span class="w"> </span><span class="o">*</span><span class="n">drv</span><span class="p">);</span><span class="w">  </span><span class="c1">// åŒ¹é…å‡½æ•°</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">uevent</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">kobj_uevent_env</span><span class="w"> </span><span class="o">*</span><span class="n">env</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">probe</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">);</span><span class="w">      </span><span class="c1">// æ¢æµ‹è®¾å¤‡</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">sync_state</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">remove</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">);</span><span class="w">     </span><span class="c1">// ç§»é™¤è®¾å¤‡</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">shutdown</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">);</span><span class="w">  </span><span class="c1">// å…³é—­è®¾å¤‡</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">online</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">offline</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">suspend</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">pm_message_t</span><span class="w"> </span><span class="n">state</span><span class="p">);</span><span class="w">  </span><span class="c1">// ç”µæºç®¡ç†</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">resume</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dev_pm_ops</span><span class="w"> </span><span class="o">*</span><span class="n">pm</span><span class="p">;</span><span class="w">           </span><span class="c1">// ç”µæºç®¡ç†æ“ä½œé›†</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">iommu_ops</span><span class="w"> </span><span class="o">*</span><span class="n">iommu_ops</span><span class="p">;</span><span class="w">     </span><span class="c1">// IOMMU æ“ä½œé›†</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">subsys_private</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span><span class="w">              </span><span class="c1">// ç§æœ‰æ•°æ®</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lock_class_key</span><span class="w"> </span><span class="n">lock_key</span><span class="p">;</span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">need_parent_lock</span><span class="p">;</span><span class="w">                 </span><span class="c1">// æ˜¯å¦éœ€è¦çˆ¶è®¾å¤‡é”</span>
<span class="p">};</span>
</code></pre></div>

<p>æ€»çº¿çš„æ ¸å¿ƒèŒè´£ï¼š</p>
<ol>
<li><strong>è®¾å¤‡æšä¸¾</strong>ï¼šå‘ç°è¿æ¥åˆ°æ€»çº¿ä¸Šçš„è®¾å¤‡</li>
<li><strong>é©±åŠ¨åŒ¹é…</strong>ï¼šä¸ºè®¾å¤‡æ‰¾åˆ°åˆé€‚çš„é©±åŠ¨ç¨‹åº</li>
<li><strong>ç”µæºç®¡ç†</strong>ï¼šåè°ƒè®¾å¤‡çš„ç”µæºçŠ¶æ€è½¬æ¢</li>
<li><strong>çƒ­æ’æ‹”å¤„ç†</strong>ï¼šå¤„ç†è®¾å¤‡çš„åŠ¨æ€æ·»åŠ å’Œç§»é™¤</li>
</ol>
<h3 id="822-device">8.2.2 è®¾å¤‡ï¼ˆDeviceï¼‰è¡¨ç¤º</h3>
<p>æ¯ä¸ªç¡¬ä»¶è®¾å¤‡åœ¨å†…æ ¸ä¸­ç”¨ struct device è¡¨ç¤ºï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kobject</span><span class="w"> </span><span class="n">kobj</span><span class="p">;</span><span class="w">                   </span><span class="c1">// å†…åµŒçš„ kobject</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">;</span><span class="w">                 </span><span class="c1">// çˆ¶è®¾å¤‡</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">device_private</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span><span class="w">              </span><span class="c1">// ç§æœ‰æ•°æ®</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">init_name</span><span class="p">;</span><span class="w">                 </span><span class="c1">// åˆå§‹åç§°</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device_type</span><span class="w"> </span><span class="o">*</span><span class="n">type</span><span class="p">;</span><span class="w">        </span><span class="c1">// è®¾å¤‡ç±»å‹</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bus_type</span><span class="w"> </span><span class="o">*</span><span class="n">bus</span><span class="p">;</span><span class="w">                  </span><span class="c1">// æ‰€å±æ€»çº¿</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">device_driver</span><span class="w"> </span><span class="o">*</span><span class="n">driver</span><span class="p">;</span><span class="w">          </span><span class="c1">// ç»‘å®šçš„é©±åŠ¨</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">platform_data</span><span class="p">;</span><span class="w">                   </span><span class="c1">// å¹³å°ç‰¹å®šæ•°æ®</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">driver_data</span><span class="p">;</span><span class="w">                     </span><span class="c1">// é©±åŠ¨ç§æœ‰æ•°æ®</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mutex</span><span class="w"> </span><span class="n">mutex</span><span class="p">;</span><span class="w">                    </span><span class="c1">// è®¾å¤‡äº’æ–¥é”</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dev_links_info</span><span class="w"> </span><span class="n">links</span><span class="p">;</span><span class="w">           </span><span class="c1">// è®¾å¤‡é“¾æ¥ä¿¡æ¯</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dev_pm_info</span><span class="w"> </span><span class="n">power</span><span class="p">;</span><span class="w">              </span><span class="c1">// ç”µæºç®¡ç†ä¿¡æ¯</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dev_pm_domain</span><span class="w"> </span><span class="o">*</span><span class="n">pm_domain</span><span class="p">;</span><span class="w">       </span><span class="c1">// PM åŸŸ</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">em_perf_domain</span><span class="w"> </span><span class="o">*</span><span class="n">em_pd</span><span class="p">;</span><span class="w">          </span><span class="c1">// èƒ½æ•ˆæ¨¡å‹</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">irq_domain</span><span class="w"> </span><span class="o">*</span><span class="n">msi_domain</span><span class="p">;</span><span class="w">         </span><span class="c1">// MSI ä¸­æ–­åŸŸ</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">msi_list</span><span class="p">;</span><span class="w">             </span><span class="c1">// MSI æè¿°ç¬¦é“¾è¡¨</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dma_map_ops</span><span class="w"> </span><span class="o">*</span><span class="n">dma_ops</span><span class="p">;</span><span class="w">     </span><span class="c1">// DMA æ“ä½œé›†</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="o">*</span><span class="n">dma_mask</span><span class="p">;</span><span class="w">                         </span><span class="c1">// DMA æ©ç </span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">coherent_dma_mask</span><span class="p">;</span><span class="w">                 </span><span class="c1">// ä¸€è‡´æ€§ DMA æ©ç </span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">bus_dma_limit</span><span class="p">;</span><span class="w">                     </span><span class="c1">// æ€»çº¿ DMA é™åˆ¶</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">device_node</span><span class="w"> </span><span class="o">*</span><span class="n">of_node</span><span class="p">;</span><span class="w">           </span><span class="c1">// è®¾å¤‡æ ‘èŠ‚ç‚¹</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">fwnode_handle</span><span class="w"> </span><span class="o">*</span><span class="n">fwnode</span><span class="p">;</span><span class="w">          </span><span class="c1">// å›ºä»¶èŠ‚ç‚¹</span>

<span class="w">    </span><span class="kt">dev_t</span><span class="w"> </span><span class="n">devt</span><span class="p">;</span><span class="w">                            </span><span class="c1">// è®¾å¤‡å·</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">                                </span><span class="c1">// è®¾å¤‡ ID</span>

<span class="w">    </span><span class="n">spinlock_t</span><span class="w"> </span><span class="n">devres_lock</span><span class="p">;</span><span class="w">                </span><span class="c1">// èµ„æºç®¡ç†é”</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">devres_head</span><span class="p">;</span><span class="w">          </span><span class="c1">// èµ„æºé“¾è¡¨</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">class</span><span class="w"> </span><span class="o">*</span><span class="n">class</span><span class="p">;</span><span class="w">                   </span><span class="c1">// è®¾å¤‡ç±»</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">attribute_group</span><span class="w"> </span><span class="o">**</span><span class="n">groups</span><span class="p">;</span><span class="w"> </span><span class="c1">// å±æ€§ç»„</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">release</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">);</span><span class="w">   </span><span class="c1">// é‡Šæ”¾å‡½æ•°</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">iommu_group</span><span class="w"> </span><span class="o">*</span><span class="n">iommu_group</span><span class="p">;</span><span class="w">       </span><span class="c1">// IOMMU ç»„</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dev_iommu</span><span class="w"> </span><span class="o">*</span><span class="n">iommu</span><span class="p">;</span><span class="w">              </span><span class="c1">// IOMMU æ•°æ®</span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">offline_disabled</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span><span class="w">               </span><span class="c1">// ç¦æ­¢ç¦»çº¿</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">offline</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span><span class="w">                        </span><span class="c1">// ç¦»çº¿çŠ¶æ€</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">of_node_reused</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span><span class="w">                </span><span class="c1">// è®¾å¤‡æ ‘èŠ‚ç‚¹å¤ç”¨</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">state_synced</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span><span class="w">                  </span><span class="c1">// çŠ¶æ€å·²åŒæ­¥</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">can_match</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span><span class="w">                     </span><span class="c1">// å¯ä»¥åŒ¹é…é©±åŠ¨</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="823-driver">8.2.3 é©±åŠ¨ï¼ˆDriverï¼‰å®ç°</h3>
<p>è®¾å¤‡é©±åŠ¨ç”¨ struct device_driver è¡¨ç¤ºï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">device_driver</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span><span class="w">                      </span><span class="c1">// é©±åŠ¨åç§°</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bus_type</span><span class="w"> </span><span class="o">*</span><span class="n">bus</span><span class="p">;</span><span class="w">                  </span><span class="c1">// æ‰€å±æ€»çº¿</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">module</span><span class="w"> </span><span class="o">*</span><span class="n">owner</span><span class="p">;</span><span class="w">                  </span><span class="c1">// æ‰€å±æ¨¡å—</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">mod_name</span><span class="p">;</span><span class="w">                  </span><span class="c1">// æ¨¡å—åç§°</span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">suppress_bind_attrs</span><span class="p">;</span><span class="w">              </span><span class="c1">// æŠ‘åˆ¶ç»‘å®šå±æ€§</span>
<span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="n">probe_type</span><span class="w"> </span><span class="n">probe_type</span><span class="p">;</span><span class="w">            </span><span class="c1">// æ¢æµ‹ç±»å‹</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">of_device_id</span><span class="w"> </span><span class="o">*</span><span class="n">of_match_table</span><span class="p">;</span><span class="w">     </span><span class="c1">// è®¾å¤‡æ ‘åŒ¹é…è¡¨</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">acpi_device_id</span><span class="w"> </span><span class="o">*</span><span class="n">acpi_match_table</span><span class="p">;</span><span class="w"> </span><span class="c1">// ACPI åŒ¹é…è¡¨</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">probe</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">);</span><span class="w">      </span><span class="c1">// æ¢æµ‹å‡½æ•°</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">sync_state</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">remove</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">);</span><span class="w">     </span><span class="c1">// ç§»é™¤å‡½æ•°</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">shutdown</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">);</span><span class="w">  </span><span class="c1">// å…³é—­å‡½æ•°</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">suspend</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">pm_message_t</span><span class="w"> </span><span class="n">state</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">resume</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">attribute_group</span><span class="w"> </span><span class="o">**</span><span class="n">groups</span><span class="p">;</span><span class="w"> </span><span class="c1">// å±æ€§ç»„</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">attribute_group</span><span class="w"> </span><span class="o">**</span><span class="n">dev_groups</span><span class="p">;</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dev_pm_ops</span><span class="w"> </span><span class="o">*</span><span class="n">pm</span><span class="p">;</span><span class="w">          </span><span class="c1">// ç”µæºç®¡ç†æ“ä½œ</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">coredump</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">);</span><span class="w">  </span><span class="c1">// æ ¸å¿ƒè½¬å‚¨</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">driver_private</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span><span class="w">              </span><span class="c1">// ç§æœ‰æ•°æ®</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="824">8.2.4 è®¾å¤‡ä¸é©±åŠ¨çš„ç»‘å®šè¿‡ç¨‹</h3>
<p>è®¾å¤‡ä¸é©±åŠ¨çš„ç»‘å®šæ˜¯è®¾å¤‡æ¨¡å‹çš„æ ¸å¿ƒè¿‡ç¨‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="mf">1.</span><span class="w"> </span><span class="n">è®¾å¤‡æ³¨å†Œ</span><span class="w"> </span><span class="p">(</span><span class="n">device_register</span><span class="p">)</span>
<span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">device_initialize</span><span class="p">()</span><span class="err">ï¼š</span><span class="n">åˆå§‹åŒ–è®¾å¤‡ç»“æ„</span>
<span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">device_add</span><span class="p">()</span><span class="err">ï¼š</span><span class="n">æ·»åŠ åˆ°ç³»ç»Ÿ</span>
<span class="w">       </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">kobject_add</span><span class="p">()</span><span class="err">ï¼š</span><span class="n">æ·»åŠ åˆ°</span><span class="w"> </span><span class="n">kobject</span><span class="w"> </span><span class="n">å±‚æ¬¡</span>
<span class="w">       </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">device_create_file</span><span class="p">()</span><span class="err">ï¼š</span><span class="n">åˆ›å»º</span><span class="w"> </span><span class="kr">sys</span><span class="n">fs</span><span class="w"> </span><span class="n">å±æ€§</span>
<span class="w">       </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">bus_add_device</span><span class="p">()</span><span class="err">ï¼š</span><span class="n">æ·»åŠ åˆ°æ€»çº¿</span>
<span class="w">       </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">bus_probe_device</span><span class="p">()</span><span class="err">ï¼š</span><span class="n">å°è¯•ç»‘å®šé©±åŠ¨</span>
<span class="w">           </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">device_initial_probe</span><span class="p">()</span>
<span class="w">               </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">__device_attach</span><span class="p">()</span>
<span class="w">                   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">()</span><span class="err">ï¼š</span><span class="n">è°ƒç”¨æ€»çº¿åŒ¹é…å‡½æ•°</span>
<span class="w">                   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">driver_probe_device</span><span class="p">()</span><span class="err">ï¼š</span><span class="n">æ¢æµ‹è®¾å¤‡</span>
<span class="w">                       </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">really_probe</span><span class="p">()</span>
<span class="w">                           </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">()</span><span class="err">ï¼š</span><span class="n">è°ƒç”¨é©±åŠ¨æ¢æµ‹å‡½æ•°</span>
<span class="w">                           </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">driver_bound</span><span class="p">()</span><span class="err">ï¼š</span><span class="n">æ ‡è®°ç»‘å®šæˆåŠŸ</span>

<span class="mf">2.</span><span class="w"> </span><span class="n">é©±åŠ¨æ³¨å†Œ</span><span class="w"> </span><span class="p">(</span><span class="n">driver_register</span><span class="p">)</span>
<span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">bus_add_driver</span><span class="p">()</span><span class="err">ï¼š</span><span class="n">æ·»åŠ åˆ°æ€»çº¿</span>
<span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">driver_attach</span><span class="p">()</span><span class="err">ï¼š</span><span class="n">å°è¯•ç»‘å®šè®¾å¤‡</span>
<span class="w">   </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">bus_for_each_dev</span><span class="p">()</span><span class="err">ï¼š</span><span class="n">éå†æ€»çº¿ä¸Šçš„è®¾å¤‡</span>
<span class="w">   </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">__driver_attach</span><span class="p">()</span><span class="err">ï¼š</span><span class="n">å°è¯•ç»‘å®šæ¯ä¸ªè®¾å¤‡</span>
<span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">module_add_driver</span><span class="p">()</span><span class="err">ï¼š</span><span class="n">å…³è”åˆ°æ¨¡å—</span>
</code></pre></div>

<h2 id="83">8.3 å¹³å°è®¾å¤‡ä¸è®¾å¤‡æ ‘</h2>
<h3 id="831">8.3.1 å¹³å°è®¾å¤‡æ¶æ„</h3>
<p>å¹³å°è®¾å¤‡ï¼ˆplatform deviceï¼‰æ˜¯ Linux ä¸ºä¸ä¾é™„äºä¼ ç»Ÿæ€»çº¿çš„è®¾å¤‡æä¾›çš„æŠ½è±¡ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">platform_device</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span><span class="w">                      </span><span class="c1">// è®¾å¤‡åç§°</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">                                </span><span class="c1">// è®¾å¤‡ ID</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">id_auto</span><span class="p">;</span><span class="w">                          </span><span class="c1">// è‡ªåŠ¨åˆ†é… ID</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="n">dev</span><span class="p">;</span><span class="w">                     </span><span class="c1">// å†…åµŒçš„ device</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">platform_dma_mask</span><span class="p">;</span><span class="w">                </span><span class="c1">// DMA æ©ç </span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">device_dma_parameters</span><span class="w"> </span><span class="n">dma_parms</span><span class="p">;</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">num_resources</span><span class="p">;</span><span class="w">                     </span><span class="c1">// èµ„æºæ•°é‡</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">resource</span><span class="w"> </span><span class="o">*</span><span class="n">resource</span><span class="p">;</span><span class="w">             </span><span class="c1">// èµ„æºæ•°ç»„</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">platform_device_id</span><span class="w"> </span><span class="o">*</span><span class="n">id_entry</span><span class="p">;</span><span class="w">  </span><span class="c1">// ID è¡¨é¡¹</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">driver_override</span><span class="p">;</span><span class="w">                 </span><span class="c1">// é©±åŠ¨è¦†ç›–</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mfd_cell</span><span class="w"> </span><span class="o">*</span><span class="n">mfd_cell</span><span class="p">;</span><span class="w">            </span><span class="c1">// MFD å•å…ƒ</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pdev_archdata</span><span class="w"> </span><span class="n">archdata</span><span class="p">;</span><span class="w">        </span><span class="c1">// æ¶æ„ç‰¹å®šæ•°æ®</span>
<span class="p">};</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">platform_driver</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">probe</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">platform_device</span><span class="w"> </span><span class="o">*</span><span class="p">);</span><span class="w">    </span><span class="c1">// æ¢æµ‹å‡½æ•°</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">remove</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">platform_device</span><span class="w"> </span><span class="o">*</span><span class="p">);</span><span class="w">   </span><span class="c1">// ç§»é™¤å‡½æ•°</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">shutdown</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">platform_device</span><span class="w"> </span><span class="o">*</span><span class="p">);</span><span class="w"> </span><span class="c1">// å…³é—­å‡½æ•°</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">suspend</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">platform_device</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">pm_message_t</span><span class="w"> </span><span class="n">state</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">resume</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">platform_device</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">device_driver</span><span class="w"> </span><span class="n">driver</span><span class="p">;</span><span class="w">               </span><span class="c1">// å†…åµŒçš„ driver</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">platform_device_id</span><span class="w"> </span><span class="o">*</span><span class="n">id_table</span><span class="p">;</span><span class="w"> </span><span class="c1">// ID åŒ¹é…è¡¨</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">prevent_deferred_probe</span><span class="p">;</span><span class="w">               </span><span class="c1">// é˜»æ­¢å»¶è¿Ÿæ¢æµ‹</span>
<span class="p">};</span>
</code></pre></div>

<p>èµ„æºæè¿°ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">resource</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">resource_size_t</span><span class="w"> </span><span class="n">start</span><span class="p">;</span><span class="w">                 </span><span class="c1">// èµ·å§‹åœ°å€</span>
<span class="w">    </span><span class="n">resource_size_t</span><span class="w"> </span><span class="n">end</span><span class="p">;</span><span class="w">                   </span><span class="c1">// ç»“æŸåœ°å€</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span><span class="w">                      </span><span class="c1">// èµ„æºåç§°</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span><span class="w">                   </span><span class="c1">// èµ„æºæ ‡å¿—</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">desc</span><span class="p">;</span><span class="w">                    </span><span class="c1">// æè¿°ç¬¦</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">resource</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">sibling</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">child</span><span class="p">;</span><span class="w">  </span><span class="c1">// å±‚æ¬¡ç»“æ„</span>
<span class="p">};</span>

<span class="c1">// èµ„æºç±»å‹æ ‡å¿—</span>
<span class="cp">#define IORESOURCE_IO      0x00000100     </span><span class="c1">// I/O ç«¯å£èµ„æº</span>
<span class="cp">#define IORESOURCE_MEM     0x00000200     </span><span class="c1">// å†…å­˜èµ„æº</span>
<span class="cp">#define IORESOURCE_REG     0x00000300     </span><span class="c1">// å¯„å­˜å™¨èµ„æº</span>
<span class="cp">#define IORESOURCE_IRQ     0x00000400     </span><span class="c1">// ä¸­æ–­èµ„æº</span>
<span class="cp">#define IORESOURCE_DMA     0x00000800     </span><span class="c1">// DMA èµ„æº</span>
<span class="cp">#define IORESOURCE_BUS     0x00001000     </span><span class="c1">// æ€»çº¿èµ„æº</span>
</code></pre></div>

<h3 id="832-device-tree">8.3.2 è®¾å¤‡æ ‘ï¼ˆDevice Treeï¼‰</h3>
<p>è®¾å¤‡æ ‘æ˜¯æè¿°ç¡¬ä»¶çš„æ•°æ®ç»“æ„ï¼Œä» PowerPC å¼•å…¥ï¼Œç°å·²æˆä¸º ARM/RISC-V ç­‰æ¶æ„çš„æ ‡å‡†ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="nf">/</span><span class="cm"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;vendor,board&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="kr">#address-cells</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="kr">#size-cells</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">;</span>

<span class="w">    </span><span class="nf">cpus</span><span class="cm"> </span><span class="p">{</span>
<span class="w">        </span><span class="kr">#address-cells</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">        </span><span class="kr">#size-cells</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">;</span>

<span class="w">        </span><span class="nf">cpu</span><span class="o">@</span><span class="mi">0</span><span class="cm"> </span><span class="p">{</span>
<span class="w">            </span><span class="kr">device_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;cpu&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="kr">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;arm,cortex-a72&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="kr">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x0</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">enable-method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;psci&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="nf">memory</span><span class="o">@</span><span class="mi">80000000</span><span class="cm"> </span><span class="p">{</span>
<span class="w">        </span><span class="kr">device_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;memory&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="kr">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x0</span><span class="w"> </span><span class="mh">0x80000000</span><span class="w"> </span><span class="mh">0x0</span><span class="w"> </span><span class="mh">0x80000000</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="nf">soc</span><span class="cm"> </span><span class="p">{</span>
<span class="w">        </span><span class="kr">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;simple-bus&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="kr">#address-cells</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">        </span><span class="kr">#size-cells</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">        </span><span class="kr">ranges</span><span class="p">;</span>

<span class="w">        </span><span class="nl">uart0</span><span class="p">:</span><span class="w"> </span><span class="nf">serial</span><span class="o">@</span><span class="mi">fe650000</span><span class="cm"> </span><span class="p">{</span>
<span class="w">            </span><span class="kr">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;vendor,uart&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="kr">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x0</span><span class="w"> </span><span class="mh">0xfe650000</span><span class="w"> </span><span class="mh">0x0</span><span class="w"> </span><span class="mh">0x100</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">interrupts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="na">GIC_SPI</span><span class="w"> </span><span class="mi">117</span><span class="w"> </span><span class="na">IRQ_TYPE_LEVEL_HIGH</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">clocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">cru</span><span class="w"> </span><span class="na">SCLK_UART0</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">cru</span><span class="w"> </span><span class="na">PCLK_UART0</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">clock-names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;baudclk&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;apb_pclk&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="kr">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;okay&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="nl">i2c0</span><span class="p">:</span><span class="w"> </span><span class="nf">i2c</span><span class="o">@</span><span class="mi">fe700000</span><span class="cm"> </span><span class="p">{</span>
<span class="w">            </span><span class="kr">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;vendor,i2c&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="kr">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x0</span><span class="w"> </span><span class="mh">0xfe700000</span><span class="w"> </span><span class="mh">0x0</span><span class="w"> </span><span class="mh">0x1000</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">interrupts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="na">GIC_SPI</span><span class="w"> </span><span class="mi">36</span><span class="w"> </span><span class="na">IRQ_TYPE_LEVEL_HIGH</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="kr">#address-cells</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="kr">#size-cells</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">clock-frequency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">400000</span><span class="o">&gt;</span><span class="p">;</span>

<span class="w">            </span><span class="nf">rtc</span><span class="o">@</span><span class="mi">51</span><span class="cm"> </span><span class="p">{</span>
<span class="w">                </span><span class="kr">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;nxp,pcf8563&quot;</span><span class="p">;</span>
<span class="w">                </span><span class="kr">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x51</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">                </span><span class="n">interrupt-parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="na">gpio0</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">                </span><span class="n">interrupts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="na">RK_PD3</span><span class="w"> </span><span class="na">IRQ_TYPE_EDGE_FALLING</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="p">};</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">    </span><span class="p">};</span>
<span class="p">};</span>
</code></pre></div>

<p>è®¾å¤‡æ ‘è§£æå’ŒåŒ¹é…ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// OF (Open Firmware) åŒ¹é…è¡¨</span>
<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">of_device_id</span><span class="w"> </span><span class="n">my_driver_of_match</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;vendor,device-v1&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">device_v1_data</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;vendor,device-v2&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">device_v2_data</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">of</span><span class="p">,</span><span class="w"> </span><span class="n">my_driver_of_match</span><span class="p">);</span>

<span class="c1">// ä»è®¾å¤‡æ ‘è·å–èµ„æº</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">my_probe</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">platform_device</span><span class="w"> </span><span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">device_node</span><span class="w"> </span><span class="o">*</span><span class="n">np</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">resource</span><span class="w"> </span><span class="o">*</span><span class="n">res</span><span class="p">;</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">__iomem</span><span class="w"> </span><span class="o">*</span><span class="n">base</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">irq</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// è·å–å†…å­˜èµ„æº</span>
<span class="w">    </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span><span class="w"> </span><span class="n">IORESOURCE_MEM</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">devm_ioremap_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">base</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// è·å–ä¸­æ–­èµ„æº</span>
<span class="w">    </span><span class="n">irq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">irq</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">irq</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// è§£æè‡ªå®šä¹‰å±æ€§</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">of_property_read_u32</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;custom-property&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">value</span><span class="p">))</span>
<span class="w">        </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DEFAULT_VALUE</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="84">8.4 å­—ç¬¦è®¾å¤‡é©±åŠ¨</h2>
<h3 id="841">8.4.1 å­—ç¬¦è®¾å¤‡åŸºç¡€</h3>
<p>å­—ç¬¦è®¾å¤‡æ˜¯ Linux ä¸­æœ€åŸºæœ¬çš„è®¾å¤‡ç±»å‹ä¹‹ä¸€ï¼Œä»¥å­—èŠ‚æµæ–¹å¼è®¿é—®ï¼Œä¸æ”¯æŒéšæœºè®¿é—®ã€‚å…¸å‹çš„å­—ç¬¦è®¾å¤‡åŒ…æ‹¬ç»ˆç«¯ã€ä¸²å£ã€é”®ç›˜ã€é¼ æ ‡ç­‰ã€‚</p>
<p>å­—ç¬¦è®¾å¤‡æ ¸å¿ƒæ•°æ®ç»“æ„ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">cdev</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kobject</span><span class="w"> </span><span class="n">kobj</span><span class="p">;</span><span class="w">                   </span><span class="c1">// å†…åµŒçš„ kobject</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">module</span><span class="w"> </span><span class="o">*</span><span class="n">owner</span><span class="p">;</span><span class="w">                  </span><span class="c1">// æ‰€å±æ¨¡å—</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_operations</span><span class="w"> </span><span class="o">*</span><span class="n">ops</span><span class="p">;</span><span class="w">     </span><span class="c1">// æ–‡ä»¶æ“ä½œé›†</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">list</span><span class="p">;</span><span class="w">                 </span><span class="c1">// è®¾å¤‡é“¾è¡¨</span>
<span class="w">    </span><span class="kt">dev_t</span><span class="w"> </span><span class="n">dev</span><span class="p">;</span><span class="w">                             </span><span class="c1">// è®¾å¤‡å·</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="w">                    </span><span class="c1">// æ¬¡è®¾å¤‡å·æ•°é‡</span>
<span class="p">};</span>

<span class="c1">// æ–‡ä»¶æ“ä½œé›†</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">file_operations</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">module</span><span class="w"> </span><span class="o">*</span><span class="n">owner</span><span class="p">;</span>
<span class="w">    </span><span class="n">loff_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">llseek</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">);</span>
<span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">read</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">write</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">read_iter</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">kiocb</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">iov_iter</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">write_iter</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">kiocb</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">iov_iter</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">iopoll</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">kiocb</span><span class="w"> </span><span class="o">*</span><span class="n">kiocb</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">io_comp_batch</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">iterate</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dir_context</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">iterate_shared</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dir_context</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="n">__poll_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">poll</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">poll_table_struct</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">unlocked_ioctl</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">);</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">compat_ioctl</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">mmap</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_area_struct</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">mmap_supported_flags</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">open</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">flush</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">fl_owner_t</span><span class="w"> </span><span class="n">id</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">release</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">fsync</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">datasync</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">fasync</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">lock</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_lock</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">sendpage</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">);</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="nf">long</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">get_unmapped_area</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">,</span>
<span class="w">                                       </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">check_flags</span><span class="p">)(</span><span class="kt">int</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">flock</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_lock</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">splice_write</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">pipe_inode_info</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span>
<span class="w">                            </span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">);</span>
<span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">splice_read</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">pipe_inode_info</span><span class="w"> </span><span class="o">*</span><span class="p">,</span>
<span class="w">                          </span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">setlease</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_lock</span><span class="w"> </span><span class="o">**</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="p">);</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">fallocate</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">show_fdinfo</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">seq_file</span><span class="w"> </span><span class="o">*</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">f</span><span class="p">);</span>
<span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">copy_file_range</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="p">,</span>
<span class="w">                               </span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">);</span>
<span class="w">    </span><span class="n">loff_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">remap_file_range</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">file_in</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="n">pos_in</span><span class="p">,</span>
<span class="w">                               </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">file_out</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="n">pos_out</span><span class="p">,</span>
<span class="w">                               </span><span class="n">loff_t</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">remap_flags</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">fadvise</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="842">8.4.2 è®¾å¤‡å·ç®¡ç†</h3>
<p>Linux ä½¿ç”¨ä¸»è®¾å¤‡å·å’Œæ¬¡è®¾å¤‡å·æ¥æ ‡è¯†è®¾å¤‡ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// è®¾å¤‡å·å®</span>
<span class="cp">#define MINORBITS    20                          </span><span class="c1">// æ¬¡è®¾å¤‡å·ä½æ•°</span>
<span class="cp">#define MINORMASK    ((1U &lt;&lt; MINORBITS) - 1)     </span><span class="c1">// æ¬¡è®¾å¤‡å·æ©ç </span>

<span class="cp">#define MAJOR(dev)   ((unsigned int) ((dev) &gt;&gt; MINORBITS))  </span><span class="c1">// è·å–ä¸»è®¾å¤‡å·</span>
<span class="cp">#define MINOR(dev)   ((unsigned int) ((dev) &amp; MINORMASK))   </span><span class="c1">// è·å–æ¬¡è®¾å¤‡å·</span>
<span class="cp">#define MKDEV(ma,mi) (((ma) &lt;&lt; MINORBITS) | (mi))           </span><span class="c1">// åˆæˆè®¾å¤‡å·</span>

<span class="c1">// åˆ†é…è®¾å¤‡å·</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">register_chrdev_region</span><span class="p">(</span><span class="kt">dev_t</span><span class="w"> </span><span class="n">from</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">);</span><span class="w">  </span><span class="c1">// é™æ€åˆ†é…</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">alloc_chrdev_region</span><span class="p">(</span><span class="kt">dev_t</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">baseminor</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w">   </span><span class="c1">// åŠ¨æ€åˆ†é…</span>
<span class="w">                        </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">unregister_chrdev_region</span><span class="p">(</span><span class="kt">dev_t</span><span class="w"> </span><span class="n">from</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">count</span><span class="p">);</span><span class="w">                 </span><span class="c1">// é‡Šæ”¾</span>
</code></pre></div>

<h3 id="843">8.4.3 å­—ç¬¦è®¾å¤‡é©±åŠ¨å®ä¾‹</h3>
<p>å®Œæ•´çš„å­—ç¬¦è®¾å¤‡é©±åŠ¨ç¤ºä¾‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/module.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/fs.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/cdev.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/device.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/uaccess.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/slab.h&gt;</span>

<span class="cp">#define DEVICE_NAME &quot;mychardev&quot;</span>
<span class="cp">#define CLASS_NAME &quot;mychar&quot;</span>
<span class="cp">#define BUFFER_SIZE 1024</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">mychar_dev</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">cdev</span><span class="w"> </span><span class="n">cdev</span><span class="p">;</span><span class="w">              </span><span class="c1">// å­—ç¬¦è®¾å¤‡ç»“æ„</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">device</span><span class="p">;</span><span class="w">         </span><span class="c1">// è®¾å¤‡ç»“æ„</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mutex</span><span class="w"> </span><span class="n">mutex</span><span class="p">;</span><span class="w">            </span><span class="c1">// äº’æ–¥é”</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="p">;</span><span class="w">                  </span><span class="c1">// æ•°æ®ç¼“å†²åŒº</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w">                   </span><span class="c1">// å½“å‰æ•°æ®å¤§å°</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="kt">dev_t</span><span class="w"> </span><span class="n">dev_number</span><span class="p">;</span><span class="w">          </span><span class="c1">// è®¾å¤‡å·</span>
<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">class</span><span class="w"> </span><span class="o">*</span><span class="n">dev_class</span><span class="p">;</span><span class="w">   </span><span class="c1">// è®¾å¤‡ç±»</span>
<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">mychar_dev</span><span class="w"> </span><span class="o">*</span><span class="n">mydev</span><span class="p">;</span><span class="w">  </span><span class="c1">// è®¾å¤‡å®ä¾‹</span>

<span class="c1">// æ‰“å¼€è®¾å¤‡</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">mychar_open</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mychar_dev</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">;</span>

<span class="w">    </span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">container_of</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_cdev</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">mychar_dev</span><span class="p">,</span><span class="w"> </span><span class="n">cdev</span><span class="p">);</span>
<span class="w">    </span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// è¯»å–è®¾å¤‡</span>
<span class="k">static</span><span class="w"> </span><span class="kt">ssize_t</span><span class="w"> </span><span class="nf">mychar_read</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">filp</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span>
<span class="w">                           </span><span class="kt">size_t</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="n">f_pos</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mychar_dev</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
<span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">f_pos</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">f_pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
<span class="w">        </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">*</span><span class="n">f_pos</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">*</span><span class="n">f_pos</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="o">*</span><span class="n">f_pos</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<span class="w">    </span><span class="n">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>

<span class="nl">out</span><span class="p">:</span>
<span class="w">    </span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// å†™å…¥è®¾å¤‡</span>
<span class="k">static</span><span class="w"> </span><span class="kt">ssize_t</span><span class="w"> </span><span class="nf">mychar_write</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">filp</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span>
<span class="w">                            </span><span class="kt">size_t</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="n">f_pos</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mychar_dev</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
<span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

<span class="w">    </span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">f_pos</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">BUFFER_SIZE</span><span class="p">)</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">f_pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">BUFFER_SIZE</span><span class="p">)</span>
<span class="w">        </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BUFFER_SIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">*</span><span class="n">f_pos</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">*</span><span class="n">f_pos</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="o">*</span><span class="n">f_pos</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">f_pos</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
<span class="w">        </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">f_pos</span><span class="p">;</span>
<span class="w">    </span><span class="n">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>

<span class="nl">out</span><span class="p">:</span>
<span class="w">    </span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// ioctl æ“ä½œ</span>
<span class="k">static</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">mychar_ioctl</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">filp</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">cmd</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mychar_dev</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// ioctl å‘½ä»¤å®šä¹‰</span>
<span class="w">    </span><span class="cp">#define MYCHAR_IOC_MAGIC &#39;k&#39;</span>
<span class="w">    </span><span class="cp">#define MYCHAR_IOCRESET  _IO(MYCHAR_IOC_MAGIC, 0)</span>
<span class="w">    </span><span class="cp">#define MYCHAR_IOCGSIZE  _IOR(MYCHAR_IOC_MAGIC, 1, int)</span>
<span class="w">    </span><span class="cp">#define MYCHAR_IOCSSIZE  _IOW(MYCHAR_IOC_MAGIC, 2, int)</span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">MYCHAR_IOCRESET</span><span class="p">:</span>
<span class="w">        </span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="w">        </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">memset</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">BUFFER_SIZE</span><span class="p">);</span>
<span class="w">        </span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">MYCHAR_IOCGSIZE</span><span class="p">:</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">))</span>
<span class="w">            </span><span class="n">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">MYCHAR_IOCSSIZE</span><span class="p">:</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">))</span>
<span class="w">            </span><span class="n">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="k">default</span><span class="o">:</span>
<span class="w">        </span><span class="n">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// æ–‡ä»¶æ“ä½œé›†</span>
<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_operations</span><span class="w"> </span><span class="n">mychar_fops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">open</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mychar_open</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mychar_read</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">write</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mychar_write</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">unlocked_ioctl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mychar_ioctl</span><span class="p">,</span>
<span class="p">};</span>

<span class="c1">// æ¨¡å—åˆå§‹åŒ–</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">mychar_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// åˆ†é…è®¾å¤‡å·</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_chrdev_region</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_number</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">DEVICE_NAME</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to allocate device number</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// åˆ›å»ºè®¾å¤‡ç±»</span>
<span class="w">    </span><span class="n">dev_class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">class_create</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">,</span><span class="w"> </span><span class="n">CLASS_NAME</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dev_class</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">unregister_chrdev_region</span><span class="p">(</span><span class="n">dev_number</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dev_class</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// åˆ†é…è®¾å¤‡ç»“æ„</span>
<span class="w">    </span><span class="n">mydev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mydev</span><span class="p">),</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mydev</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">fail_alloc</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// åˆ†é…ç¼“å†²åŒº</span>
<span class="w">    </span><span class="n">mydev</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kzalloc</span><span class="p">(</span><span class="n">BUFFER_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mydev</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">fail_buffer</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// åˆå§‹åŒ–å­—ç¬¦è®¾å¤‡</span>
<span class="w">    </span><span class="n">cdev_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mydev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mychar_fops</span><span class="p">);</span>
<span class="w">    </span><span class="n">mydev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">.</span><span class="n">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">THIS_MODULE</span><span class="p">;</span>
<span class="w">    </span><span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mydev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// æ·»åŠ å­—ç¬¦è®¾å¤‡</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cdev_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mydev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span><span class="w"> </span><span class="n">dev_number</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to add cdev</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">fail_cdev</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹</span>
<span class="w">    </span><span class="n">mydev</span><span class="o">-&gt;</span><span class="n">device</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device_create</span><span class="p">(</span><span class="n">dev_class</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">dev_number</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">DEVICE_NAME</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">mydev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">mydev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">fail_device</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;mychar driver initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_device</span><span class="p">:</span>
<span class="w">    </span><span class="n">cdev_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mydev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">);</span>
<span class="nl">fail_cdev</span><span class="p">:</span>
<span class="w">    </span><span class="n">kfree</span><span class="p">(</span><span class="n">mydev</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
<span class="nl">fail_buffer</span><span class="p">:</span>
<span class="w">    </span><span class="n">kfree</span><span class="p">(</span><span class="n">mydev</span><span class="p">);</span>
<span class="nl">fail_alloc</span><span class="p">:</span>
<span class="w">    </span><span class="n">class_destroy</span><span class="p">(</span><span class="n">dev_class</span><span class="p">);</span>
<span class="w">    </span><span class="n">unregister_chrdev_region</span><span class="p">(</span><span class="n">dev_number</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// æ¨¡å—é€€å‡º</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__exit</span><span class="w"> </span><span class="nf">mychar_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">device_destroy</span><span class="p">(</span><span class="n">dev_class</span><span class="p">,</span><span class="w"> </span><span class="n">dev_number</span><span class="p">);</span>
<span class="w">    </span><span class="n">cdev_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mydev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">);</span>
<span class="w">    </span><span class="n">kfree</span><span class="p">(</span><span class="n">mydev</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
<span class="w">    </span><span class="n">kfree</span><span class="p">(</span><span class="n">mydev</span><span class="p">);</span>
<span class="w">    </span><span class="n">class_destroy</span><span class="p">(</span><span class="n">dev_class</span><span class="p">);</span>
<span class="w">    </span><span class="n">unregister_chrdev_region</span><span class="p">(</span><span class="n">dev_number</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;mychar driver exited</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">mychar_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">mychar_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Linux Kernel Developer&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;A simple character device driver&quot;</span><span class="p">);</span>
</code></pre></div>

<h2 id="85">8.5 å—è®¾å¤‡é©±åŠ¨</h2>
<h3 id="851">8.5.1 å—è®¾å¤‡æ¶æ„</h3>
<p>å—è®¾å¤‡ä¸å­—ç¬¦è®¾å¤‡çš„ä¸»è¦åŒºåˆ«åœ¨äºï¼šå—è®¾å¤‡æ”¯æŒéšæœºè®¿é—®ï¼Œä»¥å›ºå®šå¤§å°çš„å—ä¸ºå•ä½è¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œå¹¶ä¸”å…·æœ‰è¯·æ±‚é˜Ÿåˆ—å’Œ I/O è°ƒåº¦æœºåˆ¶ã€‚</p>
<p>å—è®¾å¤‡æ ¸å¿ƒæ•°æ®ç»“æ„ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">gendisk</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">major</span><span class="p">;</span><span class="w">                              </span><span class="c1">// ä¸»è®¾å¤‡å·</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">first_minor</span><span class="p">;</span><span class="w">                       </span><span class="c1">// ç¬¬ä¸€ä¸ªæ¬¡è®¾å¤‡å·</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">minors</span><span class="p">;</span><span class="w">                             </span><span class="c1">// æ¬¡è®¾å¤‡å·æ•°é‡</span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">disk_name</span><span class="p">[</span><span class="n">DISK_NAME_LEN</span><span class="p">];</span><span class="w">        </span><span class="c1">// ç£ç›˜åç§°ï¼ˆå¦‚ sdaï¼‰</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">short</span><span class="w"> </span><span class="n">events</span><span class="p">;</span><span class="w">                  </span><span class="c1">// æ”¯æŒçš„äº‹ä»¶</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">short</span><span class="w"> </span><span class="n">event_flags</span><span class="p">;</span><span class="w">            </span><span class="c1">// äº‹ä»¶æ ‡å¿—</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">xarray</span><span class="w"> </span><span class="n">part_tbl</span><span class="p">;</span><span class="w">                </span><span class="c1">// åˆ†åŒºè¡¨</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">block_device</span><span class="w"> </span><span class="o">*</span><span class="n">part0</span><span class="p">;</span><span class="w">            </span><span class="c1">// æ•´ä¸ªç£ç›˜çš„ block_device</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">block_device_operations</span><span class="w"> </span><span class="o">*</span><span class="n">fops</span><span class="p">;</span><span class="w">  </span><span class="c1">// å—è®¾å¤‡æ“ä½œé›†</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">request_queue</span><span class="w"> </span><span class="o">*</span><span class="n">queue</span><span class="p">;</span><span class="w">           </span><span class="c1">// è¯·æ±‚é˜Ÿåˆ—</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">private_data</span><span class="p">;</span><span class="w">                    </span><span class="c1">// ç§æœ‰æ•°æ®</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span><span class="w">                             </span><span class="c1">// ç£ç›˜æ ‡å¿—</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">state</span><span class="p">;</span><span class="w">                   </span><span class="c1">// ç£ç›˜çŠ¶æ€</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mutex</span><span class="w"> </span><span class="n">open_mutex</span><span class="p">;</span><span class="w">               </span><span class="c1">// æ‰“å¼€äº’æ–¥é”</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">open_partitions</span><span class="p">;</span><span class="w">              </span><span class="c1">// æ‰“å¼€çš„åˆ†åŒºæ•°</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">backing_dev_info</span><span class="w"> </span><span class="o">*</span><span class="n">bdi</span><span class="p">;</span><span class="w">         </span><span class="c1">// åå¤‡è®¾å¤‡ä¿¡æ¯</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kobject</span><span class="w"> </span><span class="o">*</span><span class="n">slave_dir</span><span class="p">;</span><span class="w">            </span><span class="c1">// ä»å±ç›®å½•</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">timer_rand_state</span><span class="w"> </span><span class="o">*</span><span class="n">random</span><span class="p">;</span><span class="w">      </span><span class="c1">// éšæœºæ•°çŠ¶æ€</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">sync_io</span><span class="p">;</span><span class="w">                      </span><span class="c1">// åŒæ­¥ I/O è®¡æ•°</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">disk_events</span><span class="w"> </span><span class="o">*</span><span class="n">ev</span><span class="p">;</span><span class="w">               </span><span class="c1">// ç£ç›˜äº‹ä»¶</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kobject</span><span class="w"> </span><span class="n">integrity_kobj</span><span class="p">;</span><span class="w">        </span><span class="c1">// å®Œæ•´æ€§ kobject</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">cdrom_device_info</span><span class="w"> </span><span class="o">*</span><span class="n">cdi</span><span class="p">;</span><span class="w">        </span><span class="c1">// CD-ROM ä¿¡æ¯</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">node_id</span><span class="p">;</span><span class="w">                           </span><span class="c1">// NUMA èŠ‚ç‚¹ ID</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">badblocks</span><span class="w"> </span><span class="o">*</span><span class="n">bb</span><span class="p">;</span><span class="w">                  </span><span class="c1">// åå—ä¿¡æ¯</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lockdep_map</span><span class="w"> </span><span class="n">lockdep_map</span><span class="p">;</span><span class="w">       </span><span class="c1">// é”ä¾èµ–æ˜ å°„</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">diskseq</span><span class="p">;</span><span class="w">                          </span><span class="c1">// ç£ç›˜åºåˆ—å·</span>
<span class="p">};</span>

<span class="c1">// å—è®¾å¤‡æ“ä½œé›†</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">block_device_operations</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">open</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">block_device</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">fmode_t</span><span class="p">);</span><span class="w">       </span><span class="c1">// æ‰“å¼€è®¾å¤‡</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">release</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">gendisk</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">fmode_t</span><span class="p">);</span><span class="w">        </span><span class="c1">// é‡Šæ”¾è®¾å¤‡</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">rw_page</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">block_device</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">sector_t</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">ioctl</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">block_device</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">fmode_t</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">compat_ioctl</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">block_device</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">fmode_t</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">);</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="nf">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">check_events</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">gendisk</span><span class="w"> </span><span class="o">*</span><span class="n">disk</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">clearing</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">unlock_native_capacity</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">gendisk</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">revalidate_disk</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">gendisk</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">getgeo</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">block_device</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">hd_geometry</span><span class="w"> </span><span class="o">*</span><span class="p">);</span><span class="w">  </span><span class="c1">// è·å–å‡ ä½•ä¿¡æ¯</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">swap_slot_free_notify</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">block_device</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">report_zones</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">gendisk</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">sector_t</span><span class="w"> </span><span class="n">sector</span><span class="p">,</span>
<span class="w">                       </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nr_zones</span><span class="p">,</span><span class="w"> </span><span class="n">report_zones_cb</span><span class="w"> </span><span class="n">cb</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">devnode</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">gendisk</span><span class="w"> </span><span class="o">*</span><span class="n">disk</span><span class="p">,</span><span class="w"> </span><span class="n">umode_t</span><span class="w"> </span><span class="o">*</span><span class="n">mode</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">module</span><span class="w"> </span><span class="o">*</span><span class="n">owner</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">pr_ops</span><span class="w"> </span><span class="o">*</span><span class="n">pr_ops</span><span class="p">;</span><span class="w">           </span><span class="c1">// æŒä¹…é¢„ç•™æ“ä½œ</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">alternative_gpt_sector</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">gendisk</span><span class="w"> </span><span class="o">*</span><span class="n">disk</span><span class="p">,</span><span class="w"> </span><span class="n">sector_t</span><span class="w"> </span><span class="o">*</span><span class="n">sector</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="852-bio">8.5.2 è¯·æ±‚é˜Ÿåˆ—å’Œ bio</h3>
<p>å—è®¾å¤‡çš„ I/O è¯·æ±‚é€šè¿‡ bioï¼ˆBlock I/Oï¼‰ç»“æ„æè¿°ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">bio</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bio</span><span class="w">          </span><span class="o">*</span><span class="n">bi_next</span><span class="p">;</span><span class="w">          </span><span class="c1">// è¯·æ±‚é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ª bio</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">gendisk</span><span class="w">      </span><span class="o">*</span><span class="n">bi_disk</span><span class="p">;</span><span class="w">          </span><span class="c1">// ç›®æ ‡ç£ç›˜</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">        </span><span class="n">bi_opf</span><span class="p">;</span><span class="w">            </span><span class="c1">// æ“ä½œæ ‡å¿—</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">short</span><span class="w">      </span><span class="n">bi_flags</span><span class="p">;</span><span class="w">          </span><span class="c1">// çŠ¶æ€æ ‡å¿—</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">short</span><span class="w">      </span><span class="n">bi_ioprio</span><span class="p">;</span><span class="w">         </span><span class="c1">// I/O ä¼˜å…ˆçº§</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">short</span><span class="w">      </span><span class="n">bi_write_hint</span><span class="p">;</span><span class="w">     </span><span class="c1">// å†™å…¥æç¤º</span>
<span class="w">    </span><span class="n">blk_status_t</span><span class="w">        </span><span class="n">bi_status</span><span class="p">;</span><span class="w">         </span><span class="c1">// å®ŒæˆçŠ¶æ€</span>
<span class="w">    </span><span class="n">u8</span><span class="w">                  </span><span class="n">bi_partno</span><span class="p">;</span><span class="w">         </span><span class="c1">// åˆ†åŒºå·</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w">            </span><span class="n">__bi_remaining</span><span class="p">;</span><span class="w">    </span><span class="c1">// å‰©ä½™è®¡æ•°</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bvec_iter</span><span class="w">    </span><span class="n">bi_iter</span><span class="p">;</span><span class="w">           </span><span class="c1">// å½“å‰è¿­ä»£å™¨</span>

<span class="w">    </span><span class="n">bio_end_io_t</span><span class="w">        </span><span class="o">*</span><span class="n">bi_end_io</span><span class="p">;</span><span class="w">        </span><span class="c1">// å®Œæˆå›è°ƒå‡½æ•°</span>
<span class="w">    </span><span class="kt">void</span><span class="w">                </span><span class="o">*</span><span class="n">bi_private</span><span class="p">;</span><span class="w">       </span><span class="c1">// ç§æœ‰æ•°æ®</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">blkcg_gq</span><span class="w">     </span><span class="o">*</span><span class="n">bi_blkg</span><span class="p">;</span><span class="w">          </span><span class="c1">// cgroup ä¿¡æ¯</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bio_issue</span><span class="w">    </span><span class="n">bi_issue</span><span class="p">;</span><span class="w">          </span><span class="c1">// å‘å‡ºæ—¶é—´æˆ³</span>

<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">bio_integrity_payload</span><span class="w"> </span><span class="o">*</span><span class="n">bi_integrity</span><span class="p">;</span><span class="w">  </span><span class="c1">// å®Œæ•´æ€§è½½è·</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">short</span><span class="w">      </span><span class="n">bi_vcnt</span><span class="p">;</span><span class="w">           </span><span class="c1">// bio_vec æ•°é‡</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">short</span><span class="w">      </span><span class="n">bi_max_vecs</span><span class="p">;</span><span class="w">       </span><span class="c1">// æœ€å¤§ bio_vec æ•°é‡</span>

<span class="w">    </span><span class="n">atomic_t</span><span class="w">            </span><span class="n">__bi_cnt</span><span class="p">;</span><span class="w">          </span><span class="c1">// å¼•ç”¨è®¡æ•°</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bio_vec</span><span class="w">      </span><span class="o">*</span><span class="n">bi_io_vec</span><span class="p">;</span><span class="w">        </span><span class="c1">// I/O å‘é‡æ•°ç»„</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bio_set</span><span class="w">      </span><span class="o">*</span><span class="n">bi_pool</span><span class="p">;</span><span class="w">          </span><span class="c1">// æ¥æºçš„ bio æ± </span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bio_vec</span><span class="w">      </span><span class="n">bi_inline_vecs</span><span class="p">[];</span><span class="w">  </span><span class="c1">// å†…è”å‘é‡æ•°ç»„</span>
<span class="p">};</span>

<span class="c1">// bio å‘é‡ï¼šæè¿°å†…å­˜é¡µé¢</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">bio_vec</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w">     </span><span class="o">*</span><span class="n">bv_page</span><span class="p">;</span><span class="w">              </span><span class="c1">// é¡µé¢æŒ‡é’ˆ</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">    </span><span class="n">bv_len</span><span class="p">;</span><span class="w">                </span><span class="c1">// é•¿åº¦</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">    </span><span class="n">bv_offset</span><span class="p">;</span><span class="w">             </span><span class="c1">// é¡µå†…åç§»</span>
<span class="p">};</span>

<span class="c1">// è¯·æ±‚ç»“æ„</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">request</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">request_queue</span><span class="w"> </span><span class="o">*</span><span class="n">q</span><span class="p">;</span><span class="w">               </span><span class="c1">// æ‰€å±é˜Ÿåˆ—</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">blk_mq_ctx</span><span class="w"> </span><span class="o">*</span><span class="n">mq_ctx</span><span class="p">;</span><span class="w">            </span><span class="c1">// å¤šé˜Ÿåˆ—ä¸Šä¸‹æ–‡</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">blk_mq_hw_ctx</span><span class="w"> </span><span class="o">*</span><span class="n">mq_hctx</span><span class="p">;</span><span class="w">        </span><span class="c1">// ç¡¬ä»¶é˜Ÿåˆ—ä¸Šä¸‹æ–‡</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">cmd_flags</span><span class="p">;</span><span class="w">                </span><span class="c1">// å‘½ä»¤æ ‡å¿—</span>
<span class="w">    </span><span class="n">req_flags_t</span><span class="w"> </span><span class="n">rq_flags</span><span class="p">;</span><span class="w">                 </span><span class="c1">// è¯·æ±‚æ ‡å¿—</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tag</span><span class="p">;</span><span class="w">                               </span><span class="c1">// è¯·æ±‚æ ‡ç­¾</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">internal_tag</span><span class="p">;</span><span class="w">                      </span><span class="c1">// å†…éƒ¨æ ‡ç­¾</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__data_len</span><span class="p">;</span><span class="w">              </span><span class="c1">// æ•°æ®é•¿åº¦</span>
<span class="w">    </span><span class="n">sector_t</span><span class="w"> </span><span class="n">__sector</span><span class="p">;</span><span class="w">                     </span><span class="c1">// èµ·å§‹æ‰‡åŒº</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bio</span><span class="w"> </span><span class="o">*</span><span class="n">bio</span><span class="p">;</span><span class="w">                       </span><span class="c1">// bio é“¾è¡¨å¤´</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bio</span><span class="w"> </span><span class="o">*</span><span class="n">biotail</span><span class="p">;</span><span class="w">                   </span><span class="c1">// bio é“¾è¡¨å°¾</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">queuelist</span><span class="p">;</span><span class="w">           </span><span class="c1">// é˜Ÿåˆ—é“¾è¡¨èŠ‚ç‚¹</span>

<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_node</span><span class="w"> </span><span class="n">hash</span><span class="p">;</span><span class="w">            </span><span class="c1">// å“ˆå¸Œé“¾è¡¨èŠ‚ç‚¹</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">ipi_list</span><span class="p">;</span><span class="w">        </span><span class="c1">// IPI é“¾è¡¨</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">rb_node</span><span class="w"> </span><span class="n">rb_node</span><span class="p">;</span><span class="w">            </span><span class="c1">// çº¢é»‘æ ‘èŠ‚ç‚¹</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">bio_vec</span><span class="w"> </span><span class="n">special_vec</span><span class="p">;</span><span class="w">       </span><span class="c1">// ç‰¹æ®Šå‘é‡</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">completion_data</span><span class="p">;</span><span class="w">             </span><span class="c1">// å®Œæˆæ•°æ®</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">error_count</span><span class="p">;</span><span class="w">                   </span><span class="c1">// é”™è¯¯è®¡æ•°</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">struct</span><span class="w"> </span><span class="nc">io_cq</span><span class="w"> </span><span class="o">*</span><span class="n">icq</span><span class="p">;</span><span class="w">            </span><span class="c1">// I/O ä¸Šä¸‹æ–‡é˜Ÿåˆ—</span>
<span class="w">            </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">priv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w">                </span><span class="c1">// ç§æœ‰æ•°æ®</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="n">elv</span><span class="p">;</span>

<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">seq</span><span class="p">;</span><span class="w">              </span><span class="c1">// åºåˆ—å·</span>
<span class="w">            </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">list</span><span class="p">;</span><span class="w">        </span><span class="c1">// é“¾è¡¨</span>
<span class="w">            </span><span class="n">rq_end_io_fn</span><span class="w"> </span><span class="o">*</span><span class="n">saved_end_io</span><span class="p">;</span><span class="w">   </span><span class="c1">// ä¿å­˜çš„å®Œæˆå‡½æ•°</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="n">flush</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">__call_single_data</span><span class="w"> </span><span class="n">csd</span><span class="p">;</span><span class="w">    </span><span class="c1">// å•æ¬¡è°ƒç”¨æ•°æ®</span>
<span class="w">        </span><span class="n">u64</span><span class="w"> </span><span class="n">fifo_time</span><span class="p">;</span><span class="w">                    </span><span class="c1">// FIFO æ—¶é—´</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">rq_end_io_fn</span><span class="w"> </span><span class="o">*</span><span class="n">end_io</span><span class="p">;</span><span class="w">                 </span><span class="c1">// å®Œæˆå›è°ƒå‡½æ•°</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">end_io_data</span><span class="p">;</span><span class="w">                    </span><span class="c1">// å®Œæˆå›è°ƒæ•°æ®</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="853">8.5.3 å—è®¾å¤‡é©±åŠ¨å®ä¾‹</h3>
<p>ç®€å•çš„å†…å­˜å—è®¾å¤‡é©±åŠ¨ç¤ºä¾‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/module.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/blkdev.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/hdreg.h&gt;</span>

<span class="cp">#define MEMBLK_DISK_NAME    &quot;memblk&quot;</span>
<span class="cp">#define MEMBLK_MINORS       16</span>
<span class="cp">#define MEMBLK_SECTOR_SIZE  512</span>
<span class="cp">#define MEMBLK_NSECTORS     (16 * 1024 * 2)  </span><span class="c1">// 16MB</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">memblk_device</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">major</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">gendisk</span><span class="w"> </span><span class="o">*</span><span class="n">disk</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">request_queue</span><span class="w"> </span><span class="o">*</span><span class="n">queue</span><span class="p">;</span>
<span class="w">    </span><span class="n">spinlock_t</span><span class="w"> </span><span class="n">lock</span><span class="p">;</span>
<span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">;</span><span class="w">                              </span><span class="c1">// æ•°æ®å­˜å‚¨åŒº</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w">                           </span><span class="c1">// è®¾å¤‡å¤§å°</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">memblk_device</span><span class="w"> </span><span class="o">*</span><span class="n">memblk_dev</span><span class="p">;</span>

<span class="c1">// å¤„ç† I/O è¯·æ±‚</span>
<span class="k">static</span><span class="w"> </span><span class="n">blk_status_t</span><span class="w"> </span><span class="nf">memblk_queue_rq</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">blk_mq_hw_ctx</span><span class="w"> </span><span class="o">*</span><span class="n">hctx</span><span class="p">,</span>
<span class="w">                                    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">blk_mq_queue_data</span><span class="w"> </span><span class="o">*</span><span class="n">bd</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">request</span><span class="w"> </span><span class="o">*</span><span class="n">rq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">memblk_device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queuedata</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bio_vec</span><span class="w"> </span><span class="n">bvec</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">req_iterator</span><span class="w"> </span><span class="n">iter</span><span class="p">;</span>
<span class="w">    </span><span class="n">loff_t</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">rq</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">9</span><span class="p">;</span><span class="w">     </span><span class="c1">// æ‰‡åŒºè½¬å­—èŠ‚</span>
<span class="w">    </span><span class="n">loff_t</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="p">;</span>

<span class="w">    </span><span class="n">blk_mq_start_request</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Request beyond device capacity</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">blk_mq_end_request</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span><span class="w"> </span><span class="n">BLK_STS_IOERR</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">BLK_STS_IOERR</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// éå†è¯·æ±‚ä¸­çš„æ‰€æœ‰ bio å‘é‡</span>
<span class="w">    </span><span class="n">rq_for_each_segment</span><span class="p">(</span><span class="n">bvec</span><span class="p">,</span><span class="w"> </span><span class="n">rq</span><span class="p">,</span><span class="w"> </span><span class="n">iter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">page_address</span><span class="p">(</span><span class="n">bvec</span><span class="p">.</span><span class="n">bv_page</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bvec</span><span class="p">.</span><span class="n">bv_offset</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">rq</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">WRITE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// å†™æ“ä½œï¼šä» buffer å¤åˆ¶åˆ°è®¾å¤‡</span>
<span class="w">            </span><span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">data</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">bvec</span><span class="p">.</span><span class="n">bv_len</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// è¯»æ“ä½œï¼šä»è®¾å¤‡å¤åˆ¶åˆ° buffer</span>
<span class="w">            </span><span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">data</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">bvec</span><span class="p">.</span><span class="n">bv_len</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">pos</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">bvec</span><span class="p">.</span><span class="n">bv_len</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">blk_mq_end_request</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span><span class="w"> </span><span class="n">BLK_STS_OK</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">BLK_STS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// å—è®¾å¤‡æ“ä½œé›†</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">memblk_open</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">block_device</span><span class="w"> </span><span class="o">*</span><span class="n">bdev</span><span class="p">,</span><span class="w"> </span><span class="n">fmode_t</span><span class="w"> </span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">memblk_release</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">gendisk</span><span class="w"> </span><span class="o">*</span><span class="n">disk</span><span class="p">,</span><span class="w"> </span><span class="n">fmode_t</span><span class="w"> </span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">memblk_getgeo</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">block_device</span><span class="w"> </span><span class="o">*</span><span class="n">bdev</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">hd_geometry</span><span class="w"> </span><span class="o">*</span><span class="n">geo</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">memblk_device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">MEMBLK_SECTOR_SIZE</span><span class="p">;</span>

<span class="w">    </span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">cylinders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="mh">0x3f</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span>
<span class="w">    </span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">heads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">    </span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
<span class="w">    </span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">block_device_operations</span><span class="w"> </span><span class="n">memblk_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">open</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memblk_open</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">release</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memblk_release</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">getgeo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memblk_getgeo</span><span class="p">,</span>
<span class="p">};</span>

<span class="c1">// å¤šé˜Ÿåˆ—æ“ä½œé›†</span>
<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">blk_mq_ops</span><span class="w"> </span><span class="n">memblk_mq_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">queue_rq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memblk_queue_rq</span><span class="p">,</span>
<span class="p">};</span>

<span class="c1">// æ¨¡å—åˆå§‹åŒ–</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">memblk_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// åˆ†é…è®¾å¤‡ç»“æ„</span>
<span class="w">    </span><span class="n">memblk_dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">memblk_dev</span><span class="p">),</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">memblk_dev</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// åˆ†é…æ•°æ®å­˜å‚¨åŒº</span>
<span class="w">    </span><span class="n">memblk_dev</span><span class="o">-&gt;</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MEMBLK_NSECTORS</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">MEMBLK_SECTOR_SIZE</span><span class="p">;</span>
<span class="w">    </span><span class="n">memblk_dev</span><span class="o">-&gt;</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vzalloc</span><span class="p">(</span><span class="n">memblk_dev</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">memblk_dev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">fail_data</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// æ³¨å†Œå—è®¾å¤‡ä¸»è®¾å¤‡å·</span>
<span class="w">    </span><span class="n">memblk_dev</span><span class="o">-&gt;</span><span class="n">major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">register_blkdev</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MEMBLK_DISK_NAME</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">memblk_dev</span><span class="o">-&gt;</span><span class="n">major</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memblk_dev</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">;</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">fail_register</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// åˆ†é… gendisk</span>
<span class="w">    </span><span class="n">memblk_dev</span><span class="o">-&gt;</span><span class="n">disk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_disk</span><span class="p">(</span><span class="n">MEMBLK_MINORS</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">memblk_dev</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">fail_disk</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// åˆå§‹åŒ–è¯·æ±‚é˜Ÿåˆ—</span>
<span class="w">    </span><span class="n">memblk_dev</span><span class="o">-&gt;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blk_mq_init_sq_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">memblk_dev</span><span class="o">-&gt;</span><span class="n">tag_set</span><span class="p">,</span>
<span class="w">                                                   </span><span class="o">&amp;</span><span class="n">memblk_mq_ops</span><span class="p">,</span>
<span class="w">                                                   </span><span class="mi">128</span><span class="p">,</span>
<span class="w">                                                   </span><span class="n">BLK_MQ_F_SHOULD_MERGE</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">memblk_dev</span><span class="o">-&gt;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">memblk_dev</span><span class="o">-&gt;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">fail_queue</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">memblk_dev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memblk_dev</span><span class="o">-&gt;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">;</span>
<span class="w">    </span><span class="n">memblk_dev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">queuedata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memblk_dev</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// è®¾ç½® gendisk å±æ€§</span>
<span class="w">    </span><span class="n">memblk_dev</span><span class="o">-&gt;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memblk_dev</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">;</span>
<span class="w">    </span><span class="n">memblk_dev</span><span class="o">-&gt;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">first_minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">memblk_dev</span><span class="o">-&gt;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">fops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">memblk_ops</span><span class="p">;</span>
<span class="w">    </span><span class="n">memblk_dev</span><span class="o">-&gt;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memblk_dev</span><span class="p">;</span>
<span class="w">    </span><span class="n">snprintf</span><span class="p">(</span><span class="n">memblk_dev</span><span class="o">-&gt;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="n">MEMBLK_DISK_NAME</span><span class="p">);</span>
<span class="w">    </span><span class="n">set_capacity</span><span class="p">(</span><span class="n">memblk_dev</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">,</span><span class="w"> </span><span class="n">MEMBLK_NSECTORS</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// æ·»åŠ ç£ç›˜</span>
<span class="w">    </span><span class="n">add_disk</span><span class="p">(</span><span class="n">memblk_dev</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">);</span>

<span class="w">    </span><span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;memblk: initialized, size=%zu bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">memblk_dev</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_queue</span><span class="p">:</span>
<span class="w">    </span><span class="n">put_disk</span><span class="p">(</span><span class="n">memblk_dev</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">);</span>
<span class="nl">fail_disk</span><span class="p">:</span>
<span class="w">    </span><span class="n">unregister_blkdev</span><span class="p">(</span><span class="n">memblk_dev</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span><span class="w"> </span><span class="n">MEMBLK_DISK_NAME</span><span class="p">);</span>
<span class="nl">fail_register</span><span class="p">:</span>
<span class="w">    </span><span class="n">vfree</span><span class="p">(</span><span class="n">memblk_dev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="nl">fail_data</span><span class="p">:</span>
<span class="w">    </span><span class="n">kfree</span><span class="p">(</span><span class="n">memblk_dev</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// æ¨¡å—é€€å‡º</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__exit</span><span class="w"> </span><span class="nf">memblk_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">del_gendisk</span><span class="p">(</span><span class="n">memblk_dev</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">);</span>
<span class="w">    </span><span class="n">blk_cleanup_queue</span><span class="p">(</span><span class="n">memblk_dev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
<span class="w">    </span><span class="n">put_disk</span><span class="p">(</span><span class="n">memblk_dev</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">);</span>
<span class="w">    </span><span class="n">unregister_blkdev</span><span class="p">(</span><span class="n">memblk_dev</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span><span class="w"> </span><span class="n">MEMBLK_DISK_NAME</span><span class="p">);</span>
<span class="w">    </span><span class="n">vfree</span><span class="p">(</span><span class="n">memblk_dev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="w">    </span><span class="n">kfree</span><span class="p">(</span><span class="n">memblk_dev</span><span class="p">);</span>
<span class="w">    </span><span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;memblk: exited</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">memblk_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">memblk_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Linux Kernel Developer&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Simple memory block device driver&quot;</span><span class="p">);</span>
</code></pre></div>
            </article>
            
            <nav class="page-nav"><a href="chapter7.html" class="nav-link prev">â† ç¬¬7ç« ï¼šå—è®¾å¤‡å±‚ä¸I/Oè°ƒåº¦</a><a href="chapter9.html" class="nav-link next">ç¬¬9ç« ï¼šç½‘ç»œåè®®æ ˆ â†’</a></nav>
        </main>
    </div>
</body>
</html>