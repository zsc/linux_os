<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>第5章：虚拟文件系统（VFS）</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>目录</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="搜索..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Linux 内核源代码深度解析</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第1章：Linux 内核概述与发展史</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第2章：进程管理与任务调度</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第3章：内存管理架构</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第4章：进程间通信机制</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第5章：虚拟文件系统（VFS）</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第6章：具体文件系统实现</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第7章：块设备层与I/O调度</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第8章：设备驱动模型</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第9章：网络协议栈</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第10章：内核同步机制</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第11章：并发编程模型</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第12章：容器与命名空间</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第13章：安全子系统</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第14章：实时Linux</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第15章：性能分析与调试</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第16章：引导过程与初始化</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="5vfs">第5章：虚拟文件系统（VFS）</h1>
<h2 id="_1">章节大纲</h2>
<ol>
<li>
<p><strong>开篇与VFS概述</strong>
   - VFS的设计哲学与目标
   - VFS在Linux内核中的位置
   - 统一文件模型的重要性</p>
</li>
<li>
<p><strong>VFS核心架构</strong>
   - 2.1 四大核心对象</p>
<ul>
<li>超级块（superblock）</li>
<li>索引节点（inode）</li>
<li>目录项（dentry）</li>
<li>文件对象（file）</li>
<li>2.2 对象间的关系与生命周期</li>
<li>2.3 VFS操作表（operations）</li>
</ul>
</li>
<li>
<p><strong>文件系统注册与挂载</strong>
   - 3.1 文件系统类型注册
   - 3.2 挂载过程分析
   - 3.3 命名空间与挂载传播
   - 3.4 根文件系统的特殊处理</p>
</li>
<li>
<p><strong>路径名查找与目录项缓存</strong>
   - 4.1 路径解析算法
   - 4.2 目录项缓存（dcache）机制
   - 4.3 RCU路径遍历优化
   - 4.4 符号链接处理</p>
</li>
<li>
<p><strong>文件操作接口实现</strong>
   - 5.1 系统调用到VFS的映射
   - 5.2 文件描述符管理
   - 5.3 读写操作路径
   - 5.4 内存映射（mmap）支持</p>
</li>
<li>
<p><strong>算法焦点</strong>
   - 哈希表在dcache中的应用
   - LRU缓存管理策略
   - RCU在路径查找中的应用
   - 负目录项（negative dentry）优化</p>
</li>
<li>
<p><strong>历史故事</strong>
   - VFS层的诞生与演进
   - Al Viro的VFS重构贡献
   - 从单一文件系统到多文件系统支持</p>
</li>
<li>
<p><strong>高级话题</strong>
   - overlayfs与容器存储
   - FUSE用户态文件系统
   - VFS层的并发优化
   - 延迟分配与预读策略</p>
</li>
</ol>
<h2 id="_2">本章学习目标</h2>
<p>完成本章学习后，您将能够：</p>
<ol>
<li>理解VFS的抽象层设计及其在内核中的核心作用</li>
<li>掌握VFS四大对象的数据结构和相互关系</li>
<li>分析文件系统挂载和路径查找的实现机制</li>
<li>理解dcache的优化策略和RCU的应用</li>
<li>掌握从系统调用到具体文件系统的完整调用链</li>
<li>能够实现简单的虚拟文件系统</li>
</ol>
<hr />
<h2 id="1">1. 引言</h2>
<p>虚拟文件系统（Virtual File System，VFS）是Linux内核中最优雅的设计之一。它通过在用户空间和具体文件系统实现之间建立一个抽象层，使得Linux能够支持数十种不同的文件系统，从传统的ext4、XFS，到网络文件系统NFS、SMB，再到特殊用途的proc、sysfs，所有这些都能通过统一的接口被访问。本章将深入剖析VFS的设计理念、核心数据结构、关键算法以及性能优化技术，帮助您理解Linux如何实现"一切皆文件"的设计哲学。</p>
<h2 id="2-vfs">2. VFS核心架构</h2>
<h3 id="21-vfs">2.1 VFS的设计哲学</h3>
<p>VFS的核心设计目标是提供一个统一的文件访问接口，隐藏底层文件系统的实现细节。这种抽象带来了三个关键优势：</p>
<ol>
<li><strong>透明性</strong>：应用程序无需关心文件存储在哪种文件系统上</li>
<li><strong>可扩展性</strong>：新文件系统可以通过实现VFS接口轻松集成</li>
<li><strong>一致性</strong>：所有文件操作遵循相同的语义和错误处理机制</li>
</ol>
<p>VFS在内核中的位置可以用以下ASCII图表示：</p>
<div class="codehilite"><pre><span></span><code>    用户空间应用程序
         |
    系统调用接口 (open, read, write, close...)
         |
    +---------+
    |   VFS   |  &lt;--- 抽象层
    +---------+
         |
    +----+----+----+----+
    |    |    |    |    |
   ext4 XFS  NFS proc tmpfs  &lt;--- 具体文件系统
</code></pre></div>

<h3 id="22">2.2 四大核心对象</h3>
<p>VFS通过四个核心对象来抽象文件系统的概念：</p>
<h4 id="221-struct-super_block">2.2.1 超级块（struct super_block）</h4>
<p>超级块代表一个已挂载的文件系统实例，包含文件系统的全局信息：</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w">    </span><span class="n">s_list</span><span class="p">;</span><span class="w">        </span><span class="cm">/* 超级块链表 */</span>
<span class="w">    </span><span class="kt">dev_t</span><span class="w">               </span><span class="n">s_dev</span><span class="p">;</span><span class="w">         </span><span class="cm">/* 设备标识符 */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w">       </span><span class="n">s_blocksize_bits</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">       </span><span class="n">s_blocksize</span><span class="p">;</span><span class="w">   </span><span class="cm">/* 块大小 */</span>
<span class="w">    </span><span class="n">loff_t</span><span class="w">              </span><span class="n">s_maxbytes</span><span class="p">;</span><span class="w">    </span><span class="cm">/* 最大文件大小 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_system_type</span><span class="w"> </span><span class="o">*</span><span class="n">s_type</span><span class="p">;</span><span class="w">   </span><span class="cm">/* 文件系统类型 */</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">super_operations</span><span class="w"> </span><span class="o">*</span><span class="n">s_op</span><span class="p">;</span><span class="w"> </span><span class="cm">/* 超级块操作表 */</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">       </span><span class="n">s_flags</span><span class="p">;</span><span class="w">       </span><span class="cm">/* 挂载标志 */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">       </span><span class="n">s_magic</span><span class="p">;</span><span class="w">       </span><span class="cm">/* 魔数 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w">       </span><span class="o">*</span><span class="n">s_root</span><span class="p">;</span><span class="w">       </span><span class="cm">/* 根目录项 */</span>

<span class="w">    </span><span class="kt">int</span><span class="w">                 </span><span class="n">s_count</span><span class="p">;</span><span class="w">       </span><span class="cm">/* 引用计数 */</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w">            </span><span class="n">s_active</span><span class="p">;</span><span class="w">      </span><span class="cm">/* 活动引用计数 */</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w">    </span><span class="n">s_inodes</span><span class="p">;</span><span class="w">      </span><span class="cm">/* inode链表 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w">    </span><span class="n">s_dirty</span><span class="p">;</span><span class="w">       </span><span class="cm">/* 脏inode链表 */</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">block_device</span><span class="w"> </span><span class="o">*</span><span class="n">s_bdev</span><span class="p">;</span><span class="w">       </span><span class="cm">/* 块设备 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">backing_dev_info</span><span class="w"> </span><span class="o">*</span><span class="n">s_bdi</span><span class="p">;</span><span class="w">    </span><span class="cm">/* 后备设备信息 */</span>

<span class="w">    </span><span class="kt">void</span><span class="w">                </span><span class="o">*</span><span class="n">s_fs_info</span><span class="p">;</span><span class="w">    </span><span class="cm">/* 文件系统私有信息 */</span>

<span class="w">    </span><span class="cm">/* 配额、安全等其他字段... */</span>
<span class="p">};</span>
</code></pre></div>

<p>超级块操作表（super_operations）定义了文件系统级别的操作：</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">super_operations</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">alloc_inode</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="o">*</span><span class="n">sb</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">destroy_inode</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">dirty_inode</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">write_inode</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">writeback_control</span><span class="w"> </span><span class="o">*</span><span class="n">wbc</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">drop_inode</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">evict_inode</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">put_super</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">sync_fs</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="o">*</span><span class="n">sb</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">wait</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">statfs</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">kstatfs</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">remount_fs</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="cm">/* 更多操作... */</span>
<span class="p">};</span>
</code></pre></div>

<h4 id="222-struct-inode">2.2.2 索引节点（struct inode）</h4>
<p>inode代表文件系统中的一个对象（文件、目录、设备等），包含对象的元数据：</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">umode_t</span><span class="w">             </span><span class="n">i_mode</span><span class="p">;</span><span class="w">        </span><span class="cm">/* 文件类型和权限 */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">short</span><span class="w">      </span><span class="n">i_opflags</span><span class="p">;</span>
<span class="w">    </span><span class="n">kuid_t</span><span class="w">              </span><span class="n">i_uid</span><span class="p">;</span><span class="w">         </span><span class="cm">/* 所有者用户ID */</span>
<span class="w">    </span><span class="n">kgid_t</span><span class="w">              </span><span class="n">i_gid</span><span class="p">;</span><span class="w">         </span><span class="cm">/* 所有者组ID */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">        </span><span class="n">i_flags</span><span class="p">;</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode_operations</span><span class="w"> </span><span class="o">*</span><span class="n">i_op</span><span class="p">;</span><span class="w">  </span><span class="cm">/* inode操作表 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w">  </span><span class="o">*</span><span class="n">i_sb</span><span class="p">;</span><span class="w">         </span><span class="cm">/* 所属超级块 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">address_space</span><span class="w"> </span><span class="o">*</span><span class="n">i_mapping</span><span class="p">;</span><span class="w">   </span><span class="cm">/* 页缓存映射 */</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">       </span><span class="n">i_ino</span><span class="p">;</span><span class="w">         </span><span class="cm">/* inode号 */</span>
<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i_nlink</span><span class="p">;</span><span class="w">    </span><span class="cm">/* 硬链接计数 */</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__i_nlink</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="kt">dev_t</span><span class="w">               </span><span class="n">i_rdev</span><span class="p">;</span><span class="w">        </span><span class="cm">/* 设备号（设备文件） */</span>
<span class="w">    </span><span class="n">loff_t</span><span class="w">              </span><span class="n">i_size</span><span class="p">;</span><span class="w">        </span><span class="cm">/* 文件大小 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec64</span><span class="w">   </span><span class="n">i_atime</span><span class="p">;</span><span class="w">       </span><span class="cm">/* 访问时间 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec64</span><span class="w">   </span><span class="n">i_mtime</span><span class="p">;</span><span class="w">       </span><span class="cm">/* 修改时间 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec64</span><span class="w">   </span><span class="n">i_ctime</span><span class="p">;</span><span class="w">       </span><span class="cm">/* 状态改变时间 */</span>

<span class="w">    </span><span class="n">spinlock_t</span><span class="w">          </span><span class="n">i_lock</span><span class="p">;</span><span class="w">        </span><span class="cm">/* 保护inode的自旋锁 */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">short</span><span class="w">      </span><span class="n">i_bytes</span><span class="p">;</span><span class="w">       </span><span class="cm">/* 最后一个块的字节数 */</span>
<span class="w">    </span><span class="n">u8</span><span class="w">                  </span><span class="n">i_blkbits</span><span class="p">;</span><span class="w">     </span><span class="cm">/* 块大小的位数 */</span>

<span class="w">    </span><span class="n">atomic_t</span><span class="w">            </span><span class="n">i_count</span><span class="p">;</span><span class="w">       </span><span class="cm">/* 引用计数 */</span>

<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">pipe_inode_info</span><span class="w"> </span><span class="o">*</span><span class="n">i_pipe</span><span class="p">;</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">block_device</span><span class="w"> </span><span class="o">*</span><span class="n">i_bdev</span><span class="p">;</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">cdev</span><span class="w">         </span><span class="o">*</span><span class="n">i_cdev</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_operations</span><span class="w"> </span><span class="o">*</span><span class="n">i_fop</span><span class="p">;</span><span class="w">  </span><span class="cm">/* 文件操作表 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_lock_context</span><span class="w"> </span><span class="o">*</span><span class="n">i_flctx</span><span class="p">;</span><span class="w">    </span><span class="cm">/* 文件锁上下文 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">address_space</span><span class="w"> </span><span class="n">i_data</span><span class="p">;</span><span class="w">          </span><span class="cm">/* 设备的地址空间 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w">    </span><span class="n">i_devices</span><span class="p">;</span><span class="w">        </span><span class="cm">/* 设备链表 */</span>

<span class="w">    </span><span class="kt">void</span><span class="w">                </span><span class="o">*</span><span class="n">i_private</span><span class="p">;</span><span class="w">       </span><span class="cm">/* 文件系统私有数据 */</span>
<span class="p">};</span>
</code></pre></div>

<h4 id="223-struct-dentry">2.2.3 目录项（struct dentry）</h4>
<p>目录项是路径名的一个组成部分，它将文件名与对应的inode关联起来。目录项的设计是VFS性能优化的关键：</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">        </span><span class="n">d_flags</span><span class="p">;</span><span class="w">       </span><span class="cm">/* 目录项标志 */</span>
<span class="w">    </span><span class="n">seqcount_spinlock_t</span><span class="w"> </span><span class="n">d_seq</span><span class="p">;</span><span class="w">         </span><span class="cm">/* 用于RCU查找的序列计数器 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_bl_node</span><span class="w"> </span><span class="n">d_hash</span><span class="p">;</span><span class="w">       </span><span class="cm">/* 哈希表链接 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w">       </span><span class="o">*</span><span class="n">d_parent</span><span class="p">;</span><span class="w">     </span><span class="cm">/* 父目录项 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">qstr</span><span class="w">         </span><span class="n">d_name</span><span class="p">;</span><span class="w">        </span><span class="cm">/* 文件名 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w">        </span><span class="o">*</span><span class="n">d_inode</span><span class="p">;</span><span class="w">      </span><span class="cm">/* 关联的inode */</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w">       </span><span class="n">d_iname</span><span class="p">[</span><span class="n">DNAME_INLINE_LEN</span><span class="p">];</span><span class="w"> </span><span class="cm">/* 短文件名优化 */</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lockref</span><span class="w">      </span><span class="n">d_lockref</span><span class="p">;</span><span class="w">     </span><span class="cm">/* 引用计数和自旋锁 */</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry_operations</span><span class="w"> </span><span class="o">*</span><span class="n">d_op</span><span class="p">;</span><span class="w">  </span><span class="cm">/* 目录项操作表 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w">  </span><span class="o">*</span><span class="n">d_sb</span><span class="p">;</span><span class="w">         </span><span class="cm">/* 所属超级块 */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">       </span><span class="n">d_time</span><span class="p">;</span><span class="w">        </span><span class="cm">/* 重验证时间 */</span>
<span class="w">    </span><span class="kt">void</span><span class="w">                </span><span class="o">*</span><span class="n">d_fsdata</span><span class="p">;</span><span class="w">     </span><span class="cm">/* 文件系统私有数据 */</span>

<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">d_lru</span><span class="p">;</span><span class="w">        </span><span class="cm">/* LRU链表 */</span>
<span class="w">        </span><span class="n">wait_queue_head_t</span><span class="w"> </span><span class="o">*</span><span class="n">d_wait</span><span class="p">;</span><span class="w">     </span><span class="cm">/* 等待队列 */</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w">    </span><span class="n">d_child</span><span class="p">;</span><span class="w">       </span><span class="cm">/* 父目录的子项链表 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w">    </span><span class="n">d_subdirs</span><span class="p">;</span><span class="w">     </span><span class="cm">/* 子目录链表 */</span>

<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_node</span><span class="w"> </span><span class="n">d_alias</span><span class="p">;</span><span class="w">     </span><span class="cm">/* inode别名链表 */</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_bl_node</span><span class="w"> </span><span class="n">d_in_lookup_hash</span><span class="p">;</span><span class="w"> </span><span class="cm">/* 查找哈希表 */</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">rcu_head</span><span class="w"> </span><span class="n">d_rcu</span><span class="p">;</span><span class="w">         </span><span class="cm">/* RCU回收头 */</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">d_u</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>

<p>目录项有三种状态：</p>
<ul>
<li><strong>使用中（in use）</strong>：d_inode指向有效inode，引用计数&gt;0</li>
<li><strong>未使用（unused）</strong>：d_inode指向有效inode，引用计数=0，保留在缓存中</li>
<li><strong>负目录项（negative）</strong>：d_inode为NULL，表示不存在的文件，用于加速查找失败</li>
</ul>
<h4 id="224-struct-file">2.2.4 文件对象（struct file）</h4>
<p>文件对象代表进程打开的一个文件，包含文件的当前状态：</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">llist_node</span><span class="w">   </span><span class="n">fu_llist</span><span class="p">;</span><span class="w">   </span><span class="cm">/* 文件对象链表 */</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">rcu_head</span><span class="w">     </span><span class="n">fu_rcuhead</span><span class="p">;</span><span class="w"> </span><span class="cm">/* RCU回收头 */</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">f_u</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">path</span><span class="w">         </span><span class="n">f_path</span><span class="p">;</span><span class="w">        </span><span class="cm">/* 包含dentry和vfsmount */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w">        </span><span class="o">*</span><span class="n">f_inode</span><span class="p">;</span><span class="w">      </span><span class="cm">/* 缓存的inode指针 */</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_operations</span><span class="w"> </span><span class="o">*</span><span class="n">f_op</span><span class="p">;</span><span class="w"> </span><span class="cm">/* 文件操作表 */</span>

<span class="w">    </span><span class="n">spinlock_t</span><span class="w">          </span><span class="n">f_lock</span><span class="p">;</span><span class="w">        </span><span class="cm">/* 保护文件对象的锁 */</span>
<span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="n">rw_hint</span><span class="w">        </span><span class="n">f_write_hint</span><span class="p">;</span><span class="w">  </span><span class="cm">/* 写入提示 */</span>
<span class="w">    </span><span class="n">atomic_long_t</span><span class="w">       </span><span class="n">f_count</span><span class="p">;</span><span class="w">       </span><span class="cm">/* 引用计数 */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">        </span><span class="n">f_flags</span><span class="p">;</span><span class="w">       </span><span class="cm">/* 文件标志（O_RDONLY等） */</span>
<span class="w">    </span><span class="n">fmode_t</span><span class="w">             </span><span class="n">f_mode</span><span class="p">;</span><span class="w">        </span><span class="cm">/* 文件模式 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mutex</span><span class="w">        </span><span class="n">f_pos_lock</span><span class="p">;</span><span class="w">    </span><span class="cm">/* 保护f_pos */</span>
<span class="w">    </span><span class="n">loff_t</span><span class="w">              </span><span class="n">f_pos</span><span class="p">;</span><span class="w">         </span><span class="cm">/* 文件位置 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">fown_struct</span><span class="w">  </span><span class="n">f_owner</span><span class="p">;</span><span class="w">       </span><span class="cm">/* 异步I/O的所有者 */</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">cred</span><span class="w">   </span><span class="o">*</span><span class="n">f_cred</span><span class="p">;</span><span class="w">       </span><span class="cm">/* 打开文件时的凭证 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_ra_state</span><span class="w"> </span><span class="n">f_ra</span><span class="p">;</span><span class="w">         </span><span class="cm">/* 预读状态 */</span>

<span class="w">    </span><span class="n">u64</span><span class="w">                 </span><span class="n">f_version</span><span class="p">;</span><span class="w">     </span><span class="cm">/* 版本号 */</span>
<span class="w">    </span><span class="kt">void</span><span class="w">                </span><span class="o">*</span><span class="n">private_data</span><span class="p">;</span><span class="w"> </span><span class="cm">/* 私有数据 */</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">address_space</span><span class="w"> </span><span class="o">*</span><span class="n">f_mapping</span><span class="p">;</span><span class="w">   </span><span class="cm">/* 页缓存映射 */</span>
<span class="w">    </span><span class="n">errseq_t</span><span class="w">            </span><span class="n">f_wb_err</span><span class="p">;</span><span class="w">      </span><span class="cm">/* 写回错误 */</span>
<span class="w">    </span><span class="n">errseq_t</span><span class="w">            </span><span class="n">f_sb_err</span><span class="p">;</span><span class="w">      </span><span class="cm">/* 超级块错误 */</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="23-vfs">2.3 VFS操作表</h3>
<p>VFS通过操作表（operations structure）实现多态性。每个对象都有对应的操作表：</p>
<ol>
<li><strong>super_operations</strong>：文件系统级操作（创建/删除inode、同步等）</li>
<li><strong>inode_operations</strong>：inode级操作（创建、删除、查找等）</li>
<li><strong>dentry_operations</strong>：目录项操作（比较、哈希、验证等）</li>
<li><strong>file_operations</strong>：文件操作（读、写、打开、关闭等）</li>
<li><strong>address_space_operations</strong>：地址空间操作（页面读写、内存映射等）</li>
</ol>
<p>这种设计允许不同文件系统提供自己的实现，同时保持接口的一致性。</p>
<h3 id="24">2.4 对象间的关系</h3>
<p>VFS对象之间存在复杂的引用关系：</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nx">super_block</span>
<span class="w">         </span><span class="o">|</span>
<span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="nx">s_root</span>
<span class="w">         </span><span class="err">↓</span>
<span class="w">      </span><span class="nx">dentry</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="p">)</span>
<span class="w">         </span><span class="o">|</span>
<span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="nx">d_inode</span>
<span class="w">         </span><span class="err">↓</span>
<span class="w">       </span><span class="nx">inode</span>
<span class="w">         </span><span class="o">|</span>
<span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="nx">i_mapping</span>
<span class="w">         </span><span class="err">↓</span>
<span class="w">   </span><span class="nx">address_space</span>

<span class="w">   </span><span class="nx">进程</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="nx">dentry</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="nx">inode</span>
<span class="w">             </span><span class="err">↓</span>
<span class="w">          </span><span class="nx">f_path</span><span class="p">.</span><span class="nx">mnt</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="nx">vfsmount</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="nx">super_block</span>
</code></pre></div>

<p>这些关系确保了：</p>
<ul>
<li>文件系统的层次结构</li>
<li>引用计数的正确管理</li>
<li>内存回收的安全性</li>
<li>并发访问的一致性</li>
</ul>
<h2 id="3">3. 文件系统注册与挂载</h2>
<h3 id="31">3.1 文件系统类型注册</h3>
<p>Linux支持的每种文件系统都必须先注册到内核中。文件系统类型由<code>struct file_system_type</code>表示：</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">file_system_type</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span><span class="w">               </span><span class="cm">/* 文件系统名称 */</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fs_flags</span><span class="p">;</span><span class="w">                   </span><span class="cm">/* 文件系统标志 */</span>
<span class="cp">#define FS_REQUIRES_DEV         1   </span><span class="cm">/* 需要块设备 */</span>
<span class="cp">#define FS_BINARY_MOUNTDATA     2   </span><span class="cm">/* 二进制挂载数据 */</span>
<span class="cp">#define FS_HAS_SUBTYPE          4   </span><span class="cm">/* 有子类型 */</span>
<span class="cp">#define FS_USERNS_MOUNT         8   </span><span class="cm">/* 可在用户命名空间挂载 */</span>
<span class="cp">#define FS_DISALLOW_NOTIFY_PERM 16  </span><span class="cm">/* 禁用fanotify权限事件 */</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">mount</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file_system_type</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span>
<span class="w">                           </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">kill_sb</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">module</span><span class="w"> </span><span class="o">*</span><span class="n">owner</span><span class="p">;</span><span class="w">           </span><span class="cm">/* 所属模块 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_system_type</span><span class="w"> </span><span class="o">*</span><span class="n">next</span><span class="p">;</span><span class="w">  </span><span class="cm">/* 链表中的下一个 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_head</span><span class="w"> </span><span class="n">fs_supers</span><span class="p">;</span><span class="w">    </span><span class="cm">/* 该类型的超级块链表 */</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lock_class_key</span><span class="w"> </span><span class="n">s_lock_key</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lock_class_key</span><span class="w"> </span><span class="n">s_umount_key</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lock_class_key</span><span class="w"> </span><span class="n">s_vfs_rename_key</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lock_class_key</span><span class="w"> </span><span class="n">s_writers_key</span><span class="p">[</span><span class="n">SB_FREEZE_LEVELS</span><span class="p">];</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lock_class_key</span><span class="w"> </span><span class="n">i_lock_key</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lock_class_key</span><span class="w"> </span><span class="n">i_mutex_key</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lock_class_key</span><span class="w"> </span><span class="n">i_mutex_dir_key</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>

<p>文件系统注册通过<code>register_filesystem()</code>完成：</p>
<div class="codehilite"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">register_filesystem</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file_system_type</span><span class="w"> </span><span class="o">*</span><span class="n">fs</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_system_type</span><span class="w"> </span><span class="o">**</span><span class="n">p</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

<span class="w">    </span><span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file_systems_lock</span><span class="p">);</span>
<span class="w">    </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">find_filesystem</span><span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="w">        </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fs</span><span class="p">;</span>
<span class="w">    </span><span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file_systems_lock</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="32">3.2 挂载过程分析</h3>
<p>文件系统挂载是将存储设备上的文件系统连接到目录树的过程。挂载涉及以下关键步骤：</p>
<h4 id="321">3.2.1 挂载系统调用</h4>
<div class="codehilite"><pre><span></span><code><span class="n">SYSCALL_DEFINE5</span><span class="p">(</span><span class="n">mount</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">dev_name</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">dir_name</span><span class="p">,</span>
<span class="w">                </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ksys_mount</span><span class="p">(</span><span class="n">dev_name</span><span class="p">,</span><span class="w"> </span><span class="n">dir_name</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="322">3.2.2 挂载过程的核心步骤</h4>
<ol>
<li><strong>路径查找</strong>：找到挂载点的dentry</li>
<li><strong>文件系统查找</strong>：根据类型名找到file_system_type</li>
<li><strong>超级块创建</strong>：调用文件系统的mount方法创建超级块</li>
<li><strong>挂载连接</strong>：创建mount结构，连接到挂载树</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">mount</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_node</span><span class="w"> </span><span class="n">mnt_hash</span><span class="p">;</span><span class="w">     </span><span class="cm">/* 挂载哈希表 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mount</span><span class="w"> </span><span class="o">*</span><span class="n">mnt_parent</span><span class="p">;</span><span class="w">        </span><span class="cm">/* 父挂载点 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="n">mnt_mountpoint</span><span class="p">;</span><span class="w">   </span><span class="cm">/* 挂载点目录项 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vfsmount</span><span class="w"> </span><span class="n">mnt</span><span class="p">;</span><span class="w">             </span><span class="cm">/* VFS挂载信息 */</span>

<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">rcu_head</span><span class="w"> </span><span class="n">mnt_rcu</span><span class="p">;</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">llist_node</span><span class="w"> </span><span class="n">mnt_llist</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mnt_pcp</span><span class="w"> </span><span class="n">__percpu</span><span class="w"> </span><span class="o">*</span><span class="n">mnt_pcp</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">mnt_mounts</span><span class="p">;</span><span class="w">    </span><span class="cm">/* 子挂载链表 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">mnt_child</span><span class="p">;</span><span class="w">     </span><span class="cm">/* 父挂载的子项 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">mnt_instance</span><span class="p">;</span><span class="w">  </span><span class="cm">/* 挂载实例链表 */</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">mnt_devname</span><span class="p">;</span><span class="w">        </span><span class="cm">/* 设备名 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">mnt_list</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">mnt_expire</span><span class="p">;</span><span class="w">    </span><span class="cm">/* 过期链表 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">mnt_share</span><span class="p">;</span><span class="w">     </span><span class="cm">/* 共享挂载链表 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">mnt_slave_list</span><span class="p">;</span><span class="cm">/* 从属挂载链表 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">mnt_slave</span><span class="p">;</span><span class="w">     </span><span class="cm">/* 从属链表 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mount</span><span class="w"> </span><span class="o">*</span><span class="n">mnt_master</span><span class="p">;</span><span class="w">        </span><span class="cm">/* 主挂载点 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mnt_namespace</span><span class="w"> </span><span class="o">*</span><span class="n">mnt_ns</span><span class="p">;</span><span class="w">   </span><span class="cm">/* 挂载命名空间 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mountpoint</span><span class="w"> </span><span class="o">*</span><span class="n">mnt_mp</span><span class="p">;</span><span class="w">      </span><span class="cm">/* 挂载点 */</span>
<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_node</span><span class="w"> </span><span class="n">mnt_mp_list</span><span class="p">;</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_node</span><span class="w"> </span><span class="n">mnt_umount</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">mnt_umounting</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">fsnotify_mark_connector</span><span class="w"> </span><span class="n">__rcu</span><span class="w"> </span><span class="o">*</span><span class="n">mnt_fsnotify_marks</span><span class="p">;</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">mnt_fsnotify_mask</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mnt_id</span><span class="p">;</span><span class="w">                     </span><span class="cm">/* 挂载ID */</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mnt_group_id</span><span class="p">;</span><span class="w">               </span><span class="cm">/* 组ID */</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mnt_expiry_mark</span><span class="p">;</span><span class="w">            </span><span class="cm">/* 过期标记 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_head</span><span class="w"> </span><span class="n">mnt_pins</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_head</span><span class="w"> </span><span class="n">mnt_stuck_children</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="33">3.3 命名空间与挂载传播</h3>
<p>Linux支持挂载命名空间，允许不同进程看到不同的文件系统视图：</p>
<h4 id="331">3.3.1 挂载命名空间</h4>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">mnt_namespace</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="w">                  </span><span class="cm">/* 引用计数 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ns_common</span><span class="w"> </span><span class="n">ns</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mount</span><span class="w"> </span><span class="o">*</span><span class="n">root</span><span class="p">;</span><span class="w">              </span><span class="cm">/* 根挂载点 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">list</span><span class="p">;</span><span class="w">           </span><span class="cm">/* 挂载点链表 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">user_namespace</span><span class="w"> </span><span class="o">*</span><span class="n">user_ns</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ucounts</span><span class="w"> </span><span class="o">*</span><span class="n">ucounts</span><span class="p">;</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">seq</span><span class="p">;</span><span class="w">                         </span><span class="cm">/* 序列号 */</span>
<span class="w">    </span><span class="n">wait_queue_head_t</span><span class="w"> </span><span class="n">poll</span><span class="p">;</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">event</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mounts</span><span class="p">;</span><span class="w">             </span><span class="cm">/* 挂载点数量 */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pending_mounts</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>

<h4 id="332">3.3.2 挂载传播类型</h4>
<p>Linux支持四种挂载传播类型：</p>
<ol>
<li><strong>MS_SHARED</strong>：共享挂载，挂载/卸载操作会传播到同组其他挂载点</li>
<li><strong>MS_PRIVATE</strong>：私有挂载，挂载/卸载操作不传播</li>
<li><strong>MS_SLAVE</strong>：从属挂载，单向接收主挂载点的传播</li>
<li><strong>MS_UNBINDABLE</strong>：不可绑定挂载，不能作为bind mount的源</li>
</ol>
<p>传播机制的实现：</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">propagate_one</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mount</span><span class="w"> </span><span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mount</span><span class="w"> </span><span class="o">*</span><span class="n">child</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_MNT_NEW</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* 判断传播类型 */</span>
<span class="w">    </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CL_SLAVE</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_MNT_SHARED</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
<span class="w">        </span><span class="n">type</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">CL_MAKE_SHARED</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* 复制挂载 */</span>
<span class="w">    </span><span class="n">child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">copy_tree</span><span class="p">(</span><span class="n">source</span><span class="p">,</span><span class="w"> </span><span class="n">source</span><span class="o">-&gt;</span><span class="n">mnt</span><span class="p">.</span><span class="n">mnt_root</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* 附加到目标 */</span>
<span class="w">    </span><span class="n">mnt_set_mountpoint</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">mp</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">);</span>
<span class="w">    </span><span class="n">child</span><span class="o">-&gt;</span><span class="n">mnt_parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="p">;</span>
<span class="w">    </span><span class="n">child</span><span class="o">-&gt;</span><span class="n">mnt_master</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mnt_master</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* 加入挂载哈希表 */</span>
<span class="w">    </span><span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">mnt_hash</span><span class="p">,</span><span class="w"> </span><span class="n">tree_list</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">count_mounts</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mnt_ns</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="34">3.4 根文件系统的特殊处理</h3>
<p>根文件系统是系统启动时第一个挂载的文件系统，具有特殊的初始化过程：</p>
<h4 id="341-initramfs">3.4.1 早期根文件系统（initramfs）</h4>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">populate_rootfs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">err</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* 解压内置的initramfs */</span>
<span class="w">    </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unpack_to_rootfs</span><span class="p">(</span><span class="n">__initramfs_start</span><span class="p">,</span>
<span class="w">                           </span><span class="n">__initramfs_size</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
<span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;Failed to unpack initramfs: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* 如果有外部initrd */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">initrd_start</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cp">#ifdef CONFIG_BLK_DEV_RAM</span>
<span class="w">        </span><span class="cm">/* 创建/initrd.image */</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ksys_open</span><span class="p">(</span><span class="s">&quot;/initrd.image&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="n">O_WRONLY</span><span class="o">|</span><span class="n">O_CREAT</span><span class="p">,</span><span class="w"> </span><span class="mo">0700</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">ksys_write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">initrd_start</span><span class="p">,</span>
<span class="w">                      </span><span class="n">initrd_end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">initrd_start</span><span class="p">);</span>
<span class="w">            </span><span class="n">ksys_close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="cp">#else</span>
<span class="w">        </span><span class="cm">/* 直接解压 */</span>
<span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unpack_to_rootfs</span><span class="p">((</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">initrd_start</span><span class="p">,</span>
<span class="w">                               </span><span class="n">initrd_end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">initrd_start</span><span class="p">);</span>
<span class="w">        </span><span class="cp">#endif</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">rootfs_initcall</span><span class="p">(</span><span class="n">populate_rootfs</span><span class="p">);</span>
</code></pre></div>

<h4 id="342">3.4.2 真实根文件系统切换</h4>
<p>从initramfs切换到真实根文件系统的过程：</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">prepare_namespace</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">root_delay</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="w"> </span><span class="s">&quot;Waiting %d sec before mounting root device...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">               </span><span class="n">root_delay</span><span class="p">);</span>
<span class="w">        </span><span class="n">ssleep</span><span class="p">(</span><span class="n">root_delay</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* 等待根设备出现 */</span>
<span class="w">    </span><span class="n">wait_for_device_probe</span><span class="p">();</span>

<span class="w">    </span><span class="cm">/* 挂载根文件系统 */</span>
<span class="w">    </span><span class="n">mount_root</span><span class="p">();</span>

<span class="w">    </span><span class="cm">/* 切换根目录 */</span>
<span class="w">    </span><span class="n">ksys_chdir</span><span class="p">(</span><span class="s">&quot;/root&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">mount_block_root</span><span class="p">();</span>
<span class="w">    </span><span class="n">mount_root_generic</span><span class="p">();</span>

<span class="w">    </span><span class="cm">/* 移动挂载点 */</span>
<span class="w">    </span><span class="n">ksys_mount</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">MS_MOVE</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">ksys_chroot</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="4">4. 路径名查找与目录项缓存</h2>
<p>路径名查找是VFS最频繁的操作之一，其性能直接影响系统整体性能。Linux通过目录项缓存（dcache）和RCU优化实现了高效的路径查找。</p>
<h3 id="41">4.1 路径解析算法</h3>
<p>路径名解析将文件路径转换为对应的dentry和inode。核心函数是<code>path_lookupat()</code>：</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">path_lookupat</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">nameidata</span><span class="w"> </span><span class="o">*</span><span class="n">nd</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">path</span><span class="w"> </span><span class="o">*</span><span class="n">path</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path_init</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">link_path_walk</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">nd</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">           </span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup_last</span><span class="p">(</span><span class="n">nd</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">        </span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">;</span>
<span class="w">        </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">mnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">        </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dentry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">terminate_walk</span><span class="p">(</span><span class="n">nd</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="411">4.1.1 路径查找数据结构</h4>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">nameidata</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">path</span><span class="w">     </span><span class="n">path</span><span class="p">;</span><span class="w">           </span><span class="cm">/* 当前路径 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">qstr</span><span class="w">     </span><span class="n">last</span><span class="p">;</span><span class="w">           </span><span class="cm">/* 最后一个组件 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">path</span><span class="w">     </span><span class="n">root</span><span class="p">;</span><span class="w">           </span><span class="cm">/* 根目录 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w">    </span><span class="o">*</span><span class="n">inode</span><span class="p">;</span><span class="w">         </span><span class="cm">/* 当前inode */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">    </span><span class="n">flags</span><span class="p">;</span><span class="w">          </span><span class="cm">/* 查找标志 */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w">        </span><span class="n">seq</span><span class="p">;</span><span class="w">            </span><span class="cm">/* 序列号（RCU） */</span>
<span class="w">    </span><span class="kt">int</span><span class="w">             </span><span class="n">last_type</span><span class="p">;</span><span class="w">      </span><span class="cm">/* 最后组件类型 */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w">        </span><span class="n">depth</span><span class="p">;</span><span class="w">          </span><span class="cm">/* 符号链接深度 */</span>
<span class="w">    </span><span class="kt">int</span><span class="w">             </span><span class="n">total_link_count</span><span class="p">;</span><span class="w"> </span><span class="cm">/* 总链接数 */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">saved</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">path</span><span class="w"> </span><span class="n">link</span><span class="p">;</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">delayed_call</span><span class="w"> </span><span class="n">done</span><span class="p">;</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">seq</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="o">*</span><span class="n">stack</span><span class="p">,</span><span class="w"> </span><span class="n">internal</span><span class="p">[</span><span class="n">EMBEDDED_LEVELS</span><span class="p">];</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">filename</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">nameidata</span><span class="w"> </span><span class="o">*</span><span class="n">saved</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w">        </span><span class="n">root_seq</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w">             </span><span class="n">dfd</span><span class="p">;</span>
<span class="w">    </span><span class="n">kuid_t</span><span class="w">          </span><span class="n">dir_uid</span><span class="p">;</span>
<span class="w">    </span><span class="n">umode_t</span><span class="w">         </span><span class="n">dir_mode</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>

<h4 id="412">4.1.2 路径遍历核心算法</h4>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">link_path_walk</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">nameidata</span><span class="w"> </span><span class="o">*</span><span class="n">nd</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;/&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="n">name</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!*</span><span class="n">name</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="p">(;;)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">u64</span><span class="w"> </span><span class="n">hash_len</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>

<span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">may_lookup</span><span class="p">(</span><span class="n">nd</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>

<span class="w">        </span><span class="n">hash_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash_name</span><span class="p">(</span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dentry</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>

<span class="w">        </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LAST_NORM</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;.&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">hashlen_len</span><span class="p">(</span><span class="n">hash_len</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;.&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LAST_DOTDOT</span><span class="p">;</span>
<span class="w">                    </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">LOOKUP_JUMPED</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span>
<span class="w">                </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LAST_DOT</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">LAST_NORM</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dentry</span><span class="p">;</span>
<span class="w">            </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">LOOKUP_JUMPED</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">d_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">DCACHE_OP_HASH</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">struct</span><span class="w"> </span><span class="nc">qstr</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">hash_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash_len</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="p">};</span>
<span class="w">                </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">d_op</span><span class="o">-&gt;</span><span class="n">d_hash</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">this</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<span class="w">                </span><span class="n">hash_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">hash_len</span><span class="p">;</span>
<span class="w">                </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">.</span><span class="n">hash_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash_len</span><span class="p">;</span>
<span class="w">        </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
<span class="w">        </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">last_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>

<span class="w">        </span><span class="n">name</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">hashlen_len</span><span class="p">(</span><span class="n">hash_len</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!*</span><span class="n">name</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">name</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">*</span><span class="n">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;/&#39;</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!*</span><span class="n">name</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">LOOKUP_DIRECTORY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">LOOKUP_FOLLOW</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">LOOKUP_DOTDOT</span><span class="p">;</span>
<span class="w">            </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">last_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LAST_ROOT</span><span class="p">;</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">walk_component</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span><span class="w"> </span><span class="n">WALK_MORE</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_link</span><span class="p">(</span><span class="n">nd</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">s</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">stack</span><span class="p">[</span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">depth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">].</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
<span class="w">                </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">;</span>
<span class="w">                </span><span class="k">continue</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="42-dcache">4.2 目录项缓存（dcache）机制</h3>
<p>dcache是VFS性能的关键，它缓存了最近使用的目录项，避免重复的磁盘访问。</p>
<h4 id="421-dcache">4.2.1 dcache哈希表</h4>
<p>dcache使用全局哈希表快速查找目录项：</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_bl_head</span><span class="w"> </span><span class="o">*</span><span class="n">dentry_hashtable</span><span class="w"> </span><span class="n">__read_mostly</span><span class="p">;</span>

<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_bl_head</span><span class="w"> </span><span class="o">*</span><span class="n">d_hash</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">hash</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">dentry_hashtable</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">hash</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">d_hash_shift</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">d_hash_name</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">,</span>
<span class="w">                                       </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">qstr</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">init_name_hash</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span>
<span class="w">        </span><span class="n">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">partial_name_hash</span><span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">hash</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">end_name_hash</span><span class="p">(</span><span class="n">hash</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="422-dcache">4.2.2 dcache查找</h4>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="n">__d_lookup</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">qstr</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d_hash_name</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_bl_head</span><span class="w"> </span><span class="o">*</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d_hash</span><span class="p">(</span><span class="n">hash</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_bl_node</span><span class="w"> </span><span class="o">*</span><span class="n">node</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="n">dentry</span><span class="p">;</span>

<span class="w">    </span><span class="n">rcu_read_lock</span><span class="p">();</span>
<span class="w">    </span><span class="n">hlist_bl_for_each_entry_rcu</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">d_hash</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">hash</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">hash</span><span class="p">)</span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span>

<span class="w">        </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_parent</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">parent</span><span class="p">)</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">next</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">d_unhashed</span><span class="p">(</span><span class="n">dentry</span><span class="p">))</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">next</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">d_same_name</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span><span class="w"> </span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">))</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">next</span><span class="p">;</span>

<span class="w">        </span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_lockref</span><span class="p">.</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dentry</span><span class="p">;</span>
<span class="w">        </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="nl">next</span><span class="p">:</span>
<span class="w">        </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">rcu_read_unlock</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">found</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="43-rcu">4.3 RCU路径遍历优化</h3>
<p>RCU（Read-Copy-Update）允许无锁的路径查找，极大提升了并发性能。</p>
<h4 id="431-rcu">4.3.1 RCU模式的路径查找</h4>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">lookup_fast</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">nameidata</span><span class="w"> </span><span class="o">*</span><span class="n">nd</span><span class="p">,</span>
<span class="w">                      </span><span class="k">struct</span><span class="w"> </span><span class="nc">path</span><span class="w"> </span><span class="o">*</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">**</span><span class="n">inode</span><span class="p">,</span>
<span class="w">                      </span><span class="kt">unsigned</span><span class="w"> </span><span class="o">*</span><span class="n">seqp</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vfsmount</span><span class="w"> </span><span class="o">*</span><span class="n">mnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">mnt</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="n">dentry</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dentry</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">LOOKUP_RCU</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">seq</span><span class="p">;</span>
<span class="w">        </span><span class="n">dentry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__d_lookup_rcu</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">seq</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">dentry</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlazy_walk</span><span class="p">(</span><span class="n">nd</span><span class="p">))</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ECHILD</span><span class="p">;</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="o">*</span><span class="n">inode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d_backing_inode</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">read_seqcount_retry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_seq</span><span class="p">,</span><span class="w"> </span><span class="n">seq</span><span class="p">)))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ECHILD</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">__read_seqcount_retry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">d_seq</span><span class="p">,</span><span class="w"> </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">)))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ECHILD</span><span class="p">;</span>

<span class="w">        </span><span class="o">*</span><span class="n">seqp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seq</span><span class="p">;</span>
<span class="w">        </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d_revalidate</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span><span class="w"> </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">path</span><span class="o">-&gt;</span><span class="n">mnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mnt</span><span class="p">;</span>
<span class="w">            </span><span class="n">path</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dentry</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!*</span><span class="n">inode</span><span class="p">))</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">__follow_mount_rcu</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="n">seqp</span><span class="p">)))</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlazy_child</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span><span class="w"> </span><span class="n">dentry</span><span class="p">,</span><span class="w"> </span><span class="n">seq</span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ECHILD</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="n">ECHILD</span><span class="p">))</span>
<span class="w">            </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d_revalidate</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span><span class="w"> </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">dentry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__d_lookup</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">dentry</span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d_revalidate</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span><span class="w"> </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
<span class="w">            </span><span class="n">d_invalidate</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
<span class="w">        </span><span class="n">dput</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">path</span><span class="o">-&gt;</span><span class="n">mnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mnt</span><span class="p">;</span>
<span class="w">    </span><span class="n">path</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dentry</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="432">4.3.2 序列锁保护</h4>
<p>RCU模式使用序列锁检测并发修改：</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">read_seqcount_retry</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">seqcount_t</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">start</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">smp_rmb</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">unlikely</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">start</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="nf">read_seqbegin</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">seqlock_t</span><span class="w"> </span><span class="o">*</span><span class="n">sl</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">READ_ONCE</span><span class="p">(</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">cpu_relax</span><span class="p">();</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">repeat</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">smp_rmb</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="44">4.4 符号链接处理</h3>
<p>符号链接的处理需要特别注意避免无限循环：</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="nf">get_link</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">nameidata</span><span class="w"> </span><span class="o">*</span><span class="n">nd</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">saved</span><span class="w"> </span><span class="o">*</span><span class="n">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">stack</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">depth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="n">dentry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">last</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">dentry</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">inode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">link_inode</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">res</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">total_link_count</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">MAXSYMLINKS</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">path_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">last</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ELOOP</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">total_link_count</span><span class="o">++</span><span class="p">;</span>

<span class="w">    </span><span class="n">touch_atime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">last</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>

<span class="w">    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">security_inode_follow_link</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span><span class="w"> </span><span class="n">inode</span><span class="p">,</span>
<span class="w">                                       </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">LOOKUP_RCU</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ERR_PTR</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>

<span class="w">    </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">READ_ONCE</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_link</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">get</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">,</span>
<span class="w">                           </span><span class="k">struct</span><span class="w"> </span><span class="nc">delayed_call</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">        </span><span class="n">get</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_op</span><span class="o">-&gt;</span><span class="n">get_link</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">LOOKUP_RCU</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">last</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ECHILD</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlazy_walk</span><span class="p">(</span><span class="n">nd</span><span class="p">))</span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ECHILD</span><span class="p">);</span>
<span class="w">                </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span><span class="w"> </span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">last</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span><span class="w"> </span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">last</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;/&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nd_jump_root</span><span class="p">(</span><span class="n">nd</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">ERR_PTR</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="45">4.5 负目录项优化</h3>
<p>负目录项（negative dentry）缓存不存在的文件，避免重复的查找失败：</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">d_instantiate_negative</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="n">dentry</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">BUG_ON</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
<span class="w">    </span><span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">hlist_unhashed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_u</span><span class="p">.</span><span class="n">d_alias</span><span class="p">));</span>

<span class="w">    </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>
<span class="w">    </span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">DCACHE_NEGATIVE</span><span class="p">;</span>
<span class="w">    </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>负目录项的好处：</p>
<ol>
<li>减少对不存在文件的重复查找</li>
<li>加速编译等需要搜索大量路径的操作</li>
<li>提高include路径搜索效率</li>
</ol>
<h2 id="5">5. 文件操作接口实现</h2>
<p>VFS通过系统调用为用户空间提供文件操作接口。这些系统调用最终转换为对具体文件系统的操作。</p>
<h3 id="51-vfs">5.1 系统调用到VFS的映射</h3>
<h4 id="511-open">5.1.1 open系统调用</h4>
<div class="codehilite"><pre><span></span><code><span class="n">SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">open</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">umode_t</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">force_o_largefile</span><span class="p">())</span>
<span class="w">        </span><span class="n">flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">O_LARGEFILE</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">do_sys_open</span><span class="p">(</span><span class="n">AT_FDCWD</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">long</span><span class="w"> </span><span class="n">do_sys_open</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">dfd</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">umode_t</span><span class="w"> </span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">open_how</span><span class="w"> </span><span class="n">how</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">build_open_how</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">do_sys_openat2</span><span class="p">(</span><span class="n">dfd</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">how</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">do_sys_openat2</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">dfd</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">filename</span><span class="p">,</span>
<span class="w">                           </span><span class="k">struct</span><span class="w"> </span><span class="nc">open_how</span><span class="w"> </span><span class="o">*</span><span class="n">how</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">filename</span><span class="w"> </span><span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">;</span>

<span class="w">    </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getname</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>

<span class="w">    </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_unused_fd_flags</span><span class="p">(</span><span class="n">how</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">do_filp_open</span><span class="p">(</span><span class="n">dfd</span><span class="p">,</span><span class="w"> </span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">how</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">f</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">put_unused_fd</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="w">            </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">fsnotify_open</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="w">            </span><span class="n">fd_install</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">putname</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">fd</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="512">5.1.2 文件打开的核心过程</h4>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">do_filp_open</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">dfd</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">filename</span><span class="w"> </span><span class="o">*</span><span class="n">pathname</span><span class="p">,</span>
<span class="w">                         </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">open_flags</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">nameidata</span><span class="w"> </span><span class="n">nd</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">lookup_flags</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">filp</span><span class="p">;</span>

<span class="w">    </span><span class="n">set_nameidata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nd</span><span class="p">,</span><span class="w"> </span><span class="n">dfd</span><span class="p">,</span><span class="w"> </span><span class="n">pathname</span><span class="p">);</span>
<span class="w">    </span><span class="n">filp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path_openat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nd</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">LOOKUP_RCU</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">filp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ECHILD</span><span class="p">)))</span>
<span class="w">        </span><span class="n">filp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path_openat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nd</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">filp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ESTALE</span><span class="p">)))</span>
<span class="w">        </span><span class="n">filp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path_openat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nd</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">LOOKUP_REVAL</span><span class="p">);</span>
<span class="w">    </span><span class="n">restore_nameidata</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">filp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">path_openat</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">nameidata</span><span class="w"> </span><span class="o">*</span><span class="n">nd</span><span class="p">,</span>
<span class="w">                               </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">open_flags</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>

<span class="w">    </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_empty_file</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">open_flag</span><span class="p">,</span><span class="w"> </span><span class="n">current_cred</span><span class="p">());</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">file</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">__O_TMPFILE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">do_tmpfile</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">O_PATH</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">do_o_path</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path_init</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">link_path_walk</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">nd</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">               </span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open_last_lookups</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">            </span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
<span class="w">            </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">do_open</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">);</span>
<span class="w">        </span><span class="n">terminate_walk</span><span class="p">(</span><span class="n">nd</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FMODE_OPENED</span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">file</span><span class="p">;</span>
<span class="w">        </span><span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">fput</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="n">EOPENSTALE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">LOOKUP_RCU</span><span class="p">)</span>
<span class="w">            </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">ECHILD</span><span class="p">;</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">ESTALE</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ERR_PTR</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="52">5.2 文件描述符管理</h3>
<h4 id="521">5.2.1 文件描述符表</h4>
<p>每个进程维护一个文件描述符表：</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">files_struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">resize_in_progress</span><span class="p">;</span>
<span class="w">    </span><span class="n">wait_queue_head_t</span><span class="w"> </span><span class="n">resize_wait</span><span class="p">;</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">fdtable</span><span class="w"> </span><span class="n">__rcu</span><span class="w"> </span><span class="o">*</span><span class="n">fdt</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">fdtable</span><span class="w"> </span><span class="n">fdtab</span><span class="p">;</span>

<span class="w">    </span><span class="n">spinlock_t</span><span class="w"> </span><span class="n">file_lock</span><span class="w"> </span><span class="n">____cacheline_aligned_in_smp</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">next_fd</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">close_on_exec_init</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">open_fds_init</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">full_fds_bits_init</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="n">__rcu</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">fd_array</span><span class="p">[</span><span class="n">NR_OPEN_DEFAULT</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">fdtable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">max_fds</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="n">__rcu</span><span class="w"> </span><span class="o">**</span><span class="n">fd</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">close_on_exec</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">open_fds</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">full_fds_bits</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rcu_head</span><span class="w"> </span><span class="n">rcu</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>

<h4 id="522">5.2.2 分配文件描述符</h4>
<div class="codehilite"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">get_unused_fd_flags</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">__get_unused_fd_flags</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">rlimit</span><span class="p">(</span><span class="n">RLIMIT_NOFILE</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">__get_unused_fd_flags</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">nofile</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">files_struct</span><span class="w"> </span><span class="o">*</span><span class="n">files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">;</span>

<span class="w">    </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">files</span><span class="o">-&gt;</span><span class="n">file_lock</span><span class="p">);</span>
<span class="nl">repeat</span><span class="p">:</span>
<span class="w">    </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">find_next_fd</span><span class="p">(</span><span class="n">files</span><span class="p">,</span><span class="w"> </span><span class="n">files</span><span class="o">-&gt;</span><span class="n">next_fd</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">nofile</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EMFILE</span><span class="p">;</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expand_files</span><span class="p">(</span><span class="n">files</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">repeat</span><span class="p">;</span>

<span class="w">    </span><span class="n">__set_open_fd</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">files</span><span class="o">-&gt;</span><span class="n">fdt</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">O_CLOEXEC</span><span class="p">)</span>
<span class="w">        </span><span class="n">__set_close_on_exec</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">files</span><span class="o">-&gt;</span><span class="n">fdt</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">__clear_close_on_exec</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">files</span><span class="o">-&gt;</span><span class="n">fdt</span><span class="p">);</span>

<span class="w">    </span><span class="n">files</span><span class="o">-&gt;</span><span class="n">next_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="nl">out</span><span class="p">:</span>
<span class="w">    </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">files</span><span class="o">-&gt;</span><span class="n">file_lock</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">fd</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="53">5.3 读写操作路径</h3>
<h4 id="531-read">5.3.1 read系统调用</h4>
<div class="codehilite"><pre><span></span><code><span class="n">SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">read</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ksys_read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">ssize_t</span><span class="w"> </span><span class="n">ksys_read</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">fd</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fdget_pos</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">file</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">loff_t</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">ppos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file_ppos</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">file</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ppos</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">ppos</span><span class="p">;</span>
<span class="w">            </span><span class="n">ppos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pos</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vfs_read</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">ppos</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ppos</span><span class="p">)</span>
<span class="w">            </span><span class="n">f</span><span class="p">.</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="p">;</span>
<span class="w">        </span><span class="n">fdput_pos</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="532-vfs">5.3.2 VFS读操作</h4>
<div class="codehilite"><pre><span></span><code><span class="kt">ssize_t</span><span class="w"> </span><span class="nf">vfs_read</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FMODE_READ</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FMODE_CAN_READ</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">)))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rw_verify_area</span><span class="p">(</span><span class="n">READ</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MAX_RW_COUNT</span><span class="p">)</span>
<span class="w">        </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAX_RW_COUNT</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">)</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">read_iter</span><span class="p">)</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_sync_read</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fsnotify_access</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
<span class="w">        </span><span class="n">add_rchar</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">inc_syscr</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="533">5.3.3 写操作实现</h4>
<div class="codehilite"><pre><span></span><code><span class="kt">ssize_t</span><span class="w"> </span><span class="nf">vfs_write</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FMODE_WRITE</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FMODE_CAN_WRITE</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">)))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rw_verify_area</span><span class="p">(</span><span class="n">WRITE</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MAX_RW_COUNT</span><span class="p">)</span>
<span class="w">        </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAX_RW_COUNT</span><span class="p">;</span>

<span class="w">    </span><span class="n">file_start_write</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">)</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">write_iter</span><span class="p">)</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_sync_write</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fsnotify_modify</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
<span class="w">        </span><span class="n">add_wchar</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">inc_syscw</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
<span class="w">    </span><span class="n">file_end_write</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="54-mmap">5.4 内存映射（mmap）支持</h3>
<h4 id="541-mmap">5.4.1 mmap系统调用</h4>
<div class="codehilite"><pre><span></span><code><span class="n">SYSCALL_DEFINE6</span><span class="p">(</span><span class="n">mmap</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">,</span>
<span class="w">                </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">,</span><span class="w"> </span><span class="n">prot</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span>
<span class="w">                </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">,</span><span class="w"> </span><span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">offset_in_page</span><span class="p">(</span><span class="n">off</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ksys_mmap_pgoff</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">prot</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">PAGE_SHIFT</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ksys_mmap_pgoff</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">len</span><span class="p">,</span>
<span class="w">                              </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">prot</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span>
<span class="w">                              </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">pgoff</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">retval</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">MAP_ANONYMOUS</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fget</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_file_hugepages</span><span class="p">(</span><span class="n">file</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALIGN</span><span class="p">(</span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">huge_page_size</span><span class="p">(</span><span class="n">hstate_file</span><span class="p">(</span><span class="n">file</span><span class="p">)));</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">MAP_HUGETLB</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">out_fput</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">MAP_HUGETLB</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">ucounts</span><span class="w"> </span><span class="o">*</span><span class="n">ucounts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">        </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hugetlb_file_setup</span><span class="p">(</span><span class="n">HUGETLB_ANON_FILE</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">,</span>
<span class="w">                                 </span><span class="n">VM_NORESERVE</span><span class="p">,</span>
<span class="w">                                 </span><span class="o">&amp;</span><span class="n">ucounts</span><span class="p">,</span><span class="w"> </span><span class="n">HUGETLB_ANONHUGE_INODE</span><span class="p">,</span>
<span class="w">                                 </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">MAP_HUGE_SHIFT</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">MAP_HUGE_MASK</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm_mmap_pgoff</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">prot</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">pgoff</span><span class="p">);</span>

<span class="nl">out_fput</span><span class="p">:</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
<span class="w">        </span><span class="n">fput</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="542-vfs">5.4.2 文件映射的VFS支持</h4>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">do_mmap</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span>
<span class="w">                  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">prot</span><span class="p">,</span>
<span class="w">                  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">pgoff</span><span class="p">,</span>
<span class="w">                  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">populate</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="o">*</span><span class="n">uf</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">;</span>
<span class="w">    </span><span class="n">vm_flags_t</span><span class="w"> </span><span class="n">vm_flags</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pkey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="o">*</span><span class="n">populate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">prot</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PROT_READ</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">personality</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">READ_IMPLIES_EXEC</span><span class="p">))</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">file</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">path_noexec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">)))</span>
<span class="w">            </span><span class="n">prot</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">PROT_EXEC</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">MAP_FIXED</span><span class="p">))</span>
<span class="w">        </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">round_hint_to_min</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>

<span class="w">    </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">pgoff</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">PAGE_SHIFT</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">pgoff</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">map_count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">sysctl_max_map_count</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

<span class="w">    </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_unmapped_area</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">pgoff</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR_VALUE</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">MAP_FIXED_NOREPLACE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">find_vma_intersection</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">len</span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prot</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PROT_EXEC</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pkey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">execute_only_pkey</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pkey</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="n">pkey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">vm_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calc_vm_prot_bits</span><span class="p">(</span><span class="n">prot</span><span class="p">,</span><span class="w"> </span><span class="n">pkey</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">calc_vm_flag_bits</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span><span class="w"> </span><span class="o">|</span>
<span class="w">               </span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">def_flags</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">VM_MAYREAD</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">VM_MAYWRITE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">VM_MAYEXEC</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">inode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file_inode</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">flags_mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VM_MERGEABLE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">VM_MAYSHARE</span><span class="w"> </span><span class="o">|</span>
<span class="w">                                   </span><span class="n">VM_DONTEXPAND</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">VM_SOFTDIRTY</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">file_mmap_ok</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="n">pgoff</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>

<span class="w">        </span><span class="n">flags_mask</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">mmap_supported_flags</span><span class="p">;</span>

<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">MAP_TYPE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">MAP_SHARED</span><span class="p">:</span>
<span class="w">            </span><span class="n">flags_mask</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">VM_SHARED</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">VM_MAYSHARE</span><span class="p">;</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">MAP_SHARED_VALIDATE</span><span class="p">:</span>
<span class="w">            </span><span class="n">flags_mask</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">VM_SHARED</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">VM_MAYSHARE</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">flags_mask</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">MAP_PRIVATE</span><span class="p">:</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vm_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">VM_GROWSDOWN</span><span class="o">|</span><span class="n">VM_GROWSUP</span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mmap_region</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">vm_flags</span><span class="p">,</span><span class="w"> </span><span class="n">pgoff</span><span class="p">,</span><span class="w"> </span><span class="n">uf</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">IS_ERR_VALUE</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="p">((</span><span class="n">vm_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">VM_LOCKED</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<span class="w">         </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">MAP_POPULATE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MAP_NONBLOCK</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MAP_POPULATE</span><span class="p">))</span>
<span class="w">        </span><span class="o">*</span><span class="n">populate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
            </article>
            
            <nav class="page-nav"><a href="chapter4.html" class="nav-link prev">← 第4章：进程间通信机制</a><a href="chapter6.html" class="nav-link next">第6章：具体文件系统实现 →</a></nav>
        </main>
    </div>
</body>
</html>