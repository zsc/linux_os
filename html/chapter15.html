<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬15ç« ï¼šæ€§èƒ½åˆ†æä¸è°ƒè¯•</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Linux å†…æ ¸æºä»£ç æ·±åº¦è§£æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬1ç« ï¼šLinux å†…æ ¸æ¦‚è¿°ä¸å‘å±•å²</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬2ç« ï¼šè¿›ç¨‹ç®¡ç†ä¸ä»»åŠ¡è°ƒåº¦</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬3ç« ï¼šå†…å­˜ç®¡ç†æ¶æ„</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬4ç« ï¼šè¿›ç¨‹é—´é€šä¿¡æœºåˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬5ç« ï¼šè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬6ç« ï¼šå…·ä½“æ–‡ä»¶ç³»ç»Ÿå®ç°</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬7ç« ï¼šå—è®¾å¤‡å±‚ä¸I/Oè°ƒåº¦</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬8ç« ï¼šè®¾å¤‡é©±åŠ¨æ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬9ç« ï¼šç½‘ç»œåè®®æ ˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬10ç« ï¼šå†…æ ¸åŒæ­¥æœºåˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬11ç« ï¼šå¹¶å‘ç¼–ç¨‹æ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬12ç« ï¼šå®¹å™¨ä¸å‘½åç©ºé—´</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬13ç« ï¼šå®‰å…¨å­ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬14ç« ï¼šå®æ—¶Linux</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬15ç« ï¼šæ€§èƒ½åˆ†æä¸è°ƒè¯•</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬16ç« ï¼šå¼•å¯¼è¿‡ç¨‹ä¸åˆå§‹åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="15">ç¬¬15ç« ï¼šæ€§èƒ½åˆ†æä¸è°ƒè¯•</h1>
<p>åœ¨ç°ä»£ Linux ç³»ç»Ÿä¸­ï¼Œæ€§èƒ½åˆ†æå’Œè°ƒè¯•æ˜¯å†…æ ¸å¼€å‘ä¸ç³»ç»Ÿä¼˜åŒ–çš„æ ¸å¿ƒæŠ€èƒ½ã€‚æœ¬ç« æ·±å…¥æ¢è®¨ Linux å†…æ ¸æä¾›çš„å„ç§è§‚æµ‹ã€åˆ†æå’Œè°ƒè¯•æœºåˆ¶ï¼Œä»ä¼ ç»Ÿçš„ ftrace åˆ°é©å‘½æ€§çš„ eBPFï¼Œä»é™æ€è·Ÿè¸ªç‚¹åˆ°åŠ¨æ€æ¢é’ˆï¼Œä»å´©æºƒè½¬å‚¨åˆ°å®æ—¶è°ƒè¯•ã€‚æˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•ä½¿ç”¨è¿™äº›å¼ºå¤§çš„å·¥å…·æ¥è¯Šæ–­æ€§èƒ½ç“¶é¢ˆã€è¿½è¸ªç³»ç»Ÿè¡Œä¸ºã€å®šä½å†…æ ¸é”™è¯¯ï¼Œå¹¶æœ€ç»ˆå®ç°ç³»ç»Ÿçš„æ€§èƒ½ä¼˜åŒ–ã€‚</p>
<h2 id="_1">å­¦ä¹ ç›®æ ‡</h2>
<p>å®Œæˆæœ¬ç« å­¦ä¹ åï¼Œæ‚¨å°†èƒ½å¤Ÿï¼š</p>
<ol>
<li><strong>æŒæ¡å†…æ ¸è·Ÿè¸ªæœºåˆ¶</strong>ï¼šç†è§£ ftraceã€kprobesã€tracepoints çš„åŸç†ä¸ä½¿ç”¨</li>
<li><strong>ç²¾é€šæ€§èƒ½åˆ†æå·¥å…·</strong>ï¼šç†Ÿç»ƒä½¿ç”¨ perfã€ç«ç„°å›¾ç­‰å·¥å…·è¿›è¡Œæ€§èƒ½å‰–æ</li>
<li><strong>æŒæ¡å†…æ ¸è°ƒè¯•æŠ€æœ¯</strong>ï¼šä½¿ç”¨ KGDBã€crashã€kdump è°ƒè¯•å†…æ ¸é—®é¢˜</li>
<li><strong>è¿ç”¨åŠ¨æ€è¿½è¸ªæŠ€æœ¯</strong>ï¼šç¼–å†™ eBPF/bpftrace ç¨‹åºè¿›è¡Œç³»ç»Ÿè§‚æµ‹</li>
<li><strong>æ€§èƒ½ä¼˜åŒ–å®è·µ</strong>ï¼šè¯†åˆ«æ€§èƒ½ç“¶é¢ˆå¹¶å®æ–½é’ˆå¯¹æ€§ä¼˜åŒ–</li>
</ol>
<h2 id="_2">ç« èŠ‚å¤§çº²</h2>
<h2 id="151">15.1 å†…æ ¸è·Ÿè¸ªæœºåˆ¶</h2>
<p>Linux å†…æ ¸è·Ÿè¸ªæœºåˆ¶æä¾›äº†è§‚æµ‹å†…æ ¸è¡Œä¸ºçš„çª—å£ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿåœ¨ä¸ä¿®æ”¹å†…æ ¸ä»£ç çš„æƒ…å†µä¸‹ï¼Œæ·±å…¥äº†è§£ç³»ç»Ÿçš„è¿è¡ŒçŠ¶æ€ã€‚ä» 2.6.27 ç‰ˆæœ¬å¼•å…¥ ftrace å¼€å§‹ï¼ŒLinux çš„å¯è§‚æµ‹æ€§å¾—åˆ°äº†è´¨çš„é£è·ƒã€‚</p>
<h3 id="1511-ftrace">15.1.1 ftrace æ¡†æ¶</h3>
<p>ftraceï¼ˆfunction tracerï¼‰æ˜¯ Linux å†…æ ¸çš„å®˜æ–¹è·Ÿè¸ªæ¡†æ¶ï¼Œç”± Steven Rostedt å¼€å‘ã€‚å®ƒä¸ä»…å¯ä»¥è·Ÿè¸ªå‡½æ•°è°ƒç”¨ï¼Œè¿˜é›†æˆäº†å„ç§è·Ÿè¸ªå™¨ï¼Œæˆä¸ºå†…æ ¸è°ƒè¯•å’Œæ€§èƒ½åˆ†æçš„ç‘å£«å†›åˆ€ã€‚</p>
<p><strong>æ¶æ„è®¾è®¡</strong></p>
<p>ftrace åŸºäºç¼–è¯‘æ—¶æ’æ¡©å’Œè¿è¡Œæ—¶ä¿®æ”¹å®ç°ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c">    ç”¨æˆ·ç©ºé—´æ¥å£ (/sys/kernel/debug/tracing/)</span>
<span class="c">           |</span>
<span class="c">    </span><span class="nb">+------</span><span class="c">v</span><span class="nb">------+</span>
<span class="c">    | Trace Buffer |  </span><span class="nv">&lt;</span><span class="nb">-</span><span class="c"> ç¯å½¢ç¼“å†²åŒºï¼ˆper</span><span class="nb">-</span><span class="c">CPUï¼‰</span>
<span class="c">    </span><span class="nb">+------+------+</span>
<span class="c">           |</span>
<span class="c">    </span><span class="nb">+------</span><span class="c">v</span><span class="nb">------+</span>
<span class="c">    |   Tracers   |  </span><span class="nv">&lt;</span><span class="nb">-</span><span class="c"> function</span><span class="nt">,</span><span class="c"> function_graph</span><span class="nt">,</span><span class="c"> wakeup</span><span class="nt">,</span><span class="c"> irqsoff</span>
<span class="c">    </span><span class="nb">+------+------+</span>
<span class="c">           |</span>
<span class="c">    </span><span class="nb">+------</span><span class="c">v</span><span class="nb">------+</span>
<span class="c">    | Trace Events |  </span><span class="nv">&lt;</span><span class="nb">-</span><span class="c"> é™æ€è·Ÿè¸ªç‚¹</span>
<span class="c">    </span><span class="nb">+------+------+</span>
<span class="c">           |</span>
<span class="c">    </span><span class="nb">+------</span><span class="c">v</span><span class="nb">------+</span>
<span class="c">    |   Ftrace    |  </span><span class="nv">&lt;</span><span class="nb">-</span><span class="c"> æ ¸å¿ƒæ¡†æ¶</span>
<span class="c">    |   Core      |</span>
<span class="c">    </span><span class="nb">+------+------+</span>
<span class="c">           |</span>
<span class="c">    </span><span class="nb">+------</span><span class="c">v</span><span class="nb">------+</span>
<span class="c">    | Mcount/Fentry| </span><span class="nv">&lt;</span><span class="nb">-</span><span class="c"> å‡½æ•°å…¥å£é’©å­</span>
<span class="c">    </span><span class="nb">+--------------+</span>
</code></pre></div>

<p><strong>å‡½æ•°è·Ÿè¸ªåŸç†</strong></p>
<p>GCC ç¼–è¯‘å™¨çš„ <code>-pg</code> é€‰é¡¹ä¼šåœ¨æ¯ä¸ªå‡½æ•°å…¥å£æ’å…¥ mcount è°ƒç”¨ï¼ˆæ–°ç‰ˆæœ¬ä½¿ç”¨ fentryï¼‰ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* åŸå§‹å‡½æ•° */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">do_something</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* function body */</span>
<span class="p">}</span>

<span class="cm">/* ç¼–è¯‘åï¼ˆæ¦‚å¿µæ€§è¡¨ç¤ºï¼‰ */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">do_something</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">mcount</span><span class="p">();</span><span class="w">  </span><span class="cm">/* æˆ– __fentry__() */</span>
<span class="w">    </span><span class="cm">/* function body */</span>
<span class="p">}</span>
</code></pre></div>

<p>ftrace åœ¨è¿è¡Œæ—¶é€šè¿‡åŠ¨æ€ä¿®æ”¹è¿™äº›è°ƒç”¨ç‚¹æ¥å¯ç”¨/ç¦ç”¨è·Ÿè¸ªï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* kernel/trace/ftrace.c ç®€åŒ–ç‰ˆ */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">ftrace_modify_code</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">old_code</span><span class="p">,</span>
<span class="w">                              </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">new_code</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">replaced</span><span class="p">[</span><span class="n">MCOUNT_INSN_SIZE</span><span class="p">];</span>

<span class="w">    </span><span class="cm">/* ä½¿ç”¨ text_poke æˆ–ç±»ä¼¼æœºåˆ¶ä¿®æ”¹ä»£ç  */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">probe_kernel_read</span><span class="p">(</span><span class="n">replaced</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="n">MCOUNT_INSN_SIZE</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">replaced</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">old_code</span><span class="p">,</span><span class="w"> </span><span class="n">MCOUNT_INSN_SIZE</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* åŸå­æ€§åœ°æ›¿æ¢æŒ‡ä»¤ */</span>
<span class="w">    </span><span class="n">text_poke_bp</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">new_code</span><span class="p">,</span><span class="w"> </span><span class="n">MCOUNT_INSN_SIZE</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>ä½¿ç”¨ç¤ºä¾‹</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># å¯ç”¨å‡½æ•°è·Ÿè¸ª</span>
<span class="nb">echo</span><span class="w"> </span><span class="k">function</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/kernel/debug/tracing/current_tracer
<span class="nb">echo</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/kernel/debug/tracing/tracing_on

<span class="c1"># è®¾ç½®å‡½æ•°è¿‡æ»¤</span>
<span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;tcp_*&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/kernel/debug/tracing/set_ftrace_filter

<span class="c1"># æŸ¥çœ‹è·Ÿè¸ªç»“æœ</span>
cat<span class="w"> </span>/sys/kernel/debug/tracing/trace

<span class="c1"># å‡½æ•°è°ƒç”¨å›¾è·Ÿè¸ª</span>
<span class="nb">echo</span><span class="w"> </span>function_graph<span class="w"> </span>&gt;<span class="w"> </span>/sys/kernel/debug/tracing/current_tracer
</code></pre></div>

<h3 id="1512-kprobes">15.1.2 kprobes åŠ¨æ€æ¢é’ˆ</h3>
<p>kprobes æ˜¯ Linux å†…æ ¸çš„åŠ¨æ€æ¢æµ‹æœºåˆ¶ï¼Œå…è®¸åœ¨å‡ ä¹ä»»æ„å†…æ ¸ä»£ç ä½ç½®è®¾ç½®æ¢é’ˆï¼Œæ— éœ€é‡æ–°ç¼–è¯‘å†…æ ¸ã€‚å®ƒé€šè¿‡æ›¿æ¢æŒ‡ä»¤ã€ä½¿ç”¨æ–­ç‚¹æˆ–è·³è½¬æŒ‡ä»¤æ¥å®ç°ã€‚</p>
<p><strong>kprobes å®¶æ—</strong></p>
<ol>
<li><strong>kprobes</strong>ï¼šåœ¨æŒ‡å®šåœ°å€è®¾ç½®æ¢é’ˆ</li>
<li><strong>kretprobes</strong>ï¼šåœ¨å‡½æ•°è¿”å›æ—¶è§¦å‘</li>
<li><strong>jprobes</strong>ï¼šå·²åºŸå¼ƒï¼Œè¢« kprobes å–ä»£</li>
</ol>
<p><strong>å®ç°æœºåˆ¶</strong></p>
<p>kprobes çš„æ ¸å¿ƒæ˜¯æŒ‡ä»¤æ›¿æ¢å’Œå¼‚å¸¸å¤„ç†ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* ç®€åŒ–çš„ kprobe ç»“æ„ */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">kprobe</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_node</span><span class="w"> </span><span class="n">hlist</span><span class="p">;</span>
<span class="w">    </span><span class="n">kprobe_opcode_t</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="p">;</span><span class="w">        </span><span class="cm">/* æ¢æµ‹ç‚¹åœ°å€ */</span>
<span class="w">    </span><span class="n">kprobe_pre_handler_t</span><span class="w"> </span><span class="n">pre_handler</span><span class="p">;</span>
<span class="w">    </span><span class="n">kprobe_post_handler_t</span><span class="w"> </span><span class="n">post_handler</span><span class="p">;</span>
<span class="w">    </span><span class="n">kprobe_opcode_t</span><span class="w"> </span><span class="n">opcode</span><span class="p">;</span><span class="w">       </span><span class="cm">/* ä¿å­˜çš„åŸå§‹æŒ‡ä»¤ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">arch_specific_insn</span><span class="w"> </span><span class="n">ainsn</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* æ³¨å†Œ kprobe çš„æ ¸å¿ƒæµç¨‹ */</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">register_kprobe</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">kprobe</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="cm">/* 1. è§£æç¬¦å·åœ°å€ */</span>
<span class="w">    </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kprobe_addr</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* 2. å‡†å¤‡æ¢æµ‹ç‚¹ */</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prepare_kprobe</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* 3. æ’å…¥æ–­ç‚¹æŒ‡ä»¤ (x86: int3) */</span>
<span class="w">    </span><span class="n">arch_arm_kprobe</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* 4. æ·»åŠ åˆ°å“ˆå¸Œè¡¨ */</span>
<span class="w">    </span><span class="n">hlist_add_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">hlist</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kprobe_table</span><span class="p">[</span><span class="n">hash</span><span class="p">]);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>æ–­ç‚¹å¤„ç†æµç¨‹</strong></p>
<div class="codehilite"><pre><span></span><code>    æ‰§è¡Œåˆ°æ¢æµ‹ç‚¹
         |
         v
    è§¦å‘ int3 å¼‚å¸¸
         |
         v
    do_int3() å¤„ç†å™¨
         |
         v
    kprobe_int3_handler()
         |
    +----+----+
    |         |
    v         v
pre_handler  å•æ­¥æ‰§è¡ŒåŸæŒ‡ä»¤
    |         |
    v         v
post_handler è¿”å›æ­£å¸¸æ‰§è¡Œ
</code></pre></div>

<p><strong>ä½¿ç”¨ç¤ºä¾‹</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* å†…æ ¸æ¨¡å—ä¸­ä½¿ç”¨ kprobes */</span>
<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">kprobe</span><span class="w"> </span><span class="n">kp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">symbol_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;tcp_sendmsg&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">handler_pre</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">kprobe</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">pt_regs</span><span class="w"> </span><span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;tcp_sendmsg: sock=%p, len=%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">si</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">kprobe_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">kp</span><span class="p">.</span><span class="n">pre_handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">handler_pre</span><span class="p">;</span>
<span class="w">    </span><span class="n">register_kprobe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kp</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1513-tracepoints">15.1.3 tracepoints é™æ€è·Ÿè¸ªç‚¹</h3>
<p>tracepoints æ˜¯å†…æ ¸ä¸­é¢„å®šä¹‰çš„é™æ€è·Ÿè¸ªç‚¹ï¼Œç›¸æ¯”åŠ¨æ€æ¢é’ˆå…·æœ‰æ›´é«˜çš„ç¨³å®šæ€§å’Œæ›´ä½çš„å¼€é”€ã€‚</p>
<p><strong>å®šä¹‰è·Ÿè¸ªç‚¹</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* include/trace/events/sched.h */</span>
<span class="n">TRACE_EVENT</span><span class="p">(</span><span class="n">sched_switch</span><span class="p">,</span>
<span class="w">    </span><span class="n">TP_PROTO</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">next</span><span class="p">),</span>
<span class="w">    </span><span class="n">TP_ARGS</span><span class="p">(</span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">next</span><span class="p">),</span>

<span class="w">    </span><span class="n">TP_STRUCT__entry</span><span class="p">(</span>
<span class="w">        </span><span class="n">__array</span><span class="p">(</span><span class="kt">char</span><span class="p">,</span><span class="w"> </span><span class="n">prev_comm</span><span class="p">,</span><span class="w"> </span><span class="n">TASK_COMM_LEN</span><span class="p">)</span>
<span class="w">        </span><span class="n">__field</span><span class="p">(</span><span class="kt">pid_t</span><span class="p">,</span><span class="w"> </span><span class="n">prev_pid</span><span class="p">)</span>
<span class="w">        </span><span class="n">__field</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">prev_prio</span><span class="p">)</span>
<span class="w">        </span><span class="n">__array</span><span class="p">(</span><span class="kt">char</span><span class="p">,</span><span class="w"> </span><span class="n">next_comm</span><span class="p">,</span><span class="w"> </span><span class="n">TASK_COMM_LEN</span><span class="p">)</span>
<span class="w">        </span><span class="n">__field</span><span class="p">(</span><span class="kt">pid_t</span><span class="p">,</span><span class="w"> </span><span class="n">next_pid</span><span class="p">)</span>
<span class="w">        </span><span class="n">__field</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">next_prio</span><span class="p">)</span>
<span class="w">    </span><span class="p">),</span>

<span class="w">    </span><span class="n">TP_fast_assign</span><span class="p">(</span>
<span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">__entry</span><span class="o">-&gt;</span><span class="n">prev_comm</span><span class="p">,</span><span class="w"> </span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">TASK_COMM_LEN</span><span class="p">);</span>
<span class="w">        </span><span class="n">__entry</span><span class="o">-&gt;</span><span class="n">prev_pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
<span class="w">        </span><span class="n">__entry</span><span class="o">-&gt;</span><span class="n">prev_prio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">;</span>
<span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">__entry</span><span class="o">-&gt;</span><span class="n">next_comm</span><span class="p">,</span><span class="w"> </span><span class="n">next</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="n">TASK_COMM_LEN</span><span class="p">);</span>
<span class="w">        </span><span class="n">__entry</span><span class="o">-&gt;</span><span class="n">next_pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
<span class="w">        </span><span class="n">__entry</span><span class="o">-&gt;</span><span class="n">next_prio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">;</span>
<span class="w">    </span><span class="p">),</span>

<span class="w">    </span><span class="n">TP_printk</span><span class="p">(</span><span class="s">&quot;prev_comm=%s prev_pid=%d prev_prio=%d ==&gt; &quot;</span>
<span class="w">              </span><span class="s">&quot;next_comm=%s next_pid=%d next_prio=%d&quot;</span><span class="p">,</span>
<span class="w">              </span><span class="n">__entry</span><span class="o">-&gt;</span><span class="n">prev_comm</span><span class="p">,</span><span class="w"> </span><span class="n">__entry</span><span class="o">-&gt;</span><span class="n">prev_pid</span><span class="p">,</span><span class="w"> </span><span class="n">__entry</span><span class="o">-&gt;</span><span class="n">prev_prio</span><span class="p">,</span>
<span class="w">              </span><span class="n">__entry</span><span class="o">-&gt;</span><span class="n">next_comm</span><span class="p">,</span><span class="w"> </span><span class="n">__entry</span><span class="o">-&gt;</span><span class="n">next_pid</span><span class="p">,</span><span class="w"> </span><span class="n">__entry</span><span class="o">-&gt;</span><span class="n">next_prio</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div>

<p><strong>è·Ÿè¸ªç‚¹å®ç°</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* è·Ÿè¸ªç‚¹çš„é™æ€è°ƒç”¨ä¼˜åŒ– */</span>
<span class="cp">#define DEFINE_TRACE(name)                              \</span>
<span class="cp">    struct tracepoint __tracepoint_##name = {           \</span>
<span class="cp">        .name = #name,                                  \</span>
<span class="cp">        .key = STATIC_KEY_INIT_FALSE,                   \</span>
<span class="cp">        .funcs = NULL,                                  \</span>
<span class="cp">    };                                                   \</span>
<span class="cp">                                                        \</span>
<span class="cp">    static inline void trace_##name(proto)              \</span>
<span class="cp">    {                                                    \</span>
<span class="cp">        if (static_key_false(&amp;__tracepoint_##name.key)) \</span>
<span class="cp">            __DO_TRACE(&amp;__tracepoint_##name, args);     \</span>
<span class="cp">    }</span>
</code></pre></div>

<h3 id="1514">15.1.4 è·Ÿè¸ªäº‹ä»¶å­ç³»ç»Ÿ</h3>
<p>è·Ÿè¸ªäº‹ä»¶å­ç³»ç»Ÿç»Ÿä¸€äº†å„ç§è·Ÿè¸ªæœºåˆ¶çš„æ¥å£ï¼Œæä¾›äº†æ ‡å‡†åŒ–çš„äº‹ä»¶å®šä¹‰å’Œè¿‡æ»¤æœºåˆ¶ã€‚</p>
<p><strong>äº‹ä»¶è¿‡æ»¤å™¨</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># è®¾ç½®è¿‡æ»¤æ¡ä»¶</span>
<span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;prev_prio &lt; 100&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/kernel/debug/tracing/events/sched/sched_switch/filter

<span class="c1"># å¤åˆæ¡ä»¶</span>
<span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;irq == 1 &amp;&amp; ret &gt;= 0&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/kernel/debug/tracing/events/irq/irq_handler_exit/filter
</code></pre></div>

<p><strong>è§¦å‘å™¨æœºåˆ¶</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># å½“æ»¡è¶³æ¡ä»¶æ—¶è§¦å‘å¿«ç…§</span>
<span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;snapshot if bytes_req &gt; 4096&#39;</span><span class="w"> </span>&gt;<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>/sys/kernel/debug/tracing/events/kmem/kmalloc/trigger

<span class="c1"># è§¦å‘æ ˆè¿½è¸ª</span>
<span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;stacktrace&#39;</span><span class="w"> </span>&gt;<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>/sys/kernel/debug/tracing/events/sched/sched_switch/trigger
</code></pre></div>

<h2 id="152">15.2 æ€§èƒ½è®¡æ•°å™¨</h2>
<p>Linux æ€§èƒ½è®¡æ•°å™¨å­ç³»ç»Ÿï¼ˆperf_eventsï¼‰æä¾›äº†ç»Ÿä¸€çš„æ¥å£æ¥è®¿é—®ç¡¬ä»¶æ€§èƒ½è®¡æ•°å™¨å’Œè½¯ä»¶äº‹ä»¶ï¼Œæ˜¯ç°ä»£æ€§èƒ½åˆ†æçš„åŸºçŸ³ã€‚</p>
<h3 id="1521-perf-events">15.2.1 perf events æ¶æ„</h3>
<p>perf_events å­ç³»ç»Ÿç”± Thomas Gleixnerã€Ingo Molnar å’Œ Arnaldo Carvalho de Melo ç­‰äººå¼€å‘ï¼Œä» 2.6.31 ç‰ˆæœ¬å¼€å§‹æˆä¸ºå†…æ ¸çš„æ ¸å¿ƒç»„ä»¶ã€‚</p>
<p><strong>ç³»ç»Ÿæ¶æ„</strong></p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="err">ç”¨æˆ·ç©ºé—´å·¥å…·</span><span class="w"> </span><span class="p">(</span><span class="n">perf</span><span class="p">,</span><span class="w"> </span><span class="n">pmu</span><span class="o">-</span><span class="n">tools</span><span class="p">)</span>
<span class="w">              </span><span class="o">|</span>
<span class="w">    </span><span class="o">+=========</span><span class="n">v</span><span class="o">=========+</span>
<span class="w">    </span><span class="o">|</span><span class="w">   </span><span class="err">ç³»ç»Ÿè°ƒç”¨æ¥å£</span><span class="w">    </span><span class="o">|</span><span class="w">  </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">perf_event_open</span><span class="p">()</span>
<span class="w">    </span><span class="o">+===================+</span>
<span class="w">              </span><span class="o">|</span>
<span class="w">    </span><span class="o">+---------</span><span class="n">v</span><span class="o">---------+</span>
<span class="w">    </span><span class="o">|</span><span class="w">  </span><span class="n">perf_event</span><span class="w"> </span><span class="err">æ ¸å¿ƒ</span><span class="w">  </span><span class="o">|</span><span class="w">  </span><span class="o">&lt;-</span><span class="w"> </span><span class="err">äº‹ä»¶ç®¡ç†ã€è°ƒåº¦ã€é‡‡æ ·</span>
<span class="w">    </span><span class="o">+-------------------+</span>
<span class="w">         </span><span class="o">/</span><span class="w">    </span><span class="o">|</span><span class="w">    </span>\
<span class="w">        </span><span class="o">/</span><span class="w">     </span><span class="o">|</span><span class="w">     </span>\
<span class="w">       </span><span class="n">v</span><span class="w">      </span><span class="n">v</span><span class="w">      </span><span class="n">v</span>
<span class="w">    </span><span class="o">+-----+</span><span class="w"> </span><span class="o">+-----+</span><span class="w"> </span><span class="o">+-----+</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">CPU</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">SW</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="n">Trace</span><span class="o">|</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">PMU</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="n">Event</span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="n">Point</span><span class="o">|</span>
<span class="w">    </span><span class="o">+-----+</span><span class="w"> </span><span class="o">+-----+</span><span class="w"> </span><span class="o">+-----+</span>
</code></pre></div>

<p><strong>æ ¸å¿ƒæ•°æ®ç»“æ„</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* include/linux/perf_event.h */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">perf_event</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w">        </span><span class="n">event_entry</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">perf_event</span><span class="w">       </span><span class="o">*</span><span class="n">group_leader</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pmu</span><span class="w">              </span><span class="o">*</span><span class="n">pmu</span><span class="p">;</span><span class="w">           </span><span class="cm">/* æ€§èƒ½ç›‘æ§å•å…ƒ */</span>

<span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="n">perf_event_state</span><span class="w">   </span><span class="n">state</span><span class="p">;</span>
<span class="w">    </span><span class="n">atomic64_t</span><span class="w">              </span><span class="n">count</span><span class="p">;</span><span class="w">          </span><span class="cm">/* äº‹ä»¶è®¡æ•° */</span>
<span class="w">    </span><span class="n">atomic64_t</span><span class="w">              </span><span class="n">child_count</span><span class="p">;</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">perf_event_attr</span><span class="w">  </span><span class="n">attr</span><span class="p">;</span><span class="w">           </span><span class="cm">/* ç”¨æˆ·é…ç½® */</span>
<span class="w">    </span><span class="n">u64</span><span class="w">                     </span><span class="n">hw_event</span><span class="p">;</span><span class="w">       </span><span class="cm">/* ç¡¬ä»¶äº‹ä»¶é…ç½® */</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">perf_sample_data</span><span class="w"> </span><span class="n">sample_data</span><span class="p">;</span><span class="w">    </span><span class="cm">/* é‡‡æ ·æ•°æ® */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ring_buffer</span><span class="w">      </span><span class="o">*</span><span class="n">rb</span><span class="p">;</span><span class="w">            </span><span class="cm">/* ç¯å½¢ç¼“å†²åŒº */</span>

<span class="w">    </span><span class="cm">/* å›è°ƒå‡½æ•° */</span>
<span class="w">    </span><span class="n">perf_overflow_handler_t</span><span class="w"> </span><span class="n">overflow_handler</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">perf_event_context</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* æ€§èƒ½ç›‘æ§å•å…ƒæŠ½è±¡ */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">pmu</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w">        </span><span class="n">entry</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w">              </span><span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w">                     </span><span class="n">type</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* PMU æ“ä½œæ¥å£ */</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">pmu_enable</span><span class="p">)</span><span class="w">      </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">pmu</span><span class="w"> </span><span class="o">*</span><span class="n">pmu</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">pmu_disable</span><span class="p">)</span><span class="w">     </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">pmu</span><span class="w"> </span><span class="o">*</span><span class="n">pmu</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w">  </span><span class="p">(</span><span class="o">*</span><span class="n">event_init</span><span class="p">)</span><span class="w">      </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">perf_event</span><span class="w"> </span><span class="o">*</span><span class="n">event</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">add</span><span class="p">)</span><span class="w">             </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">perf_event</span><span class="w"> </span><span class="o">*</span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">del</span><span class="p">)</span><span class="w">             </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">perf_event</span><span class="w"> </span><span class="o">*</span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">start</span><span class="p">)</span><span class="w">           </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">perf_event</span><span class="w"> </span><span class="o">*</span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">stop</span><span class="p">)</span><span class="w">            </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">perf_event</span><span class="w"> </span><span class="o">*</span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">read</span><span class="p">)</span><span class="w">            </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">perf_event</span><span class="w"> </span><span class="o">*</span><span class="n">event</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="1522-pmu">15.2.2 ç¡¬ä»¶æ€§èƒ½ç›‘æ§å•å…ƒï¼ˆPMUï¼‰</h3>
<p>ç°ä»£å¤„ç†å™¨æä¾›ä¸“é—¨çš„ç¡¬ä»¶è®¡æ•°å™¨æ¥ç»Ÿè®¡å„ç§å¾®æ¶æ„äº‹ä»¶ï¼Œå¦‚ç¼“å­˜å‘½ä¸­/æœªå‘½ä¸­ã€åˆ†æ”¯é¢„æµ‹ã€æŒ‡ä»¤æ‰§è¡Œç­‰ã€‚</p>
<p><strong>Intel PMU æ¶æ„</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* arch/x86/events/intel/core.c */</span>
<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">event_constraint</span><span class="w"> </span><span class="n">intel_core_event_constraints</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x11</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2</span><span class="p">),</span><span class="w">  </span><span class="cm">/* FP_ASSIST */</span>
<span class="w">    </span><span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x12</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2</span><span class="p">),</span><span class="w">  </span><span class="cm">/* MUL */</span>
<span class="w">    </span><span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x13</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2</span><span class="p">),</span><span class="w">  </span><span class="cm">/* DIV */</span>
<span class="w">    </span><span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x14</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">),</span><span class="w">  </span><span class="cm">/* CYCLES_DIV_BUSY */</span>
<span class="w">    </span><span class="n">INTEL_EVENT_CONSTRAINT</span><span class="p">(</span><span class="mh">0x19</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2</span><span class="p">),</span><span class="w">  </span><span class="cm">/* DELAYED_BYPASS */</span>
<span class="p">};</span>

<span class="cm">/* é€šç”¨æ€§èƒ½è®¡æ•°å™¨é…ç½® */</span>
<span class="cp">#define ARCH_PERFMON_EVENTSEL_EVENT    0x000000FFULL</span>
<span class="cp">#define ARCH_PERFMON_EVENTSEL_UMASK    0x0000FF00ULL</span>
<span class="cp">#define ARCH_PERFMON_EVENTSEL_USR       (1ULL &lt;&lt; 16)</span>
<span class="cp">#define ARCH_PERFMON_EVENTSEL_OS        (1ULL &lt;&lt; 17)</span>
<span class="cp">#define ARCH_PERFMON_EVENTSEL_EDGE      (1ULL &lt;&lt; 18)</span>
<span class="cp">#define ARCH_PERFMON_EVENTSEL_INT       (1ULL &lt;&lt; 20)</span>
<span class="cp">#define ARCH_PERFMON_EVENTSEL_ENABLE    (1ULL &lt;&lt; 22)</span>
</code></pre></div>

<p><strong>ç¡¬ä»¶äº‹ä»¶æ˜ å°„</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* é€šç”¨ç¡¬ä»¶äº‹ä»¶åˆ°å…·ä½“ CPU äº‹ä»¶çš„æ˜ å°„ */</span>
<span class="k">static</span><span class="w"> </span><span class="n">u64</span><span class="w"> </span><span class="nf">intel_pmu_event_map</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">hw_event</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">hw_event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">PERF_COUNT_HW_CPU_CYCLES</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mh">0x003c</span><span class="p">;</span><span class="w">  </span><span class="cm">/* UNHALTED_CORE_CYCLES */</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">PERF_COUNT_HW_INSTRUCTIONS</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mh">0x00c0</span><span class="p">;</span><span class="w">  </span><span class="cm">/* INST_RETIRED.ANY_P */</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">PERF_COUNT_HW_CACHE_REFERENCES</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mh">0x4f2e</span><span class="p">;</span><span class="w">  </span><span class="cm">/* LLC Reference */</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">PERF_COUNT_HW_CACHE_MISSES</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mh">0x412e</span><span class="p">;</span><span class="w">  </span><span class="cm">/* LLC Misses */</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">PERF_COUNT_HW_BRANCH_INSTRUCTIONS</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mh">0x00c4</span><span class="p">;</span><span class="w">  </span><span class="cm">/* BR_INST_RETIRED.ALL_BRANCHES */</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">PERF_COUNT_HW_BRANCH_MISSES</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mh">0x00c5</span><span class="p">;</span><span class="w">  </span><span class="cm">/* BR_MISP_RETIRED.ALL_BRANCHES */</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>PMU ä¸­æ–­å¤„ç†</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* æ€§èƒ½è®¡æ•°å™¨æº¢å‡ºä¸­æ–­å¤„ç† */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">intel_pmu_handle_irq</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">pt_regs</span><span class="w"> </span><span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">cpu_hw_events</span><span class="w"> </span><span class="o">*</span><span class="n">cpuc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this_cpu_ptr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu_hw_events</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">bit</span><span class="p">,</span><span class="w"> </span><span class="n">loops</span><span class="p">;</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* è¯»å–æº¢å‡ºçŠ¶æ€ */</span>
<span class="w">    </span><span class="n">rdmsrl</span><span class="p">(</span><span class="n">MSR_CORE_PERF_GLOBAL_STATUS</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>

<span class="w">    </span><span class="n">for_each_set_bit</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">X86_PMC_IDX_MAX</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">perf_event</span><span class="w"> </span><span class="o">*</span><span class="n">event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">bit</span><span class="p">];</span>

<span class="w">        </span><span class="cm">/* å¤„ç†æº¢å‡º */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">intel_pmu_save_and_restart</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span>

<span class="w">        </span><span class="cm">/* ç”Ÿæˆé‡‡æ ·æ•°æ® */</span>
<span class="w">        </span><span class="n">perf_sample_data_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">last_period</span><span class="p">);</span>

<span class="w">        </span><span class="cm">/* è°ƒç”¨æº¢å‡ºå¤„ç†å™¨ */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">perf_event_overflow</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">))</span>
<span class="w">            </span><span class="n">x86_pmu_stop</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* æ¸…é™¤æº¢å‡ºçŠ¶æ€ */</span>
<span class="w">    </span><span class="n">wrmsrl</span><span class="p">(</span><span class="n">MSR_CORE_PERF_GLOBAL_OVF_CTRL</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1523">15.2.3 è½¯ä»¶äº‹ä»¶ä¸è·Ÿè¸ªç‚¹</h3>
<p>é™¤äº†ç¡¬ä»¶è®¡æ•°å™¨ï¼Œperf_events è¿˜æ”¯æŒçº¯è½¯ä»¶äº‹ä»¶å’Œè·Ÿè¸ªç‚¹äº‹ä»¶ã€‚</p>
<p><strong>è½¯ä»¶äº‹ä»¶ç±»å‹</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">enum</span><span class="w"> </span><span class="n">perf_sw_ids</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">PERF_COUNT_SW_CPU_CLOCK</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">PERF_COUNT_SW_TASK_CLOCK</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="n">PERF_COUNT_SW_PAGE_FAULTS</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">    </span><span class="n">PERF_COUNT_SW_CONTEXT_SWITCHES</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
<span class="w">    </span><span class="n">PERF_COUNT_SW_CPU_MIGRATIONS</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span>
<span class="w">    </span><span class="n">PERF_COUNT_SW_PAGE_FAULTS_MIN</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span>
<span class="w">    </span><span class="n">PERF_COUNT_SW_PAGE_FAULTS_MAJ</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span>
<span class="w">    </span><span class="n">PERF_COUNT_SW_ALIGNMENT_FAULTS</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span>
<span class="w">    </span><span class="n">PERF_COUNT_SW_EMULATION_FAULTS</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* è½¯ä»¶äº‹ä»¶è§¦å‘ */</span>
<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">perf_sw_event</span><span class="p">(</span><span class="n">u32</span><span class="w"> </span><span class="n">event_id</span><span class="p">,</span><span class="w"> </span><span class="n">u64</span><span class="w"> </span><span class="n">nr</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">pt_regs</span><span class="w"> </span><span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">static_key_false</span><span class="p">(</span><span class="o">&amp;</span><span class="n">perf_swevent_enabled</span><span class="p">[</span><span class="n">event_id</span><span class="p">]))</span>
<span class="w">        </span><span class="n">__perf_sw_event</span><span class="p">(</span><span class="n">event_id</span><span class="p">,</span><span class="w"> </span><span class="n">nr</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>è·Ÿè¸ªç‚¹é›†æˆ</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* å°†è·Ÿè¸ªç‚¹äº‹ä»¶è¿æ¥åˆ° perf */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">perf_trace_event_init</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">perf_event</span><span class="w"> </span><span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">trace_event_call</span><span class="w"> </span><span class="o">*</span><span class="n">tp_event</span><span class="p">;</span>

<span class="w">    </span><span class="n">tp_event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event</span><span class="o">-&gt;</span><span class="n">tp_event</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">tp_event</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* æ³¨å†Œè·Ÿè¸ªç‚¹å¤„ç†å™¨ */</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">perf_trace_event_reg</span><span class="p">(</span><span class="n">tp_event</span><span class="p">,</span><span class="w"> </span><span class="n">event</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1524">15.2.4 æ€§èƒ½æ•°æ®é‡‡é›†ä¸åˆ†æ</h3>
<p><strong>é‡‡æ ·æœºåˆ¶</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* å‘¨æœŸæ€§é‡‡æ ·é…ç½® */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">perf_event_attr</span><span class="w"> </span><span class="n">attr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">type</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">PERF_TYPE_HARDWARE</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">config</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="n">PERF_COUNT_HW_CPU_CYCLES</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">sample_period</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">100000</span><span class="p">,</span><span class="w">  </span><span class="cm">/* æ¯ 100000 ä¸ªå‘¨æœŸé‡‡æ ·ä¸€æ¬¡ */</span>
<span class="w">    </span><span class="p">.</span><span class="n">sample_type</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">PERF_SAMPLE_IP</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PERF_SAMPLE_TID</span><span class="w"> </span><span class="o">|</span>
<span class="w">                      </span><span class="n">PERF_SAMPLE_TIME</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PERF_SAMPLE_CALLCHAIN</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">exclude_kernel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">exclude_user</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>ç¯å½¢ç¼“å†²åŒºç®¡ç†</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* kernel/events/ring_buffer.c */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">ring_buffer</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w">                </span><span class="n">poll</span><span class="p">;</span>
<span class="w">    </span><span class="n">local_t</span><span class="w">                 </span><span class="n">head</span><span class="p">;</span><span class="w">          </span><span class="cm">/* å†™å…¥ä½ç½® */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">           </span><span class="n">nest</span><span class="p">;</span>
<span class="w">    </span><span class="n">local_t</span><span class="w">                 </span><span class="n">events</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">           </span><span class="n">wakeup_stamp</span><span class="p">;</span>
<span class="w">    </span><span class="n">local_t</span><span class="w">                 </span><span class="n">lost</span><span class="p">;</span>

<span class="w">    </span><span class="kt">long</span><span class="w">                    </span><span class="n">watermark</span><span class="p">;</span>
<span class="w">    </span><span class="kt">long</span><span class="w">                    </span><span class="n">aux_watermark</span><span class="p">;</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">perf_event_mmap_page</span><span class="w"> </span><span class="o">*</span><span class="n">user_page</span><span class="p">;</span><span class="w">  </span><span class="cm">/* ç”¨æˆ·æ˜ å°„é¡µ */</span>
<span class="w">    </span><span class="kt">void</span><span class="w">                    </span><span class="o">*</span><span class="n">data_pages</span><span class="p">[];</span><span class="w">    </span><span class="cm">/* æ•°æ®é¡µæ•°ç»„ */</span>
<span class="p">};</span>

<span class="cm">/* å†™å…¥é‡‡æ ·æ•°æ® */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">perf_output_sample</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">perf_output_handle</span><span class="w"> </span><span class="o">*</span><span class="n">handle</span><span class="p">,</span>
<span class="w">                        </span><span class="k">struct</span><span class="w"> </span><span class="nc">perf_event_header</span><span class="w"> </span><span class="o">*</span><span class="n">header</span><span class="p">,</span>
<span class="w">                        </span><span class="k">struct</span><span class="w"> </span><span class="nc">perf_sample_data</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span>
<span class="w">                        </span><span class="k">struct</span><span class="w"> </span><span class="nc">perf_event</span><span class="w"> </span><span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="cm">/* å†™å…¥é‡‡æ ·å¤´ */</span>
<span class="w">    </span><span class="n">perf_output_put</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">header</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* å†™å…¥ IP */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sample_type</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PERF_SAMPLE_IP</span><span class="p">)</span>
<span class="w">        </span><span class="n">perf_output_put</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* å†™å…¥ TID */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sample_type</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PERF_SAMPLE_TID</span><span class="p">)</span>
<span class="w">        </span><span class="n">perf_output_put</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">tid_entry</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* å†™å…¥è°ƒç”¨æ ˆ */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sample_type</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PERF_SAMPLE_CALLCHAIN</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">callchain</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
<span class="w">        </span><span class="n">perf_output_put</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">callchain</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
<span class="w">        </span><span class="n">perf_output_copy</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">callchain</span><span class="o">-&gt;</span><span class="n">ips</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>ä½¿ç”¨ perf å·¥å…·</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># CPU æ€§èƒ½åˆ†æ</span>
perf<span class="w"> </span>record<span class="w"> </span>-F<span class="w"> </span><span class="m">99</span><span class="w"> </span>-a<span class="w"> </span>-g<span class="w"> </span>--<span class="w"> </span>sleep<span class="w"> </span><span class="m">10</span>
perf<span class="w"> </span>report

<span class="c1"># ç¼“å­˜åˆ†æ</span>
perf<span class="w"> </span>stat<span class="w"> </span>-e<span class="w"> </span>cache-references,cache-misses<span class="w"> </span>./program

<span class="c1"># è°ƒåº¦å»¶è¿Ÿåˆ†æ</span>
perf<span class="w"> </span>sched<span class="w"> </span>record<span class="w"> </span>sleep<span class="w"> </span><span class="m">10</span>
perf<span class="w"> </span>sched<span class="w"> </span>latency

<span class="c1"># é”ç«äº‰åˆ†æ</span>
perf<span class="w"> </span>lock<span class="w"> </span>record<span class="w"> </span>./program
perf<span class="w"> </span>lock<span class="w"> </span>report
</code></pre></div>

<h2 id="153">15.3 å†…æ ¸è°ƒè¯•æŠ€æœ¯</h2>
<p>å†…æ ¸è°ƒè¯•æ˜¯ç³»ç»Ÿå¼€å‘ä¸­æœ€å…·æŒ‘æˆ˜æ€§çš„ä»»åŠ¡ä¹‹ä¸€ã€‚ä¸ç”¨æˆ·ç©ºé—´ç¨‹åºä¸åŒï¼Œå†…æ ¸è¿è¡Œåœ¨ç‰¹æƒçº§åˆ«ï¼Œä¸€ä¸ªé”™è¯¯å°±å¯èƒ½å¯¼è‡´ç³»ç»Ÿå´©æºƒã€‚Linux æä¾›äº†ä»æºç çº§è°ƒè¯•åˆ°å´©æºƒåˆ†æçš„å®Œæ•´å·¥å…·é“¾ã€‚</p>
<h3 id="1531-kgdb">15.3.1 KGDB å†…æ ¸è°ƒè¯•å™¨</h3>
<p>KGDB æ˜¯ Linux å†…æ ¸çš„æºç çº§è°ƒè¯•å™¨ï¼Œé€šè¿‡ä¸²å£æˆ–ç½‘ç»œè¿æ¥è¿œç¨‹ GDBï¼Œå®ç°å¯¹è¿è¡Œä¸­å†…æ ¸çš„è°ƒè¯•ã€‚å®ƒç”± Jason Wessel ç»´æŠ¤ï¼Œä» 2.6.26 ç‰ˆæœ¬å¼€å§‹è¿›å…¥ä¸»çº¿ã€‚</p>
<p><strong>æ¶æ„è®¾è®¡</strong></p>
<p>KGDB é‡‡ç”¨å®¢æˆ·ç«¯-æœåŠ¡å™¨æ¶æ„ï¼Œå†…æ ¸ä½œä¸ºè°ƒè¯•å­˜æ ¹ï¼ˆstubï¼‰ï¼Œå¤–éƒ¨ GDB ä½œä¸ºè°ƒè¯•å™¨ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="err">å¼€å‘æœºå™¨</span><span class="w">                     </span><span class="err">ç›®æ ‡æœºå™¨</span>
<span class="w">    </span><span class="o">+-------+</span><span class="w">                   </span><span class="o">+--------+</span>
<span class="w">    </span><span class="o">|</span><span class="w">  </span><span class="n">GDB</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="o">&lt;---</span><span class="w"> </span><span class="err">ä¸²å£</span><span class="o">/</span><span class="err">ç½‘ç»œ</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="n">KGDB</span><span class="w">  </span><span class="o">|</span>
<span class="w">    </span><span class="o">+-------+</span><span class="w">                   </span><span class="o">|</span><span class="w"> </span><span class="n">Kernel</span><span class="w"> </span><span class="o">|</span>
<span class="w">        </span><span class="o">|</span><span class="w">                       </span><span class="o">+--------+</span>
<span class="w">        </span><span class="n">v</span><span class="w">                           </span><span class="o">|</span>
<span class="w">    </span><span class="err">æºç ç¬¦å·</span><span class="w">                     </span><span class="err">æ–­ç‚¹</span><span class="o">/</span><span class="err">å•æ­¥</span>
</code></pre></div>

<p><strong>æ ¸å¿ƒç»„ä»¶</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* kernel/debug/debug_core.c */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">kgdb_state</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w">                     </span><span class="n">cpu</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w">                     </span><span class="n">pass_exception</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">           </span><span class="n">threadid</span><span class="p">;</span>
<span class="w">    </span><span class="kt">long</span><span class="w">                    </span><span class="n">kgdb_usethreadid</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pt_regs</span><span class="w">          </span><span class="o">*</span><span class="n">linux_regs</span><span class="p">;</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w">                </span><span class="o">*</span><span class="n">send_ready</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* KGDB æ¶æ„æ¥å£ */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">kgdb_arch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w">           </span><span class="n">gdb_bpt_instr</span><span class="p">[</span><span class="n">BREAK_INSTR_SIZE</span><span class="p">];</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">           </span><span class="n">flags</span><span class="p">;</span>

<span class="w">    </span><span class="kt">int</span><span class="w">  </span><span class="p">(</span><span class="o">*</span><span class="n">set_breakpoint</span><span class="p">)(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">saved_instr</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w">  </span><span class="p">(</span><span class="o">*</span><span class="n">remove_breakpoint</span><span class="p">)(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">bundle</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w">  </span><span class="p">(</span><span class="o">*</span><span class="n">set_hw_breakpoint</span><span class="p">)(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">kgdb_bptype</span><span class="w"> </span><span class="n">type</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w">  </span><span class="p">(</span><span class="o">*</span><span class="n">remove_hw_breakpoint</span><span class="p">)(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">kgdb_bptype</span><span class="w"> </span><span class="n">type</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">disable_hw_break</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">pt_regs</span><span class="w"> </span><span class="o">*</span><span class="n">regs</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">correct_hw_break</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">enable_nmi</span><span class="p">)(</span><span class="kt">bool</span><span class="w"> </span><span class="n">on</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>æ–­ç‚¹å®ç°æœºåˆ¶</strong></p>
<p>KGDB æ”¯æŒè½¯ä»¶æ–­ç‚¹å’Œç¡¬ä»¶æ–­ç‚¹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* è½¯ä»¶æ–­ç‚¹ï¼šæ›¿æ¢æŒ‡ä»¤ä¸º int3 (x86) */</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">kgdb_arch_set_breakpoint</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">kgdb_bkpt</span><span class="w"> </span><span class="o">*</span><span class="n">bpt</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">opc</span><span class="p">[</span><span class="n">BREAK_INSTR_SIZE</span><span class="p">];</span>

<span class="w">    </span><span class="cm">/* ä¿å­˜åŸå§‹æŒ‡ä»¤ */</span>
<span class="w">    </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">probe_kernel_read</span><span class="p">(</span><span class="n">opc</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">bpt</span><span class="o">-&gt;</span><span class="n">bpt_addr</span><span class="p">,</span><span class="w"> </span><span class="n">BREAK_INSTR_SIZE</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">bpt</span><span class="o">-&gt;</span><span class="n">saved_instr</span><span class="p">,</span><span class="w"> </span><span class="n">opc</span><span class="p">,</span><span class="w"> </span><span class="n">BREAK_INSTR_SIZE</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* å†™å…¥æ–­ç‚¹æŒ‡ä»¤ */</span>
<span class="w">    </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">probe_kernel_write</span><span class="p">((</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">bpt</span><span class="o">-&gt;</span><span class="n">bpt_addr</span><span class="p">,</span><span class="w"> </span>
<span class="w">                            </span><span class="n">arch_kgdb_ops</span><span class="p">.</span><span class="n">gdb_bpt_instr</span><span class="p">,</span><span class="w"> </span><span class="n">BREAK_INSTR_SIZE</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ç¡¬ä»¶æ–­ç‚¹ï¼šä½¿ç”¨ CPU è°ƒè¯•å¯„å­˜å™¨ */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">hw_break_reserve_slot</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">breakno</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">cpu</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">perf_event</span><span class="w"> </span><span class="o">**</span><span class="n">pevent</span><span class="p">;</span>

<span class="w">    </span><span class="n">for_each_online_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pevent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">breakinfo</span><span class="p">[</span><span class="n">breakno</span><span class="p">].</span><span class="n">pev</span><span class="p">,</span><span class="w"> </span><span class="n">cpu</span><span class="p">);</span>
<span class="w">        </span><span class="o">*</span><span class="n">pevent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">register_wide_hw_breakpoint</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="o">*</span><span class="n">pevent</span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="o">*</span><span class="n">pevent</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>å¼‚å¸¸å¤„ç†æµç¨‹</strong></p>
<p>å½“è§¦å‘æ–­ç‚¹æˆ–æ”¶åˆ°è°ƒè¯•ä¿¡å·æ—¶ï¼ŒKGDB æ¥ç®¡ç³»ç»Ÿï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* è¿›å…¥ KGDB çš„æ ¸å¿ƒå‡½æ•° */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">kgdb_cpu_enter</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">kgdb_state</span><span class="w"> </span><span class="o">*</span><span class="n">ks</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">pt_regs</span><span class="w"> </span><span class="o">*</span><span class="n">regs</span><span class="p">,</span>
<span class="w">                         </span><span class="kt">int</span><span class="w"> </span><span class="n">exception_state</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">raw_smp_processor_id</span><span class="p">();</span>

<span class="w">    </span><span class="cm">/* 1. åœæ­¢å…¶ä»– CPU */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">kgdb_single_step</span><span class="p">)</span>
<span class="w">        </span><span class="n">kgdb_roundup_cpus</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* 2. ç¦ç”¨ä¸­æ–­ */</span>
<span class="w">    </span><span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* 3. è¿›å…¥è°ƒè¯•å¾ªç¯ */</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* ç­‰å¾… GDB å‘½ä»¤ */</span>
<span class="w">        </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gdb_serial_stub</span><span class="p">(</span><span class="n">ks</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DBG_PASS_EVENT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="cm">/* ç»§ç»­æ‰§è¡Œ */</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="cm">/* å¤„ç†å‘½ä»¤ */</span>
<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">ks</span><span class="o">-&gt;</span><span class="n">gdb_cmd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;c&#39;</span><span class="p">:</span><span class="w">  </span><span class="cm">/* continue */</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;s&#39;</span><span class="p">:</span><span class="w">  </span><span class="cm">/* single step */</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* 4. æ¢å¤æ‰§è¡Œ */</span>
<span class="w">    </span><span class="n">kgdb_restore_cpus</span><span class="p">();</span>
<span class="w">    </span><span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>ä½¿ç”¨é…ç½®</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># å†…æ ¸é…ç½®</span>
<span class="nv">CONFIG_KGDB</span><span class="o">=</span>y
<span class="nv">CONFIG_KGDB_SERIAL_CONSOLE</span><span class="o">=</span>y
<span class="nv">CONFIG_KGDB_KDB</span><span class="o">=</span>y

<span class="c1"># å¯åŠ¨å‚æ•°</span>
<span class="nv">kgdboc</span><span class="o">=</span>ttyS0,115200<span class="w"> </span>kgdbwait

<span class="c1"># GDB è¿æ¥</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>target<span class="w"> </span>remote<span class="w"> </span>/dev/ttyS0
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span><span class="nb">set</span><span class="w"> </span>debug<span class="w"> </span>remote<span class="w"> </span><span class="m">1</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span><span class="k">break</span><span class="w"> </span>sys_open
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span><span class="k">continue</span>
</code></pre></div>

<h3 id="1532-crash">15.3.2 crash å·¥å…·ä¸å†…æ ¸è½¬å‚¨</h3>
<p>crash æ˜¯ Red Hat å¼€å‘çš„å†…æ ¸å´©æºƒåˆ†æå·¥å…·ï¼Œç”± Dave Anderson ç»´æŠ¤ã€‚å®ƒå¯ä»¥åˆ†æè¿è¡Œä¸­çš„ç³»ç»Ÿæˆ–å´©æºƒè½¬å‚¨æ–‡ä»¶ï¼ˆvmcoreï¼‰ã€‚</p>
<p><strong>å·¥ä½œåŸç†</strong></p>
<p>crash é€šè¿‡è§£æå†…æ ¸ç¬¦å·è¡¨å’Œæ•°æ®ç»“æ„ï¼Œæä¾›ç±»ä¼¼ GDB çš„è°ƒè¯•æ¥å£ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">vmcore</span><span class="o">/</span><span class="n">live</span><span class="w"> </span><span class="n">system</span>
<span class="w">           </span><span class="o">|</span>
<span class="w">    </span><span class="o">+------</span><span class="n">v</span><span class="o">------+</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">crash</span><span class="w"> </span><span class="k">tool</span><span class="w">  </span><span class="o">|</span>
<span class="w">    </span><span class="o">+-------------+</span>
<span class="w">           </span><span class="o">|</span>
<span class="w">    </span><span class="err">è§£æå†…æ ¸ç»“æ„</span>
<span class="w">           </span><span class="o">|</span>
<span class="w">    </span><span class="o">+------</span><span class="n">v</span><span class="o">------+</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="err">ç¬¦å·è¡¨</span><span class="w">      </span><span class="o">|</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">debuginfo</span><span class="w">   </span><span class="o">|</span>
<span class="w">    </span><span class="o">+-------------+</span>
</code></pre></div>

<p><strong>æ ¸å¿ƒåŠŸèƒ½å®ç°</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* crash å†…éƒ¨æ•°æ®ç»“æ„è§£æ */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">task_context</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ulong</span><span class="w"> </span><span class="n">task</span><span class="p">;</span><span class="w">           </span><span class="cm">/* task_struct åœ°å€ */</span>
<span class="w">    </span><span class="n">ulong</span><span class="w"> </span><span class="n">thread_info</span><span class="p">;</span><span class="w">    </span><span class="cm">/* thread_info åœ°å€ */</span>
<span class="w">    </span><span class="n">ulong</span><span class="w"> </span><span class="n">pid</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">comm</span><span class="p">[</span><span class="n">TASK_COMM_LEN</span><span class="p">];</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">processor</span><span class="p">;</span>
<span class="w">    </span><span class="n">ulong</span><span class="w"> </span><span class="n">ptask</span><span class="p">;</span><span class="w">          </span><span class="cm">/* çˆ¶è¿›ç¨‹ */</span>
<span class="w">    </span><span class="n">ulong</span><span class="w"> </span><span class="n">mm_struct</span><span class="p">;</span><span class="w">      </span><span class="cm">/* å†…å­˜æè¿°ç¬¦ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_context</span><span class="w"> </span><span class="o">*</span><span class="n">tc_next</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* è¯»å–å†…æ ¸å†…å­˜ */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">readmem</span><span class="p">(</span><span class="n">ulonglong</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">memtype</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span>
<span class="w">                   </span><span class="kt">long</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">ulong</span><span class="w"> </span><span class="n">error_handle</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">memtype</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">KVADDR</span><span class="p">:</span>
<span class="w">        </span><span class="cm">/* å†…æ ¸è™šæ‹Ÿåœ°å€ */</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">read_kdump</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">PHYSADDR</span><span class="p">:</span>
<span class="w">        </span><span class="cm">/* ç‰©ç†åœ°å€ */</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">read_physmem</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">FILEADDR</span><span class="p">:</span>
<span class="w">        </span><span class="cm">/* æ–‡ä»¶åç§» */</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">read_vmcore</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>å¸¸ç”¨å‘½ä»¤å®ç°</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* bt - æ˜¾ç¤ºè°ƒç”¨æ ˆ */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">cmd_bt</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_info</span><span class="w"> </span><span class="n">bt_info</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">bt</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_context</span><span class="w"> </span><span class="o">*</span><span class="n">tc</span><span class="p">;</span>
<span class="w">    </span><span class="n">ulong</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">ip</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* è·å–å½“å‰ä»»åŠ¡ä¸Šä¸‹æ–‡ */</span>
<span class="w">    </span><span class="n">tc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CURRENT_CONTEXT</span><span class="p">();</span>

<span class="w">    </span><span class="cm">/* åˆå§‹åŒ–æ ˆå¸§ä¿¡æ¯ */</span>
<span class="w">    </span><span class="n">bt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bt_info</span><span class="p">;</span>
<span class="w">    </span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">;</span>
<span class="w">    </span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">stackbase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GET_STACKBASE</span><span class="p">(</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* å±•å¼€è°ƒç”¨æ ˆ */</span>
<span class="w">    </span><span class="n">sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">thread_info</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">OFFSET</span><span class="p">(</span><span class="n">thread_info_cpu_context</span><span class="p">);</span>
<span class="w">    </span><span class="n">ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GET_PC</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">sp</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">stackbase</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* è§£ææ ˆå¸§ */</span>
<span class="w">        </span><span class="n">frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GET_FRAME_POINTER</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
<span class="w">        </span><span class="n">function</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">closest_symbol</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>

<span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;#%d [%016lx] %s at %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                </span><span class="n">level</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">function</span><span class="p">,</span><span class="w"> </span><span class="n">ip</span><span class="p">);</span>

<span class="w">        </span><span class="cm">/* ä¸‹ä¸€å¸§ */</span>
<span class="w">        </span><span class="n">sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frame</span><span class="p">;</span>
<span class="w">        </span><span class="n">ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GET_RETURN_ADDRESS</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>ä½¿ç”¨ç¤ºä¾‹</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># åˆ†æ vmcore</span>
crash<span class="w"> </span>/usr/lib/debug/lib/modules/<span class="k">$(</span>uname<span class="w"> </span>-r<span class="k">)</span>/vmlinux<span class="w"> </span>/var/crash/vmcore

<span class="c1"># å¸¸ç”¨å‘½ä»¤</span>
crash&gt;<span class="w"> </span>sys<span class="w">          </span><span class="c1"># ç³»ç»Ÿä¿¡æ¯</span>
crash&gt;<span class="w"> </span>bt<span class="w">           </span><span class="c1"># å½“å‰ä»»åŠ¡è°ƒç”¨æ ˆ</span>
crash&gt;<span class="w"> </span>ps<span class="w">           </span><span class="c1"># è¿›ç¨‹åˆ—è¡¨</span>
crash&gt;<span class="w"> </span>log<span class="w">          </span><span class="c1"># å†…æ ¸æ—¥å¿—</span>
crash&gt;<span class="w"> </span>dis<span class="w"> </span>-l<span class="w"> </span>function_name<span class="w">  </span><span class="c1"># åæ±‡ç¼–</span>
crash&gt;<span class="w"> </span>struct<span class="w"> </span>task_struct<span class="w"> </span>ffff88007c8a0000<span class="w">  </span><span class="c1"># æŸ¥çœ‹æ•°æ®ç»“æ„</span>
crash&gt;<span class="w"> </span>foreach<span class="w"> </span>bt<span class="w">   </span><span class="c1"># æ‰€æœ‰ä»»åŠ¡çš„è°ƒç”¨æ ˆ</span>
</code></pre></div>

<h3 id="1533-kdump">15.3.3 kdump æœºåˆ¶</h3>
<p>kdump æ˜¯ Linux çš„å†…æ ¸å´©æºƒè½¬å‚¨æœºåˆ¶ï¼Œä½¿ç”¨ kexec åœ¨ç³»ç»Ÿå´©æºƒæ—¶å¯åŠ¨ç¬¬äºŒä¸ªå†…æ ¸æ¥æ”¶é›†è½¬å‚¨ã€‚</p>
<p><strong>å·¥ä½œæµç¨‹</strong></p>
<div class="codehilite"><pre><span></span><code>    ç”Ÿäº§å†…æ ¸å´©æºƒ
         |
         v
    è§¦å‘ panic()
         |
         v
    machine_kexec()
         |
         v
    åŠ è½½æ•è·å†…æ ¸
         |
         v
    æ•è·å†…æ ¸å¯åŠ¨
         |
         v
    æ”¶é›† vmcore
         |
         v
    ä¿å­˜åˆ°ç£ç›˜
</code></pre></div>

<p><strong>å®ç°æœºåˆ¶</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* kernel/kexec_core.c */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">__crash_kexec</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">pt_regs</span><span class="w"> </span><span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="cm">/* å·²ç»æœ‰ CPU åœ¨å¤„ç† */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mutex_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kexec_mutex</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kexec_crash_image</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">struct</span><span class="w"> </span><span class="nc">pt_regs</span><span class="w"> </span><span class="n">fixed_regs</span><span class="p">;</span>

<span class="w">            </span><span class="cm">/* ä¿å­˜å´©æºƒæ—¶çš„å¯„å­˜å™¨ */</span>
<span class="w">            </span><span class="n">crash_setup_regs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fixed_regs</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">);</span>
<span class="w">            </span><span class="n">crash_save_vmcoreinfo</span><span class="p">();</span>

<span class="w">            </span><span class="cm">/* å…³é—­å…¶ä»– CPU */</span>
<span class="w">            </span><span class="n">machine_crash_shutdown</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fixed_regs</span><span class="p">);</span>

<span class="w">            </span><span class="cm">/* è·³è½¬åˆ°æ•è·å†…æ ¸ */</span>
<span class="w">            </span><span class="n">machine_kexec</span><span class="p">(</span><span class="n">kexec_crash_image</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kexec_mutex</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ä¿ç•™å†…å­˜åŒºåŸŸ */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">reserve_crashkernel</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">crash_size</span><span class="p">,</span><span class="w"> </span><span class="n">crash_base</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* è§£æ crashkernel= å‚æ•° */</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse_crashkernel</span><span class="p">(</span><span class="n">boot_command_line</span><span class="p">,</span><span class="w"> </span><span class="n">memblock_phys_mem_size</span><span class="p">(),</span>
<span class="w">                           </span><span class="o">&amp;</span><span class="n">crash_size</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">crash_base</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* é¢„ç•™å†…å­˜ */</span>
<span class="w">    </span><span class="n">memblock_reserve</span><span class="p">(</span><span class="n">crash_base</span><span class="p">,</span><span class="w"> </span><span class="n">crash_size</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* è®¾ç½®å…¨å±€å˜é‡ */</span>
<span class="w">    </span><span class="n">crashk_res</span><span class="p">.</span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">crash_base</span><span class="p">;</span>
<span class="w">    </span><span class="n">crashk_res</span><span class="p">.</span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">crash_base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">crash_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>vmcore ç”Ÿæˆ</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* fs/proc/vmcore.c */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">vmcore_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* è§£æ ELF å¤´ */</span>
<span class="w">    </span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse_crash_elf_headers</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rc</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">rc</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* åˆ›å»º /proc/vmcore */</span>
<span class="w">    </span><span class="n">proc_vmcore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;vmcore&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">S_IRUSR</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">proc_vmcore_operations</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* è¯»å– vmcore */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">ssize_t</span><span class="w"> </span><span class="nf">read_vmcore</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
<span class="w">                          </span><span class="kt">size_t</span><span class="w"> </span><span class="n">buflen</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="n">fpos</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="cm">/* è¯»å– ELF å¤´ */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">fpos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">elfcorebuf_sz</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">tsz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">elfcorebuf_sz</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="o">*</span><span class="n">fpos</span><span class="p">,</span><span class="w"> </span><span class="n">buflen</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">elfcorebuf</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">*</span><span class="n">fpos</span><span class="p">,</span><span class="w"> </span><span class="n">tsz</span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* è¯»å–ç¨‹åºæ®µ */</span>
<span class="w">    </span><span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vmcore_list</span><span class="p">,</span><span class="w"> </span><span class="n">list</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">fpos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">tsz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">*</span><span class="n">fpos</span><span class="p">,</span><span class="w"> </span><span class="n">buflen</span><span class="p">);</span>
<span class="w">            </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">fpos</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>

<span class="w">            </span><span class="cm">/* æ‹·è´ç‰©ç†å†…å­˜ */</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">copy_oldmem_page</span><span class="p">(</span><span class="n">pfn</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">tsz</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">))</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>é…ç½®ä½¿ç”¨</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># å®‰è£… kdump å·¥å…·</span>
yum<span class="w"> </span>install<span class="w"> </span>kexec-tools

<span class="c1"># é…ç½®é¢„ç•™å†…å­˜</span>
<span class="c1"># /etc/default/grub</span>
<span class="nv">GRUB_CMDLINE_LINUX</span><span class="o">=</span><span class="s2">&quot;crashkernel=256M&quot;</span>

<span class="c1"># å¯åŠ¨ kdump æœåŠ¡</span>
systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>kdump
systemctl<span class="w"> </span>start<span class="w"> </span>kdump

<span class="c1"># æµ‹è¯•å´©æºƒ</span>
<span class="nb">echo</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>&gt;<span class="w"> </span>/proc/sys/kernel/sysrq
<span class="nb">echo</span><span class="w"> </span>c<span class="w"> </span>&gt;<span class="w"> </span>/proc/sysrq-trigger
</code></pre></div>

<h3 id="1534-pr_debug">15.3.4 åŠ¨æ€æ‰“å°ä¸ pr_debug</h3>
<p>åŠ¨æ€è°ƒè¯•ï¼ˆdynamic debugï¼‰å…è®¸åœ¨è¿è¡Œæ—¶æ§åˆ¶è°ƒè¯•ä¿¡æ¯çš„è¾“å‡ºï¼Œæ— éœ€é‡æ–°ç¼–è¯‘å†…æ ¸ã€‚</p>
<p><strong>å®ç°åŸç†</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* include/linux/dynamic_debug.h */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">_ddebug</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">modname</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">function</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">filename</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">format</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">lineno</span><span class="o">:</span><span class="mi">18</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="o">:</span><span class="mi">8</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="mi">8</span><span class="p">)));</span>

<span class="cm">/* pr_debug å®å±•å¼€ */</span>
<span class="cp">#define pr_debug(fmt, ...)                                      \</span>
<span class="cp">    dynamic_pr_debug(fmt, ##__VA_ARGS__)</span>

<span class="cp">#define dynamic_pr_debug(fmt, ...)                              \</span>
<span class="cp">do {                                                            \</span>
<span class="cp">    DEFINE_DYNAMIC_DEBUG_METADATA(descriptor, fmt);             \</span>
<span class="cp">    if (DYNAMIC_DEBUG_BRANCH(descriptor))                       \</span>
<span class="cp">        __dynamic_pr_debug(&amp;descriptor, pr_fmt(fmt),           \</span>
<span class="cp">                          ##__VA_ARGS__);                       \</span>
<span class="cp">} while (0)</span>
</code></pre></div>

<p><strong>æ§åˆ¶æ¥å£</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* lib/dynamic_debug.c */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">ddebug_proc_write</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">ubuf</span><span class="p">,</span>
<span class="w">                            </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="n">offp</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">words</span><span class="p">[</span><span class="n">MAXWORDS</span><span class="p">];</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ddebug_query</span><span class="w"> </span><span class="n">query</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* è§£ææ§åˆ¶å‘½ä»¤ */</span>
<span class="w">    </span><span class="n">nwords</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ddebug_tokenize</span><span class="p">(</span><span class="n">tmpbuf</span><span class="p">,</span><span class="w"> </span><span class="n">words</span><span class="p">,</span><span class="w"> </span><span class="n">MAXWORDS</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* è§£ææŸ¥è¯¢æ¡ä»¶ */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ddebug_parse_query</span><span class="p">(</span><span class="n">words</span><span class="p">,</span><span class="w"> </span><span class="n">nwords</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">query</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* åº”ç”¨ä¿®æ”¹ */</span>
<span class="w">    </span><span class="n">nfound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ddebug_change</span><span class="p">(</span><span class="o">&amp;</span><span class="n">query</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">mask</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ä¿®æ”¹è°ƒè¯•æ ‡å¿— */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">ddebug_change</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">ddebug_query</span><span class="w"> </span><span class="o">*</span><span class="n">query</span><span class="p">,</span>
<span class="w">                        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ddebug_table</span><span class="w"> </span><span class="o">*</span><span class="n">dt</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">_ddebug</span><span class="w"> </span><span class="o">*</span><span class="n">dp</span><span class="p">;</span>

<span class="w">    </span><span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ddebug_tables</span><span class="p">,</span><span class="w"> </span><span class="n">link</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">dp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dt</span><span class="o">-&gt;</span><span class="n">ddebugs</span><span class="p">;</span><span class="w"> </span><span class="n">dp</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dt</span><span class="o">-&gt;</span><span class="n">ddebugs</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dt</span><span class="o">-&gt;</span><span class="n">num_ddebugs</span><span class="p">;</span><span class="w"> </span><span class="n">dp</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="cm">/* åŒ¹é…æŸ¥è¯¢æ¡ä»¶ */</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">match_wildcard</span><span class="p">(</span><span class="n">query</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span><span class="w"> </span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">modname</span><span class="p">))</span>
<span class="w">                </span><span class="k">continue</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">match_wildcard</span><span class="p">(</span><span class="n">query</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">,</span><span class="w"> </span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">))</span>
<span class="w">                </span><span class="k">continue</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">match_wildcard</span><span class="p">(</span><span class="n">query</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">))</span>
<span class="w">                </span><span class="k">continue</span><span class="p">;</span>

<span class="w">            </span><span class="cm">/* æ›´æ–°æ ‡å¿— */</span>
<span class="w">            </span><span class="n">newflags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">mask</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newflags</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newflags</span><span class="p">;</span>
<span class="w">                </span><span class="n">matched</span><span class="o">++</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">matched</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>ä½¿ç”¨æ–¹æ³•</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># å¯ç”¨ç‰¹å®šæ–‡ä»¶çš„è°ƒè¯•</span>
<span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;file tcp_input.c +p&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/kernel/debug/dynamic_debug/control

<span class="c1"># å¯ç”¨ç‰¹å®šå‡½æ•°</span>
<span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;func tcp_receive_skb +p&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/kernel/debug/dynamic_debug/control

<span class="c1"># å¯ç”¨æ¨¡å—è°ƒè¯•</span>
<span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;module e1000e +p&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/kernel/debug/dynamic_debug/control

<span class="c1"># æŸ¥çœ‹å½“å‰è®¾ç½®</span>
cat<span class="w"> </span>/sys/kernel/debug/dynamic_debug/control

<span class="c1"># å¸¦æ¡ä»¶çš„è°ƒè¯•</span>
<span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;file drivers/net/* line 1-200 +p&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/kernel/debug/dynamic_debug/control
</code></pre></div>

<h2 id="154">15.4 åŠ¨æ€è¿½è¸ªå·¥å…·</h2>
<p>åŠ¨æ€è¿½è¸ªæŠ€æœ¯è®©æˆ‘ä»¬èƒ½å¤Ÿåœ¨ç”Ÿäº§ç¯å¢ƒä¸­å®‰å…¨åœ°è§‚æµ‹ç³»ç»Ÿè¡Œä¸ºï¼Œæ— éœ€åœæœºæˆ–é‡æ–°ç¼–è¯‘ã€‚ä» SystemTap åˆ° eBPF çš„æ¼”è¿›ï¼Œæ ‡å¿—ç€ Linux å¯è§‚æµ‹æ€§çš„é©å‘½æ€§è¿›æ­¥ã€‚</p>
<h3 id="1541-systemtap">15.4.1 SystemTap æ¡†æ¶</h3>
<p>SystemTap æ˜¯ Red Hat å¼€å‘çš„åŠ¨æ€è¿½è¸ªç³»ç»Ÿï¼Œé€šè¿‡å°†é«˜çº§è„šæœ¬è¯­è¨€ç¼–è¯‘æˆå†…æ ¸æ¨¡å—æ¥å®ç°ç³»ç»Ÿè¿½è¸ªã€‚å°½ç®¡ç°åœ¨ eBPF æ›´å—æ¬¢è¿ï¼Œä½† SystemTap ä»åœ¨è®¸å¤šä¼ä¸šç¯å¢ƒä¸­ä½¿ç”¨ã€‚</p>
<p><strong>æ¶æ„æ¦‚è§ˆ</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c">    SystemTap è„šæœ¬ (</span><span class="nt">.</span><span class="c">stp)</span>
<span class="c">           |</span>
<span class="c">    </span><span class="nb">+------</span><span class="c">v</span><span class="nb">------+</span>
<span class="c">    |   stap ç¼–è¯‘å™¨|  </span><span class="nv">&lt;</span><span class="nb">-</span><span class="c"> è¯­æ³•åˆ†æã€è¯­ä¹‰æ£€æŸ¥</span>
<span class="c">    </span><span class="nb">+------+------+</span>
<span class="c">           |</span>
<span class="c">    </span><span class="nb">+------</span><span class="c">v</span><span class="nb">------+</span>
<span class="c">    | C ä»£ç ç”Ÿæˆ   |  </span><span class="nv">&lt;</span><span class="nb">-</span><span class="c"> ç”Ÿæˆå†…æ ¸æ¨¡å—æºç </span>
<span class="c">    </span><span class="nb">+------+------+</span>
<span class="c">           |</span>
<span class="c">    </span><span class="nb">+------</span><span class="c">v</span><span class="nb">------+</span>
<span class="c">    |  gcc ç¼–è¯‘    |  </span><span class="nv">&lt;</span><span class="nb">-</span><span class="c"> ç¼–è¯‘æˆ </span><span class="nt">.</span><span class="c">ko æ¨¡å—</span>
<span class="c">    </span><span class="nb">+------+------+</span>
<span class="c">           |</span>
<span class="c">    </span><span class="nb">+------</span><span class="c">v</span><span class="nb">------+</span>
<span class="c">    | staprun åŠ è½½ |  </span><span class="nv">&lt;</span><span class="nb">-</span><span class="c"> æ’å…¥å†…æ ¸æ‰§è¡Œ</span>
<span class="c">    </span><span class="nb">+------+------+</span>
<span class="c">           |</span>
<span class="c">    è¿è¡Œæ—¶æ•°æ®æ”¶é›†</span>
</code></pre></div>

<p><strong>è„šæœ¬è¯­è¨€ç‰¹æ€§</strong></p>
<div class="codehilite"><pre><span></span><code><span class="o">/*</span><span class="w"> </span><span class="n">SystemTap</span><span class="w"> </span>è„šæœ¬ç¤ºä¾‹<span class="w"> </span><span class="o">*/</span>
<span class="k">global</span><span class="w"> </span><span class="n">reads</span>

<span class="n">probe</span><span class="w"> </span><span class="n">vfs</span><span class="p">.</span><span class="nb">read</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">reads</span><span class="p">[</span><span class="n">execname</span><span class="p">(),</span><span class="w"> </span><span class="n">pid</span><span class="p">()]</span><span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="w"> </span><span class="no">$</span><span class="n">count</span>
<span class="p">}</span>

<span class="n">probe</span><span class="w"> </span><span class="nb">timer</span><span class="p">.</span><span class="n">s</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">printf</span><span class="p">(</span><span class="s">&quot;Top processes reading:\n&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">foreach</span><span class="w"> </span><span class="p">([</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">]</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">reads</span><span class="o">-</span><span class="w"> </span><span class="n">limit</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">printf</span><span class="p">(</span><span class="s">&quot;%s[%d]: %d bytes\n&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">               </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="p">@</span><span class="nb">sum</span><span class="p">(</span><span class="n">reads</span><span class="p">[</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">]))</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nb">delete</span><span class="w"> </span><span class="n">reads</span>
<span class="p">}</span>

<span class="o">/*</span><span class="w"> </span>æ¢é’ˆè¯­æ³•<span class="w"> </span><span class="o">*/</span>
<span class="n">probe</span><span class="w"> </span><span class="nb">kernel</span><span class="p">.</span><span class="k">function</span><span class="p">(</span><span class="s">&quot;tcp_sendmsg&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">printf</span><span class="p">(</span><span class="s">&quot;TCP send from %s: %d bytes\n&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">           </span><span class="n">execname</span><span class="p">(),</span><span class="w"> </span><span class="no">$</span><span class="nb">size</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">probe</span><span class="w"> </span><span class="nb">kernel</span><span class="p">.</span><span class="k">function</span><span class="p">(</span><span class="s">&quot;tcp_sendmsg&quot;</span><span class="p">).</span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="no">$</span><span class="k">return</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="nb">printf</span><span class="p">(</span><span class="s">&quot;TCP send failed: %d\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="no">$</span><span class="k">return</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>è¿è¡Œæ—¶å®ç°</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* runtime/transport/transport.c */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">_stp_transport_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="cm">/* åˆ›å»º relayfs é€šé“ */</span>
<span class="w">    </span><span class="n">_stp_relay_data</span><span class="p">.</span><span class="n">rchan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">relay_open</span><span class="p">(</span><span class="s">&quot;trace&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                       </span><span class="n">_stp_get_module_dir</span><span class="p">(),</span>
<span class="w">                                       </span><span class="n">_stp_bufsize</span><span class="p">,</span>
<span class="w">                                       </span><span class="n">n_subbufs</span><span class="p">,</span>
<span class="w">                                       </span><span class="o">&amp;</span><span class="n">_stp_relay_callbacks</span><span class="p">,</span>
<span class="w">                                       </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* æ³¨å†Œæ¢é’ˆ */</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">_stp_num_probes</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">stap_probe</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">_stp_probes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">        </span><span class="n">register_kprobe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">kprobe</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* æ¢é’ˆå¤„ç†å™¨æ¨¡æ¿ */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">probe_NNNN</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">kprobe</span><span class="w"> </span><span class="o">*</span><span class="n">inst</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">pt_regs</span><span class="w"> </span><span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">context</span><span class="w"> </span><span class="o">*</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">contexts</span><span class="p">,</span><span class="w"> </span><span class="n">smp_processor_id</span><span class="p">());</span>

<span class="w">    </span><span class="cm">/* è·å–ä¸Šä¸‹æ–‡ */</span>
<span class="w">    </span><span class="n">c</span><span class="o">-&gt;</span><span class="n">regs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regs</span><span class="p">;</span>
<span class="w">    </span><span class="n">c</span><span class="o">-&gt;</span><span class="n">pi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* æ‰§è¡Œç”¨æˆ·è„šæœ¬é€»è¾‘ */</span>
<span class="w">    </span><span class="n">probe_NNNN_enter</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* è¾“å‡ºæ•°æ® */</span>
<span class="w">    </span><span class="n">_stp_print_flush</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1542-ebpf">15.4.2 eBPF æ¶æ„ä¸åŸç†</h3>
<p>eBPFï¼ˆextended Berkeley Packet Filterï¼‰æ˜¯ Linux å†…æ ¸çš„é©å‘½æ€§æŠ€æœ¯ï¼Œæä¾›äº†å®‰å…¨ã€é«˜æ•ˆçš„å†…æ ¸å¯ç¼–ç¨‹èƒ½åŠ›ã€‚ç”± Alexei Starovoitov ä¸»å¯¼å¼€å‘ï¼Œå·²æˆä¸ºäº‘åŸç”Ÿå¯è§‚æµ‹æ€§çš„åŸºçŸ³ã€‚</p>
<p><strong>eBPF æ¶æ„</strong></p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span>ç”¨æˆ·ç©ºé—´<span class="w">                     </span>å†…æ ¸ç©ºé—´
<span class="w">    </span><span class="o">+--------+</span><span class="w">                </span><span class="o">+------------+</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">eBPF</span><span class="w">   </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="n">eBPF</span><span class="w"> </span>ç¨‹åº<span class="w">  </span><span class="o">|</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span>ç¨‹åº<span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="nf">bpf</span><span class="p">()</span><span class="w"> </span><span class="o">--&gt;</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="p">(</span>å­—èŠ‚ç <span class="p">)</span><span class="w">   </span><span class="o">|</span>
<span class="w">    </span><span class="o">+--------+</span><span class="w">                </span><span class="o">+-----+------+</span>
<span class="w">                                   </span><span class="o">|</span>
<span class="w">                              </span><span class="o">+----</span><span class="n">v</span><span class="o">-----+</span>
<span class="w">                              </span><span class="o">|</span><span class="w"> </span><span class="n">Verifier</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="o">&lt;-</span><span class="w"> </span>å®‰å…¨éªŒè¯
<span class="w">                              </span><span class="o">+----+-----+</span>
<span class="w">                                   </span><span class="o">|</span>
<span class="w">                              </span><span class="o">+----</span><span class="n">v</span><span class="o">-----+</span>
<span class="w">                              </span><span class="o">|</span><span class="w"> </span><span class="n">JIT</span><span class="w"> </span>ç¼–è¯‘<span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="o">&lt;-</span><span class="w"> </span>ç¼–è¯‘æˆæœºå™¨ç 
<span class="w">                              </span><span class="o">+----+-----+</span>
<span class="w">                                   </span><span class="o">|</span>
<span class="w">                              </span><span class="o">+----</span><span class="n">v</span><span class="o">-----+</span>
<span class="w">                              </span><span class="o">|</span><span class="w"> </span>æ‰§è¡Œå¼•æ“<span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="o">&lt;-</span><span class="w"> </span>åœ¨é’©å­ç‚¹æ‰§è¡Œ
<span class="w">                              </span><span class="o">+----------+</span>
</code></pre></div>

<p><strong>eBPF æŒ‡ä»¤é›†</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* include/uapi/linux/bpf.h */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">bpf_insn</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__u8</span><span class="w">    </span><span class="n">code</span><span class="p">;</span><span class="w">    </span><span class="cm">/* æ“ä½œç  */</span>
<span class="w">    </span><span class="n">__u8</span><span class="w">    </span><span class="n">dst_reg</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span><span class="w">  </span><span class="cm">/* ç›®æ ‡å¯„å­˜å™¨ */</span>
<span class="w">    </span><span class="n">__u8</span><span class="w">    </span><span class="n">src_reg</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span><span class="w">  </span><span class="cm">/* æºå¯„å­˜å™¨ */</span>
<span class="w">    </span><span class="n">__s16</span><span class="w">   </span><span class="n">off</span><span class="p">;</span><span class="w">     </span><span class="cm">/* åç§» */</span>
<span class="w">    </span><span class="n">__s32</span><span class="w">   </span><span class="n">imm</span><span class="p">;</span><span class="w">     </span><span class="cm">/* ç«‹å³æ•° */</span>
<span class="p">};</span>

<span class="cm">/* eBPF å¯„å­˜å™¨ */</span>
<span class="cp">#define BPF_REG_0   0   </span><span class="cm">/* è¿”å›å€¼ */</span>
<span class="cp">#define BPF_REG_1   1   </span><span class="cm">/* å‚æ•° 1 */</span>
<span class="cp">#define BPF_REG_2   2   </span><span class="cm">/* å‚æ•° 2 */</span>
<span class="cp">#define BPF_REG_3   3   </span><span class="cm">/* å‚æ•° 3 */</span>
<span class="cp">#define BPF_REG_4   4   </span><span class="cm">/* å‚æ•° 4 */</span>
<span class="cp">#define BPF_REG_5   5   </span><span class="cm">/* å‚æ•° 5 */</span>
<span class="cp">#define BPF_REG_6   6   </span><span class="cm">/* callee saved */</span>
<span class="cp">#define BPF_REG_7   7   </span><span class="cm">/* callee saved */</span>
<span class="cp">#define BPF_REG_8   8   </span><span class="cm">/* callee saved */</span>
<span class="cp">#define BPF_REG_9   9   </span><span class="cm">/* callee saved */</span>
<span class="cp">#define BPF_REG_10  10  </span><span class="cm">/* æ ˆæŒ‡é’ˆ */</span>

<span class="cm">/* æŒ‡ä»¤ç¤ºä¾‹ */</span>
<span class="n">BPF_MOV64_REG</span><span class="p">(</span><span class="n">BPF_REG_6</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_REG_1</span><span class="p">),</span><span class="w">     </span><span class="cm">/* r6 = r1 */</span>
<span class="n">BPF_LD_ABS</span><span class="p">(</span><span class="n">BPF_B</span><span class="p">,</span><span class="w"> </span><span class="n">ETH_HLEN</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w">         </span><span class="cm">/* åŠ è½½å­—èŠ‚ */</span>
<span class="n">BPF_JMP_IMM</span><span class="p">(</span><span class="n">BPF_JEQ</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_REG_0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x80</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="cm">/* if r0 == 0x80 jump */</span>
<span class="n">BPF_MOV64_IMM</span><span class="p">(</span><span class="n">BPF_REG_0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w">             </span><span class="cm">/* r0 = 0 */</span>
<span class="n">BPF_EXIT_INSN</span><span class="p">(),</span><span class="w">                          </span><span class="cm">/* return r0 */</span>
</code></pre></div>

<p><strong>éªŒè¯å™¨ï¼ˆVerifierï¼‰</strong></p>
<p>eBPF éªŒè¯å™¨ç¡®ä¿ç¨‹åºå®‰å…¨æ€§ï¼Œé˜²æ­¢å†…æ ¸å´©æºƒï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* kernel/bpf/verifier.c */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">do_check</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_verifier_env</span><span class="w"> </span><span class="o">*</span><span class="n">env</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_insn</span><span class="w"> </span><span class="o">*</span><span class="n">insns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">env</span><span class="o">-&gt;</span><span class="n">prog</span><span class="o">-&gt;</span><span class="n">insnsi</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_verifier_state</span><span class="w"> </span><span class="o">*</span><span class="n">state</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">insn_cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">env</span><span class="o">-&gt;</span><span class="n">prog</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* éå†æ‰€æœ‰å¯èƒ½çš„æ‰§è¡Œè·¯å¾„ */</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">insn_cnt</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_insn</span><span class="w"> </span><span class="o">*</span><span class="n">insn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">insns</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">        </span><span class="n">u8</span><span class="w"> </span><span class="n">class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BPF_CLASS</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>

<span class="w">        </span><span class="cm">/* æ£€æŸ¥å†…å­˜è®¿é—® */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">class</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BPF_LDX</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">class</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BPF_STX</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">check_mem_access</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">insn_idx</span><span class="p">,</span><span class="w"> </span><span class="n">regno</span><span class="p">,</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span>
<span class="w">                                 </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">value_regno</span><span class="p">,</span><span class="w"> </span><span class="n">strict_alignment</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="cm">/* æ£€æŸ¥å‡½æ•°è°ƒç”¨ */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="n">BPF_JMP</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">BPF_CALL</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">check_helper_call</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">imm</span><span class="p">,</span><span class="w"> </span><span class="n">insn_idx</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="cm">/* æ£€æŸ¥è·³è½¬ */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">BPF_CLASS</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BPF_JMP</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">check_cond_jmp_op</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">insn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">insn_idx</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* ç¡®ä¿ç¨‹åºæœ‰è¿”å› */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">curframe</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">verbose</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;program didn&#39;t return</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* æ£€æŸ¥å†…å­˜è®¿é—®å®‰å…¨æ€§ */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">check_mem_access</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_verifier_env</span><span class="w"> </span><span class="o">*</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">insn_idx</span><span class="p">,</span>
<span class="w">                           </span><span class="n">u32</span><span class="w"> </span><span class="n">regno</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bpf_size</span><span class="p">,</span>
<span class="w">                           </span><span class="k">enum</span><span class="w"> </span><span class="n">bpf_access_type</span><span class="w"> </span><span class="n">t</span><span class="p">,</span>
<span class="w">                           </span><span class="kt">int</span><span class="w"> </span><span class="n">value_regno</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">strict_alignment</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_reg_state</span><span class="w"> </span><span class="o">*</span><span class="n">regs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur_regs</span><span class="p">(</span><span class="n">env</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_reg_state</span><span class="w"> </span><span class="o">*</span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regs</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">regno</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* æ£€æŸ¥æŒ‡é’ˆç±»å‹ */</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">PTR_TO_MAP_VALUE</span><span class="p">:</span>
<span class="w">        </span><span class="cm">/* æ£€æŸ¥ map è®¿é—®è¾¹ç•Œ */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">check_map_access</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">regno</span><span class="p">,</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">PTR_TO_CTX</span><span class="p">:</span>
<span class="w">        </span><span class="cm">/* æ£€æŸ¥ä¸Šä¸‹æ–‡è®¿é—® */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">check_ctx_access</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">insn_idx</span><span class="p">,</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">reg_type</span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">PTR_TO_STACK</span><span class="p">:</span>
<span class="w">        </span><span class="cm">/* æ£€æŸ¥æ ˆè®¿é—® */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">check_stack_boundary</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">regno</span><span class="p">,</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">access_type</span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>JIT ç¼–è¯‘å™¨</strong></p>
<p>å°† eBPF å­—èŠ‚ç ç¼–è¯‘æˆæœ¬åœ°æœºå™¨ç ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* arch/x86/net/bpf_jit_comp.c */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">do_jit</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_prog</span><span class="w"> </span><span class="o">*</span><span class="n">bpf_prog</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">addrs</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="n">image</span><span class="p">,</span>
<span class="w">                 </span><span class="kt">int</span><span class="w"> </span><span class="n">oldproglen</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">jit_context</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_insn</span><span class="w"> </span><span class="o">*</span><span class="n">insn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_prog</span><span class="o">-&gt;</span><span class="n">insnsi</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">insn_cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_prog</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="n">prog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">insn_cnt</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">insn</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">s32</span><span class="w"> </span><span class="n">imm32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">imm</span><span class="p">;</span>
<span class="w">        </span><span class="n">u32</span><span class="w"> </span><span class="n">dst_reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">dst_reg</span><span class="p">;</span>
<span class="w">        </span><span class="n">u32</span><span class="w"> </span><span class="n">src_reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">src_reg</span><span class="p">;</span>
<span class="w">        </span><span class="n">u8</span><span class="w"> </span><span class="n">b2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">b3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">s64</span><span class="w"> </span><span class="n">jmp_offset</span><span class="p">;</span>
<span class="w">        </span><span class="n">u8</span><span class="w"> </span><span class="n">jmp_cond</span><span class="p">;</span>

<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* ALU æ“ä½œ */</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">BPF_ALU64</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">BPF_ADD</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">BPF_X</span><span class="p">:</span>
<span class="w">            </span><span class="n">EMIT3</span><span class="p">(</span><span class="mh">0x48</span><span class="p">,</span><span class="w"> </span><span class="mh">0x01</span><span class="p">,</span><span class="w"> </span><span class="n">add_2reg</span><span class="p">(</span><span class="mh">0xC0</span><span class="p">,</span><span class="w"> </span><span class="n">dst_reg</span><span class="p">,</span><span class="w"> </span><span class="n">src_reg</span><span class="p">));</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="cm">/* å†…å­˜åŠ è½½ */</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">BPF_LDX</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">BPF_MEM</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">BPF_DW</span><span class="p">:</span>
<span class="w">            </span><span class="n">EMIT3</span><span class="p">(</span><span class="mh">0x48</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8B</span><span class="p">,</span><span class="w"> </span><span class="n">add_2reg</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="n">dst_reg</span><span class="p">,</span><span class="w"> </span><span class="n">src_reg</span><span class="p">));</span>
<span class="w">            </span><span class="n">EMIT1</span><span class="p">(</span><span class="n">insn</span><span class="o">-&gt;</span><span class="n">off</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="cm">/* å‡½æ•°è°ƒç”¨ */</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">BPF_JMP</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">BPF_CALL</span><span class="p">:</span>
<span class="w">            </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">__bpf_call_base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">imm32</span><span class="p">;</span>
<span class="w">            </span><span class="n">jmp_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">prog</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>
<span class="w">            </span><span class="n">EMIT1_off32</span><span class="p">(</span><span class="mh">0xE8</span><span class="p">,</span><span class="w"> </span><span class="n">jmp_offset</span><span class="p">);</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="cm">/* æ¡ä»¶è·³è½¬ */</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">BPF_JMP</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">BPF_JEQ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">BPF_X</span><span class="p">:</span>
<span class="w">            </span><span class="n">EMIT3</span><span class="p">(</span><span class="mh">0x48</span><span class="p">,</span><span class="w"> </span><span class="mh">0x39</span><span class="p">,</span><span class="w"> </span><span class="n">add_2reg</span><span class="p">(</span><span class="mh">0xC0</span><span class="p">,</span><span class="w"> </span><span class="n">dst_reg</span><span class="p">,</span><span class="w"> </span><span class="n">src_reg</span><span class="p">));</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">emit_cond_jmp</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>eBPF Maps</strong></p>
<p>Maps æ˜¯ eBPF ç¨‹åºä¸ç”¨æˆ·ç©ºé—´é€šä¿¡çš„å…³é”®æœºåˆ¶ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* kernel/bpf/hashtab.c */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">bpf_htab</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_map</span><span class="w"> </span><span class="n">map</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bucket</span><span class="w"> </span><span class="o">*</span><span class="n">buckets</span><span class="p">;</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">elems</span><span class="p">;</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">n_buckets</span><span class="p">;</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">elem_size</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lock_class_key</span><span class="w"> </span><span class="n">lockdep_key</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* æŸ¥æ‰¾å…ƒç´  */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">htab_map_lookup_elem</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_map</span><span class="w"> </span><span class="o">*</span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_htab</span><span class="w"> </span><span class="o">*</span><span class="n">htab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">container_of</span><span class="p">(</span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_htab</span><span class="p">,</span><span class="w"> </span><span class="n">map</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_nulls_head</span><span class="w"> </span><span class="o">*</span><span class="n">head</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">htab_elem</span><span class="w"> </span><span class="o">*</span><span class="n">l</span><span class="p">;</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">hash</span><span class="p">,</span><span class="w"> </span><span class="n">key_size</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* è®¡ç®—å“ˆå¸Œå€¼ */</span>
<span class="w">    </span><span class="n">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">htab_map_hash</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">key_size</span><span class="p">,</span><span class="w"> </span><span class="n">htab</span><span class="o">-&gt;</span><span class="n">hashrnd</span><span class="p">);</span>
<span class="w">    </span><span class="n">head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">select_bucket</span><span class="p">(</span><span class="n">htab</span><span class="p">,</span><span class="w"> </span><span class="n">hash</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* æŸ¥æ‰¾é“¾è¡¨ */</span>
<span class="w">    </span><span class="n">hlist_nulls_for_each_entry_rcu</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">head</span><span class="p">,</span><span class="w"> </span><span class="n">hash_node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">hash</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">key_size</span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">l</span><span class="o">-&gt;</span><span class="n">key</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">round_up</span><span class="p">(</span><span class="n">key_size</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1543-bpftrace">15.4.3 bpftrace é«˜çº§è¿½è¸ª</h3>
<p>bpftrace æ˜¯ Brendan Gregg å’Œ Alastair Robertson å¼€å‘çš„é«˜çº§è¿½è¸ªè¯­è¨€ï¼Œæä¾›äº†ç±»ä¼¼ DTrace çš„ç®€æ´è¯­æ³•ã€‚</p>
<p><strong>è¯­è¨€ç‰¹æ€§</strong></p>
<div class="codehilite"><pre><span></span><code><span class="err">#!</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">env</span><span class="w"> </span><span class="n">bpftrace</span>

<span class="cm">/* è¿½è¸ªç³»ç»Ÿè°ƒç”¨å»¶è¿Ÿ */</span>
<span class="nl">tracepoint</span><span class="p">:</span><span class="nl">raw_syscalls</span><span class="p">:</span><span class="n">sys_enter</span>
<span class="err">{</span>
<span class="w">    </span><span class="nv">@start</span><span class="o">[</span><span class="n">tid</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nsecs</span><span class="p">;</span>
<span class="err">}</span>

<span class="nl">tracepoint</span><span class="p">:</span><span class="nl">raw_syscalls</span><span class="p">:</span><span class="n">sys_exit</span>
<span class="o">/</span><span class="nv">@start</span><span class="o">[</span><span class="n">tid</span><span class="o">]/</span>
<span class="err">{</span>
<span class="w">    </span><span class="nv">@ns</span><span class="o">[</span><span class="n">comm</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hist</span><span class="p">((</span><span class="n">nsecs</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">@start</span><span class="o">[</span><span class="n">tid</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span>
<span class="w">    </span><span class="k">delete</span><span class="p">(</span><span class="nv">@start</span><span class="o">[</span><span class="n">tid</span><span class="o">]</span><span class="p">);</span>
<span class="err">}</span>

<span class="cm">/* è¿½è¸ª TCP é‡ä¼  */</span>
<span class="nl">kprobe</span><span class="p">:</span><span class="n">tcp_retransmit_skb</span>
<span class="err">{</span>
<span class="w">    </span><span class="nv">@retrans</span><span class="o">[</span><span class="n">comm, pid</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">count</span><span class="p">();</span>
<span class="err">}</span>

<span class="cm">/* è¿½è¸ªå— I/O å»¶è¿Ÿ */</span>
<span class="nl">kprobe</span><span class="p">:</span><span class="n">blk_account_io_start</span>
<span class="err">{</span>
<span class="w">    </span><span class="nv">@iotime</span><span class="o">[</span><span class="n">arg0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nsecs</span><span class="p">;</span>
<span class="err">}</span>

<span class="nl">kprobe</span><span class="p">:</span><span class="n">blk_account_io_done</span>
<span class="o">/</span><span class="nv">@iotime</span><span class="o">[</span><span class="n">arg0</span><span class="o">]/</span>
<span class="err">{</span>
<span class="w">    </span><span class="nv">@usecs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hist</span><span class="p">((</span><span class="n">nsecs</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">@iotime</span><span class="o">[</span><span class="n">arg0</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span>
<span class="w">    </span><span class="k">delete</span><span class="p">(</span><span class="nv">@iotime</span><span class="o">[</span><span class="n">arg0</span><span class="o">]</span><span class="p">);</span>
<span class="err">}</span>

<span class="k">END</span>
<span class="err">{</span>
<span class="w">    </span><span class="n">clear</span><span class="p">(</span><span class="nv">@iotime</span><span class="p">);</span>
<span class="w">    </span><span class="n">clear</span><span class="p">(</span><span class="nv">@start</span><span class="p">);</span>
<span class="err">}</span>
</code></pre></div>

<p><strong>å†…éƒ¨å®ç°</strong></p>
<p>bpftrace å°†é«˜çº§è¯­è¨€ç¼–è¯‘æˆ eBPF å­—èŠ‚ç ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* AST åˆ° LLVM IR çš„è½¬æ¢ */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">CodegenLLVM::visit</span><span class="p">(</span><span class="n">Call</span><span class="w"> </span><span class="o">&amp;</span><span class="n">call</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">func</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;count&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ç”Ÿæˆè®¡æ•°å™¨æ›´æ–°ä»£ç </span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">map_lookup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b_</span><span class="p">.</span><span class="n">CreateCall</span><span class="p">(</span><span class="n">lookup_func</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                        </span><span class="p">{</span><span class="n">map_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">key_ptr</span><span class="p">});</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b_</span><span class="p">.</span><span class="n">CreateLoad</span><span class="p">(</span><span class="n">map_lookup</span><span class="p">);</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">incremented</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b_</span><span class="p">.</span><span class="n">CreateAdd</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                        </span><span class="n">b_</span><span class="p">.</span><span class="n">getInt64</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
<span class="w">        </span><span class="n">b_</span><span class="p">.</span><span class="n">CreateStore</span><span class="p">(</span><span class="n">incremented</span><span class="p">,</span><span class="w"> </span><span class="n">map_lookup</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">func</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;hist&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ç”Ÿæˆç›´æ–¹å›¾æ›´æ–°ä»£ç </span>
<span class="w">        </span><span class="n">generate_histogram_update</span><span class="p">(</span><span class="n">call</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1544">15.4.4 æ€§èƒ½ä¼˜åŒ–æ¡ˆä¾‹</h3>
<p><strong>æ¡ˆä¾‹1ï¼šè¿½è¸ªå†…å­˜åˆ†é…çƒ­ç‚¹</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* eBPF C ç¨‹åº */</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;uapi/linux/ptrace.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/mm.h&gt;</span>

<span class="n">BPF_HASH</span><span class="p">(</span><span class="n">allocs</span><span class="p">,</span><span class="w"> </span><span class="n">u64</span><span class="p">,</span><span class="w"> </span><span class="n">u64</span><span class="p">);</span>
<span class="n">BPF_STACK_TRACE</span><span class="p">(</span><span class="n">stack_traces</span><span class="p">,</span><span class="w"> </span><span class="mi">1024</span><span class="p">);</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">trace_kmalloc</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">pt_regs</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_get_current_pid_tgid</span><span class="p">();</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">stackid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_traces</span><span class="p">.</span><span class="n">get_stackid</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">alloc_info</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="n">info</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<span class="w">    </span><span class="n">info</span><span class="p">.</span><span class="n">stackid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stackid</span><span class="p">;</span>
<span class="w">    </span><span class="n">info</span><span class="p">.</span><span class="n">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_ktime_get_ns</span><span class="p">();</span>

<span class="w">    </span><span class="n">allocs</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>æ¡ˆä¾‹2ï¼šç½‘ç»œå»¶è¿Ÿåˆ†æ</strong></p>
<div class="codehilite"><pre><span></span><code><span class="err">#!</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">env</span><span class="w"> </span><span class="n">bpftrace</span>

<span class="cm">/* TCP è¿æ¥å»¶è¿Ÿåˆ†æ */</span>
<span class="nl">kprobe</span><span class="p">:</span><span class="n">tcp_v4_connect</span>
<span class="err">{</span>
<span class="w">    </span><span class="nv">@start</span><span class="o">[</span><span class="n">tid</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nsecs</span><span class="p">;</span>
<span class="w">    </span><span class="nv">@daddr</span><span class="o">[</span><span class="n">tid</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">struct</span><span class="w"> </span><span class="n">sockaddr_in</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">arg1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span>
<span class="err">}</span>

<span class="nl">kretprobe</span><span class="p">:</span><span class="n">tcp_v4_connect</span>
<span class="o">/</span><span class="nv">@start</span><span class="o">[</span><span class="n">tid</span><span class="o">]/</span>
<span class="err">{</span>
<span class="w">    </span><span class="err">$</span><span class="n">lat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">nsecs</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">@start</span><span class="o">[</span><span class="n">tid</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span>
<span class="w">    </span><span class="nv">@conn_lat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hist</span><span class="p">(</span><span class="err">$</span><span class="n">lat</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="err">$</span><span class="n">lat</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1000000</span><span class="p">)</span><span class="w"> </span><span class="err">{</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="n">ç§’</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="ss">&quot;Slow connection to %s: %d us\n&quot;</span><span class="p">,</span>
<span class="w">               </span><span class="n">ntop</span><span class="p">(</span><span class="nv">@daddr</span><span class="o">[</span><span class="n">tid</span><span class="o">]</span><span class="p">),</span><span class="w"> </span><span class="err">$</span><span class="n">lat</span><span class="p">);</span>
<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="k">delete</span><span class="p">(</span><span class="nv">@start</span><span class="o">[</span><span class="n">tid</span><span class="o">]</span><span class="p">);</span>
<span class="w">    </span><span class="k">delete</span><span class="p">(</span><span class="nv">@daddr</span><span class="o">[</span><span class="n">tid</span><span class="o">]</span><span class="p">);</span>
<span class="err">}</span>
</code></pre></div>

<p><strong>æ¡ˆä¾‹3ï¼šæ–‡ä»¶ç³»ç»Ÿæ€§èƒ½ç“¶é¢ˆ</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* è¿½è¸ª ext4 å†™å…¥å»¶è¿Ÿ */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">data_t</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">ts</span><span class="p">;</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">delta</span><span class="p">;</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">pid</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">comm</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">filename</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="p">};</span>

<span class="n">BPF_PERF_OUTPUT</span><span class="p">(</span><span class="n">events</span><span class="p">);</span>
<span class="n">BPF_HASH</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="p">);</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">trace_ext4_write_begin</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">pt_regs</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_get_current_pid_tgid</span><span class="p">();</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_ktime_get_ns</span><span class="p">();</span>
<span class="w">    </span><span class="n">start</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">trace_ext4_write_end</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">pt_regs</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_get_current_pid_tgid</span><span class="p">();</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="o">*</span><span class="n">tsp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start</span><span class="p">.</span><span class="n">lookup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pid</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">tsp</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">data_t</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="n">data</span><span class="p">.</span><span class="n">ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_ktime_get_ns</span><span class="p">();</span>
<span class="w">    </span><span class="n">data</span><span class="p">.</span><span class="n">delta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">ts</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">*</span><span class="n">tsp</span><span class="p">;</span>
<span class="w">    </span><span class="n">data</span><span class="p">.</span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pid</span><span class="p">;</span>
<span class="w">    </span><span class="n">bpf_get_current_comm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">.</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">comm</span><span class="p">));</span>

<span class="w">    </span><span class="n">events</span><span class="p">.</span><span class="n">perf_submit</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
<span class="w">    </span><span class="n">start</span><span class="p">.</span><span class="n">delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pid</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="155">15.5 å¯è§†åŒ–åˆ†æå·¥å…·</h3>
<ul>
<li>15.5.1 ç«ç„°å›¾ç”Ÿæˆä¸åˆ†æ</li>
<li>15.5.2 å»¶è¿Ÿçƒ­å›¾</li>
<li>15.5.3 è°ƒç”¨å›¾ä¸ä¾èµ–åˆ†æ</li>
<li>15.5.4 å®æ—¶æ€§èƒ½ç›‘æ§</li>
</ul>
<h3 id="_3">æœ¬ç« å°ç»“</h3>
<h3 id="_4">ç»ƒä¹ é¢˜</h3>
<h3 id="_5">å¸¸è§é™·é˜±ä¸é”™è¯¯</h3>
<h3 id="_6">æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•</h3>
<hr />
            </article>
            
            <nav class="page-nav"><a href="chapter14.html" class="nav-link prev">â† ç¬¬14ç« ï¼šå®æ—¶Linux</a><a href="chapter16.html" class="nav-link next">ç¬¬16ç« ï¼šå¼•å¯¼è¿‡ç¨‹ä¸åˆå§‹åŒ– â†’</a></nav>
        </main>
    </div>
</body>
</html>