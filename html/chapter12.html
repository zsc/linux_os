<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬12ç« ï¼šå®¹å™¨ä¸å‘½åç©ºé—´</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Linux å†…æ ¸æºä»£ç æ·±åº¦è§£æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬1ç« ï¼šLinux å†…æ ¸æ¦‚è¿°ä¸å‘å±•å²</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬2ç« ï¼šè¿›ç¨‹ç®¡ç†ä¸ä»»åŠ¡è°ƒåº¦</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬3ç« ï¼šå†…å­˜ç®¡ç†æ¶æ„</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬4ç« ï¼šè¿›ç¨‹é—´é€šä¿¡æœºåˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬5ç« ï¼šè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬6ç« ï¼šå…·ä½“æ–‡ä»¶ç³»ç»Ÿå®ç°</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬7ç« ï¼šå—è®¾å¤‡å±‚ä¸I/Oè°ƒåº¦</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬8ç« ï¼šè®¾å¤‡é©±åŠ¨æ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬9ç« ï¼šç½‘ç»œåè®®æ ˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬10ç« ï¼šå†…æ ¸åŒæ­¥æœºåˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬11ç« ï¼šå¹¶å‘ç¼–ç¨‹æ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬12ç« ï¼šå®¹å™¨ä¸å‘½åç©ºé—´</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬13ç« ï¼šå®‰å…¨å­ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬14ç« ï¼šå®æ—¶Linux</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬15ç« ï¼šæ€§èƒ½åˆ†æä¸è°ƒè¯•</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬16ç« ï¼šå¼•å¯¼è¿‡ç¨‹ä¸åˆå§‹åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="12">ç¬¬12ç« ï¼šå®¹å™¨ä¸å‘½åç©ºé—´</h1>
<h2 id="_1">æœ¬ç« æ¦‚è¦</h2>
<p>å®¹å™¨æŠ€æœ¯å·²æˆä¸ºç°ä»£äº‘åŸç”Ÿåº”ç”¨çš„åŸºçŸ³ï¼Œè€Œ Linux å†…æ ¸çš„å‘½åç©ºé—´ï¼ˆnamespaceï¼‰å’Œæ§åˆ¶ç»„ï¼ˆcgroupsï¼‰æœºåˆ¶æ˜¯å®¹å™¨å®ç°çš„æ ¸å¿ƒåŸºç¡€ã€‚æœ¬ç« æ·±å…¥å‰–æè¿™äº›å†…æ ¸æœºåˆ¶çš„å®ç°åŸç†ï¼Œä»æ—©æœŸçš„ chroot åˆ°ç°ä»£å®¹å™¨è¿è¡Œæ—¶ï¼Œæ¢ç´¢è¿›ç¨‹éš”ç¦»ã€èµ„æºé™åˆ¶å’Œå®‰å…¨è¾¹ç•Œçš„å†…æ ¸çº§å®ç°ã€‚é€šè¿‡å­¦ä¹ æœ¬ç« ï¼Œæ‚¨å°†ç†è§£å®¹å™¨"è½»é‡çº§è™šæ‹ŸåŒ–"èƒŒåçš„æŠ€æœ¯æœ¬è´¨ï¼ŒæŒæ¡æ„å»ºå®¹å™¨è¿è¡Œæ—¶æ‰€éœ€çš„å†…æ ¸æ¥å£ï¼Œä»¥åŠå¦‚ä½•åœ¨ä¿è¯éš”ç¦»æ€§çš„åŒæ—¶ä¼˜åŒ–æ€§èƒ½ã€‚</p>
<h2 id="121">12.1 å‘½åç©ºé—´çš„æ¼”è¿›ä¸è®¾è®¡å“²å­¦</h2>
<h3 id="1211-chroot-namespace">12.1.1 ä» chroot åˆ° namespace</h3>
<p>Linux å‘½åç©ºé—´çš„å†å²å¯ä»¥è¿½æº¯åˆ° 1979 å¹´çš„ chroot ç³»ç»Ÿè°ƒç”¨ã€‚chroot æ”¹å˜è¿›ç¨‹çš„æ ¹ç›®å½•è§†å›¾ï¼Œæ˜¯æœ€æ—©çš„è¿›ç¨‹éš”ç¦»æœºåˆ¶ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="err">ä¼ ç»Ÿ</span><span class="w"> </span><span class="n">Unix</span><span class="w"> </span><span class="err">è¿›ç¨‹è§†å›¾ï¼š</span>
<span class="w">    </span><span class="o">/</span>
<span class="w">    </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">bin</span><span class="o">/</span>
<span class="w">    </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">etc</span><span class="o">/</span>
<span class="w">    </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">home</span><span class="o">/</span>
<span class="w">    </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">usr</span><span class="o">/</span>

<span class="n">chroot</span><span class="w"> </span><span class="err">åçš„è¿›ç¨‹è§†å›¾ï¼š</span>
<span class="w">    </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="err">å®é™…ä¸Šæ˜¯</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">chroot</span><span class="p">)</span>
<span class="w">    </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">bin</span><span class="o">/</span>
<span class="w">    </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">etc</span><span class="o">/</span>
<span class="w">    </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">lib</span><span class="o">/</span>
</code></pre></div>

<p>ç„¶è€Œï¼Œchroot åªéš”ç¦»äº†æ–‡ä»¶ç³»ç»Ÿè§†å›¾ï¼Œè¿›ç¨‹ä»èƒ½çœ‹åˆ°ç³»ç»Ÿçš„å…¶ä»–èµ„æºã€‚2002 å¹´ï¼ŒEric W. Biederman æå‡ºäº†å‘½åç©ºé—´çš„æ¦‚å¿µï¼Œå°†éš”ç¦»æ‰©å±•åˆ°ç³»ç»Ÿçš„å„ä¸ªæ–¹é¢ã€‚å‘½åç©ºé—´çš„è®¾è®¡éµå¾ªå‡ ä¸ªå…³é”®åŸåˆ™ï¼š</p>
<ol>
<li><strong>é€æ˜æ€§</strong>ï¼šå‘½åç©ºé—´å†…çš„è¿›ç¨‹æ— éœ€ä¿®æ”¹å³å¯è¿è¡Œ</li>
<li><strong>é€’å½’æ€§</strong>ï¼šå‘½åç©ºé—´å¯ä»¥åµŒå¥—ï¼Œå½¢æˆå±‚æ¬¡ç»“æ„</li>
<li><strong>ç‹¬ç«‹æ€§</strong>ï¼šå„ç±»å‘½åç©ºé—´å¯ä»¥ç‹¬ç«‹ä½¿ç”¨å’Œç»„åˆ</li>
<li><strong>å…¼å®¹æ€§</strong>ï¼šä¿æŒ POSIX è¯­ä¹‰å’Œå‘åå…¼å®¹</li>
</ol>
<h3 id="1212">12.1.2 å‘½åç©ºé—´çš„ç±»å‹ä¸ç”¨é€”</h3>
<p>Linux å†…æ ¸ç›®å‰æ”¯æŒ 8 ç§å‘½åç©ºé—´ï¼Œæ¯ç§è´Ÿè´£éš”ç¦»ç‰¹å®šçš„ç³»ç»Ÿèµ„æºï¼š</p>
<p>| å‘½åç©ºé—´ | éš”ç¦»å†…å®¹ | å¼•å…¥ç‰ˆæœ¬ | ä¸»è¦ç”¨é€” |</p>
<table>
<thead>
<tr>
<th>å‘½åç©ºé—´</th>
<th>éš”ç¦»å†…å®¹</th>
<th>å¼•å…¥ç‰ˆæœ¬</th>
<th>ä¸»è¦ç”¨é€”</th>
</tr>
</thead>
<tbody>
<tr>
<td>Mount (mnt)</td>
<td>æŒ‚è½½ç‚¹</td>
<td>2.4.19</td>
<td>æ–‡ä»¶ç³»ç»Ÿè§†å›¾éš”ç¦»</td>
</tr>
<tr>
<td>UTS</td>
<td>ä¸»æœºåå’ŒåŸŸå</td>
<td>2.6.19</td>
<td>ä¸»æœºæ ‡è¯†éš”ç¦»</td>
</tr>
<tr>
<td>IPC</td>
<td>System V IPC, POSIX æ¶ˆæ¯é˜Ÿåˆ—</td>
<td>2.6.19</td>
<td>è¿›ç¨‹é—´é€šä¿¡éš”ç¦»</td>
</tr>
<tr>
<td>PID</td>
<td>è¿›ç¨‹ ID</td>
<td>2.6.24</td>
<td>è¿›ç¨‹æ ‘éš”ç¦»</td>
</tr>
<tr>
<td>Network (net)</td>
<td>ç½‘ç»œè®¾å¤‡ã€åè®®æ ˆã€ç«¯å£</td>
<td>2.6.29</td>
<td>ç½‘ç»œæ ˆéš”ç¦»</td>
</tr>
<tr>
<td>User</td>
<td>ç”¨æˆ·å’Œç»„ ID</td>
<td>3.8</td>
<td>ç”¨æˆ·æƒé™éš”ç¦»</td>
</tr>
<tr>
<td>Cgroup</td>
<td>Cgroup æ ¹ç›®å½•</td>
<td>4.6</td>
<td>èµ„æºé™åˆ¶è§†å›¾éš”ç¦»</td>
</tr>
<tr>
<td>Time</td>
<td>ç³»ç»Ÿæ—¶é—´</td>
<td>5.6</td>
<td>æ—¶é—´è§†å›¾éš”ç¦»</td>
</tr>
</tbody>
</table>
<h3 id="1213">12.1.3 å‘½åç©ºé—´çš„å†…æ ¸æ•°æ®ç»“æ„</h3>
<p>å‘½åç©ºé—´åœ¨å†…æ ¸ä¸­é€šè¿‡ <code>struct nsproxy</code> ç»“æ„ç®¡ç†ï¼Œæ¯ä¸ªè¿›ç¨‹çš„ <code>task_struct</code> åŒ…å«ä¸€ä¸ªæŒ‡å‘ nsproxy çš„æŒ‡é’ˆï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// include/linux/nsproxy.h</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">nsproxy</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="w">                    </span><span class="c1">// å¼•ç”¨è®¡æ•°</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">uts_namespace</span><span class="w"> </span><span class="o">*</span><span class="n">uts_ns</span><span class="p">;</span><span class="w">     </span><span class="c1">// UTS å‘½åç©ºé—´</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ipc_namespace</span><span class="w"> </span><span class="o">*</span><span class="n">ipc_ns</span><span class="p">;</span><span class="w">     </span><span class="c1">// IPC å‘½åç©ºé—´</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mnt_namespace</span><span class="w"> </span><span class="o">*</span><span class="n">mnt_ns</span><span class="p">;</span><span class="w">     </span><span class="c1">// Mount å‘½åç©ºé—´</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pid_namespace</span><span class="w"> </span><span class="o">*</span><span class="n">pid_ns_for_children</span><span class="p">;</span><span class="w"> </span><span class="c1">// PID å‘½åç©ºé—´</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">net</span><span class="w"> </span><span class="o">*</span><span class="n">net_ns</span><span class="p">;</span><span class="w">                </span><span class="c1">// Network å‘½åç©ºé—´</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">time_namespace</span><span class="w"> </span><span class="o">*</span><span class="n">time_ns</span><span class="p">;</span><span class="w">    </span><span class="c1">// Time å‘½åç©ºé—´</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">time_namespace</span><span class="w"> </span><span class="o">*</span><span class="n">time_ns_for_children</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">cgroup_namespace</span><span class="w"> </span><span class="o">*</span><span class="n">cgroup_ns</span><span class="p">;</span><span class="w"> </span><span class="c1">// Cgroup å‘½åç©ºé—´</span>
<span class="p">};</span>

<span class="c1">// include/linux/sched.h</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ... å…¶ä»–å­—æ®µ</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">nsproxy</span><span class="w"> </span><span class="o">*</span><span class="n">nsproxy</span><span class="p">;</span><span class="w">  </span><span class="c1">// å‘½åç©ºé—´ä»£ç†</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">};</span>
</code></pre></div>

<p>å‘½åç©ºé—´çš„åˆ›å»ºå’Œåˆ‡æ¢é€šè¿‡ cloneã€unshare å’Œ setns ç³»ç»Ÿè°ƒç”¨å®ç°ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// åˆ›å»ºæ–°å‘½åç©ºé—´çš„æ ‡å¿—ä½</span>
<span class="cp">#define CLONE_NEWNS     0x00020000  </span><span class="c1">// Mount namespace</span>
<span class="cp">#define CLONE_NEWUTS    0x04000000  </span><span class="c1">// UTS namespace</span>
<span class="cp">#define CLONE_NEWIPC    0x08000000  </span><span class="c1">// IPC namespace</span>
<span class="cp">#define CLONE_NEWPID    0x20000000  </span><span class="c1">// PID namespace</span>
<span class="cp">#define CLONE_NEWNET    0x40000000  </span><span class="c1">// Network namespace</span>
<span class="cp">#define CLONE_NEWUSER   0x10000000  </span><span class="c1">// User namespace</span>
<span class="cp">#define CLONE_NEWCGROUP 0x02000000  </span><span class="c1">// Cgroup namespace</span>
<span class="cp">#define CLONE_NEWTIME   0x00000080  </span><span class="c1">// Time namespace</span>
</code></pre></div>

<h2 id="122">12.2 æ ¸å¿ƒå‘½åç©ºé—´å®ç°è¯¦è§£</h2>
<h3 id="1221-pid">12.2.1 PID å‘½åç©ºé—´</h3>
<p>PID å‘½åç©ºé—´æ˜¯å®¹å™¨å®ç°çš„æ ¸å¿ƒï¼Œå®ƒä¸ºè¿›ç¨‹æä¾›ç‹¬ç«‹çš„è¿›ç¨‹ ID ç©ºé—´ã€‚åœ¨ PID å‘½åç©ºé—´å†…ï¼Œè¿›ç¨‹å¯ä»¥æ‹¥æœ‰ä¸å¤–éƒ¨ç›¸åŒçš„ PIDï¼Œå®ç°è¿›ç¨‹æ ‘çš„å®Œå…¨éš”ç¦»ã€‚</p>
<div class="codehilite"><pre><span></span><code>ä¸»æœºè§†è§’ï¼š
<span class="w">    </span><span class="nf">systemd </span><span class="p">(</span><span class="n">PID</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">    </span>â”œâ”€â”€<span class="w"> </span><span class="nf">sshd </span><span class="p">(</span><span class="n">PID</span><span class="w"> </span><span class="m">1234</span><span class="p">)</span>
<span class="w">    </span>â”œâ”€â”€<span class="w"> </span><span class="n">container</span><span class="o">-</span><span class="nf">runtime </span><span class="p">(</span><span class="n">PID</span><span class="w"> </span><span class="m">5678</span><span class="p">)</span>
<span class="w">    </span>â”‚<span class="w">   </span>â””â”€â”€<span class="w"> </span><span class="n">container</span><span class="o">-</span><span class="nf">init </span><span class="p">(</span><span class="n">PID</span><span class="w"> </span><span class="m">5679</span><span class="p">)</span><span class="w">  </span><span class="o">&lt;-</span><span class="w"> </span>å®¹å™¨å†…çš„<span class="w"> </span><span class="n">PID</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span>â”‚<span class="w">       </span>â”œâ”€â”€<span class="w"> </span><span class="nf">app </span><span class="p">(</span><span class="n">PID</span><span class="w"> </span><span class="m">5680</span><span class="p">)</span><span class="w">         </span><span class="o">&lt;-</span><span class="w"> </span>å®¹å™¨å†…çš„<span class="w"> </span><span class="n">PID</span><span class="w"> </span><span class="m">2</span>
<span class="w">    </span>â”‚<span class="w">       </span>â””â”€â”€<span class="w"> </span><span class="nf">worker </span><span class="p">(</span><span class="n">PID</span><span class="w"> </span><span class="m">5681</span><span class="p">)</span><span class="w">      </span><span class="o">&lt;-</span><span class="w"> </span>å®¹å™¨å†…çš„<span class="w"> </span><span class="n">PID</span><span class="w"> </span><span class="m">3</span>

å®¹å™¨å†…è§†è§’ï¼š
<span class="w">    </span><span class="nf">init </span><span class="p">(</span><span class="n">PID</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">    </span>â”œâ”€â”€<span class="w"> </span><span class="nf">app </span><span class="p">(</span><span class="n">PID</span><span class="w"> </span><span class="m">2</span><span class="p">)</span>
<span class="w">    </span>â””â”€â”€<span class="w"> </span><span class="nf">worker </span><span class="p">(</span><span class="n">PID</span><span class="w"> </span><span class="m">3</span><span class="p">)</span>
</code></pre></div>

<p>PID å‘½åç©ºé—´çš„å…³é”®å®ç°ç»†èŠ‚ï¼š</p>
<ol>
<li><strong>å±‚æ¬¡ç»“æ„</strong>ï¼šPID å‘½åç©ºé—´å½¢æˆæ ‘çŠ¶å±‚æ¬¡ï¼Œå­å‘½åç©ºé—´ä¸­çš„è¿›ç¨‹åœ¨çˆ¶å‘½åç©ºé—´ä¸­å¯è§</li>
<li><strong>PID æ˜ å°„</strong>ï¼šæ¯ä¸ªè¿›ç¨‹åœ¨å…¶æ‰€åœ¨çš„å‘½åç©ºé—´åŠæ‰€æœ‰ç¥–å…ˆå‘½åç©ºé—´ä¸­éƒ½æœ‰ PID</li>
<li><strong>init è¿›ç¨‹</strong>ï¼šæ¯ä¸ª PID å‘½åç©ºé—´éƒ½æœ‰è‡ªå·±çš„ init è¿›ç¨‹ï¼ˆPID 1ï¼‰ï¼Œè´Ÿè´£å›æ”¶å­¤å„¿è¿›ç¨‹</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// kernel/pid.c - PID åˆ†é…çš„æ ¸å¿ƒç»“æ„</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">pid</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">level</span><span class="p">;</span><span class="w">           </span><span class="c1">// PID å‘½åç©ºé—´çš„å±‚çº§</span>
<span class="w">    </span><span class="cm">/* æ¯ä¸ªå‘½åç©ºé—´å±‚çº§çš„ PID å· */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">upid</span><span class="w"> </span><span class="n">numbers</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">upid</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nr</span><span class="p">;</span><span class="w">                       </span><span class="c1">// åœ¨è¯¥å‘½åç©ºé—´ä¸­çš„ PID</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pid_namespace</span><span class="w"> </span><span class="o">*</span><span class="n">ns</span><span class="p">;</span><span class="w">    </span><span class="c1">// æ‰€å±çš„å‘½åç©ºé—´</span>
<span class="p">};</span>

<span class="c1">// PID å‘½åç©ºé—´ç»“æ„</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">pid_namespace</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kref</span><span class="w"> </span><span class="n">kref</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pidmap</span><span class="w"> </span><span class="n">pidmap</span><span class="p">[</span><span class="n">PIDMAP_ENTRIES</span><span class="p">];</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">child_reaper</span><span class="p">;</span><span class="w">  </span><span class="c1">// init è¿›ç¨‹</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">level</span><span class="p">;</span><span class="w">                </span><span class="c1">// å±‚çº§æ·±åº¦</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pid_namespace</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">;</span><span class="w">      </span><span class="c1">// çˆ¶å‘½åç©ºé—´</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="1222-network">12.2.2 Network å‘½åç©ºé—´</h3>
<p>ç½‘ç»œå‘½åç©ºé—´æä¾›å®Œå…¨ç‹¬ç«‹çš„ç½‘ç»œæ ˆï¼ŒåŒ…æ‹¬ç½‘ç»œè®¾å¤‡ã€IP åœ°å€ã€è·¯ç”±è¡¨ã€é˜²ç«å¢™è§„åˆ™ç­‰ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// include/net/net_namespace.h</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">net</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="w">               </span><span class="c1">// å¼•ç”¨è®¡æ•°</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">list</span><span class="p">;</span><span class="w">        </span><span class="c1">// å‘½åç©ºé—´é“¾è¡¨</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">net_device</span><span class="w"> </span><span class="o">*</span><span class="n">loopback_dev</span><span class="p">;</span><span class="w">  </span><span class="c1">// ç¯å›è®¾å¤‡</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">dev_base_head</span><span class="p">;</span><span class="w">   </span><span class="c1">// ç½‘ç»œè®¾å¤‡é“¾è¡¨</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sock</span><span class="w"> </span><span class="o">*</span><span class="n">rtnl</span><span class="p">;</span><span class="w">            </span><span class="c1">// rtnetlink å¥—æ¥å­—</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sock</span><span class="w"> </span><span class="o">*</span><span class="n">genl_sock</span><span class="p">;</span><span class="w">       </span><span class="c1">// generic netlink</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">netns_ipv4</span><span class="w"> </span><span class="n">ipv4</span><span class="p">;</span><span class="w">      </span><span class="c1">// IPv4 ç›¸å…³</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">netns_ipv6</span><span class="w"> </span><span class="n">ipv6</span><span class="p">;</span><span class="w">      </span><span class="c1">// IPv6 ç›¸å…³</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">netns_packet</span><span class="w"> </span><span class="n">packet</span><span class="p">;</span><span class="w">   </span><span class="c1">// packet å¥—æ¥å­—</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">netns_unix</span><span class="w"> </span><span class="n">unx</span><span class="p">;</span><span class="w">        </span><span class="c1">// Unix åŸŸå¥—æ¥å­—</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">net_generic</span><span class="w"> </span><span class="o">*</span><span class="n">gen</span><span class="p">;</span><span class="w">      </span><span class="c1">// é€šç”¨å­˜å‚¨</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">};</span>
</code></pre></div>

<p>ç½‘ç»œå‘½åç©ºé—´çš„å…¸å‹ä½¿ç”¨æ¨¡å¼ï¼š</p>
<div class="codehilite"><pre><span></span><code>ä¸»æœºç½‘ç»œå‘½åç©ºé—´
    eth0 (10.0.0.1)
    docker0 (172.17.0.1) â”€â”€â”
                           â”‚
                      veth pair
                           â”‚
å®¹å™¨ç½‘ç»œå‘½åç©ºé—´          â”‚
    eth0 (172.17.0.2) â”€â”€â”€â”€â”˜
    lo (127.0.0.1)
</code></pre></div>

<h3 id="1223-mount">12.2.3 Mount å‘½åç©ºé—´</h3>
<p>Mount å‘½åç©ºé—´éš”ç¦»æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ç‚¹ï¼Œä½¿æ¯ä¸ªå®¹å™¨æ‹¥æœ‰ç‹¬ç«‹çš„æ–‡ä»¶ç³»ç»Ÿè§†å›¾ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// fs/mount.h</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">mnt_namespace</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mount</span><span class="w"> </span><span class="o">*</span><span class="n">root</span><span class="p">;</span><span class="w">           </span><span class="c1">// æ ¹æŒ‚è½½ç‚¹</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">list</span><span class="p">;</span><span class="w">        </span><span class="c1">// æŒ‚è½½ç‚¹é“¾è¡¨</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">user_namespace</span><span class="w"> </span><span class="o">*</span><span class="n">user_ns</span><span class="p">;</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">seq</span><span class="p">;</span><span class="w">                      </span><span class="c1">// åºåˆ—å·</span>
<span class="w">    </span><span class="n">wait_queue_head_t</span><span class="w"> </span><span class="n">poll</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">event</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">mount</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_node</span><span class="w"> </span><span class="n">mnt_hash</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mount</span><span class="w"> </span><span class="o">*</span><span class="n">mnt_parent</span><span class="p">;</span><span class="w">     </span><span class="c1">// çˆ¶æŒ‚è½½ç‚¹</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="n">mnt_mountpoint</span><span class="p">;</span><span class="w"> </span><span class="c1">// æŒ‚è½½ä½ç½®</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vfsmount</span><span class="w"> </span><span class="n">mnt</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">};</span>
</code></pre></div>

<p>æŒ‚è½½ä¼ æ’­æœºåˆ¶ï¼š</p>
<ul>
<li><strong>private</strong>ï¼šæŒ‚è½½äº‹ä»¶ä¸ä¼ æ’­</li>
<li><strong>shared</strong>ï¼šæŒ‚è½½äº‹ä»¶åŒå‘ä¼ æ’­</li>
<li><strong>slave</strong>ï¼šå•å‘æ¥æ”¶ä¼ æ’­</li>
<li><strong>unbindable</strong>ï¼šä¸å¯ç»‘å®šæŒ‚è½½</li>
</ul>
<h3 id="1224-user">12.2.4 User å‘½åç©ºé—´</h3>
<p>User å‘½åç©ºé—´æ˜¯å®‰å…¨å®¹å™¨çš„å…³é”®ï¼Œå®ƒå…è®¸å°†å®¹å™¨å†…çš„ root ç”¨æˆ·æ˜ å°„ä¸ºä¸»æœºä¸Šçš„æ™®é€šç”¨æˆ·ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// kernel/user_namespace.c</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">user_namespace</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">uid_gid_map</span><span class="w"> </span><span class="n">uid_map</span><span class="p">;</span><span class="w">   </span><span class="c1">// UID æ˜ å°„</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">uid_gid_map</span><span class="w"> </span><span class="n">gid_map</span><span class="p">;</span><span class="w">   </span><span class="c1">// GID æ˜ å°„</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">uid_gid_map</span><span class="w"> </span><span class="n">projid_map</span><span class="p">;</span><span class="w"> </span><span class="c1">// é¡¹ç›® ID æ˜ å°„</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">user_namespace</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">;</span>
<span class="w">    </span><span class="n">kuid_t</span><span class="w"> </span><span class="n">owner</span><span class="p">;</span><span class="w">                  </span><span class="c1">// åˆ›å»ºè€…çš„ UID</span>
<span class="w">    </span><span class="n">kgid_t</span><span class="w"> </span><span class="n">group</span><span class="p">;</span><span class="w">                  </span><span class="c1">// åˆ›å»ºè€…çš„ GID</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">proc_inum</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">};</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">uid_gid_extent</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">first</span><span class="p">;</span><span class="w">      </span><span class="c1">// æ˜ å°„çš„èµ·å§‹ ID</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">lower_first</span><span class="p">;</span><span class="w"> </span><span class="c1">// çˆ¶å‘½åç©ºé—´ä¸­çš„èµ·å§‹ ID</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="w">      </span><span class="c1">// æ˜ å°„æ•°é‡</span>
<span class="p">};</span>
</code></pre></div>

<p>UID/GID æ˜ å°„ç¤ºä¾‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="err">å®¹å™¨å†…</span><span class="w"> </span><span class="n">UID</span><span class="w">    </span><span class="err">ä¸»æœº</span><span class="w"> </span><span class="n">UID</span>
<span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="n">root</span><span class="p">)</span><span class="w">  </span><span class="o">-&gt;</span><span class="w">  </span><span class="mi">100000</span>
<span class="mi">1</span><span class="w">         </span><span class="o">-&gt;</span><span class="w">  </span><span class="mi">100001</span>
<span class="mi">999</span><span class="w">       </span><span class="o">-&gt;</span><span class="w">  </span><span class="mi">100999</span>
</code></pre></div>

<h2 id="123-cgroups">12.3 Cgroupsï¼šèµ„æºæ§åˆ¶ä¸é™åˆ¶</h2>
<h3 id="1231-cgroups-v1">12.3.1 Cgroups v1 æ¶æ„</h3>
<p>Cgroupsï¼ˆControl Groupsï¼‰æä¾›äº†å¯¹è¿›ç¨‹ç»„çš„èµ„æºä½¿ç”¨è¿›è¡Œé™åˆ¶ã€ç»Ÿè®¡å’Œéš”ç¦»çš„æœºåˆ¶ã€‚v1 é‡‡ç”¨å¤šå±‚æ¬¡çš„ç›®å½•ç»“æ„ï¼Œæ¯ä¸ªå­ç³»ç»Ÿç‹¬ç«‹æŒ‚è½½ï¼š</p>
<div class="codehilite"><pre><span></span><code>/sys/fs/cgroup/
â”œâ”€â”€ cpu/           # CPU ä½¿ç”¨é™åˆ¶
â”‚   â”œâ”€â”€ docker/
â”‚   â”‚   â””â”€â”€ &lt;container-id&gt;/
â”‚   â”‚       â”œâ”€â”€ cpu.shares
â”‚   â”‚       â””â”€â”€ cpu.cfs_quota_us
â”œâ”€â”€ memory/        # å†…å­˜é™åˆ¶
â”‚   â”œâ”€â”€ docker/
â”‚   â”‚   â””â”€â”€ &lt;container-id&gt;/
â”‚   â”‚       â”œâ”€â”€ memory.limit_in_bytes
â”‚   â”‚       â””â”€â”€ memory.usage_in_bytes
â””â”€â”€ blkio/         # å—è®¾å¤‡ I/O é™åˆ¶
</code></pre></div>

<p>æ ¸å¿ƒå­ç³»ç»ŸåŠŸèƒ½ï¼š</p>
<p>| å­ç³»ç»Ÿ | åŠŸèƒ½ | å…³é”®å‚æ•° |</p>
<table>
<thead>
<tr>
<th>å­ç³»ç»Ÿ</th>
<th>åŠŸèƒ½</th>
<th>å…³é”®å‚æ•°</th>
</tr>
</thead>
<tbody>
<tr>
<td>cpu</td>
<td>CPU æ—¶é—´åˆ†é…</td>
<td>cpu.shares, cpu.cfs_period_us, cpu.cfs_quota_us</td>
</tr>
<tr>
<td>cpuset</td>
<td>CPU å’Œå†…å­˜èŠ‚ç‚¹ç»‘å®š</td>
<td>cpuset.cpus, cpuset.mems</td>
</tr>
<tr>
<td>memory</td>
<td>å†…å­˜ä½¿ç”¨é™åˆ¶</td>
<td>memory.limit_in_bytes, memory.soft_limit_in_bytes</td>
</tr>
<tr>
<td>blkio</td>
<td>å—è®¾å¤‡ I/O æ§åˆ¶</td>
<td>blkio.weight, blkio.throttle.read_bps_device</td>
</tr>
<tr>
<td>devices</td>
<td>è®¾å¤‡è®¿é—®æ§åˆ¶</td>
<td>devices.allow, devices.deny</td>
</tr>
<tr>
<td>freezer</td>
<td>æš‚åœ/æ¢å¤è¿›ç¨‹ç»„</td>
<td>freezer.state</td>
</tr>
<tr>
<td>net_cls</td>
<td>ç½‘ç»œåˆ†ç±»æ ‡è®°</td>
<td>net_cls.classid</td>
</tr>
<tr>
<td>pids</td>
<td>è¿›ç¨‹æ•°é‡é™åˆ¶</td>
<td>pids.max</td>
</tr>
</tbody>
</table>
<h3 id="1232-cgroups-v2">12.3.2 Cgroups v2 ç»Ÿä¸€å±‚æ¬¡</h3>
<p>Cgroups v2 é‡‡ç”¨ç»Ÿä¸€çš„å±‚æ¬¡ç»“æ„ï¼Œè§£å†³äº† v1 çš„è®¾è®¡ç¼ºé™·ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// kernel/cgroup/cgroup.c</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">cgroup</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">cgroup_subsys_state</span><span class="w"> </span><span class="n">self</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">level</span><span class="p">;</span><span class="w">                    </span><span class="c1">// å±‚çº§æ·±åº¦</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">cgroup</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">;</span><span class="w">        </span><span class="c1">// çˆ¶ cgroup</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kernfs_node</span><span class="w"> </span><span class="o">*</span><span class="n">kn</span><span class="p">;</span><span class="w">       </span><span class="c1">// kernfs èŠ‚ç‚¹</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">cgroup_file</span><span class="w"> </span><span class="n">procs_file</span><span class="p">;</span><span class="w"> </span><span class="c1">// cgroup.procs æ–‡ä»¶</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">cgroup_file</span><span class="w"> </span><span class="n">events_file</span><span class="p">;</span><span class="w"> </span><span class="c1">// cgroup.events æ–‡ä»¶</span>

<span class="w">    </span><span class="n">u16</span><span class="w"> </span><span class="n">subtree_control</span><span class="p">;</span><span class="w">          </span><span class="c1">// å­æ ‘æ§åˆ¶æ©ç </span>
<span class="w">    </span><span class="n">u16</span><span class="w"> </span><span class="n">subtree_ss_mask</span><span class="p">;</span><span class="w">          </span><span class="c1">// å­æ ‘å­ç³»ç»Ÿæ©ç </span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">pidlists</span><span class="p">;</span><span class="w">    </span><span class="c1">// PID åˆ—è¡¨</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">cgroup_rstat_cpu</span><span class="w"> </span><span class="n">__percpu</span><span class="w"> </span><span class="o">*</span><span class="n">rstat_cpu</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">};</span>
</code></pre></div>

<p>v2 çš„æ”¹è¿›ç‰¹æ€§ï¼š</p>
<ol>
<li><strong>ç»Ÿä¸€å±‚æ¬¡</strong>ï¼šæ‰€æœ‰æ§åˆ¶å™¨å…±äº«åŒä¸€å±‚æ¬¡ç»“æ„</li>
<li><strong>æ›´å¥½çš„èµ„æºæ¨¡å‹</strong>ï¼šåŸºäºæƒé‡çš„èµ„æºåˆ†é…</li>
<li><strong>å‹åŠ›æŒ‡æ ‡ï¼ˆPSIï¼‰</strong>ï¼šmemory.pressure, cpu.pressure, io.pressure</li>
<li><strong>eBPF é›†æˆ</strong>ï¼šæ”¯æŒ BPF ç¨‹åºè¿›è¡Œç»†ç²’åº¦æ§åˆ¶</li>
</ol>
<div class="codehilite"><pre><span></span><code>/sys/fs/cgroup/unified/
â”œâ”€â”€ cgroup.controllers      # å¯ç”¨æ§åˆ¶å™¨
â”œâ”€â”€ cgroup.subtree_control  # å­æ ‘å¯ç”¨çš„æ§åˆ¶å™¨
â”œâ”€â”€ user.slice/
â”‚   â””â”€â”€ user-1000.slice/
â”‚       â”œâ”€â”€ memory.max
â”‚       â”œâ”€â”€ memory.current
â”‚       â”œâ”€â”€ cpu.max
â”‚       â””â”€â”€ io.max
â””â”€â”€ system.slice/
    â””â”€â”€ docker.service/
</code></pre></div>

<h3 id="1233">12.3.3 èµ„æºé™åˆ¶çš„å†…æ ¸å®ç°</h3>
<p>å†…å­˜é™åˆ¶å®ç°ï¼ˆä»¥ memory cgroup ä¸ºä¾‹ï¼‰ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// mm/memcontrol.c</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">mem_cgroup</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">cgroup_subsys_state</span><span class="w"> </span><span class="n">css</span><span class="p">;</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mem_cgroup_id</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* å†…å­˜è®¡æ•°å™¨ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">page_counter</span><span class="w"> </span><span class="n">memory</span><span class="p">;</span><span class="w">    </span><span class="c1">// å†…å­˜ä½¿ç”¨</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">page_counter</span><span class="w"> </span><span class="n">swap</span><span class="p">;</span><span class="w">      </span><span class="c1">// äº¤æ¢ä½¿ç”¨</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">page_counter</span><span class="w"> </span><span class="n">memsw</span><span class="p">;</span><span class="w">     </span><span class="c1">// å†…å­˜+äº¤æ¢</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">page_counter</span><span class="w"> </span><span class="n">kmem</span><span class="p">;</span><span class="w">      </span><span class="c1">// å†…æ ¸å†…å­˜</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">page_counter</span><span class="w"> </span><span class="n">tcpmem</span><span class="p">;</span><span class="w">    </span><span class="c1">// TCP ç¼“å†²åŒº</span>

<span class="w">    </span><span class="cm">/* è½¯é™åˆ¶ */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">soft_limit</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* ç»Ÿè®¡ä¿¡æ¯ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mem_cgroup_stat_cpu</span><span class="w"> </span><span class="n">__percpu</span><span class="w"> </span><span class="o">*</span><span class="n">stat_cpu</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* OOM æ§åˆ¶ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mem_cgroup_oom_info</span><span class="w"> </span><span class="n">oom_info</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">oom_kill_disable</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* å†…å­˜å›æ”¶ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">work_struct</span><span class="w"> </span><span class="n">high_work</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">memory_pressure</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">};</span>
</code></pre></div>

<p>CPU é™åˆ¶å®ç°ï¼ˆCFS å¸¦å®½æ§åˆ¶ï¼‰ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// kernel/sched/fair.c</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">cfs_bandwidth</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">raw_spinlock_t</span><span class="w"> </span><span class="n">lock</span><span class="p">;</span>
<span class="w">    </span><span class="n">ktime_t</span><span class="w"> </span><span class="n">period</span><span class="p">;</span><span class="w">               </span><span class="c1">// å‘¨æœŸï¼ˆé»˜è®¤ 100msï¼‰</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">quota</span><span class="p">;</span><span class="w">                    </span><span class="c1">// é…é¢</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">runtime</span><span class="p">;</span><span class="w">                  </span><span class="c1">// å‰©ä½™è¿è¡Œæ—¶é—´</span>
<span class="w">    </span><span class="n">s64</span><span class="w"> </span><span class="n">hierarchical_quota</span><span class="p">;</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hrtimer</span><span class="w"> </span><span class="n">period_timer</span><span class="p">;</span><span class="w">  </span><span class="c1">// å‘¨æœŸå®šæ—¶å™¨</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hrtimer</span><span class="w"> </span><span class="n">slack_timer</span><span class="p">;</span><span class="w">   </span><span class="c1">// æ¾å¼›å®šæ—¶å™¨</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">throttled_cfs_rq</span><span class="p">;</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nr_periods</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nr_throttled</span><span class="p">;</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">throttled_time</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>

<h2 id="124">12.4 å®¹å™¨è¿è¡Œæ—¶åŸç†</h2>
<h3 id="1241">12.4.1 å®¹å™¨åˆ›å»ºçš„ç³»ç»Ÿè°ƒç”¨åºåˆ—</h3>
<p>å®¹å™¨çš„åˆ›å»ºæ¶‰åŠä¸€ç³»åˆ—ç²¾å¿ƒç¼–æ’çš„ç³»ç»Ÿè°ƒç”¨ï¼Œä»è¿›ç¨‹å…‹éš†åˆ°èµ„æºé™åˆ¶è®¾ç½®ã€‚ä»¥ä¸‹æ˜¯å…¸å‹çš„å®¹å™¨å¯åŠ¨æµç¨‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ç®€åŒ–çš„å®¹å™¨åˆ›å»ºæµç¨‹</span>
<span class="kt">pid_t</span><span class="w"> </span><span class="nf">create_container</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 1. åˆ›å»ºæ–°çš„å‘½åç©ºé—´</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CLONE_NEWNS</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">CLONE_NEWPID</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">CLONE_NEWNET</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>
<span class="w">                </span><span class="n">CLONE_NEWIPC</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">CLONE_NEWUTS</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">CLONE_NEWUSER</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 2. å…‹éš†è¿›ç¨‹å¹¶åˆ›å»ºå‘½åç©ºé—´</span>
<span class="w">    </span><span class="kt">pid_t</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clone</span><span class="p">(</span><span class="n">container_init</span><span class="p">,</span><span class="w"> </span><span class="n">stack_top</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">SIGCHLD</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// çˆ¶è¿›ç¨‹</span>
<span class="w">        </span><span class="c1">// 3. é…ç½® user namespace æ˜ å°„</span>
<span class="w">        </span><span class="n">write_uid_map</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>
<span class="w">        </span><span class="n">write_gid_map</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 4. è®¾ç½® cgroups</span>
<span class="w">        </span><span class="n">setup_cgroups</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 5. é…ç½®ç½‘ç»œ</span>
<span class="w">        </span><span class="n">setup_network</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">pid</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">container_init</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// å®¹å™¨å†…çš„ init è¿›ç¨‹</span>
<span class="w">    </span><span class="c1">// 1. è®¾ç½®ä¸»æœºå</span>
<span class="w">    </span><span class="n">sethostname</span><span class="p">(</span><span class="s">&quot;container&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 2. æŒ‚è½½å¿…è¦çš„æ–‡ä»¶ç³»ç»Ÿ</span>
<span class="w">    </span><span class="n">mount</span><span class="p">(</span><span class="s">&quot;proc&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/proc&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;proc&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">mount</span><span class="p">(</span><span class="s">&quot;sys&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/sys&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sysfs&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 3. pivot_root åˆ‡æ¢æ ¹æ–‡ä»¶ç³»ç»Ÿ</span>
<span class="w">    </span><span class="n">pivot_root</span><span class="p">(</span><span class="s">&quot;/new_root&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/new_root/.old_root&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 4. å¸è½½æ—§æ ¹</span>
<span class="w">    </span><span class="n">umount2</span><span class="p">(</span><span class="s">&quot;/.old_root&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">MNT_DETACH</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 5. æ‰§è¡Œå®¹å™¨åº”ç”¨</span>
<span class="w">    </span><span class="n">execve</span><span class="p">(</span><span class="s">&quot;/bin/sh&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="n">envp</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1242-oci">12.4.2 OCI è¿è¡Œæ—¶è§„èŒƒ</h3>
<p>Open Container Initiative (OCI) å®šä¹‰äº†å®¹å™¨è¿è¡Œæ—¶çš„æ ‡å‡†è§„èŒƒï¼ŒåŒ…æ‹¬è¿è¡Œæ—¶è§„èŒƒï¼ˆruntime-specï¼‰å’Œé•œåƒè§„èŒƒï¼ˆimage-specï¼‰ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// config.json - OCI è¿è¡Œæ—¶é…ç½®ç¤ºä¾‹</span>
<span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;ociVersion&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.0.2&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;process&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;terminal&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;user&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;uid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;gid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nt">&quot;args&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;/bin/sh&quot;</span><span class="p">],</span>
<span class="w">        </span><span class="nt">&quot;env&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;TERM=xterm&quot;</span>
<span class="w">        </span><span class="p">],</span>
<span class="w">        </span><span class="nt">&quot;cwd&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;capabilities&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;bounding&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;CAP_NET_BIND_SERVICE&quot;</span><span class="p">],</span>
<span class="w">            </span><span class="nt">&quot;effective&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;CAP_NET_BIND_SERVICE&quot;</span><span class="p">],</span>
<span class="w">            </span><span class="nt">&quot;permitted&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;CAP_NET_BIND_SERVICE&quot;</span><span class="p">]</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nt">&quot;rlimits&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">            </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;RLIMIT_NOFILE&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;hard&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1024</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;soft&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1024</span>
<span class="w">        </span><span class="p">}]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;root&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;rootfs&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;readonly&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;mounts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">        </span><span class="nt">&quot;destination&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/proc&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;proc&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;source&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;proc&quot;</span>
<span class="w">    </span><span class="p">}],</span>
<span class="w">    </span><span class="nt">&quot;linux&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;namespaces&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;pid&quot;</span><span class="p">},</span>
<span class="w">            </span><span class="p">{</span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;network&quot;</span><span class="p">},</span>
<span class="w">            </span><span class="p">{</span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ipc&quot;</span><span class="p">},</span>
<span class="w">            </span><span class="p">{</span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;uts&quot;</span><span class="p">},</span>
<span class="w">            </span><span class="p">{</span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;mount&quot;</span><span class="p">}</span>
<span class="w">        </span><span class="p">],</span>
<span class="w">        </span><span class="nt">&quot;resources&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;memory&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;limit&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">536870912</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="nt">&quot;cpu&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;shares&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1024</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;quota&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100000</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;period&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100000</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1243-runc">12.4.3 runc å®ç°åˆ†æ</h3>
<p>runc æ˜¯ OCI è¿è¡Œæ—¶è§„èŒƒçš„å‚è€ƒå®ç°ï¼Œå…¶æ ¸å¿ƒæµç¨‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// libcontainer/process_linux.go ç®€åŒ–ç‰ˆ</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="o">*</span><span class="nx">initProcess</span><span class="p">)</span><span class="w"> </span><span class="nx">start</span><span class="p">()</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 1. åˆ›å»ºç®¡é“ç”¨äºçˆ¶å­è¿›ç¨‹é€šä¿¡</span>
<span class="w">    </span><span class="nx">parentPipe</span><span class="p">,</span><span class="w"> </span><span class="nx">childPipe</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">newPipe</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 2. å¯åŠ¨è¿›ç¨‹</span>
<span class="w">    </span><span class="nx">cmd</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">cmd</span>
<span class="w">    </span><span class="nx">cmd</span><span class="p">.</span><span class="nx">ExtraFiles</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[]</span><span class="o">*</span><span class="nx">os</span><span class="p">.</span><span class="nx">File</span><span class="p">{</span><span class="nx">childPipe</span><span class="p">}</span>
<span class="w">    </span><span class="nx">cmd</span><span class="p">.</span><span class="nx">Env</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">cmd</span><span class="p">.</span><span class="nx">Env</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;_LIBCONTAINER_INITPIPE=%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">))</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">cmd</span><span class="p">.</span><span class="nx">Start</span><span class="p">();</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 3. å‘é€é…ç½®åˆ°å­è¿›ç¨‹</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">sendConfig</span><span class="p">();</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 4. ç­‰å¾…å­è¿›ç¨‹å‡†å¤‡å°±ç»ª</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">waitForChildExit</span><span class="p">();</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 5. é…ç½® cgroups</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">manager</span><span class="p">.</span><span class="nx">Apply</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">pid</span><span class="p">());</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 6. è®¾ç½®ç½‘ç»œ</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">createNetworkInterfaces</span><span class="p">();</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 7. é€šçŸ¥å­è¿›ç¨‹ç»§ç»­</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">sendContinue</span><span class="p">();</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1244">12.4.4 å®¹å™¨ç½‘ç»œæ¨¡å‹</h3>
<p>å®¹å™¨ç½‘ç»œé€šå¸¸é‡‡ç”¨ veth pairï¼ˆè™šæ‹Ÿä»¥å¤ªç½‘å¯¹ï¼‰è¿æ¥å®¹å™¨å’Œä¸»æœºç½‘ç»œï¼š</p>
<div class="codehilite"><pre><span></span><code>   ä¸»æœºç½‘ç»œå‘½åç©ºé—´                    å®¹å™¨ç½‘ç»œå‘½åç©ºé—´
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚              â”‚                  â”‚              â”‚
   â”‚  docker0     â”‚                  â”‚    eth0      â”‚
   â”‚  (bridge)    â”‚â—„â”€â”€â”€â”€veth pairâ”€â”€â”€â–ºâ”‚  172.17.0.2  â”‚
   â”‚  172.17.0.1  â”‚                  â”‚              â”‚
   â”‚              â”‚                  â”‚              â”‚
   â”‚     eth0     â”‚                  â”‚              â”‚
   â”‚  10.0.0.100  â”‚                  â”‚              â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
    å¤–éƒ¨ç½‘ç»œ (NAT)
</code></pre></div>

<p>veth è®¾å¤‡åˆ›å»ºå’Œé…ç½®ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// åˆ›å»º veth pair</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">create_veth_pair</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">veth1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">veth2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">nl_sock</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nl_socket_alloc</span><span class="p">();</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rtnl_link</span><span class="w"> </span><span class="o">*</span><span class="n">link</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rtnl_link_alloc</span><span class="p">();</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rtnl_link</span><span class="w"> </span><span class="o">*</span><span class="n">peer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rtnl_link_alloc</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// è®¾ç½® veth ç±»å‹</span>
<span class="w">    </span><span class="n">rtnl_link_set_type</span><span class="p">(</span><span class="n">link</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;veth&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">rtnl_link_set_name</span><span class="p">(</span><span class="n">link</span><span class="p">,</span><span class="w"> </span><span class="n">veth1</span><span class="p">);</span>
<span class="w">    </span><span class="n">rtnl_link_set_name</span><span class="p">(</span><span class="n">peer</span><span class="p">,</span><span class="w"> </span><span class="n">veth2</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// åˆ›å»º veth pair</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">rtnl_link_add</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span><span class="w"> </span><span class="n">link</span><span class="p">,</span><span class="w"> </span><span class="n">NLM_F_CREATE</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// å°† veth ä¸€ç«¯ç§»åˆ°å®¹å™¨å‘½åç©ºé—´</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">move_veth_to_netns</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">veth</span><span class="p">,</span><span class="w"> </span><span class="kt">pid_t</span><span class="w"> </span><span class="n">pid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">path</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="w">    </span><span class="n">snprintf</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">path</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;/proc/%d/ns/net&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">);</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">netns_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDONLY</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">nl_sock</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nl_socket_alloc</span><span class="p">();</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rtnl_link</span><span class="w"> </span><span class="o">*</span><span class="n">link</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rtnl_link_get_by_name</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span><span class="w"> </span><span class="n">veth</span><span class="p">);</span>

<span class="w">    </span><span class="n">rtnl_link_set_ns_fd</span><span class="p">(</span><span class="n">link</span><span class="p">,</span><span class="w"> </span><span class="n">netns_fd</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">rtnl_link_change</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span><span class="w"> </span><span class="n">link</span><span class="p">,</span><span class="w"> </span><span class="n">link</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="125">12.5 å®‰å…¨å®¹å™¨æŠ€æœ¯</h2>
<h3 id="1251">12.5.1 å®¹å™¨å®‰å…¨æŒ‘æˆ˜</h3>
<p>ä¼ ç»Ÿå®¹å™¨å…±äº«ä¸»æœºå†…æ ¸ï¼Œå­˜åœ¨å›ºæœ‰çš„å®‰å…¨é£é™©ï¼š</p>
<ol>
<li><strong>å†…æ ¸æ¼æ´</strong>ï¼šå®¹å™¨é€ƒé€¸å¯èƒ½è·å¾—ä¸»æœºæƒé™</li>
<li><strong>èµ„æºè€—å°½</strong>ï¼šæ¶æ„å®¹å™¨å¯èƒ½è€—å°½ç³»ç»Ÿèµ„æº</li>
<li><strong>ä¾§ä¿¡é“æ”»å‡»</strong>ï¼šå…±äº« CPU ç¼“å­˜å¯èƒ½æ³„éœ²ä¿¡æ¯</li>
<li><strong>æƒé™æå‡</strong>ï¼šä¸å½“çš„æƒèƒ½é…ç½®å¯èƒ½å¯¼è‡´ææƒ</li>
</ol>
<h3 id="1252-gvisor">12.5.2 gVisorï¼šç”¨æˆ·æ€å†…æ ¸</h3>
<p>gVisor é€šè¿‡åœ¨ç”¨æˆ·æ€å®ç°å…¼å®¹çš„ç³»ç»Ÿè°ƒç”¨æ¥å£ï¼Œæä¾›é¢å¤–çš„éš”ç¦»å±‚ï¼š</p>
<div class="codehilite"><pre><span></span><code>åº”ç”¨ç¨‹åº
    â”‚
    â–¼ ç³»ç»Ÿè°ƒç”¨
Sentry (ç”¨æˆ·æ€å†…æ ¸)
    â”‚
    â–¼ æœ‰é™çš„ç³»ç»Ÿè°ƒç”¨
ä¸»æœºå†…æ ¸
</code></pre></div>

<p>gVisor çš„å…³é”®ç»„ä»¶ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Sentry ç³»ç»Ÿè°ƒç”¨æ‹¦æˆª</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">k</span><span class="w"> </span><span class="o">*</span><span class="nx">Kernel</span><span class="p">)</span><span class="w"> </span><span class="nx">SyscallEnter</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">Task</span><span class="p">,</span><span class="w"> </span><span class="nx">sysno</span><span class="w"> </span><span class="kt">uintptr</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="w"> </span><span class="nx">arch</span><span class="p">.</span><span class="nx">SyscallArguments</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// æ£€æŸ¥ç³»ç»Ÿè°ƒç”¨æ˜¯å¦å…è®¸</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">k</span><span class="p">.</span><span class="nx">featureSet</span><span class="p">.</span><span class="nx">HasFeature</span><span class="p">(</span><span class="nx">sysno</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">syserror</span><span class="p">.</span><span class="nx">ENOSYS</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// æ‰§è¡Œç³»ç»Ÿè°ƒç”¨æ¨¡æ‹Ÿ</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="nx">sysno</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">syscall</span><span class="p">.</span><span class="nx">SYS_OPEN</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">k</span><span class="p">.</span><span class="nx">sysOpen</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="p">)</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">syscall</span><span class="p">.</span><span class="nx">SYS_READ</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">k</span><span class="p">.</span><span class="nx">sysRead</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="p">)</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">syscall</span><span class="p">.</span><span class="nx">SYS_WRITE</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">k</span><span class="p">.</span><span class="nx">sysWrite</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="p">)</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1253-kata-containers">12.5.3 Kata Containersï¼šè½»é‡çº§è™šæ‹Ÿæœº</h3>
<p>Kata Containers ä¸ºæ¯ä¸ªå®¹å™¨åˆ›å»ºç‹¬ç«‹çš„è½»é‡çº§è™šæ‹Ÿæœºï¼Œæä¾›ç¡¬ä»¶çº§éš”ç¦»ï¼š</p>
<div class="codehilite"><pre><span></span><code>å®¹å™¨è¿è¡Œæ—¶ (containerd/CRI-O)
         â”‚
         â–¼
    kata-runtime
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â–¼         â–¼
kata-proxy  kata-shim
    â”‚         â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â–¼
    kata-agent (VMå†…)
         â”‚
         â–¼
    Guest Kernel
         â”‚
         â–¼
    Container App
</code></pre></div>

<p>Kata çš„å†…å­˜ä¼˜åŒ–æŠ€æœ¯ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// DAX (Direct Access) å†…å­˜æ˜ å°„</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">dax_device</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">inode</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">cdev</span><span class="w"> </span><span class="n">cdev</span><span class="p">;</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">private</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dax_operations</span><span class="w"> </span><span class="o">*</span><span class="n">ops</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// å†…å­˜å»é‡ (KSM - Kernel Same-page Merging)</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">ksm_scan</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mm_slot</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">address</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rmap_item</span><span class="w"> </span><span class="o">**</span><span class="n">rmap_list</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">seqnr</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="1254">12.5.4 å®‰å…¨å¢å¼ºæœºåˆ¶</h3>
<h4 id="seccomp-bpf">Seccomp-BPFï¼šç³»ç»Ÿè°ƒç”¨è¿‡æ»¤</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">// å®šä¹‰ seccomp è¿‡æ»¤è§„åˆ™</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">sock_filter</span><span class="w"> </span><span class="n">filter</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// åŠ è½½ç³»ç»Ÿè°ƒç”¨å·</span>
<span class="w">    </span><span class="n">BPF_STMT</span><span class="p">(</span><span class="n">BPF_LD</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">BPF_W</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">BPF_ABS</span><span class="p">,</span><span class="w"> </span>
<span class="w">             </span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">seccomp_data</span><span class="p">,</span><span class="w"> </span><span class="n">nr</span><span class="p">)),</span>

<span class="w">    </span><span class="c1">// å…è®¸çš„ç³»ç»Ÿè°ƒç”¨</span>
<span class="w">    </span><span class="n">BPF_JUMP</span><span class="p">(</span><span class="n">BPF_JMP</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">BPF_JEQ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">BPF_K</span><span class="p">,</span><span class="w"> </span><span class="n">__NR_read</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>
<span class="w">    </span><span class="n">BPF_STMT</span><span class="p">(</span><span class="n">BPF_RET</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">BPF_K</span><span class="p">,</span><span class="w"> </span><span class="n">SECCOMP_RET_ALLOW</span><span class="p">),</span>

<span class="w">    </span><span class="n">BPF_JUMP</span><span class="p">(</span><span class="n">BPF_JMP</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">BPF_JEQ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">BPF_K</span><span class="p">,</span><span class="w"> </span><span class="n">__NR_write</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>
<span class="w">    </span><span class="n">BPF_STMT</span><span class="p">(</span><span class="n">BPF_RET</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">BPF_K</span><span class="p">,</span><span class="w"> </span><span class="n">SECCOMP_RET_ALLOW</span><span class="p">),</span>

<span class="w">    </span><span class="c1">// é»˜è®¤æ‹’ç»</span>
<span class="w">    </span><span class="n">BPF_STMT</span><span class="p">(</span><span class="n">BPF_RET</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">BPF_K</span><span class="p">,</span><span class="w"> </span><span class="n">SECCOMP_RET_KILL</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">sock_fprog</span><span class="w"> </span><span class="n">prog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">filter</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
<span class="w">    </span><span class="p">.</span><span class="n">filter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filter</span><span class="p">,</span>
<span class="p">};</span>

<span class="c1">// åº”ç”¨è¿‡æ»¤è§„åˆ™</span>
<span class="n">prctl</span><span class="p">(</span><span class="n">PR_SET_NO_NEW_PRIVS</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="n">prctl</span><span class="p">(</span><span class="n">PR_SET_SECCOMP</span><span class="p">,</span><span class="w"> </span><span class="n">SECCOMP_MODE_FILTER</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">prog</span><span class="p">);</span>
</code></pre></div>

<h4 id="apparmorselinux">AppArmor/SELinux å¼ºåˆ¶è®¿é—®æ§åˆ¶</h4>
<div class="codehilite"><pre><span></span><code><span class="gh">#</span> AppArmor å®¹å™¨é…ç½®æ–‡ä»¶ç¤ºä¾‹
profile docker-container flags=(attach_disconnected,mediate_deleted) {
  # ç½‘ç»œè®¿é—®
  network inet,
  network inet6,

  # æ–‡ä»¶è®¿é—®
  deny @{PROC}/* w,
  deny @{PROC}/.* w,
  deny /sys/[^f]*/** w,
  deny /sys/f[^s]*/** w,

  # æŒ‚è½½æƒé™
  mount,
  umount,
  pivot_root,

  # æƒèƒ½é™åˆ¶
  capability net_bind_service,
  capability setuid,
  capability setgid,
  deny capability sys_admin,
}
</code></pre></div>

<h4 id="capabilities">Capabilities ç»†ç²’åº¦æƒé™æ§åˆ¶</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">// æƒèƒ½é›†åˆç®¡ç†</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">cred</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ... å…¶ä»–å­—æ®µ</span>
<span class="w">    </span><span class="n">kernel_cap_t</span><span class="w"> </span><span class="n">cap_inheritable</span><span class="p">;</span><span class="w">  </span><span class="c1">// å¯ç»§æ‰¿æƒèƒ½</span>
<span class="w">    </span><span class="n">kernel_cap_t</span><span class="w"> </span><span class="n">cap_permitted</span><span class="p">;</span><span class="w">    </span><span class="c1">// å…è®¸çš„æƒèƒ½</span>
<span class="w">    </span><span class="n">kernel_cap_t</span><span class="w"> </span><span class="n">cap_effective</span><span class="p">;</span><span class="w">    </span><span class="c1">// ç”Ÿæ•ˆçš„æƒèƒ½</span>
<span class="w">    </span><span class="n">kernel_cap_t</span><span class="w"> </span><span class="n">cap_bset</span><span class="p">;</span><span class="w">        </span><span class="c1">// è¾¹ç•Œé›†</span>
<span class="w">    </span><span class="n">kernel_cap_t</span><span class="w"> </span><span class="n">cap_ambient</span><span class="p">;</span><span class="w">     </span><span class="c1">// ç¯å¢ƒæƒèƒ½</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">};</span>

<span class="c1">// å¸¸ç”¨å®¹å™¨æƒèƒ½é…ç½®</span>
<span class="cp">#define CONTAINER_CAPS ( \</span>
<span class="cp">    CAP_TO_MASK(CAP_CHOWN) | \</span>
<span class="cp">    CAP_TO_MASK(CAP_DAC_OVERRIDE) | \</span>
<span class="cp">    CAP_TO_MASK(CAP_FSETID) | \</span>
<span class="cp">    CAP_TO_MASK(CAP_FOWNER) | \</span>
<span class="cp">    CAP_TO_MASK(CAP_SETGID) | \</span>
<span class="cp">    CAP_TO_MASK(CAP_SETUID) | \</span>
<span class="cp">    CAP_TO_MASK(CAP_SETPCAP) | \</span>
<span class="cp">    CAP_TO_MASK(CAP_NET_BIND_SERVICE) | \</span>
<span class="cp">    CAP_TO_MASK(CAP_KILL) \</span>
<span class="cp">)</span>
</code></pre></div>

<h2 id="126">12.6 å®¹å™¨ç¼–æ’ä¸é›†ç¾¤ç®¡ç†</h2>
<h3 id="1261">12.6.1 å®¹å™¨ç¼–æ’çš„å†…æ ¸æ”¯æŒ</h3>
<p>Kubernetes ç­‰å®¹å™¨ç¼–æ’ç³»ç»Ÿä¾èµ–å¤šé¡¹å†…æ ¸ç‰¹æ€§å®ç°é›†ç¾¤ç®¡ç†ï¼š</p>
<ol>
<li><strong>CRIï¼ˆContainer Runtime Interfaceï¼‰</strong>ï¼šæ ‡å‡†åŒ–å®¹å™¨è¿è¡Œæ—¶æ¥å£</li>
<li><strong>CNIï¼ˆContainer Network Interfaceï¼‰</strong>ï¼šæ ‡å‡†åŒ–ç½‘ç»œæ’ä»¶æ¥å£</li>
<li><strong>CSIï¼ˆContainer Storage Interfaceï¼‰</strong>ï¼šæ ‡å‡†åŒ–å­˜å‚¨æ’ä»¶æ¥å£</li>
</ol>
<h3 id="1262-pod">12.6.2 Pod çš„å†…æ ¸å®ç°</h3>
<p>Kubernetes Pod ä¸­çš„å®¹å™¨å…±äº«æŸäº›å‘½åç©ºé—´ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Pod å†…å®¹å™¨çš„å‘½åç©ºé—´é…ç½®</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">pod_namespace_config</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// å…±äº«çš„å‘½åç©ºé—´</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">net</span><span class="w"> </span><span class="o">*</span><span class="n">net_ns</span><span class="p">;</span><span class="w">        </span><span class="c1">// å…±äº«ç½‘ç»œå‘½åç©ºé—´</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ipc_namespace</span><span class="w"> </span><span class="o">*</span><span class="n">ipc_ns</span><span class="p">;</span><span class="w"> </span><span class="c1">// å…±äº« IPC å‘½åç©ºé—´</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">uts_namespace</span><span class="w"> </span><span class="o">*</span><span class="n">uts_ns</span><span class="p">;</span><span class="w"> </span><span class="c1">// å…±äº« UTS å‘½åç©ºé—´</span>

<span class="w">    </span><span class="c1">// ç‹¬ç«‹çš„å‘½åç©ºé—´</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pid_namespace</span><span class="w"> </span><span class="o">*</span><span class="n">pid_ns</span><span class="p">;</span><span class="w"> </span><span class="c1">// å„è‡ªçš„ PID å‘½åç©ºé—´</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mnt_namespace</span><span class="w"> </span><span class="o">*</span><span class="n">mnt_ns</span><span class="p">;</span><span class="w"> </span><span class="c1">// å„è‡ªçš„æŒ‚è½½å‘½åç©ºé—´</span>
<span class="p">};</span>

<span class="c1">// Pause å®¹å™¨ï¼ˆåŸºç¡€è®¾æ–½å®¹å™¨ï¼‰</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">create_pause_container</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// åˆ›å»ºå…±äº«çš„å‘½åç©ºé—´</span>
<span class="w">    </span><span class="n">unshare</span><span class="p">(</span><span class="n">CLONE_NEWNET</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">CLONE_NEWIPC</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">CLONE_NEWUTS</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Pause å®¹å™¨åªæ˜¯æŒæœ‰å‘½åç©ºé—´</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pause</span><span class="p">();</span><span class="w">  </span><span class="c1">// æ°¸ä¹…ä¼‘çœ </span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1263">12.6.3 å®¹å™¨é—´é€šä¿¡ä¼˜åŒ–</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// å…±äº«å†…å­˜ IPC</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">shm_container_ipc</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">shmid</span><span class="p">;</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="p">;</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// Unix åŸŸå¥—æ¥å­—</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">unix_socket_ipc</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">sock_fd</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sockaddr_un</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// å†…å­˜æ˜ å°„æ–‡ä»¶</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">mmap_ipc</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">;</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="p">;</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">length</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>

<h2 id="127">12.7 æ€§èƒ½ä¼˜åŒ–ä¸è°ƒä¼˜</h2>
<h3 id="1271">12.7.1 å‘½åç©ºé—´æ€§èƒ½å¼€é”€</h3>
<p>ä¸åŒå‘½åç©ºé—´çš„æ€§èƒ½å½±å“ï¼š</p>
<p>| å‘½åç©ºé—´ | æ€§èƒ½å¼€é”€ | ä¸»è¦å½±å“ |</p>
<table>
<thead>
<tr>
<th>å‘½åç©ºé—´</th>
<th>æ€§èƒ½å¼€é”€</th>
<th>ä¸»è¦å½±å“</th>
</tr>
</thead>
<tbody>
<tr>
<td>PID</td>
<td>ä½ (~1%)</td>
<td>è¿›ç¨‹åˆ›å»ºæ—¶çš„ PID åˆ†é…</td>
</tr>
<tr>
<td>Network</td>
<td>ä¸­ (~5%)</td>
<td>ç½‘ç»œæ ˆéå†ã€veth å¼€é”€</td>
</tr>
<tr>
<td>Mount</td>
<td>ä½ (~2%)</td>
<td>è·¯å¾„è§£æã€æŒ‚è½½ç‚¹æŸ¥æ‰¾</td>
</tr>
<tr>
<td>IPC</td>
<td>æä½ (&lt;1%)</td>
<td>IPC å¯¹è±¡æŸ¥æ‰¾</td>
</tr>
<tr>
<td>UTS</td>
<td>æä½ (&lt;1%)</td>
<td>å‡ ä¹æ— å¼€é”€</td>
</tr>
<tr>
<td>User</td>
<td>ä¸­ (~3%)</td>
<td>æƒé™æ£€æŸ¥ã€ID æ˜ å°„</td>
</tr>
</tbody>
</table>
<h3 id="1272-cgroups">12.7.2 Cgroups æ€§èƒ½ä¼˜åŒ–</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä½¿ç”¨ cgroup v2 çš„å‹åŠ›æŒ‡æ ‡è¿›è¡ŒåŠ¨æ€è°ƒæ•´</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">psi_group</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mutex</span><span class="w"> </span><span class="n">trigger_lock</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">psi_trigger</span><span class="w"> </span><span class="o">*</span><span class="n">triggers</span><span class="p">;</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">total</span><span class="p">[</span><span class="n">NR_PSI_TASK_COUNTS</span><span class="p">][</span><span class="n">NR_PSI_STATES</span><span class="p">];</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">avg</span><span class="p">[</span><span class="n">NR_PSI_STATES</span><span class="p">][</span><span class="mi">3</span><span class="p">];</span><span class="w">  </span><span class="c1">// 10s, 60s, 300s</span>
<span class="p">};</span>

<span class="c1">// å†…å­˜å‹åŠ›ç›‘æ§</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">monitor_memory_pressure</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">cgroup</span><span class="w"> </span><span class="o">*</span><span class="n">cgrp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">psi_group</span><span class="w"> </span><span class="o">*</span><span class="n">psi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cgrp</span><span class="o">-&gt;</span><span class="n">psi</span><span class="p">;</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">pressure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">psi</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">[</span><span class="n">PSI_MEM_SOME</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span><span class="w">  </span><span class="c1">// 10s average</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pressure</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">THRESHOLD_HIGH</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// è§¦å‘å†…å­˜å›æ”¶</span>
<span class="w">        </span><span class="n">reclaim_memory</span><span class="p">(</span><span class="n">cgrp</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pressure</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">THRESHOLD_LOW</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// å¯ä»¥å¢åŠ å†…å­˜é™åˆ¶</span>
<span class="w">        </span><span class="n">increase_memory_limit</span><span class="p">(</span><span class="n">cgrp</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="1273">12.7.3 å®¹å™¨å¯åŠ¨ä¼˜åŒ–</h3>
<ol>
<li><strong>é•œåƒå±‚ç¼“å­˜</strong>ï¼šåˆ©ç”¨ overlayfs çš„å±‚æ¬¡ç»“æ„</li>
<li><strong>å»¶è¿ŸæŒ‚è½½</strong>ï¼šæŒ‰éœ€æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ</li>
<li><strong>é¢„åˆ›å»ºå®¹å™¨æ± </strong>ï¼šæå‰åˆ›å»ºå¾…ç”¨å®¹å™¨</li>
<li><strong>checkpoint/restore</strong>ï¼šä½¿ç”¨ CRIU å¿«é€Ÿæ¢å¤</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># CRIU å®¹å™¨æ£€æŸ¥ç‚¹</span>
criu<span class="w"> </span>dump<span class="w"> </span>-t<span class="w"> </span><span class="nv">$PID</span><span class="w"> </span>-D<span class="w"> </span>/checkpoint<span class="w"> </span>--shell-job

<span class="c1"># å¿«é€Ÿæ¢å¤</span>
criu<span class="w"> </span>restore<span class="w"> </span>-D<span class="w"> </span>/checkpoint<span class="w"> </span>--shell-job
</code></pre></div>

<h2 id="_2">æœ¬ç« å°ç»“</h2>
<p>æœ¬ç« æ·±å…¥æ¢è®¨äº† Linux å®¹å™¨æŠ€æœ¯çš„å†…æ ¸å®ç°æœºåˆ¶ã€‚æˆ‘ä»¬ä»å‘½åç©ºé—´çš„è®¾è®¡å“²å­¦å‡ºå‘ï¼Œè¯¦ç»†åˆ†æäº† 8 ç§å‘½åç©ºé—´çš„å®ç°åŸç†å’Œç›¸äº’å…³ç³»ã€‚é€šè¿‡å¯¹ cgroups v1 å’Œ v2 çš„å¯¹æ¯”ï¼Œç†è§£äº†èµ„æºæ§åˆ¶çš„æ¼”è¿›è¿‡ç¨‹ã€‚å®¹å™¨è¿è¡Œæ—¶éƒ¨åˆ†æ¶µç›–äº†ä»ç³»ç»Ÿè°ƒç”¨åˆ° OCI è§„èŒƒçš„å®Œæ•´å®ç°é“¾è·¯ã€‚å®‰å…¨å®¹å™¨æŠ€æœ¯å±•ç¤ºäº† gVisor å’Œ Kata Containers å¦‚ä½•é€šè¿‡ä¸åŒæ–¹å¼å¢å¼ºéš”ç¦»æ€§ã€‚</p>
<p>å…³é”®è¦ç‚¹ï¼š</p>
<ol>
<li><strong>å‘½åç©ºé—´</strong>ï¼šæä¾›è¿›ç¨‹è§†å›¾éš”ç¦»ï¼Œæ˜¯å®¹å™¨çš„åŸºç¡€</li>
<li><strong>Cgroups</strong>ï¼šå®ç°èµ„æºé™åˆ¶å’Œç»Ÿè®¡ï¼Œä¿è¯å…¬å¹³æ€§</li>
<li><strong>è¿è¡Œæ—¶è§„èŒƒ</strong>ï¼šOCI æ ‡å‡†åŒ–äº†å®¹å™¨ç”Ÿæ€ç³»ç»Ÿ</li>
<li><strong>å®‰å…¨æœºåˆ¶</strong>ï¼šå¤šå±‚é˜²æŠ¤ç¡®ä¿å®¹å™¨éš”ç¦»æ€§</li>
<li><strong>æ€§èƒ½æƒè¡¡</strong>ï¼šéš”ç¦»æ€§ä¸æ€§èƒ½çš„å¹³è¡¡è®¾è®¡</li>
</ol>
<p>å…¬å¼æ€»ç»“ï¼š</p>
<ul>
<li>å®¹å™¨å¼€é”€ = $\sum_{ns \in namespaces} overhead(ns) + cgroup_overhead + network_overhead$</li>
<li>å†…å­˜é™åˆ¶ = $min(cgroup_limit, system_available, oom_threshold)$</li>
<li>CPU é…é¢ = $\frac{quota}{period} \times available_cpus$</li>
</ul>
<h2 id="_3">ç»ƒä¹ é¢˜</h2>
<h3 id="_4">åŸºç¡€é¢˜</h3>
<ol>
<li>
<p><strong>å‘½åç©ºé—´ç†è§£</strong>
   - è§£é‡Š PID å‘½åç©ºé—´çš„å±‚æ¬¡ç»“æ„ï¼Œä¸ºä»€ä¹ˆå®¹å™¨å†…çš„è¿›ç¨‹åœ¨ä¸»æœºä¸Šæœ‰ä¸åŒçš„ PIDï¼Ÿ
   - <strong>Hint</strong>: è€ƒè™‘ struct pid çš„ level å­—æ®µå’Œ upid æ•°ç»„
   <details markdown="block">
   <summary markdown="off">ç­”æ¡ˆ</summary>
   PID å‘½åç©ºé—´å½¢æˆæ ‘çŠ¶å±‚æ¬¡ç»“æ„ã€‚æ¯ä¸ªè¿›ç¨‹åœ¨å…¶æ‰€åœ¨å‘½åç©ºé—´åŠæ‰€æœ‰ç¥–å…ˆå‘½åç©ºé—´ä¸­éƒ½æœ‰ PIDã€‚struct pid åŒ…å«å¤šä¸ª upid ç»“æ„ï¼Œæ¯ä¸ªå¯¹åº”ä¸€ä¸ªå‘½åç©ºé—´å±‚çº§ã€‚å®¹å™¨å†… PID 1 çš„è¿›ç¨‹åœ¨ä¸»æœºå‘½åç©ºé—´å¯èƒ½æ˜¯ PID 5679ï¼Œé€šè¿‡ pid-&gt;numbers[] æ•°ç»„ç»´æŠ¤å¤šä¸ª PID æ˜ å°„ã€‚
   </details></p>
</li>
<li>
<p><strong>Cgroups ç‰ˆæœ¬å¯¹æ¯”</strong>
   - æ¯”è¾ƒ cgroups v1 å’Œ v2 çš„ä¸»è¦åŒºåˆ«ï¼Œè¯´æ˜ v2 è§£å†³äº† v1 çš„å“ªäº›é—®é¢˜ï¼Ÿ
   - <strong>Hint</strong>: è€ƒè™‘å±‚æ¬¡ç»“æ„ã€æ§åˆ¶å™¨ç®¡ç†å’Œèµ„æºæ¨¡å‹
   <details markdown="block">
   <summary markdown="off">ç­”æ¡ˆ</summary>
   v1 é—®é¢˜ï¼šå¤šä¸ªå±‚æ¬¡ç»“æ„å¯¼è‡´ç®¡ç†å¤æ‚ã€æ§åˆ¶å™¨é—´ç¼ºä¹åè°ƒã€æ— ç»Ÿä¸€çš„èµ„æºå‹åŠ›æŒ‡æ ‡ã€‚v2 æ”¹è¿›ï¼šç»Ÿä¸€å±‚æ¬¡ç»“æ„ã€æ‰€æœ‰æ§åˆ¶å™¨å…±äº«åŒä¸€æ ‘ã€å¼•å…¥ PSI å‹åŠ›æŒ‡æ ‡ã€æ›´å¥½çš„èµ„æºæ¨¡å‹ï¼ˆåŸºäºæƒé‡è€Œéé™åˆ¶ï¼‰ã€æ”¯æŒ eBPF ç¨‹åºè¿›è¡Œç»†ç²’åº¦æ§åˆ¶ã€‚
   </details></p>
</li>
<li>
<p><strong>å®¹å™¨ç½‘ç»œåŸºç¡€</strong>
   - æè¿° veth pair çš„å·¥ä½œåŸç†ï¼Œä»¥åŠå®¹å™¨å¦‚ä½•é€šè¿‡ docker0 ç½‘æ¡¥è®¿é—®å¤–ç½‘
   - <strong>Hint</strong>: è€ƒè™‘æ•°æ®åŒ…åœ¨å‘½åç©ºé—´é—´çš„æµåŠ¨è·¯å¾„
   <details markdown="block">
   <summary markdown="off">ç­”æ¡ˆ</summary>
   veth pair æ˜¯æˆå¯¹çš„è™šæ‹Ÿç½‘å¡ï¼Œæ•°æ®ä»ä¸€ç«¯è¿›å…¥ä¼šä»å¦ä¸€ç«¯å‡ºæ¥ã€‚å®¹å™¨ eth0 è¿æ¥åˆ° veth ä¸€ç«¯ï¼Œå¦ä¸€ç«¯è¿æ¥åˆ° docker0 ç½‘æ¡¥ã€‚å‡ºç«™æµé‡ï¼šå®¹å™¨ eth0 â†’ veth â†’ docker0 â†’ iptables NAT â†’ ä¸»æœº eth0ã€‚å…¥ç«™æµé‡åå‘ï¼Œé€šè¿‡ iptables DNAT è§„åˆ™è½¬å‘åˆ°å®¹å™¨ã€‚
   </details></p>
</li>
<li>
<p><strong>ç³»ç»Ÿè°ƒç”¨åºåˆ—</strong>
   - åˆ—å‡ºåˆ›å»ºä¸€ä¸ªæœ€å°å®¹å™¨éœ€è¦çš„ç³»ç»Ÿè°ƒç”¨åºåˆ—ï¼Œå¹¶è¯´æ˜æ¯ä¸ªè°ƒç”¨çš„ä½œç”¨
   - <strong>Hint</strong>: cloneã€unshareã€setnsã€mountã€pivot_root
   <details markdown="block">
   <summary markdown="off">ç­”æ¡ˆ</summary>

   1. clone(CLONE_NEW*): åˆ›å»ºæ–°è¿›ç¨‹å’Œå‘½åç©ºé—´
   2. setns(): åŠ å…¥å·²æœ‰å‘½åç©ºé—´
   3. unshare(): åˆ›å»ºæ–°å‘½åç©ºé—´
   4. mount(): æŒ‚è½½ procã€sys ç­‰ä¼ªæ–‡ä»¶ç³»ç»Ÿ
   5. pivot_root(): åˆ‡æ¢æ ¹æ–‡ä»¶ç³»ç»Ÿ
   6. prctl(PR_SET_NO_NEW_PRIVS): è®¾ç½®å®‰å…¨å±æ€§
   7. setrlimit(): è®¾ç½®èµ„æºé™åˆ¶
   8. execve(): æ‰§è¡Œå®¹å™¨è¿›ç¨‹
   </details></p>
</li>
</ol>
<h3 id="_5">æŒ‘æˆ˜é¢˜</h3>
<ol start="5">
<li>
<p><strong>å®ç°ç®€å•å®¹å™¨</strong>
   - è®¾è®¡å¹¶å®ç°ä¸€ä¸ªæœ€å°å®¹å™¨è¿è¡Œæ—¶ï¼Œæ”¯æŒè¿›ç¨‹éš”ç¦»å’Œç®€å•çš„èµ„æºé™åˆ¶
   - <strong>Hint</strong>: ä½¿ç”¨ clone() åˆ›å»ºå‘½åç©ºé—´ï¼Œé€šè¿‡ /sys/fs/cgroup è®¾ç½®é™åˆ¶
   <details markdown="block">
   <summary markdown="off">ç­”æ¡ˆ</summary>
   æ ¸å¿ƒæ­¥éª¤ï¼š

   1. ä½¿ç”¨ clone(CLONE_NEWPID|CLONE_NEWNS|CLONE_NEWNET) åˆ›å»ºéš”ç¦»ç¯å¢ƒ
   2. åœ¨å­è¿›ç¨‹ä¸­ mount procã€åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹
   3. ä½¿ç”¨ pivot_root åˆ‡æ¢æ ¹ç›®å½•
   4. å†™å…¥ cgroup æ–‡ä»¶è®¾ç½®å†…å­˜å’Œ CPU é™åˆ¶
   5. drop capabilities é™ä½æƒé™
   6. execve è¿è¡Œç”¨æˆ·ç¨‹åº
   å…³é”®ç‚¹ï¼šå¤„ç†å¥½çˆ¶å­è¿›ç¨‹é€šä¿¡ã€æ­£ç¡®è®¾ç½®æŒ‚è½½ä¼ æ’­å±æ€§ã€æ¸…ç†ç¯å¢ƒå˜é‡
   </details></p>
</li>
<li>
<p><strong>æ€§èƒ½åˆ†æé¢˜</strong>
   - åˆ†æä¸ºä»€ä¹ˆ Kubernetes Pod ä¸­çš„å®¹å™¨å…±äº«ç½‘ç»œå‘½åç©ºé—´è€Œä¸å…±äº« PID å‘½åç©ºé—´ï¼Ÿè¿™ç§è®¾è®¡çš„æƒè¡¡æ˜¯ä»€ä¹ˆï¼Ÿ
   - <strong>Hint</strong>: è€ƒè™‘å®¹å™¨é—´é€šä¿¡ã€è¿›ç¨‹éš”ç¦»ã€æ•…éšœåŸŸ
   <details markdown="block">
   <summary markdown="off">ç­”æ¡ˆ</summary>
   å…±äº«ç½‘ç»œå‘½åç©ºé—´ä¼˜åŠ¿ï¼š1) localhost é€šä¿¡æ— éœ€ç»è¿‡ç½‘ç»œæ ˆ 2) å…±äº«ç«¯å£ç©ºé—´ä¾¿äºæœåŠ¡å‘ç° 3) å‡å°‘ç½‘ç»œé…ç½®å¤æ‚åº¦ã€‚
   ä¸å…±äº« PID å‘½åç©ºé—´åŸå› ï¼š1) è¿›ç¨‹éš”ç¦»é˜²æ­¢ç›¸äº’å¹²æ‰° 2) ç‹¬ç«‹çš„ PID 1 å¤„ç†ä¿¡å·å’Œå­¤å„¿è¿›ç¨‹ 3) æ•…éšœéš”ç¦»ï¼Œä¸€ä¸ªå®¹å™¨å´©æºƒä¸å½±å“å…¶ä»–ã€‚
   æƒè¡¡ï¼šç½‘ç»œæ€§èƒ½ vs è¿›ç¨‹éš”ç¦»ï¼Œé€šè¿‡ pause å®¹å™¨æŒæœ‰å…±äº«å‘½åç©ºé—´å®ç°æœ€ä½³å¹³è¡¡ã€‚
   </details></p>
</li>
<li>
<p><strong>å®‰å…¨è®¾è®¡é¢˜</strong>
   - è®¾è®¡ä¸€ä¸ªå®¹å™¨å®‰å…¨æ–¹æ¡ˆï¼Œè¦æ±‚ï¼šé˜²æ­¢å®¹å™¨é€ƒé€¸ã€é™åˆ¶ç³»ç»Ÿè°ƒç”¨ã€å®ç°ç»†ç²’åº¦æƒé™æ§åˆ¶
   - <strong>Hint</strong>: ç»„åˆä½¿ç”¨ user namespaceã€seccompã€capabilitiesã€LSM
   <details markdown="block">
   <summary markdown="off">ç­”æ¡ˆ</summary>
   å¤šå±‚é˜²å¾¡æ–¹æ¡ˆï¼š

   1. User namespace: å®¹å™¨ root æ˜ å°„ä¸ºä¸»æœºæ™®é€šç”¨æˆ·(uid 100000)
   2. Seccomp-BPF: ç™½åå•è¿‡æ»¤å±é™©ç³»ç»Ÿè°ƒç”¨(ç¦æ­¢ mountã€ptrace ç­‰)
   3. Capabilities: ä»…ä¿ç•™å¿…è¦æƒèƒ½ï¼Œdrop CAP_SYS_ADMIN ç­‰
   4. AppArmor/SELinux: å¼ºåˆ¶è®¿é—®æ§åˆ¶ç­–ç•¥
   5. åªè¯»æ ¹æ–‡ä»¶ç³»ç»Ÿ + tmpfs
   6. èµ„æºé™åˆ¶: cgroups é˜²æ­¢ DoS
   7. ç½‘ç»œéš”ç¦»: ç‹¬ç«‹ç½‘ç»œå‘½åç©ºé—´ + é˜²ç«å¢™è§„åˆ™
   å®æ–½é¡ºåºï¼šå…ˆå®½åä¸¥ï¼Œé€æ­¥æ”¶ç´§æƒé™
   </details></p>
</li>
<li>
<p><strong>ä¼˜åŒ–å®è·µé¢˜</strong>
   - æŸå®¹å™¨åŒ–åº”ç”¨å¯åŠ¨æ—¶é—´è¿‡é•¿ï¼ˆ&gt;10ç§’ï¼‰ï¼Œè¯·åˆ†æå¯èƒ½çš„åŸå› å¹¶æå‡ºä¼˜åŒ–æ–¹æ¡ˆ
   - <strong>Hint</strong>: é•œåƒå±‚ã€æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œé…ç½®ã€è¿›ç¨‹åˆå§‹åŒ–
   <details markdown="block">
   <summary markdown="off">ç­”æ¡ˆ</summary>
   ç“¶é¢ˆåˆ†æï¼š

   1. é•œåƒæ‹‰å–ï¼šä½¿ç”¨æœ¬åœ°é•œåƒç¼“å­˜ã€é•œåƒé¢„çƒ­
   2. å±‚è§£å‹ï¼šä¼˜åŒ–å±‚æ•°é‡ã€ä½¿ç”¨ lazy pulling
   3. æ–‡ä»¶ç³»ç»Ÿï¼šoverlayfs ä¼˜åŒ–ã€å‡å°‘å±‚æ•°
   4. ç½‘ç»œåˆå§‹åŒ–ï¼šé¢„åˆ›å»ºç½‘ç»œå‘½åç©ºé—´æ± 
   5. è¿›ç¨‹å¯åŠ¨ï¼šåº”ç”¨é¢„çƒ­ã€JIT é¢„ç¼–è¯‘
   ä¼˜åŒ–æ–¹æ¡ˆï¼š

   - ä½¿ç”¨ CRIU checkpoint/restore
   - å®ç°å®¹å™¨æ± é¢„åˆ›å»º
   - é•œåƒåˆ†å±‚ä¼˜åŒ–ï¼ŒåŸºç¡€å±‚å…±äº«
   - å»¶è¿ŸåŠ è½½éå…³é”®èµ„æº
   - å¹¶è¡ŒåŒ–åˆå§‹åŒ–æ­¥éª¤
   é¢„æœŸæ•ˆæœï¼šå¯åŠ¨æ—¶é—´é™è‡³ 1-2 ç§’
   </details></p>
</li>
</ol>
<h2 id="_6">å¸¸è§é™·é˜±ä¸é”™è¯¯</h2>
<h3 id="_7">å‘½åç©ºé—´ç›¸å…³</h3>
<ol>
<li>
<p><strong>PID å‘½åç©ºé—´çš„ init è¿›ç¨‹</strong>
   - é”™è¯¯ï¼šå¿˜è®°å¤„ç†å®¹å™¨å†…çš„ PID 1 ä¿¡å·
   - åæœï¼šå­è¿›ç¨‹å˜æˆåƒµå°¸è¿›ç¨‹
   - è§£å†³ï¼šPID 1 å¿…é¡»æ­£ç¡®å¤„ç† SIGCHLDï¼Œå›æ”¶å­è¿›ç¨‹</p>
</li>
<li>
<p><strong>User namespace UID æ˜ å°„</strong>
   - é”™è¯¯ï¼šå…ˆå†™ gid_map å†å†™ uid_map
   - åæœï¼šæƒé™é”™è¯¯ï¼Œæ˜ å°„å¤±è´¥
   - è§£å†³ï¼šå¿…é¡»å…ˆå†™ uid_mapï¼Œä¸”éœ€è¦ CAP_SETUID æƒèƒ½</p>
</li>
<li>
<p><strong>Mount å‘½åç©ºé—´ä¼ æ’­</strong>
   - é”™è¯¯ï¼šæœªè®¾ç½®æ­£ç¡®çš„æŒ‚è½½ä¼ æ’­ç±»å‹
   - åæœï¼šå®¹å™¨å†…æŒ‚è½½å½±å“ä¸»æœº
   - è§£å†³ï¼šä½¿ç”¨ MS_PRIVATE æˆ– MS_SLAVE é˜²æ­¢ä¼ æ’­</p>
</li>
</ol>
<h3 id="cgroups">Cgroups ç›¸å…³</h3>
<ol start="4">
<li>
<p><strong>Cgroups v1/v2 æ··ç”¨</strong>
   - é”™è¯¯ï¼šåŒæ—¶ä½¿ç”¨ v1 å’Œ v2 æ§åˆ¶å™¨
   - åæœï¼šè¡Œä¸ºä¸å¯é¢„æµ‹ï¼ŒæŸäº›æ§åˆ¶å™¨å¤±æ•ˆ
   - è§£å†³ï¼šé€‰æ‹©ä¸€ä¸ªç‰ˆæœ¬ï¼Œé¿å…æ··ç”¨</p>
</li>
<li>
<p><strong>å†…å­˜é™åˆ¶ä¸ OOM</strong>
   - é”™è¯¯ï¼šè®¾ç½®è¿‡ä½çš„å†…å­˜é™åˆ¶
   - åæœï¼šé¢‘ç¹ OOMï¼Œå®¹å™¨è¢«æ€
   - è§£å†³ï¼šç›‘æ§å†…å­˜ä½¿ç”¨ï¼Œè®¾ç½®åˆç†çš„é™åˆ¶å’Œ swap</p>
</li>
</ol>
<h3 id="_8">ç½‘ç»œç›¸å…³</h3>
<ol start="6">
<li><strong>veth è®¾å¤‡æ¸…ç†</strong>
   - é”™è¯¯ï¼šå®¹å™¨é€€å‡ºå veth è®¾å¤‡æ®‹ç•™
   - åæœï¼šè®¾å¤‡åå†²çªï¼Œèµ„æºæ³„éœ²
   - è§£å†³ï¼šç¡®ä¿å®¹å™¨é€€å‡ºæ—¶æ¸…ç†ç½‘ç»œèµ„æº</li>
</ol>
<h3 id="_9">å®‰å…¨ç›¸å…³</h3>
<ol start="7">
<li>
<p><strong>Capabilities è¿‡åº¦æˆæƒ</strong>
   - é”™è¯¯ï¼šä¿ç•™ CAP_SYS_ADMIN
   - åæœï¼šå®¹å™¨å¯ä»¥æ‰§è¡Œç‰¹æƒæ“ä½œ
   - è§£å†³ï¼šæœ€å°æƒé™åŸåˆ™ï¼Œåªä¿ç•™å¿…éœ€æƒèƒ½</p>
</li>
<li>
<p><strong>Seccomp è§„åˆ™é¡ºåº</strong>
   - é”™è¯¯ï¼šé»˜è®¤å…è®¸ï¼Œå†ç¦ç”¨ç‰¹å®šè°ƒç”¨
   - åæœï¼šæ–°çš„å±é™©è°ƒç”¨æœªè¢«è¿‡æ»¤
   - è§£å†³ï¼šé»˜è®¤æ‹’ç»ï¼Œç™½åå•å…è®¸</p>
</li>
</ol>
<h2 id="_10">æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•</h2>
<h3 id="_11">å®¹å™¨è®¾è®¡å®¡æŸ¥</h3>
<ul>
<li>[ ] <strong>èµ„æºé™åˆ¶</strong>ï¼šè®¾ç½®äº†å†…å­˜ã€CPUã€PID æ•°é‡é™åˆ¶</li>
<li>[ ] <strong>å®‰å…¨é…ç½®</strong>ï¼šå¯ç”¨ user namespaceï¼Œæ­£ç¡®é…ç½® UID æ˜ å°„</li>
<li>[ ] <strong>ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤</strong>ï¼šåº”ç”¨äº† seccomp è§„åˆ™</li>
<li>[ ] <strong>æƒèƒ½æœ€å°åŒ–</strong>ï¼šä»…ä¿ç•™å¿…è¦çš„ capabilities</li>
<li>[ ] <strong>æ–‡ä»¶ç³»ç»Ÿ</strong>ï¼šæ ¹æ–‡ä»¶ç³»ç»Ÿåªè¯»ï¼Œæ•æ„Ÿè·¯å¾„ä½¿ç”¨ tmpfs</li>
<li>[ ] <strong>ç½‘ç»œéš”ç¦»</strong>ï¼šç‹¬ç«‹ç½‘ç»œå‘½åç©ºé—´ï¼Œåˆç†çš„é˜²ç«å¢™è§„åˆ™</li>
</ul>
<h3 id="_12">æ€§èƒ½ä¼˜åŒ–å®¡æŸ¥</h3>
<ul>
<li>[ ] <strong>å¯åŠ¨ä¼˜åŒ–</strong>ï¼šé•œåƒå±‚ä¼˜åŒ–ï¼Œä½¿ç”¨ç¼“å­˜</li>
<li>[ ] <strong>ç½‘ç»œæ€§èƒ½</strong>ï¼šåˆç†é…ç½® veth é˜Ÿåˆ—å’Œç¼“å†²åŒº</li>
<li>[ ] <strong>å­˜å‚¨ä¼˜åŒ–</strong>ï¼šé€‰æ‹©åˆé€‚çš„å­˜å‚¨é©±åŠ¨ï¼ˆoverlay2ï¼‰</li>
<li>[ ] <strong>CPU äº²å’Œæ€§</strong>ï¼šå…³é”®å®¹å™¨ç»‘å®š CPU</li>
<li>[ ] <strong>å†…å­˜å±€éƒ¨æ€§</strong>ï¼šNUMA æ„ŸçŸ¥çš„å®¹å™¨è°ƒåº¦</li>
</ul>
<h3 id="_13">è¿ç»´å®è·µå®¡æŸ¥</h3>
<ul>
<li>[ ] <strong>æ—¥å¿—ç®¡ç†</strong>ï¼šæ—¥å¿—è½®è½¬ï¼Œé¿å…å¡«æ»¡ç£ç›˜</li>
<li>[ ] <strong>ç›‘æ§å‘Šè­¦</strong>ï¼šèµ„æºä½¿ç”¨ã€é”™è¯¯ç‡ç›‘æ§</li>
<li>[ ] <strong>å¤‡ä»½æ¢å¤</strong>ï¼šæ•°æ®æŒä¹…åŒ–ç­–ç•¥</li>
<li>[ ] <strong>æ›´æ–°ç­–ç•¥</strong>ï¼šæ»šåŠ¨æ›´æ–°ï¼Œå›æ»šæœºåˆ¶</li>
<li>[ ] <strong>æ•…éšœå¤„ç†</strong>ï¼šå¥åº·æ£€æŸ¥ï¼Œè‡ªåŠ¨é‡å¯</li>
<li>[ ] <strong>å®‰å…¨æ›´æ–°</strong>ï¼šåŠæ—¶æ›´æ–°åŸºç¡€é•œåƒå’Œè¿è¡Œæ—¶</li>
</ul>
            </article>
            
            <nav class="page-nav"><a href="chapter11.html" class="nav-link prev">â† ç¬¬11ç« ï¼šå¹¶å‘ç¼–ç¨‹æ¨¡å‹</a><a href="chapter13.html" class="nav-link next">ç¬¬13ç« ï¼šå®‰å…¨å­ç³»ç»Ÿ â†’</a></nav>
        </main>
    </div>
</body>
</html>