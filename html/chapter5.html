<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬5ç« ï¼šè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Linux å†…æ ¸æºä»£ç æ·±åº¦è§£æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬1ç« ï¼šLinux å†…æ ¸æ¦‚è¿°ä¸å‘å±•å²</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬2ç« ï¼šè¿›ç¨‹ç®¡ç†ä¸ä»»åŠ¡è°ƒåº¦</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬3ç« ï¼šå†…å­˜ç®¡ç†æ¶æ„</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬4ç« ï¼šè¿›ç¨‹é—´é€šä¿¡æœºåˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬5ç« ï¼šè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬6ç« ï¼šå…·ä½“æ–‡ä»¶ç³»ç»Ÿå®ç°</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬7ç« ï¼šå—è®¾å¤‡å±‚ä¸I/Oè°ƒåº¦</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬8ç« ï¼šè®¾å¤‡é©±åŠ¨æ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬9ç« ï¼šç½‘ç»œåè®®æ ˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬10ç« ï¼šå†…æ ¸åŒæ­¥æœºåˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬11ç« ï¼šå¹¶å‘ç¼–ç¨‹æ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬12ç« ï¼šå®¹å™¨ä¸å‘½åç©ºé—´</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬13ç« ï¼šå®‰å…¨å­ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬14ç« ï¼šå®æ—¶Linux</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬15ç« ï¼šæ€§èƒ½åˆ†æä¸è°ƒè¯•</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬16ç« ï¼šå¼•å¯¼è¿‡ç¨‹ä¸åˆå§‹åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="5vfs">ç¬¬5ç« ï¼šè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰</h1>
<h2 id="_1">ç« èŠ‚å¤§çº²</h2>
<ol>
<li>
<p><strong>å¼€ç¯‡ä¸VFSæ¦‚è¿°</strong>
   - VFSçš„è®¾è®¡å“²å­¦ä¸ç›®æ ‡
   - VFSåœ¨Linuxå†…æ ¸ä¸­çš„ä½ç½®
   - ç»Ÿä¸€æ–‡ä»¶æ¨¡å‹çš„é‡è¦æ€§</p>
</li>
<li>
<p><strong>VFSæ ¸å¿ƒæ¶æ„</strong>
   - 2.1 å››å¤§æ ¸å¿ƒå¯¹è±¡</p>
<ul>
<li>è¶…çº§å—ï¼ˆsuperblockï¼‰</li>
<li>ç´¢å¼•èŠ‚ç‚¹ï¼ˆinodeï¼‰</li>
<li>ç›®å½•é¡¹ï¼ˆdentryï¼‰</li>
<li>æ–‡ä»¶å¯¹è±¡ï¼ˆfileï¼‰</li>
<li>2.2 å¯¹è±¡é—´çš„å…³ç³»ä¸ç”Ÿå‘½å‘¨æœŸ</li>
<li>2.3 VFSæ“ä½œè¡¨ï¼ˆoperationsï¼‰</li>
</ul>
</li>
<li>
<p><strong>æ–‡ä»¶ç³»ç»Ÿæ³¨å†Œä¸æŒ‚è½½</strong>
   - 3.1 æ–‡ä»¶ç³»ç»Ÿç±»å‹æ³¨å†Œ
   - 3.2 æŒ‚è½½è¿‡ç¨‹åˆ†æ
   - 3.3 å‘½åç©ºé—´ä¸æŒ‚è½½ä¼ æ’­
   - 3.4 æ ¹æ–‡ä»¶ç³»ç»Ÿçš„ç‰¹æ®Šå¤„ç†</p>
</li>
<li>
<p><strong>è·¯å¾„åæŸ¥æ‰¾ä¸ç›®å½•é¡¹ç¼“å­˜</strong>
   - 4.1 è·¯å¾„è§£æç®—æ³•
   - 4.2 ç›®å½•é¡¹ç¼“å­˜ï¼ˆdcacheï¼‰æœºåˆ¶
   - 4.3 RCUè·¯å¾„éå†ä¼˜åŒ–
   - 4.4 ç¬¦å·é“¾æ¥å¤„ç†</p>
</li>
<li>
<p><strong>æ–‡ä»¶æ“ä½œæ¥å£å®ç°</strong>
   - 5.1 ç³»ç»Ÿè°ƒç”¨åˆ°VFSçš„æ˜ å°„
   - 5.2 æ–‡ä»¶æè¿°ç¬¦ç®¡ç†
   - 5.3 è¯»å†™æ“ä½œè·¯å¾„
   - 5.4 å†…å­˜æ˜ å°„ï¼ˆmmapï¼‰æ”¯æŒ</p>
</li>
<li>
<p><strong>ç®—æ³•ç„¦ç‚¹</strong>
   - å“ˆå¸Œè¡¨åœ¨dcacheä¸­çš„åº”ç”¨
   - LRUç¼“å­˜ç®¡ç†ç­–ç•¥
   - RCUåœ¨è·¯å¾„æŸ¥æ‰¾ä¸­çš„åº”ç”¨
   - è´Ÿç›®å½•é¡¹ï¼ˆnegative dentryï¼‰ä¼˜åŒ–</p>
</li>
<li>
<p><strong>å†å²æ•…äº‹</strong>
   - VFSå±‚çš„è¯ç”Ÿä¸æ¼”è¿›
   - Al Viroçš„VFSé‡æ„è´¡çŒ®
   - ä»å•ä¸€æ–‡ä»¶ç³»ç»Ÿåˆ°å¤šæ–‡ä»¶ç³»ç»Ÿæ”¯æŒ</p>
</li>
<li>
<p><strong>é«˜çº§è¯é¢˜</strong>
   - overlayfsä¸å®¹å™¨å­˜å‚¨
   - FUSEç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿ
   - VFSå±‚çš„å¹¶å‘ä¼˜åŒ–
   - å»¶è¿Ÿåˆ†é…ä¸é¢„è¯»ç­–ç•¥</p>
</li>
</ol>
<h2 id="_2">æœ¬ç« å­¦ä¹ ç›®æ ‡</h2>
<p>å®Œæˆæœ¬ç« å­¦ä¹ åï¼Œæ‚¨å°†èƒ½å¤Ÿï¼š</p>
<ol>
<li>ç†è§£VFSçš„æŠ½è±¡å±‚è®¾è®¡åŠå…¶åœ¨å†…æ ¸ä¸­çš„æ ¸å¿ƒä½œç”¨</li>
<li>æŒæ¡VFSå››å¤§å¯¹è±¡çš„æ•°æ®ç»“æ„å’Œç›¸äº’å…³ç³»</li>
<li>åˆ†ææ–‡ä»¶ç³»ç»ŸæŒ‚è½½å’Œè·¯å¾„æŸ¥æ‰¾çš„å®ç°æœºåˆ¶</li>
<li>ç†è§£dcacheçš„ä¼˜åŒ–ç­–ç•¥å’ŒRCUçš„åº”ç”¨</li>
<li>æŒæ¡ä»ç³»ç»Ÿè°ƒç”¨åˆ°å…·ä½“æ–‡ä»¶ç³»ç»Ÿçš„å®Œæ•´è°ƒç”¨é“¾</li>
<li>èƒ½å¤Ÿå®ç°ç®€å•çš„è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ</li>
</ol>
<hr />
<h2 id="1">1. å¼•è¨€</h2>
<p>è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVirtual File Systemï¼ŒVFSï¼‰æ˜¯Linuxå†…æ ¸ä¸­æœ€ä¼˜é›…çš„è®¾è®¡ä¹‹ä¸€ã€‚å®ƒé€šè¿‡åœ¨ç”¨æˆ·ç©ºé—´å’Œå…·ä½“æ–‡ä»¶ç³»ç»Ÿå®ç°ä¹‹é—´å»ºç«‹ä¸€ä¸ªæŠ½è±¡å±‚ï¼Œä½¿å¾—Linuxèƒ½å¤Ÿæ”¯æŒæ•°åç§ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿï¼Œä»ä¼ ç»Ÿçš„ext4ã€XFSï¼Œåˆ°ç½‘ç»œæ–‡ä»¶ç³»ç»ŸNFSã€SMBï¼Œå†åˆ°ç‰¹æ®Šç”¨é€”çš„procã€sysfsï¼Œæ‰€æœ‰è¿™äº›éƒ½èƒ½é€šè¿‡ç»Ÿä¸€çš„æ¥å£è¢«è®¿é—®ã€‚æœ¬ç« å°†æ·±å…¥å‰–æVFSçš„è®¾è®¡ç†å¿µã€æ ¸å¿ƒæ•°æ®ç»“æ„ã€å…³é”®ç®—æ³•ä»¥åŠæ€§èƒ½ä¼˜åŒ–æŠ€æœ¯ï¼Œå¸®åŠ©æ‚¨ç†è§£Linuxå¦‚ä½•å®ç°"ä¸€åˆ‡çš†æ–‡ä»¶"çš„è®¾è®¡å“²å­¦ã€‚</p>
<h2 id="2-vfs">2. VFSæ ¸å¿ƒæ¶æ„</h2>
<h3 id="21-vfs">2.1 VFSçš„è®¾è®¡å“²å­¦</h3>
<p>VFSçš„æ ¸å¿ƒè®¾è®¡ç›®æ ‡æ˜¯æä¾›ä¸€ä¸ªç»Ÿä¸€çš„æ–‡ä»¶è®¿é—®æ¥å£ï¼Œéšè—åº•å±‚æ–‡ä»¶ç³»ç»Ÿçš„å®ç°ç»†èŠ‚ã€‚è¿™ç§æŠ½è±¡å¸¦æ¥äº†ä¸‰ä¸ªå…³é”®ä¼˜åŠ¿ï¼š</p>
<ol>
<li><strong>é€æ˜æ€§</strong>ï¼šåº”ç”¨ç¨‹åºæ— éœ€å…³å¿ƒæ–‡ä»¶å­˜å‚¨åœ¨å“ªç§æ–‡ä»¶ç³»ç»Ÿä¸Š</li>
<li><strong>å¯æ‰©å±•æ€§</strong>ï¼šæ–°æ–‡ä»¶ç³»ç»Ÿå¯ä»¥é€šè¿‡å®ç°VFSæ¥å£è½»æ¾é›†æˆ</li>
<li><strong>ä¸€è‡´æ€§</strong>ï¼šæ‰€æœ‰æ–‡ä»¶æ“ä½œéµå¾ªç›¸åŒçš„è¯­ä¹‰å’Œé”™è¯¯å¤„ç†æœºåˆ¶</li>
</ol>
<p>VFSåœ¨å†…æ ¸ä¸­çš„ä½ç½®å¯ä»¥ç”¨ä»¥ä¸‹ASCIIå›¾è¡¨ç¤ºï¼š</p>
<div class="codehilite"><pre><span></span><code>    ç”¨æˆ·ç©ºé—´åº”ç”¨ç¨‹åº
         |
    ç³»ç»Ÿè°ƒç”¨æ¥å£ (open, read, write, close...)
         |
    +---------+
    |   VFS   |  &lt;--- æŠ½è±¡å±‚
    +---------+
         |
    +----+----+----+----+
    |    |    |    |    |
   ext4 XFS  NFS proc tmpfs  &lt;--- å…·ä½“æ–‡ä»¶ç³»ç»Ÿ
</code></pre></div>

<h3 id="22">2.2 å››å¤§æ ¸å¿ƒå¯¹è±¡</h3>
<p>VFSé€šè¿‡å››ä¸ªæ ¸å¿ƒå¯¹è±¡æ¥æŠ½è±¡æ–‡ä»¶ç³»ç»Ÿçš„æ¦‚å¿µï¼š</p>
<h4 id="221-struct-super_block">2.2.1 è¶…çº§å—ï¼ˆstruct super_blockï¼‰</h4>
<p>è¶…çº§å—ä»£è¡¨ä¸€ä¸ªå·²æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿå®ä¾‹ï¼ŒåŒ…å«æ–‡ä»¶ç³»ç»Ÿçš„å…¨å±€ä¿¡æ¯ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w">    </span><span class="n">s_list</span><span class="p">;</span><span class="w">        </span><span class="cm">/* è¶…çº§å—é“¾è¡¨ */</span>
<span class="w">    </span><span class="kt">dev_t</span><span class="w">               </span><span class="n">s_dev</span><span class="p">;</span><span class="w">         </span><span class="cm">/* è®¾å¤‡æ ‡è¯†ç¬¦ */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w">       </span><span class="n">s_blocksize_bits</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">       </span><span class="n">s_blocksize</span><span class="p">;</span><span class="w">   </span><span class="cm">/* å—å¤§å° */</span>
<span class="w">    </span><span class="n">loff_t</span><span class="w">              </span><span class="n">s_maxbytes</span><span class="p">;</span><span class="w">    </span><span class="cm">/* æœ€å¤§æ–‡ä»¶å¤§å° */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_system_type</span><span class="w"> </span><span class="o">*</span><span class="n">s_type</span><span class="p">;</span><span class="w">   </span><span class="cm">/* æ–‡ä»¶ç³»ç»Ÿç±»å‹ */</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">super_operations</span><span class="w"> </span><span class="o">*</span><span class="n">s_op</span><span class="p">;</span><span class="w"> </span><span class="cm">/* è¶…çº§å—æ“ä½œè¡¨ */</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">       </span><span class="n">s_flags</span><span class="p">;</span><span class="w">       </span><span class="cm">/* æŒ‚è½½æ ‡å¿— */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">       </span><span class="n">s_magic</span><span class="p">;</span><span class="w">       </span><span class="cm">/* é­”æ•° */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w">       </span><span class="o">*</span><span class="n">s_root</span><span class="p">;</span><span class="w">       </span><span class="cm">/* æ ¹ç›®å½•é¡¹ */</span>

<span class="w">    </span><span class="kt">int</span><span class="w">                 </span><span class="n">s_count</span><span class="p">;</span><span class="w">       </span><span class="cm">/* å¼•ç”¨è®¡æ•° */</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w">            </span><span class="n">s_active</span><span class="p">;</span><span class="w">      </span><span class="cm">/* æ´»åŠ¨å¼•ç”¨è®¡æ•° */</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w">    </span><span class="n">s_inodes</span><span class="p">;</span><span class="w">      </span><span class="cm">/* inodeé“¾è¡¨ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w">    </span><span class="n">s_dirty</span><span class="p">;</span><span class="w">       </span><span class="cm">/* è„inodeé“¾è¡¨ */</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">block_device</span><span class="w"> </span><span class="o">*</span><span class="n">s_bdev</span><span class="p">;</span><span class="w">       </span><span class="cm">/* å—è®¾å¤‡ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">backing_dev_info</span><span class="w"> </span><span class="o">*</span><span class="n">s_bdi</span><span class="p">;</span><span class="w">    </span><span class="cm">/* åå¤‡è®¾å¤‡ä¿¡æ¯ */</span>

<span class="w">    </span><span class="kt">void</span><span class="w">                </span><span class="o">*</span><span class="n">s_fs_info</span><span class="p">;</span><span class="w">    </span><span class="cm">/* æ–‡ä»¶ç³»ç»Ÿç§æœ‰ä¿¡æ¯ */</span>

<span class="w">    </span><span class="cm">/* é…é¢ã€å®‰å…¨ç­‰å…¶ä»–å­—æ®µ... */</span>
<span class="p">};</span>
</code></pre></div>

<p>è¶…çº§å—æ“ä½œè¡¨ï¼ˆsuper_operationsï¼‰å®šä¹‰äº†æ–‡ä»¶ç³»ç»Ÿçº§åˆ«çš„æ“ä½œï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">super_operations</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">alloc_inode</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="o">*</span><span class="n">sb</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">destroy_inode</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">dirty_inode</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">write_inode</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">writeback_control</span><span class="w"> </span><span class="o">*</span><span class="n">wbc</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">drop_inode</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">evict_inode</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">put_super</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">sync_fs</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="o">*</span><span class="n">sb</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">wait</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">statfs</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">kstatfs</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">remount_fs</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="cm">/* æ›´å¤šæ“ä½œ... */</span>
<span class="p">};</span>
</code></pre></div>

<h4 id="222-struct-inode">2.2.2 ç´¢å¼•èŠ‚ç‚¹ï¼ˆstruct inodeï¼‰</h4>
<p>inodeä»£è¡¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä¸€ä¸ªå¯¹è±¡ï¼ˆæ–‡ä»¶ã€ç›®å½•ã€è®¾å¤‡ç­‰ï¼‰ï¼ŒåŒ…å«å¯¹è±¡çš„å…ƒæ•°æ®ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">umode_t</span><span class="w">             </span><span class="n">i_mode</span><span class="p">;</span><span class="w">        </span><span class="cm">/* æ–‡ä»¶ç±»å‹å’Œæƒé™ */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">short</span><span class="w">      </span><span class="n">i_opflags</span><span class="p">;</span>
<span class="w">    </span><span class="n">kuid_t</span><span class="w">              </span><span class="n">i_uid</span><span class="p">;</span><span class="w">         </span><span class="cm">/* æ‰€æœ‰è€…ç”¨æˆ·ID */</span>
<span class="w">    </span><span class="n">kgid_t</span><span class="w">              </span><span class="n">i_gid</span><span class="p">;</span><span class="w">         </span><span class="cm">/* æ‰€æœ‰è€…ç»„ID */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">        </span><span class="n">i_flags</span><span class="p">;</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode_operations</span><span class="w"> </span><span class="o">*</span><span class="n">i_op</span><span class="p">;</span><span class="w">  </span><span class="cm">/* inodeæ“ä½œè¡¨ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w">  </span><span class="o">*</span><span class="n">i_sb</span><span class="p">;</span><span class="w">         </span><span class="cm">/* æ‰€å±è¶…çº§å— */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">address_space</span><span class="w"> </span><span class="o">*</span><span class="n">i_mapping</span><span class="p">;</span><span class="w">   </span><span class="cm">/* é¡µç¼“å­˜æ˜ å°„ */</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">       </span><span class="n">i_ino</span><span class="p">;</span><span class="w">         </span><span class="cm">/* inodeå· */</span>
<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i_nlink</span><span class="p">;</span><span class="w">    </span><span class="cm">/* ç¡¬é“¾æ¥è®¡æ•° */</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__i_nlink</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="kt">dev_t</span><span class="w">               </span><span class="n">i_rdev</span><span class="p">;</span><span class="w">        </span><span class="cm">/* è®¾å¤‡å·ï¼ˆè®¾å¤‡æ–‡ä»¶ï¼‰ */</span>
<span class="w">    </span><span class="n">loff_t</span><span class="w">              </span><span class="n">i_size</span><span class="p">;</span><span class="w">        </span><span class="cm">/* æ–‡ä»¶å¤§å° */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec64</span><span class="w">   </span><span class="n">i_atime</span><span class="p">;</span><span class="w">       </span><span class="cm">/* è®¿é—®æ—¶é—´ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec64</span><span class="w">   </span><span class="n">i_mtime</span><span class="p">;</span><span class="w">       </span><span class="cm">/* ä¿®æ”¹æ—¶é—´ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec64</span><span class="w">   </span><span class="n">i_ctime</span><span class="p">;</span><span class="w">       </span><span class="cm">/* çŠ¶æ€æ”¹å˜æ—¶é—´ */</span>

<span class="w">    </span><span class="n">spinlock_t</span><span class="w">          </span><span class="n">i_lock</span><span class="p">;</span><span class="w">        </span><span class="cm">/* ä¿æŠ¤inodeçš„è‡ªæ—‹é” */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">short</span><span class="w">      </span><span class="n">i_bytes</span><span class="p">;</span><span class="w">       </span><span class="cm">/* æœ€åä¸€ä¸ªå—çš„å­—èŠ‚æ•° */</span>
<span class="w">    </span><span class="n">u8</span><span class="w">                  </span><span class="n">i_blkbits</span><span class="p">;</span><span class="w">     </span><span class="cm">/* å—å¤§å°çš„ä½æ•° */</span>

<span class="w">    </span><span class="n">atomic_t</span><span class="w">            </span><span class="n">i_count</span><span class="p">;</span><span class="w">       </span><span class="cm">/* å¼•ç”¨è®¡æ•° */</span>

<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">pipe_inode_info</span><span class="w"> </span><span class="o">*</span><span class="n">i_pipe</span><span class="p">;</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">block_device</span><span class="w"> </span><span class="o">*</span><span class="n">i_bdev</span><span class="p">;</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">cdev</span><span class="w">         </span><span class="o">*</span><span class="n">i_cdev</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_operations</span><span class="w"> </span><span class="o">*</span><span class="n">i_fop</span><span class="p">;</span><span class="w">  </span><span class="cm">/* æ–‡ä»¶æ“ä½œè¡¨ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_lock_context</span><span class="w"> </span><span class="o">*</span><span class="n">i_flctx</span><span class="p">;</span><span class="w">    </span><span class="cm">/* æ–‡ä»¶é”ä¸Šä¸‹æ–‡ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">address_space</span><span class="w"> </span><span class="n">i_data</span><span class="p">;</span><span class="w">          </span><span class="cm">/* è®¾å¤‡çš„åœ°å€ç©ºé—´ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w">    </span><span class="n">i_devices</span><span class="p">;</span><span class="w">        </span><span class="cm">/* è®¾å¤‡é“¾è¡¨ */</span>

<span class="w">    </span><span class="kt">void</span><span class="w">                </span><span class="o">*</span><span class="n">i_private</span><span class="p">;</span><span class="w">       </span><span class="cm">/* æ–‡ä»¶ç³»ç»Ÿç§æœ‰æ•°æ® */</span>
<span class="p">};</span>
</code></pre></div>

<h4 id="223-struct-dentry">2.2.3 ç›®å½•é¡¹ï¼ˆstruct dentryï¼‰</h4>
<p>ç›®å½•é¡¹æ˜¯è·¯å¾„åçš„ä¸€ä¸ªç»„æˆéƒ¨åˆ†ï¼Œå®ƒå°†æ–‡ä»¶åä¸å¯¹åº”çš„inodeå…³è”èµ·æ¥ã€‚ç›®å½•é¡¹çš„è®¾è®¡æ˜¯VFSæ€§èƒ½ä¼˜åŒ–çš„å…³é”®ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">        </span><span class="n">d_flags</span><span class="p">;</span><span class="w">       </span><span class="cm">/* ç›®å½•é¡¹æ ‡å¿— */</span>
<span class="w">    </span><span class="n">seqcount_spinlock_t</span><span class="w"> </span><span class="n">d_seq</span><span class="p">;</span><span class="w">         </span><span class="cm">/* ç”¨äºRCUæŸ¥æ‰¾çš„åºåˆ—è®¡æ•°å™¨ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_bl_node</span><span class="w"> </span><span class="n">d_hash</span><span class="p">;</span><span class="w">       </span><span class="cm">/* å“ˆå¸Œè¡¨é“¾æ¥ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w">       </span><span class="o">*</span><span class="n">d_parent</span><span class="p">;</span><span class="w">     </span><span class="cm">/* çˆ¶ç›®å½•é¡¹ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">qstr</span><span class="w">         </span><span class="n">d_name</span><span class="p">;</span><span class="w">        </span><span class="cm">/* æ–‡ä»¶å */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w">        </span><span class="o">*</span><span class="n">d_inode</span><span class="p">;</span><span class="w">      </span><span class="cm">/* å…³è”çš„inode */</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w">       </span><span class="n">d_iname</span><span class="p">[</span><span class="n">DNAME_INLINE_LEN</span><span class="p">];</span><span class="w"> </span><span class="cm">/* çŸ­æ–‡ä»¶åä¼˜åŒ– */</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lockref</span><span class="w">      </span><span class="n">d_lockref</span><span class="p">;</span><span class="w">     </span><span class="cm">/* å¼•ç”¨è®¡æ•°å’Œè‡ªæ—‹é” */</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry_operations</span><span class="w"> </span><span class="o">*</span><span class="n">d_op</span><span class="p">;</span><span class="w">  </span><span class="cm">/* ç›®å½•é¡¹æ“ä½œè¡¨ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w">  </span><span class="o">*</span><span class="n">d_sb</span><span class="p">;</span><span class="w">         </span><span class="cm">/* æ‰€å±è¶…çº§å— */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">       </span><span class="n">d_time</span><span class="p">;</span><span class="w">        </span><span class="cm">/* é‡éªŒè¯æ—¶é—´ */</span>
<span class="w">    </span><span class="kt">void</span><span class="w">                </span><span class="o">*</span><span class="n">d_fsdata</span><span class="p">;</span><span class="w">     </span><span class="cm">/* æ–‡ä»¶ç³»ç»Ÿç§æœ‰æ•°æ® */</span>

<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">d_lru</span><span class="p">;</span><span class="w">        </span><span class="cm">/* LRUé“¾è¡¨ */</span>
<span class="w">        </span><span class="n">wait_queue_head_t</span><span class="w"> </span><span class="o">*</span><span class="n">d_wait</span><span class="p">;</span><span class="w">     </span><span class="cm">/* ç­‰å¾…é˜Ÿåˆ— */</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w">    </span><span class="n">d_child</span><span class="p">;</span><span class="w">       </span><span class="cm">/* çˆ¶ç›®å½•çš„å­é¡¹é“¾è¡¨ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w">    </span><span class="n">d_subdirs</span><span class="p">;</span><span class="w">     </span><span class="cm">/* å­ç›®å½•é“¾è¡¨ */</span>

<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_node</span><span class="w"> </span><span class="n">d_alias</span><span class="p">;</span><span class="w">     </span><span class="cm">/* inodeåˆ«åé“¾è¡¨ */</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_bl_node</span><span class="w"> </span><span class="n">d_in_lookup_hash</span><span class="p">;</span><span class="w"> </span><span class="cm">/* æŸ¥æ‰¾å“ˆå¸Œè¡¨ */</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">rcu_head</span><span class="w"> </span><span class="n">d_rcu</span><span class="p">;</span><span class="w">         </span><span class="cm">/* RCUå›æ”¶å¤´ */</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">d_u</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>

<p>ç›®å½•é¡¹æœ‰ä¸‰ç§çŠ¶æ€ï¼š</p>
<ul>
<li><strong>ä½¿ç”¨ä¸­ï¼ˆin useï¼‰</strong>ï¼šd_inodeæŒ‡å‘æœ‰æ•ˆinodeï¼Œå¼•ç”¨è®¡æ•°&gt;0</li>
<li><strong>æœªä½¿ç”¨ï¼ˆunusedï¼‰</strong>ï¼šd_inodeæŒ‡å‘æœ‰æ•ˆinodeï¼Œå¼•ç”¨è®¡æ•°=0ï¼Œä¿ç•™åœ¨ç¼“å­˜ä¸­</li>
<li><strong>è´Ÿç›®å½•é¡¹ï¼ˆnegativeï¼‰</strong>ï¼šd_inodeä¸ºNULLï¼Œè¡¨ç¤ºä¸å­˜åœ¨çš„æ–‡ä»¶ï¼Œç”¨äºåŠ é€ŸæŸ¥æ‰¾å¤±è´¥</li>
</ul>
<h4 id="224-struct-file">2.2.4 æ–‡ä»¶å¯¹è±¡ï¼ˆstruct fileï¼‰</h4>
<p>æ–‡ä»¶å¯¹è±¡ä»£è¡¨è¿›ç¨‹æ‰“å¼€çš„ä¸€ä¸ªæ–‡ä»¶ï¼ŒåŒ…å«æ–‡ä»¶çš„å½“å‰çŠ¶æ€ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">llist_node</span><span class="w">   </span><span class="n">fu_llist</span><span class="p">;</span><span class="w">   </span><span class="cm">/* æ–‡ä»¶å¯¹è±¡é“¾è¡¨ */</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">rcu_head</span><span class="w">     </span><span class="n">fu_rcuhead</span><span class="p">;</span><span class="w"> </span><span class="cm">/* RCUå›æ”¶å¤´ */</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">f_u</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">path</span><span class="w">         </span><span class="n">f_path</span><span class="p">;</span><span class="w">        </span><span class="cm">/* åŒ…å«dentryå’Œvfsmount */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w">        </span><span class="o">*</span><span class="n">f_inode</span><span class="p">;</span><span class="w">      </span><span class="cm">/* ç¼“å­˜çš„inodeæŒ‡é’ˆ */</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_operations</span><span class="w"> </span><span class="o">*</span><span class="n">f_op</span><span class="p">;</span><span class="w"> </span><span class="cm">/* æ–‡ä»¶æ“ä½œè¡¨ */</span>

<span class="w">    </span><span class="n">spinlock_t</span><span class="w">          </span><span class="n">f_lock</span><span class="p">;</span><span class="w">        </span><span class="cm">/* ä¿æŠ¤æ–‡ä»¶å¯¹è±¡çš„é” */</span>
<span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="n">rw_hint</span><span class="w">        </span><span class="n">f_write_hint</span><span class="p">;</span><span class="w">  </span><span class="cm">/* å†™å…¥æç¤º */</span>
<span class="w">    </span><span class="n">atomic_long_t</span><span class="w">       </span><span class="n">f_count</span><span class="p">;</span><span class="w">       </span><span class="cm">/* å¼•ç”¨è®¡æ•° */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">        </span><span class="n">f_flags</span><span class="p">;</span><span class="w">       </span><span class="cm">/* æ–‡ä»¶æ ‡å¿—ï¼ˆO_RDONLYç­‰ï¼‰ */</span>
<span class="w">    </span><span class="n">fmode_t</span><span class="w">             </span><span class="n">f_mode</span><span class="p">;</span><span class="w">        </span><span class="cm">/* æ–‡ä»¶æ¨¡å¼ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mutex</span><span class="w">        </span><span class="n">f_pos_lock</span><span class="p">;</span><span class="w">    </span><span class="cm">/* ä¿æŠ¤f_pos */</span>
<span class="w">    </span><span class="n">loff_t</span><span class="w">              </span><span class="n">f_pos</span><span class="p">;</span><span class="w">         </span><span class="cm">/* æ–‡ä»¶ä½ç½® */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">fown_struct</span><span class="w">  </span><span class="n">f_owner</span><span class="p">;</span><span class="w">       </span><span class="cm">/* å¼‚æ­¥I/Oçš„æ‰€æœ‰è€… */</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">cred</span><span class="w">   </span><span class="o">*</span><span class="n">f_cred</span><span class="p">;</span><span class="w">       </span><span class="cm">/* æ‰“å¼€æ–‡ä»¶æ—¶çš„å‡­è¯ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_ra_state</span><span class="w"> </span><span class="n">f_ra</span><span class="p">;</span><span class="w">         </span><span class="cm">/* é¢„è¯»çŠ¶æ€ */</span>

<span class="w">    </span><span class="n">u64</span><span class="w">                 </span><span class="n">f_version</span><span class="p">;</span><span class="w">     </span><span class="cm">/* ç‰ˆæœ¬å· */</span>
<span class="w">    </span><span class="kt">void</span><span class="w">                </span><span class="o">*</span><span class="n">private_data</span><span class="p">;</span><span class="w"> </span><span class="cm">/* ç§æœ‰æ•°æ® */</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">address_space</span><span class="w"> </span><span class="o">*</span><span class="n">f_mapping</span><span class="p">;</span><span class="w">   </span><span class="cm">/* é¡µç¼“å­˜æ˜ å°„ */</span>
<span class="w">    </span><span class="n">errseq_t</span><span class="w">            </span><span class="n">f_wb_err</span><span class="p">;</span><span class="w">      </span><span class="cm">/* å†™å›é”™è¯¯ */</span>
<span class="w">    </span><span class="n">errseq_t</span><span class="w">            </span><span class="n">f_sb_err</span><span class="p">;</span><span class="w">      </span><span class="cm">/* è¶…çº§å—é”™è¯¯ */</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="23-vfs">2.3 VFSæ“ä½œè¡¨</h3>
<p>VFSé€šè¿‡æ“ä½œè¡¨ï¼ˆoperations structureï¼‰å®ç°å¤šæ€æ€§ã€‚æ¯ä¸ªå¯¹è±¡éƒ½æœ‰å¯¹åº”çš„æ“ä½œè¡¨ï¼š</p>
<ol>
<li><strong>super_operations</strong>ï¼šæ–‡ä»¶ç³»ç»Ÿçº§æ“ä½œï¼ˆåˆ›å»º/åˆ é™¤inodeã€åŒæ­¥ç­‰ï¼‰</li>
<li><strong>inode_operations</strong>ï¼šinodeçº§æ“ä½œï¼ˆåˆ›å»ºã€åˆ é™¤ã€æŸ¥æ‰¾ç­‰ï¼‰</li>
<li><strong>dentry_operations</strong>ï¼šç›®å½•é¡¹æ“ä½œï¼ˆæ¯”è¾ƒã€å“ˆå¸Œã€éªŒè¯ç­‰ï¼‰</li>
<li><strong>file_operations</strong>ï¼šæ–‡ä»¶æ“ä½œï¼ˆè¯»ã€å†™ã€æ‰“å¼€ã€å…³é—­ç­‰ï¼‰</li>
<li><strong>address_space_operations</strong>ï¼šåœ°å€ç©ºé—´æ“ä½œï¼ˆé¡µé¢è¯»å†™ã€å†…å­˜æ˜ å°„ç­‰ï¼‰</li>
</ol>
<p>è¿™ç§è®¾è®¡å…è®¸ä¸åŒæ–‡ä»¶ç³»ç»Ÿæä¾›è‡ªå·±çš„å®ç°ï¼ŒåŒæ—¶ä¿æŒæ¥å£çš„ä¸€è‡´æ€§ã€‚</p>
<h3 id="24">2.4 å¯¹è±¡é—´çš„å…³ç³»</h3>
<p>VFSå¯¹è±¡ä¹‹é—´å­˜åœ¨å¤æ‚çš„å¼•ç”¨å…³ç³»ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nx">super_block</span>
<span class="w">         </span><span class="o">|</span>
<span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="nx">s_root</span>
<span class="w">         </span><span class="err">â†“</span>
<span class="w">      </span><span class="nx">dentry</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="p">)</span>
<span class="w">         </span><span class="o">|</span>
<span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="nx">d_inode</span>
<span class="w">         </span><span class="err">â†“</span>
<span class="w">       </span><span class="nx">inode</span>
<span class="w">         </span><span class="o">|</span>
<span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="nx">i_mapping</span>
<span class="w">         </span><span class="err">â†“</span>
<span class="w">   </span><span class="nx">address_space</span>

<span class="w">   </span><span class="nx">è¿›ç¨‹</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="nx">dentry</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="nx">inode</span>
<span class="w">             </span><span class="err">â†“</span>
<span class="w">          </span><span class="nx">f_path</span><span class="p">.</span><span class="nx">mnt</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="nx">vfsmount</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="nx">super_block</span>
</code></pre></div>

<p>è¿™äº›å…³ç³»ç¡®ä¿äº†ï¼š</p>
<ul>
<li>æ–‡ä»¶ç³»ç»Ÿçš„å±‚æ¬¡ç»“æ„</li>
<li>å¼•ç”¨è®¡æ•°çš„æ­£ç¡®ç®¡ç†</li>
<li>å†…å­˜å›æ”¶çš„å®‰å…¨æ€§</li>
<li>å¹¶å‘è®¿é—®çš„ä¸€è‡´æ€§</li>
</ul>
<h2 id="3">3. æ–‡ä»¶ç³»ç»Ÿæ³¨å†Œä¸æŒ‚è½½</h2>
<h3 id="31">3.1 æ–‡ä»¶ç³»ç»Ÿç±»å‹æ³¨å†Œ</h3>
<p>Linuxæ”¯æŒçš„æ¯ç§æ–‡ä»¶ç³»ç»Ÿéƒ½å¿…é¡»å…ˆæ³¨å†Œåˆ°å†…æ ¸ä¸­ã€‚æ–‡ä»¶ç³»ç»Ÿç±»å‹ç”±<code>struct file_system_type</code>è¡¨ç¤ºï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">file_system_type</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span><span class="w">               </span><span class="cm">/* æ–‡ä»¶ç³»ç»Ÿåç§° */</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fs_flags</span><span class="p">;</span><span class="w">                   </span><span class="cm">/* æ–‡ä»¶ç³»ç»Ÿæ ‡å¿— */</span>
<span class="cp">#define FS_REQUIRES_DEV         1   </span><span class="cm">/* éœ€è¦å—è®¾å¤‡ */</span>
<span class="cp">#define FS_BINARY_MOUNTDATA     2   </span><span class="cm">/* äºŒè¿›åˆ¶æŒ‚è½½æ•°æ® */</span>
<span class="cp">#define FS_HAS_SUBTYPE          4   </span><span class="cm">/* æœ‰å­ç±»å‹ */</span>
<span class="cp">#define FS_USERNS_MOUNT         8   </span><span class="cm">/* å¯åœ¨ç”¨æˆ·å‘½åç©ºé—´æŒ‚è½½ */</span>
<span class="cp">#define FS_DISALLOW_NOTIFY_PERM 16  </span><span class="cm">/* ç¦ç”¨fanotifyæƒé™äº‹ä»¶ */</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">mount</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file_system_type</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span>
<span class="w">                           </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">kill_sb</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">super_block</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">module</span><span class="w"> </span><span class="o">*</span><span class="n">owner</span><span class="p">;</span><span class="w">           </span><span class="cm">/* æ‰€å±æ¨¡å— */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_system_type</span><span class="w"> </span><span class="o">*</span><span class="n">next</span><span class="p">;</span><span class="w">  </span><span class="cm">/* é“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ª */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_head</span><span class="w"> </span><span class="n">fs_supers</span><span class="p">;</span><span class="w">    </span><span class="cm">/* è¯¥ç±»å‹çš„è¶…çº§å—é“¾è¡¨ */</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lock_class_key</span><span class="w"> </span><span class="n">s_lock_key</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lock_class_key</span><span class="w"> </span><span class="n">s_umount_key</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lock_class_key</span><span class="w"> </span><span class="n">s_vfs_rename_key</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lock_class_key</span><span class="w"> </span><span class="n">s_writers_key</span><span class="p">[</span><span class="n">SB_FREEZE_LEVELS</span><span class="p">];</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lock_class_key</span><span class="w"> </span><span class="n">i_lock_key</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lock_class_key</span><span class="w"> </span><span class="n">i_mutex_key</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">lock_class_key</span><span class="w"> </span><span class="n">i_mutex_dir_key</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>

<p>æ–‡ä»¶ç³»ç»Ÿæ³¨å†Œé€šè¿‡<code>register_filesystem()</code>å®Œæˆï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">register_filesystem</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file_system_type</span><span class="w"> </span><span class="o">*</span><span class="n">fs</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_system_type</span><span class="w"> </span><span class="o">**</span><span class="n">p</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

<span class="w">    </span><span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file_systems_lock</span><span class="p">);</span>
<span class="w">    </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">find_filesystem</span><span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="w">        </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fs</span><span class="p">;</span>
<span class="w">    </span><span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file_systems_lock</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="32">3.2 æŒ‚è½½è¿‡ç¨‹åˆ†æ</h3>
<p>æ–‡ä»¶ç³»ç»ŸæŒ‚è½½æ˜¯å°†å­˜å‚¨è®¾å¤‡ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿè¿æ¥åˆ°ç›®å½•æ ‘çš„è¿‡ç¨‹ã€‚æŒ‚è½½æ¶‰åŠä»¥ä¸‹å…³é”®æ­¥éª¤ï¼š</p>
<h4 id="321">3.2.1 æŒ‚è½½ç³»ç»Ÿè°ƒç”¨</h4>
<div class="codehilite"><pre><span></span><code><span class="n">SYSCALL_DEFINE5</span><span class="p">(</span><span class="n">mount</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">dev_name</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">dir_name</span><span class="p">,</span>
<span class="w">                </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ksys_mount</span><span class="p">(</span><span class="n">dev_name</span><span class="p">,</span><span class="w"> </span><span class="n">dir_name</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="322">3.2.2 æŒ‚è½½è¿‡ç¨‹çš„æ ¸å¿ƒæ­¥éª¤</h4>
<ol>
<li><strong>è·¯å¾„æŸ¥æ‰¾</strong>ï¼šæ‰¾åˆ°æŒ‚è½½ç‚¹çš„dentry</li>
<li><strong>æ–‡ä»¶ç³»ç»ŸæŸ¥æ‰¾</strong>ï¼šæ ¹æ®ç±»å‹åæ‰¾åˆ°file_system_type</li>
<li><strong>è¶…çº§å—åˆ›å»º</strong>ï¼šè°ƒç”¨æ–‡ä»¶ç³»ç»Ÿçš„mountæ–¹æ³•åˆ›å»ºè¶…çº§å—</li>
<li><strong>æŒ‚è½½è¿æ¥</strong>ï¼šåˆ›å»ºmountç»“æ„ï¼Œè¿æ¥åˆ°æŒ‚è½½æ ‘</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">mount</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_node</span><span class="w"> </span><span class="n">mnt_hash</span><span class="p">;</span><span class="w">     </span><span class="cm">/* æŒ‚è½½å“ˆå¸Œè¡¨ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mount</span><span class="w"> </span><span class="o">*</span><span class="n">mnt_parent</span><span class="p">;</span><span class="w">        </span><span class="cm">/* çˆ¶æŒ‚è½½ç‚¹ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="n">mnt_mountpoint</span><span class="p">;</span><span class="w">   </span><span class="cm">/* æŒ‚è½½ç‚¹ç›®å½•é¡¹ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vfsmount</span><span class="w"> </span><span class="n">mnt</span><span class="p">;</span><span class="w">             </span><span class="cm">/* VFSæŒ‚è½½ä¿¡æ¯ */</span>

<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">rcu_head</span><span class="w"> </span><span class="n">mnt_rcu</span><span class="p">;</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">llist_node</span><span class="w"> </span><span class="n">mnt_llist</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mnt_pcp</span><span class="w"> </span><span class="n">__percpu</span><span class="w"> </span><span class="o">*</span><span class="n">mnt_pcp</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">mnt_mounts</span><span class="p">;</span><span class="w">    </span><span class="cm">/* å­æŒ‚è½½é“¾è¡¨ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">mnt_child</span><span class="p">;</span><span class="w">     </span><span class="cm">/* çˆ¶æŒ‚è½½çš„å­é¡¹ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">mnt_instance</span><span class="p">;</span><span class="w">  </span><span class="cm">/* æŒ‚è½½å®ä¾‹é“¾è¡¨ */</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">mnt_devname</span><span class="p">;</span><span class="w">        </span><span class="cm">/* è®¾å¤‡å */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">mnt_list</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">mnt_expire</span><span class="p">;</span><span class="w">    </span><span class="cm">/* è¿‡æœŸé“¾è¡¨ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">mnt_share</span><span class="p">;</span><span class="w">     </span><span class="cm">/* å…±äº«æŒ‚è½½é“¾è¡¨ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">mnt_slave_list</span><span class="p">;</span><span class="cm">/* ä»å±æŒ‚è½½é“¾è¡¨ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">mnt_slave</span><span class="p">;</span><span class="w">     </span><span class="cm">/* ä»å±é“¾è¡¨ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mount</span><span class="w"> </span><span class="o">*</span><span class="n">mnt_master</span><span class="p">;</span><span class="w">        </span><span class="cm">/* ä¸»æŒ‚è½½ç‚¹ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mnt_namespace</span><span class="w"> </span><span class="o">*</span><span class="n">mnt_ns</span><span class="p">;</span><span class="w">   </span><span class="cm">/* æŒ‚è½½å‘½åç©ºé—´ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mountpoint</span><span class="w"> </span><span class="o">*</span><span class="n">mnt_mp</span><span class="p">;</span><span class="w">      </span><span class="cm">/* æŒ‚è½½ç‚¹ */</span>
<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_node</span><span class="w"> </span><span class="n">mnt_mp_list</span><span class="p">;</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_node</span><span class="w"> </span><span class="n">mnt_umount</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">mnt_umounting</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">fsnotify_mark_connector</span><span class="w"> </span><span class="n">__rcu</span><span class="w"> </span><span class="o">*</span><span class="n">mnt_fsnotify_marks</span><span class="p">;</span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">mnt_fsnotify_mask</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mnt_id</span><span class="p">;</span><span class="w">                     </span><span class="cm">/* æŒ‚è½½ID */</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mnt_group_id</span><span class="p">;</span><span class="w">               </span><span class="cm">/* ç»„ID */</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mnt_expiry_mark</span><span class="p">;</span><span class="w">            </span><span class="cm">/* è¿‡æœŸæ ‡è®° */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_head</span><span class="w"> </span><span class="n">mnt_pins</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_head</span><span class="w"> </span><span class="n">mnt_stuck_children</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="33">3.3 å‘½åç©ºé—´ä¸æŒ‚è½½ä¼ æ’­</h3>
<p>Linuxæ”¯æŒæŒ‚è½½å‘½åç©ºé—´ï¼Œå…è®¸ä¸åŒè¿›ç¨‹çœ‹åˆ°ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿè§†å›¾ï¼š</p>
<h4 id="331">3.3.1 æŒ‚è½½å‘½åç©ºé—´</h4>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">mnt_namespace</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="w">                  </span><span class="cm">/* å¼•ç”¨è®¡æ•° */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ns_common</span><span class="w"> </span><span class="n">ns</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mount</span><span class="w"> </span><span class="o">*</span><span class="n">root</span><span class="p">;</span><span class="w">              </span><span class="cm">/* æ ¹æŒ‚è½½ç‚¹ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">list</span><span class="p">;</span><span class="w">           </span><span class="cm">/* æŒ‚è½½ç‚¹é“¾è¡¨ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">user_namespace</span><span class="w"> </span><span class="o">*</span><span class="n">user_ns</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ucounts</span><span class="w"> </span><span class="o">*</span><span class="n">ucounts</span><span class="p">;</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">seq</span><span class="p">;</span><span class="w">                         </span><span class="cm">/* åºåˆ—å· */</span>
<span class="w">    </span><span class="n">wait_queue_head_t</span><span class="w"> </span><span class="n">poll</span><span class="p">;</span>
<span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">event</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mounts</span><span class="p">;</span><span class="w">             </span><span class="cm">/* æŒ‚è½½ç‚¹æ•°é‡ */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pending_mounts</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>

<h4 id="332">3.3.2 æŒ‚è½½ä¼ æ’­ç±»å‹</h4>
<p>Linuxæ”¯æŒå››ç§æŒ‚è½½ä¼ æ’­ç±»å‹ï¼š</p>
<ol>
<li><strong>MS_SHARED</strong>ï¼šå…±äº«æŒ‚è½½ï¼ŒæŒ‚è½½/å¸è½½æ“ä½œä¼šä¼ æ’­åˆ°åŒç»„å…¶ä»–æŒ‚è½½ç‚¹</li>
<li><strong>MS_PRIVATE</strong>ï¼šç§æœ‰æŒ‚è½½ï¼ŒæŒ‚è½½/å¸è½½æ“ä½œä¸ä¼ æ’­</li>
<li><strong>MS_SLAVE</strong>ï¼šä»å±æŒ‚è½½ï¼Œå•å‘æ¥æ”¶ä¸»æŒ‚è½½ç‚¹çš„ä¼ æ’­</li>
<li><strong>MS_UNBINDABLE</strong>ï¼šä¸å¯ç»‘å®šæŒ‚è½½ï¼Œä¸èƒ½ä½œä¸ºbind mountçš„æº</li>
</ol>
<p>ä¼ æ’­æœºåˆ¶çš„å®ç°ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">propagate_one</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mount</span><span class="w"> </span><span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mount</span><span class="w"> </span><span class="o">*</span><span class="n">child</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_MNT_NEW</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* åˆ¤æ–­ä¼ æ’­ç±»å‹ */</span>
<span class="w">    </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CL_SLAVE</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_MNT_SHARED</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
<span class="w">        </span><span class="n">type</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">CL_MAKE_SHARED</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* å¤åˆ¶æŒ‚è½½ */</span>
<span class="w">    </span><span class="n">child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">copy_tree</span><span class="p">(</span><span class="n">source</span><span class="p">,</span><span class="w"> </span><span class="n">source</span><span class="o">-&gt;</span><span class="n">mnt</span><span class="p">.</span><span class="n">mnt_root</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* é™„åŠ åˆ°ç›®æ ‡ */</span>
<span class="w">    </span><span class="n">mnt_set_mountpoint</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">mp</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">);</span>
<span class="w">    </span><span class="n">child</span><span class="o">-&gt;</span><span class="n">mnt_parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="p">;</span>
<span class="w">    </span><span class="n">child</span><span class="o">-&gt;</span><span class="n">mnt_master</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mnt_master</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* åŠ å…¥æŒ‚è½½å“ˆå¸Œè¡¨ */</span>
<span class="w">    </span><span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">mnt_hash</span><span class="p">,</span><span class="w"> </span><span class="n">tree_list</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">count_mounts</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mnt_ns</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="34">3.4 æ ¹æ–‡ä»¶ç³»ç»Ÿçš„ç‰¹æ®Šå¤„ç†</h3>
<p>æ ¹æ–‡ä»¶ç³»ç»Ÿæ˜¯ç³»ç»Ÿå¯åŠ¨æ—¶ç¬¬ä¸€ä¸ªæŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå…·æœ‰ç‰¹æ®Šçš„åˆå§‹åŒ–è¿‡ç¨‹ï¼š</p>
<h4 id="341-initramfs">3.4.1 æ—©æœŸæ ¹æ–‡ä»¶ç³»ç»Ÿï¼ˆinitramfsï¼‰</h4>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">populate_rootfs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">err</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* è§£å‹å†…ç½®çš„initramfs */</span>
<span class="w">    </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unpack_to_rootfs</span><span class="p">(</span><span class="n">__initramfs_start</span><span class="p">,</span>
<span class="w">                           </span><span class="n">__initramfs_size</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
<span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;Failed to unpack initramfs: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* å¦‚æœæœ‰å¤–éƒ¨initrd */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">initrd_start</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cp">#ifdef CONFIG_BLK_DEV_RAM</span>
<span class="w">        </span><span class="cm">/* åˆ›å»º/initrd.image */</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ksys_open</span><span class="p">(</span><span class="s">&quot;/initrd.image&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="n">O_WRONLY</span><span class="o">|</span><span class="n">O_CREAT</span><span class="p">,</span><span class="w"> </span><span class="mo">0700</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">ksys_write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">initrd_start</span><span class="p">,</span>
<span class="w">                      </span><span class="n">initrd_end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">initrd_start</span><span class="p">);</span>
<span class="w">            </span><span class="n">ksys_close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="cp">#else</span>
<span class="w">        </span><span class="cm">/* ç›´æ¥è§£å‹ */</span>
<span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unpack_to_rootfs</span><span class="p">((</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">initrd_start</span><span class="p">,</span>
<span class="w">                               </span><span class="n">initrd_end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">initrd_start</span><span class="p">);</span>
<span class="w">        </span><span class="cp">#endif</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">rootfs_initcall</span><span class="p">(</span><span class="n">populate_rootfs</span><span class="p">);</span>
</code></pre></div>

<h4 id="342">3.4.2 çœŸå®æ ¹æ–‡ä»¶ç³»ç»Ÿåˆ‡æ¢</h4>
<p>ä»initramfsåˆ‡æ¢åˆ°çœŸå®æ ¹æ–‡ä»¶ç³»ç»Ÿçš„è¿‡ç¨‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">prepare_namespace</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">root_delay</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="w"> </span><span class="s">&quot;Waiting %d sec before mounting root device...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">               </span><span class="n">root_delay</span><span class="p">);</span>
<span class="w">        </span><span class="n">ssleep</span><span class="p">(</span><span class="n">root_delay</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* ç­‰å¾…æ ¹è®¾å¤‡å‡ºç° */</span>
<span class="w">    </span><span class="n">wait_for_device_probe</span><span class="p">();</span>

<span class="w">    </span><span class="cm">/* æŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿ */</span>
<span class="w">    </span><span class="n">mount_root</span><span class="p">();</span>

<span class="w">    </span><span class="cm">/* åˆ‡æ¢æ ¹ç›®å½• */</span>
<span class="w">    </span><span class="n">ksys_chdir</span><span class="p">(</span><span class="s">&quot;/root&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">mount_block_root</span><span class="p">();</span>
<span class="w">    </span><span class="n">mount_root_generic</span><span class="p">();</span>

<span class="w">    </span><span class="cm">/* ç§»åŠ¨æŒ‚è½½ç‚¹ */</span>
<span class="w">    </span><span class="n">ksys_mount</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">MS_MOVE</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">ksys_chroot</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="4">4. è·¯å¾„åæŸ¥æ‰¾ä¸ç›®å½•é¡¹ç¼“å­˜</h2>
<p>è·¯å¾„åæŸ¥æ‰¾æ˜¯VFSæœ€é¢‘ç¹çš„æ“ä½œä¹‹ä¸€ï¼Œå…¶æ€§èƒ½ç›´æ¥å½±å“ç³»ç»Ÿæ•´ä½“æ€§èƒ½ã€‚Linuxé€šè¿‡ç›®å½•é¡¹ç¼“å­˜ï¼ˆdcacheï¼‰å’ŒRCUä¼˜åŒ–å®ç°äº†é«˜æ•ˆçš„è·¯å¾„æŸ¥æ‰¾ã€‚</p>
<h3 id="41">4.1 è·¯å¾„è§£æç®—æ³•</h3>
<p>è·¯å¾„åè§£æå°†æ–‡ä»¶è·¯å¾„è½¬æ¢ä¸ºå¯¹åº”çš„dentryå’Œinodeã€‚æ ¸å¿ƒå‡½æ•°æ˜¯<code>path_lookupat()</code>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">path_lookupat</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">nameidata</span><span class="w"> </span><span class="o">*</span><span class="n">nd</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">path</span><span class="w"> </span><span class="o">*</span><span class="n">path</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path_init</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">link_path_walk</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">nd</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">           </span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lookup_last</span><span class="p">(</span><span class="n">nd</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">        </span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">;</span>
<span class="w">        </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">mnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">        </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dentry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">terminate_walk</span><span class="p">(</span><span class="n">nd</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="411">4.1.1 è·¯å¾„æŸ¥æ‰¾æ•°æ®ç»“æ„</h4>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">nameidata</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">path</span><span class="w">     </span><span class="n">path</span><span class="p">;</span><span class="w">           </span><span class="cm">/* å½“å‰è·¯å¾„ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">qstr</span><span class="w">     </span><span class="n">last</span><span class="p">;</span><span class="w">           </span><span class="cm">/* æœ€åä¸€ä¸ªç»„ä»¶ */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">path</span><span class="w">     </span><span class="n">root</span><span class="p">;</span><span class="w">           </span><span class="cm">/* æ ¹ç›®å½• */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w">    </span><span class="o">*</span><span class="n">inode</span><span class="p">;</span><span class="w">         </span><span class="cm">/* å½“å‰inode */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">    </span><span class="n">flags</span><span class="p">;</span><span class="w">          </span><span class="cm">/* æŸ¥æ‰¾æ ‡å¿— */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w">        </span><span class="n">seq</span><span class="p">;</span><span class="w">            </span><span class="cm">/* åºåˆ—å·ï¼ˆRCUï¼‰ */</span>
<span class="w">    </span><span class="kt">int</span><span class="w">             </span><span class="n">last_type</span><span class="p">;</span><span class="w">      </span><span class="cm">/* æœ€åç»„ä»¶ç±»å‹ */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w">        </span><span class="n">depth</span><span class="p">;</span><span class="w">          </span><span class="cm">/* ç¬¦å·é“¾æ¥æ·±åº¦ */</span>
<span class="w">    </span><span class="kt">int</span><span class="w">             </span><span class="n">total_link_count</span><span class="p">;</span><span class="w"> </span><span class="cm">/* æ€»é“¾æ¥æ•° */</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">saved</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">path</span><span class="w"> </span><span class="n">link</span><span class="p">;</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">delayed_call</span><span class="w"> </span><span class="n">done</span><span class="p">;</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">seq</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="o">*</span><span class="n">stack</span><span class="p">,</span><span class="w"> </span><span class="n">internal</span><span class="p">[</span><span class="n">EMBEDDED_LEVELS</span><span class="p">];</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">filename</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">nameidata</span><span class="w"> </span><span class="o">*</span><span class="n">saved</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w">        </span><span class="n">root_seq</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w">             </span><span class="n">dfd</span><span class="p">;</span>
<span class="w">    </span><span class="n">kuid_t</span><span class="w">          </span><span class="n">dir_uid</span><span class="p">;</span>
<span class="w">    </span><span class="n">umode_t</span><span class="w">         </span><span class="n">dir_mode</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>

<h4 id="412">4.1.2 è·¯å¾„éå†æ ¸å¿ƒç®—æ³•</h4>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">link_path_walk</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">nameidata</span><span class="w"> </span><span class="o">*</span><span class="n">nd</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;/&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="n">name</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!*</span><span class="n">name</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="p">(;;)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">u64</span><span class="w"> </span><span class="n">hash_len</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>

<span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">may_lookup</span><span class="p">(</span><span class="n">nd</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>

<span class="w">        </span><span class="n">hash_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash_name</span><span class="p">(</span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dentry</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>

<span class="w">        </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LAST_NORM</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;.&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">hashlen_len</span><span class="p">(</span><span class="n">hash_len</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;.&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LAST_DOTDOT</span><span class="p">;</span>
<span class="w">                    </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">LOOKUP_JUMPED</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span>
<span class="w">                </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LAST_DOT</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">LAST_NORM</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dentry</span><span class="p">;</span>
<span class="w">            </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">LOOKUP_JUMPED</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">d_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">DCACHE_OP_HASH</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">struct</span><span class="w"> </span><span class="nc">qstr</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">hash_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash_len</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="p">};</span>
<span class="w">                </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">d_op</span><span class="o">-&gt;</span><span class="n">d_hash</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">this</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<span class="w">                </span><span class="n">hash_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">hash_len</span><span class="p">;</span>
<span class="w">                </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">.</span><span class="n">hash_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash_len</span><span class="p">;</span>
<span class="w">        </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
<span class="w">        </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">last_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>

<span class="w">        </span><span class="n">name</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">hashlen_len</span><span class="p">(</span><span class="n">hash_len</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!*</span><span class="n">name</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">name</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">*</span><span class="n">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;/&#39;</span><span class="p">));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!*</span><span class="n">name</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">LOOKUP_DIRECTORY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">LOOKUP_FOLLOW</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">LOOKUP_DOTDOT</span><span class="p">;</span>
<span class="w">            </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">last_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LAST_ROOT</span><span class="p">;</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">walk_component</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span><span class="w"> </span><span class="n">WALK_MORE</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_link</span><span class="p">(</span><span class="n">nd</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">s</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">stack</span><span class="p">[</span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">depth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">].</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
<span class="w">                </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">;</span>
<span class="w">                </span><span class="k">continue</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="42-dcache">4.2 ç›®å½•é¡¹ç¼“å­˜ï¼ˆdcacheï¼‰æœºåˆ¶</h3>
<p>dcacheæ˜¯VFSæ€§èƒ½çš„å…³é”®ï¼Œå®ƒç¼“å­˜äº†æœ€è¿‘ä½¿ç”¨çš„ç›®å½•é¡¹ï¼Œé¿å…é‡å¤çš„ç£ç›˜è®¿é—®ã€‚</p>
<h4 id="421-dcache">4.2.1 dcacheå“ˆå¸Œè¡¨</h4>
<p>dcacheä½¿ç”¨å…¨å±€å“ˆå¸Œè¡¨å¿«é€ŸæŸ¥æ‰¾ç›®å½•é¡¹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_bl_head</span><span class="w"> </span><span class="o">*</span><span class="n">dentry_hashtable</span><span class="w"> </span><span class="n">__read_mostly</span><span class="p">;</span>

<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_bl_head</span><span class="w"> </span><span class="o">*</span><span class="n">d_hash</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">hash</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">dentry_hashtable</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">hash</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">d_hash_shift</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">d_hash_name</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">,</span>
<span class="w">                                       </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">qstr</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">init_name_hash</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span>
<span class="w">        </span><span class="n">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">partial_name_hash</span><span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">hash</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">end_name_hash</span><span class="p">(</span><span class="n">hash</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="422-dcache">4.2.2 dcacheæŸ¥æ‰¾</h4>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="n">__d_lookup</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">qstr</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d_hash_name</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_bl_head</span><span class="w"> </span><span class="o">*</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d_hash</span><span class="p">(</span><span class="n">hash</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">hlist_bl_node</span><span class="w"> </span><span class="o">*</span><span class="n">node</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="n">dentry</span><span class="p">;</span>

<span class="w">    </span><span class="n">rcu_read_lock</span><span class="p">();</span>
<span class="w">    </span><span class="n">hlist_bl_for_each_entry_rcu</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">d_hash</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">hash</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">hash</span><span class="p">)</span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span>

<span class="w">        </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_parent</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">parent</span><span class="p">)</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">next</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">d_unhashed</span><span class="p">(</span><span class="n">dentry</span><span class="p">))</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">next</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">d_same_name</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span><span class="w"> </span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">))</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">next</span><span class="p">;</span>

<span class="w">        </span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_lockref</span><span class="p">.</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dentry</span><span class="p">;</span>
<span class="w">        </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="nl">next</span><span class="p">:</span>
<span class="w">        </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">rcu_read_unlock</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">found</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="43-rcu">4.3 RCUè·¯å¾„éå†ä¼˜åŒ–</h3>
<p>RCUï¼ˆRead-Copy-Updateï¼‰å…è®¸æ— é”çš„è·¯å¾„æŸ¥æ‰¾ï¼Œæå¤§æå‡äº†å¹¶å‘æ€§èƒ½ã€‚</p>
<h4 id="431-rcu">4.3.1 RCUæ¨¡å¼çš„è·¯å¾„æŸ¥æ‰¾</h4>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">lookup_fast</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">nameidata</span><span class="w"> </span><span class="o">*</span><span class="n">nd</span><span class="p">,</span>
<span class="w">                      </span><span class="k">struct</span><span class="w"> </span><span class="nc">path</span><span class="w"> </span><span class="o">*</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">**</span><span class="n">inode</span><span class="p">,</span>
<span class="w">                      </span><span class="kt">unsigned</span><span class="w"> </span><span class="o">*</span><span class="n">seqp</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vfsmount</span><span class="w"> </span><span class="o">*</span><span class="n">mnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">mnt</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="n">dentry</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dentry</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">LOOKUP_RCU</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">seq</span><span class="p">;</span>
<span class="w">        </span><span class="n">dentry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__d_lookup_rcu</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">seq</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">dentry</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlazy_walk</span><span class="p">(</span><span class="n">nd</span><span class="p">))</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ECHILD</span><span class="p">;</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="o">*</span><span class="n">inode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d_backing_inode</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">read_seqcount_retry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_seq</span><span class="p">,</span><span class="w"> </span><span class="n">seq</span><span class="p">)))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ECHILD</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">__read_seqcount_retry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">d_seq</span><span class="p">,</span><span class="w"> </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">)))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ECHILD</span><span class="p">;</span>

<span class="w">        </span><span class="o">*</span><span class="n">seqp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seq</span><span class="p">;</span>
<span class="w">        </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d_revalidate</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span><span class="w"> </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">path</span><span class="o">-&gt;</span><span class="n">mnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mnt</span><span class="p">;</span>
<span class="w">            </span><span class="n">path</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dentry</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!*</span><span class="n">inode</span><span class="p">))</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">__follow_mount_rcu</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="n">seqp</span><span class="p">)))</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlazy_child</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span><span class="w"> </span><span class="n">dentry</span><span class="p">,</span><span class="w"> </span><span class="n">seq</span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ECHILD</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="n">ECHILD</span><span class="p">))</span>
<span class="w">            </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d_revalidate</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span><span class="w"> </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">dentry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__d_lookup</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">dentry</span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d_revalidate</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span><span class="w"> </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
<span class="w">            </span><span class="n">d_invalidate</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
<span class="w">        </span><span class="n">dput</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">path</span><span class="o">-&gt;</span><span class="n">mnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mnt</span><span class="p">;</span>
<span class="w">    </span><span class="n">path</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dentry</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="432">4.3.2 åºåˆ—é”ä¿æŠ¤</h4>
<p>RCUæ¨¡å¼ä½¿ç”¨åºåˆ—é”æ£€æµ‹å¹¶å‘ä¿®æ”¹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">read_seqcount_retry</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">seqcount_t</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">start</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">smp_rmb</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">unlikely</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">start</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="nf">read_seqbegin</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">seqlock_t</span><span class="w"> </span><span class="o">*</span><span class="n">sl</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">READ_ONCE</span><span class="p">(</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">cpu_relax</span><span class="p">();</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">repeat</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">smp_rmb</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="44">4.4 ç¬¦å·é“¾æ¥å¤„ç†</h3>
<p>ç¬¦å·é“¾æ¥çš„å¤„ç†éœ€è¦ç‰¹åˆ«æ³¨æ„é¿å…æ— é™å¾ªç¯ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="nf">get_link</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">nameidata</span><span class="w"> </span><span class="o">*</span><span class="n">nd</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">saved</span><span class="w"> </span><span class="o">*</span><span class="n">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">stack</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">depth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="n">dentry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">last</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">dentry</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">inode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">link_inode</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">res</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">total_link_count</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">MAXSYMLINKS</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">path_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">last</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ELOOP</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">total_link_count</span><span class="o">++</span><span class="p">;</span>

<span class="w">    </span><span class="n">touch_atime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">last</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>

<span class="w">    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">security_inode_follow_link</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span><span class="w"> </span><span class="n">inode</span><span class="p">,</span>
<span class="w">                                       </span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">LOOKUP_RCU</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ERR_PTR</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>

<span class="w">    </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">READ_ONCE</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_link</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">get</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">,</span>
<span class="w">                           </span><span class="k">struct</span><span class="w"> </span><span class="nc">delayed_call</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">        </span><span class="n">get</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_op</span><span class="o">-&gt;</span><span class="n">get_link</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">LOOKUP_RCU</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">last</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ECHILD</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlazy_walk</span><span class="p">(</span><span class="n">nd</span><span class="p">))</span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ECHILD</span><span class="p">);</span>
<span class="w">                </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span><span class="w"> </span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">last</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span><span class="w"> </span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">last</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;/&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nd_jump_root</span><span class="p">(</span><span class="n">nd</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">ERR_PTR</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="45">4.5 è´Ÿç›®å½•é¡¹ä¼˜åŒ–</h3>
<p>è´Ÿç›®å½•é¡¹ï¼ˆnegative dentryï¼‰ç¼“å­˜ä¸å­˜åœ¨çš„æ–‡ä»¶ï¼Œé¿å…é‡å¤çš„æŸ¥æ‰¾å¤±è´¥ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">d_instantiate_negative</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">dentry</span><span class="w"> </span><span class="o">*</span><span class="n">dentry</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">BUG_ON</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
<span class="w">    </span><span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">hlist_unhashed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_u</span><span class="p">.</span><span class="n">d_alias</span><span class="p">));</span>

<span class="w">    </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>
<span class="w">    </span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">DCACHE_NEGATIVE</span><span class="p">;</span>
<span class="w">    </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_lock</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>è´Ÿç›®å½•é¡¹çš„å¥½å¤„ï¼š</p>
<ol>
<li>å‡å°‘å¯¹ä¸å­˜åœ¨æ–‡ä»¶çš„é‡å¤æŸ¥æ‰¾</li>
<li>åŠ é€Ÿç¼–è¯‘ç­‰éœ€è¦æœç´¢å¤§é‡è·¯å¾„çš„æ“ä½œ</li>
<li>æé«˜includeè·¯å¾„æœç´¢æ•ˆç‡</li>
</ol>
<h2 id="5">5. æ–‡ä»¶æ“ä½œæ¥å£å®ç°</h2>
<p>VFSé€šè¿‡ç³»ç»Ÿè°ƒç”¨ä¸ºç”¨æˆ·ç©ºé—´æä¾›æ–‡ä»¶æ“ä½œæ¥å£ã€‚è¿™äº›ç³»ç»Ÿè°ƒç”¨æœ€ç»ˆè½¬æ¢ä¸ºå¯¹å…·ä½“æ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œã€‚</p>
<h3 id="51-vfs">5.1 ç³»ç»Ÿè°ƒç”¨åˆ°VFSçš„æ˜ å°„</h3>
<h4 id="511-open">5.1.1 openç³»ç»Ÿè°ƒç”¨</h4>
<div class="codehilite"><pre><span></span><code><span class="n">SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">open</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">umode_t</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">force_o_largefile</span><span class="p">())</span>
<span class="w">        </span><span class="n">flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">O_LARGEFILE</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">do_sys_open</span><span class="p">(</span><span class="n">AT_FDCWD</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">long</span><span class="w"> </span><span class="n">do_sys_open</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">dfd</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">umode_t</span><span class="w"> </span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">open_how</span><span class="w"> </span><span class="n">how</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">build_open_how</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">do_sys_openat2</span><span class="p">(</span><span class="n">dfd</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">how</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">do_sys_openat2</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">dfd</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">filename</span><span class="p">,</span>
<span class="w">                           </span><span class="k">struct</span><span class="w"> </span><span class="nc">open_how</span><span class="w"> </span><span class="o">*</span><span class="n">how</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">filename</span><span class="w"> </span><span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">;</span>

<span class="w">    </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getname</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>

<span class="w">    </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_unused_fd_flags</span><span class="p">(</span><span class="n">how</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">do_filp_open</span><span class="p">(</span><span class="n">dfd</span><span class="p">,</span><span class="w"> </span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">how</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">f</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">put_unused_fd</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="w">            </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">fsnotify_open</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="w">            </span><span class="n">fd_install</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">putname</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">fd</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="512">5.1.2 æ–‡ä»¶æ‰“å¼€çš„æ ¸å¿ƒè¿‡ç¨‹</h4>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">do_filp_open</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">dfd</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">filename</span><span class="w"> </span><span class="o">*</span><span class="n">pathname</span><span class="p">,</span>
<span class="w">                         </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">open_flags</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">nameidata</span><span class="w"> </span><span class="n">nd</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">op</span><span class="o">-&gt;</span><span class="n">lookup_flags</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">filp</span><span class="p">;</span>

<span class="w">    </span><span class="n">set_nameidata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nd</span><span class="p">,</span><span class="w"> </span><span class="n">dfd</span><span class="p">,</span><span class="w"> </span><span class="n">pathname</span><span class="p">);</span>
<span class="w">    </span><span class="n">filp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path_openat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nd</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">LOOKUP_RCU</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">filp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ECHILD</span><span class="p">)))</span>
<span class="w">        </span><span class="n">filp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path_openat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nd</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">filp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ESTALE</span><span class="p">)))</span>
<span class="w">        </span><span class="n">filp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path_openat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nd</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">LOOKUP_REVAL</span><span class="p">);</span>
<span class="w">    </span><span class="n">restore_nameidata</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">filp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">path_openat</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">nameidata</span><span class="w"> </span><span class="o">*</span><span class="n">nd</span><span class="p">,</span>
<span class="w">                               </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">open_flags</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>

<span class="w">    </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_empty_file</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">open_flag</span><span class="p">,</span><span class="w"> </span><span class="n">current_cred</span><span class="p">());</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">file</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">__O_TMPFILE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">do_tmpfile</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">O_PATH</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">do_o_path</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path_init</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">link_path_walk</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">nd</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">               </span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open_last_lookups</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">            </span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
<span class="w">            </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">do_open</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">);</span>
<span class="w">        </span><span class="n">terminate_walk</span><span class="p">(</span><span class="n">nd</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FMODE_OPENED</span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">file</span><span class="p">;</span>
<span class="w">        </span><span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">fput</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="n">EOPENSTALE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">LOOKUP_RCU</span><span class="p">)</span>
<span class="w">            </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">ECHILD</span><span class="p">;</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">ESTALE</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ERR_PTR</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="52">5.2 æ–‡ä»¶æè¿°ç¬¦ç®¡ç†</h3>
<h4 id="521">5.2.1 æ–‡ä»¶æè¿°ç¬¦è¡¨</h4>
<p>æ¯ä¸ªè¿›ç¨‹ç»´æŠ¤ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦è¡¨ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">files_struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">resize_in_progress</span><span class="p">;</span>
<span class="w">    </span><span class="n">wait_queue_head_t</span><span class="w"> </span><span class="n">resize_wait</span><span class="p">;</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">fdtable</span><span class="w"> </span><span class="n">__rcu</span><span class="w"> </span><span class="o">*</span><span class="n">fdt</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">fdtable</span><span class="w"> </span><span class="n">fdtab</span><span class="p">;</span>

<span class="w">    </span><span class="n">spinlock_t</span><span class="w"> </span><span class="n">file_lock</span><span class="w"> </span><span class="n">____cacheline_aligned_in_smp</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">next_fd</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">close_on_exec_init</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">open_fds_init</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">full_fds_bits_init</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="n">__rcu</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">fd_array</span><span class="p">[</span><span class="n">NR_OPEN_DEFAULT</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">fdtable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">max_fds</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="n">__rcu</span><span class="w"> </span><span class="o">**</span><span class="n">fd</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">close_on_exec</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">open_fds</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">full_fds_bits</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rcu_head</span><span class="w"> </span><span class="n">rcu</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>

<h4 id="522">5.2.2 åˆ†é…æ–‡ä»¶æè¿°ç¬¦</h4>
<div class="codehilite"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">get_unused_fd_flags</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">__get_unused_fd_flags</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">rlimit</span><span class="p">(</span><span class="n">RLIMIT_NOFILE</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">__get_unused_fd_flags</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">nofile</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">files_struct</span><span class="w"> </span><span class="o">*</span><span class="n">files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">;</span>

<span class="w">    </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">files</span><span class="o">-&gt;</span><span class="n">file_lock</span><span class="p">);</span>
<span class="nl">repeat</span><span class="p">:</span>
<span class="w">    </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">find_next_fd</span><span class="p">(</span><span class="n">files</span><span class="p">,</span><span class="w"> </span><span class="n">files</span><span class="o">-&gt;</span><span class="n">next_fd</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">nofile</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EMFILE</span><span class="p">;</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expand_files</span><span class="p">(</span><span class="n">files</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">repeat</span><span class="p">;</span>

<span class="w">    </span><span class="n">__set_open_fd</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">files</span><span class="o">-&gt;</span><span class="n">fdt</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">O_CLOEXEC</span><span class="p">)</span>
<span class="w">        </span><span class="n">__set_close_on_exec</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">files</span><span class="o">-&gt;</span><span class="n">fdt</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">__clear_close_on_exec</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">files</span><span class="o">-&gt;</span><span class="n">fdt</span><span class="p">);</span>

<span class="w">    </span><span class="n">files</span><span class="o">-&gt;</span><span class="n">next_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="nl">out</span><span class="p">:</span>
<span class="w">    </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">files</span><span class="o">-&gt;</span><span class="n">file_lock</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">fd</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="53">5.3 è¯»å†™æ“ä½œè·¯å¾„</h3>
<h4 id="531-read">5.3.1 readç³»ç»Ÿè°ƒç”¨</h4>
<div class="codehilite"><pre><span></span><code><span class="n">SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">read</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ksys_read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">ssize_t</span><span class="w"> </span><span class="n">ksys_read</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">fd</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fdget_pos</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">file</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">loff_t</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">ppos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file_ppos</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">file</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ppos</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">ppos</span><span class="p">;</span>
<span class="w">            </span><span class="n">ppos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pos</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vfs_read</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">ppos</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ppos</span><span class="p">)</span>
<span class="w">            </span><span class="n">f</span><span class="p">.</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="p">;</span>
<span class="w">        </span><span class="n">fdput_pos</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="532-vfs">5.3.2 VFSè¯»æ“ä½œ</h4>
<div class="codehilite"><pre><span></span><code><span class="kt">ssize_t</span><span class="w"> </span><span class="nf">vfs_read</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FMODE_READ</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FMODE_CAN_READ</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">)))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rw_verify_area</span><span class="p">(</span><span class="n">READ</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MAX_RW_COUNT</span><span class="p">)</span>
<span class="w">        </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAX_RW_COUNT</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">)</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">read_iter</span><span class="p">)</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_sync_read</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fsnotify_access</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
<span class="w">        </span><span class="n">add_rchar</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">inc_syscr</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="533">5.3.3 å†™æ“ä½œå®ç°</h4>
<div class="codehilite"><pre><span></span><code><span class="kt">ssize_t</span><span class="w"> </span><span class="nf">vfs_write</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FMODE_WRITE</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FMODE_CAN_WRITE</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">)))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rw_verify_area</span><span class="p">(</span><span class="n">WRITE</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MAX_RW_COUNT</span><span class="p">)</span>
<span class="w">        </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAX_RW_COUNT</span><span class="p">;</span>

<span class="w">    </span><span class="n">file_start_write</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">)</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">write_iter</span><span class="p">)</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_sync_write</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fsnotify_modify</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
<span class="w">        </span><span class="n">add_wchar</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">inc_syscw</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
<span class="w">    </span><span class="n">file_end_write</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="54-mmap">5.4 å†…å­˜æ˜ å°„ï¼ˆmmapï¼‰æ”¯æŒ</h3>
<h4 id="541-mmap">5.4.1 mmapç³»ç»Ÿè°ƒç”¨</h4>
<div class="codehilite"><pre><span></span><code><span class="n">SYSCALL_DEFINE6</span><span class="p">(</span><span class="n">mmap</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">,</span>
<span class="w">                </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">,</span><span class="w"> </span><span class="n">prot</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span>
<span class="w">                </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">,</span><span class="w"> </span><span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">offset_in_page</span><span class="p">(</span><span class="n">off</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ksys_mmap_pgoff</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">prot</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">PAGE_SHIFT</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ksys_mmap_pgoff</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">len</span><span class="p">,</span>
<span class="w">                              </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">prot</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span>
<span class="w">                              </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">pgoff</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">retval</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">MAP_ANONYMOUS</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fget</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_file_hugepages</span><span class="p">(</span><span class="n">file</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALIGN</span><span class="p">(</span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">huge_page_size</span><span class="p">(</span><span class="n">hstate_file</span><span class="p">(</span><span class="n">file</span><span class="p">)));</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">MAP_HUGETLB</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">out_fput</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">MAP_HUGETLB</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">ucounts</span><span class="w"> </span><span class="o">*</span><span class="n">ucounts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">        </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hugetlb_file_setup</span><span class="p">(</span><span class="n">HUGETLB_ANON_FILE</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">,</span>
<span class="w">                                 </span><span class="n">VM_NORESERVE</span><span class="p">,</span>
<span class="w">                                 </span><span class="o">&amp;</span><span class="n">ucounts</span><span class="p">,</span><span class="w"> </span><span class="n">HUGETLB_ANONHUGE_INODE</span><span class="p">,</span>
<span class="w">                                 </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">MAP_HUGE_SHIFT</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">MAP_HUGE_MASK</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm_mmap_pgoff</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">prot</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">pgoff</span><span class="p">);</span>

<span class="nl">out_fput</span><span class="p">:</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
<span class="w">        </span><span class="n">fput</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="542-vfs">5.4.2 æ–‡ä»¶æ˜ å°„çš„VFSæ”¯æŒ</h4>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">do_mmap</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span>
<span class="w">                  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">prot</span><span class="p">,</span>
<span class="w">                  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">pgoff</span><span class="p">,</span>
<span class="w">                  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">populate</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="o">*</span><span class="n">uf</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">;</span>
<span class="w">    </span><span class="n">vm_flags_t</span><span class="w"> </span><span class="n">vm_flags</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pkey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="o">*</span><span class="n">populate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">prot</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PROT_READ</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">personality</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">READ_IMPLIES_EXEC</span><span class="p">))</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">file</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">path_noexec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">)))</span>
<span class="w">            </span><span class="n">prot</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">PROT_EXEC</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">MAP_FIXED</span><span class="p">))</span>
<span class="w">        </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">round_hint_to_min</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>

<span class="w">    </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">pgoff</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">PAGE_SHIFT</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">pgoff</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">map_count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">sysctl_max_map_count</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

<span class="w">    </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_unmapped_area</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">pgoff</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR_VALUE</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">MAP_FIXED_NOREPLACE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">find_vma_intersection</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">len</span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prot</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PROT_EXEC</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pkey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">execute_only_pkey</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pkey</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="n">pkey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">vm_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calc_vm_prot_bits</span><span class="p">(</span><span class="n">prot</span><span class="p">,</span><span class="w"> </span><span class="n">pkey</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">calc_vm_flag_bits</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span><span class="w"> </span><span class="o">|</span>
<span class="w">               </span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">def_flags</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">VM_MAYREAD</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">VM_MAYWRITE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">VM_MAYEXEC</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">inode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file_inode</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">flags_mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VM_MERGEABLE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">VM_MAYSHARE</span><span class="w"> </span><span class="o">|</span>
<span class="w">                                   </span><span class="n">VM_DONTEXPAND</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">VM_SOFTDIRTY</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">file_mmap_ok</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="n">pgoff</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>

<span class="w">        </span><span class="n">flags_mask</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">mmap_supported_flags</span><span class="p">;</span>

<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">MAP_TYPE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">MAP_SHARED</span><span class="p">:</span>
<span class="w">            </span><span class="n">flags_mask</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">VM_SHARED</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">VM_MAYSHARE</span><span class="p">;</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">MAP_SHARED_VALIDATE</span><span class="p">:</span>
<span class="w">            </span><span class="n">flags_mask</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">VM_SHARED</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">VM_MAYSHARE</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">flags_mask</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">MAP_PRIVATE</span><span class="p">:</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vm_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">VM_GROWSDOWN</span><span class="o">|</span><span class="n">VM_GROWSUP</span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mmap_region</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">vm_flags</span><span class="p">,</span><span class="w"> </span><span class="n">pgoff</span><span class="p">,</span><span class="w"> </span><span class="n">uf</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">IS_ERR_VALUE</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="p">((</span><span class="n">vm_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">VM_LOCKED</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<span class="w">         </span><span class="p">(</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">MAP_POPULATE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MAP_NONBLOCK</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MAP_POPULATE</span><span class="p">))</span>
<span class="w">        </span><span class="o">*</span><span class="n">populate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
            </article>
            
            <nav class="page-nav"><a href="chapter4.html" class="nav-link prev">â† ç¬¬4ç« ï¼šè¿›ç¨‹é—´é€šä¿¡æœºåˆ¶</a><a href="chapter6.html" class="nav-link next">ç¬¬6ç« ï¼šå…·ä½“æ–‡ä»¶ç³»ç»Ÿå®ç° â†’</a></nav>
        </main>
    </div>
</body>
</html>